<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="/images/logo.png" type="image/x-icon"> <title>Incontri sulla Parola (Accesso) - Eremo Frate Francesco</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Stile per l'avatar immagine nella navbar */
    .user-avatar img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      vertical-align: middle;
    }
  </style>
</head>
<body class="page-incontri">

<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="indexaccesso.html" style="text-decoration:none; color:inherit;"><span class="emoji">üèîÔ∏è</span><h2>Eremo Frate Francesco</h2></a>
    </div>
    <div class="menu">
      <a href="eventiincorsoaccesso.html">Calendario attivit√†</a>
      <a href="eventipassatiaccesso.html">Archivio attivit√†</a>
      <span class="separator">|</span>
      <a href="incontrisullaparolaaccesso.html" class="active">Incontri sulla parola</a>
      <span class="separator">|</span>
      <a href="dovesiamoaccesso.html">Dove siamo</a>
      <a href="contattiaccesso.html">Contatti</a>
    </div>
    <div class="right-menu">
      <div class="user-dropdown" id="userDropdownContainer">
        <button class="user-btn" onclick="toggleUserMenu(event)" aria-haspopup="true" aria-expanded="false">
                    <span class="user-avatar" id="navbar-avatar">
                        <img src="/uploads/icons/default_user.png" alt="User Icon"> </span>
          <span class="user-name" id="navbar-username">Utente</span>
          <span class="dropdown-arrow">‚ñº</span>
        </button>
        <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
          <a href="areapersonale.html">Il mio profilo</a>
          <a href="areapersonale.html#prenotazioni">Le mie prenotazioni</a>
          <a href="#" id="logout-link-dropdown">Esci</a>
        </div>
      </div>
      <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorsoaccesso.html" onclick="closeMobileMenu()">Calendario attivit√†</a>
    <a href="eventipassatiaccesso.html" onclick="closeMobileMenu()">Archivio attivit√†</a>
    <a href="incontrisullaparolaaccesso.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
    <a href="dovesiamoaccesso.html" onclick="closeMobileMenu()">Dove siamo</a>
    <a href="contattiaccesso.html" onclick="closeMobileMenu()">Contatti</a>
    <hr style="border-color: rgba(255,255,255,0.1);">
    <a href="areapersonale.html" onclick="closeMobileMenu()">Il mio profilo</a>
    <a href="areapersonale.html#prenotazioni" onclick="closeMobileMenu()">Le mie prenotazioni</a>
    <a href="#" id="logout-link-mobile" onclick="handleLogout(); closeMobileMenu();">Esci</a>
  </div>
</header>

<main>
  <section class="page-header section-padding" style="background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://picsum.photos/1920/1080?random=bible,study') center/cover; color: white; text-align: center; border-radius: 0 0 var(--border-radius-large) var(--border-radius-large); margin-bottom: 3rem;">
    <div class="container">
      <h1 style="color: white;">Incontri sulla Parola</h1>
      <p style="font-size: 1.2rem; opacity: 0.9;">Un cammino settimanale di scoperta e crescita spirituale attraverso la Lectio Divina.</p>
    </div>
  </section>

  <div class="container">
    <section class="chi-siamo-section section-padding">
      <div class="chi-siamo-image-container">
        <img src="https://picsum.photos/600/400?random=group,reading,discussion" alt="Gruppo di studio biblico" class="chi-siamo-image">
      </div>
      <div class="chi-siamo-content">
        <h2>Cosa sono gli Incontri sulla Parola?</h2>
        <p>Gli Incontri sulla Parola sono un appuntamento settimanale dedicato all'ascolto, alla meditazione e alla condivisione della Parola di Dio, secondo il metodo della <strong>Lectio Divina</strong>. √à un'opportunit√† per nutrire la propria fede, approfondire la comprensione delle Scritture e crescere insieme come comunit√†.</p>
        <p>Non si tratta di uno studio accademico, ma di un'esperienza spirituale che cerca di far risuonare la Parola nella vita di ciascuno, in un clima di ascolto reciproco e di preghiera.</p>
      </div>
    </section>

    <section class="section-padding" style="background-color: var(--light); border-radius: var(--border-radius-large);">
      <h2 class="text-center mb-4" style="color: var(--secondary);">Informazioni Pratiche</h2>
      <div class="card-grid">
        <div class="card info-card">
          <div class="card-content">
            <h3><i class="fas fa-calendar-alt" style="margin-right: 8px; color: var(--secondary);"></i> Quando</h3>
            <p>Ogni Mercoled√¨ sera<br>Orario: 20:30 - 22:00</p>
            <p><strong>Prossimo incontro: <span id="next-meeting-date">[Data prossimo mercoled√¨]</span></strong></p>
          </div>
        </div>
        <div class="card info-card">
          <div class="card-content">
            <h3><i class="fas fa-map-marker-alt" style="margin-right: 8px; color: var(--secondary);"></i> Dove</h3>
            <p>Presso la sala incontri dell'Eremo Frate Francesco<br>Via San Vito, Nembro (BG)</p>
            <a href="dovesiamoaccesso.html" class="card-btn card-btn-secondary" style="margin-top: 1rem;">Come raggiungerci</a>
          </div>
        </div>
        <div class="card info-card">
          <div class="card-content">
            <h3><i class="fas fa-users" style="margin-right: 8px; color: var(--secondary);"></i> A chi √® rivolto</h3>
            <p>L'invito √® aperto a tutti: giovani, adulti, famiglie. Non √® richiesta alcuna preparazione teologica specifica, solo il desiderio di mettersi in ascolto della Parola.</p>
          </div>
        </div>
      </div>
    </section>

    <section class="chi-siamo-section reverse section-padding">
      <div class="chi-siamo-image-container">
        <img src="https://picsum.photos/600/400?random=community,prayer,circle" alt="Condivisione comunitaria" class="chi-siamo-image">
      </div>
      <div class="chi-siamo-content">
        <h2>Un Approccio Comunitario alla Lectio Divina</h2>
        <p>La Lectio Divina √® un metodo antico di preghiera e lettura della Bibbia che si articola in quattro momenti: <strong>Lectio</strong> (lettura), <strong>Meditatio</strong> (meditazione), <strong>Oratio</strong> (preghiera) e <strong>Contemplatio</strong> (contemplazione).</p>
        <p>Durante i nostri incontri, applichiamo questo metodo in modo comunitario. Dopo la lettura attenta di un brano biblico, ognuno √® invitato a meditare su ci√≤ che lo ha colpito, a trasformarlo in preghiera personale e, infine, a condividere liberamente (senza obbligo) le proprie riflessioni con il gruppo, arricchendosi reciprocamente.</p>
      </div>
    </section>

    <section class="section-padding">
      <h2 class="text-center mb-4">I Passi della Lectio Comunitaria</h2>
      <div class="card-grid">
        <div class="card">
          <div class="card-content text-center">
            <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">1</div>
            <h3>Lectio (Lettura)</h3>
            <p>Lettura attenta e ripetuta del brano biblico scelto per l'incontro, cercando di cogliere il messaggio letterale.</p>
          </div>
        </div>
        <div class="card">
          <div class="card-content text-center">
            <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">2</div>
            <h3>Meditatio (Meditazione)</h3>
            <p>Riflessione personale: cosa dice a me, oggi, questa Parola? Quali sentimenti o pensieri suscita?</p>
          </div>
        </div>
        <div class="card">
          <div class="card-content text-center">
            <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">3</div>
            <h3>Oratio (Preghiera)</h3>
            <p>Risposta personale alla Parola attraverso la preghiera: lode, ringraziamento, richiesta, supplica.</p>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<footer>
  <p>¬© <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia</p>
</footer>

<script>
  let currentUser = null;
  const defaultUserIconPath = '/uploads/icons/default_user.png'; // Path ASSOLUTO

  // --- FUNZIONI NAVBAR E SESSIONE UTENTE (STANDARD) ---
  async function callApi(url, method = 'GET', data = null) {
    const headers = { 'Content-Type': 'application/json' };
    const options = { method, headers, credentials: 'same-origin' };
    if (data && (method === 'POST' || method === 'PUT' || method === 'DELETE')) {
      options.body = JSON.stringify(data);
    }
    try {
      const response = await fetch(url, options);
      if (!response.ok) {
        let errorData = { message: `Errore HTTP ${response.status} (${response.statusText}) per ${url}` };
        try { errorData = await response.json(); } catch (e) { /* usa default */ }
        const finalErrorMessage = errorData.message || `Errore del server: ${response.status} per ${url}`;
        console.error("[callApi] Errore:", finalErrorMessage);
        throw new Error(finalErrorMessage);
      }
      if (response.status === 204) return {};
      return await response.json();
    } catch (error) {
      console.error(`[callApi] Fallimento chiamata API (rete/parse) a ${url}:`, error.message);
      throw error;
    }
  }

  function updateNavbarUserUI() {
    const navbarUsernameEl = document.getElementById('navbar-username');
    const navbarAvatarImgEl = document.querySelector('#navbar-avatar img'); // Seleziona l'elemento <img>
    if (!navbarUsernameEl || !navbarAvatarImgEl) { return; }

    if (currentUser && currentUser.email) {
      let displayName = currentUser.nome || currentUser.email.split('@')[0];
      navbarUsernameEl.textContent = displayName;
      navbarAvatarImgEl.src = currentUser.iconPath || defaultUserIconPath;
      navbarAvatarImgEl.alt = `Icona di ${displayName}`;
      navbarAvatarImgEl.onerror = function() { this.src = defaultUserIconPath; }; // Fallback se l'icona utente non carica
    } else {
      navbarUsernameEl.textContent = 'Utente';
      navbarAvatarImgEl.src = defaultUserIconPath;
      navbarAvatarImgEl.alt = 'Icona utente predefinita';
    }
  }

  function handleLogout() {
    localStorage.removeItem('userDataEFF');
    currentUser = null;
    alert('Logout effettuato. Verrai reindirizzato alla homepage.');
    window.location.href = 'index.html';
  }

  function setupUserSessionAndNavbar() {
    const userDataString = localStorage.getItem('userDataEFF');
    if (userDataString) {
      try {
        currentUser = JSON.parse(userDataString);
        if (!currentUser || typeof currentUser.email === 'undefined') {
          currentUser = null; localStorage.removeItem('userDataEFF');
        }
      } catch (e) {
        currentUser = null; localStorage.removeItem('userDataEFF'); console.error("Errore parsing userDataEFF:", e);
      }
    } else {
      currentUser = null;
    }
    updateNavbarUserUI(); // Aggiorna subito UI con dati da localStorage

    // Assicurati che gli ID dei link di logout corrispondano a quelli nell'HTML di questa pagina
    const logoutLinkDropdown = document.getElementById('logout-link-dropdown');
    const logoutLinkMobile = document.getElementById('logout-link-mobile');

    if (logoutLinkDropdown) logoutLinkDropdown.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
    if (logoutLinkMobile) logoutLinkMobile.addEventListener('click', (e) => {
      e.preventDefault();
      if(typeof closeMobileMenu === 'function') closeMobileMenu();
      handleLogout();
    });
  }

  async function fetchAndUpdateUserDisplayData() {
    if (!currentUser || !currentUser.email) { return; }
    try {
      const apiUserData = await callApi('api/api_get_user_profile.php'); // Script profilo UTENTE √® in /api/
      if (apiUserData && apiUserData.success && apiUserData.data) {
        const freshData = apiUserData.data;
        currentUser.nome = freshData.nome || currentUser.nome;
        currentUser.email = freshData.email || currentUser.email;
        currentUser.iconPath = freshData.icon || defaultUserIconPath;
        currentUser.cognome = freshData.cognome || (currentUser.cognome || '');

        localStorage.setItem('userDataEFF', JSON.stringify(currentUser));
        updateNavbarUserUI(); // Aggiorna la UI con i dati freschi
      }
    } catch (error) {
      console.warn("IncontriSullaParola: Errore fetch profilo aggiornato per navbar:", error.message);
    }
  }
  // --- FINE FUNZIONI NAVBAR E SESSIONE UTENTE ---

  // --- Logica Menu (Scroll, Dropdown, Hamburger) ---
  // (Identica a quella delle altre pagine autenticate)
  let lastScroll = 0;
  const navbarContainer = document.getElementById('navbarContainer');
  if (navbarContainer) {
    window.addEventListener('scroll', () => {
      const currentScroll = window.pageYOffset;
      if (currentScroll <= 50) { navbarContainer.classList.remove('hidden'); lastScroll = 0; return; }
      if (currentScroll > lastScroll && !navbarContainer.classList.contains('hidden')) {navbarContainer.classList.add('hidden');}
      else if (currentScroll < lastScroll && navbarContainer.classList.contains('hidden')) {navbarContainer.classList.remove('hidden');}
      lastScroll = currentScroll;
    }, {passive: true});
  }
  const userDropdownButton = document.querySelector('#userDropdownContainer .user-btn');
  const userDropdownMenu = document.querySelector('#userDropdownContainer .dropdown-menu');
  function toggleUserMenu(event) { // Chiamata da onclick nell'HTML
    if(event) event.stopPropagation();
    if (userDropdownMenu && userDropdownButton) {
      const isCurrentlyOpen = userDropdownMenu.style.display === 'block';
      userDropdownMenu.style.display = isCurrentlyOpen ? 'none' : 'block';
      userDropdownButton.setAttribute('aria-expanded', String(!isCurrentlyOpen));
    }
  }
  const mobileMenu = document.getElementById("mobileMenu");
  const hamburger = document.querySelector(".navbar .hamburger");
  function toggleMobileMenu() { // Chiamata da onclick nell'HTML
    if (mobileMenu && hamburger) {
      const isOpen = mobileMenu.classList.toggle("open");
      hamburger.classList.toggle("open");
      hamburger.setAttribute("aria-expanded", isOpen.toString());
      document.body.style.overflow = isOpen ? 'hidden' : '';
    }
  }
  function closeMobileMenu() { // Chiamata da onclick nei link del mobile menu
    if (mobileMenu && hamburger && mobileMenu.classList.contains("open")) {
      mobileMenu.classList.remove("open");
      if(hamburger.classList.contains("open")){
        hamburger.classList.remove("open");
        hamburger.setAttribute("aria-expanded", "false");
      }
      document.body.style.overflow = '';
    }
  }
  // Listener globale per chiudere i menu al click esterno
  document.addEventListener('click', function(globalEvent) {
    if (userDropdownMenu && userDropdownMenu.style.display === 'block') {
      const userDropdownContainer = document.getElementById('userDropdownContainer');
      if (userDropdownContainer && !userDropdownContainer.contains(globalEvent.target)) {
        userDropdownMenu.style.display = 'none';
        if (userDropdownButton) userDropdownButton.setAttribute('aria-expanded', 'false');
      }
    }
    if (mobileMenu && mobileMenu.classList.contains('open')) {
      if (mobileMenu.contains(globalEvent.target) && globalEvent.target.tagName === 'A' && globalEvent.target.closest('.mobile-menu')) {
        closeMobileMenu();
      } else if (hamburger && !mobileMenu.contains(globalEvent.target) && !hamburger.contains(globalEvent.target)) {
        closeMobileMenu();
      }
    }
  });
  // --- FINE LOGICA MENU ---


  // --- Logica Specifica per questa pagina (incontrisullaparolaaccesso.html) ---
  function getNextWednesday() {
    const today = new Date();
    const currentDay = today.getDay(); // 0 = Domenica, 1 = Luned√¨, ..., 3 = Mercoled√¨
    let daysUntilWednesday = (3 - currentDay + 7) % 7; // Giorni mancanti al prossimo mercoled√¨

    // Se oggi √® mercoled√¨ E l'ora √® >= 22:00, considera il mercoled√¨ della settimana successiva
    if (daysUntilWednesday === 0 && today.getHours() >= 22) {
      daysUntilWednesday = 7;
    } else if (daysUntilWednesday === 0 && currentDay === 3) {
      // Se oggi √® mercoled√¨ e non √® ancora passata l'ora dell'incontro, √® oggi
      // Se invece hai gi√† passato l'ora dell'incontro, o vuoi sempre il prossimo, commenta questa condizione
    }


    const nextWednesday = new Date(today);
    nextWednesday.setDate(today.getDate() + daysUntilWednesday);
    nextWednesday.setHours(20, 30, 0, 0); // Imposta l'orario per chiarezza, anche se non richiesto dalla formattazione
    return nextWednesday;
  }

  function formatDateItalian(date) {
    const options = { weekday: 'long', day: 'numeric', month: 'long' };
    return date.toLocaleDateString('it-IT', options);
  }

  document.addEventListener('DOMContentLoaded', async () => { // Reso async
    setupUserSessionAndNavbar(); // Setup iniziale da localStorage

    if (!currentUser) { // Reindirizza se non loggato (questo controllo √® cruciale)
      // console.log("Utente non loggato su incontrisullaparolaaccesso.html. Reindirizzamento.");
      window.location.href = 'index.html';
      return;
    }

    // Dopo il setup iniziale, e DOPO il controllo di redirect, chiama per aggiornare la navbar
    await fetchAndUpdateUserDisplayData();

    const currentYearEl = document.getElementById('currentYear');
    if (currentYearEl) {
      currentYearEl.textContent = new Date().getFullYear();
    }

    const nextMeetingDateElement = document.getElementById('next-meeting-date');
    if (nextMeetingDateElement) {
      nextMeetingDateElement.textContent = formatDateItalian(getNextWednesday());
    }

    // Animazioni (opzionale, dalla tua versione originale)
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.style.opacity = 1;
          entry.target.style.transform = 'translateY(0)';
          observer.unobserve(entry.target); // Opzionale: smetti di osservare dopo l'animazione
        }
      });
    }, { threshold: 0.1 });

    document.querySelectorAll('.chi-siamo-section, .card').forEach(el => {
      el.style.opacity = 0;
      el.style.transform = 'translateY(20px)';
      el.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
      observer.observe(el);
    });
  });
</script>

</body>
</html>