<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/logo.png" type="image/x-icon" />
  <title>Archivio Attivit√† - Eremo Frate Francesco</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@300;400;500;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Stili specifici per i filtri, se necessario */
    .event-filters {
      background-color: var(--white);
      padding: 1.5rem;
      border-radius: var(--border-radius-medium);
      margin-bottom: 2rem;
      box-shadow: var(--shadow-light);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end; /* Allinea elementi in basso */
    }
    .event-filters .form-group {
      flex: 1 1 200px; /* Flex per adattarsi */
      margin-bottom: 0; /* Rimuove margine inferiore dal form-group */
    }
    .event-filters label {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      color: var(--primary);
      display: block;
    }
    .event-filters input,
    .event-filters select {
      width: 100%;
      padding: 0.7rem 1rem;
      border: 1px solid var(--gray-medium);
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .event-filters button {
      padding: 0.7rem 1.5rem;
      background-color: var(--secondary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition-medium);
      height: fit-content; /* Adatta altezza */
    }
    .event-filters button:hover {
      background-color: var(--primary);
    }
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .loading-overlay.visible {
      visibility: visible;
      opacity: 1;
    }
    .loading-overlay .spinner { /* Spinner per il caricamento pagina */
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary);
      animation: spin 1s ease infinite;
      margin-bottom: 0.5rem;
    }
    .spinner-mini-light { /* Spinner per bottoni */
      display: inline-block;
      width: 1em;
      height: 1em;
      border: 2px solid rgba(0,0,0,0.2);
      border-radius: 50%;
      border-top-color: #000;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-left: 5px;
    }
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    .no-events {
      text-align: center;
      padding: 2rem;
      color: var(--gray-dark);
    }
    .login-popup input.form-control.error-border {
      border-color: var(--danger, red) !important;
    }
    .login-popup input:-webkit-autofill,
    .login-popup input:-webkit-autofill:hover,
    .login-popup input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0px 1000px var(--white, white) inset !important;
      -webkit-text-fill-color: var(--dark, #333) !important;
    }
    .form-message.error {
      color: var(--danger, red);
      background-color: rgba(var(--danger-rgb, 231, 76, 60), 0.1);
      border: 1px solid rgba(var(--danger-rgb, 231, 76, 60), 0.3);
      padding: 0.75rem;
      border-radius: 8px;
      font-size: 0.9em;
      margin-top: 0.5em;
      text-align: left;
    }
    .terms-checkbox {
      text-align: left;
      font-size: 0.9em;
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      color: var(--gray-dark);
    }
    .terms-checkbox input[type="checkbox"] {
      margin-right: 0.5rem;
      vertical-align: middle;
    }
    .terms-checkbox label {
      font-weight: normal;
      color: var(--gray-dark);
    }
    .terms-checkbox a {
      color: var(--primary);
      text-decoration: underline;
    }
  </style>
</head>
<body>
<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="index.html"
      ><span class="emoji">üèîÔ∏è</span>
        <h2>Eremo Frate Francesco</h2></a
      >
    </div>
    <div class="menu">
      <a href="eventiincorso.html">Calendario attivit√†</a>
      <a href="eventipassati.html" class="active">Archivio attivit√†</a
      ><span class="separator">|</span>
      <a href="incontrisullaparola.html">Incontri sulla parola</a
      ><span class="separator">|</span>
      <a href="dovesiamo.html">Dove siamo</a>
      <a href="contatti.html">Contatti</a>
    </div>
    <div class="right-menu">
      <button id="login-btn" class="login-btn">Accedi</button>
      <button
              class="hamburger"
              onclick="toggleMobileMenu()"
              aria-label="Toggle menu"
      >
        ‚ò∞
      </button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorso.html" onclick="closeMobileMenu()"
    >Calendario attivit√†</a
    >
    <a href="eventipassati.html" onclick="closeMobileMenu()"
    >Archivio attivit√†</a
    >
    <a href="incontrisullaparola.html" onclick="closeMobileMenu()"
    >Incontri sulla parola</a
    >
    <a href="dovesiamo.html" onclick="closeMobileMenu()">Dove siamo</a>
    <a href="contatti.html" onclick="closeMobileMenu()">Contatti</a>
    <a
            href="#"
            id="login-btn-mobile"
            onclick="openLoginPopup(); closeMobileMenu();"
    >Accedi</a
    >
  </div>
</header>

<main>
  <div class="container section-padding">
    <h1>Archivio Attivit√† Passate</h1>

    <div class="event-filters">
      <div class="form-group">
        <label for="searchTitle">Titolo Evento</label>
        <input
                type="text"
                id="searchTitle"
                placeholder="Cerca per titolo..."
                class="form-control"
        />
      </div>
      <div class="form-group">
        <label for="searchDate">Mese/Anno (YYYY-MM)</label>
        <input type="month" id="searchDate" class="form-control" />
      </div>
      <div class="form-group">
        <label for="searchSpeaker">Relatore</label>
        <input
                type="text"
                id="searchSpeaker"
                class="form-control"
                placeholder="Nome relatore..."
        />
      </div>
    </div>

    <div id="eventiGridContainer" style="position: relative">
      <div id="loadingIndicator" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top: 0.5rem; color: var(--primary);">Caricamento eventi...</p>
      </div>
      <div class="card-grid" id="eventiPassatiGrid"></div>
    </div>
  </div>
</main>

<footer>
  <p>
    ¬© <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti
    riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia
  </p>
</footer>

<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
  <button class="close-popup" id="closePopupBtn" aria-label="Chiudi popup">
    &times;
  </button>
  <div class="login-tabs">
    <div class="login-tab active" data-tab="login">Accedi</div>
    <div class="login-tab" data-tab="register">Registrati</div>
  </div>
  <form class="login-form active" id="loginFormPopup">
    <div class="form-group">
      <label for="login-email-popup">Email</label>
      <input
              type="email"
              id="login-email-popup"
              name="login-email"
              class="form-control"
              required
              autocomplete="email"
      />
    </div>
    <div class="form-group">
      <label for="login-password-popup">Password</label>
      <input
              type="password"
              id="login-password-popup"
              name="login-password"
              class="form-control"
              required
              autocomplete="current-password"
      />
    </div>
    <div id="login-error-message-popup" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
    <div class="form-actions">
      <button type="submit" class="btn-popup">Accedi</button>
    </div>
  </form>
  <form class="login-form" id="registerFormPopup">
    <div class="form-group">
      <label for="register-name-popup">Nome</label>
      <input
              type="text"
              id="register-name-popup"
              name="register-name"
              class="form-control"
              required
              autocomplete="given-name"
      />
    </div>
    <div class="form-group">
      <label for="register-surname-popup">Cognome</label>
      <input
              type="text"
              id="register-surname-popup"
              name="register-surname"
              class="form-control"
              required
              autocomplete="family-name"
      />
    </div>
    <div class="form-group">
      <label for="register-email-popup">Email</label>
      <input
              type="email"
              id="register-email-popup"
              name="register-email"
              class="form-control"
              required
              autocomplete="email"
      />
    </div>
    <div class="form-group">
      <label for="register-password-popup">Password</label>
      <input
              type="password"
              id="register-password-popup"
              name="register-password"
              class="form-control"
              required
              minlength="8"
              autocomplete="new-password"
      />
      <small>Minimo 8 caratteri.</small>
    </div>
    <div class="terms-checkbox">
      <input type="checkbox" id="register-terms-popup" name="register-terms" required>
      <label for="register-terms-popup">Accetto i <a href="termini.html" target="_blank">termini e condizioni</a></label>
    </div>
    <div id="register-error-message-popup" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
    <div class="form-actions">
      <button type="submit" class="btn-popup">Registrati</button>
    </div>
  </form>
</div>

<div class="login-popup-overlay" id="loginRequiredOverlay"></div>
<div class="login-popup" id="loginRequiredPopup">
  <button class="close-popup" id="closeLoginRequiredPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h2 style="color: var(--primary); margin-top: 0; margin-bottom: 1.5rem; text-align: center; font-size: 1.8rem;">Accesso Richiesto</h2>
  <p style="text-align: center; margin-bottom: 1.5rem; font-size: 1.2rem; color: var(--dark);">Per visualizzare i dettagli completi dell'evento e i commenti, √® necessario effettuare l'accesso.</p>
  <div class="form-actions" style="text-align: center;">
    <button type="button" class="btn-popup" id="loginRequiredLoginBtn">Accedi / Registrati</button>
  </div>
</div>


<script>
  // --- Funzioni Utilit√† ---
  function gebi(id) {
    return document.getElementById(id);
  }
  const defaultUserIconPath = '/uploads/icons/default_user.png';

  // --- Navbar Scroll Logic ---
  let lastScroll = 0;
  const navbarContainer = gebi("navbarContainer");
  if (navbarContainer) {
    window.addEventListener( "scroll", function () {
      const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      if (currentScroll <= 50) {
        navbarContainer.classList.remove("hidden");
        lastScroll = 0;
        return;
      }
      if ( currentScroll > lastScroll && !navbarContainer.classList.contains("hidden") ) {
        navbarContainer.classList.add("hidden");
      } else if ( currentScroll < lastScroll && navbarContainer.classList.contains("hidden") ) {
        navbarContainer.classList.remove("hidden");
      }
      lastScroll = currentScroll;
    }, false );
  }

  // --- Mobile Menu Logic ---
  const mobileMenu = gebi("mobileMenu");
  const hamburger = document.querySelector(".navbar .hamburger"); // Selettore specifico
  function toggleMobileMenu() {
    if (mobileMenu && hamburger) {
      const isOpen = mobileMenu.classList.toggle("open");
      hamburger.classList.toggle("open"); // Assicura che anche la classe dell'hamburger cambi
      hamburger.setAttribute("aria-expanded", String(isOpen));
      document.body.style.overflow = isOpen ? "hidden" : "";
    }
  }
  function closeMobileMenu() {
    if (mobileMenu && hamburger && mobileMenu.classList.contains("open")) {
      mobileMenu.classList.remove("open");
      hamburger.classList.remove("open"); // Assicura che anche la classe dell'hamburger si resetti
      hamburger.setAttribute("aria-expanded", "false");
      document.body.style.overflow = "";
    }
  }
  // L'HTML ha onclick="toggleMobileMenu()", quindi l'addEventListener qui sotto √® ridondante e pu√≤ essere rimosso.
  // if (hamburger) hamburger.addEventListener("click", toggleMobileMenu); // RIMOSSO per evitare doppia chiamata

  document.querySelectorAll("#mobileMenu a").forEach((link) => {
    if (link.id !== 'login-btn-mobile') {
      link.addEventListener("click", closeMobileMenu);
    }
    // Per login-btn-mobile, l'onclick nell'HTML √®: onclick="openLoginPopup(); closeMobileMenu();"
    // closeMobileMenu() √® gi√† corretto.
  });
  document.addEventListener("click", function (event) {
    if ( mobileMenu && mobileMenu.classList.contains("open") &&
            hamburger && !mobileMenu.contains(event.target) &&
            !hamburger.contains(event.target) ) {
      closeMobileMenu();
    }
  });


  // --- Login Popup Logic ---
  const loginBtn = gebi("login-btn");
  const loginBtnMobile = gebi("login-btn-mobile");
  const loginOverlay = gebi("loginOverlay");
  const loginPopup = gebi("loginPopup");
  const closePopupBtn = gebi("closePopupBtn");
  const loginTabs = document.querySelectorAll(".login-tab");
  const loginForms = document.querySelectorAll(".login-popup .login-form");
  const loginErrorMessagePopup = gebi('login-error-message-popup');
  const registerErrorMessagePopup = gebi('register-error-message-popup');

  function openLoginPopup() {
    if (loginOverlay) loginOverlay.classList.add("active");
    if (loginPopup) loginPopup.classList.add("active");
    document.body.style.overflow = "hidden";
    resetFormErrors();
    const activeForm = loginPopup.querySelector(".login-form.active");
    if (activeForm) activeForm.querySelector('input:not([type="hidden"])')?.focus();
  }

  function closeLoginPopup() {
    if (loginOverlay) loginOverlay.classList.remove("active");
    if (loginPopup) loginPopup.classList.remove("active");
    document.body.style.overflow = "";
    resetFormErrors();
  }

  function resetFormErrors() {
    loginForms.forEach(form => {
      form.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border'));
    });
    if (loginErrorMessagePopup) loginErrorMessagePopup.style.display = 'none';
    if (registerErrorMessagePopup) registerErrorMessagePopup.style.display = 'none';
  }

  if (loginBtn) loginBtn.addEventListener("click", (e) => { e.preventDefault(); openLoginPopup(); });
  // loginBtnMobile ha gi√† onclick="openLoginPopup(); closeMobileMenu();" nell'HTML

  if (closePopupBtn) closePopupBtn.addEventListener("click", closeLoginPopup);
  if (loginOverlay) loginOverlay.addEventListener("click", (e) => { if (e.target === loginOverlay) closeLoginPopup(); });

  loginTabs.forEach((tab) => {
    tab.addEventListener("click", () => {
      const tabId = tab.getAttribute("data-tab");
      loginTabs.forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");
      loginForms.forEach((form) => {
        form.classList.remove("active");
        if (form.id === `${tabId}FormPopup`) {
          form.classList.add("active");
          form.querySelector('input:not([type="hidden"])')?.focus();
        }
      });
      resetFormErrors();
    });
  });

  // --- LOGIN FORM SUBMISSION ---
  gebi("loginFormPopup")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const loginButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = loginButton.textContent;
    loginButton.disabled = true;
    loginButton.innerHTML = 'Accesso... <div class="spinner-mini-light"></div>';

    const emailInput = gebi('login-email-popup');
    const passwordInput = gebi('login-password-popup');
    emailInput.classList.remove('error-border');
    passwordInput.classList.remove('error-border');
    if(loginErrorMessagePopup) loginErrorMessagePopup.style.display = 'none';

    try {
      const response = await fetch('login.php', {
        method: 'POST',
        body: new FormData(e.target)
      });

      if (!response.ok) {
        let errorData = { message: `Errore HTTP: ${response.status}` };
        try { errorData = await response.json(); } catch (e) { /* Ignora se non √® JSON */ }
        throw new Error(errorData.message || `Errore HTTP: ${response.status}`);
      }
      const result = await response.json();

      if (result.success) {
        const userDataToStore = {
          nome: result.nome,
          email: result.email,
          iconPath: defaultUserIconPath
        };
        localStorage.setItem('userDataEFF', JSON.stringify(userDataToStore));
        closeLoginPopup();
        window.location.href = result.is_admin ? 'indexadmin.html' : 'eventipassatiaccesso.html';
      } else {
        emailInput.classList.add('error-border');
        passwordInput.classList.add('error-border');
        if(loginErrorMessagePopup) {
          loginErrorMessagePopup.textContent = result.message || "Credenziali non valide.";
          loginErrorMessagePopup.style.display = 'block';
        } else {
          alert(result.message || "Credenziali non valide.");
        }
      }
    } catch (error) {
      emailInput.classList.add('error-border');
      passwordInput.classList.add('error-border');
      if(loginErrorMessagePopup) {
        loginErrorMessagePopup.textContent = "Errore di connessione o risposta non valida dal server.";
        loginErrorMessagePopup.style.display = 'block';
      } else {
        alert("Errore di connessione o risposta non valida dal server.");
      }
      console.error("Errore login:", error);
    } finally {
      loginButton.disabled = false;
      loginButton.innerHTML = originalButtonText;
    }
  });

  // --- REGISTER FORM SUBMISSION ---
  gebi("registerFormPopup")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const registerButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = registerButton.textContent;
    registerButton.disabled = true;
    registerButton.innerHTML = 'Registrazione... <div class="spinner-mini-light"></div>';
    if(registerErrorMessagePopup) registerErrorMessagePopup.style.display = 'none';
    e.target.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border'));

    try {
      const response = await fetch('registrati.php', {
        method: 'POST',
        body: new FormData(e.target)
      });

      if (!response.ok) {
        let errorMsg = `Errore HTTP: ${response.status} ${response.statusText}`;
        try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; }
        catch(err) { /* Ignora se non √® JSON */ }
        throw new Error(errorMsg);
      }
      const result = await response.json();

      if (result.success) {
        alert(result.message || "Registrazione completata! Ora puoi effettuare il login.");
        const loginTabButton = document.querySelector('.login-tab[data-tab="login"]');
        if (loginTabButton) loginTabButton.click();

        const loginEmailPopup = gebi('login-email-popup');
        const registerEmailPopup = gebi('register-email-popup');
        if (loginEmailPopup && registerEmailPopup) {
          loginEmailPopup.value = registerEmailPopup.value;
        }
        e.target.reset();
      } else {
        if(registerErrorMessagePopup) {
          registerErrorMessagePopup.textContent = result.message || "Errore durante la registrazione.";
          registerErrorMessagePopup.style.display = 'block';
        } else {
          alert("Errore Registrazione: " + (result.message || "Si √® verificato un errore."));
        }
        if (result.errors) {
          for (const fieldNameFromError in result.errors) {
            const inputElement = e.target.elements[fieldNameFromError] || gebi(`register-${fieldNameFromError}-popup`);
            if (inputElement) {
              inputElement.classList.add('error-border');
            }
          }
        }
      }
    } catch (error) {
      if(registerErrorMessagePopup) {
        registerErrorMessagePopup.textContent = "Errore: " + error.message;
        registerErrorMessagePopup.style.display = 'block';
      } else {
        alert("Errore durante la registrazione: " + error.message);
      }
      console.error("Dettaglio errore registrazione:", error);
    } finally {
      registerButton.disabled = false;
      registerButton.innerHTML = originalButtonText;
    }
  });

  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") {
      if (loginPopup && loginPopup.classList.contains("active") ) {
        closeLoginPopup();
      }
      if (loginRequiredPopup && loginRequiredPopup.classList.contains("active")) {
        closeLoginRequiredPopup();
      }
    }
  });

  // --- Logica Popup "Accesso Richiesto" (invariata) ---
  const loginRequiredOverlay = gebi("loginRequiredOverlay");
  const loginRequiredPopup = gebi("loginRequiredPopup");
  const closeLoginRequiredPopupBtn = gebi("closeLoginRequiredPopupBtn");
  const loginRequiredLoginBtn = gebi("loginRequiredLoginBtn");

  function showLoginRequiredPopup(event) {
    if (event) event.preventDefault();
    if (loginRequiredOverlay) loginRequiredOverlay.classList.add("active");
    if (loginRequiredPopup) loginRequiredPopup.classList.add("active");
    document.body.style.overflow = "hidden";
  }

  function closeLoginRequiredPopup() {
    if (loginRequiredOverlay) loginRequiredOverlay.classList.remove("active");
    if (loginRequiredPopup) loginRequiredPopup.classList.remove("active");
    if (!loginPopup || !loginPopup.classList.contains("active")) {
      document.body.style.overflow = "";
    }
  }

  if (closeLoginRequiredPopupBtn) {
    closeLoginRequiredPopupBtn.addEventListener("click", closeLoginRequiredPopup);
  }
  if (loginRequiredOverlay) {
    loginRequiredOverlay.addEventListener("click", (e) => {
      if (e.target === loginRequiredOverlay) closeLoginRequiredPopup();
    });
  }
  if (loginRequiredLoginBtn) {
    loginRequiredLoginBtn.addEventListener("click", () => {
      closeLoginRequiredPopup();
      openLoginPopup();
    });
  }

  // --- Logica Caricamento e Filtro Eventi Passati (invariata) ---
  const eventiPassatiGrid = gebi("eventiPassatiGrid");
  const loadingIndicator = gebi("loadingIndicator");
  let allPastEvents = []; // Cambiato da allPastEventsData per coerenza con il file che mi hai dato

  function formatDate(dateString) {
    if (!dateString) return "Data non disponibile";
    try {
      const normalizedDateString = dateString.length === 10 ? dateString + "T00:00:00Z" : dateString.replace(" ", "T") + "Z";
      const date = new Date(normalizedDateString);
      if (isNaN(date.getTime())) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString.substring(0,10))) {
          const parts = dateString.substring(0,10).split('-');
          const utcDate = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
          if (!isNaN(utcDate.getTime())) {
            return utcDate.toLocaleDateString("it-IT", {
              day: "numeric", month: "long", year: "numeric", timeZone: 'UTC'
            });
          }
        }
        return dateString;
      }
      return date.toLocaleDateString("it-IT", {
        day: "numeric", month: "long", year: "numeric", timeZone: 'UTC'
      });
    } catch (e) {
      console.warn("Errore formattazione data:", dateString, e);
      return dateString;
    }
  }

  function createPastEventCard(event) {
    const card = document.createElement("article");
    card.className = "card";
    // Rimosso dataset.title, .date, .speaker per non creare discrepanze con il filtro attuale
    // che lavora su allPastEvents
    let imageSrc = event.immagine_url && event.immagine_url.trim() !== "" ? event.immagine_url : "images/default-event-past.jpg";

    card.innerHTML = `
            <div class="card-image-container">
                <img src="${imageSrc}" alt="Copertina: ${event.titolo || "Evento passato"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
            </div>
            <div class="card-content">
                <h3>${event.titolo || "Titolo non disponibile"}</h3>
                <p class="card-info">
                    <b>Data:</b> ${formatDate(event.datainizio)}
                    ${event.durata ? `<br><b>Orario/Durata:</b> ${event.durata}` : ""}
                </p>
                <p class="card-info">
                    <b>${event.prefisso_relatore || "Relatore"}:</b> ${event.relatore || "N/D"}
                    ${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}`: ""}
                </p>
                <p>${event.descrizione || "Nessuna descrizione breve disponibile."}</p>
                <div class="card-actions">
                    <a href="#" onclick="showLoginRequiredPopup(event); return false;" class="card-btn card-btn-primary">Dettagli</a>
                    <a href="#" onclick="showLoginRequiredPopup(event); return false;" class="card-btn card-btn-primary">Commenti</a>
                </div>
            </div>
        `;
    return card;
  }

  async function loadPastEvents() {
    if (!eventiPassatiGrid || !loadingIndicator) return;
    loadingIndicator.classList.add("visible");
    eventiPassatiGrid.innerHTML = "";

    try {
      const response = await fetch("get_past_events.php");
      if (!response.ok) {
        throw new Error( `Errore HTTP: ${response.status} ${response.statusText}` );
      }
      const result = await response.json();

      if (result.success && result.data) {
        allPastEvents = result.data; // Usa allPastEvents come nel tuo file
        filterEvents();
      } else {
        throw new Error( result.message || "Errore nel caricamento degli eventi passati." );
      }
    } catch (error) {
      console.error("Errore caricamento eventi passati:", error);
      if(eventiPassatiGrid) eventiPassatiGrid.innerHTML = `<p class="no-events error-message">Si √® verificato un errore durante il caricamento degli eventi. (${error.message})</p>`;
    } finally {
      if(loadingIndicator) loadingIndicator.classList.remove("visible");
    }
  }

  function filterEvents() {
    if (!eventiPassatiGrid) return;

    const titleFilter = gebi("searchTitle").value.toLowerCase().trim();
    const dateFilter = gebi("searchDate").value;
    const speakerFilter = gebi("searchSpeaker").value.toLowerCase().trim();

    eventiPassatiGrid.innerHTML = '';
    let visibleCardsCount = 0; // rinominato da visibleCards

    const filteredEvents = allPastEvents.filter(event => {
      const eventTitle = event.titolo?.toLowerCase() || "";
      const eventDateMonthYear = (event.datainizio && typeof event.datainizio === 'string') ? event.datainizio.substring(0, 7) : "";
      const eventSpeaker = event.relatore?.toLowerCase() || "";

      const titleMatch = !titleFilter || eventTitle.includes(titleFilter);
      const dateMatch = !dateFilter || (eventDateMonthYear === dateFilter);
      const speakerMatch = !speakerFilter || eventSpeaker.includes(speakerFilter);

      return titleMatch && dateMatch && speakerMatch;
    });

    if (filteredEvents.length > 0) {
      filteredEvents.forEach(event => {
        eventiPassatiGrid.appendChild(createPastEventCard(event));
      });
      visibleCardsCount = filteredEvents.length;
    }

    const existingNoResultsMessage = gebi("noResultsMessage");
    if (existingNoResultsMessage) existingNoResultsMessage.remove();

    if (visibleCardsCount === 0) {
      const p = document.createElement("p");
      p.id = "noResultsMessage";
      p.className = "no-events";
      if (titleFilter || dateFilter || speakerFilter) {
        p.textContent = "Nessun evento passato corrisponde ai criteri di ricerca.";
      } else if (allPastEvents.length === 0 && !(titleFilter || dateFilter || speakerFilter) ) {
        p.textContent = "Nessun evento passato trovato in archivio.";
      }
      if (p.textContent) {
        eventiPassatiGrid.appendChild(p);
      }
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const currentYearEl = gebi("currentYear");
    if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
    loadPastEvents();

    gebi("searchTitle").addEventListener("input", filterEvents);
    gebi("searchDate").addEventListener("change", filterEvents); // Mantenuto 'change' come nel tuo codice
    gebi("searchSpeaker").addEventListener("input", filterEvents);
  });
</script>
</body>
</html>