<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/logo.png" type="image/x-icon" />
  <title>Archivio Attivit√† - Eremo Frate Francesco</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@300;400;500;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Stili specifici per i filtri */
    .event-filters {
      background-color: var(--white);
      padding: 1.5rem;
      border-radius: var(--border-radius-medium);
      margin-bottom: 2rem;
      box-shadow: var(--shadow-light);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end; /* Allinea elementi in basso */
    }
    .event-filters .form-group {
      flex: 1 1 200px; /* Flex per adattarsi */
      margin-bottom: 0; /* Rimuove margine inferiore dal form-group */
    }
    .event-filters label {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      color: var(--primary);
      display: block;
    }
    .event-filters input,
    .event-filters select {
      width: 100%;
      padding: 0.7rem 1rem;
      border: 1px solid var(--gray-medium);
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .event-filters button { /* Stile per eventuale bottone filtro */
      padding: 0.7rem 1.5rem;
      background-color: var(--secondary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition-medium);
      height: fit-content; /* Adatta altezza */
    }
    .event-filters button:hover {
      background-color: var(--primary);
    }

    /* Stili Overlay Caricamento e No-Events */
    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0.85);
      display: flex;
      flex-direction: column; /* Per allineare spinner e testo verticalmente */
      justify-content: center;
      align-items: center;
      z-index: 10;
      visibility: hidden; opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      border-radius: inherit; /* Eredita il border-radius dal contenitore */
    }
    .loading-overlay.visible { visibility: visible; opacity: 1; }
    .loading-overlay .spinner { /* Spinner per il caricamento pagina */
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px; height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary);
      animation: spin 1s ease infinite;
      margin-bottom: 0.8rem;
    }
    .loading-overlay p {
      font-size: 1.1em;
      color: var(--dark);
      font-weight: 500;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .no-events { text-align: center; padding: 2rem; color: var(--gray-dark); }

    /* Stili Popup Login/Registrazione */
    .login-popup input.form-control.error-border { border-color: var(--danger, red) !important; }
    .login-popup input:-webkit-autofill,
    .login-popup input:-webkit-autofill:hover,
    .login-popup input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0px 1000px var(--white, white) inset !important;
      -webkit-text-fill-color: var(--dark, #333) !important;
    }
    .form-message { display: none; padding: 0.75rem; border-radius: 8px; font-size: 0.9em; margin-top: 0.5em; text-align: left; }
    .form-message.error { color: var(--danger, red); background-color: rgba(var(--danger-rgb, 231, 76, 60), 0.1); border: 1px solid rgba(var(--danger-rgb, 231, 76, 60), 0.3); }
    .form-message.success { color: var(--success, green); background-color: rgba(var(--success-rgb, 46, 204, 113), 0.1); border: 1px solid rgba(var(--success-rgb, 46, 204, 113), 0.3); }
    .terms-checkbox { text-align: left; font-size: 0.9em; margin-top: 0.5rem; margin-bottom: 1rem; color: var(--gray-dark); }
    .terms-checkbox input[type="checkbox"] { margin-right: 0.5rem; vertical-align: middle; }
    .terms-checkbox label { font-weight: normal; color: var(--gray-dark); }
    .terms-checkbox a { color: var(--primary); text-decoration: underline; }
    .spinner-mini-light { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; vertical-align: middle; margin-left: 5px; }
    .spinner-mini { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(0,0,0,0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin .6s linear infinite; vertical-align: middle; margin-right: 5px; }

    /* Stile per l'avatar immagine nella navbar */
    .user-avatar img {
      width: 30px; height: 30px; border-radius: 50%;
      object-fit: cover; vertical-align: middle;
    }
    .user-avatar span { /* Per icona carattere admin */
      font-size: 1.5em; line-height:1; vertical-align:middle;
    }


    /* Stili per bottoni admin nelle card */
    .card-actions.admin-actions {
      margin-top: 1rem; border-top: 1px solid var(--gray-light); padding-top: 1rem;
    }
    .card-actions.admin-actions .card-btn { flex-grow: 1; }
    .card-actions .btn-delete { background-color: var(--danger) !important; color: white !important; }
    .card-actions .btn-delete:hover { background-color: darkred !important; }

    /* Stili popup admin */
    .event-popup .form-message.success {
      color: var(--dark);
    }
    .event-popup .form-message.error {
      color: var(--dark);
    }
    #current-event-image-preview { max-width:100px; max-height:100px; display:none; margin-top:5px; border-radius: 4px; border: 1px solid var(--gray-light); }
    #current-event-flyer-preview a { color: var(--primary); text-decoration: underline; }
    #current-event-flyer-preview a:hover { color: var(--accent); }

  </style>
</head>
<body>

<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="index.html" id="logoLink"><span class="emoji">üèîÔ∏è</span><h2 id="navbarTitle">Eremo Frate Francesco</h2></a>
    </div>
    <div class="menu" id="mainMenu">
      <a href="eventiincorso.html" id="navCalendarioAttivita">Calendario attivit√†</a>
      <a href="eventipassati_unificato.html" class="active" id="navArchivioAttivita">Archivio attivit√†</a>
      <span class="separator">|</span>
      <a href="incontrisullaparola.html" id="navIncontriParola">Incontri sulla parola</a>
      <span class="separator">|</span>
      <a href="dovesiamo.html" id="navDoveSiamo">Dove siamo</a>
      <a href="contatti.html" id="navContatti">Contatti</a>
    </div>
    <div class="right-menu">
      <button id="login-btn-desktop" class="login-btn" style="display: none;">Accedi</button>
      <div class="user-dropdown" id="userDropdownContainer" style="display: none;">
        <button class="user-btn" id="userBtnTrigger" aria-haspopup="true" aria-expanded="false">
          <span class="user-avatar" id="navbar-avatar-container"></span>
          <span class="user-name" id="navbar-username">Utente</span>
          <span class="dropdown-arrow">‚ñº</span>
        </button>
        <div class="dropdown-menu" id="userDropdownMenu">
          <a href="areapersonale.html" id="dropdownProfilo" style="display: none;">Il mio profilo</a>
          <a href="areapersonale.html#prenotazioni" id="dropdownPrenotazioni" style="display: none;">Le mie prenotazioni</a>
          <a href="#" id="dropdownLogout">Esci</a>
        </div>
      </div>
      <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu">‚ò∞</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorso.html" id="mobileNavCalendarioAttivita">Calendario attivit√†</a>
    <a href="eventipassati_unificato.html" id="mobileNavArchivioAttivita">Archivio attivit√†</a>
    <a href="incontrisullaparola.html" id="mobileNavIncontriParola">Incontri sulla parola</a>
    <a href="dovesiamo.html" id="mobileNavDoveSiamo">Dove siamo</a>
    <a href="contatti.html" id="mobileNavContatti">Contatti</a>
    <hr id="mobileMenuSeparator" style="border-color: rgba(255,255,255,0.1); display:none;">
    <a href="#" id="login-btn-mobile" style="display: none;">Accedi</a>
    <a href="areapersonale.html" id="mobileNavProfilo" style="display: none;">Il mio profilo</a>
    <a href="areapersonale.html#prenotazioni" id="mobileNavPrenotazioni" style="display: none;">Le mie prenotazioni</a>
    <a href="#" id="mobileLogoutLink" style="display: none;">Esci</a>
  </div>
</header>

<main>
  <div class="container section-padding">
    <h1 id="mainPageTitle">Archivio Attivit√† Passate</h1>

    <div class="event-filters">
      <div class="form-group">
        <label for="searchTitle">Titolo Evento</label>
        <input type="text" id="searchTitle" placeholder="Cerca per titolo..." class="form-control"/>
      </div>
      <div class="form-group">
        <label for="searchDate">Mese/Anno (YYYY-MM)</label>
        <input type="month" id="searchDate" class="form-control" />
      </div>
      <div class="form-group">
        <label for="searchSpeaker">Relatore</label>
        <input type="text" id="searchSpeaker" class="form-control" placeholder="Nome relatore..."/>
      </div>
    </div>

    <div id="eventiGridContainer" style="position: relative">
      <div id="loadingIndicator" class="loading-overlay">
        <div class="spinner"></div>
        <p>Caricamento eventi...</p>
      </div>
      <div class="card-grid" id="eventiPassatiGrid"></div>
    </div>
  </div>
</main>

<footer>
  <p>¬© <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia</p>
</footer>

<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
  <button class="close-popup" id="closeLoginPopupBtn" aria-label="Chiudi popup">&times;</button>
  <div class="login-tabs">
    <div class="login-tab active" data-tab="login">Accedi</div>
    <div class="login-tab" data-tab="register">Registrati</div>
  </div>
  <form class="login-form active" id="loginFormPopup" method="POST">
    <div class="form-group"><label for="login-email-popup">Email</label><input type="email" id="login-email-popup" name="login-email" class="form-control" required autocomplete="email"/></div>
    <div class="form-group"><label for="login-password-popup">Password</label><input type="password" id="login-password-popup" name="login-password" class="form-control" required autocomplete="current-password"/></div>
    <div id="login-error-message-popup" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
    <div class="form-actions"><button type="submit" class="btn-popup">Accedi</button></div>
  </form>
  <form class="login-form" id="registerFormPopup" method="POST">
    <div class="form-group"><label for="register-name-popup">Nome</label><input type="text" id="register-name-popup" name="register-name" class="form-control" required autocomplete="given-name"/></div>
    <div class="form-group"><label for="register-surname-popup">Cognome</label><input type="text" id="register-surname-popup" name="register-surname" class="form-control" required autocomplete="family-name"/></div>
    <div class="form-group"><label for="register-email-popup">Email</label><input type="email" id="register-email-popup" name="register-email" class="form-control" required autocomplete="email"/></div>
    <div class="form-group"><label for="register-password-popup">Password</label><input type="password" id="register-password-popup" name="register-password" class="form-control" required minlength="8" autocomplete="new-password"/><small>Minimo 8 caratteri.</small></div>
    <div class="terms-checkbox"><input type="checkbox" id="register-terms-popup" name="register-terms" required><label for="register-terms-popup">Accetto i <a href="termini.html" target="_blank">termini e condizioni</a></label></div>
    <div id="register-error-message-popup" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
    <div class="form-actions"><button type="submit" class="btn-popup">Registrati</button></div>
  </form>
</div>

<div class="login-popup-overlay" id="loginRequiredOverlay"></div>
<div class="login-popup" id="loginRequiredPopup">
  <button class="close-popup" id="closeLoginRequiredPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h2 style="color: var(--primary); margin-top: 0; margin-bottom: 1.5rem; text-align: center; font-size: 1.8rem;">Accesso Richiesto</h2>
  <p style="text-align: center; margin-bottom: 1.5rem; font-size: 1.2rem; color: var(--dark);">Per visualizzare i dettagli completi dell'evento e i commenti, √® necessario effettuare l'accesso.</p>
  <div class="form-actions" style="text-align: center;">
    <button type="button" class="btn-popup" id="loginRequiredLoginBtn">Accedi / Registrati</button>
  </div>
</div>

<div class="event-popup-overlay" id="eventPopupOverlayAdmin" style="display:none;"></div>
<div class="event-popup" id="eventPopupAdmin" style="display:none;">
  <button class="close-popup" id="closeEventPopupBtnAdmin" aria-label="Chiudi popup">&times;</button>
  <h2 id="eventPopupTitleAdmin">Modifica Evento Passato</h2>
  <form id="editPastEventFormAdmin" method="POST" enctype="multipart/form-data">
    <input type="hidden" id="admin-event-id" name="event-id">
    <div class="form-group"> <label for="admin-event-title">Titolo Evento*</label> <input type="text" id="admin-event-title" name="event-title" class="form-control" required> </div>
    <div class="form-grid">
      <div class="form-group"> <label for="admin-event-date">Data Inizio*</label> <input type="date" id="admin-event-date" name="event-date" class="form-control" required> </div>
      <div class="form-group"> <label for="admin-event-time">Orario/Durata</label> <input type="text" id="admin-event-time" name="event-time" class="form-control" placeholder="es. 18:00-19:30 o 2 giorni"> </div>
    </div>
    <div class="form-group"> <label for="admin-event-short-desc">Descrizione Breve*</label> <textarea id="admin-event-short-desc" name="event-short-desc" class="form-control" rows="3" required maxlength="200"></textarea> </div>
    <div class="form-group"> <label for="admin-event-long-desc">Descrizione Estesa</label> <textarea id="admin-event-long-desc" name="event-long-desc" class="form-control" rows="5"></textarea> </div>
    <div class="form-grid">
      <div class="form-group"> <label for="admin-event-prefix">Prefisso Relatore</label> <input type="text" id="admin-event-prefix" name="event-prefix" class="form-control" placeholder="Default: Relatore"> </div>
      <div class="form-group"> <label for="admin-event-speaker">Nome Relatore*</label> <input type="text" id="admin-event-speaker" name="event-speaker" class="form-control" required> </div>
    </div>
    <div class="form-grid">
      <div class="form-group"> <label for="admin-event-association">Associazione</label> <input type="text" id="admin-event-association" name="event-association" class="form-control"> </div>
      <div class="form-group"> <label for="admin-event-seats">Posti Disponibili*</label> <input type="number" id="admin-event-seats" name="event-seats" class="form-control" required min="0"> </div>
    </div>
    <div class="form-group">
      <label for="admin-event-image">Immagine Copertina</label> <input type="file" id="admin-event-image" name="event-image" class="form-control" accept="image/*">
      <small>Lascia vuoto se non vuoi modificare l'immagine corrente.</small>
      <img id="current-event-image-preview" src="#" alt="Anteprima copertina">
    </div>
    <div class="form-group">
      <label for="admin-event-flyer">Volantino (PDF/Immagine)</label> <input type="file" id="admin-event-flyer" name="event-flyer" class="form-control" accept="image/*,application/pdf">
      <small>Lascia vuoto se non vuoi modificare il volantino corrente.</small>
      <div id="current-event-flyer-preview" style="margin-top:5px;"></div>
    </div>
    <div class="form-check-group"> <input type="checkbox" id="admin-event-booking" name="event-booking"> <label for="admin-event-booking">Era prenotabile?</label> </div>
    <div class="form-check-group"> <input type="checkbox" id="admin-event-voluntary" name="event-voluntary"> <label for="admin-event-voluntary">Costo su base volontaria (offerta libera)</label> </div>
    <div class="form-group" id="admin-event-price-container"> <label for="admin-event-price">Prezzo (‚Ç¨)</label> <input type="number" id="admin-event-price" name="event-price" class="form-control" min="0" step="0.01" placeholder="Es. 10.00"> </div>
    <div id="editPastEventFormMessageAdmin" class="form-message" style="display:none;"></div>
    <div class="form-actions"> <button type="submit" class="btn-popup">Salva Modifiche</button> </div>
  </form>
</div>


<script>
  const defaultUserIconPath = 'uploads/icons/default_user.png';
  let currentUserData = null;
  let allPastEventsData = [];

  function gebi(id) { return document.getElementById(id); }

  function loadUserData() {
    const uds = localStorage.getItem('userDataEFF');
    if (uds) {
      try {
        currentUserData = JSON.parse(uds);
        if (!currentUserData || typeof currentUserData.email === 'undefined') {
          currentUserData = null; localStorage.removeItem('userDataEFF');
        }
      } catch (e) {
        console.error("Errore parsing userDataEFF:", e);
        currentUserData = null; localStorage.removeItem('userDataEFF');
      }
    } else {
      currentUserData = null;
    }
  }

  async function fetchAndUpdateUserDisplayData() {
    if (!currentUserData || !currentUserData.email || currentUserData.isAdmin) {
      updateNavbarUI();
      return;
    }
    try {
      const response = await fetch(`api/api_get_user_profile.php?email=${encodeURIComponent(currentUserData.email)}`);
      if (!response.ok) throw new Error('Errore fetch profilo utente');
      const apiResult = await response.json();
      if (apiResult.success && apiResult.data) {
        const freshData = apiResult.data;
        currentUserData.nome = freshData.nome || currentUserData.nome;
        currentUserData.iconPath = freshData.icon || defaultUserIconPath;
        currentUserData.cognome = freshData.cognome || (currentUserData.cognome || '');
        localStorage.setItem('userDataEFF', JSON.stringify(currentUserData));
      }
    } catch (error) {
      console.warn("ArchivioAttivita: Errore fetch profilo aggiornato per navbar:", error.message);
    }
    updateNavbarUI();
  }

  function updateNavbarUI() {
    const logoLink = gebi('logoLink');
    if (logoLink) logoLink.href = "index.html"; // Sempre index.html

    const navbarTitle = gebi('navbarTitle');
    const loginBtnDesktop = gebi('login-btn-desktop');
    const userDropdownContainer = gebi('userDropdownContainer');
    const navbarAvatarContainer = gebi('navbar-avatar-container');
    const navbarUsername = gebi('navbar-username');
    const dropdownProfilo = gebi('dropdownProfilo');
    const dropdownPrenotazioni = gebi('dropdownPrenotazioni');
    const dropdownLogout = gebi('dropdownLogout');
    const loginBtnMobile = gebi('login-btn-mobile');
    const mobileNavProfilo = gebi('mobileNavProfilo');
    const mobileNavPrenotazioni = gebi('mobileNavPrenotazioni');
    const mobileLogoutLink = gebi('mobileLogoutLink');
    const mobileMenuSeparator = gebi('mobileMenuSeparator');
    const mainPageTitle = gebi('mainPageTitle');
    const userDropdownMenu = gebi('userDropdownMenu');
    const mobileMenu = gebi('mobileMenu');

    // Ensure admin links exist or create them
    let dropdownDashboard = gebi('dropdownDashboard');
    if (userDropdownMenu && !dropdownDashboard) {
      dropdownDashboard = document.createElement('a');
      dropdownDashboard.id = 'dropdownDashboard';
      dropdownDashboard.href = 'dashboard.html';
      dropdownDashboard.textContent = 'Dashboard Admin';
      userDropdownMenu.insertBefore(dropdownDashboard, dropdownLogout);
    }
    let dropdownGestioneEventi = gebi('dropdownGestioneEventi');
    if (userDropdownMenu && !dropdownGestioneEventi) {
      dropdownGestioneEventi = document.createElement('a');
      dropdownGestioneEventi.id = 'dropdownGestioneEventi';
      dropdownGestioneEventi.href = 'eventiincorsoAdmin.html';
      dropdownGestioneEventi.textContent = 'Gestione Eventi';
      userDropdownMenu.insertBefore(dropdownGestioneEventi, dropdownLogout);
    }

    let mobileNavDashboard = gebi('mobileNavDashboard');
    if (mobileMenu && !mobileNavDashboard) {
      mobileNavDashboard = document.createElement('a');
      mobileNavDashboard.id = 'mobileNavDashboard';
      mobileNavDashboard.href = 'dashboard.html';
      mobileNavDashboard.textContent = 'Dashboard Admin';
      mobileMenu.insertBefore(mobileNavDashboard, mobileLogoutLink);
    }
    let mobileNavGestioneEventiAdmin = gebi('mobileNavGestioneEventiAdmin');
    if (mobileMenu && !mobileNavGestioneEventiAdmin) {
      mobileNavGestioneEventiAdmin = document.createElement('a');
      mobileNavGestioneEventiAdmin.id = 'mobileNavGestioneEventiAdmin';
      mobileNavGestioneEventiAdmin.href = 'eventiincorsoAdmin.html';
      mobileNavGestioneEventiAdmin.textContent = 'Gestione Eventi';
      mobileMenu.insertBefore(mobileNavGestioneEventiAdmin, mobileLogoutLink);
    }

    // Hide all by default
    if (loginBtnDesktop) loginBtnDesktop.style.display = 'none';
    if (userDropdownContainer) userDropdownContainer.style.display = 'none';
    if (dropdownProfilo) dropdownProfilo.style.display = 'none';
    if (dropdownPrenotazioni) dropdownPrenotazioni.style.display = 'none';
    if (dropdownDashboard) dropdownDashboard.style.display = 'none';
    if (dropdownGestioneEventi) dropdownGestioneEventi.style.display = 'none';
    if (loginBtnMobile) loginBtnMobile.style.display = 'none';
    if (mobileNavProfilo) mobileNavProfilo.style.display = 'none';
    if (mobileNavPrenotazioni) mobileNavPrenotazioni.style.display = 'none';
    if (mobileNavDashboard) mobileNavDashboard.style.display = 'none';
    if (mobileNavGestioneEventiAdmin) mobileNavGestioneEventiAdmin.style.display = 'none';
    if (mobileLogoutLink) mobileLogoutLink.style.display = 'none';
    if (mobileMenuSeparator) mobileMenuSeparator.style.display = 'none';

    if (currentUserData) { // User Logged In (User or Admin)
      if (userDropdownContainer) userDropdownContainer.style.display = 'inline-block';
      if (navbarUsername) navbarUsername.textContent = currentUserData.nome || currentUserData.email.split('@')[0];
      if (navbarAvatarContainer) {
        if (currentUserData.isAdmin) {
          navbarAvatarContainer.innerHTML = `<span>üëë</span>`;
        } else {
          navbarAvatarContainer.innerHTML = `<img src="${currentUserData.iconPath || defaultUserIconPath}" alt="User Avatar">`;
          const img = navbarAvatarContainer.querySelector('img');
          if (img) img.onerror = function() { this.src = defaultUserIconPath; };
        }
      }

      if (mobileLogoutLink) mobileLogoutLink.style.display = 'block';
      if (mobileMenuSeparator) mobileMenuSeparator.style.display = 'block';

      if (currentUserData.isAdmin) {
        if (navbarTitle) navbarTitle.textContent = "Eremo (Admin)";
        if (mainPageTitle) mainPageTitle.textContent = "Gestione Archivio Attivit√†";
        if (dropdownDashboard) dropdownDashboard.style.display = 'block';
        if (dropdownGestioneEventi) dropdownGestioneEventi.style.display = 'block';
        if (mobileNavDashboard) mobileNavDashboard.style.display = 'block';
        if (mobileNavGestioneEventiAdmin) mobileNavGestioneEventiAdmin.style.display = 'block';
      } else { // Regular Logged-in User
        if (navbarTitle) navbarTitle.textContent = "Eremo Frate Francesco";
        if (mainPageTitle) mainPageTitle.textContent = "Archivio Attivit√† Passate";
        if (dropdownProfilo) dropdownProfilo.style.display = 'block';
        if (dropdownPrenotazioni) dropdownPrenotazioni.style.display = 'block';
        if (mobileNavProfilo) mobileNavProfilo.style.display = 'block';
        if (mobileNavPrenotazioni) mobileNavPrenotazioni.style.display = 'block';
      }
    } else { // Guest
      if (loginBtnDesktop) loginBtnDesktop.style.display = 'inline-block';
      if (loginBtnMobile) loginBtnMobile.style.display = 'block';
      if (navbarTitle) navbarTitle.textContent = "Eremo Frate Francesco";
      if (mainPageTitle) mainPageTitle.textContent = "Archivio Attivit√† Passate";
    }
  }


  function handleLogout() {
    localStorage.removeItem('userDataEFF');
    currentUserData = null;
    updateNavbarUI();
    loadPastEvents();
    alert('Logout effettuato.');
  }

  let lastScrollNav = 0; const navbarContainerEl = gebi("navbarContainer"); if (navbarContainerEl) { window.addEventListener("scroll", function () { const cS = window.pageYOffset || document.documentElement.scrollTop; if (cS <= 50) { navbarContainerEl.classList.remove("hidden"); lastScrollNav = 0; return; } if (cS > lastScrollNav && !navbarContainerEl.classList.contains("hidden")) navbarContainerEl.classList.add("hidden"); else if (cS < lastScrollNav && navbarContainerEl.classList.contains("hidden")) navbarContainerEl.classList.remove("hidden"); lastScrollNav = cS <= 0 ? 0 : cS; }, false); }
  const mobileMenuEl = gebi("mobileMenu"); const hamburgerButton = gebi("hamburgerBtn"); function toggleMobileMenu() { if (mobileMenuEl && hamburgerButton) { const iO = mobileMenuEl.classList.toggle("open"); hamburgerButton.classList.toggle("open"); hamburgerButton.setAttribute("aria-expanded", String(iO)); document.body.style.overflow = iO ? "hidden" : ""; } } function closeMobileMenu() { if (mobileMenuEl && hamburgerButton && mobileMenuEl.classList.contains("open")) { mobileMenuEl.classList.remove("open"); hamburgerButton.classList.remove("open"); hamburgerButton.setAttribute("aria-expanded", "false"); document.body.style.overflow = ""; } }
  if (hamburgerButton) hamburgerButton.addEventListener("click", toggleMobileMenu);
  document.querySelectorAll("#mobileMenu a").forEach(l => { if (l.id !== 'login-btn-mobile' && l.id !== 'mobileLogoutLink') { l.addEventListener("click", closeMobileMenu); }});
  document.addEventListener("click", function (e) { if (mobileMenuEl && mobileMenuEl.classList.contains("open") && hamburgerButton && !mobileMenuEl.contains(e.target) && !hamburgerButton.contains(e.target)) closeMobileMenu(); });
  const userBtnTriggerEl = gebi('userBtnTrigger'); const userDropdownMenuEl = gebi('userDropdownMenu'); if (userBtnTriggerEl && userDropdownMenuEl) { userBtnTriggerEl.addEventListener('click', function (e) { e.stopPropagation(); const iS = userDropdownMenuEl.style.display === 'block'; userDropdownMenuEl.style.display = iS ? 'none' : 'block'; this.setAttribute('aria-expanded', String(!iS)); }); document.addEventListener('click', function (e) { if (userDropdownMenuEl && userDropdownMenuEl.style.display === 'block' && !userBtnTriggerEl.contains(e.target) && !userDropdownMenuEl.contains(e.target)) { userDropdownMenuEl.style.display = 'none'; userBtnTriggerEl.setAttribute('aria-expanded', 'false'); } }); }

  const loginOverlayEl = gebi("loginOverlay");
  const loginPopupEl = gebi("loginPopup");
  const closePopupBtnEl = gebi("closeLoginPopupBtn");
  const loginTabsEls = document.querySelectorAll(".login-tab");
  const loginFormsEls = document.querySelectorAll(".login-popup .login-form");
  const loginErrorMessagePopupEl = gebi('login-error-message-popup');
  const registerErrorMessagePopupEl = gebi('register-error-message-popup');

  function openLoginPopup() {
    if (loginOverlayEl) loginOverlayEl.classList.add("active");
    if (loginPopupEl) loginPopupEl.classList.add("active");
    document.body.style.overflow = "hidden";
    resetFormErrors();
    const loginTabToActivate = loginPopupEl.querySelector('.login-tab[data-tab="login"]');
    if (loginTabToActivate) loginTabToActivate.click();
    const firstInput = loginPopupEl.querySelector('#loginFormPopup input:not([type="hidden"])');
    if (firstInput) firstInput.focus();
  }

  function closeLoginPopup() {
    if (loginOverlayEl) loginOverlayEl.classList.remove("active");
    if (loginPopupEl) loginPopupEl.classList.remove("active");
    document.body.style.overflow = "";
    resetFormErrors();
  }

  function resetFormErrors() {
    loginFormsEls.forEach(form => {
      form.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border'));
    });
    if (loginErrorMessagePopupEl) loginErrorMessagePopupEl.style.display = 'none';
    if (registerErrorMessagePopupEl) registerErrorMessagePopupEl.style.display = 'none';
  }

  gebi("login-btn-desktop")?.addEventListener("click", (e) => { e.preventDefault(); openLoginPopup(); });
  gebi("login-btn-mobile")?.addEventListener("click", (e) => { e.preventDefault(); openLoginPopup(); closeMobileMenu(); });
  if (closePopupBtnEl) closePopupBtnEl.addEventListener("click", closeLoginPopup);
  if (loginOverlayEl) loginOverlayEl.addEventListener("click", (e) => { if (e.target === loginOverlayEl) closeLoginPopup(); });

  loginTabsEls.forEach((tab) => {
    tab.addEventListener("click", () => {
      const tabId = tab.getAttribute("data-tab");
      loginTabsEls.forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");
      loginFormsEls.forEach((form) => {
        form.classList.remove("active");
        if (form.id === `${tabId}FormPopup`) {
          form.classList.add("active");
          form.querySelector('input:not([type="hidden"])')?.focus();
        }
      });
      resetFormErrors();
    });
  });

  gebi("loginFormPopup")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const loginButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = loginButton.textContent;
    loginButton.disabled = true;
    loginButton.innerHTML = 'Accesso... <div class="spinner-mini-light"></div>';
    const emailInput = gebi('login-email-popup');
    const passwordInput = gebi('login-password-popup');
    emailInput.classList.remove('error-border');
    passwordInput.classList.remove('error-border');
    if(loginErrorMessagePopupEl) loginErrorMessagePopupEl.style.display = 'none';

    try {
      const response = await fetch('login.php', { method: 'POST', body: new FormData(e.target) });
      if (!response.ok) {
        let errorData = { message: `Errore HTTP: ${response.status}` };
        try { errorData = await response.json(); } catch (parseError) { /* Ignora */ }
        throw new Error(errorData.message || `Errore HTTP: ${response.status}`);
      }
      const result = await response.json();
      if (result.success) {
        currentUserData = {
          nome: result.nome, email: result.email,
          iconPath: result.iconPath, // Will be handled by updateNavbarUI if admin or not
          isAdmin: result.is_admin === true || result.is_admin === 1
        };
        localStorage.setItem('userDataEFF', JSON.stringify(currentUserData));
        await fetchAndUpdateUserDisplayData(); // This calls updateNavbarUI internally
        closeLoginPopup();
        loadPastEvents(); // Reload events to reflect new user state
        // Admin stays on this page, UI updates to admin view.
      } else {
        emailInput.classList.add('error-border');
        passwordInput.classList.add('error-border');
        if(loginErrorMessagePopupEl) {
          loginErrorMessagePopupEl.textContent = result.message || "Credenziali non valide.";
          loginErrorMessagePopupEl.style.display = 'block';
        }
      }
    } catch (error) {
      emailInput.classList.add('error-border');
      passwordInput.classList.add('error-border');
      if(loginErrorMessagePopupEl) {
        loginErrorMessagePopupEl.textContent = "Errore di connessione o risposta non valida.";
        loginErrorMessagePopupEl.style.display = 'block';
      }
      console.error("Errore login:", error);
    } finally {
      loginButton.disabled = false;
      loginButton.innerHTML = originalButtonText;
    }
  });

  gebi("registerFormPopup")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const registerButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = registerButton.textContent;
    registerButton.disabled = true;
    registerButton.innerHTML = 'Registrazione... <div class="spinner-mini-light"></div>';
    if(registerErrorMessagePopupEl) registerErrorMessagePopupEl.style.display = 'none';
    e.target.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border'));

    try {
      const response = await fetch('registrati.php', { method: 'POST', body: new FormData(e.target) });
      if (!response.ok) {
        let errorMsg = `Errore HTTP: ${response.status} ${response.statusText}`;
        try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; }
        catch(err) { /* Ignora */ }
        throw new Error(errorMsg);
      }
      const result = await response.json();
      if (result.success) {
        alert(result.message || "Registrazione completata! Ora puoi effettuare il login.");
        const loginTabButton = document.querySelector('.login-tab[data-tab="login"]');
        if (loginTabButton) loginTabButton.click();
        const loginEmailPopup = gebi('login-email-popup');
        const registerEmailPopup = gebi('register-email-popup');
        if (loginEmailPopup && registerEmailPopup) loginEmailPopup.value = registerEmailPopup.value;
        e.target.reset();
      } else {
        if(registerErrorMessagePopupEl) {
          registerErrorMessagePopupEl.textContent = result.message || "Errore durante la registrazione.";
          registerErrorMessagePopupEl.style.display = 'block';
        }
        if (result.errors) {
          for (const fieldNameFromError in result.errors) {
            const inputElement = e.target.elements[fieldNameFromError] || gebi(`register-${fieldNameFromError}-popup`);
            if (inputElement) inputElement.classList.add('error-border');
          }
        }
      }
    } catch (error) {
      if(registerErrorMessagePopupEl) {
        registerErrorMessagePopupEl.textContent = "Errore: " + error.message;
        registerErrorMessagePopupEl.style.display = 'block';
      }
      console.error("Dettaglio errore registrazione:", error);
    } finally {
      registerButton.disabled = false;
      registerButton.innerHTML = originalButtonText;
    }
  });

  const loginRequiredOverlayEl = gebi("loginRequiredOverlay");
  const loginRequiredPopupEl = gebi("loginRequiredPopup");
  const closeLoginRequiredPopupBtnEl = gebi("closeLoginRequiredPopupBtn");
  const loginRequiredLoginBtnEl = gebi("loginRequiredLoginBtn");

  function showLoginRequiredPopup(event) {
    if (event) event.preventDefault();
    if (loginRequiredOverlayEl) loginRequiredOverlayEl.classList.add("active");
    if (loginRequiredPopupEl) loginRequiredPopupEl.classList.add("active");
    document.body.style.overflow = "hidden";
  }

  function closeLoginRequiredPopup() {
    if (loginRequiredOverlayEl) loginRequiredOverlayEl.classList.remove("active");
    if (loginRequiredPopupEl) loginRequiredPopupEl.classList.remove("active");
    if (!loginPopupEl || !loginPopupEl.classList.contains("active")) {
      document.body.style.overflow = "";
    }
  }

  if (closeLoginRequiredPopupBtnEl) closeLoginRequiredPopupBtnEl.addEventListener("click", closeLoginRequiredPopup);
  if (loginRequiredOverlayEl) loginRequiredOverlayEl.addEventListener("click", (e) => { if (e.target === loginRequiredOverlayEl) closeLoginRequiredPopup(); });
  if (loginRequiredLoginBtnEl) { loginRequiredLoginBtnEl.addEventListener("click", () => { closeLoginRequiredPopup(); openLoginPopup(); }); }

  const eventPopupOverlayAdminEl = gebi('eventPopupOverlayAdmin');
  const eventPopupAdminEl = gebi('eventPopupAdmin');
  const closeEventPopupBtnAdminEl = gebi('closeEventPopupBtnAdmin');
  const editPastEventFormAdminEl = gebi('editPastEventFormAdmin');
  const eventPopupTitleAdminEl = gebi('eventPopupTitleAdmin');
  const adminEventIdInput = gebi('admin-event-id');
  const adminVoluntaryCheckbox = gebi('admin-event-voluntary');
  const adminPriceContainer = gebi('admin-event-price-container');
  const adminEventPriceInput = gebi('admin-event-price');
  const editPastEventFormMessageAdminEl = gebi('editPastEventFormMessageAdmin');
  const adminCurrentImagePreview = gebi('current-event-image-preview');
  const adminCurrentFlyerPreview = gebi('current-event-flyer-preview');

  function updateAdminPriceFieldVisibility() {
    if (adminVoluntaryCheckbox && adminPriceContainer && adminEventPriceInput) {
      const isVoluntary = adminVoluntaryCheckbox.checked;
      adminPriceContainer.style.display = isVoluntary ? 'none' : 'block';
      adminEventPriceInput.required = !isVoluntary;
      if (isVoluntary) adminEventPriceInput.value = '';
    }
  }
  if (adminVoluntaryCheckbox) adminVoluntaryCheckbox.addEventListener('change', updateAdminPriceFieldVisibility);

  function openEditPastEventPopup(eventData) {
    if (!currentUserData || !currentUserData.isAdmin) return;
    if (!editPastEventFormAdminEl || !eventPopupAdminEl || !eventPopupOverlayAdminEl) return;

    editPastEventFormAdminEl.reset();
    if(editPastEventFormMessageAdminEl) {
      editPastEventFormMessageAdminEl.style.display = 'none';
      editPastEventFormMessageAdminEl.className = 'form-message';
    }
    if(adminCurrentImagePreview) { adminCurrentImagePreview.style.display = 'none'; adminCurrentImagePreview.src = '#';}
    if(adminCurrentFlyerPreview) adminCurrentFlyerPreview.innerHTML = '';
    if(eventPopupTitleAdminEl) eventPopupTitleAdminEl.textContent = 'Modifica Evento Passato';
    if(adminEventIdInput) adminEventIdInput.value = eventData.idevento;
    gebi('admin-event-title').value = eventData.titolo || '';
    gebi('admin-event-date').value = eventData.datainizio ? eventData.datainizio.substring(0,10) : '';
    gebi('admin-event-time').value = eventData.durata || '';
    gebi('admin-event-short-desc').value = eventData.descrizione || '';
    gebi('admin-event-long-desc').value = eventData.descrizione_estesa || '';
    gebi('admin-event-prefix').value = eventData.prefisso_relatore || '';
    gebi('admin-event-speaker').value = eventData.relatore || '';
    gebi('admin-event-association').value = eventData.associazione || '';
    gebi('admin-event-seats').value = eventData.posti_disponibili !== null ? eventData.posti_disponibili : '';
    gebi('admin-event-booking').checked = !!eventData.flagprenotabile;
    if(adminVoluntaryCheckbox) adminVoluntaryCheckbox.checked = parseFloat(eventData.costo) === 0.00;
    updateAdminPriceFieldVisibility();
    if (adminEventPriceInput && !adminVoluntaryCheckbox.checked && eventData.costo && parseFloat(eventData.costo) > 0) {
      adminEventPriceInput.value = parseFloat(eventData.costo).toFixed(2);
    } else if (adminEventPriceInput) {
      adminEventPriceInput.value = '';
    }
    if (adminCurrentImagePreview && eventData.immagine_url) {
      adminCurrentImagePreview.src = eventData.immagine_url;
      adminCurrentImagePreview.style.display = 'block';
    }
    if (adminCurrentFlyerPreview && eventData.volantino_url) {
      const fileName = eventData.volantino_url.split('/').pop();
      adminCurrentFlyerPreview.innerHTML = `<p>Volantino attuale: <a href="${eventData.volantino_url}" target="_blank">${fileName}</a></p>`;
    }
    eventPopupOverlayAdminEl.style.display = 'block';
    eventPopupAdminEl.style.display = 'block';
    setTimeout(() => {
      eventPopupOverlayAdminEl.classList.add('active');
      eventPopupAdminEl.classList.add('active');
    }, 10);
    document.body.style.overflow = 'hidden';
    gebi('admin-event-title').focus();
  }

  function closeEditPastEventPopup() {
    if (!eventPopupAdminEl || !eventPopupOverlayAdminEl) return;
    eventPopupOverlayAdminEl.classList.remove('active');
    eventPopupAdminEl.classList.remove('active');
    setTimeout(() => {
      eventPopupOverlayAdminEl.style.display = 'none';
      eventPopupAdminEl.style.display = 'none';
      if (!loginPopupEl?.classList.contains('active') && !loginRequiredPopupEl?.classList.contains('active')) {
        document.body.style.overflow = '';
      }
    }, 300);
  }

  if (closeEventPopupBtnAdminEl) closeEventPopupBtnAdminEl.addEventListener('click', closeEditPastEventPopup);
  if (eventPopupOverlayAdminEl) eventPopupOverlayAdminEl.addEventListener('click', (e) => { if (e.target === eventPopupOverlayAdminEl) closeEditPastEventPopup(); });

  editPastEventFormAdminEl?.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentUserData || !currentUserData.isAdmin) return;
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div class="spinner-mini"></div>Salvataggio...';
    if(editPastEventFormMessageAdminEl) {
      editPastEventFormMessageAdminEl.style.display = 'none';
      editPastEventFormMessageAdminEl.className = 'form-message';
    }
    try {
      const formData = new FormData(this);
      formData.append('action', 'update_event');
      const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
      const responseText = await response.text();
      let result;
      try { result = JSON.parse(responseText); }
      catch (jsonError) { throw new Error(`Risposta non JSON: ${responseText.substring(0,200)}`); }
      if (!response.ok) throw new Error(result.message || `Errore server: ${response.status}`);
      if (result.success) {
        if(editPastEventFormMessageAdminEl) {
          editPastEventFormMessageAdminEl.textContent = result.message || 'Evento aggiornato!';
          editPastEventFormMessageAdminEl.classList.add('success');
        }
        loadPastEvents();
        setTimeout(closeEditPastEventPopup, 1500);
      } else { throw new Error(result.message || 'Errore aggiornamento.'); }
    } catch (error) {
      console.error('Errore form modifica (admin):', error);
      if(editPastEventFormMessageAdminEl) {
        editPastEventFormMessageAdminEl.textContent = `Errore: ${error.message}`;
        editPastEventFormMessageAdminEl.classList.add('error');
      }
    } finally {
      if(editPastEventFormMessageAdminEl) editPastEventFormMessageAdminEl.style.display = 'block';
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
    }
  });

  const eventiPassatiGridEl = gebi("eventiPassatiGrid");
  const loadingIndicatorEl = gebi("loadingIndicator");

  function formatDate(dateString) {
    if (!dateString) return "Data non disponibile";
    try {
      const normalizedDateString = dateString.length === 10 ? dateString + "T00:00:00Z" : dateString.replace(" ", "T") + (dateString.endsWith("Z") ? "" : "Z");
      const date = new Date(normalizedDateString);
      if (isNaN(date.getTime())) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString.substring(0,10))) {
          const parts = dateString.substring(0,10).split('-');
          const utcDate = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
          if (!isNaN(utcDate.getTime())) {
            return utcDate.toLocaleDateString("it-IT", { day: "numeric", month: "long", year: "numeric", timeZone: 'UTC' });
          }
        }
        return dateString;
      }
      return date.toLocaleDateString("it-IT", { day: "numeric", month: "long", year: "numeric", timeZone: 'UTC' });
    } catch (e) {
      console.warn("Errore formattazione data:", dateString, e);
      return dateString;
    }
  }

  function createPastEventCard(event) {
    const card = document.createElement("article");
    card.className = "card";
    if (currentUserData && currentUserData.isAdmin) card.classList.add('admin-card');
    card.dataset.title = event.titolo?.toLowerCase() || '';
    card.dataset.date = event.datainizio || '';
    card.dataset.speaker = event.relatore?.toLowerCase() || '';
    let imageSrc = event.immagine_url?.trim() ? event.immagine_url : "images/default-event-past.jpg";

    if (currentUserData && currentUserData.isAdmin) {
      let volantinoInfoHtml = event.volantino_url ? `<p class="card-info" style="font-size:0.9em;"><b>Volantino:</b> <a href="${event.volantino_url}" target="_blank">${event.volantino_url.split('/').pop()}</a></p>` : '';
      card.innerHTML = `
            <div class="card-image-container"><img src="${imageSrc}" alt="Copertina: ${event.titolo || "Evento"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';"></div>
            <div class="card-content">
                <h3>${event.titolo || "Titolo N/D"}</h3>
                <p class="card-info"><b>Data:</b> ${formatDate(event.datainizio)}${event.durata ? `<br><b>Orario/Durata:</b> ${event.durata}` : ""}</p>
                <p class="card-info"><b>${event.prefisso_relatore || "Relatore"}:</b> ${event.relatore || "N/D"}${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}`: ""}</p>
                <p class="card-description" style="font-size:0.95em; min-height: 4.5em;">${event.descrizione || "N/D"}</p>
                <p class="card-info" style="font-size:0.9em;"><b>Posti:</b> ${event.posti_disponibili !== null ? event.posti_disponibili : 'N/D'}${(event.costo !== null && parseFloat(event.costo) > 0) ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨` : (parseFloat(event.costo) === 0 ? '<br><b>Costo:</b> Offerta libera' : '')}</p>
                <p class="card-info" style="font-size:0.9em;">Stato Prenotazioni: ${event.flagprenotabile ? '<span style="color:green;font-weight:bold;">Aperte</span>' : '<span style="color:red;">Chiuse</span>'}</p>
                ${volantinoInfoHtml}
                <div class="card-actions admin-actions">
                    <button class="card-btn btn-edit card-btn-secondary" data-event-id="${event.idevento}">Modifica</button>
                    <button class="card-btn btn-delete card-btn-primary" data-event-id="${event.idevento}">Elimina</button>
                </div>
            </div>`;
      card.querySelector('.btn-edit').addEventListener('click', function() {
        const eventToEdit = allPastEventsData.find(e => e.idevento == this.dataset.eventId);
        if (eventToEdit) openEditPastEventPopup(eventToEdit); else alert("Dettagli non trovati.");
      });
      card.querySelector('.btn-delete').addEventListener('click', async function() {
        const eventId = this.dataset.eventId;
        const eventToDelete = allPastEventsData.find(e => e.idevento == eventId);
        if (confirm(`Eliminare "${eventToDelete?.titolo || "questo evento"}"? L'azione √® irreversibile.`)) {
          const btn = this; const oldTxt = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<div class="spinner-mini" style="border-top-color:white;"></div>';
          try {
            const fd = new FormData(); fd.append('action', 'delete_event'); fd.append('event_id', eventId);
            const r = await fetch('gestione_eventi.php', { method: 'POST', body: fd });
            const rt = await r.text(); let res; try { res = JSON.parse(rt); } catch { throw new Error("Risposta non JSON (delete)"); }
            if (!r.ok || !res.success) throw new Error(res.message || "Eliminazione fallita.");
            alert(res.message || 'Eliminato.'); loadPastEvents();
          } catch (err) { console.error('Errore eliminazione:', err); alert(`Errore: ${err.message}`); }
          finally { btn.disabled = false; btn.innerHTML = oldTxt; }
        }
      });
    } else { // Guest o User loggato
      const actionsHTML = currentUserData ? `
            <a href="evento_dettaglio_accesso.html?id=${event.idevento}" class="card-btn card-btn-primary">Dettagli</a>
            <a href="evento_dettaglio_accesso.html?id=${event.idevento}#event-comments" class="card-btn card-btn-primary">Commenti</a>` : `
            <a href="#" onclick="showLoginRequiredPopup(event); return false;" class="card-btn card-btn-primary">Dettagli</a>
            <a href="#" onclick="showLoginRequiredPopup(event); return false;" class="card-btn card-btn-primary">Commenti</a>`;
      card.innerHTML = `
            <div class="card-image-container"><img src="${imageSrc}" alt="Copertina: ${event.titolo || "Evento"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';"></div>
            <div class="card-content">
                <h3>${event.titolo || "Titolo N/D"}</h3>
                <p class="card-info"><b>Data:</b> ${formatDate(event.datainizio)}${event.durata ? `<br><b>Orario/Durata:</b> ${event.durata}` : ""}</p>
                <p class="card-info"><b>${event.prefisso_relatore || "Relatore"}:</b> ${event.relatore || "N/D"}${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}`: ""}</p>
                <p class="card-description">${event.descrizione || "Nessuna descrizione."}</p>
                <div class="card-actions">${actionsHTML}</div>
            </div>`;
    }
    return card;
  }

  async function loadPastEvents() {
    if (!eventiPassatiGridEl || !loadingIndicatorEl) return;
    loadingIndicatorEl.classList.add("visible");
    eventiPassatiGridEl.innerHTML = "";
    try {
      const response = await fetch("get_past_events.php");
      if (!response.ok) throw new Error( `Errore HTTP: ${response.status} ${response.statusText}` );
      const result = await response.json();
      if (result.success && result.data) {
        allPastEventsData = result.data;
        filterEvents();
      } else { throw new Error( result.message || "Errore caricamento eventi." ); }
    } catch (error) {
      console.error("Errore loadPastEvents:", error);
      if(eventiPassatiGridEl) eventiPassatiGridEl.innerHTML = `<p class="no-events error-message" style="text-align:center; padding:20px;">Errore caricamento. (${error.message}) <button onclick="loadPastEvents()" class="btn-popup" style="margin-top:10px;">Riprova</button></p>`;
    } finally {
      if(loadingIndicatorEl) loadingIndicatorEl.classList.remove("visible");
    }
  }

  function filterEvents() {
    if (!eventiPassatiGridEl) return;
    const titleFilter = gebi("searchTitle").value.toLowerCase().trim();
    const dateFilter = gebi("searchDate").value;
    const speakerFilter = gebi("searchSpeaker").value.toLowerCase().trim();
    eventiPassatiGridEl.innerHTML = '';
    let visibleCardsCount = 0;
    const filteredEvents = allPastEventsData.filter(event => {
      const eventTitle = event.titolo?.toLowerCase() || "";
      const eventDateMonthYear = event.datainizio?.substring(0, 7) || "";
      const eventSpeaker = event.relatore?.toLowerCase() || "";
      const titleMatch = !titleFilter || eventTitle.includes(titleFilter);
      const dateMatch = !dateFilter || (eventDateMonthYear === dateFilter);
      const speakerMatch = !speakerFilter || eventSpeaker.includes(speakerFilter);
      return titleMatch && dateMatch && speakerMatch;
    });
    if (filteredEvents.length > 0) {
      filteredEvents.forEach(event => eventiPassatiGridEl.appendChild(createPastEventCard(event)));
      visibleCardsCount = filteredEvents.length;
    }
    const existingNoResultsMessage = gebi("noResultsMessage");
    if (existingNoResultsMessage) existingNoResultsMessage.remove();
    if (visibleCardsCount === 0) {
      const p = document.createElement("p");
      p.id = "noResultsMessage"; p.className = "no-events";
      if (titleFilter || dateFilter || speakerFilter) {
        p.textContent = "Nessun evento passato corrisponde ai criteri di ricerca.";
      } else if (allPastEventsData.length === 0) {
        p.textContent = "Nessun evento passato trovato in archivio.";
      }
      if (p.textContent) eventiPassatiGridEl.appendChild(p);
    }
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const currentYearEl = gebi("currentYear");
    if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
    loadUserData();
    await fetchAndUpdateUserDisplayData();
    loadPastEvents();
    gebi("searchTitle")?.addEventListener("input", filterEvents);
    gebi("searchDate")?.addEventListener("change", filterEvents);
    gebi("searchSpeaker")?.addEventListener("input", filterEvents);
    gebi('dropdownLogout')?.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
    gebi('mobileLogoutLink')?.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); closeMobileMenu(); });
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        if (loginPopupEl?.classList.contains("active")) closeLoginPopup();
        if (loginRequiredPopupEl?.classList.contains("active")) closeLoginRequiredPopup();
        if (eventPopupAdminEl?.classList.contains("active")) closeEditPastEventPopup();
      }
    });
    if (currentUserData && currentUserData.isAdmin && typeof updateAdminPriceFieldVisibility === 'function') {
      updateAdminPriceFieldVisibility();
    }
  });
</script>
</body>
</html>