<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/logo.png" type="image/x-icon" />
  <title>Archivio Attività - Eremo Frate Francesco</title>
  <script src="https://cdn.jsdelivr.net/npm/liquid-web/liquid-core.min.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="liquidai.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@300;400;500;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Stili per filtri e card */
    .event-filters {
      background-color: var(--white);
      padding: 1.5rem;
      border-radius: var(--border-radius-medium);
      margin-bottom: 2rem;
      box-shadow: var(--shadow-light);
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
    }
    .event-filters .form-group {
      flex: 1 1 180px;
      margin-bottom: 0;
      min-width: 150px;
    }
    .event-filters label {
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
      color: var(--primary);
      display: block;
    }
    .event-filters input,
    .event-filters select {
      width: 100%;
      padding: 0.7rem 1rem;
      border: 1px solid var(--gray-medium);
      border-radius: 8px;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    .event-filters select {
      height: calc(0.7rem * 2 + 0.95rem * 1.5 + 2px); /* Adjusted to match input height better */
      line-height: 1.5;
    }
    .event-filters button {
      padding: 0.7rem 1.5rem;
      background-color: var(--secondary);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition-medium);
      height: fit-content; /* Align with bottom of taller inputs */
    }
    .event-filters button:hover {
      background-color: var(--primary);
    }
    /* === NUOVI STILI PER FILTRI MOBILE E BUTTONS === */
    #mobile-filter-trigger {
      display: none; /* Nascosto di default, mostrato solo su mobile */
      width: 100%;
      padding: 0.8rem 1.5rem;
      font-size: 1.05rem;
      font-weight: 600;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius-medium);
      cursor: pointer;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-light);
      transition: all 0.2s ease-in-out;
    }
    #mobile-filter-trigger i {
      margin-right: 0.6rem;
    }
    #mobile-filter-trigger:hover {
      background-color: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
    }
    /* Overlay che copre lo schermo quando il drawer è aperto */
    #filter-drawer-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px) saturate(150%);
      -webkit-backdrop-filter: blur(8px) saturate(150%);
      z-index: 1500;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s cubic-bezier(0.23, 1, 0.32, 1);
    }
    #filter-drawer-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .filter-drawer-header {
      padding: 0.5rem 1.5rem 1rem 1.5rem;
      text-align: center;
      position: relative;
      border-bottom: 1px solid var(--gray-lighter);
    }
    .filter-drawer-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--primary-dark);
      font-weight: 600;
    }
    .filter-drawer-close-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      font-size: 1.1rem;
      color: var(--gray-dark);
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.2s ease, transform 0.2s ease;
    }
    .filter-drawer-close-btn:hover {
      background-color: var(--gray-medium);
      color: var(--dark);
      transform: rotate(90deg) scale(1.1);
    }

    /* Il pulsante "Applica filtri" del drawer mobile */
    .filter-drawer-apply-btn {
      display: block;
      width: calc(100% - 3rem);
      margin: 1.5rem auto 1rem auto;
      padding: 0.9rem;
      font-size: 1.1rem;
      font-weight: 600;
      background-color: var(--secondary);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px -5px rgba(var(--secondary-rgb), 0.6);
      transition: all 0.2s ease-in-out;
    }
    .filter-drawer-apply-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px -5px rgba(var(--secondary-rgb), 0.7);
    }
    /* Nasconde la 'X' e il pulsante 'Applica' su schermi più grandi */
    @media (min-width: 768px) {
      .filter-drawer-header,
      .filter-drawer-apply-btn,
      .filter-drawer-overlay,
      .event-filters.active {
        display: none !important;
        visibility: hidden !important;
        transform: translateY(100%);
      }
      #mobile-filter-trigger {
        display: none !important;
      }
      .event-filters {
        position: static;
        width: auto;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-light);
        padding: 1.5rem;
        margin-bottom: 2rem;
        background-color: var(--white);
        display: flex;
        flex-direction: row;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: flex-end;
      }
      .event-filters.active {
        transform: translateY(0);
      }
    }
    /* Media query per mobile */
    @media (max-width: 768px) {
      #mobile-filter-trigger {
        display: block; /* Mostra il pulsante su mobile */
      }
      .event-filters {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        width: 100%;
        z-index: 1600;
        background-color: #f8f8fa; /* Colore più "morbido", stile Apple */
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        box-shadow: 0 -10px 40px -10px rgba(0, 0, 0, 0.2);
        padding: 0;
        margin-bottom: 0;
        /* Animazione */
        transform: translateY(100%);
        transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
        /* Layout interno per il drawer */
        display: flex;
        flex-direction: column;
        gap: 0;
        max-height: 80vh;
      }
      .event-filters.active {
        transform: translateY(0);
      }
      .event-filters .form-group {
        flex: 1 1 100%; /* Occupa tutta la larghezza */
        padding: 0 1.5rem;
        margin-bottom: 1rem;
      }
      .event-filters .form-group:first-of-type {
        margin-top: 1.5rem;
      }
      .event-filters label {
        font-size: 0.95rem;
        font-weight: 500;
        color: var(--primary-dark);
      }
      .event-filters input, .event-filters select {
        padding: 0.8rem 1.1rem;
        font-size: 1rem;
        background-color: white;
        border-color: var(--gray-light);
      }
      .event-filters select {
        height: auto;
      }
    }
    /* === FINE NUOVI STILI === */
    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      visibility: hidden; opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      border-radius: inherit;
    }
    .loading-overlay.visible { visibility: visible; opacity: 1; }
    .loading-overlay .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px; height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary);
      animation: spin 1s ease infinite;
      margin-bottom: 0.8rem;
    }
    .loading-overlay p {
      font-size: 1.1em;
      color: var(--dark);
      font-weight: 500;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .no-events { text-align: center; padding: 2rem; color: var(--gray-dark); }
    /* Stili per popup login, messaggi errore, etc. (Stili unificati da eventiincorso) */
    .login-popup input.form-control.error-border { border-color: var(--danger, red) !important; }
    .login-popup input:-webkit-autofill,
    .login-popup input:-webkit-autofill:hover,
    .login-popup input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0px 1000px var(--white, white) inset !important;
      -webkit-text-fill-color: var(--dark, #333) !important;
    }
    .form-message { display: none; padding: 0.75rem; border-radius: 8px; font-size: 0.9em; margin-top: 0.5em; text-align: left; }
    .form-message.error { color: var(--danger, red); background-color: rgba(var(--danger-rgb, 231, 76, 60), 0.1); border: 1px solid rgba(var(--danger-rgb, 231, 76, 60), 0.3); }
    .form-message.success { color: var(--success, green); background-color: rgba(var(--success-rgb, 46, 204, 113), 0.1); border: 1px solid rgba(var(--success-rgb, 46, 204, 113), 0.3); }
    .terms-checkbox { text-align: left; font-size: 0.9em; margin-top: 0.5rem; margin-bottom: 1rem; color: var(--gray-dark); }
    .terms-checkbox input[type="checkbox"] { margin-right: 0.5rem; vertical-align: middle; }
    .terms-checkbox label { font-weight: normal; color: var(--gray-dark); }
    .terms-checkbox a { color: var(--primary); text-decoration: underline; }
    .spinner-mini-light { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; vertical-align: middle; margin-left: 5px; }
    .spinner-mini { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(0,0,0,0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin .6s linear infinite; vertical-align: middle; margin-right: 5px; }
    .user-avatar img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; vertical-align: middle; }
    .card-actions.admin-actions {
      margin-top: 1rem; border-top: 1px solid var(--gray-light); padding-top: 1rem;
    }
    .card-actions.admin-actions .card-btn { flex-grow: 1; }
    .card-actions .btn-delete { background-color: var(--danger) !important; color: white !important; }
    .card-actions .btn-delete:hover { background-color: darkred !important; }
    #current-event-image-preview { max-width:100px; max-height:100px; display:none; margin-top:5px; border-radius: 4px; border: 1px solid var(--gray-light); }
    #current-event-flyer-preview a { color: var(--primary); text-decoration: underline; }
    #current-event-flyer-preview a:hover { color: var(--accent); }
    /* === STILI NUOVO POPUP VOLANTINO (Design Ispirato Apple) === */
    :root {
      --flyer-text-primary: #1d1d1f;
      --flyer-modal-bg: #f8f8fa;
      --flyer-overlay-bg: rgba(0, 0, 0, 0.65);
    }
    .flyer-overlay-eff {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--flyer-overlay-bg);
      backdrop-filter: blur(16px) saturate(160%);
      -webkit-backdrop-filter: blur(16px) saturate(160%);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s cubic-bezier(0.45, 0.05, 0.55, 0.95), visibility 0s linear 0.4s;
    }
    .flyer-overlay-eff.active {
      opacity: 1;
      visibility: visible;
      transition-delay: 0s;
    }
    .flyer-modal-eff {
      background-color: var(--flyer-modal-bg);
      border-radius: 22px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25),
      0 0 15px rgba(0, 0, 0, 0.1);
      width: clamp(320px, 88vw, 1000px);
      height: clamp(450px, 85vh, 750px);
      display: flex;
      flex-direction: column;
      position: relative;
      opacity: 0;
      transform: scale(0.92) translateY(15px);
      transition: opacity 0.4s cubic-bezier(0.45, 0.05, 0.55, 0.95) 0.05s, transform 0.4s cubic-bezier(0.45, 0.05, 0.55, 0.95) 0.05s;
      overflow: hidden;
    }
    .flyer-overlay-eff.active .flyer-modal-eff {
      opacity: 1;
      transform: scale(1) translateY(0px);
    }
    .flyer-close-btn-eff {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 2rem;
      color: var(--gray-dark, #777);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      line-height: 1;
      z-index: 10;
      transition: color 0.2s ease, transform 0.25s ease-out;
    }
    .flyer-close-btn-eff:hover,
    .flyer-close-btn-eff:focus-visible {
      color: var(--dark, #333);
      transform: rotate(90deg);
      background: none;
    }
    .flyer-content-area-eff {
      flex-grow: 1;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: inherit;
    }
    .flyer-media-container-eff {
      width: 100%;
      height: 100%;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      box-sizing: border-box;
    }
    .flyer-media-container-eff img,
    .flyer-media-container-eff iframe {
      display: block;
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      border: none;
      border-radius: 8px;
    }
    .flyer-media-container-eff iframe {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }
    .flyer-message-display-eff {
      text-align: center;
      padding: 3rem 1rem;
      font-size: 1.1rem;
      color: var(--flyer-text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
    .flyer-message-display-eff p { margin-bottom: 1rem; }
    .flyer-message-display-eff a {
      color: var(--primary);
      text-decoration: underline; font-weight: 500;
      padding: 0.6rem 1.2rem; background-color: rgba(0,0,0,0.05); border-radius: 8px;
    }
    .flyer-message-display-eff a:hover { background-color: rgba(0,0,0,0.08); }
    body.flyer-popup-active-eff {
      overflow: hidden;
    }
    /* === FINE STILI NUOVO POPUP VOLANTINO === */
    /* Stile per il Custom Confirm Modal */
    .custom-confirm-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease-out;
    }
    .custom-confirm-overlay.active {
      display: flex;
      opacity: 1;
    }
    .custom-confirm-modal {
      background-color: var(--white);
      padding: 2rem;
      border-radius: var(--border-radius-medium);
      box-shadow: var(--shadow-strong);
      width: 90%;
      max-width: 450px;
      text-align: center;
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.2s ease-out, opacity 0.2s ease-out;
    }
    .custom-confirm-overlay.active .custom-confirm-modal {
      transform: scale(1);
      opacity: 1;
    }
    .custom-confirm-modal h3 {
      font-size: 1.3rem;
      color: var(--primary);
      margin-top: 0;
      margin-bottom: 1rem;
    }
    .custom-confirm-modal p {
      font-size: 1rem;
      color: var(--gray-dark);
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    .custom-confirm-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    .custom-confirm-actions .btn-popup {
      min-width: 100px;
    }
    .custom-confirm-actions .btn-confirm-no {
      background-color: var(--gray-light);
      color: var(--dark);
      border: 1px solid var(--gray-medium);
    }
    .custom-confirm-actions .btn-confirm-no:hover {
      background-color: var(--gray-medium);
    }
    /* === NUOVI STILI PER INFO A "PILLOLE" (CON SPAZIATURA AGGIORNATA) === */
    .card-info-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin: 1rem 0 1.2rem 0;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--gray-lighter);
    }
    .info-pill {
      display: inline-flex;
      align-items: center;
      background-color: var(--background-light, #f8f9fa);
      color: var(--primary-dark, #333);
      padding: 0.4rem 0.8rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      border: 1px solid var(--gray-light, #eee);
      transition: all 0.2s ease-in-out;
    }
    .info-pill i {
      margin-right: 0.5rem;
      color: var(--primary);
      font-size: 0.9em;
    }
    /* === FINE NUOVI STILI === */
    /* === NUOVI STILI PER POPUP ADMIN (stile Dashboard) === */
    .dash-admin-event-popup-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.65); z-index: 1050;
      display: none; opacity: 0; transition: opacity 0.3s ease;
    }
    .dash-admin-event-popup-overlay.active { display: block; opacity: 1; }
    .dash-admin-event-popup {
      position: fixed; top: 50%; left: 50%;
      background-color: var(--white, #fff);
      padding: 0;
      border-radius: var(--border-radius-large, 12px);
      box-shadow: var(--shadow-strong, 0 10px 30px rgba(0,0,0,0.2));
      z-index: 1051;
      width: 95%; max-width: 900px;
      max-height: 90vh;
      display: none; opacity: 0;
      transform: translate(-50%, -50%) scale(0.95);
      transition: opacity 0.3s ease, transform 0.3s ease;
      overflow: hidden;
    }
    .dash-admin-event-popup.active {
      opacity: 1; transform: translate(-50%, -50%) scale(1);
      display: flex; flex-direction: column;
    }
    .dash-admin-event-popup-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--gray-light, #eee);
      display: flex; justify-content: space-between; align-items: center;
    }
    .dash-admin-event-popup-header h2 { margin: 0; color: var(--primary); font-size: 1.5rem; }
    .dash-admin-event-popup .close-popup {
      font-size: 1.8rem; color: var(--gray-dark, #777); background: none;
      border: none; cursor: pointer; padding: 0.5rem; line-height: 1;
    }
    .dash-admin-event-popup .close-popup:hover { color: var(--dark, #333); }
    .dash-admin-event-popup-content {
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
    }
    .dash-admin-event-form-and-preview-container {
      display: flex;
      flex-wrap: wrap; gap: 2rem;
      width: 100%;
    }
    #dashAdminEventForm { flex: 2; min-width: 320px; }
    #dashAdminEventCardPreviewContainer {
      flex: 1; min-width: 280px; padding: 1rem; border: 1px dashed var(--gray-medium, #ccc);
      border-radius: var(--border-radius-medium, 8px); background-color: var(--background-light, #f8f9fa);
      height: fit-content; position: sticky; top: 1.5rem;
    }
    @media (max-width: 768px) {
      .dash-admin-event-form-and-preview-container { flex-direction: column-reverse; }
      #dashAdminEventCardPreviewContainer { position: static; margin-bottom: 2rem;}
    }
    #dashAdminEventCardPreviewContainer h4 {
      text-align: center; color: var(--primary); margin-top: 0; margin-bottom: 1rem;
      font-size: 1.1rem; border-bottom: 1px solid var(--gray-light, #eee); padding-bottom: 0.5rem;
    }
    .dash-admin-preview-card {
      background: var(--white); border-radius: var(--border-radius-medium);
      box-shadow: var(--shadow-light); overflow: hidden; border: 1px solid var(--gray-light);
    }
    .dash-admin-preview-card-image-container {
      height: 160px; background-color: var(--gray-lighter, #f0f0f0); display: flex;
      align-items: center; justify-content: center; overflow: hidden;
    }
    .dash-admin-preview-card-image-container img { width: 100%; height: 100%; object-fit: cover; }
    .dash-admin-preview-card-image-container .dash-admin-no-image-placeholder { font-size: 0.9rem; color: var(--gray-dark); }
    .dash-admin-preview-card-content { padding: 0.8rem 1rem; }
    .dash-admin-preview-card-content h5 {
      font-size: 1.15rem; color: var(--primary); margin: 0 0 0.4rem 0;
      font-weight: 600; min-height: 1.2em; word-break: break-word;
    }
    .dash-admin-preview-card-content p {
      font-size: 0.85rem; color: var(--gray-dark); line-height: 1.4;
      margin-bottom: 0.4rem; min-height: 1em; word-break: break-word;
    }
    .dash-admin-preview-card-content .dash-admin-preview-relatore { font-style: italic; }
    .dash-admin-preview-card-content .dash-admin-preview-posti,
    .dash-admin-preview-card-content .dash-admin-preview-costo { font-weight: bold; }
    #dashAdminEventForm .form-group { margin-bottom: 1rem; position: relative; }
    #dashAdminEventForm .form-group label {
      display: block; margin-bottom: 0.3rem; color: var(--primary-dark, #333);
      font-weight: 500; font-size: 0.9rem;
    }
    #dashAdminEventForm .form-control, #dashAdminEventForm select.form-control {
      width: 100%; padding: 0.7rem 0.9rem; border: 1px solid var(--gray-medium, #ccc);
      border-radius: 6px; font-size: 0.95rem; background-color: var(--white, #fff);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    #dashAdminEventForm .form-control:focus {
      border-color: var(--secondary, #8db187);
      box-shadow: 0 0 0 2px rgba(var(--secondary-rgb, 141, 177, 135), 0.2);
      outline: none;
    }
    #dashAdminEventForm textarea.form-control { min-height: 70px; resize: vertical; }
    #dashAdminEventForm .form-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;
    }
    #dashAdminEventForm .form-check-group {
      display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;
    }
    #dashAdminEventForm .form-check-group input[type="checkbox"] {
      width: auto; margin-right: 0.2rem; transform: scale(1.05);
    }
    #dashAdminEventForm .form-check-group label {
      font-weight: normal; font-size: 0.9rem; margin-bottom: 0; color: var(--dark);
    }
    #dashAdminEventForm .form-actions { margin-top: 1.5rem; text-align: right; }
    #dashAdminEventForm small {
      font-size: 0.8rem; color: var(--gray-dark); display: block; margin-top: 0.2rem;
    }
    #dashAdmin-current-event-image-preview {
      margin-top: 0.5rem; max-width: 120px; border: 1px solid var(--gray-light, #eee);
      padding: 4px; border-radius: 4px; display:none;
    }
    #dashAdmin-current-event-flyer-preview {
      margin-top: 0.5rem; padding: 4px; font-size: 0.85rem;
    }
    #dashAdmin-current-event-flyer-preview a { color: var(--primary); text-decoration: underline; }
    #dashAdmin-current-event-flyer-preview span { color: var(--gray-dark); }
    #dashAdminEventFormMessage.form-message { margin-top: 1rem; }
    /* Stile body quando il drawer dei filtri è aperto */
    body.filter-drawer-open {
      overflow: hidden;
    }
  </style>
</head>
<body>

<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="index.html" id="logoLink">
        <img src="images/Logo_eremo.png" alt="Logo Eremo Frate Francesco" class="navbar-logo-img" id="navbarLogoImgTag">
        <h2 id="navbarTitle">Eremo Frate Francesco</h2>
      </a>
    </div>
    <div class="menu" id="mainMenu">
      <a href="eventiincorso.html" id="navCalendarioAttivita">Calendario attività</a>
      <a href="eventipassati.html" class="active" id="navArchivioAttivita">Archivio attività</a>
      <span class="separator">|</span>
      <a href="incontrisullaparola.html" id="navIncontriParola">Incontri sulla parola</a>
      <span class="separator">|</span>
      <a href="dovesiamo.html" id="navDoveSiamo">Dove siamo</a>
      <a href="contatti.html" id="navContatti">Contatti</a>
    </div>
    <div class="right-menu">
      <button id="login-btn-desktop" class="login-btn" style="display: none;">Accedi</button>
      <div class="user-dropdown" id="userDropdownContainer" style="display: none;">
        <button class="user-btn" id="userBtnTrigger" aria-haspopup="true" aria-expanded="false">
          <span class="user-avatar" id="navbar-avatar"><img src="uploads/icons/default_user.png" alt="User Icon"></span>
          <span class="user-name" id="navbar-username">Utente</span>
          <span class="dropdown-arrow">▼</span>
        </button>
        <div class="dropdown-menu" id="userDropdownMenu">
          <a href="areapersonale.html" id="dropdownProfilo" style="display: block;">Il mio profilo</a>
          <a href="areapersonale.html#prenotazioni" id="dropdownPrenotazioni" style="display: block;">Le mie prenotazioni</a>
          <a href="dashboard.html" id="dropdownDashboard" style="display: block;">Dashboard Admin</a>
          <a href="eventiincorso.html" id="dropdownGestioneEventi" style="display: block;">Gestione Eventi</a>
          <a href="#" id="dropdownLogout">Esci</a>
        </div>
      </div>
      <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu">☰</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorso.html" id="mobileNavCalendarioAttivita">Calendario attività</a>
    <a href="eventipassati.html" id="mobileNavArchivioAttivita">Archivio attività</a>
    <a href="incontrisullaparola.html" id="mobileNavIncontriParola">Incontri sulla parola</a>
    <a href="dovesiamo.html" id="mobileNavDoveSiamo">Dove siamo</a>
    <a href="contatti.html" id="mobileNavContatti">Contatti</a>
    <hr id="mobileMenuSeparator" style="border-color: rgba(255,255,255,0.1); display:none;">
    <a href="#" id="login-btn-mobile" style="display: none;">Accedi</a>
    <a href="areapersonale.html" id="mobileNavProfilo" style="display: none;">Il mio profilo</a>
    <a href="areapersonale.html#prenotazioni" id="mobileNavPrenotazioni" style="display: none;">Le mie prenotazioni</a>
    <a href="dashboard.html" id="mobileNavDashboard" style="display: none;">Dashboard Admin</a>
    <a href="eventiincorso.html" id="mobileNavGestioneEventiAdmin" style="display: none;">Gestione Eventi</a>
    <a href="#" id="mobileLogoutLink" style="display: none;">Esci</a>
  </div>
</header>

<main>
  <div class="container section-padding">
    <h1 id="mainPageTitle">Archivio Attività</h1>
    <!-- Pulsante per triggerare i filtri su mobile -->
    <button id="mobile-filter-trigger">
      <i class="fas fa-sliders-h"></i> Filtra Risultati
    </button>
    <!-- I filtri verranno trasformati in un drawer su mobile via CSS -->
    <div class="event-filters" id="eventFilters">
      <!-- Header del drawer per mobile -->
      <div class="filter-drawer-header">
        <!-- Pulsante di chiusura del drawer mobile -->
        <button class="filter-drawer-close-btn" aria-label="Chiudi Filtri">
          <i class="fas fa-times"></i>
        </button>

      </div>
      <!-- Contenuto originale dei filtri -->
      <div class="form-group">
        <label for="searchTitle">Titolo Evento</label>
        <input type="text" id="searchTitle" placeholder="Cerca per titolo..." class="form-control"/>
      </div>
      <div class="form-group">
        <label for="searchMonth">Mese</label>
        <select id="searchMonth" class="form-control">
          <option value="">Tutti i mesi</option>
          <option value="01">Gennaio</option>
          <option value="02">Febbraio</option>
          <option value="03">Marzo</option>
          <option value="04">Aprile</option>
          <option value="05">Maggio</option>
          <option value="06">Giugno</option>
          <option value="07">Luglio</option>
          <option value="08">Agosto</option>
          <option value="09">Settembre</option>
          <option value="10">Ottobre</option>
          <option value="11">Novembre</option>
          <option value="12">Dicembre</option>
        </select>
      </div>
      <div class="form-group">
        <label for="searchYear">Anno</label>
        <select id="searchYear" class="form-control">
        </select>
      </div>
      <div class="form-group">
        <label for="searchSpeaker">Relatore</label>
        <input type="text" id="searchSpeaker" class="form-control" placeholder="Nome relatore..."/>
      </div>
      <!-- Pulsante Applica per mobile -->
      <button class="filter-drawer-apply-btn">Applica Filtri</button>
    </div>
    <div id="eventiGridContainer" style="position: relative"> <div id="loadingIndicator" class="loading-overlay"> <div class="spinner"></div>
      <p>Caricamento eventi...</p>
    </div>
      <div class="card-grid" id="eventiPassatiGrid">
      </div>
    </div>
  </div>
</main>
<!-- Overlay per il drawer dei filtri -->
<div id="filter-drawer-overlay"></div>
<div id="ai-assistant-fab" title="Assistente Virtuale Eremo" data-liquid> <i class="fas fa-headset"></i>
</div>
<div id="ai-chat-popup">
  <div id="ai-chat-header">
    <h3>Assistente Eremo <i class="fas fa-robot"></i></h3>
    <button id="ai-chat-close-btn" aria-label="Chiudi Chat">&times;</button>
  </div>
  <div id="ai-chat-messages">
    <div class="ai-message">Ciao! Sono l'assistente virtuale dell'Eremo. Come posso aiutarti oggi riguardo il sito?</div>
  </div>
  <div id="ai-chat-input-container">
    <textarea id="ai-chat-input" placeholder="Scrivi la tua domanda..." rows="2"></textarea>
    <button id="ai-chat-send-btn" aria-label="Invia Messaggio"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>
<footer>
  <p>© <span id="currentYear"></span> Eremo Frate Francesco. OdV Via San Vito 2, Nembro. C.F.:90004060167. Sviluppato da 5AII 2024-2025 Majorana Seriate.</p>
</footer>
<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
  <button class="close-popup" id="closeLoginPopupBtn" aria-label="Chiudi popup">&times;</button>
  <div class="login-tabs">
    <div class="login-tab active" data-tab="login">Accedi</div>
    <div class="login-tab" data-tab="register">Registrati</div>
  </div>
  <form class="login-form active" id="loginFormPopup" method="POST">
    <div class="form-group"><label for="login-email-popup">Email</label><input type="email" id="login-email-popup" name="login-email" class="form-control" required autocomplete="email"/></div>
    <div class="form-group"><label for="login-password-popup">Password</label><input type="password" id="login-password-popup" name="login-password" class="form-control" required autocomplete="current-password"/></div>
    <div style="text-align: right; margin-top: -10px; margin-bottom: 10px;">
      <a href="#" id="forgotPasswordLink" style="font-size: 0.9em; color: var(--primary);">Password dimenticata?</a>
    </div>
    <div id="login-error-message-popup" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
    <div class="form-actions"><button type="submit" class="btn-popup">Accedi</button></div>
  </form>
  <form class="login-form" id="registerFormPopup" method="POST">
    <div class="form-group"><label for="register-name-popup">Nome</label><input type="text" id="register-name-popup" name="register-name" class="form-control" required autocomplete="given-name"/></div>
    <div class="form-group"><label for="register-surname-popup">Cognome</label><input type="text" id="register-surname-popup" name="register-surname" class="form-control" required autocomplete="family-name"/></div>
    <div class="form-group"><label for="register-email-popup">Email</label><input type="email" id="register-email-popup" name="register-email" class="form-control" required autocomplete="email"/></div>
    <div class="form-group"><label for="register-password-popup">Password</label><input type="password" id="register-password-popup" name="register-password" class="form-control" required minlength="8" autocomplete="new-password"/><small>Minimo 8 caratteri.</small></div>
    <div class="terms-checkbox"><input type="checkbox" id="register-terms-popup" name="register-terms" required><label for="register-terms-popup">Accetto i <a href="termini.html" target="_blank">termini e condizioni</a></label></div>
    <div id="register-error-message-popup" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
    <div class="form-actions"><button type="submit" class="btn-popup">Registrati</button></div>
  </form>
</div>
<div class="login-popup-overlay" id="forgotPasswordOverlay"></div>
<div class="login-popup" id="forgotPasswordPopup">
  <button class="close-popup" id="closeForgotPasswordPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h3 style="text-align:center; margin-bottom: 1rem; color: var(--primary);">Recupera Password</h3>
  <p style="font-size:0.95em; color:var(--gray-dark); margin-bottom:1.5rem; text-align:left;">Inserisci l'indirizzo email associato al tuo account. Se presente nel nostro sistema, ti invieremo un link per reimpostare la password.</p>
  <form id="forgotPasswordForm" method="POST">
    <div class="form-group mb-3">
      <label for="forgot-email">Email</label>
      <input type="email" id="forgot-email" name="forgot-email" class="form-control" required autocomplete="email">
    </div>
    <div id="forgot-password-message" class="form-message" style="text-align:left;"></div>
    <div class="form-actions">
      <button type="submit" class="btn-popup">Invia link di recupero</button>
    </div>
  </form>
</div>
<div class="login-popup-overlay" id="loginRequiredOverlay"></div>
<div class="login-popup" id="loginRequiredPopup">
  <button class="close-popup" id="closeLoginRequiredPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h2 style="color: var(--primary); margin-top: 0; margin-bottom: 1.5rem; text-align: center; font-size: 1.8rem;">Accesso Richiesto</h2>
  <p style="text-align: center; margin-bottom: 1.5rem; font-size: 1.2rem; color: var(--dark);">Per visualizzare le risorse di questo evento, è necessario effettuare l'accesso.</p>
  <div class="form-actions" style="text-align: center;">
    <button type="button" class="btn-popup" id="loginRequiredLoginBtn">Accedi / Registrati</button>
  </div>
</div>
<!-- NUOVO POPUP MODALE AGGIORNATO (stili da eventiincorso) -->
<div class="dash-admin-event-popup-overlay" id="dashAdminEventPopupOverlay"></div>
<div class="dash-admin-event-popup" id="dashAdminEventPopup">
  <div class="dash-admin-event-popup-header">
    <h2 id="dashAdminEventPopupTitle">Modifica Evento Passato</h2>
    <button class="close-popup" id="closeDashAdminEventPopupBtn" aria-label="Chiudi popup">&times;</button>
  </div>
  <div class="dash-admin-event-popup-content">
    <div class="dash-admin-event-form-and-preview-container">
      <form id="dashAdminEventForm" method="POST" enctype="multipart/form-data">
        <input type="hidden" id="dashAdmin-event-id" name="event-id">
        <div class="form-group">
          <label for="dashAdmin-event-title">Titolo Evento*</label>
          <input type="text" id="dashAdmin-event-title" name="event-title" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="dashAdmin-event-date">Data Evento*</label>
          <input type="date" id="dashAdmin-event-date" name="event-date" class="form-control" required>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="dashAdmin-event-start-time">Orario Inizio (HH:MM)</label>
            <input type="time" id="dashAdmin-event-start-time" name="event-start-time" class="form-control">
          </div>
          <div class="form-group">
            <label for="dashAdmin-event-end-time">Orario Fine (HH:MM)</label>
            <input type="time" id="dashAdmin-event-end-time" name="event-end-time" class="form-control">
          </div>
        </div>
        <div class="form-group">
          <label for="dashAdmin-event-short-desc">Descrizione Breve*</label>
          <textarea id="dashAdmin-event-short-desc" name="event-short-desc" class="form-control" rows="3" required maxlength="200"></textarea>
        </div>
        <div class="form-group">
          <label for="dashAdmin-event-long-desc">Descrizione Estesa</label>
          <textarea id="dashAdmin-event-long-desc" name="event-long-desc" class="form-control" rows="5"></textarea>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="dashAdmin-event-prefix">Prefisso Relatore</label>
            <input type="text" id="dashAdmin-event-prefix" name="event-prefix" class="form-control" placeholder="Default: Relatore">
          </div>
          <div class="form-group">
            <label for="dashAdmin-event-speaker">Nome Relatore*</label>
            <input type="text" id="dashAdmin-event-speaker" name="event-speaker" class="form-control" required>
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="dashAdmin-event-association">Associazione</label>
            <input type="text" id="dashAdmin-event-association" name="event-association" class="form-control">
          </div>
          <div class="form-group">
            <label for="dashAdmin-event-seats">Posti Totali*</label>
            <input type="number" id="dashAdmin-event-seats" name="event-seats" class="form-control" required min="0">
          </div>
        </div>
        <div class="form-group">
          <label for="dashAdmin-event-image">Immagine Copertina</label>
          <input type="file" id="dashAdmin-event-image" name="event-image" class="form-control" accept="image/*">
          <small>Lascia vuoto se non vuoi modificare l'immagine corrente.</small>
          <img id="dashAdmin-current-event-image-preview" src="#" alt="Anteprima copertina">
        </div>
        <div class="form-group">
          <label for="dashAdmin-event-flyer">Volantino (PDF/Immagine)</label>
          <input type="file" id="dashAdmin-event-flyer" name="event-flyer" class="form-control" accept="image/*,application/pdf">
          <small>Lascia vuoto se non vuoi modificare il volantino corrente.</small>
          <div id="dashAdmin-current-event-flyer-preview" style="margin-top:5px;"></div>
        </div>
        <div class="form-check-group">
          <input type="checkbox" id="dashAdmin-event-booking" name="event-booking">
          <label for="dashAdmin-event-booking">Evento prenotabile?</label>
        </div>
        <div class="form-check-group">
          <input type="checkbox" id="dashAdmin-event-voluntary" name="event-voluntary">
          <label for="dashAdmin-event-voluntary">Costo su base volontaria (offerta libera)</label>
        </div>
        <div class="form-group" id="dashAdmin-event-price-container">
          <label for="dashAdmin-event-price">Prezzo (€)</label>
          <input type="number" id="dashAdmin-event-price" name="event-price" class="form-control" min="0" step="0.01" placeholder="Es. 10.00">
        </div>
        <div id="dashAdminEventFormMessage" class="form-message" style="display:none;"></div>
        <div class="form-actions">
          <button type="submit" class="btn-popup">Salva Modifiche</button>
        </div>
      </form>
      <div id="dashAdminEventCardPreviewContainer">
        <h4>Anteprima Card Evento</h4>
        <div class="dash-admin-preview-card">
          <div class="dash-admin-preview-card-image-container">
            <img id="dashAdmin_previewImage" src="images/default-event.jpg" alt="Anteprima copertina evento">
            <span class="dash-admin-no-image-placeholder" style="display:none;">Nessuna immagine</span>
          </div>
          <div class="dash-admin-preview-card-content">
            <h5 id="dashAdmin_previewTitle">Titolo Evento</h5>
            <p id="dashAdmin_previewDateFull"><b>Data:</b> <span class="value">Seleziona data</span></p>
            <p id="dashAdmin_previewTimeFull" style="display:none;"><b>Orario:</b> <span class="value"></span></p>
            <p id="dashAdmin_previewSpeakerFull" class="dash-admin-preview-relatore"><b><span id="dashAdmin_previewSpeakerPrefix">Relatore</span>:</b> <span id="dashAdmin_previewSpeakerName" class="value">Nome Relatore</span></p>
            <p id="dashAdmin_previewShortDesc">Descrizione breve dell'evento qui...</p>
            <p id="dashAdmin_previewSeatsFull" class="dash-admin-preview-posti"><b>Posti:</b> <span class="value">0</span></p>
            <p id="dashAdmin_previewPriceFull" class="dash-admin-preview-costo"><b>Costo:</b> <span class="value">€ 0.00</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="custom-confirm-overlay" id="customConfirmOverlay">
  <div class="custom-confirm-modal" id="customConfirmModal">
    <h3 id="customConfirmTitle">Conferma Uscita</h3>
    <p id="customConfirmMessage">Hai modifiche non salvate. Sei sicuro di voler uscire senza salvare?</p>
    <div class="custom-confirm-actions">
      <button type="button" class="btn-popup btn-confirm-no" id="customConfirmNo">Annulla</button>
      <button type="button" class="btn-popup btn-confirm-yes" id="customConfirmYes">Esci</button>
    </div>
  </div>
</div>
<script src="assistenteAI.js" defer></script>
<script src="liquidglass.js" defer></script>
<script>
  // Percorso dell'icona utente di default
  const defaultUserIconPath = 'uploads/icons/default_user.png';
  // Variabile globale per i dati dell'utente corrente
  let currentUserData = null;
  // Array per memorizzare tutti gli eventi passati caricati
  let allPastEventsData = [];
  // Elementi del DOM per i filtri
  const searchTitleEl = document.getElementById("searchTitle");
  const searchMonthEl = document.getElementById("searchMonth");
  const searchYearEl = document.getElementById("searchYear");
  const searchSpeakerEl = document.getElementById("searchSpeaker");
  // Elemento del DOM per la griglia degli eventi
  const eventiPassatiGridEl = document.getElementById("eventiPassatiGrid");
  // Elemento del DOM per l'indicatore di caricamento
  const loadingIndicatorEl = document.getElementById("loadingIndicator");
  // NUOVI Elementi del DOM per il drawer dei filtri mobile
  const mobileFilterTriggerEl = document.getElementById('mobile-filter-trigger');
  const eventFiltersEl = document.getElementById('eventFilters');
  const filterDrawerOverlayEl = document.getElementById('filter-drawer-overlay');
  const filterDrawerCloseBtnEl = document.querySelector('.filter-drawer-close-btn');
  const filterDrawerApplyBtnEl = document.querySelector('.filter-drawer-apply-btn');
  // Elementi del DOM per il nuovo popup di modifica admin (stile dashboard)
  let dashAdminEventPopupOverlayEl, dashAdminEventPopupEl, closeDashAdminEventPopupBtnEl,
          dashAdminEventFormEl, dashAdminEventPopupTitleEl, dashAdminEventIdInputEl,
          dashAdminEventTitleEl, dashAdminEventDateEl, dashAdminEventStartTimeEl, dashAdminEventEndTimeEl,
          dashAdminEventShortDescEl, dashAdminEventLongDescEl, dashAdminEventPrefixEl,
          dashAdminEventSpeakerEl, dashAdminEventAssociationEl, dashAdminEventSeatsEl,
          dashAdminEventImageEl, dashAdminEventFlyerEl, dashAdminEventBookingCheckbox,
          dashAdminEventVoluntaryCheckbox, dashAdminEventPriceContainerEl, dashAdminEventPriceInputEl,
          dashAdminEventFormMessageEl, dashAdminCurrentImagePreviewEl, dashAdminCurrentFlyerPreviewEl,
          dashAdminPreviewImageEl, dashAdminPreviewNoImagePlaceholderEl, dashAdminPreviewTitleEl,
          dashAdminPreviewDateFullEl, dashAdminPreviewTimeFullEl, dashAdminPreviewTimeValueEl,
          dashAdminPreviewSpeakerFullEl, dashAdminPreviewSpeakerPrefixEl, dashAdminPreviewSpeakerNameEl,
          dashAdminPreviewShortDescEl, dashAdminPreviewSeatsFullEl, dashAdminPreviewPriceFullEl;
  let initialAdminEventFormData = {};
  let isEventFormDirty = false;
  let customConfirmOverlayEl, customConfirmModalEl, customConfirmTitleEl, customConfirmMessageEl,
          customConfirmYesBtn, customConfirmNoBtn;
  let confirmResolve = null;
  // Variabili globali per popup volantino
  let globalFlyerOverlayEff = null;
  let currentFlyerModalEff = null;
  // Funzione abbreviata per getElementById
  function gebi(id) { return document.getElementById(id); }
  // NUOVE Funzioni per gestire il drawer dei filtri mobile
  function openFilterDrawer() {
    if (filterDrawerOverlayEl) filterDrawerOverlayEl.classList.add('active');
    if (eventFiltersEl) eventFiltersEl.classList.add('active');
    document.body.classList.add('filter-drawer-open');
  }
  function closeFilterDrawer() {
    if (filterDrawerOverlayEl) filterDrawerOverlayEl.classList.remove('active');
    if (eventFiltersEl) eventFiltersEl.classList.remove('active');
    document.body.classList.remove('filter-drawer-open');
  }
  function showCustomConfirm(title, message, confirmBtnText = "Sì", cancelBtnText = "Annulla") {
    return new Promise((resolve) => {
      if(customConfirmTitleEl) customConfirmTitleEl.textContent = title || "Conferma";
      if(customConfirmMessageEl) customConfirmMessageEl.textContent = message || "Sei sicuro di voler procedere?";
      if(customConfirmYesBtn) customConfirmYesBtn.textContent = confirmBtnText;
      if(customConfirmNoBtn) customConfirmNoBtn.textContent = cancelBtnText;
      if(customConfirmOverlayEl) customConfirmOverlayEl.classList.add('active');
      confirmResolve = resolve;
    });
  }
  function handleConfirm(confirmed) {
    if(customConfirmOverlayEl) customConfirmOverlayEl.classList.remove('active');
    if (confirmResolve) {
      confirmResolve(confirmed);
      confirmResolve = null;
    }
  }
  // Carica i dati dell'utente dal localStorage
  function loadUserData() {
    const uds = localStorage.getItem('userDataEFF');
    if (uds) {
      try {
        currentUserData = JSON.parse(uds);
        // Validazione base dei dati utente
        if (!currentUserData || typeof currentUserData.email === 'undefined') {
          currentUserData = null; localStorage.removeItem('userDataEFF');
        }
      } catch (e) { currentUserData = null; localStorage.removeItem('userDataEFF'); }
    } else { currentUserData = null; }
  }
  // Aggiorna i dati dell'utente (nome, icona) dalla API se necessario e aggiorna la UI della navbar
  async function fetchAndUpdateUserDisplayData() {
    if (!currentUserData || !currentUserData.email || currentUserData.isAdmin) {
      updateNavbarUI();
      return;
    }
    try {
      const response = await fetch(`api/api_get_user_profile.php?email=${encodeURIComponent(currentUserData.email)}`);
      if (!response.ok) throw new Error('Errore fetch profilo utente');
      const apiResult = await response.json();
      if (apiResult.success && apiResult.data) {
        const freshData = apiResult.data;
        currentUserData.nome = freshData.nome || currentUserData.nome;
        currentUserData.iconPath = freshData.icon || defaultUserIconPath;
        currentUserData.cognome = freshData.cognome || (currentUserData.cognome || '');
        localStorage.setItem('userDataEFF', JSON.stringify(currentUserData));
      }
    } catch (error) {
      console.warn("Impossibile aggiornare i dati del profilo utente:", error);
    }
    updateNavbarUI();
  }
  // Aggiorna l'interfaccia utente della navbar in base allo stato di login e al ruolo dell'utente
  function updateNavbarUI() {
    const logoLink = gebi('logoLink');
    if (logoLink) logoLink.href = "index.html";
    const navbarTitle = gebi('navbarTitle');
    const loginBtnDesktop = gebi('login-btn-desktop');
    const userDropdownContainer = gebi('userDropdownContainer');
    const navbarAvatarSpan = gebi('navbar-avatar');
    const navbarUsername = gebi('navbar-username');
    const dropdownProfilo = gebi('dropdownProfilo');
    const dropdownPrenotazioni = gebi('dropdownPrenotazioni');
    const dropdownDashboard = gebi('dropdownDashboard');
    const dropdownGestioneEventi = gebi('dropdownGestioneEventi');
    const loginBtnMobile = gebi('login-btn-mobile');
    const mobileNavProfilo = gebi('mobileNavProfilo');
    const mobileNavPrenotazioni = gebi('mobileNavPrenotazioni');
    const mobileNavDashboard = gebi('mobileNavDashboard');
    const mobileNavGestioneEventiAdmin = gebi('mobileNavGestioneEventiAdmin');
    const mobileLogoutLink = gebi('mobileLogoutLink');
    const mobileMenuSeparator = gebi('mobileMenuSeparator');
    const mainPageTitle = gebi('mainPageTitle');
    if(loginBtnDesktop) loginBtnDesktop.style.display = 'none';
    if(userDropdownContainer) userDropdownContainer.style.display = 'none';
    if(dropdownProfilo) dropdownProfilo.style.display = 'none';
    if(dropdownPrenotazioni) dropdownPrenotazioni.style.display = 'none';
    if(dropdownDashboard) dropdownDashboard.style.display = 'none';
    if(dropdownGestioneEventi) dropdownGestioneEventi.style.display = 'none';
    if(loginBtnMobile) loginBtnMobile.style.display = 'none';
    if(mobileNavProfilo) mobileNavProfilo.style.display = 'none';
    if(mobileNavPrenotazioni) mobileNavPrenotazioni.style.display = 'none';
    if(mobileNavDashboard) mobileNavDashboard.style.display = 'none';
    if(mobileNavGestioneEventiAdmin) mobileNavGestioneEventiAdmin.style.display = 'none';
    if(mobileLogoutLink) mobileLogoutLink.style.display = 'none';
    if(mobileMenuSeparator) mobileMenuSeparator.style.display = 'none';
    if (currentUserData) {
      if(userDropdownContainer) userDropdownContainer.style.display = 'inline-block';
      if(navbarUsername) navbarUsername.textContent = currentUserData.nome || currentUserData.email.split('@')[0];
      const avatarImgEl = navbarAvatarSpan ? navbarAvatarSpan.querySelector('img') : null;
      if(avatarImgEl) {
        avatarImgEl.src = currentUserData.iconPath || defaultUserIconPath;
        avatarImgEl.alt = `Avatar di ${currentUserData.nome || 'utente'}`;
        avatarImgEl.onerror = function() { this.src = defaultUserIconPath; };
      }
      if(mobileLogoutLink) mobileLogoutLink.style.display = 'block';
      if(mobileMenuSeparator) mobileMenuSeparator.style.display = 'block';
      if (currentUserData.isAdmin) {
        if(navbarTitle) navbarTitle.textContent = "Eremo (Admin)";
        if(mainPageTitle) mainPageTitle.textContent = "Gestione Archivio Attività";
        if(dropdownProfilo) dropdownProfilo.style.display = 'block';
        if(mobileNavProfilo) mobileNavProfilo.style.display = 'block';
        if(dropdownDashboard) dropdownDashboard.style.display = 'block';
        if(mobileNavDashboard) mobileNavDashboard.style.display = 'block';
        if(dropdownPrenotazioni) dropdownPrenotazioni.style.display = 'none';
        if(mobileNavPrenotazioni) mobileNavPrenotazioni.style.display = 'none';
        if(dropdownGestioneEventi) dropdownGestioneEventi.style.display = 'none';
        if(mobileNavGestioneEventiAdmin) mobileNavGestioneEventiAdmin.style.display = 'none';
      } else {
        if(navbarTitle) navbarTitle.textContent = "Eremo Frate Francesco";
        if(mainPageTitle) mainPageTitle.textContent = "Archivio Attività";
        if(dropdownProfilo) dropdownProfilo.style.display = 'block';
        if(mobileNavProfilo) mobileNavProfilo.style.display = 'block';
        if(dropdownPrenotazioni) dropdownPrenotazioni.style.display = 'block';
        if(mobileNavPrenotazioni) mobileNavPrenotazioni.style.display = 'block';
      }
    } else {
      if(loginBtnDesktop) loginBtnDesktop.style.display = 'inline-block';
      if(loginBtnMobile) loginBtnMobile.style.display = 'block';
      if(navbarTitle) navbarTitle.textContent = "Eremo Frate Francesco";
      if(mainPageTitle) mainPageTitle.textContent = "Archivio Attività ";
    }
  }
  // Gestisce il logout dell'utente
  function handleLogout() {
    localStorage.removeItem('userDataEFF');
    currentUserData = null;
    updateNavbarUI();
    loadPastEvents();
    alert('Logout effettuato.');
  }
  // Gestione navbar che scompare allo scroll
  let lastScrollNav = 0; const navbarContainerEl = gebi("navbarContainer"); if (navbarContainerEl) { window.addEventListener("scroll", function () { const cS = window.pageYOffset || document.documentElement.scrollTop; if (cS <= 50) { navbarContainerEl.classList.remove("hidden"); lastScrollNav = 0; return; } if (cS > lastScrollNav && !navbarContainerEl.classList.contains("hidden")) navbarContainerEl.classList.add("hidden"); else if (cS < lastScrollNav && navbarContainerEl.classList.contains("hidden")) navbarContainerEl.classList.remove("hidden"); lastScrollNav = cS <= 0 ? 0 : cS; }, false); }
  // Gestione menu mobile (hamburger)
  const mobileMenuEl = gebi("mobileMenu"); const hamburgerButton = gebi("hamburgerBtn"); function toggleMobileMenu() { if (mobileMenuEl && hamburgerButton) { const iO = mobileMenuEl.classList.toggle("open"); hamburgerButton.classList.toggle("open"); hamburgerButton.setAttribute("aria-expanded", String(iO)); document.body.style.overflow = iO ? "hidden" : ""; } } function closeMobileMenu() { if (mobileMenuEl && hamburgerButton && mobileMenuEl.classList.contains("open")) { mobileMenuEl.classList.remove("open"); hamburgerButton.classList.remove("open"); hamburgerButton.setAttribute("aria-expanded", "false"); document.body.style.overflow = ""; } }
  if (hamburgerButton) hamburgerButton.addEventListener("click", toggleMobileMenu);
  document.querySelectorAll("#mobileMenu a").forEach(l => { if (l.id !== 'login-btn-mobile' && l.id !== 'mobileLogoutLink') { l.addEventListener("click", closeMobileMenu); }});
  document.addEventListener("click", function (e) { if (mobileMenuEl && mobileMenuEl.classList.contains("open") && hamburgerButton && !mobileMenuEl.contains(e.target) && !hamburgerButton.contains(e.target)) closeMobileMenu(); });
  // Gestione dropdown utente
  const userBtnTriggerEl = gebi('userBtnTrigger'); const userDropdownMenuEl = gebi('userDropdownMenu'); if (userBtnTriggerEl && userDropdownMenuEl) { userBtnTriggerEl.addEventListener('click', function (e) { e.stopPropagation(); const iS = userDropdownMenuEl.style.display === 'block'; userDropdownMenuEl.style.display = iS ? 'none' : 'block'; this.setAttribute('aria-expanded', String(!iS)); }); document.addEventListener('click', function (e) { if (userDropdownMenuEl && userDropdownMenuEl.style.display === 'block' && !userBtnTriggerEl.contains(e.target) && !userDropdownMenuEl.contains(e.target)) { userDropdownMenuEl.style.display = 'none'; userBtnTriggerEl.setAttribute('aria-expanded', 'false'); } }); }
  // Elementi del DOM per il popup di login/registrazione
  const loginOverlayEl = gebi("loginOverlay"); const loginPopupEl = gebi("loginPopup"); const closePopupBtnEl = gebi("closeLoginPopupBtn"); const loginTabsEls = document.querySelectorAll(".login-tab"); const loginFormsEls = document.querySelectorAll("#loginPopup .login-form");
  const loginErrorMessagePopupEl = gebi('login-error-message-popup'); const registerErrorMessagePopupEl = gebi('register-error-message-popup');
  function isAnyPopupActive() {
    const isActive = (el) => el && (el.classList.contains('active') || window.getComputedStyle(el).display !== 'none');
    return isActive(loginPopupEl) ||
            isActive(gebi('forgotPasswordPopup')) ||
            isActive(gebi('loginRequiredPopup')) ||
            isActive(gebi('dashAdminEventPopup')) ||
            (globalFlyerOverlayEff && globalFlyerOverlayEff.classList.contains('active')) ||
            (customConfirmOverlayEl && customConfirmOverlayEl.classList.contains('active')) ||
            (eventFiltersEl && eventFiltersEl.classList.contains('active')); // Aggiunto controllo per drawer filtri
  }
  function openLoginPopup() {
    if(gebi('loginRequiredPopup')?.classList.contains('active')) closeLoginRequiredPopup();
    if (loginOverlayEl) loginOverlayEl.classList.add("active");
    if (loginPopupEl) loginPopupEl.classList.add("active");
    document.body.style.overflow = "hidden";
    resetFormErrors();
    const loginTabToActivate = loginPopupEl.querySelector('.login-tab[data-tab="login"]');
    if (loginTabToActivate) loginTabToActivate.click();
    const firstInput = loginPopupEl.querySelector('#login-email-popup');
    if (firstInput) firstInput.focus();
  }
  function closeLoginPopup() {
    if (loginOverlayEl) loginOverlayEl.classList.remove("active");
    if (loginPopupEl) loginPopupEl.classList.remove("active");
    if (!isAnyPopupActive()) {
      document.body.style.overflow = "";
    }
    resetFormErrors();
  }
  function resetFormErrors() {
    loginFormsEls.forEach(form => { form.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border')); });
    if (loginErrorMessagePopupEl) loginErrorMessagePopupEl.style.display = 'none';
    if (registerErrorMessagePopupEl) registerErrorMessagePopupEl.style.display = 'none';
  }
  gebi("login-btn-desktop")?.addEventListener("click", (e) => { e.preventDefault(); openLoginPopup(); });
  gebi("login-btn-mobile")?.addEventListener("click", (e) => { e.preventDefault(); openLoginPopup(); closeMobileMenu(); });
  if (closePopupBtnEl) closePopupBtnEl.addEventListener("click", closeLoginPopup);
  if (loginOverlayEl) loginOverlayEl.addEventListener("click", (e) => { if (e.target === loginOverlayEl) closeLoginPopup(); });
  loginTabsEls.forEach((tab) => {
    tab.addEventListener("click", () => {
      const tabId = tab.getAttribute("data-tab");
      loginTabsEls.forEach((t) => t.classList.remove("active"));
      tab.classList.add("active");
      loginFormsEls.forEach((form) => {
        form.classList.remove("active");
        if (form.id === `${tabId}FormPopup`) {
          form.classList.add("active");
          form.querySelector('input:not([type="hidden"])')?.focus();
        }
      });
      resetFormErrors();
    });
  });
  gebi("loginFormPopup")?.addEventListener("submit", async (e) => { e.preventDefault(); const loginButton = e.target.querySelector('button[type="submit"]'); const originalButtonText = loginButton.textContent; loginButton.disabled = true; loginButton.innerHTML = 'Accesso... <div class="spinner-mini-light"></div>'; const emailInput = gebi('login-email-popup'); const passwordInput = gebi('login-password-popup'); emailInput.classList.remove('error-border'); passwordInput.classList.remove('error-border'); if(loginErrorMessagePopupEl) loginErrorMessagePopupEl.style.display = 'none'; try { const response = await fetch('login.php', { method: 'POST', body: new FormData(e.target) }); if (!response.ok) { let errorData = { message: `Errore HTTP: ${response.status}` }; try { errorData = await response.json(); } catch (parseError) {} throw new Error(errorData.message || `Errore HTTP: ${response.status}`); } const result = await response.json(); if (result.success) { currentUserData = { nome: result.nome, email: result.email, iconPath: result.iconPath, isAdmin: result.is_admin === true || result.is_admin === 1 }; localStorage.setItem('userDataEFF', JSON.stringify(currentUserData)); await fetchAndUpdateUserDisplayData(); closeLoginPopup(); loadPastEvents(); } else { emailInput.classList.add('error-border'); passwordInput.classList.add('error-border'); if(loginErrorMessagePopupEl) { loginErrorMessagePopupEl.textContent = result.message || "Credenziali non valide."; loginErrorMessagePopupEl.style.display = 'block'; } } } catch (error) { emailInput.classList.add('error-border'); passwordInput.classList.add('error-border'); if(loginErrorMessagePopupEl) { loginErrorMessagePopupEl.textContent = "Errore di connessione o risposta non valida."; loginErrorMessagePopupEl.style.display = 'block'; } } finally { loginButton.disabled = false; loginButton.innerHTML = originalButtonText; } });
  gebi("registerFormPopup")?.addEventListener("submit", async (e) => { e.preventDefault(); const registerButton = e.target.querySelector('button[type="submit"]'); const originalButtonText = registerButton.textContent; registerButton.disabled = true; registerButton.innerHTML = 'Registrazione... <div class="spinner-mini-light"></div>'; if(registerErrorMessagePopupEl) registerErrorMessagePopupEl.style.display = 'none'; e.target.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border')); try { const response = await fetch('registrati.php', { method: 'POST', body: new FormData(e.target) }); if (!response.ok) { let errorMsg = `Errore HTTP: ${response.status} ${response.statusText}`; try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; } catch(err) {} throw new Error(errorMsg); } const result = await response.json(); if (result.success) { alert(result.message || "Registrazione completata! Ora puoi effettuare il login."); const loginTabButton = document.querySelector('#loginPopup .login-tab[data-tab="login"]'); if (loginTabButton) loginTabButton.click(); const loginEmailPopup = gebi('login-email-popup'); const registerEmailPopup = gebi('register-email-popup'); if (loginEmailPopup && registerEmailPopup) loginEmailPopup.value = registerEmailPopup.value; e.target.reset(); } else { if(registerErrorMessagePopupEl) { registerErrorMessagePopupEl.textContent = result.message || "Errore durante la registrazione."; registerErrorMessagePopupEl.style.display = 'block'; } if (result.errors) { for (const fieldNameFromError in result.errors) { const inputElement = e.target.elements[fieldNameFromError] || gebi(`register-${fieldNameFromError}-popup`); if (inputElement) inputElement.classList.add('error-border'); } } } } catch (error) { if(registerErrorMessagePopupEl) { registerErrorMessagePopupEl.textContent = "Errore: " + error.message; registerErrorMessagePopupEl.style.display = 'block'; } } finally { registerButton.disabled = false; registerButton.innerHTML = originalButtonText; } });
  const forgotPasswordLink = document.getElementById('forgotPasswordLink');
  const forgotPasswordOverlay = document.getElementById('forgotPasswordOverlay');
  const forgotPasswordPopup = document.getElementById('forgotPasswordPopup');
  const closeForgotPasswordPopupBtn = document.getElementById('closeForgotPasswordPopupBtn');
  const forgotPasswordForm = document.getElementById('forgotPasswordForm');
  const forgotPasswordMessage = document.getElementById('forgot-password-message');
  function openForgotPasswordPopup() {
    if (typeof closeLoginPopup === 'function' && loginPopupEl?.classList.contains('active')) {
      closeLoginPopup();
    }
    if (forgotPasswordOverlay) forgotPasswordOverlay.classList.add('active');
    if (forgotPasswordPopup) forgotPasswordPopup.classList.add('active');
    document.body.style.overflow = 'hidden';
    if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'none';
    const forgotEmailInput = document.getElementById('forgot-email');
    if(forgotEmailInput) forgotEmailInput.focus();
  }
  function closeForgotPasswordPopup() {
    if (forgotPasswordOverlay) forgotPasswordOverlay.classList.remove('active');
    if (forgotPasswordPopup) forgotPasswordPopup.classList.remove('active');
    if (!isAnyPopupActive()) {
      document.body.style.overflow = '';
    }
    if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'none';
    if(forgotPasswordForm) forgotPasswordForm.reset();
  }
  if (forgotPasswordLink) {
    forgotPasswordLink.addEventListener('click', (e) => {
      e.preventDefault();
      openForgotPasswordPopup();
    });
  }
  if (closeForgotPasswordPopupBtn) closeForgotPasswordPopupBtn.addEventListener('click', closeForgotPasswordPopup);
  if (forgotPasswordOverlay) forgotPasswordOverlay.addEventListener('click', (e) => { if (e.target === forgotPasswordOverlay) closeForgotPasswordPopup(); });
  if (forgotPasswordForm) {
    forgotPasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (forgotPasswordMessage) {
        forgotPasswordMessage.style.display = 'none';
        forgotPasswordMessage.className = 'form-message';
      }
      const emailInput = document.getElementById('forgot-email');
      const submitBtn = forgotPasswordForm.querySelector('button[type="submit"]');
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Invio...<div class="spinner-mini-light"></div>';
      try {
        const formData = new FormData(forgotPasswordForm);
        const response = await fetch('richiesta_recupero_password.php', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        if (result.success) {
          forgotPasswordMessage.textContent = result.message;
          forgotPasswordMessage.classList.add('success');
          if(emailInput) emailInput.value = '';
        } else {
          forgotPasswordMessage.textContent = result.message || "Si è verificato un errore.";
          forgotPasswordMessage.classList.add('error');
        }
      } catch (error) {
        console.error('Errore richiesta recupero password:', error);
        forgotPasswordMessage.textContent = "Errore di connessione o del server.";
        forgotPasswordMessage.classList.add('error');
      } finally {
        if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
      }
    });
  }
  const loginRequiredOverlayEl = gebi("loginRequiredOverlay"); const loginRequiredPopupEl = gebi("loginRequiredPopup"); const closeLoginRequiredPopupBtnEl = gebi("closeLoginRequiredPopupBtn"); const loginRequiredLoginBtnEl = gebi("loginRequiredLoginBtn");
  function showLoginRequiredPopup(event) { if (event) event.preventDefault(); if (loginRequiredOverlayEl) loginRequiredOverlayEl.classList.add("active"); if (loginRequiredPopupEl) loginRequiredPopupEl.classList.add("active"); document.body.style.overflow = "hidden"; }
  function closeLoginRequiredPopup() { if (loginRequiredOverlayEl) loginRequiredOverlayEl.classList.remove("active"); if (loginRequiredPopupEl) loginRequiredPopupEl.classList.remove("active"); if (!isAnyPopupActive()) { document.body.style.overflow = ""; } }
  if (closeLoginRequiredPopupBtnEl) closeLoginRequiredPopupBtnEl.addEventListener("click", closeLoginRequiredPopup);
  if (loginRequiredOverlayEl) loginRequiredOverlayEl.addEventListener("click", (e) => { if (e.target === loginRequiredOverlayEl) closeLoginRequiredPopup(); });
  if (loginRequiredLoginBtnEl) { loginRequiredLoginBtnEl.addEventListener("click", () => { closeLoginRequiredPopup(); openLoginPopup(); }); }
  // NUOVE FUNZIONI PER POPUP MODALE ADMIN
  function initializeDashAdminEventPopupHandlers() {
    dashAdminEventPopupOverlayEl = gebi('dashAdminEventPopupOverlay');
    dashAdminEventPopupEl = gebi('dashAdminEventPopup');
    closeDashAdminEventPopupBtnEl = gebi('closeDashAdminEventPopupBtn');
    dashAdminEventFormEl = gebi('dashAdminEventForm');
    dashAdminEventPopupTitleEl = gebi('dashAdminEventPopupTitle');
    dashAdminEventIdInputEl = gebi('dashAdmin-event-id');
    dashAdminEventTitleEl = gebi('dashAdmin-event-title');
    dashAdminEventDateEl = gebi('dashAdmin-event-date');
    dashAdminEventStartTimeEl = gebi('dashAdmin-event-start-time');
    dashAdminEventEndTimeEl = gebi('dashAdmin-event-end-time');
    dashAdminEventShortDescEl = gebi('dashAdmin-event-short-desc');
    dashAdminEventLongDescEl = gebi('dashAdmin-event-long-desc');
    dashAdminEventPrefixEl = gebi('dashAdmin-event-prefix');
    dashAdminEventSpeakerEl = gebi('dashAdmin-event-speaker');
    dashAdminEventAssociationEl = gebi('dashAdmin-event-association');
    dashAdminEventSeatsEl = gebi('dashAdmin-event-seats');
    dashAdminEventImageEl = gebi('dashAdmin-event-image');
    dashAdminEventFlyerEl = gebi('dashAdmin-event-flyer');
    dashAdminEventBookingCheckbox = gebi('dashAdmin-event-booking');
    dashAdminEventVoluntaryCheckbox = gebi('dashAdmin-event-voluntary');
    dashAdminEventPriceContainerEl = gebi('dashAdmin-event-price-container');
    dashAdminEventPriceInputEl = gebi('dashAdmin-event-price');
    dashAdminEventFormMessageEl = gebi('dashAdminEventFormMessage');
    dashAdminCurrentImagePreviewEl = gebi('dashAdmin-current-event-image-preview');
    dashAdminCurrentFlyerPreviewEl = gebi('dashAdmin-current-event-flyer-preview');
    dashAdminPreviewImageEl = gebi('dashAdmin_previewImage');
    dashAdminPreviewNoImagePlaceholderEl = document.querySelector('#dashAdminEventCardPreviewContainer .dash-admin-no-image-placeholder');
    dashAdminPreviewTitleEl = gebi('dashAdmin_previewTitle');
    dashAdminPreviewDateFullEl = gebi('dashAdmin_previewDateFull').querySelector('.value');
    dashAdminPreviewTimeFullEl = gebi('dashAdmin_previewTimeFull');
    dashAdminPreviewTimeValueEl = gebi('dashAdmin_previewTimeFull').querySelector('.value');
    dashAdminPreviewSpeakerFullEl = gebi('dashAdmin_previewSpeakerFull');
    dashAdminPreviewSpeakerPrefixEl = gebi('dashAdmin_previewSpeakerPrefix');
    dashAdminPreviewSpeakerNameEl = gebi('dashAdmin_previewSpeakerName');
    dashAdminPreviewShortDescEl = gebi('dashAdmin_previewShortDesc');
    dashAdminPreviewSeatsFullEl = gebi('dashAdmin_previewSeatsFull').querySelector('.value');
    dashAdminPreviewPriceFullEl = gebi('dashAdmin_previewPriceFull').querySelector('.value');
    customConfirmOverlayEl = gebi('customConfirmOverlay');
    customConfirmModalEl = gebi('customConfirmModal');
    customConfirmTitleEl = gebi('customConfirmTitle');
    customConfirmMessageEl = gebi('customConfirmMessage');
    customConfirmYesBtn = gebi('customConfirmYes');
    customConfirmNoBtn = gebi('customConfirmNo');
    if (closeDashAdminEventPopupBtnEl) closeDashAdminEventPopupBtnEl.addEventListener('click', () => tryCloseDashAdminEventPopup());
    if (dashAdminEventPopupOverlayEl) dashAdminEventPopupOverlayEl.addEventListener('click', (e) => { if (e.target === dashAdminEventPopupOverlayEl) tryCloseDashAdminEventPopup(); });
    if (dashAdminEventVoluntaryCheckbox) dashAdminEventVoluntaryCheckbox.addEventListener('change', updateDashAdminPriceFieldVisibility);
    attachDashAdminPreviewListeners();
    dashAdminEventFormEl?.addEventListener('submit', handleAdminEventFormSubmit);
    if (customConfirmYesBtn) customConfirmYesBtn.addEventListener('click', () => handleConfirm(true));
    if (customConfirmNoBtn) customConfirmNoBtn.addEventListener('click', () => handleConfirm(false));
    if (customConfirmOverlayEl) customConfirmOverlayEl.addEventListener('click', (e) => {
      if (e.target === customConfirmOverlayEl) handleConfirm(false);
    });
  }
  function getAdminEventFormData(form) {
    const formData = new FormData(form);
    const data = {};
    for (const [key, value] of formData.entries()) {
      const element = form.elements[key];
      if (element.type === 'checkbox') data[key] = element.checked;
      else if (element.type === 'file') data[key] = element.files.length > 0 ? element.files[0].name : '';
      else data[key] = value;
    }
    return data;
  }
  function compareAdminEventFormData(data1, data2) {
    const keys1 = Object.keys(data1);
    const keys2 = Object.keys(data2);
    if (keys1.length !== keys2.length) return false;
    for (let key of keys1) {
      if (data1[key] !== data2[key]) {
        return false;
      }
    }
    return true;
  }
  function updateDashAdminPriceFieldVisibility() {
    if (dashAdminEventVoluntaryCheckbox && dashAdminEventPriceContainerEl && dashAdminEventPriceInputEl) {
      const isVoluntary = dashAdminEventVoluntaryCheckbox.checked;
      dashAdminEventPriceContainerEl.style.display = isVoluntary ? 'none' : 'block';
      dashAdminEventPriceInputEl.required = !isVoluntary;
      if (isVoluntary) dashAdminEventPriceInputEl.value = '';
      updateDashAdminEventPreview();
    }
  }
  function sanitizeForAttribute(str) {
    if (typeof str !== 'string' || str === null) return '';
    return str.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
  }
  function sanitizeText(text) {
    if (text === null || typeof text === 'undefined') return '';
    const element = document.createElement('div'); element.innerText = String(text); return element.innerHTML;
  }
  function openEditPastEventPopup(eventData = null) {
    if (!dashAdminEventFormEl) return;
    if(dashAdminEventPopupTitleEl) dashAdminEventPopupTitleEl.textContent = 'Modifica Evento Passato';
    if (!eventData) return;
    if(dashAdminEventIdInputEl) dashAdminEventIdInputEl.value = eventData.idevento;
    dashAdminEventTitleEl.value = eventData.titolo || '';
    dashAdminEventDateEl.value = eventData.datainizio ? eventData.datainizio.substring(0,10) : '';
    let startTime = '', endTime = '';
    const durata = eventData.durata || '';
    if (durata.includes('-')) {
      const parts = durata.split('-');
      startTime = parts[0].trim().match(/^\d{2}:\d{2}/) ? parts[0].trim().substring(0,5) : '';
      endTime = parts[1].trim().match(/^\d{2}:\d{2}/) ? parts[1].trim().substring(0,5) : '';
    } else if (durata.match(/^\d{2}:\d{2}/)) {
      startTime = durata.substring(0,5);
    }
    dashAdminEventStartTimeEl.value = startTime;
    dashAdminEventEndTimeEl.value = endTime;
    dashAdminEventShortDescEl.value = eventData.descrizione || '';
    dashAdminEventLongDescEl.value = eventData.descrizione_estesa || '';
    dashAdminEventPrefixEl.value = eventData.prefisso_relatore || 'Relatore';
    dashAdminEventSpeakerEl.value = eventData.relatore || '';
    dashAdminEventAssociationEl.value = eventData.associazione || '';
    dashAdminEventSeatsEl.value = eventData.posti_disponibili !== null ? eventData.posti_disponibili : '0';
    dashAdminEventBookingCheckbox.checked = parseInt(eventData.flagprenotabile) === 1;
    dashAdminEventVoluntaryCheckbox.checked = parseFloat(eventData.costo) === 0.00;
    updateDashAdminPriceFieldVisibility();
    if (!dashAdminEventVoluntaryCheckbox.checked && eventData.costo && parseFloat(eventData.costo) > 0) {
      dashAdminEventPriceInputEl.value = parseFloat(eventData.costo).toFixed(2);
    } else {
      dashAdminEventPriceInputEl.value = '';
    }
    if (dashAdminCurrentImagePreviewEl && eventData.immagine_url) {
      dashAdminCurrentImagePreviewEl.src = eventData.immagine_url;
      dashAdminCurrentImagePreviewEl.style.display = 'block';
    } else if (dashAdminCurrentImagePreviewEl) {
      dashAdminCurrentImagePreviewEl.style.display = 'none';
      dashAdminCurrentImagePreviewEl.src = '#';
    }
    if(dashAdminEventFlyerEl) dashAdminEventFlyerEl.value = '';
    if (dashAdminCurrentFlyerPreviewEl && eventData.volantino_url) {
      dashAdminCurrentFlyerPreviewEl.innerHTML = `<a href="${sanitizeForAttribute(eventData.volantino_url)}" target="_blank" title="Visualizza il volantino attuale">${sanitizeText(eventData.volantino_url.split('/').pop())}</a>`;
    } else if (dashAdminCurrentFlyerPreviewEl) {
      dashAdminCurrentFlyerPreviewEl.innerHTML = `<span>Nessun volantino caricato.</span>`;
    }
    updateDashAdminEventPreview();
    storeInitialFormData();
    if(dashAdminEventPopupOverlayEl) dashAdminEventPopupOverlayEl.classList.add('active');
    if(dashAdminEventPopupEl) dashAdminEventPopupEl.classList.add('active');
    document.body.style.overflow = 'hidden';
    if(dashAdminEventTitleEl) dashAdminEventTitleEl.focus();
  }
  function storeInitialFormData() {
    if (dashAdminEventFormEl) {
      initialAdminEventFormData = getAdminEventFormData(dashAdminEventFormEl);
      isEventFormDirty = false;
    }
  }
  async function tryCloseDashAdminEventPopup() {
    const currentFormData = getAdminEventFormData(dashAdminEventFormEl);
    const imageFileChanged = dashAdminEventImageEl.files.length > 0 && initialAdminEventFormData['event-image'] !== dashAdminEventImageEl.files[0].name;
    const flyerFileChanged = dashAdminEventFlyerEl.files.length > 0 && initialAdminEventFormData['event-flyer'] !== dashAdminEventFlyerEl.files[0].name;
    isEventFormDirty = !compareAdminEventFormData(initialAdminEventFormData, currentFormData) || imageFileChanged || flyerFileChanged;
    if (isEventFormDirty) {
      const confirmed = await showCustomConfirm(
              "Conferma Uscita",
              "Hai modifiche non salvate. Sei sicuro di voler uscire senza salvare?",
              "Esci",
              "Annulla"
      );
      if (confirmed) {
        closeDashAdminEventPopup_actual();
      }
      return;
    }
    closeDashAdminEventPopup_actual();
  }
  function closeDashAdminEventPopup_actual() {
    if(dashAdminEventPopupOverlayEl) dashAdminEventPopupOverlayEl.classList.remove('active');
    if(dashAdminEventPopupEl) dashAdminEventPopupEl.classList.remove('active');
    if (!isAnyPopupActive()) document.body.style.overflow = '';
    isEventFormDirty = false;
    dashAdminEventFormEl.reset();
  }
  function updateDashAdminEventPreview() {
    if (!dashAdminPreviewTitleEl) return;
    dashAdminPreviewTitleEl.textContent = dashAdminEventTitleEl.value || 'Titolo Evento';
    const dateValue = dashAdminEventDateEl.value;
    dashAdminPreviewDateFullEl.textContent = dateValue ? formatSimpleDateForPreview(dateValue) : 'Seleziona data';
    const startTimeValue = dashAdminEventStartTimeEl.value;
    const endTimeValue = dashAdminEventEndTimeEl.value;
    let timeString = '';
    if (startTimeValue && endTimeValue) timeString = `${startTimeValue}-${endTimeValue}`;
    else if (startTimeValue) timeString = startTimeValue;
    if (timeString && dashAdminPreviewTimeFullEl && dashAdminPreviewTimeValueEl) {
      dashAdminPreviewTimeFullEl.style.display = 'block';
      dashAdminPreviewTimeValueEl.textContent = timeString;
    } else if (dashAdminPreviewTimeFullEl && dashAdminPreviewTimeValueEl) {
      dashAdminPreviewTimeFullEl.style.display = 'none';
      dashAdminPreviewTimeValueEl.textContent = '';
    }
    dashAdminPreviewSpeakerPrefixEl.textContent = dashAdminEventPrefixEl.value || 'Relatore';
    dashAdminPreviewSpeakerNameEl.textContent = dashAdminEventSpeakerEl.value || 'Nome Relatore';
    dashAdminPreviewShortDescEl.textContent = dashAdminEventShortDescEl.value || 'Descrizione breve dell\'evento qui...';
    dashAdminPreviewSeatsFullEl.textContent = dashAdminEventSeatsEl.value || '0';
    const isVoluntary = dashAdminEventVoluntaryCheckbox.checked;
    if (isVoluntary) dashAdminPreviewPriceFullEl.textContent = 'Offerta libera';
    else {
      const priceValue = parseFloat(dashAdminEventPriceInputEl.value);
      dashAdminPreviewPriceFullEl.textContent = !isNaN(priceValue) && priceValue > 0 ? `€ ${priceValue.toFixed(2)}` : '€ 0.00';
    }
    const imageInput = dashAdminEventImageEl;
    if (imageInput.files && imageInput.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        dashAdminPreviewImageEl.src = e.target.result;
        dashAdminPreviewImageEl.style.display = 'block';
        if(dashAdminPreviewNoImagePlaceholderEl) dashAdminPreviewNoImagePlaceholderEl.style.display = 'none';
      }
      reader.readAsDataURL(imageInput.files[0]);
    } else if (dashAdminCurrentImagePreviewEl && dashAdminCurrentImagePreviewEl.src !== '#' && dashAdminCurrentImagePreviewEl.style.display !== 'none') {
      dashAdminPreviewImageEl.src = dashAdminCurrentImagePreviewEl.src;
      dashAdminPreviewImageEl.style.display = 'block';
      if(dashAdminPreviewNoImagePlaceholderEl) dashAdminPreviewNoImagePlaceholderEl.style.display = 'none';
    } else {
      dashAdminPreviewImageEl.src = 'images/default-event.jpg';
      dashAdminPreviewImageEl.style.display = 'block';
      if(dashAdminPreviewNoImagePlaceholderEl) dashAdminPreviewNoImagePlaceholderEl.style.display = 'none';
    }
  }
  function attachDashAdminPreviewListeners() {
    const formElementsToWatch = [
      'dashAdmin-event-title', 'dashAdmin-event-date', 'dashAdmin-event-start-time', 'dashAdmin-event-end-time',
      'dashAdmin-event-short-desc', 'dashAdmin-event-prefix', 'dashAdmin-event-speaker', 'dashAdmin-event-seats',
      'dashAdmin-event-price', 'dashAdmin-event-voluntary', 'dashAdmin-event-image', 'dashAdmin-event-long-desc'
    ];
    formElementsToWatch.forEach(id => {
      const element = gebi(id);
      if (element) {
        element.addEventListener('input', updateDashAdminEventPreview);
        if (element.type === 'checkbox' || element.type === 'file' || element.type === 'date' || element.type === 'time') {
          element.addEventListener('change', updateDashAdminEventPreview);
        }
      }
    });
    if (dashAdminEventFlyerEl && dashAdminCurrentFlyerPreviewEl) {
      dashAdminEventFlyerEl.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          dashAdminCurrentFlyerPreviewEl.innerHTML = `<a href="${URL.createObjectURL(this.files[0])}" target="_blank" title="Visualizza il volantino selezionato">${sanitizeText(this.files[0].name)}</a>`;
        } else if (!dashAdminEventIdInputEl.value) {
          dashAdminCurrentFlyerPreviewEl.innerHTML = '<span>Nessun volantino caricato.</span>';
        }
      });
    }
  }
  async function handleAdminEventFormSubmit(e) {
    e.preventDefault();
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true; submitBtn.innerHTML = '<div class="spinner-mini"></div>Salvataggio...';
    if(dashAdminEventFormMessageEl) { dashAdminEventFormMessageEl.style.display = 'none'; dashAdminEventFormMessageEl.className = 'form-message';}
    try {
      const formData = new FormData(this);
      formData.append('action', formData.get('event-id') ? 'update_event' : 'add_event');
      const startTime = formData.get('event-start-time'); const endTime = formData.get('event-end-time');
      let durataString = '';
      if (startTime && endTime) durataString = `${startTime}-${endTime}`;
      else if (startTime) durataString = startTime;
      formData.append('event-time', durataString);
      formData.delete('event-start-time'); formData.delete('event-end-time');
      if (dashAdminEventVoluntaryCheckbox.checked) formData.set('event-price', '0.00');
      else if (!formData.get('event-price')) formData.set('event-price', '0.00');
      const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
      const responseText = await response.text();
      let result; try { result = JSON.parse(responseText); }
      catch (jsonError) { throw new Error(`Risposta non JSON dal server: ${responseText.substring(0,200)}`); }
      if (!response.ok) throw new Error(result.message || `Errore server: ${response.status}`);
      if (result.success) {
        if(dashAdminEventFormMessageEl) {
          dashAdminEventFormMessageEl.textContent = result.message || 'Operazione completata!';
          dashAdminEventFormMessageEl.classList.add('success');
          dashAdminEventFormMessageEl.style.display = 'block';
        }
        loadPastEvents();
        isEventFormDirty = false;
        setTimeout(closeDashAdminEventPopup_actual, 1500);
      } else { throw new Error(result.message || 'Errore durante il salvataggio dell\'evento.'); }
    } catch (error) {
      console.error('Errore invio form evento admin (stile dashboard):', error);
      if(dashAdminEventFormMessageEl) {
        dashAdminEventFormMessageEl.textContent = `Errore: ${error.message}`;
        dashAdminEventFormMessageEl.classList.add('error');
        dashAdminEventFormMessageEl.style.display = 'block';
      }
    } finally {
      submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText;
    }
  }
  async function handleDeleteEvent(eventId) {
    const eventToDelete = allPastEventsData.find(e => e.idevento == eventId);
    const eventTitle = eventToDelete ? eventToDelete.titolo : "questo evento";
    const userConfirmed = await showCustomConfirm(
            "Conferma eliminazione",
            `Sei sicuro di voler eliminare l'evento "${sanitizeForAttribute(eventTitle)}"? L'azione è irreversibile.`,
            "Elimina",
            "Annulla"
    );
    if (userConfirmed) {
      const deleteButton = document.querySelector(`.btn-delete[data-event-id="${eventId}"]`);
      let originalButtonHTML = '';
      if(deleteButton) {
        originalButtonHTML = deleteButton.innerHTML;
        deleteButton.disabled = true;
        deleteButton.innerHTML = '<div class="spinner-mini" style="border-top-color:white;"></div>';
      }
      try {
        const formData = new FormData(); formData.append('action', 'delete_event'); formData.append('event_id', eventId);
        const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
        const resText = await response.text();
        let result; try { result = JSON.parse(resText); }
        catch(e) { throw new Error("Risposta non JSON dal server (delete): "+resText.substring(0,100));}
        if (!response.ok) throw new Error(result.message || `Errore HTTP ${response.status}`);
        if (result.success) { console.log(result.message || 'Evento eliminato con successo.'); loadPastEvents(); }
        else { throw new Error(result.message || 'Eliminazione fallita.'); }
      } catch (error) {
        console.error('Errore eliminazione evento:', error);
        alert(`Errore durante l'eliminazione: ${error.message}`);
      } finally {
        if(deleteButton) { deleteButton.disabled = false; deleteButton.innerHTML = originalButtonHTML; }
      }
    }
  }
  function formatDate(dateString) {
    if (!dateString) return "Data non disponibile";
    try {
      const normalizedDateString = dateString.length === 10 ? dateString + "T00:00:00Z" : dateString.replace(" ", "T") + (dateString.endsWith("Z") ? "" : "Z");
      const date = new Date(normalizedDateString);
      if (isNaN(date.getTime())) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString.substring(0,10))) {
          const parts = dateString.substring(0,10).split('-');
          const utcDate = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
          if (!isNaN(utcDate.getTime())) return utcDate.toLocaleDateString("it-IT", { day: "numeric", month: "long", year: "numeric", timeZone: 'UTC' });
        }
        return dateString;
      }
      return date.toLocaleDateString("it-IT", { day: "numeric", month: "long", year: "numeric", timeZone: 'UTC' });
    } catch (e) {
      return dateString;
    }
  }
  function formatSimpleDateForPreview(dateString) {
    if (!dateString) return 'Seleziona data';
    try {
      const parts = dateString.split('-');
      if (parts.length === 3) return `${parts[2]}/${parts[1]}`;
      return dateString;
    } catch (e) { return dateString; }
  }
  function populateYearFilter() {
    const currentYr = new Date().getFullYear();
    let minYear = currentYr;
    if (allPastEventsData && allPastEventsData.length > 0) {
      allPastEventsData.forEach(event => {
        if (event.datainizio) {
          const eventYear = parseInt(event.datainizio.substring(0, 4));
          if (!isNaN(eventYear) && eventYear < minYear) {
            minYear = eventYear;
          }
        }
      });
    } else {
      minYear = currentYr - 4;
    }
    if (searchYearEl) {
      searchYearEl.innerHTML = '<option value="">Tutti gli anni</option>';
      for (let y = currentYr; y >= minYear; y--) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        searchYearEl.appendChild(option);
      }
      searchYearEl.value = currentYr.toString();
    }
  }
  // === NUOVE FUNZIONI PER POPUP VOLANTINO E SANITIZZAZIONE ===
  function initGlobalFlyerOverlay() {
    if (!document.getElementById('globalFlyerOverlayEff')) {
      const overlay = document.createElement('div');
      overlay.id = 'globalFlyerOverlayEff';
      overlay.className = 'flyer-overlay-eff';
      document.body.appendChild(overlay);
      globalFlyerOverlayEff = overlay;
      globalFlyerOverlayEff.addEventListener('click', (e) => {
        if (e.target === globalFlyerOverlayEff) hideFlyerPopupEff();
      });
    } else {
      globalFlyerOverlayEff = document.getElementById('globalFlyerOverlayEff');
    }
  }
  function showFlyerPopupEff(volantinoUrl) {
    if (!globalFlyerOverlayEff) return;
    if (currentFlyerModalEff) currentFlyerModalEff.remove();
    document.body.classList.add("flyer-popup-active-eff");
    globalFlyerOverlayEff.classList.add("active");
    currentFlyerModalEff = document.createElement("article");
    currentFlyerModalEff.className = "flyer-modal-eff";
    let flyerContentHTML = '';
    const sanitizedUrl = sanitizeForAttribute(volantinoUrl);
    if (volantinoUrl && volantinoUrl.trim() !== "") {
      if (volantinoUrl.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i)) {
        flyerContentHTML = `<img src="${sanitizedUrl}" alt="Volantino Evento">`;
      } else if (volantinoUrl.endsWith('.pdf')) {
        flyerContentHTML = `<iframe src="${sanitizedUrl}" type="application/pdf" title="Volantino PDF"></iframe>`;
      } else {
        flyerContentHTML = `<div class="flyer-message-display-eff"><p>Il volantino è disponibile come file esterno.</p><a href="${sanitizedUrl}" target="_blank" rel="noopener noreferrer">Visualizza Volantino</a></div>`;
      }
    } else {
      flyerContentHTML = `<div class="flyer-message-display-eff"><p>Volantino non disponibile.</p></div>`;
    }
    currentFlyerModalEff.innerHTML = `
      <button class="flyer-close-btn-eff" aria-label="Chiudi">&times;</button>
      <div class="flyer-content-area-eff">
          <div class="flyer-media-container-eff">${flyerContentHTML}</div>
      </div>`;
    globalFlyerOverlayEff.appendChild(currentFlyerModalEff);
    const closeBtn = currentFlyerModalEff.querySelector('.flyer-close-btn-eff');
    if (closeBtn) { closeBtn.onclick = hideFlyerPopupEff; closeBtn.focus(); }
  }
  function hideFlyerPopupEff() {
    if (globalFlyerOverlayEff) globalFlyerOverlayEff.classList.remove("active");
    if (currentFlyerModalEff) {
      currentFlyerModalEff.addEventListener('transitionend', function handleTransitionEnd(event) {
        if (event.propertyName === 'opacity' && currentFlyerModalEff && !globalFlyerOverlayEff.classList.contains('active')) {
          currentFlyerModalEff.remove(); currentFlyerModalEff = null;
          event.target.removeEventListener('transitionend', handleTransitionEnd);
        }
      });
      if (currentFlyerModalEff && !globalFlyerOverlayEff.classList.contains('active')) {
        setTimeout(() => {
          if (currentFlyerModalEff && !globalFlyerOverlayEff.classList.contains('active')) {
            currentFlyerModalEff.remove(); currentFlyerModalEff = null;
          }
        }, 450);
      }
    }
    document.body.classList.remove("flyer-popup-active-eff");
  }
  // === FINE NUOVE FUNZIONI ===
  function createPastEventCard(event) {
    const card = document.createElement("article");
    card.className = "card";
    if (currentUserData && currentUserData.isAdmin) card.classList.add('admin-card');
    card.dataset.title = event.titolo?.toLowerCase() || '';
    card.dataset.date = event.datainizio || '';
    card.dataset.speaker = event.relatore?.toLowerCase() || '';
    let imageSrc = event.immagine_url?.trim() ? event.immagine_url : "images/default-event-past.jpg";
    // --- NUOVA LOGICA PER LE "PILLOLE" INFORMATIVE ---
    let infoPillsHTML = '<div class="card-info-pills">';
    if (event.datainizio) {
      infoPillsHTML += `<span class="info-pill"><i class="fas fa-calendar-alt"></i> ${formatDate(event.datainizio)}</span>`;
    }
    const durata = event.durata || '';
    if (durata) {
      const parts = durata.split('-');
      let formattedDurata = '';
      if (parts.length === 2 && parts[0].trim().match(/^\d{2}:\d{2}/) && parts[1].trim().match(/^\d{2}:\d{2}/)) {
        formattedDurata = `${parts[0].trim()} - ${parts[1].trim()}`;
      } else if (durata.trim().match(/^\d{2}:\d{2}/)) {
        formattedDurata = durata.trim();
      } else {
        formattedDurata = sanitizeText(durata);
      }
      if (formattedDurata) {
        infoPillsHTML += `<span class="info-pill"><i class="fas fa-clock"></i> ${formattedDurata}</span>`;
      }
    }
    if (event.relatore) {
      infoPillsHTML += `<span class="info-pill"><i class="fas fa-user"></i> ${sanitizeText(event.prefisso_relatore) || 'Relatore'}: ${sanitizeText(event.relatore)}</span>`;
    }
    if (event.associazione) {
      infoPillsHTML += `<span class="info-pill"><i class="fas fa-users"></i> ${sanitizeText(event.associazione)}</span>`;
    }
    infoPillsHTML += '</div>';
    // --- FINE NUOVA LOGICA ---
    if (currentUserData && currentUserData.isAdmin) {
      let volantinoAdminLinkHTML = '';
      if (event.volantino_url && event.volantino_url.trim() !== "") { volantinoAdminLinkHTML = `<p class="card-info" style="font-size:0.9em;"><b>Volantino:</b> <a href="${sanitizeForAttribute(event.volantino_url)}" target="_blank">Visualizza volantino</a></p>`; }
      card.innerHTML = `
        <div class="card-image-container"><img src="${imageSrc}" alt="Copertina: ${sanitizeText(event.titolo) || "Evento"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';"></div>
        <div class="card-content">
          <h3>${sanitizeText(event.titolo) || "Titolo N/D"}</h3>
          ${infoPillsHTML}
          <p class="card-description" style="font-size:0.95em; min-height: 4.5em;">${sanitizeText(event.descrizione) || "N/D"}</p>
          ${volantinoAdminLinkHTML}
          <div class="card-actions admin-actions">
            <button class="card-btn btn-edit card-btn-secondary" data-event-id="${event.idevento}">Modifica</button>
            <button class="card-btn btn-delete card-btn-primary" data-event-id="${event.idevento}">Elimina</button>
          </div>
        </div>`;
      card.querySelector('.btn-edit').addEventListener('click', function() {
        const eventToEdit = allPastEventsData.find(e => e.idevento == this.dataset.eventId);
        if (eventToEdit) openEditPastEventPopup(eventToEdit);
        else alert("Dettagli evento non trovati per la modifica.");
      });
      card.querySelector('.btn-delete').addEventListener('click', async function() { handleDeleteEvent(this.dataset.eventId); });
    } else {
      let volantinoBtnHTML = '';
      const sanitizedUrl = sanitizeForAttribute(event.volantino_url);
      if (event.volantino_url && event.volantino_url.trim() !== "") {
        volantinoBtnHTML = `<button class="card-btn card-btn-secondary btn-visualizza-volantino" data-volantino-url="${sanitizedUrl}">Volantino</button>`;
      } else {
        volantinoBtnHTML = `<button class="card-btn card-btn-secondary" disabled title="Volantino non disponibile">Volantino</button>`;
      }
      let risorseBtnHTML = '';
      if (currentUserData) {
        risorseBtnHTML = `<a href="evento_dettaglio_accesso.html?id=${event.idevento}" class="card-btn card-btn-primary">Risorse</a>`;
      } else {
        risorseBtnHTML = `<a href="#" onclick="showLoginRequiredPopup(event); return false;" class="card-btn card-btn-primary">Risorse</a>`;
      }
      const actionsHTML = `${volantinoBtnHTML}${risorseBtnHTML}`;
      card.innerHTML = `
        <div class="card-image-container"><img src="${imageSrc}" alt="Copertina: ${sanitizeText(event.titolo) || "Evento"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';"></div>
        <div class="card-content">
          <h3>${sanitizeText(event.titolo) || "Titolo non disponibile"}</h3>
          ${infoPillsHTML}
          <p class="card-description">${sanitizeText(event.descrizione) || "Nessuna descrizione breve disponibile."}</p>
          <div class="card-actions">${actionsHTML}</div>
        </div>`;
      const viewFlyerBtn = card.querySelector(".btn-visualizza-volantino");
      if (viewFlyerBtn && !viewFlyerBtn.disabled) {
        viewFlyerBtn.addEventListener("click", function() {
          if (typeof showFlyerPopupEff === 'function') {
            showFlyerPopupEff(this.dataset.volantinoUrl);
          }
        });
      }
    }
    return card;
  }
  async function loadPastEvents() {
    if (!eventiPassatiGridEl || !loadingIndicatorEl) return;
    loadingIndicatorEl.classList.add("visible");
    eventiPassatiGridEl.innerHTML = "";
    try {
      const response = await fetch("get_past_events.php");
      if (!response.ok) throw new Error( `Errore HTTP: ${response.status} ${response.statusText}` );
      const result = await response.json();
      if (result.success && result.data) {
        allPastEventsData = result.data;
        populateYearFilter();
        filterEvents();
      } else { throw new Error( result.message || "Errore nel caricamento degli eventi passati." ); }
    } catch (error) {
      if(eventiPassatiGridEl) eventiPassatiGridEl.innerHTML = `<p class="no-events error-message" style="text-align:center; padding:20px;">Errore durante il caricamento degli eventi. (${error.message}) <button onclick="loadPastEvents()" class="btn-popup" style="margin-top:10px;">Riprova</button></p>`;
    } finally {
      if(loadingIndicatorEl) loadingIndicatorEl.classList.remove("visible");
    }
  }
  function filterEvents() {
    if (!eventiPassatiGridEl) return;
    const titleFilter = searchTitleEl ? searchTitleEl.value.toLowerCase().trim() : "";
    const monthFilter = searchMonthEl ? searchMonthEl.value : "";
    const yearFilterStr = searchYearEl ? searchYearEl.value : "";
    const speakerFilter = searchSpeakerEl ? searchSpeakerEl.value.toLowerCase().trim() : "";
    eventiPassatiGridEl.innerHTML = '';
    let visibleCardsCount = 0;
    const filteredEvents = allPastEventsData.filter(event => {
      const eventTitle = event.titolo?.toLowerCase() || "";
      const eventDateStr = event.datainizio || "";
      let eventMatchesYear = (yearFilterStr === "");
      let eventMatchesMonth = (monthFilter === "");
      if (eventDateStr) {
        const eventYear = parseInt(eventDateStr.substring(0, 4));
        const eventMonthNum = eventDateStr.substring(5, 7);
        if (yearFilterStr !== "" && !isNaN(eventYear) && eventYear === parseInt(yearFilterStr)) {
          eventMatchesYear = true;
        }
        if (monthFilter !== "" && eventMonthNum === monthFilter) {
          eventMatchesMonth = true;
        }
      }
      const titleMatch = !titleFilter || eventTitle.includes(titleFilter);
      const speakerMatch = !speakerFilter || (event.relatore?.toLowerCase() || "").includes(speakerFilter);
      return titleMatch && speakerMatch && eventMatchesYear && eventMatchesMonth;
    });
    if (filteredEvents.length > 0) {
      filteredEvents.forEach(event => eventiPassatiGridEl.appendChild(createPastEventCard(event)));
      visibleCardsCount = filteredEvents.length;
    }
    const existingNoResultsMessage = gebi("noResultsMessage");
    if (existingNoResultsMessage) existingNoResultsMessage.remove();
    if (visibleCardsCount === 0) {
      const p = document.createElement("p");
      p.id = "noResultsMessage";
      p.className = "no-events";
      if (allPastEventsData.length === 0 && !titleFilter && !monthFilter && !yearFilterStr && !speakerFilter) {
        p.textContent = "Nessun evento passato trovato in archivio.";
      } else if (titleFilter || monthFilter || yearFilterStr || speakerFilter) {
        p.textContent = "Nessun evento passato corrisponde ai criteri di ricerca.";
      }
      if (p.textContent) eventiPassatiGridEl.appendChild(p);
    }
  }
  async function loadNavbarLogo() {
    const logoImgTag = document.getElementById('navbarLogoImgTag');
    if (!logoImgTag) {
      console.error("Elemento immagine logo navbar (<img id='navbarLogoImgTag'>) non trovato in eventipassati.html.");
      return;
    }
    const defaultLogoPath = 'images/Logo_eremo.png';
    try {
      const response = await fetch('api_get_page_content.php?page=index');
      if (!response.ok) {
        throw new Error(`Errore HTTP ${response.status} nel caricare i dati per il logo.`);
      }
      const data = await response.json();
      if (data.success && data.contents && data.contents.navbarLogo) {
        logoImgTag.src = data.contents.navbarLogo;
      } else {
        console.warn("URL del logo navbar non trovato o errore API. Uso il logo di default.");
        logoImgTag.src = defaultLogoPath;
      }
    } catch (error) {
      console.error("Errore nel caricare dinamicamente il logo navbar:", error);
      logoImgTag.src = defaultLogoPath;
    }
  }
  document.addEventListener("DOMContentLoaded", async () => {
    const currentYearEl = gebi("currentYear");
    if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
    initGlobalFlyerOverlay(); // Inizializza il popup del volantino
    loadUserData();
    await fetchAndUpdateUserDisplayData();
    await loadNavbarLogo();
    // Listeners per i filtri desktop
    searchTitleEl?.addEventListener("input", filterEvents);
    searchMonthEl?.addEventListener("change", filterEvents);
    searchYearEl?.addEventListener("change", filterEvents);
    searchSpeakerEl?.addEventListener("input", filterEvents);
    // NUOVI Listeners per il drawer mobile
    mobileFilterTriggerEl?.addEventListener('click', openFilterDrawer);
    filterDrawerOverlayEl?.addEventListener('click', closeFilterDrawer);
    filterDrawerCloseBtnEl?.addEventListener('click', closeFilterDrawer);
    filterDrawerApplyBtnEl?.addEventListener('click', closeFilterDrawer);
    initializeDashAdminEventPopupHandlers();
    await loadPastEvents();
    gebi('dropdownLogout')?.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
    gebi('mobileLogoutLink')?.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); closeMobileMenu(); });
    document.addEventListener("keydown", async (event) => {
      if (event.key === "Escape") {
        if (eventFiltersEl?.classList.contains('active')) closeFilterDrawer(); // Chiude il drawer filtri
        if (loginPopupEl?.classList.contains("active")) closeLoginPopup();
        if (gebi('forgotPasswordPopup')?.classList.contains("active")) closeForgotPasswordPopup();
        if (gebi('loginRequiredPopup')?.classList.contains("active")) closeLoginRequiredPopup();
        if (globalFlyerOverlayEff?.classList.contains("active")) hideFlyerPopupEff();
        if (gebi('dashAdminEventPopup')?.classList.contains("active")) await tryCloseDashAdminEventPopup();
        if (customConfirmOverlayEl?.classList.contains('active')) handleConfirm(false);
      }
    });
    if (currentUserData && currentUserData.isAdmin && typeof updateDashAdminPriceFieldVisibility === 'function') {
      updateDashAdminPriceFieldVisibility();
    }
  });
</script>
</body>
</html>
