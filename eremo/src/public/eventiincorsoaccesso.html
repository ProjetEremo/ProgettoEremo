<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .navbar-container {
            position: fixed;
            top: 0;
            width: 100%;
            transition: transform 0.3s ease;
            z-index: 1000;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-container.hidden {
            transform: translateY(-100%);
        }
        body {
            padding-top: 80px;
        }
    </style>
</head>
<body>

<header>
    <div class="navbar-container" id="navbarContainer">
        <div class="navbar">
            <a href="indexaccesso.html" style="text-decoration: none; color: inherit">
                <div class="logo">
                    <span class="emoji">üèîÔ∏è</span>
                    <h2>Eremo Frate Francesco</h2>
                </div>
            </a>
            <div class="menu">
                <a href="chi-siamo.html">Chi siamo</a>
                <span class="separator">|</span>
                <a href="eventiincorsoaccesso.html" class="active">Calendario attivit√°</a>
                <a href="eventipassatiaccesso.html">Archivio attivit√°</a>
                <span class="separator">|</span>
                <a href="incontrisullaparolaaccesso.html">Incontri sulla parola</a>
                <span class="separator">|</span>
                <a href="">Dove siamo</a>
                <a href="contattiaccesso.html">Contatti</a>
            </div>

            <div class="right-menu">
                <div class="user-dropdown" onclick="toggleUserMenu()">
                    <button class="user-btn">
                        <span class="user-avatar">üò∫</span>
                        <span class="user-name">Area Personale</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-menu">
                        <a href="areapersonale.html" class="dropdown-item">Il mio profilo</a>
                        <a href="gestisciprenotazioni.html" class="dropdown-item">Le mie prenotazioni</a>
                        <a href="logout.html" class="dropdown-item">Esci</a>
                    </div>
                </div>
                <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
            </div>
        </div>
    </div>

    <script>
        function toggleUserMenu() {
            const dropdown = document.querySelector('.user-dropdown');
            dropdown.classList.toggle('show');
        }

        // Chiudi il dropdown se si clicca fuori
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.user-dropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
</header>

    <script>
        let lastScroll = 0;
        const navbar = document.getElementById('navbarContainer');
        
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            
            if (currentScroll <= 0) {
                navbar.classList.remove('hidden');
                return;
            }
            
            if (currentScroll > lastScroll) {
                navbar.classList.add('hidden');
            } else {
                navbar.classList.remove('hidden');
            }
            
            lastScroll = currentScroll;
        });

        function toggleMenu() {
            const menu = document.getElementById("mobileMenu");
            const button = document.querySelector(".hamburger");
            const isOpen = menu.classList.toggle("open");
            button.classList.toggle("open");
            button.setAttribute("aria-expanded", isOpen);
        }

        function closeMenu() {
            document.getElementById("mobileMenu").classList.remove("open");
            document.querySelector(".hamburger").classList.remove("open");
            document.querySelector(".hamburger").setAttribute("aria-expanded", "false");
        }
    </script>

    <div class="container section-padding">
        <h1 class="text-center mb-4">Calendario Attivit√†</h1>

        <div class="card-grid" id="eventiGrid">
            <!-- Gli eventi verranno caricati qui dinamicamente via JavaScript -->
        </div>

    </div>

<footer>
    <p>&copy; 2025 Eremo Frate Francesco. Tutti i diritti riservati.</p>
</footer>

<script>
    // Gestione pulsante aggiungi evento
    const addEventBtn = document.getElementById('addEventBtn');
    const eventPopupOverlay = document.getElementById('eventPopupOverlay');
    const eventPopup = document.getElementById('eventPopup');
    const closeEventPopup = document.getElementById('closeEventPopup');
    const voluntaryCheckbox = document.getElementById('event-voluntary');
    const priceContainer = document.getElementById('event-price-container');

    // Mostra/nascondi campo prezzo in base alla checkbox
    voluntaryCheckbox.addEventListener('change', function() {
        priceContainer.style.display = this.checked ? 'none' : 'block';
    });

    // Apri popup
    addEventBtn.addEventListener('click', function() {
        eventPopupOverlay.classList.add('active');
        eventPopup.classList.add('active');
        document.body.style.overflow = 'hidden';
    });

    // Chiudi popup
    closeEventPopup.addEventListener('click', closeEventPopupHandler);
    eventPopupOverlay.addEventListener('click', closeEventPopupHandler);

    function closeEventPopupHandler() {
        eventPopupOverlay.classList.remove('active');
        eventPopup.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Gestione invio form
    // Gestione invio form
    document.getElementById('newEventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Salvataggio...';

        try {
            const formData = new FormData(this);
            formData.append('action', 'add_event');

            const response = await fetch('gestione_eventi.php', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Errore HTTP: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                alert(result.message);
                closeEventPopupHandler();
                window.location.reload(); // Ricarica la pagina per vedere il nuovo evento
            } else {
                throw new Error(result.message || 'Errore durante il salvataggio');
            }
        } catch (error) {
            console.error('Errore:', error);
            alert(`Errore: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });

    // Chiudi con ESC
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && eventPopup.classList.contains('active')) {
            closeEventPopupHandler();
        }
    });
</script>

<script>
    // Funzione per caricare gli eventi dal database
    async function loadEvents() {
        try {
            const response = await fetch('get_events.php');
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || 'Errore nel caricamento');
            }

            const eventsGrid = document.getElementById('eventiGrid');
            eventsGrid.innerHTML = '';

            if (result.count === 0) {
                eventsGrid.innerHTML = '<p class="no-events">Nessun evento in programma</p>';
                return;
            }

            result.data.forEach(event => {
                const eventCard = createEventCard(event);
                eventsGrid.appendChild(eventCard);
            });

        } catch (error) {
            console.error('Errore:', error);
            document.getElementById('eventiGrid').innerHTML = `
            <div class="error-message">
                <p>Si √® verificato un errore nel caricamento degli eventi</p>
                <button onclick="loadEvents()">Riprova</button>
            </div>
        `;
        }
    }

    function createEventCard(event) {
        const card = document.createElement('article');
        card.className = 'card';

        // Gestione immagine con fallback
        let imageSrc = 'https://picsum.photos/400/250?random=event';
        if (event.immagine) {
            if (event.immagine.startsWith('data:image')) {
                imageSrc = event.immagine; // Base64 image
            } else if (event.immagine.startsWith('http')) {
                imageSrc = event.immagine; // URL image
            }
        }

        card.innerHTML = `
        <div class="card-image-container">
            <img src="${imageSrc}" alt="${event.titolo}" class="card-image" loading="lazy">
        </div>
        <div class="card-content">
            <h3>${event.titolo}</h3>
            <p class="card-info">
                <b>Data:</b> ${formatDate(event.datainizio)}
                ${event.durata ? '<br><b>Orario:</b> ' + event.durata : ''}
                <br>
                <b>Relatore:</b> ${event.relatore || 'Non specificato'}
            </p>
            <p>${event.descrizione || ''}</p>
            <p class="card-info"><b>Posti disponibili:</b>
                <span class="posti-disponibili">${event.posti_disponibili}</span>
            </p>
            <div class="card-actions">
                <a href="evento.html?id=${event.idevento}" class="card-btn card-btn-secondary">Dettagli</a>
                <button class="card-btn card-btn-primary btn-prenota-rapido"
                        data-event-id="${event.idevento}"
                        ${event.posti_disponibili <= 0 || !event.flagprenotabile ? 'disabled' : ''}>
                    ${event.posti_disponibili <= 0 ? 'Esaurito' : 'Prenota'}
                </button>
            </div>
        </div>
    `;

        return card;
    }

    // Funzioni di utilit√† per formattare data e ora
    function formatDate(dateString) {
        const options = { day: 'numeric', month: 'long', year: 'numeric' };
        return new Date(dateString).toLocaleDateString('it-IT', options);
    }

    function formatTime(timeString) {
        return `<b>Orario:</b> ${timeString}`;
    }

    // Carica gli eventi al caricamento della pagina
    document.addEventListener('DOMContentLoaded', loadEvents);
</script>
</body>
</html>
