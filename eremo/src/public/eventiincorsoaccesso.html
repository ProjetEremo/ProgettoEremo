<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Calendario Attivit√† - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Stili popup e spinner (dal tuo style.css o qui) */
        .booking-popup-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 1050; opacity: 0;
            transition: opacity 0.3s ease-in-out; backdrop-filter: blur(5px);
        }
        .booking-popup-overlay.active { display: block; opacity: 1; }
        .booking-popup {
            display: none; position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95); width: 90%; max-width: 550px;
            max-height: 90vh; overflow-y: auto; background: var(--white);
            border-radius: var(--border-radius-medium); padding: 2rem;
            box-shadow: var(--shadow-medium); z-index: 1051; opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .booking-popup.active { display: block; opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .booking-popup h2 {
            color: var(--primary); margin-top: 0; margin-bottom: 1.5rem;
            text-align: center; font-size: 1.8rem;
        }
        .booking-popup .form-group { margin-bottom: 1rem; }
        .booking-popup .form-group label {
            display: block; margin-bottom: 0.5rem; color: var(--primary); font-weight: 500; font-size: 0.95rem;
        }
        .booking-popup .form-control {
            width: 100%; padding: 0.7rem 1rem; border: 1px solid var(--gray-medium);
            border-radius: 8px; font-size: 1rem; background-color: var(--white);
        }
        .booking-popup .form-control:focus {
            border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(141, 177, 135, 0.3); outline: none;
        }
        .participant-fields-container { margin-top: 1rem; margin-bottom: 1rem; max-height: 200px; overflow-y: auto; padding-right: 5px; }
        .participant-fields-container .participant-entry { padding-bottom: 1rem; margin-bottom: 1rem; border-bottom: 1px dotted var(--gray-light); }
        .participant-fields-container .participant-entry:last-child { border-bottom: none; margin-bottom: 0; }
        .participant-fields-container .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem; align-items: center; }
        .participant-fields-container .form-grid label { font-size: 0.9rem; margin-bottom: 0.2rem; }
        .booking-popup .form-actions { margin-top: 1.5rem; text-align: right; }
        .booking-popup .btn-popup {
            padding: 0.7rem 1.5rem; border-radius: 50px; border: none; font-weight: 500; cursor: pointer;
            background: var(--secondary); color: white; transition: var(--transition-medium);
        }
        .booking-popup .btn-popup:hover { background: var(--primary); }
        .booking-popup .close-popup {
            position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.8rem;
            font-weight: bold; line-height: 1; color: var(--gray-medium); cursor: pointer; padding: 0.25rem;
            transition: var(--transition-fast);
        }
        .booking-popup .close-popup:hover { color: var(--dark); transform: rotate(90deg) scale(1.1); }
        #bookingResponseMessage {
            margin-top: 1rem; padding: 0.8rem 1rem; border-radius: 8px; font-size: 0.95rem;
            text-align: center; display: none;
        }
        #bookingResponseMessage.success {
            background-color: rgba(46, 204, 113, 0.15); border: 1px solid var(--success); color: var(--dark);
        }
        #bookingResponseMessage.error {
            background-color: rgba(231, 76, 60, 0.15); border: 1px solid var(--danger); color: var(--dark);
        }
        /* .spinner-mini √® definito in style.css principale */
    </style>
</head>
<body id="pageBody"> <header class="navbar-container" id="navbarContainer"> <nav class="navbar">
    <a href="indexaccesso.html" style="text-decoration: none; color: inherit;">
        <div class="logo">
            <span class="emoji">üèîÔ∏è</span>
            <h2>Eremo Frate Francesco</h2>
        </div>
    </a>
    <div class="menu">
        <a href="eventiincorsoaccesso.html" class="active">Calendario attivit√†</a>
        <a href="eventipassatiaccesso.html">Archivio attivit√†</a>
        <span class="separator">|</span>
        <a href="incontrisullaparolaaccesso.html">Incontri sulla parola</a>
        <span class="separator">|</span>
        <a href="dovesiamoaccesso.html">Dove siamo</a> <a href="contattiaccesso.html">Contatti</a>
    </div>

<header class="navbar-container" id="navbarContainer">
    <nav class="navbar">
        <a href="indexaccesso.html" style="text-decoration: none; color: inherit;">
            <div class="logo">
                <span class="emoji">üèîÔ∏è</span>
                <h2>Eremo Frate Francesco</h2>
            </div>
        </a>
        <div class="menu">
            <a href="eventiincorsoaccesso.html" class="active">Calendario attivit√†</a>
            <a href="eventipassatiaccesso.html">Archivio attivit√†</a>
            <span class="separator">|</span>
            <a href="incontrisullaparolaaccesso.html">Incontri sulla parola</a>
            <span class="separator">|</span>
            <a href="dovesiamoaccesso.html">Dove siamo</a> <a href="contattiaccesso.html">Contatti</a>
        </div>
        <div class="right-menu">
            <div class="user-dropdown" id="userDropdownContainer">
                <button class="user-btn" aria-haspopup="true" aria-expanded="false">
                    <span class="user-avatar" id="navbar-avatar">üë§</span>
                    <span class="user-name" id="navbar-username">Utente</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
                    <a href="areapersonale.html" class="dropdown-item">Il mio profilo</a>
                    <a href="gestisciprenotazioni.html" class="dropdown-item">Le mie prenotazioni</a>
                    <a href="#" id="logout-link-dropdown-eventi">Esci</a>
                </div>
            </div>
            <button class="hamburger" aria-label="Toggle menu">‚ò∞</button>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="eventiincorsoaccesso.html" onclick="closeMobileMenu()">Calendario attivit√†</a>
        <a href="eventipassatiaccesso.html" onclick="closeMobileMenu()">Archivio attivit√†</a>
        <a href="incontrisullaparolaaccesso.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
        <a href="dovesiamoaccesso.html" onclick="closeMobileMenu()">Dove siamo</a>
        <a href="contattiaccesso.html" onclick="closeMobileMenu()">Contatti</a>
        <hr style="border-color: rgba(255,255,255,0.1);">
        <a href="areapersonale.html" onclick="closeMobileMenu()">Il mio profilo</a>
        <a href="gestisciprenotazioni.html" onclick="closeMobileMenu()">Le mie prenotazioni</a>
        <a href="#" id="logout-link-mobile-eventi" onclick="closeMobileMenu()">Esci</a>
    </div>
</header>
<main>
    <div class="container section-padding">
        <h1>Calendario Attivit√†</h1>
        <div id="eventiGridContainer">
            <div id="loadingIndicator" class="loading-overlay">
                <div class="spinner"> <div class="bounce1"></div> <div class="bounce2"></div> <div class="bounce3"></div> </div>
                <p>Sto caricando gli eventi...</p>
            </div>
            <div class="card-grid" id="eventiGrid">
            </div>
        </div>
    </div>
</main>

<footer>
    <p>&copy; <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati.</p>
</footer>

<div class="booking-popup-overlay" id="bookingPopupOverlay"></div>
<div class="booking-popup" id="bookingPopup">
    <button class="close-popup" id="closeBookingPopupBtn" aria-label="Chiudi popup">&times;</button>
    <h2 id="bookingPopupTitle">Prenota Evento</h2>
    <form id="bookingForm">
        <input type="hidden" id="bookingEventId" name="eventId">
        <div class="form-group">
            <label for="numeroPosti">Numero Partecipanti (max 5)</label>
            <input type="number" id="numeroPosti" name="numeroPosti" class="form-control" min="1" max="5" value="1" required>
        </div>
        <div id="participantFieldsContainer" class="participant-fields-container">
        </div>
        <div id="bookingResponseMessage" class="form-message" style="display:none;"></div>
        <div class="form-actions">
            <button type="submit" class="btn-popup">Conferma Prenotazione</button>
        </div>
    </form>
</div>

<script>
    // --- SCRIPT GLOBALI PER PAGINE ACCESSO (da includere o replicare) ---
    let currentUser = null;

    function updateNavbarUserUI() {
        const navbarUsernameEl = document.getElementById('navbar-username');
        const navbarAvatarEl = document.getElementById('navbar-avatar');
        if (!navbarUsernameEl || !navbarAvatarEl) return;

        if (currentUser) {
            let displayName = 'Utente';
            if (currentUser.nome && currentUser.nome.trim() !== '') {
                displayName = currentUser.nome;
            } else if (currentUser.email) {
                displayName = currentUser.email.split('@')[0];
            }
            navbarUsernameEl.textContent = displayName;
            if (currentUser.avatar) navbarAvatarEl.textContent = currentUser.avatar;
        } else {
            navbarUsernameEl.textContent = 'Utente';
            navbarAvatarEl.textContent = 'üë§';
        }
    }

    function handleLogout() {
        localStorage.removeItem('userDataEFF');
        currentUser = null;
        alert('Logout effettuato.');
        window.location.href = 'index.html';
    }

    function setupUserSessionAndNavbar() {
        const userDataString = localStorage.getItem('userDataEFF');
        if (userDataString) {
            try {
                currentUser = JSON.parse(userDataString);
                if (!currentUser || !currentUser.email) {
                    currentUser = null;
                    localStorage.removeItem('userDataEFF');
                }
            } catch (e) {
                currentUser = null;
                localStorage.removeItem('userDataEFF');
            }
        } else {
            currentUser = null;
        }
        updateNavbarUserUI();

        const logoutLinkDropdown = document.getElementById('logout-link-dropdown-eventi');
        const logoutLinkMobile = document.getElementById('logout-link-mobile-eventi');
        if (logoutLinkDropdown) logoutLinkDropdown.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
        if (logoutLinkMobile) logoutLinkMobile.addEventListener('click', (e) => {
            e.preventDefault();
            if(typeof closeMobileMenu === 'function') closeMobileMenu();
            handleLogout();
        });
    }

    let lastScroll = 0;
    const navbarContainer = document.getElementById('navbarContainer');
    if (navbarContainer) {
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            if (currentScroll <= 50) { navbarContainer.classList.remove('hidden'); lastScroll = 0; return; }
            if (currentScroll > lastScroll && !navbarContainer.classList.contains('hidden')) {
                navbarContainer.classList.add('hidden');
            } else if (currentScroll < lastScroll && navbarContainer.classList.contains('hidden')) {
                navbarContainer.classList.remove('hidden');
            }
            lastScroll = currentScroll;
        });
    }

    const userDropdownButton = document.querySelector('#userDropdownContainer .user-btn');
    const userDropdownMenu = document.querySelector('#userDropdownContainer .dropdown-menu');
    if (userDropdownButton && userDropdownMenu) {
        userDropdownButton.addEventListener('click', function(event) {
            event.stopPropagation();
            const isCurrentlyOpen = userDropdownMenu.style.display === 'block';
            userDropdownMenu.style.display = isCurrentlyOpen ? 'none' : 'block';
            this.setAttribute('aria-expanded', String(!isCurrentlyOpen));
        });
    }
    document.addEventListener('click', function(event) {
        if (userDropdownMenu && userDropdownMenu.style.display === 'block') {
            if (userDropdownButton && !userDropdownButton.contains(event.target) && !userDropdownMenu.contains(event.target)) {
                userDropdownMenu.style.display = 'none';
                if (userDropdownButton) userDropdownButton.setAttribute('aria-expanded', 'false');
            }
        }
    });

    const mobileMenu = document.getElementById("mobileMenu");
    const hamburger = document.querySelector(".navbar .hamburger");
    if (hamburger) hamburger.addEventListener('click', toggleMobileMenu);
    function toggleMobileMenu() {
        if (mobileMenu && hamburger) {
            const isOpen = mobileMenu.classList.toggle("open");
            hamburger.classList.toggle("open");
            hamburger.setAttribute("aria-expanded", isOpen.toString());
            document.body.style.overflow = isOpen ? 'hidden' : '';
        }
    }
    function closeMobileMenu() {
        if (mobileMenu && hamburger) {
            mobileMenu.classList.remove("open");
            if (hamburger.classList.contains("open")) { hamburger.classList.remove("open"); hamburger.setAttribute("aria-expanded", "false");}
            document.body.style.overflow = '';
        }
    }
    document.addEventListener('click', function(event) {
        if (mobileMenu && mobileMenu.classList.contains('open')) {
            if (!mobileMenu.contains(event.target) && hamburger && !hamburger.contains(event.target)) {
                closeMobileMenu();
            }
        }
    });
    // --- FINE SCRIPT GLOBALI ---

    // --- LOGICA SPECIFICA DELLA PAGINA EVENTIINCORSACCESSO ---
    document.addEventListener('DOMContentLoaded', () => {
        setupUserSessionAndNavbar(); // Imposta currentUser e UI navbar PRIMA di ogni altra logica

        if (!currentUser || !currentUser.email) { // Controllo se l'utente √® effettivamente loggato
            console.log("Utente non loggato o email mancante in eventiincorsoaccesso.html. Reindirizzamento.");
            // Non mostrare l'alert qui, il reindirizzamento √® sufficiente
            window.location.href = 'index.html'; // Reindirizza alla pagina di login/home pubblica
            return; // Interrompe l'esecuzione ulteriore se non loggato
        }

        // Se l'utente √® loggato, procedi:
        loadEvents();
        initializeBookingPopupHandlers();

        const currentYearEl = document.getElementById('currentYear');
        if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();
    });

    function initializeBookingPopupHandlers() {
        const bookingPopupOverlay = document.getElementById('bookingPopupOverlay');
        const bookingPopup = document.getElementById('bookingPopup');
        const closeBookingPopupBtn = document.getElementById('closeBookingPopupBtn');
        const bookingForm = document.getElementById('bookingForm');
        const numeroPostiInput = document.getElementById('numeroPosti');
        const participantFieldsContainer = document.getElementById('participantFieldsContainer');
        const bookingEventIdInput = document.getElementById('bookingEventId');
        const bookingPopupTitle = document.getElementById('bookingPopupTitle');
        const bookingResponseMessage = document.getElementById('bookingResponseMessage');

        window.openBookingPopup = function(eventId, eventTitle, postiDisponibiliEvento) {
            if (!currentUser) { // Questo controllo ora dovrebbe essere ridondante ma lo lascio per sicurezza
                alert("Sessione scaduta o utente non valido. Effettua nuovamente il login.");
                window.location.href = 'index.html'; return;
            }
            bookingEventIdInput.value = eventId;
            bookingPopupTitle.textContent = `Prenota: ${eventTitle}`;

            const postiDisponibiliNum = parseInt(postiDisponibiliEvento);
            const maxPostiEffettivi = Math.min(5, postiDisponibiliNum);

            if (isNaN(postiDisponibiliNum) || postiDisponibiliNum < 1 || maxPostiEffettivi < 1) {
                alert("Spiacenti, non ci sono pi√π posti disponibili per questo evento o l'evento non √® prenotabile.");
                return;
            }
            numeroPostiInput.max = maxPostiEffettivi;
            numeroPostiInput.value = 1;

            generateParticipantFields(1);
            bookingResponseMessage.style.display = 'none';
            bookingResponseMessage.textContent = '';
            bookingResponseMessage.className = 'form-message';

            bookingPopupOverlay.classList.add('active');
            bookingPopup.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeBookingPopup() {
            if (bookingPopupOverlay) bookingPopupOverlay.classList.remove('active');
            if (bookingPopup) bookingPopup.classList.remove('active');
            document.body.style.overflow = '';
            if(participantFieldsContainer) participantFieldsContainer.innerHTML = '';
            if(bookingForm) bookingForm.reset();
        }

        if (closeBookingPopupBtn) closeBookingPopupBtn.addEventListener('click', closeBookingPopup);
        if (bookingPopupOverlay) bookingPopupOverlay.addEventListener('click', (e) => {
            if (e.target === bookingPopupOverlay) closeBookingPopup();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && bookingPopup && bookingPopup.classList.contains('active')) {
                closeBookingPopup();
            }
        });

        function generateParticipantFields(count) {
            if (!participantFieldsContainer || !numeroPostiInput) return;
            participantFieldsContainer.innerHTML = '';
            const maxAllowed = parseInt(numeroPostiInput.max);
            let validCount = parseInt(count);

            if (isNaN(validCount) || validCount < 1) validCount = 1;
            if (validCount > maxAllowed) validCount = maxAllowed;

            if (numeroPostiInput.value != validCount) numeroPostiInput.value = validCount;

            if (validCount > 0) {
                for (let i = 1; i <= validCount; i++) {
                    const fieldSet = document.createElement('div');
                    fieldSet.className = 'participant-entry';
                    fieldSet.innerHTML = `
                        <p style="margin-bottom: 0.5rem; font-weight: 500; color: var(--dark);">Partecipante ${i}:</p>
                        <div class="form-grid">
                            <div>
                                <label for="participant_nome_${i}">Nome*</label>
                                <input type="text" id="participant_nome_${i}" name="participant_nome[]" class="form-control" required>
                            </div>
                            <div>
                                <label for="participant_cognome_${i}">Cognome*</label>
                                <input type="text" id="participant_cognome_${i}" name="participant_cognome[]" class="form-control" required>
                            </div>
                        </div>
                    `;
                    participantFieldsContainer.appendChild(fieldSet);
                }
            }
        }

        if (numeroPostiInput) {
            numeroPostiInput.addEventListener('input', (e) => {
                generateParticipantFields(e.target.value);
            });
            // Non chiamare generateParticipantFields qui, verr√† fatto dal listener o da openBookingPopup
        }

        if (bookingForm) {
            bookingForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                if (!currentUser || !currentUser.email) {
                    alert("Errore: sessione utente non valida. Effettua nuovamente il login.");
                    window.location.href = 'index.html'; return;
                }

                const submitBtn = this.querySelector('button[type="submit"]');
                const originalBtnText = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner-mini"></div> Elaborazione...';
                if(bookingResponseMessage) bookingResponseMessage.style.display = 'none';

                const formData = new FormData();
                formData.append('eventId', bookingEventIdInput.value);
                formData.append('numeroPosti', numeroPostiInput.value);
                formData.append('contatto', currentUser.email);

                const nomi = participantFieldsContainer.querySelectorAll('input[name="participant_nome[]"]');
                const cognomi = participantFieldsContainer.querySelectorAll('input[name="participant_cognome[]"]');
                let formIsValid = true;

                if (nomi.length !== parseInt(numeroPostiInput.value)) {
                    formIsValid = false;
                    if(bookingResponseMessage) bookingResponseMessage.textContent = 'Errore: il numero di partecipanti non corrisponde ai campi compilati.';
                } else {
                    for (let i = 0; i < nomi.length; i++) {
                        if (nomi[i].value.trim() === '' || cognomi[i].value.trim() === '') {
                            formIsValid = false;
                            if(bookingResponseMessage) bookingResponseMessage.textContent = 'Nome e cognome sono obbligatori per tutti i partecipanti.';
                            break;
                        }
                        formData.append('partecipanti_nomi[]', nomi[i].value.trim());
                        formData.append('partecipanti_cognomi[]', cognomi[i].value.trim());
                    }
                }

                if (!formIsValid) {
                    if(bookingResponseMessage) {
                        bookingResponseMessage.className = 'form-message error';
                        bookingResponseMessage.style.display = 'block';
                    }
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                    return;
                }

                try {
                    const response = await fetch('prenota_evento.php', { method: 'POST', body: formData });
                    const responseText = await response.text();
                    let result;
                    try { result = JSON.parse(responseText); }
                    catch (error) { throw new Error("Risposta del server non valida: " + responseText.substring(0,100)); }

                    if (result.success) {
                        if(bookingResponseMessage) {
                            bookingResponseMessage.textContent = result.message || 'Prenotazione confermata!';
                            bookingResponseMessage.className = 'form-message success';
                        }
                        loadEvents();
                        setTimeout(closeBookingPopup, 3000);
                    } else {
                        throw new Error(result.message || 'Errore durante la prenotazione.');
                    }
                } catch (error) {
                    if(bookingResponseMessage) bookingResponseMessage.textContent = `Errore: ${error.message}`;
                    if(bookingResponseMessage) bookingResponseMessage.className = 'form-message error';
                } finally {
                    if(bookingResponseMessage) bookingResponseMessage.style.display = 'block';
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalBtnText;
                }
            });
        }
    }

    async function loadEvents() {
        const eventsGrid = document.getElementById('eventiGrid');
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) loadingIndicator.classList.add('visible');
        if (eventsGrid) eventsGrid.innerHTML = '';

        try {
            const response = await fetch('get_events.php');
            if (!response.ok) throw new Error(`Errore HTTP: ${response.status}`);
            const result = await response.json();
            if (!result.success) throw new Error(result.message || 'Errore caricamento dati eventi.');
            if (!eventsGrid) return;

            if (result.data && result.data.length > 0) {
                result.data.forEach(event => eventsGrid.appendChild(createEventCard(event)));
            } else {
                eventsGrid.innerHTML = '<p class="no-events" style="text-align:center; padding:20px;">Nessun evento in programma al momento.</p>';
            }
        } catch (error) {
            if (eventsGrid) eventsGrid.innerHTML = `<p class="no-events error-message" style="text-align:center; padding:20px;">Errore caricamento eventi: ${error.message} <button onclick="loadEvents()" class="btn-popup" style="margin-top:10px;">Riprova</button></p>`;
        } finally {
            if (loadingIndicator) loadingIndicator.classList.remove('visible');
        }
    }

    function createEventCard(event) {
        const card = document.createElement('article');
        card.className = 'card';
        let imageSrc = (event.immagine_url && event.immagine_url.trim() !== '') ? event.immagine_url : 'images/default-event.jpg';

        card.innerHTML = `
            <div class="card-image-container">
                <img src="${imageSrc}" alt="Copertina: ${event.titolo || 'Evento'}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
            </div>
            <div class="card-content">
                <h3>${event.titolo || 'Titolo non disponibile'}</h3>
                <p class="card-info">
                    <b>Data:</b> ${event.datainizio ? formatDate(event.datainizio) : 'Da definire'}
                    ${event.durata ? `<br><b>Orario:</b> ${event.durata}` : ''}
                </p>
                <p class="card-info">
                    <b>${event.prefisso_relatore || 'Relatore'}:</b> ${event.relatore || 'Non specificato'}
                    ${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}` : ''}
                </p>
                <p class="card-description">${event.descrizione || 'Nessuna descrizione breve.'}</p>
                <p class="card-info">
                    <b>Posti Disponibili:</b> <span class="posti-disponibili">${event.posti_disponibili !== null ? event.posti_disponibili : 'N/D'}</span>
                    ${event.costo !== null ? (parseFloat(event.costo) > 0 ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨` : (parseFloat(event.costo) === 0 ? '<br><b>Costo:</b> Offerta libera' : '')) : ''}
                </p>
                <div class="card-actions">
                    <a href="evento_dettaglio_accesso.html?id=${event.idevento}" class="card-btn card-btn-secondary">Dettagli</a>
                    <button class="card-btn card-btn-primary btn-prenota"
                            data-event-id="${event.idevento}"
                            data-event-title="${event.titolo || 'Evento senza titolo'}"
                            data-posti-disponibili="${event.posti_disponibili !== null ? event.posti_disponibili : '0'}"
                            ${parseInt(event.posti_disponibili) === 0 || !event.flagprenotabile ? 'disabled' : ''}>
                        ${!event.flagprenotabile ? 'Non Prenotabile' : (parseInt(event.posti_disponibili) === 0 ? 'Esaurito' : 'Prenota')}
                    </button>
                </div>
            </div>
        `;
        const prenotaBtn = card.querySelector('.btn-prenota');
        if (prenotaBtn && event.flagprenotabile && parseInt(event.posti_disponibili) > 0) {
            prenotaBtn.addEventListener('click', function() {
                const eventId = this.dataset.eventId;
                const eventTitle = this.dataset.eventTitle;
                const postiDisponibiliEvento = parseInt(this.dataset.postiDisponibili);
                if(typeof window.openBookingPopup === 'function') {
                    window.openBookingPopup(eventId, eventTitle, postiDisponibiliEvento);
                }
            });
        }
        return card;
    }

    function formatDate(dateString) {
        if (!dateString) return 'Data non disponibile';
        try {
            const date = new Date(dateString.replace(/-/g, '/'));
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric'});
        } catch (e) { return dateString; }
    }
</script>
</body>
</html>