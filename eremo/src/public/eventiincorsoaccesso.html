<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .navbar-container {
            position: fixed;
            top: 0;
            width: 100%;
            transition: transform 0.3s ease;
            z-index: 1000;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-container.hidden {
            transform: translateY(-100%);
        }
        body {
            padding-top: 80px;
        }
    </style>
</head>
<body>

<header>
    <div class="navbar-container" id="navbarContainer">
        <div class="navbar">
            <a href="indexaccesso.html" style="text-decoration: none; color: inherit">
                <div class="logo">
                    <span class="emoji">üèîÔ∏è</span>
                    <h2>Eremo Frate Francesco</h2>
                </div>
            </a>
            <div class="menu">
                <a href="chi-siamo.html">Chi siamo</a>
                <span class="separator">|</span>
                <a href="eventiincorsoaccesso.html" class="active">Calendario attivit√°</a>
                <a href="eventipassatiaccesso.html">Archivio attivit√°</a>
                <span class="separator">|</span>
                <a href="incontrisullaparolaaccesso.html">Incontri sulla parola</a>
                <span class="separator">|</span>
                <a href="">Dove siamo</a>
                <a href="contattiaccesso.html">Contatti</a>
            </div>

            <div class="right-menu">
                <div class="user-dropdown" onclick="toggleUserMenu()">
                    <button class="user-btn">
                        <span class="user-avatar">üò∫</span>
                        <span class="user-name">Area Personale</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    <div class="dropdown-menu">
                        <a href="areapersonale.html" class="dropdown-item">Il mio profilo</a>
                        <a href="gestisciprenotazioni.html" class="dropdown-item">Le mie prenotazioni</a>
                        <a href="logout.html" class="dropdown-item">Esci</a>
                    </div>
                </div>
                <button class="hamburger" onclick="toggleMenu()">‚ò∞</button>
            </div>
        </div>
    </div>

    <script>
        function toggleUserMenu() {
            const dropdown = document.querySelector('.user-dropdown');
            dropdown.classList.toggle('show');
        }

        // Chiudi il dropdown se si clicca fuori
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.user-dropdown');
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
</header>

    <script>
        let lastScroll = 0;
        const navbar = document.getElementById('navbarContainer');
        
        window.addEventListener('scroll', () => {
            const currentScroll = window.pageYOffset;
            
            if (currentScroll <= 0) {
                navbar.classList.remove('hidden');
                return;
            }
            
            if (currentScroll > lastScroll) {
                navbar.classList.add('hidden');
            } else {
                navbar.classList.remove('hidden');
            }
            
            lastScroll = currentScroll;
        });

        function toggleMenu() {
            const menu = document.getElementById("mobileMenu");
            const button = document.querySelector(".hamburger");
            const isOpen = menu.classList.toggle("open");
            button.classList.toggle("open");
            button.setAttribute("aria-expanded", isOpen);
        }

        function closeMenu() {
            document.getElementById("mobileMenu").classList.remove("open");
            document.querySelector(".hamburger").classList.remove("open");
            document.querySelector(".hamburger").setAttribute("aria-expanded", "false");
        }
    </script>

<div class="container section-padding"> <h1 class="text-center mb-4">Calendario Attivit√†</h1>

    <div id="eventiGridContainer">
        <div id="loadingIndicator" class="loading-overlay"> <div class="spinner">
            <div class="bounce1"></div>
            <div class="bounce2"></div>
            <div class="bounce3"></div>
        </div>
            <p>Sto caricando gli eventi...</p>
        </div>

        <div class="card-grid" id="eventiGrid">
        </div>
    </div>

</div>

<footer>
    <p>&copy; 2025 Eremo Frate Francesco. Tutti i diritti riservati.</p>
</footer>

<script>
    // --- Funzioni Utilit√† Generali ---
    function gebi(id) { return document.getElementById(id); } // Shorthand

    // --- Navbar & Mobile Menu Logic ---
    let lastScrollNav = 0;
    const navbarContainerEl = gebi('navbarContainer');
    if (navbarContainerEl) {
        window.addEventListener('scroll', function() {
            const currentScroll = window.pageYOffset;
            if (currentScroll <= 50) { // Leggera tolleranza per lo scroll iniziale
                navbarContainerEl.classList.remove('scroll-up', 'scroll-down');
                return;
            }
            if (currentScroll > lastScrollNav && !navbarContainerEl.classList.contains('scroll-down')) {
                navbarContainerEl.classList.remove('scroll-up');
                navbarContainerEl.classList.add('scroll-down');
            } else if (currentScroll < lastScrollNav && navbarContainerEl.classList.contains('scroll-down')) {
                navbarContainerEl.classList.remove('scroll-down');
                navbarContainerEl.classList.add('scroll-up');
            }
            lastScrollNav = currentScroll;
        });
    }

    const mobileMenuEl = gebi("mobileMenu");
    const hamburgerEl = document.querySelector(".hamburger");

    function toggleMobileMenu() {
        if (mobileMenuEl && hamburgerEl) {
            const isActive = mobileMenuEl.classList.toggle("active");
            hamburgerEl.classList.toggle("active");
            document.body.style.overflow = isActive ? 'hidden' : '';
        }
    }

    function closeMobileMenu() {
        if (mobileMenuEl && hamburgerEl) {
            mobileMenuEl.classList.remove("active");
            hamburgerEl.classList.remove("active");
            document.body.style.overflow = '';
        }
    }

    // --- Login Popup Logic ---
    const loginOverlay = gebi('loginOverlay');
    const loginPopup = gebi('loginPopup');
    const closePopupBtn = gebi('closePopup');
    const loginTabs = document.querySelectorAll('.login-tab');
    const loginForms = document.querySelectorAll('.login-form');
    const loginBtnMobile = gebi('login-btn-mobile');

    function openLoginPopup() {
        if (loginOverlay && loginPopup) {
            loginOverlay.classList.add('active');
            loginPopup.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeLoginPopup() {
        if (loginOverlay && loginPopup) {
            loginOverlay.classList.remove('active');
            loginPopup.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    if (loginBtnMobile) {
        loginBtnMobile.addEventListener('click', function(e) {
            e.preventDefault();
            openLoginPopup();
            closeMobileMenu();
        });
    }

    if (closePopupBtn) closePopupBtn.addEventListener('click', closeLoginPopup);
    if (loginOverlay) loginOverlay.addEventListener('click', closeLoginPopup);

    loginTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            loginTabs.forEach(t => t.classList.remove('active'));
            loginForms.forEach(f => f.classList.remove('active'));
            this.classList.add('active');
            const targetFormId = this.getAttribute('data-tab') === 'login' ? 'loginForm' : 'registerForm';
            const targetForm = gebi(targetFormId);
            if (targetForm) targetForm.classList.add('active');
        });
    });

    // --- User Dropdown Logic ---
    function toggleUserMenu() {
        const dropdown = document.querySelector('.user-dropdown');
        if (dropdown) {
            const userBtn = dropdown.querySelector('.user-btn');
            const isOpen = dropdown.classList.toggle('show');
            if (userBtn) userBtn.setAttribute('aria-expanded', isOpen.toString());
        }
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.querySelector('.user-dropdown');
        if (dropdown && !dropdown.contains(event.target)) {
            dropdown.classList.remove('show');
            const userBtn = dropdown.querySelector('.user-btn');
            if (userBtn) userBtn.setAttribute('aria-expanded', 'false');
        }
    });

    // --- Logica Utente (Simulata per ora) ---
    let currentUser = null;

    function updateNavbarUserUI() {
        const navbarAvatar = gebi('navbar-avatar');
        const navbarUsername = gebi('navbar-username');
        const userDropdownContainer = gebi('userDropdownContainer');
        // Non c'√® un bottone login standard nell'header in questo HTML, solo nel menu mobile
        const loginBtnMobileEl = gebi('login-btn-mobile');

        if (currentUser && navbarAvatar && navbarUsername && userDropdownContainer) {
            navbarAvatar.textContent = currentUser.avatar || 'üë§';
            navbarUsername.textContent = currentUser.nome || 'Utente';
            userDropdownContainer.style.display = 'inline-block';
            if (loginBtnMobileEl) loginBtnMobileEl.style.display = 'none';
        } else if (userDropdownContainer) {
            userDropdownContainer.style.display = 'none';
            if (loginBtnMobileEl) loginBtnMobileEl.style.display = 'block';
        }
    }

    gebi('loginForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        // SIMULAZIONE LOGIN:
        currentUser = { nome: gebi('login-email-popup').value.split('@')[0] || "Utente", avatar: "üßò" }; // Semplificato
        localStorage.setItem('userDataEFF', JSON.stringify(currentUser));
        updateNavbarUserUI();
        alert('Login effettuato con successo!');
        closeLoginPopup();

        const pendingEventId = localStorage.getItem('pending_booking_event_id_eff');
        if (pendingEventId) {
            if(confirm(`Login effettuato. Vuoi completare la prenotazione per l'evento precedentemente selezionato?`)) {
                alert(`Prenotazione per evento ${pendingEventId} da completare (simulato).`);
            }
            localStorage.removeItem('pending_booking_event_id_eff');
        }
    });

    gebi('registerForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        // SIMULAZIONE REGISTRAZIONE E LOGIN:
        currentUser = { nome: gebi('register-name').value || "Nuovo Utente", avatar: "üë§" }; // Semplificato
        localStorage.setItem('userDataEFF', JSON.stringify(currentUser));
        updateNavbarUserUI();
        alert('Registrazione effettuata con successo! Ora sei loggato.');
        closeLoginPopup();
    });

    function logout() {
        currentUser = null;
        localStorage.removeItem('userDataEFF');
        updateNavbarUserUI();
        alert('Logout effettuato.');
        // Non reindirizzare per default, potrebbe essere una pagina admin
        // window.location.href = 'index.html';
    }

    function checkLoginStatusOnLoad() {
        const storedUserData = localStorage.getItem('userDataEFF');
        if (storedUserData) {
            currentUser = JSON.parse(storedUserData);
        } else {
            currentUser = null;
        }
        updateNavbarUserUI();
    }

    // --- Gestione Pop-up Nuovo Evento ---
    const addEventBtn = gebi('addEventBtn');
    const eventPopupOverlay = gebi('eventPopupOverlay');
    const eventPopup = gebi('eventPopup');
    const closeEventPopupBtn = gebi('closeEventPopup');
    const voluntaryCheckbox = gebi('event-voluntary');
    const priceContainer = gebi('event-price-container');
    const newEventFormMessage = gebi('newEventFormMessage');

    function updatePriceFieldVisibility() {
        if (voluntaryCheckbox && priceContainer) {
            priceContainer.style.display = voluntaryCheckbox.checked ? 'none' : 'block';
            if (voluntaryCheckbox.checked) {
                gebi('event-price').value = ''; // Svuota se volontario
                gebi('event-price').required = false;
            } else {
                gebi('event-price').required = true; // Rendi richiesto se non volontario
            }
        }
    }

    if (voluntaryCheckbox) {
        voluntaryCheckbox.addEventListener('change', updatePriceFieldVisibility);
        updatePriceFieldVisibility(); // Stato iniziale
    }

    if (addEventBtn) {
        addEventBtn.addEventListener('click', function() {
            if (eventPopupOverlay && eventPopup) {
                eventPopupOverlay.classList.add('active');
                eventPopup.classList.add('active');
                document.body.style.overflow = 'hidden';
                newEventFormMessage.style.display = 'none'; // Nascondi messaggi precedenti
                gebi('newEventForm').reset(); // Resetta il form
                updatePriceFieldVisibility(); // Aggiorna visibilit√† prezzo
            }
        });
    }

    function closeEventPopupHandler() {
        if (eventPopupOverlay && eventPopup) {
            eventPopupOverlay.classList.remove('active');
            eventPopup.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    if (closeEventPopupBtn) closeEventPopupBtn.addEventListener('click', closeEventPopupHandler);
    if (eventPopupOverlay) eventPopupOverlay.addEventListener('click', closeEventPopupHandler);

    gebi('newEventForm')?.addEventListener('submit', async function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner-mini" style="width:1em;height:1em;border-width:2px;vertical-align:middle;margin-right:5px;"></div>Salvataggio...';
        newEventFormMessage.style.display = 'none';
        newEventFormMessage.className = 'form-message'; // Reset classi

        try {
            const formData = new FormData(this);
            formData.append('action', 'add_event');

            const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });

            let result;
            try {
                result = await response.json();
            } catch (jsonError) {
                throw new Error(`Errore nella risposta del server (non JSON): ${await response.text()}`);
            }

            if (!response.ok) {
                throw new Error(result.message || `Errore HTTP: ${response.status}`);
            }

            if (result.success) {
                newEventFormMessage.textContent = result.message || 'Evento aggiunto con successo!';
                newEventFormMessage.classList.add('success');
                newEventFormMessage.style.display = 'block';
                this.reset(); // Resetta il form
                updatePriceFieldVisibility();
                loadEvents();
                setTimeout(closeEventPopupHandler, 2000); // Chiudi dopo 2 sec
            } else {
                throw new Error(result.message || 'Errore sconosciuto durante il salvataggio.');
            }
        } catch (error) {
            console.error('Errore invio form nuovo evento:', error);
            newEventFormMessage.textContent = `Errore: ${error.message}`;
            newEventFormMessage.classList.add('error');
            newEventFormMessage.style.display = 'block';
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (eventPopup && eventPopup.classList.contains('active')) closeEventPopupHandler();
            if (loginPopup && loginPopup.classList.contains('active')) closeLoginPopup();
        }
    });

    // --- Logica Caricamento Eventi ---
    async function loadEvents() {
        const eventsGrid = gebi('eventiGrid');
        const loadingIndicator = gebi('loadingIndicator');

        if (loadingIndicator) loadingIndicator.classList.add('visible');
        if (eventsGrid) eventsGrid.innerHTML = '';


        try {
            // await new Promise(resolve => setTimeout(resolve, 1500)); // Simulazione ritardo

            const response = await fetch('get_events.php');

            let result;
            try {
                result = await response.json();
            } catch (jsonError) {
                throw new Error(`Errore nella risposta del server (non JSON): ${await response.text()}`);
            }

            if (!response.ok) {
                throw new Error(result.error || result.message || `Errore HTTP: ${response.status}`);
            }

            if (!result.success) {
                throw new Error(result.error || result.message || 'Errore nel caricamento dei dati degli eventi.');
            }

            if (!eventsGrid) return;

            if (result.count === 0 || !result.data || result.data.length === 0) {
                eventsGrid.innerHTML = '<p class="no-events text-center" style="padding: 20px;">Nessun evento in programma al momento.</p>';
            } else {
                result.data.forEach(event => {
                    const eventCard = createEventCard(event);
                    eventsGrid.appendChild(eventCard);
                });
            }

        } catch (error) {
            console.error('Errore dettagliato durante il caricamento degli eventi:', error);
            if (eventsGrid) {
                eventsGrid.innerHTML = `
          <div class="error-message text-center" style="padding: 20px; width: 100%;">
            <p><strong>Oops! Si √® verificato un errore.</strong></p>
            <p style="font-size:0.9em; color: #e74c3c; margin-top: 5px;">${error.message || 'Impossibile caricare gli eventi.'}</p>
            <button onclick="loadEvents()" class="btn-popup" style="margin-top: 15px;">Riprova Caricamento</button>
          </div>
        `;
            }
        } finally {
            if (loadingIndicator) loadingIndicator.classList.remove('visible');
        }
    }

    function createEventCard(event) {
        const card = document.createElement('article');
        card.className = 'card';

        let imageSrc = 'images/default-event.jpg';
        if (event.immagine && event.immagine.startsWith('data:image')) {
            imageSrc = event.immagine;
        }

        card.innerHTML = `
        <div class="card-image-container">
            <img src="${imageSrc}" alt="Immagine evento ${event.titolo || 'Evento'}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
        </div>
        <div class="card-content">
            <h3>${event.titolo || 'Titolo non disponibile'}</h3>
            <p class="card-info">
                <b>Data:</b> ${event.datainizio ? formatDate(event.datainizio) : 'Da definire'}
                ${event.durata ? `<br><b>Orario:</b> ${event.durata}` : ''}
                <br>
                <b>${event.prefisso_relatore || 'Relatore'}:</b> ${event.relatore || 'Non specificato'}
                ${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}` : ''}
            </p>
            <p class="card-description">${event.descrizione || 'Nessuna descrizione breve.'}</p>
            <p class="card-info">
                <b>Posti:</b>
                <span class="posti-disponibili">${event.posti_disponibili !== null ? event.posti_disponibili : 'N/D'}</span>
                ${event.costo !== null ? (parseFloat(event.costo) > 0 ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨` : (event.costo == 0 && !event.flagprenotabile_per_costo_volontario ? '<br><b>Costo:</b> Offerta libera' : '')) : ''}
            </p>
            <div class="card-actions">
                <a href="evento_dettaglio.html?id=${event.idevento}" class="card-btn card-btn-secondary">Dettagli</a>
                <button class="card-btn card-btn-primary btn-prenota-rapido"
                        data-event-id="${event.idevento}"
                        ${parseInt(event.posti_disponibili) === 0 || !event.flagprenotabile ? 'disabled' : ''}>
                    ${!event.flagprenotabile ? 'Info dettagli' : (parseInt(event.posti_disponibili) === 0 ? 'Esaurito' : 'Prenota')}
                </button>
            </div>
        </div>
    `;
        const prenotaBtn = card.querySelector('.btn-prenota-rapido');
        if (prenotaBtn && event.flagprenotabile) { // Aggiungi listener solo se prenotabile
            prenotaBtn.addEventListener('click', function() {
                handleRapidBooking(this, event.idevento);
            });
        }
        return card;
    }

    function handleRapidBooking(buttonElement, eventId) {
        if (currentUser) {
            console.log(`Tentativo prenotazione evento ${eventId} per utente ${currentUser.nome}`);
            alert(`Prenotazione per evento ${eventId} in elaborazione (simulato).`);
        } else {
            openLoginPopup();
            localStorage.setItem('pending_booking_event_id_eff', eventId);
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'Data non disponibile';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                const parts = dateString.split('-'); // YYYY-MM-DD
                if (parts.length === 3) {
                    const normalizedDate = new Date(parts[0], parseInt(parts[1]) - 1, parts[2]);
                    if (!isNaN(normalizedDate.getTime())) {
                        return normalizedDate.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
                    }
                }
                console.warn("Formato data non riconosciuto per la conversione:", dateString);
                return dateString;
            }
            return date.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric' });
        } catch (e) {
            console.error("Errore formattazione data:", dateString, e);
            return dateString;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        checkLoginStatusOnLoad();
        loadEvents();
    });

</script>
</body>
</html>
