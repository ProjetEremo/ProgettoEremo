<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Calendario Attivit√† (Accesso) - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Questi stili erano specifici in eventiincorsoaccesso.html, li ho spostati qui per chiarezza */
        /* Se navbarContainerEl √® usato globalmente, assicurati che gli stili non entrino in conflitto
           con la logica di hide/show basata su scroll-up/scroll-down.
           La logica di navbar fissa con 'hidden' potrebbe necessitare di revisione
           se si usa ANCHE la logica scroll-up/scroll-down.
           Per ora, mantengo la logica originale di questa pagina per la navbar.
        */
        .navbar-container.fixed-nav { /* Aggiunta una classe per attivarla se necessario via JS */
            position: fixed;
            top: 0;
            width: 100%;
            transition: transform 0.3s ease;
            z-index: 1000;
            background-color: #fff; /* Assicurati che abbia uno sfondo */
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-container.fixed-nav.hidden-scroll { /* Rinominata per evitare conflitto con la classe 'hidden' di Bootstrap o simili */
            transform: translateY(-100%);
        }
        body.body-padding-top { /* Classe da aggiungere al body se la navbar √® fissa */
            padding-top: 80px; /* Altezza approssimativa della navbar */
        }
    </style>
</head>
<body id="pageBody"> <header class="navbar-container" id="navbarContainer"> <nav class="navbar">
    <a href="indexaccesso.html" style="text-decoration: none; color: inherit;">
        <div class="logo">
            <span class="emoji">üèîÔ∏è</span>
            <h2>Eremo Frate Francesco</h2>
        </div>
    </a>
    <div class="menu">
        <a href="chi-siamoaccesso.html">Chi siamo</a> <span class="separator">|</span>
        <a href="eventiincorsoaccesso.html" class="active">Calendario attivit√†</a>
        <a href="eventipassatiaccesso.html">Archivio attivit√†</a>
        <span class="separator">|</span>
        <a href="incontrisullaparolaaccesso.html">Incontri sulla parola</a>
        <span class="separator">|</span>
        <a href="dovesiamoaccesso.html">Dove siamo</a> <a href="contattiaccesso.html">Contatti</a>
    </div>

    <div class="right-menu">
        <div class="user-dropdown" id="userDropdownContainer">
            <button class="user-btn" onclick="toggleUserMenu()" aria-haspopup="true" aria-expanded="false">
                <span class="user-avatar" id="navbar-avatar">üë§</span>
                <span class="user-name" id="navbar-username">Utente</span>
                <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
                <a href="areapersonale.html" class="dropdown-item">Il mio profilo</a>
                <a href="gestisciprenotazioni.html" class="dropdown-item">Le mie prenotazioni</a>
                <a href="#" onclick="logoutAndRedirect()" class="dropdown-item">Esci</a> </div>
        </div>
        <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
    </div>
</nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="chi-siamoaccesso.html" onclick="closeMobileMenu()">Chi siamo</a>
        <a href="eventiincorsoaccesso.html" onclick="closeMobileMenu()">Calendario attivit√†</a>
        <a href="eventipassatiaccesso.html" onclick="closeMobileMenu()">Archivio attivit√†</a>
        <a href="incontrisullaparolaaccesso.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
        <a href="dovesiamoaccesso.html" onclick="closeMobileMenu()">Dove siamo</a>
        <a href="contattiaccesso.html" onclick="closeMobileMenu()">Contatti</a>
        <a href="areapersonale.html" onclick="closeMobileMenu()">Il mio profilo</a>
        <a href="#" onclick="logoutAndRedirect(); closeMobileMenu();">Esci</a>
    </div>
</header>

<main class="container section-padding"> <h1 class="text-center mb-4">Calendario Attivit√†</h1>

    <div id="eventiGridContainer">
        <div id="loadingIndicator" class="loading-overlay">
            <div class="spinner">
                <div class="bounce1"></div>
                <div class="bounce2"></div>
                <div class="bounce3"></div>
            </div>
            <p>Sto caricando gli eventi...</p>
        </div>

        <div class="card-grid" id="eventiGrid">
        </div>
    </div>
</main>

<footer>
    <p>&copy; <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati.</p>
</footer>

<script>
    function gebi(id) { return document.getElementById(id); }

    // --- Navbar Logic (Combinata e Semplificata) ---
    const navbarContainerEl = gebi('navbarContainer');
    let lastScrollGlobal = 0; // Unica variabile per lo scroll
    const bodyEl = gebi('pageBody');

    function handleNavbarScroll() {
        const currentScroll = window.pageYOffset;
        // Logica per nascondere/mostrare su scroll up/down
        if (currentScroll <= 50) {
            navbarContainerEl.classList.remove('scroll-up', 'scroll-down');
            // Se si usa la logica fixed-nav con 'hidden-scroll'
            navbarContainerEl.classList.remove('hidden-scroll');
            return;
        }
        if (currentScroll > lastScrollGlobal && !navbarContainerEl.classList.contains('scroll-down')) {
            navbarContainerEl.classList.remove('scroll-up');
            navbarContainerEl.classList.add('scroll-down');
            // Se si usa la logica fixed-nav con 'hidden-scroll'
            // navbarContainerEl.classList.add('hidden-scroll');
        } else if (currentScroll < lastScrollGlobal && navbarContainerEl.classList.contains('scroll-down')) {
            navbarContainerEl.classList.remove('scroll-down');
            navbarContainerEl.classList.add('scroll-up');
            // Se si usa la logica fixed-nav con 'hidden-scroll'
            // navbarContainerEl.classList.remove('hidden-scroll');
        }
        lastScrollGlobal = currentScroll;
    }

    // Decidi quale logica di scroll per la navbar usare.
    // Se la navbar deve essere *sempre* fissa e nascondersi solo su scroll down:
    // navbarContainerEl.classList.add('fixed-nav');
    // bodyEl.classList.add('body-padding-top');
    // window.addEventListener('scroll', function() { // Sostituisci con la logica specifica 'hidden-scroll' se preferita
    //     const currentScroll = window.pageYOffset;
    //     if (currentScroll <= 0) { navbarContainerEl.classList.remove('hidden-scroll'); return; }
    //     if (currentScroll > lastScrollGlobal) { navbarContainerEl.classList.add('hidden-scroll'); }
    //     else { navbarContainerEl.classList.remove('hidden-scroll'); }
    //     lastScrollGlobal = currentScroll;
    // });
    // ALTRIMENTI, usa la logica scroll-up/scroll-down (come nelle altre pagine)
    window.addEventListener('scroll', handleNavbarScroll);


    const mobileMenuEl = gebi("mobileMenu");
    const hamburgerEl = document.querySelector(".hamburger"); // Potrebbe essercene solo uno

    function toggleMobileMenu() {
        if (mobileMenuEl && hamburgerEl) {
            const isActive = mobileMenuEl.classList.toggle("active");
            hamburgerEl.classList.toggle("active"); // hamburgerEl deve essere quello corretto
            document.body.style.overflow = isActive ? 'hidden' : '';
        }
    }

    function closeMobileMenu() {
        if (mobileMenuEl && hamburgerEl) {
            mobileMenuEl.classList.remove("active");
            hamburgerEl.classList.remove("active");
            document.body.style.overflow = '';
        }
    }

    // --- User Dropdown Logic ---
    function toggleUserMenu() {
        const dropdown = gebi('userDropdownContainer'); // Usa l'ID per specificit√†
        if (dropdown) {
            const userBtn = dropdown.querySelector('.user-btn');
            const isOpen = dropdown.classList.toggle('show');
            if (userBtn) userBtn.setAttribute('aria-expanded', isOpen.toString());
        }
    }

    document.addEventListener('click', function(event) {
        const dropdownContainer = gebi('userDropdownContainer');
        if (dropdownContainer && dropdownContainer.classList.contains('show')) {
            if (!dropdownContainer.contains(event.target) && !dropdownContainer.querySelector('.user-btn').contains(event.target) ) {
                dropdownContainer.classList.remove('show');
                const userBtn = dropdownContainer.querySelector('.user-btn');
                if (userBtn) userBtn.setAttribute('aria-expanded', 'false');
            }
        }
    });

    // --- Logica Utente (per pagina accesso) ---
    let currentUser = null;

    function updateNavbarUserUI() {
        const navbarAvatarEl = gebi('navbar-avatar');
        const navbarUsernameEl = gebi('navbar-username');

        if (currentUser) {
            if (navbarAvatarEl) navbarAvatarEl.textContent = currentUser.avatar || 'üë§';
            if (navbarUsernameEl) navbarUsernameEl.textContent = currentUser.nome || 'Utente';
        } else {
            // Se l'utente non √® loggato su una pagina "accesso", reindirizza al login
            alert("Accesso richiesto. Verrai reindirizzato alla pagina di login.");
            window.location.href = 'eventiincorso.html'; // o la tua pagina di login principale
        }
    }

    function checkLoginStatusOnLoad() {
        const storedUserData = localStorage.getItem('userDataEFF');
        if (storedUserData) {
            currentUser = JSON.parse(storedUserData);
        } else {
            currentUser = null; // Dovrebbe attivare il redirect in updateNavbarUserUI
        }
        updateNavbarUserUI();
    }

    function logoutAndRedirect() {
        currentUser = null;
        localStorage.removeItem('userDataEFF');
        alert('Logout effettuato.');
        window.location.href = 'index.html'; // Reindirizza alla home page pubblica
    }

    // --- Logica Caricamento Eventi (IDENTICA ALLA VERSIONE CORRETTA) ---
    async function loadEvents() {
        const eventsGrid = gebi('eventiGrid');
        const loadingIndicator = gebi('loadingIndicator');

        if (loadingIndicator) loadingIndicator.classList.add('visible');
        if (eventsGrid) eventsGrid.innerHTML = '';

        try {
            const response = await fetch('get_events.php');
            const responseText = await response.text();

            let result;
            try {
                result = JSON.parse(responseText);
            } catch (jsonError) {
                console.error("JSON.parse() fallito. Errore:", jsonError);
                console.error("Testo della risposta grezza da get_events.php (primi 1000 caratteri):\n", responseText.substring(0, 1000));
                let displayedError = `Errore nella risposta del server (non √® JSON valido).`;
                if (responseText.toLowerCase().includes("<br />") || responseText.toLowerCase().includes("<b>warning</b>") || responseText.toLowerCase().includes("<b>fatal error</b>")) {
                    displayedError += " Potrebbe trattarsi di un errore PHP.";
                }
                throw new Error(displayedError + " Controlla la console (F12) per i dettagli.");
            }

            if (!response.ok) {
                const errorMsg = result?.error || result?.message || `Errore HTTP: ${response.status} - ${response.statusText || 'Nessun testo di stato'}`;
                throw new Error(errorMsg);
            }

            if (!result.success) {
                throw new Error(result.error || result.message || 'Errore nel caricamento dei dati (success: false).');
            }

            if (!eventsGrid) return;

            if (result.count === 0 || !result.data || result.data.length === 0) {
                eventsGrid.innerHTML = '<p class="no-events text-center" style="padding: 20px;">Nessun evento in programma al momento.</p>';
            } else {
                result.data.forEach(event => {
                    const eventCard = createEventCard(event);
                    eventsGrid.appendChild(eventCard);
                });
            }

        } catch (error) {
            console.error('Errore dettagliato durante il caricamento degli eventi:', error);
            if (eventsGrid) {
                eventsGrid.innerHTML = `
                  <div class="error-message text-center" style="padding: 20px; width: 100%;">
                    <p><strong>Oops! Si √® verificato un errore.</strong></p>
                    <p style="font-size:0.9em; color: #e74c3c; margin-top: 5px;">${error.message || 'Impossibile caricare gli eventi.'}</p>
                    <button onclick="loadEvents()" class="btn-popup" style="margin-top: 15px;">Riprova Caricamento</button>
                  </div>`;
            }
        } finally {
            if (loadingIndicator) loadingIndicator.classList.remove('visible');
        }
    }

    function createEventCard(event) {
        const card = document.createElement('article');
        card.className = 'card';

        let imageSrc = 'images/default-event.jpg';
        if (event.immagine && typeof event.immagine === 'string' && event.immagine.startsWith('data:image')) {
            imageSrc = event.immagine;
        } else if (event.immagine) {
            console.warn(`Immagine per evento "${event.titolo}" non √® una data URI valida:`, event.immagine.substring(0,100) + "...");
        }

        card.innerHTML = `
            <div class="card-image-container">
                <img src="${imageSrc}" alt="Immagine evento ${event.titolo || 'Evento'}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
            </div>
            <div class="card-content">
                <h3>${event.titolo || 'Titolo non disponibile'}</h3>
                <p class="card-info">
                    <b>Data:</b> ${event.datainizio ? formatDate(event.datainizio) : 'Da definire'}
                    ${event.durata ? `<br><b>Orario:</b> ${event.durata}` : ''}
                    <br>
                    <b>${event.prefisso_relatore || 'Relatore'}:</b> ${event.relatore || 'Non specificato'}
                    ${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}` : ''}
                </p>
                <p class="card-description">${event.descrizione || 'Nessuna descrizione breve.'}</p>
                <p class="card-info">
                    <b>Posti:</b>
                    <span class="posti-disponibili">${event.posti_disponibili !== null ? event.posti_disponibili : 'N/D'}</span>
                    ${event.costo !== null ? (parseFloat(event.costo) > 0 ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨` : (parseFloat(event.costo) === 0 ? '<br><b>Costo:</b> Offerta libera' : '')) : ''}
                </p>
                <div class="card-actions">
                    <a href="evento_dettaglio_accesso.html?id=${event.idevento}" class="card-btn card-btn-secondary">Dettagli</a> <button class="card-btn card-btn-primary btn-prenota-rapido"
                            data-event-id="${event.idevento}"
                            ${parseInt(event.posti_disponibili) === 0 || !event.flagprenotabile ? 'disabled' : ''}>
                        ${!event.flagprenotabile ? 'Info dettagli' : (parseInt(event.posti_disponibili) === 0 ? 'Esaurito' : 'Prenota')}
                    </button>
                </div>
            </div>
        `;
        const prenotaBtn = card.querySelector('.btn-prenota-rapido');
        if (prenotaBtn && event.flagprenotabile && parseInt(event.posti_disponibili) > 0) {
            prenotaBtn.addEventListener('click', function() {
                handleRapidBooking(this, event.idevento);
            });
        }
        return card;
    }

    function handleRapidBooking(buttonElement, eventId) {
        if (currentUser) { // L'utente dovrebbe essere sempre loggato qui
            console.log(`Tentativo prenotazione evento ${eventId} per utente ${currentUser.nome}`);
            // Logica di prenotazione REALE qui (es. fetch a script PHP di prenotazione)
            alert(`Prenotazione per evento ${eventId} in elaborazione (simulato per ${currentUser.nome}).`);
            // Esempio: reindirizza a pagina conferma prenotazione
            // window.location.href = `conferma_prenotazione.html?evento_id=${eventId}`;
        } else {
            // Questo non dovrebbe accadere su una pagina "accesso" se la logica di auth √® corretta
            alert("Errore: Utente non riconosciuto. Prova a effettuare nuovamente il login.");
            logoutAndRedirect();
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'Data non disponibile';
        try {
            const parts = dateString.split('-');
            let date;
            if (parts.length === 3 && !isNaN(parseInt(parts[0])) && !isNaN(parseInt(parts[1])) && !isNaN(parseInt(parts[2]))) {
                date = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
            } else {
                date = new Date(dateString);
            }

            if (isNaN(date.getTime())) {
                console.warn("Formato data non riconosciuto o data non valida:", dateString);
                return dateString;
            }
            return date.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
        } catch (e) {
            console.error("Errore formattazione data:", dateString, e);
            return dateString;
        }
    }

    gebi('currentYear').textContent = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', () => {
        checkLoginStatusOnLoad(); // Verifica stato login, aggiorna UI o reindirizza
        if (currentUser) { // Carica eventi solo se l'utente √® effettivamente loggato
            loadEvents();
        }
    });

</script>
</body>
</html>