<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="images/logo.png" type="image/x-icon">
  <title>Gestione Calendario Attivit√† - Eremo Frate Francesco</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="index.html"> <span class="emoji">üèîÔ∏è</span> <h2>Eremo Frate Francesco</h2> </a>
    </div>
    <div class="menu">
      <a href="eventiincorso.html">Calendario attivit√†</a>
      <a href="eventipassati.html">Archivio attivit√†</a><span class="separator">|</span>
      <a href="incontrisullaparola.html">Incontri sulla parola</a><span class="separator">|</span>
      <a href="dovesiamo.html">Dove siamo</a>
      <a href="contatti.html">Contatti</a>
    </div>
    <div class="right-menu">
      <div class="user-dropdown" id="userDropdownContainer" style="display:none;"> <button class="user-btn" aria-haspopup="true" aria-expanded="false">
        <span class="user-avatar" id="navbar-avatar">üëë</span>
        <span class="user-name" id="navbar-username">Admin</span>
        <span class="dropdown-arrow">‚ñº</span>
      </button>
        <div class="dropdown-menu">
          <a href="#" id="admin-logout-btn-dropdown">Esci</a>
        </div>
      </div>
      <button class="hamburger" aria-label="Toggle menu">‚ò∞</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorso.html">Calendario attivit√†</a>
    <a href="eventipassati.html">Archivio attivit√†</a>
    <a href="incontrisullaparola.html">Incontri sulla parola</a>
    <a href="dovesiamo.html">Dove siamo</a>
    <a href="contatti.html">Contatti</a>
    <a href="#" id="admin-logout-btn-mobile" style="display:none;">Esci (Admin)</a>
  </div>
</header>

<main>
  <div class="container section-padding">
    <h1>Gestione Calendario Attivit√†</h1>
    <div id="eventiGridContainer">
      <div id="loadingIndicator" class="loading-overlay">
        <div class="spinner"> <div class="bounce1"></div> <div class="bounce2"></div> <div class="bounce3"></div> </div>
        <p>Sto caricando gli eventi...</p>
      </div>
      <div class="card-grid" id="eventiGrid">
      </div>
    </div>
  </div>
  <div class="add-event-btn-container">
    <button class="add-event-btn" id="addEventBtn">
      <span class="plus-icon">+</span>
      <span class="btn-label">Nuovo Evento</span>
    </button>
  </div>
</main>

<footer> <p>&copy; <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati.</p> </footer>

<div class="event-popup-overlay" id="eventPopupOverlay"></div>
<div class="event-popup" id="eventPopup">
  <button class="close-popup" id="closeEventPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h2 id="eventPopupTitle">Aggiungi Nuovo Evento</h2>
  <form id="newEventForm" method="POST" enctype="multipart/form-data">
    <input type="hidden" id="event-id" name="event-id">
    <div class="form-group"> <label for="event-title">Titolo Evento*</label> <input type="text" id="event-title" name="event-title" class="form-control" required> </div>
    <div class="form-grid">
      <div class="form-group"> <label for="event-date">Data Inizio*</label> <input type="date" id="event-date" name="event-date" class="form-control" required> </div>
      <div class="form-group"> <label for="event-time">Orario</label> <input type="text" id="event-time" name="event-time" class="form-control" placeholder="es. 18:00-19:30"> </div>
    </div>
    <div class="form-group"> <label for="event-short-desc">Descrizione Breve*</label> <textarea id="event-short-desc" name="event-short-desc" class="form-control" rows="3" required maxlength="200"></textarea> </div>
    <div class="form-group"> <label for="event-long-desc">Descrizione Estesa</label> <textarea id="event-long-desc" name="event-long-desc" class="form-control" rows="5"></textarea> </div>
    <div class="form-grid">
      <div class="form-group"> <label for="event-prefix">Prefisso Relatore</label> <input type="text" id="event-prefix" name="event-prefix" class="form-control" placeholder="Default: Relatore"> </div>
      <div class="form-group"> <label for="event-speaker">Nome Relatore*</label> <input type="text" id="event-speaker" name="event-speaker" class="form-control" required> </div>
    </div>
    <div class="form-grid">
      <div class="form-group"> <label for="event-association">Associazione</label> <input type="text" id="event-association" name="event-association" class="form-control"> </div>
      <div class="form-group"> <label for="event-seats">Posti Disponibili*</label> <input type="number" id="event-seats" name="event-seats" class="form-control" required min="0"> </div>
    </div>
    <div class="form-group">
      <label for="event-image">Immagine Copertina</label> <input type="file" id="event-image" name="event-image" class="form-control" accept="image/*">
      <small>Lascia vuoto se non vuoi modificare.</small>
      <img id="current-event-image-preview" src="#" alt="Anteprima copertina" style="max-width:100px; max-height:100px; display:none; margin-top:5px; border-radius: 4px;">
    </div>
    <div class="form-group">
      <label for="event-flyer">Volantino (PDF/Immagine)</label> <input type="file" id="event-flyer" name="event-flyer" class="form-control" accept="image/*,application/pdf">
      <small>Lascia vuoto se non vuoi modificare.</small>
      <div id="current-event-flyer-preview" style="margin-top:5px;"></div>
    </div>
    <div class="form-check-group"> <input type="checkbox" id="event-booking" name="event-booking" checked> <label for="event-booking">Prenotazioni aperte</label> </div>
    <div class="form-check-group"> <input type="checkbox" id="event-voluntary" name="event-voluntary"> <label for="event-voluntary">Costo su base volontaria (offerta libera)</label> </div>
    <div class="form-group" id="event-price-container"> <label for="event-price">Prezzo (‚Ç¨)</label> <input type="number" id="event-price" name="event-price" class="form-control" min="0" step="0.01" placeholder="Es. 10.00"> </div>
    <div id="newEventFormMessage" class="form-message" style="display:none;"></div>
    <div class="form-actions"> <button type="submit" class="btn-popup">Salva Evento</button> </div>
  </form>
</div>

<script>
  function gebi(id) { return document.getElementById(id); }

  // --- Navbar Admin & Mobile Menu Logic ---
  const adminNavbarContainerEl = gebi('navbarContainer');
  const adminMobileMenuEl = gebi("mobileMenu");
  const adminHamburgerEl = document.querySelector(".hamburger");
  const adminLogoutBtnMobile = gebi('admin-logout-btn-mobile');
  const adminUserDropdownContainer = gebi('userDropdownContainer');
  const adminUserBtn = adminUserDropdownContainer ? adminUserDropdownContainer.querySelector('.user-btn') : null;
  const adminLogoutBtnDropdown = gebi('admin-logout-btn-dropdown');
  let adminLastScrollNav = 0;

  if (adminNavbarContainerEl) {
    window.addEventListener('scroll', function() {
      const currentScroll = window.pageYOffset;
      if (currentScroll <= 50) { adminNavbarContainerEl.classList.remove('hidden'); return; }
      if (currentScroll > adminLastScrollNav && currentScroll > adminNavbarContainerEl.offsetHeight) {
        adminNavbarContainerEl.classList.add('hidden');
      } else { adminNavbarContainerEl.classList.remove('hidden'); }
      adminLastScrollNav = currentScroll <= 0 ? 0 : currentScroll;
    });
  }
  function toggleAdminMobileMenu() {
    if (adminMobileMenuEl && adminHamburgerEl) {
      adminMobileMenuEl.classList.toggle("open");
      document.body.style.overflow = adminMobileMenuEl.classList.contains("open") ? 'hidden' : '';
    }
  }
  function closeAdminMobileMenuOnLinkClick() { if (adminMobileMenuEl.classList.contains('open')) toggleAdminMobileMenu(); }
  if (adminHamburgerEl) adminHamburgerEl.addEventListener('click', toggleAdminMobileMenu);
  document.querySelectorAll('#mobileMenu a').forEach(link => link.addEventListener('click', closeAdminMobileMenuOnLinkClick));

  if (adminUserBtn) {
    adminUserBtn.addEventListener('click', function(e) {
      e.stopPropagation(); adminUserDropdownContainer.classList.toggle('show');
      this.setAttribute('aria-expanded', adminUserDropdownContainer.classList.contains('show').toString());
    });
  }
  document.addEventListener('click', function(event) {
    if (adminUserDropdownContainer && adminUserDropdownContainer.classList.contains('show') && !adminUserDropdownContainer.contains(event.target)) {
      adminUserDropdownContainer.classList.remove('show');
      if(adminUserBtn) adminUserBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // --- Logica Admin User (Simulata) ---
  let adminUser = { nome: "Admin Eremo", avatar: "üëë" }; // Simula admin loggato

  function updateAdminNavbarUI() {
    const avatarEl = gebi('navbar-avatar');
    const nameEl = gebi('navbar-username');
    if (adminUser) {
      if (avatarEl) avatarEl.textContent = adminUser.avatar;
      if (nameEl) nameEl.textContent = adminUser.nome;
      if (adminUserDropdownContainer) adminUserDropdownContainer.style.display = 'inline-block';
      if (adminLogoutBtnMobile) adminLogoutBtnMobile.style.display = 'block';
      const publicLoginBtn = gebi('login-btn-header'); if(publicLoginBtn) publicLoginBtn.style.display='none';
      const publicLoginMobileBtn = gebi('login-btn-mobile'); if(publicLoginMobileBtn) publicLoginMobileBtn.style.display='none';
    } else {
      alert("Accesso Admin non verificato. Reindirizzamento."); window.location.href = 'index.html';
    }
  }
  function adminLogout() {
    adminUser = null; alert('Logout Admin effettuato.'); updateAdminNavbarUI();
  }
  if(adminLogoutBtnDropdown) adminLogoutBtnDropdown.addEventListener('click', adminLogout);
  if(adminLogoutBtnMobile) adminLogoutBtnMobile.addEventListener('click', () => { adminLogout(); if(adminMobileMenuEl.classList.contains('open')) toggleAdminMobileMenu(); });

  // --- Gestione Pop-up Nuovo/Modifica Evento ---
  const addEventBtn = gebi('addEventBtn');
  const eventPopupOverlay = gebi('eventPopupOverlay');
  const eventPopup = gebi('eventPopup');
  const closeEventPopupBtn = gebi('closeEventPopupBtn');
  const newEventForm = gebi('newEventForm');
  const eventPopupTitle = gebi('eventPopupTitle');
  const eventIdInput = gebi('event-id');
  const voluntaryCheckbox = gebi('event-voluntary');
  const priceContainer = gebi('event-price-container');
  const eventPriceInput = gebi('event-price');
  const newEventFormMessage = gebi('newEventFormMessage');
  const currentImagePreview = gebi('current-event-image-preview');
  const currentFlyerPreview = gebi('current-event-flyer-preview');
  let currentEventsData = []; // Cache per i dati

  function updatePriceFieldVisibility() { /* ... (Incolla da interazione precedente, assicurati sia corretta) ... */ }
  if (voluntaryCheckbox) voluntaryCheckbox.addEventListener('change', updatePriceFieldVisibility);
  // Implementazione updatePriceFieldVisibility
  function updatePriceFieldVisibility() {
    if (voluntaryCheckbox && priceContainer && eventPriceInput) {
      const isVoluntary = voluntaryCheckbox.checked;
      priceContainer.style.display = isVoluntary ? 'none' : 'block';
      eventPriceInput.required = !isVoluntary;
      if (isVoluntary) eventPriceInput.value = '';
    }
  }


  function openEventPopup(eventData = null) { /* ... (Incolla da interazione precedente, assicurati sia corretta e completa) ... */ }
  if (addEventBtn) addEventBtn.addEventListener('click', () => openEventPopup());
  function closeEventPopupHandler() { /* ... (Incolla da interazione precedente) ... */ }
  if (closeEventPopupBtn) closeEventPopupBtn.addEventListener('click', closeEventPopupHandler);
  if (eventPopupOverlay) eventPopupOverlay.addEventListener('click', (e) => { if (e.target === eventPopupOverlay) closeEventPopupHandler(); });
  newEventForm?.addEventListener('submit', async function(e) { /* ... (Incolla da interazione precedente, assicurati sia completa) ... */ });
  document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && eventPopup.classList.contains('active')) closeEventPopupHandler(); });

  // Implementazione completa openEventPopup, closeEventPopupHandler, e submit listener
  function openEventPopup(eventData = null) {
    newEventForm.reset();
    updatePriceFieldVisibility();
    newEventFormMessage.style.display = 'none'; newEventFormMessage.className = 'form-message';
    currentImagePreview.style.display = 'none'; currentImagePreview.src = '#';
    currentFlyerPreview.innerHTML = '';

    if (eventData) {
      eventPopupTitle.textContent = 'Modifica Evento';
      eventIdInput.value = eventData.idevento;
      gebi('event-title').value = eventData.titolo || '';
      gebi('event-date').value = eventData.datainizio || '';
      gebi('event-time').value = eventData.durata || '';
      gebi('event-short-desc').value = eventData.descrizione || '';
      gebi('event-long-desc').value = eventData.descrizione_estesa || '';
      gebi('event-prefix').value = eventData.prefisso_relatore || '';
      gebi('event-speaker').value = eventData.relatore || '';
      gebi('event-association').value = eventData.associazione || '';
      gebi('event-seats').value = eventData.posti_disponibili !== null ? eventData.posti_disponibili : '';
      gebi('event-booking').checked = !!eventData.flagprenotabile;

      voluntaryCheckbox.checked = parseFloat(eventData.costo) === 0;
      updatePriceFieldVisibility();
      if (!voluntaryCheckbox.checked && parseFloat(eventData.costo) > 0) {
        eventPriceInput.value = parseFloat(eventData.costo).toFixed(2);
      } else {
        eventPriceInput.value = '';
      }

      if (eventData.immagine_url) {
        currentImagePreview.src = eventData.immagine_url; currentImagePreview.style.display = 'block';
      }
      if (eventData.volantino_url) {
        const fileName = eventData.volantino_url.split('/').pop();
        currentFlyerPreview.innerHTML = `<a href="${eventData.volantino_url}" target="_blank">Vedi (${fileName})</a>`;
      }
    } else {
      eventPopupTitle.textContent = 'Aggiungi Nuovo Evento';
      eventIdInput.value = '';
      voluntaryCheckbox.checked = false;
      gebi('event-booking').checked = true;
      updatePriceFieldVisibility();
    }
    eventPopupOverlay.classList.add('active'); eventPopup.classList.add('active');
    document.body.style.overflow = 'hidden';
    gebi('event-title').focus();
  }

  function closeEventPopupHandler() {
    eventPopupOverlay.classList.remove('active'); eventPopup.classList.remove('active');
    document.body.style.overflow = '';
  }

  newEventForm?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true; submitBtn.innerHTML = '<div class="spinner-mini"></div>Salvataggio...';
    newEventFormMessage.style.display = 'none'; newEventFormMessage.className = 'form-message';

    try {
      const formData = new FormData(this);
      formData.append('action', formData.get('event-id') ? 'update_event' : 'add_event');
      // La logica del costo √® gestita in PHP basandosi su 'event-voluntary' se necessario
      // o direttamente dal valore di 'event-price' che il JS sistema.

      const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
      const responseText = await response.text();
      let result;
      try { result = JSON.parse(responseText); }
      catch (jsonError) { throw new Error(`Risposta non JSON dal server: ${responseText.substring(0,200)}`); }

      if (!response.ok) throw new Error(result.message || `Errore server: ${response.status}`);
      if (result.success) {
        newEventFormMessage.textContent = result.message || 'Operazione completata con successo!';
        newEventFormMessage.classList.add('success');
        loadEvents();
        setTimeout(closeEventPopupHandler, 1500);
      } else { throw new Error(result.message || 'Errore durante il salvataggio dell\'evento.'); }
    } catch (error) {
      console.error('Errore invio form evento admin:', error);
      newEventFormMessage.textContent = `Errore: ${error.message}`;
      newEventFormMessage.classList.add('error');
    } finally {
      newEventFormMessage.style.display = 'block';
      submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText;
    }
  });


  // --- Logica Caricamento Eventi Admin ---
  async function loadEvents() { /* ... (Incolla da interazione precedente, assicurati sia completa e usi createAdminEventCard) ... */ }
  function createAdminEventCard(event) { /* ... (Incolla e adatta come sotto) ... */ }
  function formatDate(dateString) { /* ... (Incolla da interazione precedente) ... */ }

  // Implementazione completa loadEvents e createAdminEventCard (con formattazione dati come eventiincorso)
  async function loadEvents() {
    const eventsGrid = gebi('eventiGrid');
    const loadingIndicator = gebi('loadingIndicator');
    if (loadingIndicator) loadingIndicator.classList.add('visible');
    if (eventsGrid) eventsGrid.innerHTML = '';

    try {
      const response = await fetch('get_events.php?admin_view=true');
      const responseText = await response.text();
      let result;
      try { result = JSON.parse(responseText); }
      catch (e) { throw new Error(`Risposta non JSON (admin): ${responseText.substring(0,200)}`); }

      if (!response.ok) throw new Error(result.message || `Errore HTTP (admin) ${response.status}`);
      if (!result.success) throw new Error(result.message || 'Caricamento eventi (admin) fallito');

      currentEventsData = result.data;

      if (!eventsGrid) return;
      if (currentEventsData.length === 0) {
        eventsGrid.innerHTML = '<p class="no-events">Nessun evento. Aggiungine uno!</p>';
      } else {
        currentEventsData.forEach(event => eventsGrid.appendChild(createAdminEventCard(event)));
      }
    } catch (error) {
      console.error('Errore loadEvents (admin):', error);
      if (eventsGrid) eventsGrid.innerHTML = `<div class="error-message" style="width:100%;"><p><strong>Errore:</strong> ${error.message}</p><button onclick="loadEvents()" class="btn-popup">Riprova</button></div>`;
    } finally {
      if (loadingIndicator) loadingIndicator.classList.remove('visible');
    }
  }

  function createAdminEventCard(event) {
    const card = document.createElement('article');
    card.className = 'card admin-card';
    let imageSrc = (event.immagine_url && event.immagine_url.trim() !== '') ? event.immagine_url : 'images/default-event.jpg';

    let volantinoInfoHtml = '';
    if (event.volantino_url) {
      const volantinoName = event.volantino_url.split('/').pop();
      volantinoInfoHtml = `<p class="card-info"><b>Volantino:</b> <a href="${event.volantino_url}" target="_blank" title="${volantinoName}">Visualizza</a></p>`;
    }

    // Formattazione dati come in eventiincorso.html
    card.innerHTML = `
            <div class="card-image-container">
                <img src="${imageSrc}" alt="Copertina: ${event.titolo || ''}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
            </div>
            <div class="card-content">
                <h3>${event.titolo || 'Titolo non disponibile'}</h3>
                <p class="card-info">
                    <b>Data:</b> ${formatDate(event.datainizio)}
                    ${event.durata ? `<br><b>Orario:</b> ${event.durata}` : ''}
                </p>
                <p class="card-info">
                    <b>${event.prefisso_relatore || 'Relatore'}:</b> ${event.relatore || 'N/D'}
                    ${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}` : ''}
                </p>
                <p class="card-description">${event.descrizione || 'Nessuna descrizione breve.'}</p>
                <p class="card-info">
                    <b>Posti:</b> <span class="posti-disponibili">${event.posti_disponibili !== null ? event.posti_disponibili : 'N/D'}</span>
                    ${event.costo !== null ? (parseFloat(event.costo) > 0 ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨` : (parseFloat(event.costo) === 0 ? '<br><b>Costo:</b> Offerta libera' : '')) : ''}
                </p>
                <p class="card-info">
                    Stato Prenotazioni: ${event.flagprenotabile ? '<span class="status-prenotabile">Aperte</span>' : '<span class="status-non-prenotabile">Chiuse</span>'}
                </p>
                ${volantinoInfoHtml}
                <div class="card-actions admin-actions" style="margin-top: auto;"> <button class="card-btn btn-edit card-btn-secondary" data-event-id="${event.idevento}">Modifica</button>
                    <button class="card-btn btn-delete card-btn-primary" data-event-id="${event.idevento}" style="background-color: var(--danger);">Elimina</button> </div>
            </div>`;

    card.querySelector('.btn-edit').addEventListener('click', function() {
      const eventToEdit = currentEventsData.find(e => e.idevento == this.dataset.eventId);
      if (eventToEdit) openEventPopup(eventToEdit); else alert("Dati evento non trovati per modifica.");
    });
    card.querySelector('.btn-delete').addEventListener('click', async function() {
      const eventId = this.dataset.eventId;
      const eventToDelete = currentEventsData.find(e => e.idevento == eventId);
      const eventTitle = eventToDelete ? eventToDelete.titolo : "questo evento";
      if (confirm(`Sei sicuro di voler eliminare l'evento "${eventTitle}"? L'azione √® irreversibile.`)) {
        try {
          const formData = new FormData(); formData.append('action', 'delete_event'); formData.append('event_id', eventId);
          const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
          const resText = await response.text();
          let res; try {res = JSON.parse(resText);} catch(e){throw new Error("Risposta non JSON (delete): "+resText.substring(0,100))}
          if (!response.ok) throw new Error(res.message || `Errore HTTP ${response.status}`);
          if (res.success) { alert(res.message || 'Evento eliminato.'); loadEvents(); }
          else { throw new Error(res.message || 'Eliminazione fallita.'); }
        } catch (error) { console.error('Errore delete:', error); alert(`Errore eliminazione: ${error.message}`); }
      }
    });
    return card;
  }

  // Implementazione completa formatDate
  function formatDate(dateString) {
    if (!dateString) return 'Data non disponibile';
    try {
      let date;
      if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
        const parts = dateString.substring(0,10).split('-');
        date = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
      } else { date = new Date(dateString); }
      if (isNaN(date.getTime())) { return dateString; }
      return date.toLocaleDateString('it-IT', {day:'numeric',month:'long',year:'numeric',timeZone:'UTC'});
    } catch (e) { return dateString; }
  }


  // --- INIZIALIZZAZIONE PAGINA ADMIN ---
  document.addEventListener('DOMContentLoaded', () => {
    updateAdminNavbarUI(); // Gestisce UI e pseudo-autenticazione Admin
    loadEvents();
    gebi('currentYear').textContent = new Date().getFullYear();
  });
</script>
</body>
</html>