<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="images/logo.png" type="image/x-icon" />
    <title>Gestione Archivio Attivit√† - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Stili specifici per i filtri, se necessario (da eventipassati.html) */
      .event-filters {
        background-color: var(--white);
        padding: 1.5rem;
        border-radius: var(--border-radius-medium);
        margin-bottom: 2rem;
        box-shadow: var(--shadow-light);
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
      }
      .event-filters .form-group {
        flex: 1 1 200px;
        margin-bottom: 0;
      }
      .event-filters label {
        font-size: 0.9rem;
        margin-bottom: 0.3rem;
        color: var(--primary);
        display: block;
      }
      .event-filters input,
      .event-filters select {
        width: 100%;
        padding: 0.7rem 1rem;
        border: 1px solid var(--gray-medium);
        border-radius: 8px;
        font-size: 0.95rem;
      }
      .event-filters button {
        /* Stile per eventuale bottone filtro, se lo mantieni */
        padding: 0.7rem 1.5rem;
        background-color: var(--secondary);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition-medium);
        height: fit-content;
      }
      .event-filters button:hover {
        background-color: var(--primary);
      }
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
      }
      .loading-overlay.visible {
        visibility: visible;
        opacity: 1;
      }
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: var(--primary);
        animation: spin 1s ease infinite;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      .no-events {
        text-align: center;
        padding: 2rem;
        color: var(--gray-dark);
      }

      /* Stili per bottoni admin nelle card (presi da logica eventiincorsoAdmin) */
      .card-actions.admin-actions {
        margin-top: 1rem; /* Spazio sopra i bottoni admin */
        border-top: 1px solid var(--gray-light); /* Separatore opzionale */
        padding-top: 1rem; /* Spazio dopo il separatore */
      }
      .card-actions.admin-actions .card-btn {
        flex-grow: 1; /* I bottoni occupano lo spazio disponibile */
      }
      .card-actions .btn-delete {
        background-color: var(
          --danger
        ) !important; /* Usa !important se necessario per sovrascrivere */
        color: white !important;
      }
      .card-actions .btn-delete:hover {
        background-color: darkred !important; /* Esempio di hover per delete */
      }
    </style>
  </head>
  <body>
    <header class="navbar-container" id="navbarContainer">
      <nav class="navbar">
        <div class="logo">
          <a href="indexadmin.html">
            <span class="emoji">üèîÔ∏è</span>
            <h2>Eremo Frate Francesco</h2>
          </a>
        </div>
        <div class="menu">
          <a href="eventiincorsoAdmin.html">Calendario attivit√†</a>
          <a href="eventipassatiadmin.html">Archivio attivit√†</a
          ><span class="separator">|</span>
          <a href="incontrisullaparola.html">Incontri sulla parola</a
          ><span class="separator">|</span>
          <a href="dovesiamo.html">Dove siamo</a>
          <a href="contatti.html">Contatti</a>
        </div>
        <div class="right-menu">
          <div
            class="user-dropdown"
            id="userDropdownContainer"
            style="display: none"
          >
            <button class="user-btn" aria-haspopup="true" aria-expanded="false">
              <span class="user-avatar" id="navbar-avatar">üëë</span>
              <span class="user-name" id="navbar-username">Admin</span>
              <span class="dropdown-arrow">‚ñº</span>
            </button>
            <div class="dropdown-menu">
              <a href="#" id="admin-logout-btn-dropdown">Esci</a>
            </div>
          </div>
          <button class="hamburger" aria-label="Toggle menu">‚ò∞</button>
        </div>
      </nav>
      <div class="mobile-menu" id="mobileMenu">
        <a href="eventiincorso.html">Calendario attivit√†</a>
        <a href="eventiincorsoAdmin.html">Gestione Eventi</a>
        <a href="eventipassati.html">Archivio attivit√†</a>
        <a href="incontrisullaparola.html">Incontri sulla parola</a>
        <a href="dovesiamo.html">Dove siamo</a>
        <a href="contatti.html">Contatti</a>
        <a href="#" id="admin-logout-btn-mobile" style="display: none"
          >Esci (Admin)</a
        >
      </div>
    </header>

    <main>
      <div class="container section-padding">
        <h1>Gestione Archivio Attivit√†</h1>

        <div class="event-filters">
          <div class="form-group">
            <label for="searchTitle">Titolo Evento</label>
            <input
              type="text"
              id="searchTitle"
              placeholder="Cerca per titolo..."
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label for="searchDate">Mese/Anno (YYYY-MM)</label>
            <input type="month" id="searchDate" class="form-control" />
          </div>
          <div class="form-group">
            <label for="searchSpeaker">Relatore</label>
            <input
              type="text"
              id="searchSpeaker"
              class="form-control"
              placeholder="Nome relatore..."
            />
          </div>
        </div>

        <div id="eventiGridContainer" style="position: relative">
          <div id="loadingIndicator" class="loading-overlay">
            <div class="spinner">
              <div class="bounce1"></div>
              <div class="bounce2"></div>
              <div class="bounce3"></div>
            </div>
            <p>Sto caricando gli eventi passati...</p>
          </div>
          <div class="card-grid" id="eventiPassatiGrid"></div>
        </div>
      </div>
    </main>

    <footer>
      <p>
        ¬© <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti
        riservati.
      </p>
    </footer>

    <div class="event-popup-overlay" id="eventPopupOverlay"></div>
    <div class="event-popup" id="eventPopup">
      <button
        class="close-popup"
        id="closeEventPopupBtn"
        aria-label="Chiudi popup"
      >
        &times;
      </button>
      <h2 id="eventPopupTitle">Modifica Evento Passato</h2>
      <form id="editPastEventForm" method="POST" enctype="multipart/form-data">
        <input type="hidden" id="event-id" name="event-id" />
        <div class="form-group">
          <label for="event-title">Titolo Evento*</label>
          <input
            type="text"
            id="event-title"
            name="event-title"
            class="form-control"
            required
          />
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="event-date">Data Inizio*</label>
            <input
              type="date"
              id="event-date"
              name="event-date"
              class="form-control"
              required
            />
          </div>
          <div class="form-group">
            <label for="event-time">Orario/Durata</label>
            <input
              type="text"
              id="event-time"
              name="event-time"
              class="form-control"
              placeholder="es. 18:00-19:30 o 2 giorni"
            />
          </div>
        </div>
        <div class="form-group">
          <label for="event-short-desc">Descrizione Breve*</label>
          <textarea
            id="event-short-desc"
            name="event-short-desc"
            class="form-control"
            rows="3"
            required
            maxlength="200"
          ></textarea>
        </div>
        <div class="form-group">
          <label for="event-long-desc">Descrizione Estesa</label>
          <textarea
            id="event-long-desc"
            name="event-long-desc"
            class="form-control"
            rows="5"
          ></textarea>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="event-prefix">Prefisso Relatore</label>
            <input
              type="text"
              id="event-prefix"
              name="event-prefix"
              class="form-control"
              placeholder="Default: Relatore"
            />
          </div>
          <div class="form-group">
            <label for="event-speaker">Nome Relatore*</label>
            <input
              type="text"
              id="event-speaker"
              name="event-speaker"
              class="form-control"
              required
            />
          </div>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label for="event-association">Associazione</label>
            <input
              type="text"
              id="event-association"
              name="event-association"
              class="form-control"
            />
          </div>
          <div class="form-group">
            <label for="event-seats">Posti Disponibili*</label>
            <input
              type="number"
              id="event-seats"
              name="event-seats"
              class="form-control"
              required
              min="0"
            />
          </div>
        </div>
        <div class="form-group">
          <label for="event-image">Immagine Copertina</label>
          <input
            type="file"
            id="event-image"
            name="event-image"
            class="form-control"
            accept="image/*"
          />
          <small
            >Lascia vuoto se non vuoi modificare l'immagine corrente.</small
          >
          <img
            id="current-event-image-preview"
            src="#"
            alt="Anteprima copertina"
            style="
              max-width: 100px;
              max-height: 100px;
              display: none;
              margin-top: 5px;
              border-radius: 4px;
            "
          />
        </div>
        <div class="form-group">
          <label for="event-flyer">Volantino (PDF/Immagine)</label>
          <input
            type="file"
            id="event-flyer"
            name="event-flyer"
            class="form-control"
            accept="image/*,application/pdf"
          />
          <small
            >Lascia vuoto se non vuoi modificare il volantino corrente.</small
          >
          <div id="current-event-flyer-preview" style="margin-top: 5px"></div>
        </div>
        <div class="form-check-group">
          <input type="checkbox" id="event-booking" name="event-booking" />
          <label for="event-booking">Era prenotabile?</label>
        </div>
        <div class="form-check-group">
          <input type="checkbox" id="event-voluntary" name="event-voluntary" />
          <label for="event-voluntary"
            >Costo su base volontaria (offerta libera)</label
          >
        </div>
        <div class="form-group" id="event-price-container">
          <label for="event-price">Prezzo (‚Ç¨)</label>
          <input
            type="number"
            id="event-price"
            name="event-price"
            class="form-control"
            min="0"
            step="0.01"
            placeholder="Es. 10.00"
          />
        </div>
        <div
          id="editPastEventFormMessage"
          class="form-message"
          style="display: none"
        ></div>
        <div class="form-actions">
          <button type="submit" class="btn-popup">Salva Modifiche</button>
        </div>
      </form>
    </div>

    <script>
      function gebi(id) {
        return document.getElementById(id);
      }

      // --- Navbar Admin & Mobile Menu Logic (da eventiincorsoAdmin.html) ---
      const adminNavbarContainerEl = gebi("navbarContainer");
      const adminMobileMenuEl = gebi("mobileMenu");
      const adminHamburgerEl = document.querySelector(".hamburger");
      const adminLogoutBtnMobile = gebi("admin-logout-btn-mobile");
      const adminUserDropdownContainer = gebi("userDropdownContainer");
      const adminUserBtn = adminUserDropdownContainer
        ? adminUserDropdownContainer.querySelector(".user-btn")
        : null;
      const adminLogoutBtnDropdown = gebi("admin-logout-btn-dropdown");
      let adminLastScrollNav = 0;

      if (adminNavbarContainerEl) {
        window.addEventListener("scroll", function () {
          const currentScroll =
            window.pageYOffset || document.documentElement.scrollTop;
          if (currentScroll <= 50) {
            adminNavbarContainerEl.classList.remove("hidden");
            adminLastScrollNav = 0;
            return;
          }
          if (
            currentScroll > adminLastScrollNav &&
            !adminNavbarContainerEl.classList.contains("hidden")
          ) {
            adminNavbarContainerEl.classList.add("hidden");
          } else if (
            currentScroll < adminLastScrollNav &&
            adminNavbarContainerEl.classList.contains("hidden")
          ) {
            adminNavbarContainerEl.classList.remove("hidden");
          }
          adminLastScrollNav = currentScroll;
        });
      }
      function toggleAdminMobileMenu() {
        if (adminMobileMenuEl && adminHamburgerEl) {
          const isOpen = adminMobileMenuEl.classList.toggle("open");
          adminHamburgerEl.setAttribute("aria-expanded", isOpen);
          document.body.style.overflow = isOpen ? "hidden" : "";
        }
      }
      function closeAdminMobileMenuOnLinkClick() {
        if (adminMobileMenuEl && adminMobileMenuEl.classList.contains("open"))
          toggleAdminMobileMenu();
      }
      if (adminHamburgerEl)
        adminHamburgerEl.addEventListener("click", toggleAdminMobileMenu);
      document
        .querySelectorAll("#mobileMenu a")
        .forEach((link) =>
          link.addEventListener("click", closeAdminMobileMenuOnLinkClick)
        );

      if (adminUserBtn) {
        adminUserBtn.addEventListener("click", function (e) {
          e.stopPropagation();
          const isShown = adminUserDropdownContainer.classList.toggle("show");
          this.setAttribute("aria-expanded", isShown.toString());
        });
      }
      document.addEventListener("click", function (event) {
        if (
          adminUserDropdownContainer &&
          adminUserDropdownContainer.classList.contains("show") &&
          !adminUserDropdownContainer.contains(event.target)
        ) {
          adminUserDropdownContainer.classList.remove("show");
          if (adminUserBtn) adminUserBtn.setAttribute("aria-expanded", "false");
        }
      });

      // --- Logica Admin User (Simulata, da adattare alla tua autenticazione reale) ---
      let adminUser = { nome: "Admin Eremo", avatar: "üëë" }; // Simula admin loggato

      function updateAdminNavbarUI() {
        const avatarEl = gebi("navbar-avatar");
        const nameEl = gebi("navbar-username");
        if (adminUser) {
          if (avatarEl) avatarEl.textContent = adminUser.avatar;
          if (nameEl) nameEl.textContent = adminUser.nome;
          if (adminUserDropdownContainer)
            adminUserDropdownContainer.style.display = "inline-block";
          if (adminLogoutBtnMobile)
            adminLogoutBtnMobile.style.display = "block";
        } else {
          // In un'applicazione reale, qui reindirizzeresti alla pagina di login
          alert("Accesso Admin non verificato. Questa √® una demo.");
          // window.location.href = 'login.html'; // Esempio
        }
      }
      function adminLogout() {
        adminUser = null;
        alert("Logout Admin effettuato.");
        updateAdminNavbarUI();
        // Qui dovresti anche invalidare la sessione admin sul server
        window.location.href = "index.html"; // Reindirizza alla home page pubblica
      }
      if (adminLogoutBtnDropdown)
        adminLogoutBtnDropdown.addEventListener("click", adminLogout);
      if (adminLogoutBtnMobile)
        adminLogoutBtnMobile.addEventListener("click", () => {
          adminLogout();
          if (adminMobileMenuEl && adminMobileMenuEl.classList.contains("open"))
            toggleAdminMobileMenu();
        });

      // --- Gestione Pop-up Modifica Evento Passato ---
      const eventPopupOverlay = gebi("eventPopupOverlay");
      const eventPopup = gebi("eventPopup");
      const closeEventPopupBtn = gebi("closeEventPopupBtn");
      const editPastEventForm = gebi("editPastEventForm");
      const eventPopupTitle = gebi("eventPopupTitle"); // Gi√† definito sopra, ma ri-referenziamolo per chiarezza
      const eventIdInput = gebi("event-id");
      const voluntaryCheckbox = gebi("event-voluntary");
      const priceContainer = gebi("event-price-container");
      const eventPriceInput = gebi("event-price");
      const editPastEventFormMessage = gebi("editPastEventFormMessage");
      const currentImagePreview = gebi("current-event-image-preview");
      const currentFlyerPreview = gebi("current-event-flyer-preview");
      let allPastEventsAdmin = []; // Cache per i dati degli eventi passati

      function updatePriceFieldVisibility() {
        if (voluntaryCheckbox && priceContainer && eventPriceInput) {
          const isVoluntary = voluntaryCheckbox.checked;
          priceContainer.style.display = isVoluntary ? "none" : "block";
          eventPriceInput.required = !isVoluntary;
          if (isVoluntary) eventPriceInput.value = "";
        }
      }
      if (voluntaryCheckbox)
        voluntaryCheckbox.addEventListener(
          "change",
          updatePriceFieldVisibility
        );

      function openEditPastEventPopup(eventData) {
        editPastEventForm.reset();
        editPastEventFormMessage.style.display = "none";
        editPastEventFormMessage.className = "form-message";
        currentImagePreview.style.display = "none";
        currentImagePreview.src = "#";
        currentFlyerPreview.innerHTML = "";

        eventPopupTitle.textContent = "Modifica Evento Passato";
        eventIdInput.value = eventData.idevento;
        gebi("event-title").value = eventData.titolo || "";
        gebi("event-date").value = eventData.datainizio || ""; // Assicurati che il formato sia YYYY-MM-DD
        gebi("event-time").value = eventData.durata || "";
        gebi("event-short-desc").value = eventData.descrizione || "";
        gebi("event-long-desc").value = eventData.descrizione_estesa || "";
        gebi("event-prefix").value = eventData.prefisso_relatore || "";
        gebi("event-speaker").value = eventData.relatore || "";
        gebi("event-association").value = eventData.associazione || "";
        gebi("event-seats").value =
          eventData.posti_disponibili !== null
            ? eventData.posti_disponibili
            : "";
        gebi("event-booking").checked = !!eventData.flagprenotabile; // Converti a booleano

        voluntaryCheckbox.checked = parseFloat(eventData.costo) === 0.0;
        updatePriceFieldVisibility();
        if (
          !voluntaryCheckbox.checked &&
          eventData.costo &&
          parseFloat(eventData.costo) > 0
        ) {
          eventPriceInput.value = parseFloat(eventData.costo).toFixed(2);
        } else {
          eventPriceInput.value = "";
        }

        if (eventData.immagine_url) {
          currentImagePreview.src = eventData.immagine_url;
          currentImagePreview.style.display = "block";
        }
        if (eventData.volantino_url) {
          const fileName = eventData.volantino_url.split("/").pop();
          currentFlyerPreview.innerHTML = `<a href="${eventData.volantino_url}" target="_blank">Vedi volantino attuale (${fileName})</a>`;
        }

        eventPopupOverlay.classList.add("active");
        eventPopup.classList.add("active");
        document.body.style.overflow = "hidden";
        gebi("event-title").focus();
      }

      function closeEditPastEventPopup() {
        eventPopupOverlay.classList.remove("active");
        eventPopup.classList.remove("active");
        document.body.style.overflow = "";
      }

      if (closeEventPopupBtn)
        closeEventPopupBtn.addEventListener("click", closeEditPastEventPopup);
      if (eventPopupOverlay)
        eventPopupOverlay.addEventListener("click", (e) => {
          if (e.target === eventPopupOverlay) closeEditPastEventPopup();
        });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && eventPopup.classList.contains("active"))
          closeEditPastEventPopup();
      });

      editPastEventForm?.addEventListener("submit", async function (e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner-mini"></div>Salvataggio...';
        editPastEventFormMessage.style.display = "none";
        editPastEventFormMessage.className = "form-message";

        try {
          const formData = new FormData(this);
          formData.append("action", "update_event"); // Azione per PHP

          const response = await fetch("gestione_eventi.php", {
            method: "POST",
            body: formData,
          });
          const responseText = await response.text();
          let result;
          try {
            result = JSON.parse(responseText);
          } catch (jsonError) {
            throw new Error(
              `Risposta non JSON dal server: ${responseText.substring(0, 200)}`
            );
          }

          if (!response.ok)
            throw new Error(
              result.message || `Errore server: ${response.status}`
            );
          if (result.success) {
            editPastEventFormMessage.textContent =
              result.message || "Evento aggiornato con successo!";
            editPastEventFormMessage.classList.add("success");
            loadPastEventsAdmin(); // Ricarica gli eventi
            setTimeout(closeEditPastEventPopup, 1500);
          } else {
            throw new Error(
              result.message || "Errore durante l'aggiornamento dell'evento."
            );
          }
        } catch (error) {
          console.error("Errore invio form modifica evento passato:", error);
          editPastEventFormMessage.textContent = `Errore: ${error.message}`;
          editPastEventFormMessage.classList.add("error"); // Assicurati di avere una classe .error nel CSS
        } finally {
          editPastEventFormMessage.style.display = "block";
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
        }
      });

      // --- Logica Caricamento e Filtro Eventi Passati per Admin ---
      const eventiPassatiGrid = gebi("eventiPassatiGrid");
      const loadingIndicator = gebi("loadingIndicator");

      function formatDate(dateString) {
        if (!dateString) return "Data non disponibile";
        try {
          const date = new Date(
            dateString.includes("T") ? dateString : dateString + "T00:00:00"
          );
          if (isNaN(date.getTime())) return dateString;
          return date.toLocaleDateString("it-IT", {
            day: "numeric",
            month: "long",
            year: "numeric",
          });
        } catch (e) {
          console.warn("Errore formattazione data:", dateString, e);
          return dateString;
        }
      }

      function createPastEventAdminCard(event) {
        const card = document.createElement("article");
        card.className = "card admin-card"; // Aggiunta classe admin-card se serve per stili specifici
        card.dataset.title = event.titolo?.toLowerCase() || "";
        card.dataset.date = event.datainizio || "";
        card.dataset.speaker = event.relatore?.toLowerCase() || "";

        let imageSrc =
          event.immagine_url && event.immagine_url.trim() !== ""
            ? event.immagine_url
            : "images/default-event-past.jpg";
        let volantinoInfoHtml = "";
        if (event.volantino_url) {
          const volantinoName = event.volantino_url.split("/").pop();
          volantinoInfoHtml = `<p class="card-info"><b>Volantino:</b> <a href="${event.volantino_url}" target="_blank" title="${volantinoName}">Visualizza</a></p>`;
        }

        card.innerHTML = `
            <div class="card-image-container">
                <img src="${imageSrc}" alt="Copertina: ${
          event.titolo || "Evento passato"
        }" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
            </div>
            <div class="card-content">
                <h3>${event.titolo || "Titolo non disponibile"}</h3>
                <p class="card-info">
                    <b>Data:</b> ${formatDate(event.datainizio)}
                    ${
                      event.durata
                        ? `<br><b>Orario/Durata:</b> ${event.durata}`
                        : ""
                    }
                </p>
                <p class="card-info">
                    <b>${event.prefisso_relatore || "Relatore"}:</b> ${
          event.relatore || "N/D"
        }
                    ${
                      event.associazione
                        ? `<br><b>Associazione:</b> ${event.associazione}`
                        : ""
                    }
                </p>
                <p class="card-description">${
                  event.descrizione || "Nessuna descrizione breve disponibile."
                }</p>
                 <p class="card-info">
                    <b>Posti:</b> <span class="posti-disponibili">${
                      event.posti_disponibili !== null
                        ? event.posti_disponibili
                        : "N/D"
                    }</span>
                    ${
                      event.costo !== null
                        ? parseFloat(event.costo) > 0
                          ? `<br><b>Costo:</b> ${parseFloat(
                              event.costo
                            ).toFixed(2)} ‚Ç¨`
                          : parseFloat(event.costo) === 0
                          ? "<br><b>Costo:</b> Offerta libera"
                          : ""
                        : ""
                    }
                </p>
                <p class="card-info">
                    Stato Prenotazioni: ${
                      event.flagprenotabile
                        ? '<span class="status-prenotabile">Aperte</span>'
                        : '<span class="status-non-prenotabile">Chiuse</span>'
                    }
                </p>
                ${volantinoInfoHtml}
                <div class="card-actions admin-actions">
                    <button class="card-btn btn-edit card-btn-secondary" data-event-id="${
                      event.idevento
                    }">Modifica</button>
                    <button class="card-btn btn-delete card-btn-primary" data-event-id="${
                      event.idevento
                    }">Elimina</button>
                </div>
            </div>
        `;

        // Event Listener per Modifica
        card.querySelector(".btn-edit").addEventListener("click", function () {
          const eventId = this.dataset.eventId;
          const eventToEdit = allPastEventsAdmin.find(
            (e) => e.idevento == eventId
          ); // Usa == per confronto stringa/numero
          if (eventToEdit) {
            openEditPastEventPopup(eventToEdit);
          } else {
            alert("Dettagli evento non trovati per la modifica.");
          }
        });

        // Event Listener per Elimina
        card
          .querySelector(".btn-delete")
          .addEventListener("click", async function () {
            const eventId = this.dataset.eventId;
            const eventToDelete = allPastEventsAdmin.find(
              (e) => e.idevento == eventId
            );
            const eventTitle = eventToDelete
              ? eventToDelete.titolo
              : "questo evento";

            if (
              confirm(
                `Sei sicuro di voler eliminare l'evento "${eventTitle}"? L'azione √® irreversibile.`
              )
            ) {
              const deleteBtn = this;
              const originalDeleteBtnText = deleteBtn.innerHTML;
              deleteBtn.disabled = true;
              deleteBtn.innerHTML =
                '<div class="spinner-mini" style="border-top-color: white;"></div>Elimino...';
              try {
                const formData = new FormData();
                formData.append("action", "delete_event");
                formData.append("event_id", eventId);

                const response = await fetch("gestione_eventi.php", {
                  method: "POST",
                  body: formData,
                });
                const resText = await response.text();
                let res;
                try {
                  res = JSON.parse(resText);
                } catch (e) {
                  throw new Error(
                    "Risposta non JSON (delete): " + resText.substring(0, 100)
                  );
                }

                if (!response.ok)
                  throw new Error(
                    res.message || `Errore HTTP ${response.status}`
                  );
                if (res.success) {
                  alert(res.message || "Evento eliminato con successo.");
                  loadPastEventsAdmin(); // Ricarica la lista
                } else {
                  throw new Error(res.message || "Eliminazione fallita.");
                }
              } catch (error) {
                console.error(
                  "Errore durante l'eliminazione dell'evento passato:",
                  error
                );
                alert(`Errore eliminazione: ${error.message}`);
              } finally {
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalDeleteBtnText;
              }
            }
          });
        return card;
      }

      async function loadPastEventsAdmin() {
        if (!eventiPassatiGrid || !loadingIndicator) return;
        loadingIndicator.classList.add("visible");
        eventiPassatiGrid.innerHTML = "";

        try {
          // Aggiungiamo un parametro per distinguere questa chiamata se necessario nel PHP,
          // o semplicemente usiamo get_past_events.php che gi√† ordina DESC.
          // Per coerenza con eventiincorsoAdmin, potresti voler aggiungere admin_view=true se get_past_events.php lo supportasse.
          // Altrimenti, get_past_events.php dovrebbe gi√† funzionare.
          const response = await fetch("get_past_events.php");
          if (!response.ok) {
            throw new Error(
              `Errore HTTP: ${response.status} ${response.statusText}`
            );
          }
          const result = await response.json();

          if (result.success && result.data) {
            allPastEventsAdmin = result.data;
            if (allPastEventsAdmin.length > 0) {
              allPastEventsAdmin.forEach((event) => {
                eventiPassatiGrid.appendChild(createPastEventAdminCard(event));
              });
            } else {
              eventiPassatiGrid.innerHTML =
                '<p class="no-events">Nessun evento passato trovato nell\'archivio.</p>';
            }
          } else {
            throw new Error(
              result.message ||
                "Errore nel caricamento degli eventi passati per admin."
            );
          }
        } catch (error) {
          console.error("Errore caricamento eventi passati (admin):", error);
          eventiPassatiGrid.innerHTML = `<p class="no-events error-message">Si √® verificato un errore durante il caricamento degli eventi passati. (${error.message}) <button onclick="loadPastEventsAdmin()" class="btn-popup">Riprova</button></p>`;
        } finally {
          loadingIndicator.classList.remove("visible");
          filterEventsAdmin(); // Applica filtri dopo caricamento
        }
      }

      function filterEventsAdmin() {
        if (!eventiPassatiGrid) return;

        const titleFilter = gebi("searchTitle").value.toLowerCase().trim();
        const dateFilter = gebi("searchDate").value; // Formato YYYY-MM
        const speakerFilter = gebi("searchSpeaker").value.toLowerCase().trim();

        const cards = eventiPassatiGrid.querySelectorAll(".card");
        let visibleCards = 0;
        let hasActiveFilters = titleFilter || dateFilter || speakerFilter;

        cards.forEach((card) => {
          const eventTitle = card.dataset.title || "";
          const eventDate = card.dataset.date || ""; // YYYY-MM-DD
          const eventSpeaker = card.dataset.speaker || "";

          let titleMatch = !titleFilter || eventTitle.includes(titleFilter);
          let dateMatch = true;
          if (dateFilter) {
            const eventYearMonth = eventDate.substring(0, 7);
            dateMatch = eventYearMonth === dateFilter;
          }
          let speakerMatch =
            !speakerFilter || eventSpeaker.includes(speakerFilter);

          if (titleMatch && dateMatch && speakerMatch) {
            card.style.display = "flex"; // o 'block', a seconda del tuo CSS per .card
            visibleCards++;
          } else {
            card.style.display = "none";
          }
        });

        // Gestione messaggio "Nessun risultato"
        let noResultsMessage = gebi("noResultsMessageAdmin");
        if (
          visibleCards === 0 &&
          allPastEventsAdmin.length > 0 &&
          hasActiveFilters
        ) {
          if (!noResultsMessage) {
            noResultsMessage = document.createElement("p");
            noResultsMessage.id = "noResultsMessageAdmin";
            noResultsMessage.className = "no-events";
            eventiPassatiGrid.appendChild(noResultsMessage);
          }
          noResultsMessage.textContent =
            "Nessun evento passato corrisponde ai criteri di ricerca.";
          noResultsMessage.style.display = "block";
        } else if (noResultsMessage) {
          noResultsMessage.style.display = "none";
        }

        // Se non ci sono eventi caricati affatto (indipendentemente dai filtri)
        if (allPastEventsAdmin.length === 0 && !gebi("noEventsInitially")) {
          if (noResultsMessage) noResultsMessage.style.display = "none"; // Nascondi msg filtro se non ci sono eventi
          const p = eventiPassatiGrid.querySelector(".no-events");
          if (p && p.textContent.includes("Nessun evento passato trovato")) {
            // Messaggio gi√† presente da loadPastEventsAdmin
          } else if (!p) {
            // solo se non c'√® gi√† un messaggio di "nessun evento"
            const initialNoEvents = document.createElement("p");
            initialNoEvents.id = "noEventsInitially";
            initialNoEvents.className = "no-events";
            initialNoEvents.textContent =
              "Nessun evento passato trovato nell'archivio.";
            eventiPassatiGrid.appendChild(initialNoEvents);
          }
        }
      }

      // Inizializzazione al caricamento della pagina
      document.addEventListener("DOMContentLoaded", () => {
        updateAdminNavbarUI(); // Gestisce UI e pseudo-autenticazione Admin
        gebi("currentYear").textContent = new Date().getFullYear();
        loadPastEventsAdmin(); // Carica gli eventi passati per admin

        gebi("searchTitle").addEventListener("input", filterEventsAdmin);
        gebi("searchDate").addEventListener("change", filterEventsAdmin);
        gebi("searchSpeaker").addEventListener("input", filterEventsAdmin);

        updatePriceFieldVisibility(); // Per il popup di modifica
      });
    </script>
  </body>
</html>
