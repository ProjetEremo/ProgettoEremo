<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Admin Dashboard - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="page-dashboard">

<header class="navbar-container" id="navbarContainer">
    <nav class="navbar">
        <div class="logo">
            <a href="indexadmin.html"> <span class="emoji">üèîÔ∏è</span>
                <h2>Eremo Frate Francesco - Admin</h2>
            </a>
        </div>
        <div class="right-menu">
            <div class="user-dropdown" id="userDropdownContainer">
                <button class="user-btn" onclick="toggleUserMenu()" aria-haspopup="true" aria-expanded="false">
                    <span class="user-avatar" id="navbar-avatar">üë§</span>
                    <span class="user-name" id="navbar-username">Admin</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="areapersonale.html">Il mio profilo</a> <a href="eventiincorsoAdmin.html">Gestione Eventi Estesa</a> <a href="#" onclick="logout()">Esci</a>
                </div>
            </div>
            <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="dashboard.html" onclick="closeMobileMenu()">Dashboard</a>
        <a href="areapersonale.html" onclick="closeMobileMenu()">Il mio profilo</a>
        <a href="eventiincorsoAdmin.html" onclick="closeMobileMenu()">Gestione Eventi Estesa</a>
        <a href="#" onclick="logout(); closeMobileMenu();">Esci</a>
    </div>
</header>

<main class="dashboard-main">
    <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>

    <section class="dashboard-quick-stats">
        <div class="stat-card">
            <i class="fas fa-calendar-alt"></i>
            <div id="total-events" class="stat-value">0</div>
            <div class="stat-label">Eventi Totali</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <div id="total-bookings" class="stat-value">0</div>
            <div class="stat-label">Prenotazioni Totali</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-user-check"></i>
            <div id="total-participants" class="stat-value">0</div>
            <div class="stat-label">Partecipanti Totali</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-comments"></i>
            <div id="total-comments" class="stat-value">0</div>
            <div class="stat-label">Commenti Totali</div>
        </div>
    </section>

    <section class="dashboard-section" id="eventManagementSection">
        <h2><i class="fas fa-calendar-check"></i> Gestione Eventi</h2>
        <div class="admin-event-grid" id="adminEventList">
            <p><i class="fas fa-spinner fa-spin"></i> Caricamento eventi...</p>
        </div>
    </section>
</main>

<div id="uploadMediaModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('uploadMediaModal')">&times;</span>
        <h3>Gestisci Media per Evento: <span id="uploadMediaEventTitle"></span></h3>
        <div class="modal-content-scrollable">
            <h4>Carica Nuovi Media</h4>
            <form id="uploadMediaForm" class="media-upload-form">
                <input type="hidden" id="uploadMediaEventId" name="eventId">
                <div class="form-group">
                    <label for="mediaFiles">Seleziona Immagini/Video/PDF:</label>
                    <input type="file" id="mediaFiles" name="mediaFiles[]" multiple accept="image/*,video/*,.pdf">
                </div>
                <div class="form-group">
                    <label for="mediaDescription">Descrizione (opzionale):</label>
                    <textarea id="mediaDescription" name="description" rows="3" placeholder="Breve descrizione del media..."></textarea>
                </div>
                <button type="submit" class="btn-admin btn-admin-secondary"><i class="fas fa-upload"></i> Carica Media</button>
            </form>
            <div id="uploadMediaFeedback" style="margin-top:1rem;"></div>

            <div class="existing-media-section">
                <h4>Media Esistenti</h4>
                <div id="existingMediaContainer">
                    <p>Nessun media attualmente caricato per questo evento.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="manageCommentsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('manageCommentsModal')">&times;</span>
        <h3>Gestisci Commenti per Evento: <span id="commentsEventTitle"></span></h3>
        <div class="modal-content-scrollable">
            <div id="commentsListContainer">
                <p><i class="fas fa-spinner fa-spin"></i> Caricamento commenti...</p>
            </div>
        </div>
        <div id="commentsManagementFeedback" style="margin-top:1rem;"></div>
    </div>
</div>

<footer>
    <p>¬© <span id="currentYear"></span> Eremo Frate Francesco. Operazioni Admin.</p>
</footer>

<script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // --- Navbar & Mobile Menu Logic (invariato) ---
    const SnavbarContainer = document.getElementById('navbarContainer');
    let SlastScroll = 0;
    if (SnavbarContainer) {
        window.addEventListener('scroll', function() {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            if (currentScroll <= 50) { SnavbarContainer.classList.remove('hidden'); SlastScroll = 0; return; }
            if (currentScroll > SlastScroll && !SnavbarContainer.classList.contains('hidden')) {
                SnavbarContainer.classList.add('hidden');
            } else if (currentScroll < SlastScroll && SnavbarContainer.classList.contains('hidden')) {
                SnavbarContainer.classList.remove('hidden');
            }
            SlastScroll = currentScroll <= 0 ? 0 : currentScroll;
        });
    }
    function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        const hamburger = document.querySelector(".navbar .hamburger");
        if(mobileMenu && hamburger){
            mobileMenu.classList.toggle("open");
            hamburger.classList.toggle("open");
            document.body.style.overflow = mobileMenu.classList.contains("open") ? 'hidden' : '';
        }
    }
    function closeMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        const hamburger = document.querySelector(".navbar .hamburger");
        if(mobileMenu && hamburger){
            mobileMenu.classList.remove("open");
            hamburger.classList.remove("open");
            document.body.style.overflow = '';
        }
    }
    function toggleUserMenu() {
        const dropdown = document.querySelector('#userDropdownContainer .dropdown-menu');
        const button = document.querySelector('#userDropdownContainer .user-btn');
        if(dropdown && button){
            const isOpen = dropdown.style.display === 'block';
            dropdown.style.display = isOpen ? 'none' : 'block';
            button.setAttribute('aria-expanded', !isOpen);
        }
    }
    document.addEventListener('click', function(event) {
        const dropdownContainer = document.getElementById('userDropdownContainer');
        if (dropdownContainer && !dropdownContainer.contains(event.target)) {
            const menu = dropdownContainer.querySelector('.dropdown-menu');
            const btn = dropdownContainer.querySelector('.user-btn');
            if (menu && menu.style.display === 'block') {
                menu.style.display = 'none';
                if(btn) btn.setAttribute('aria-expanded', 'false');
            }
        }
        const mobileMenuEl = document.getElementById("mobileMenu");
        const hamburgerEl = document.querySelector(".navbar .hamburger");
        if (mobileMenuEl && mobileMenuEl.classList.contains("open") && hamburgerEl && !hamburgerEl.contains(event.target) && !mobileMenuEl.contains(event.target)) {
            closeMobileMenu();
        }
    });
    function logout() {
        localStorage.removeItem('adminUserEFF');
        alert('Logout effettuato.');
        window.location.href = 'login_admin.html'; // O la tua pagina di login admin
    }
    // --- Fine Navbar & Mobile Menu ---


    // --- Logica Dashboard Specifica ---
    const adminEventList = document.getElementById('adminEventList');

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('active');
        document.body.style.overflow = '';
        if (modalId === 'uploadMediaModal') {
            const uploadForm = document.getElementById('uploadMediaForm');
            const feedbackDiv = document.getElementById('uploadMediaFeedback');
            const existingMediaContainer = document.getElementById('existingMediaContainer');
            if (uploadForm) uploadForm.reset();
            if (feedbackDiv) feedbackDiv.innerHTML = '';
            if (existingMediaContainer) existingMediaContainer.innerHTML = '<p>Caricamento media...</p>';
        }
        if (modalId === 'manageCommentsModal') {
            const commentsListContainer = document.getElementById('commentsListContainer');
            const feedbackDiv = document.getElementById('commentsManagementFeedback');
            if (commentsListContainer) commentsListContainer.innerHTML = '<p>Caricamento commenti...</p>';
            if (feedbackDiv) feedbackDiv.innerHTML = '';
        }
    }
    window.onclick = function(event) {
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal && modal.classList.contains('active')) {
                closeModal(modal.id);
            }
        });
    };
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                closeModal(activeModal.id);
            }
        }
    });

    function sanitizeText(text) {
        if (text === null || typeof text === 'undefined') return '';
        const element = document.createElement('div');
        element.innerText = String(text);
        return element.innerHTML;
    }
    function sanitizeForAttribute(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
    }
    function formatDbDate(dateString) {
        if (!dateString) return 'N/D';
        const date = new Date(dateString.replace(/-/g, '/')); // Assicura compatibilit√† cross-browser per il parsing
        if (isNaN(date.getTime())) return dateString; // Se non √® una data valida, ritorna la stringa originale
        return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    async function fetchDashboardData() {
        if (!adminEventList) { console.error("Elemento adminEventList non trovato."); return; }
        adminEventList.innerHTML = '<div class="loading-message-dashboard"><i class="fas fa-spinner fa-spin"></i> Caricamento dati dashboard...</div>';
        try {
            const response = await fetch('get_dashboard_event_data.php'); // Questo script PHP deve fornire anche media_count per evento
            if (!response.ok) throw new Error(`Errore HTTP: ${response.status} ${response.statusText}`);
            const data = await response.json();
            if (data.success && data.events) {
                renderAdminEventsWithGroupedBookings(data.events);
                updateQuickStats(data.stats || {});
            } else {
                adminEventList.innerHTML = `<div class="error-message-dashboard"><p>Errore nel caricamento dati: ${data.message || 'Nessun evento trovato o formato dati non corretto.'}</p></div>`;
            }
        } catch (error) {
            console.error('Errore fetchDashboardData:', error);
            adminEventList.innerHTML = `<div class="error-message-dashboard"><p>Impossibile caricare i dati: ${error.message}</p></div>`;
        }
    }

    function updateQuickStats(stats) {
        const elTotalEvents = document.getElementById('total-events');
        const elTotalBookings = document.getElementById('total-bookings');
        const elTotalParticipants = document.getElementById('total-participants');
        const elTotalComments = document.getElementById('total-comments');

        if(elTotalEvents) elTotalEvents.textContent = stats.totalEvents || 0;
        if(elTotalBookings) elTotalBookings.textContent = stats.totalBookings || 0;
        if(elTotalParticipants) elTotalParticipants.textContent = stats.totalParticipants || 0;
        if(elTotalComments) elTotalComments.textContent = stats.totalComments || 0;
    }

    // NUOVA FUNZIONE PER TOGGLE DETTAGLI CARD
    function toggleAdminEventDetails(toggleButton, eventId) {
        const detailsDiv = document.getElementById(`details-event-${eventId}`);
        const icon = toggleButton.querySelector('i');
        if (detailsDiv && icon) {
            detailsDiv.classList.toggle('active');
            icon.classList.toggle('fa-chevron-down');
            icon.classList.toggle('fa-chevron-up');
            toggleButton.setAttribute('aria-expanded', detailsDiv.classList.contains('active'));
        }
    }

    // --- MODIFIED: renderAdminEventsWithGroupedBookings ---
    function renderAdminEventsWithGroupedBookings(events) {
        if (!adminEventList) return;
        if (events.length === 0) {
            adminEventList.innerHTML = '<div class="no-events-dashboard"><p>Nessun evento da gestire al momento.</p></div>';
            return;
        }
        adminEventList.innerHTML = ''; // Pulisce la lista

        events.forEach(event => {
            const eventCard = document.createElement('article');
            eventCard.className = 'admin-event-card';
            eventCard.id = `admin-event-${event.IDEvento}`;

            const postiOccupati = event.posti_occupati || 0;
            const postiConfigurati = event.posti_configurati_totali !== undefined ? event.posti_configurati_totali : (postiOccupati + (parseInt(event.PostiDisponibili, 10) || 0));
            // Assumiamo che lo script PHP `get_dashboard_event_data.php` possa fornire `media_count` e `comment_count`
            // Se `comment_count` √® gi√† presente nel tuo `event` object, usalo.
            const commentCount = event.comment_count || 0;
            // `media_count` √® un placeholder, dovrai aggiungerlo al tuo script PHP
            const mediaCount = event.media_count || 0; // Assicurati che 'get_dashboard_event_data.php' fornisca questo.

            let imageSrc = (event.immagine_url && event.immagine_url.trim() !== '') ? event.immagine_url : 'images/default-event-admin.jpg'; // Immagine di default specifica per admin card se vuoi

            eventCard.innerHTML = `
                <div class="admin-event-card-image-container">
                    <img src="${imageSrc}" alt="Copertina: ${sanitizeText(event.Titolo)}" class="admin-event-card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
                </div>
                <div class="admin-event-card-content">
                    <div class="admin-event-card-header">
                        <h3 class="admin-event-title">${sanitizeText(event.Titolo)} (ID: ${event.IDEvento})</h3>
                        <span class="admin-event-date">Data: ${formatDbDate(event.Data)} ${sanitizeText(event.Durata) || ''}</span>
                    </div>
                    <div class="admin-event-card-quick-stats">
                        <div class="stat-item" title="Posti Occupati / Posti Configurati"><i class="fas fa-chair"></i> ${postiOccupati} / ${postiConfigurati}</div>
                        <div class="stat-item" title="Totale Prenotazioni Individuali"><i class="fas fa-users"></i> ${event.elenco_prenotazioni?.length || 0} Pren.</div>
                        <div class="stat-item" title="Numero Media Caricati"><i class="fas fa-photo-video"></i> ${mediaCount} Media</div>
                        <div class="stat-item" title="Numero Commenti"><i class="fas fa-comments"></i> ${commentCount} Commenti</div>
                    </div>
                    <div class="admin-event-card-actions">
                        <button class="btn-admin btn-admin-secondary" onclick="window.open('generate_event_pdf.php?event_id=${event.IDEvento}', '_blank')" title="Scarica PDF Lista Partecipanti">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn-admin btn-admin-warning" onclick="openManageMediaModal(${event.IDEvento}, '${sanitizeForAttribute(event.Titolo)}')" title="Gestisci media evento">
                            <i class="fas fa-photo-video"></i> Media
                        </button>
                        <button class="btn-admin btn-admin-info" onclick="openManageCommentsModal(${event.IDEvento}, '${sanitizeForAttribute(event.Titolo)}')" title="Gestisci commenti evento">
                            <i class="fas fa-comments"></i> Commenti
                        </button>
                        <button class="btn-admin btn-admin-danger" onclick="confirmDeleteEvent(${event.IDEvento}, '${sanitizeForAttribute(event.Titolo)}')" title="Elimina questo evento">
                            <i class="fas fa-trash-alt"></i> Elimina
                        </button>
                    </div>
                    <div class="admin-event-card-expand-toggle" onclick="toggleAdminEventDetails(this, ${event.IDEvento})" role="button" aria-expanded="false" aria-controls="details-event-${event.IDEvento}">
                        <span>Gestisci Prenotazioni</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                <div class="admin-event-card-details" id="details-event-${event.IDEvento}">
                    <h4>Prenotazioni Effettuate (${event.elenco_prenotazioni?.length || 0}):</h4>
                    <div class="user-bookings-list" id="bookingsForEvent-${event.IDEvento}">
                        ${renderGroupedBookings(event.elenco_prenotazioni || [], event.IDEvento)}
                    </div>
                </div>
            `;
            adminEventList.appendChild(eventCard);
        });
    }


    function renderGroupedBookings(bookings, eventId) {
        if (!bookings || bookings.length === 0) {
            return '<p style="text-align:center; margin:1rem 0; font-size:0.9rem; color: var(--gray-dark);">Nessuna prenotazione per questo evento.</p>';
        }
        let html = '';
        bookings.forEach(booking => {
            const nomeCompletoUtente = `${sanitizeText(booking.NomeUtenteRegistrato || '')} ${sanitizeText(booking.CognomeUtenteRegistrato || '')}`.trim();
            const displayNomeUtente = nomeCompletoUtente || sanitizeText(booking.Contatto); // Fallback a Contatto se nome/cognome non ci sono
            html += `<div class="user-booking-group">
                        <h5>Prenotazione di: ${displayNomeUtente} <small>(${sanitizeText(booking.Contatto)})</small></h5>
                        <div class="single-booking-details">
                            <p><strong>ID Prenotazione: ${booking.idPrenotazione}</strong> - Posti Prenotati: ${booking.NumeroPosti}</p>
                            <strong>Partecipanti:</strong>
                            ${booking.partecipanti_della_prenotazione && booking.partecipanti_della_prenotazione.length > 0 ?
                `<ul class="participant-list-inline">
                                    ${booking.partecipanti_della_prenotazione.map(p => `<li>${sanitizeText(p.Nome)} ${sanitizeText(p.Cognome)}</li>`).join('')}
                                 </ul>` :
                '<p><small>Nessun dettaglio partecipante.</small></p>'
            }
                            <button class="btn-admin btn-admin-danger btn-sm"
                                    onclick="confirmCancelBooking(${booking.idPrenotazione}, ${eventId}, ${booking.NumeroPosti}, '${sanitizeForAttribute(displayNomeUtente)}')"
                                    title="Annulla questa specifica prenotazione">
                                <i class="fas fa-times-circle"></i> Annulla Prenotazione
                            </button>
                         </div>
                     </div>`;
        });
        return html;
    }

    function confirmCancelBooking(idPrenotazione, eventId, numPosti, nomeUtente) {
        if (confirm(`Sei sicuro di voler annullare la prenotazione ID ${idPrenotazione} (${numPosti} posti) di ${nomeUtente} per l'evento ID ${eventId}? I posti torneranno disponibili e gli utenti in coda (se presenti) verranno notificati.`)) {
            cancelBooking(idPrenotazione);
        }
    }

    async function cancelBooking(idPrenotazione) {
        // Trova il feedback placeholder relativo alla card specifica
        const bookingGroupElement = document.querySelector(`button[onclick*="confirmCancelBooking(${idPrenotazione},"]`)?.closest('.user-booking-group');
        let feedbackPlaceholder = bookingGroupElement?.querySelector('.cancel-feedback-placeholder');

        if (!feedbackPlaceholder && bookingGroupElement) {
            feedbackPlaceholder = document.createElement('p');
            feedbackPlaceholder.className = 'cancel-feedback-placeholder'; // Aggiungi una classe per stilizzarlo se necessario
            bookingGroupElement.insertAdjacentElement('afterend', feedbackPlaceholder);
        } else if (!bookingGroupElement) { // Fallback se non troviamo il booking group (improbabile)
            feedbackPlaceholder = document.getElementById(`admin-event-list`) || adminEventList; // Usa un contenitore generico
            const tempP = document.createElement('p');
            tempP.id = `cancel-feedback-${idPrenotazione}`;
            feedbackPlaceholder.prepend(tempP);
            feedbackPlaceholder = tempP;
        }

        if(feedbackPlaceholder) feedbackPlaceholder.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Annullamento prenotazione ID ${idPrenotazione}...`;


        try {
            const formData = new FormData();
            formData.append('id_prenotazione', idPrenotazione);
            const response = await fetch('annulla_prenotazione_admin.php', { method: 'POST', body: formData });
            const result = await response.json();

            if (feedbackPlaceholder) {
                if (result.success) {
                    feedbackPlaceholder.className = 'success-message';
                    feedbackPlaceholder.innerHTML = `<i class="fas fa-check-circle"></i> ${sanitizeText(result.message)}`;
                    fetchDashboardData(); // Ricarica tutti i dati per aggiornare la card e le stats globali
                } else {
                    feedbackPlaceholder.className = 'error-message';
                    feedbackPlaceholder.innerHTML = `<i class="fas fa-exclamation-circle"></i> Errore: ${sanitizeText(result.message || 'Impossibile annullare.')}`;
                }
                setTimeout(() => { feedbackPlaceholder.remove(); }, 7000);
            }
        } catch (error) {
            console.error("Errore AJAX annullamento:", error);
            if (feedbackPlaceholder) {
                feedbackPlaceholder.className = 'error-message';
                feedbackPlaceholder.innerHTML = `<i class="fas fa-exclamation-circle"></i> Errore connessione: ${sanitizeText(error.message)}`;
                setTimeout(() => { feedbackPlaceholder.remove(); }, 7000);
            }
        }
    }

    async function openManageMediaModal(eventId, eventTitle) {
        const eventIdInput = document.getElementById('uploadMediaEventId');
        const eventTitleEl = document.getElementById('uploadMediaEventTitle');
        const existingMediaContainer = document.getElementById('existingMediaContainer');
        const feedbackDiv = document.getElementById('uploadMediaFeedback');
        const uploadForm = document.getElementById('uploadMediaForm');

        if (eventIdInput) eventIdInput.value = eventId;
        if (eventTitleEl) eventTitleEl.textContent = sanitizeText(eventTitle);
        if (uploadForm) uploadForm.reset();
        if (feedbackDiv) feedbackDiv.innerHTML = '';
        if (existingMediaContainer) existingMediaContainer.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Caricamento media...</p>';

        openModal('uploadMediaModal');

        try {
            const response = await fetch(`manage_event_media.php?action=get_event_media&event_id=${eventId}`);
            const result = await response.json();
            if (result.success && result.media) {
                renderExistingMedia(result.media, eventId);
            } else {
                if (existingMediaContainer) existingMediaContainer.innerHTML = `<p>Nessun media o errore: ${sanitizeText(result.message || 'Sconosciuto.')}</p>`;
            }
        } catch (error) {
            console.error('Errore recupero media:', error);
            if (existingMediaContainer) existingMediaContainer.innerHTML = `<p>Errore connessione: ${sanitizeText(error.message)}</p>`;
        }
    }

    function renderExistingMedia(mediaItems, eventId) {
        const container = document.getElementById('existingMediaContainer');
        if (!container) return;
        if (mediaItems.length === 0) {
            container.innerHTML = '<p>Nessun media attualmente caricato.</p>'; return;
        }
        let html = '<div class="existing-media-grid">';
        mediaItems.forEach(item => {
            const filename = item.url_media ? item.url_media.split('/').pop() : 'File';
            html += `<div class="existing-media-item">`;
            if (item.tipo_media === 'image') {
                html += `<img src="${item.url_media}" alt="${sanitizeText(item.Descrizione) || filename}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="media-icon-placeholder" style="display:none;"><i class="fas fa-image"></i></div>`;
            } else if (item.tipo_media === 'video') {
                // Per i video, potrebbe essere meglio un placeholder se il caricamento √® pesante
                html += `<div class="media-icon-placeholder" title="Video: ${sanitizeText(filename)}"><i class="fas fa-video"></i></div>`;
                // Potresti aggiungere un link per aprirlo o un piccolo player se strettamente necessario nel modal
            } else { // PDF o altro
                html += `<a href="${item.url_media}" target="_blank" title="Apri ${sanitizeText(filename)}">
                            <div class="media-icon-placeholder"><i class="fas fa-file-alt"></i></div>
                         </a>`;
            }
            html += `<p class="media-filename" title="${item.url_media}">${sanitizeText(filename)}</p>`;
            if (item.Descrizione) {
                html += `<p class="media-description"><em>${sanitizeText(item.Descrizione)}</em></p>`;
            }
            html += `<button class="btn-admin btn-admin-danger btn-sm btn-delete-media" data-media-id="${item.id_media}" data-event-id="${eventId}" title="Elimina questo media"><i class="fas fa-trash-alt"></i> Elimina</button>`;
            html += `</div>`;
        });
        html += '</div>';
        container.innerHTML = html;

        container.querySelectorAll('.btn-delete-media').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questo media? L\'azione √® irreversibile.')) {
                    deleteMediaItem(this.dataset.mediaId, this.dataset.eventId);
                }
            });
        });
    }

    async function deleteMediaItem(mediaId, eventId) {
        const feedbackDiv = document.getElementById('uploadMediaFeedback');
        if(feedbackDiv) feedbackDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Eliminazione...</p>';
        try {
            const formData = new FormData();
            formData.append('action', 'delete_event_media');
            formData.append('media_id', mediaId);

            const response = await fetch('manage_event_media.php', { method: 'POST', body: formData });
            const result = await response.json();

            if (result.success) {
                if(feedbackDiv) feedbackDiv.innerHTML = `<p class="success-message">${sanitizeText(result.message)}</p>`;
                const titleEl = document.getElementById('uploadMediaEventTitle');
                // Ricarica i media nel modal e aggiorna il conteggio nella card principale
                openManageMediaModal(eventId, titleEl ? titleEl.textContent : "Evento");
                fetchDashboardData(); // Per aggiornare il conteggio media sulla card
            } else {
                if(feedbackDiv) feedbackDiv.innerHTML = `<p class="error-message">Errore: ${sanitizeText(result.message)}</p>`;
            }
        } catch (error) {
            console.error('Errore eliminazione media:', error);
            if(feedbackDiv) feedbackDiv.innerHTML = `<p class="error-message">Errore connessione: ${sanitizeText(error.message)}</p>`;
        }
        setTimeout(() => { if(feedbackDiv) feedbackDiv.innerHTML = ''; }, 4000);
    }


    const uploadMediaForm = document.getElementById('uploadMediaForm');
    if(uploadMediaForm) {
        uploadMediaForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const eventId = document.getElementById('uploadMediaEventId').value;
            const files = document.getElementById('mediaFiles').files;
            const description = document.getElementById('mediaDescription').value;
            const feedbackDiv = document.getElementById('uploadMediaFeedback');

            if (!feedbackDiv) { console.error("Feedback div mancante"); return; }

            if (files.length === 0) {
                feedbackDiv.innerHTML = '<p class="error-message">Seleziona almeno un file.</p>'; return;
            }
            feedbackDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Caricamento...</p>';

            const formData = new FormData();
            formData.append('action', 'upload_media');
            formData.append('event_id', eventId);
            formData.append('description', description);
            for (let i = 0; i < files.length; i++) {
                formData.append('mediaFiles[]', files[i]);
            }

            try {
                const response = await fetch('manage_event_media.php', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    feedbackDiv.innerHTML = `<p class="success-message">${sanitizeText(result.message)}</p>`;
                    const titleEl = document.getElementById('uploadMediaEventTitle');
                    openManageMediaModal(eventId, titleEl ? titleEl.textContent : "Evento"); // Ricarica i media nel modal
                    fetchDashboardData(); // Per aggiornare il conteggio media sulla card principale
                    this.reset();
                } else {
                    feedbackDiv.innerHTML = `<p class="error-message">Errore: ${sanitizeText(result.message)}</p>`;
                }
            } catch (error) {
                console.error('Errore uploadMedia:', error);
                feedbackDiv.innerHTML = `<p class="error-message">Errore: ${sanitizeText(error.message)}</p>`;
            }
            setTimeout(() => { if(feedbackDiv) feedbackDiv.innerHTML = ''; }, 5000);
        });
    }

    async function openManageCommentsModal(eventId, eventTitle) {
        const commentsEventTitleEl = document.getElementById('commentsEventTitle');
        const commentsListContainerEl = document.getElementById('commentsListContainer');
        const feedbackDiv = document.getElementById('commentsManagementFeedback');

        if(commentsEventTitleEl) commentsEventTitleEl.textContent = sanitizeText(eventTitle);
        if(commentsListContainerEl) commentsListContainerEl.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Caricamento commenti...</p>';
        if(feedbackDiv) feedbackDiv.innerHTML = '';

        openModal('manageCommentsModal');

        try {
            const response = await fetch(`manage_comments_admin.php?action=get_comments&event_id=${eventId}`);
            const result = await response.json();

            if (result.success && result.comments) {
                if(commentsListContainerEl) renderCommentsForAdminThreaded(result.comments, eventId, commentsListContainerEl);
            } else {
                if(commentsListContainerEl) commentsListContainerEl.innerHTML = `<p>${sanitizeText(result.message || 'Nessun commento.')}</p>`;
            }
        } catch (error) {
            console.error('Errore fetchComments admin:', error);
            if(commentsListContainerEl) commentsListContainerEl.innerHTML = `<p>Impossibile caricare: ${sanitizeText(error.message)}</p>`;
        }
    }

    function renderCommentsForAdminThreaded(comments, eventId, parentElement, depth = 0) {
        if (depth === 0 && parentElement) parentElement.innerHTML = ''; // Pulisci il contenitore solo al primo livello

        if (!comments || comments.length === 0) {
            if (depth === 0 && parentElement) parentElement.innerHTML = '<p>Nessun commento per questo evento.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.className = depth > 0 ? 'comment-replies-list' : 'comment-thread-list';
        // Lo stile per l'indentazione √® meglio gestirlo via CSS (`.comment-replies-list { margin-left: ... }`)
        // Ma se vuoi forzarlo via JS: if (depth > 0) ul.style.marginLeft = `${depth * 15}px`;

        comments.forEach(comment => {
            const li = document.createElement('li');
            li.className = 'comment-item-admin';
            li.innerHTML = `
                <div class="comment-item-content">
                    <p>
                        <strong>${sanitizeText(comment.utente_display_name)}</strong>
                        <small>(${sanitizeText(comment.data_creazione_formattata)})</small>
                        <small>[ID: ${comment.Progressivo}${comment.CodRisposta ? `, Risp. a ID: ${comment.CodRisposta}` : ''}]</small>
                    </p>
                    <p class="comment-text-admin"><em>"${sanitizeText(comment.Descrizione)}"</em></p>
                </div>
                <button class="btn-admin btn-admin-danger btn-sm" onclick="deleteAdminComment(${comment.Progressivo}, ${eventId})" title="Elimina questo commento e le sue risposte dirette">
                    <i class="fas fa-trash-alt"></i> Elimina
                </button>
            `;
            // Se non √® una risposta (depth 0) oppure se √® una risposta e il genitore √® un UL (per risposte dirette), appendi a ul.
            // Se √® una risposta e il genitore √® un LI (per risposte nidificate), appendi a li.
            if (depth === 0 || (parentElement && parentElement.tagName === 'UL')) {
                ul.appendChild(li);
            } else if (parentElement && parentElement.tagName === 'LI') {
                parentElement.appendChild(li); // Aggiungi direttamente all'LI del commento padre per la nidificazione
            }


            if (comment.replies && comment.replies.length > 0) {
                // Per le risposte, il nuovo `ul` verr√† creato e appeso DENTRO l' `li` del commento padre.
                renderCommentsForAdminThreaded(comment.replies, eventId, li, depth + 1);
            }
        });

        // Aggiungi l'ul principale al parentElement solo se siamo al livello 0 e l'ul ha figli.
        if (depth === 0 && parentElement && ul.hasChildNodes()) {
            parentElement.appendChild(ul);
        } else if (depth === 0 && parentElement && !ul.hasChildNodes() && !parentElement.hasChildNodes()) {
            // Se l'ul √® vuoto e il parentElement non ha altri figli (es. messaggio "Nessun commento"),
            // non fare nulla per evitare di sovrascrivere il messaggio.
            // Il messaggio "Nessun commento" viene gi√† gestito all'inizio della funzione.
        }
        // Se stiamo processando risposte (depth > 0), l' `ul` delle risposte √® gi√† stato appeso all' `li` del commento padre
        // oppure all' `ul` del livello precedente se la struttura √® piatta.
        // Non √® necessario ri-appendere `ul` a `parentElement` qui.
    }


    async function deleteAdminComment(commentId, eventIdForReload) {
        if (!confirm('Sei sicuro di voler eliminare questo commento e tutte le sue risposte dirette?')) return;

        const feedbackDiv = document.getElementById('commentsManagementFeedback');
        if(feedbackDiv) feedbackDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Eliminazione...</p>';

        try {
            const formData = new FormData();
            formData.append('action', 'delete_comment');
            formData.append('comment_id', commentId);

            const response = await fetch('manage_comments_admin.php', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                if(feedbackDiv) feedbackDiv.innerHTML = `<p class="success-message">${sanitizeText(result.message)}</p>`;
                const titleEl = document.getElementById('commentsEventTitle');
                // Ricarica i commenti nel modal e aggiorna il conteggio nella card principale
                openManageCommentsModal(eventIdForReload, titleEl ? titleEl.textContent : "Evento");
                fetchDashboardData(); // Per aggiornare il conteggio commenti sulla card
            } else {
                if(feedbackDiv) feedbackDiv.innerHTML = `<p class="error-message">Errore: ${sanitizeText(result.message)}</p>`;
            }
        } catch (error) {
            console.error('Errore deleteAdminComment:', error);
            if(feedbackDiv) feedbackDiv.innerHTML = `<p class="error-message">Errore: ${sanitizeText(error.message)}</p>`;
        }
        setTimeout(() => { if(feedbackDiv) feedbackDiv.innerHTML = ''; }, 5000);
    }


    async function confirmDeleteEvent(eventId, eventTitle) {
        if (!confirm(`Sei sicuro di voler eliminare l'evento "${eventTitle}" (ID: ${eventId})? Questa azione √® irreversibile e canceller√† anche tutte le prenotazioni, i media e i commenti associati.`)) return;

        // Puoi aggiungere un feedback visivo qui se vuoi, es. sull'intera card
        const eventCardElement = document.getElementById(`admin-event-${eventId}`);
        if (eventCardElement) {
            eventCardElement.style.opacity = '0.5';
            // Aggiungi uno spinner sopra la card o un messaggio
        }

        try {
            const formData = new FormData();
            formData.append('action', 'delete_event');
            formData.append('event_id', eventId);

            const response = await fetch('gestione_eventi.php', { // Assicurati che questo script esista e gestisca l'azione
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            alert(sanitizeText(result.message));
            if (result.success) {
                fetchDashboardData(); // Ricarica la lista degli eventi
            } else {
                if (eventCardElement) eventCardElement.style.opacity = '1'; // Ripristina l'opacit√† in caso di errore
            }
        } catch (error) {
            console.error('Errore deleteEvent:', error);
            alert(`Errore eliminazione evento: ${sanitizeText(error.message)}`);
            if (eventCardElement) eventCardElement.style.opacity = '1';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchDashboardData();
    });
</script>

</body>
</html>