<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Admin Dashboard - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css"> <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="page-dashboard">

<header class="navbar-container" id="navbarContainer">
    <nav class="navbar">
        <div class="logo">
            <a href="indexadmin.html"> <span class="emoji">üèîÔ∏è</span>
                <h2>Eremo Frate Francesco - Admin</h2>
            </a>
        </div>
        <div class="right-menu">
            <div class="user-dropdown" id="userDropdownContainer">
                <button class="user-btn" onclick="toggleUserMenu()" aria-haspopup="true" aria-expanded="false">
                    <span class="user-avatar" id="navbar-avatar">üë§</span>
                    <span class="user-name" id="navbar-username">Admin</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
                    <a href="dashboard.html">Dashboard</a>
                    <a href="areapersonale.html">Il mio profilo</a> <a href="eventiincorsoAdmin.html">Gestione Eventi Estesa</a> <a href="#" onclick="logout()">Esci</a>
                </div>
            </div>
            <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="dashboard.html" onclick="closeMobileMenu()">Dashboard</a>
        <a href="areapersonale.html" onclick="closeMobileMenu()">Il mio profilo</a>
        <a href="eventiincorsoAdmin.html" onclick="closeMobileMenu()">Gestione Eventi Estesa</a>
        <a href="#" onclick="logout(); closeMobileMenu();">Esci</a>
    </div>
</header>

<main class="dashboard-main">
    <h1><i class="fas fa-tachometer-alt"></i> Admin Dashboard</h1>

    <section class="dashboard-quick-stats">
        <div class="stat-card">
            <i class="fas fa-calendar-alt"></i>
            <div id="total-events" class="stat-value">0</div>
            <div class="stat-label">Eventi Totali</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-users"></i>
            <div id="total-bookings" class="stat-value">0</div>
            <div class="stat-label">Prenotazioni Totali</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-user-check"></i>
            <div id="total-participants" class="stat-value">0</div>
            <div class="stat-label">Partecipanti Totali</div>
        </div>
        <div class="stat-card">
            <i class="fas fa-comments"></i>
            <div id="total-comments" class="stat-value">0</div>
            <div class="stat-label">Commenti Totali</div>
        </div>
    </section>

    <section class="dashboard-section" id="eventManagementSection">
        <h2><i class="fas fa-calendar-check"></i> Gestione Eventi, Prenotazioni e Partecipanti</h2>
        <div class="event-list-admin" id="adminEventList">
            <p><i class="fas fa-spinner fa-spin"></i> Caricamento eventi...</p>
        </div>
    </section>
</main>

<div id="uploadMediaModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('uploadMediaModal')">&times;</span>
        <h3>Gestisci Media per Evento: <span id="uploadMediaEventTitle"></span></h3>
        <div class="modal-content-scrollable">
            <h4>Carica Nuovi Media</h4>
            <form id="uploadMediaForm" class="media-upload-form">
                <input type="hidden" id="uploadMediaEventId" name="eventId">
                <div class="form-group">
                    <label for="mediaFiles">Seleziona Immagini/Video:</label>
                    <input type="file" id="mediaFiles" name="mediaFiles[]" multiple accept="image/*,video/*,.pdf">
                </div>
                <div class="form-group">
                    <label for="mediaDescription">Descrizione (opzionale):</label>
                    <textarea id="mediaDescription" name="description" rows="3" placeholder="Breve descrizione del media..."></textarea>
                </div>
                <button type="submit" class="btn-admin btn-admin-secondary"><i class="fas fa-upload"></i> Carica Media</button>
            </form>
            <div id="uploadMediaFeedback" style="margin-top:1rem;"></div>

            <div class="existing-media-section">
                <h4>Media Esistenti</h4>
                <div id="existingMediaContainer">
                    <p>Nessun media attualmente caricato per questo evento.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="manageCommentsModal" class="modal">
    <div class="modal-content">
        <span class="close-modal-btn" onclick="closeModal('manageCommentsModal')">&times;</span>
        <h3>Gestisci Commenti per Evento: <span id="commentsEventTitle"></span></h3>
        <div class="modal-content-scrollable">
            <div id="commentsListContainer">
                <p><i class="fas fa-spinner fa-spin"></i> Caricamento commenti...</p>
            </div>
        </div>
        <div id="commentsManagementFeedback" style="margin-top:1rem;"></div>
    </div>
</div>

<footer>
    <p>¬© <span id="currentYear"></span> Eremo Frate Francesco. Operazioni Admin.</p>
</footer>

<script>
    document.getElementById('currentYear').textContent = new Date().getFullYear();

    // --- Navbar & Mobile Menu Logic ---
    const SnavbarContainer = document.getElementById('navbarContainer'); // Rinominato per evitare conflitto con var globale
    let SlastScroll = 0; // Rinominato
    if (SnavbarContainer) {
        window.addEventListener('scroll', function() {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            if (currentScroll <= 50) { SnavbarContainer.classList.remove('hidden'); SlastScroll = 0; return; } // Aggiunto SlastScroll = 0
            if (currentScroll > SlastScroll && !SnavbarContainer.classList.contains('hidden')) {
                SnavbarContainer.classList.add('hidden');
            } else if (currentScroll < SlastScroll && SnavbarContainer.classList.contains('hidden')) {
                SnavbarContainer.classList.remove('hidden');
            }
            SlastScroll = currentScroll <= 0 ? 0 : currentScroll;
        });
    }
    function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        const hamburger = document.querySelector(".navbar .hamburger");
        if(mobileMenu && hamburger){
            mobileMenu.classList.toggle("open");
            hamburger.classList.toggle("open");
            document.body.style.overflow = mobileMenu.classList.contains("open") ? 'hidden' : '';
        }
    }
    function closeMobileMenu() {
        const mobileMenu = document.getElementById("mobileMenu");
        const hamburger = document.querySelector(".navbar .hamburger");
        if(mobileMenu && hamburger){
            mobileMenu.classList.remove("open");
            hamburger.classList.remove("open");
            document.body.style.overflow = '';
        }
    }
    function toggleUserMenu() {
        const dropdown = document.querySelector('#userDropdownContainer .dropdown-menu');
        const button = document.querySelector('#userDropdownContainer .user-btn');
        if(dropdown && button){
            const isOpen = dropdown.style.display === 'block';
            dropdown.style.display = isOpen ? 'none' : 'block';
            button.setAttribute('aria-expanded', !isOpen);
        }
    }
    document.addEventListener('click', function(event) {
        const dropdownContainer = document.getElementById('userDropdownContainer');
        if (dropdownContainer && !dropdownContainer.contains(event.target)) {
            const menu = dropdownContainer.querySelector('.dropdown-menu');
            const btn = dropdownContainer.querySelector('.user-btn');
            if (menu && menu.style.display === 'block') {
                menu.style.display = 'none';
                if(btn) btn.setAttribute('aria-expanded', 'false');
            }
        }
        const mobileMenuEl = document.getElementById("mobileMenu");
        const hamburgerEl = document.querySelector(".navbar .hamburger");
        if (mobileMenuEl && mobileMenuEl.classList.contains("open") && hamburgerEl && !hamburgerEl.contains(event.target) && !mobileMenuEl.contains(event.target)) {
            closeMobileMenu();
        }
    });

    function logout() {
        // Implementa la logica di logout effettiva se necessario (es. invalidare sessione server)
        localStorage.removeItem('adminUserEFF'); // Esempio di pulizia sessione admin
        alert('Logout effettuato.');
        window.location.href = 'index.html'; // O pagina di login admin
    }
    // --- Fine Navbar & Mobile Menu ---


    // --- Logica Dashboard Specifica ---
    const adminEventList = document.getElementById('adminEventList');

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Blocca scroll pagina principale
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.remove('active');
        document.body.style.overflow = ''; // Ripristina scroll pagina principale

        if (modalId === 'uploadMediaModal') {
            const uploadForm = document.getElementById('uploadMediaForm');
            const feedbackDiv = document.getElementById('uploadMediaFeedback');
            const existingMediaContainer = document.getElementById('existingMediaContainer');
            if (uploadForm) uploadForm.reset();
            if (feedbackDiv) feedbackDiv.innerHTML = '';
            if (existingMediaContainer) existingMediaContainer.innerHTML = '<p>Caricamento media...</p>';
        }
        if (modalId === 'manageCommentsModal') {
            const commentsListContainer = document.getElementById('commentsListContainer');
            const feedbackDiv = document.getElementById('commentsManagementFeedback');
            if (commentsListContainer) commentsListContainer.innerHTML = '<p>Caricamento commenti...</p>';
            if (feedbackDiv) feedbackDiv.innerHTML = '';
        }
    }

    window.onclick = function(event) { // Chiudi modal cliccando sull'overlay
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => {
            if (event.target === modal && modal.classList.contains('active')) {
                closeModal(modal.id);
            }
        });
    };
    document.addEventListener('keydown', function(event) { // Chiudi modal con ESC
        if (event.key === "Escape") {
            const activeModal = document.querySelector('.modal.active');
            if (activeModal) {
                closeModal(activeModal.id);
            }
        }
    });


    function sanitizeText(text) {
        if (text === null || typeof text === 'undefined') return '';
        const element = document.createElement('div');
        element.innerText = String(text);
        return element.innerHTML;
    }
    function sanitizeForAttribute(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
    }
    function formatDbDate(dateString) {
        if (!dateString) return 'N/D';
        const date = new Date(dateString.replace(/-/g, '/')); // Gestisce meglio formati data
        if (isNaN(date.getTime())) return dateString; // Ritorna stringa originale se data non valida
        return date.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    async function fetchDashboardData() {
        if (!adminEventList) {
            console.error("Elemento adminEventList non trovato.");
            return;
        }
        adminEventList.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Caricamento dati dashboard...</p>';
        try {
            const response = await fetch('get_dashboard_event_data.php'); // Assicurati che questo script esista e funzioni
            if (!response.ok) throw new Error(`Errore HTTP: ${response.status} ${response.statusText}`);
            const data = await response.json();

            if (data.success && data.events) {
                renderAdminEventsWithGroupedBookings(data.events);
                updateQuickStats(data.stats || {});
            } else {
                adminEventList.innerHTML = `<p>Errore nel caricamento dati: ${data.message || 'Nessun evento trovato o formato dati non corretto.'}</p>`;
            }
        } catch (error) {
            console.error('Errore fetchDashboardData:', error);
            adminEventList.innerHTML = `<p>Impossibile caricare i dati della dashboard: ${error.message}</p>`;
        }
    }

    function updateQuickStats(stats) {
        const elTotalEvents = document.getElementById('total-events');
        const elTotalBookings = document.getElementById('total-bookings');
        const elTotalParticipants = document.getElementById('total-participants');
        const elTotalComments = document.getElementById('total-comments');

        if(elTotalEvents) elTotalEvents.textContent = stats.totalEvents || 0;
        if(elTotalBookings) elTotalBookings.textContent = stats.totalBookings || 0;
        if(elTotalParticipants) elTotalParticipants.textContent = stats.totalParticipants || 0;
        if(elTotalComments) elTotalComments.textContent = stats.totalComments || 0;
    }

    function renderAdminEventsWithGroupedBookings(events) {
        if (!adminEventList) return;
        if (events.length === 0) {
            adminEventList.innerHTML = '<p>Nessun evento da gestire al momento.</p>';
            return;
        }
        adminEventList.innerHTML = '';

        events.forEach(event => {
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item-admin';

            const postiOccupati = event.posti_occupati || 0;
            const postiConfigurati = event.posti_configurati_totali !== undefined ? event.posti_configurati_totali : (postiOccupati + (parseInt(event.PostiDisponibili, 10) || 0));
            const postiDisponibiliAttuali = event.PostiDisponibili !== undefined ? event.PostiDisponibili : (postiConfigurati - postiOccupati);


            eventItem.innerHTML = `
                <div class="event-header-admin">
                    <div>
                        <h3>${sanitizeText(event.Titolo)} (ID: ${event.IDEvento})</h3>
                        <span class="event-date-admin">Data: ${formatDbDate(event.Data)} ${sanitizeText(event.Durata) || ''}</span>
                        <span class="event-date-admin">Posti: ${postiOccupati} / ${postiConfigurati} (Disponibili: ${postiDisponibiliAttuali})</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="event-details-admin">
                    <h4>Prenotazioni Effettuate:</h4>
                    <div class="user-bookings-list" id="bookingsForEvent-${event.IDEvento}">
                        ${renderGroupedBookings(event.elenco_prenotazioni || [], event.IDEvento)}
                    </div>
                    <hr style="margin: 1.5rem 0;">
                    <h4>Azioni Generali Evento</h4>
                    <div class="actions-container">
                        <button class="btn-admin btn-admin-warning" onclick="openManageMediaModal(${event.IDEvento}, '${sanitizeForAttribute(event.Titolo)}')">
                            <i class="fas fa-photo-video"></i> Gestisci Media
                        </button>
                        <button class="btn-admin btn-admin-info" onclick="openManageCommentsModal(${event.IDEvento}, '${sanitizeForAttribute(event.Titolo)}')">
                            <i class="fas fa-comments"></i> Commenti (${event.comment_count || 0})
                        </button>
                        <button class="btn-admin btn-admin-danger" onclick="confirmDeleteEvent(${event.IDEvento}, '${sanitizeForAttribute(event.Titolo)}')">
                            <i class="fas fa-trash-alt"></i> Elimina Evento
                        </button>
                        </div>
                </div>
            `;
            adminEventList.appendChild(eventItem);

            const header = eventItem.querySelector('.event-header-admin');
            const details = eventItem.querySelector('.event-details-admin');
            if (header && details) {
                header.addEventListener('click', () => {
                    details.classList.toggle('active');
                    const icon = header.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fa-chevron-down');
                        icon.classList.toggle('fa-chevron-up');
                    }
                });
            }
        });
    }

    function renderGroupedBookings(bookings, eventId) {
        if (!bookings || bookings.length === 0) {
            return '<p>Nessuna prenotazione per questo evento.</p>';
        }
        let html = '';
        bookings.forEach(booking => {
            const nomeCompletoUtente = `${sanitizeText(booking.NomeUtenteRegistrato || '')} ${sanitizeText(booking.CognomeUtenteRegistrato || '')}`.trim();
            const displayNomeUtente = nomeCompletoUtente || sanitizeText(booking.Contatto);

            html += `<div class="user-booking-group">
                        <h5>Prenotazione di: ${displayNomeUtente} (${sanitizeText(booking.Contatto)})</h5>
                        <div class="single-booking-details">
                            <p><strong>ID Prenotazione: ${booking.idPrenotazione}</strong> - Posti Richiesti: ${booking.NumeroPosti}</p>
                            <strong>Partecipanti:</strong>
                            ${booking.partecipanti_della_prenotazione && booking.partecipanti_della_prenotazione.length > 0 ?
                `<ul class="participant-list-inline">
                                    ${booking.partecipanti_della_prenotazione.map(p => `<li>${sanitizeText(p.Nome)} ${sanitizeText(p.Cognome)}</li>`).join('')}
                                 </ul>` :
                '<p><small>Nessun dettaglio partecipante specificato per questa prenotazione.</small></p>'
            }
                            <button class="btn-admin btn-admin-danger btn-sm"
                                    onclick="confirmCancelBooking(${booking.idPrenotazione}, ${eventId}, ${booking.NumeroPosti}, '${sanitizeForAttribute(displayNomeUtente)}')">
                                <i class="fas fa-times-circle"></i> Annulla Questa Prenotazione
                            </button>
                         </div>
                     </div>`;
        });
        return html;
    }

    function confirmCancelBooking(idPrenotazione, eventId, numPosti, nomeUtente) {
        if (confirm(`Sei sicuro di voler annullare la prenotazione ID ${idPrenotazione} (${numPosti} posti) di ${nomeUtente} per l'evento ID ${eventId}? I posti torneranno disponibili e gli utenti in coda (se presenti) verranno notificati.`)) {
            cancelBooking(idPrenotazione);
        }
    }

    async function cancelBooking(idPrenotazione) {
        const feedbackPlaceholder = document.createElement('p');
        feedbackPlaceholder.id = `cancel-feedback-${idPrenotazione}`;
        feedbackPlaceholder.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Annullamento prenotazione ID ${idPrenotazione}...`;

        // Trova il bottone cliccato o un riferimento per inserire il feedback
        const clickedButton = event.target.closest('button');
        if (clickedButton && clickedButton.parentElement) {
            clickedButton.parentElement.insertBefore(feedbackPlaceholder, clickedButton.nextSibling);
        } else if (adminEventList) {
            adminEventList.prepend(feedbackPlaceholder); // Fallback
        }

        try {
            const formData = new FormData();
            formData.append('id_prenotazione', idPrenotazione);
            const response = await fetch('annulla_prenotazione_admin.php', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                feedbackPlaceholder.className = 'success-message'; // Usa classi CSS
                feedbackPlaceholder.innerHTML = `<i class="fas fa-check-circle"></i> ${sanitizeText(result.message)}`;
                fetchDashboardData(); // Ricarica i dati per aggiornare la vista
            } else {
                feedbackPlaceholder.className = 'error-message'; // Usa classi CSS
                feedbackPlaceholder.innerHTML = `<i class="fas fa-exclamation-circle"></i> Errore: ${sanitizeText(result.message || 'Impossibile annullare la prenotazione.')}`;
            }
            setTimeout(() => { if(feedbackPlaceholder) feedbackPlaceholder.remove(); }, 5000); // Rimuovi feedback dopo 5 sec
        } catch (error) {
            console.error("Errore AJAX annullamento prenotazione:", error);
            feedbackPlaceholder.className = 'error-message';
            feedbackPlaceholder.innerHTML = `<i class="fas fa-exclamation-circle"></i> Errore di connessione: ${sanitizeText(error.message)}`;
            setTimeout(() => { if(feedbackPlaceholder) feedbackPlaceholder.remove(); }, 5000);
        }
    }

    // --- Gestione Media (openManageMediaModal, renderExistingMedia, deleteMediaItem, submit uploadMediaForm) ---
    async function openManageMediaModal(eventId, eventTitle) {
        const eventIdInput = document.getElementById('uploadMediaEventId');
        const eventTitleEl = document.getElementById('uploadMediaEventTitle');
        const existingMediaContainer = document.getElementById('existingMediaContainer');
        const feedbackDiv = document.getElementById('uploadMediaFeedback');
        const uploadForm = document.getElementById('uploadMediaForm');

        if (eventIdInput) eventIdInput.value = eventId;
        if (eventTitleEl) eventTitleEl.textContent = sanitizeText(eventTitle);

        if (uploadForm) uploadForm.reset();
        if (feedbackDiv) feedbackDiv.innerHTML = '';
        if (existingMediaContainer) existingMediaContainer.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Caricamento media...</p>';

        openModal('uploadMediaModal');

        try {
            const response = await fetch(`manage_event_media.php?action=get_event_media&event_id=${eventId}`);
            const result = await response.json();
            if (result.success && result.media) {
                renderExistingMedia(result.media, eventId);
            } else {
                if (existingMediaContainer) existingMediaContainer.innerHTML = `<p>Nessun media trovato o errore: ${sanitizeText(result.message || 'Sconosciuto.')}</p>`;
            }
        } catch (error) {
            console.error('Errore recupero media esistenti:', error);
            if (existingMediaContainer) existingMediaContainer.innerHTML = `<p>Errore connessione recupero media: ${sanitizeText(error.message)}</p>`;
        }
    }
    function renderExistingMedia(mediaItems, eventId) {
        const container = document.getElementById('existingMediaContainer');
        if (!container) return;
        if (mediaItems.length === 0) {
            container.innerHTML = '<p>Nessun media attualmente caricato.</p>'; return;
        }
        let html = '<div class="existing-media-grid">';
        mediaItems.forEach(item => {
            const filename = item.url_media ? item.url_media.split('/').pop() : 'File';
            html += `<div class="existing-media-item">`;
            if (item.tipo_media === 'image') {
                html += `<img src="${item.url_media}" alt="${sanitizeText(item.Descrizione) || filename}" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                         <div class="media-icon-placeholder" style="display:none;"><i class="fas fa-image"></i></div>`;
            } else if (item.tipo_media === 'video') {
                html += `<video src="${item.url_media}" controls preload="metadata"></video>`;
            } else {
                html += `<div class="media-icon-placeholder"><i class="fas fa-file"></i></div>`;
            }
            html += `<p class="media-filename" title="${item.url_media}">${sanitizeText(filename)}</p>`;
            if (item.Descrizione) {
                html += `<p class="media-description"><em>${sanitizeText(item.Descrizione)}</em></p>`;
            }
            html += `<button class="btn-admin btn-admin-danger btn-sm btn-delete-media" data-media-id="${item.id_media}" data-event-id="${eventId}"><i class="fas fa-trash-alt"></i> Elimina</button>`;
            html += `</div>`;
        });
        html += '</div>';
        container.innerHTML = html;
        container.querySelectorAll('.btn-delete-media').forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare questo media?')) {
                    deleteMediaItem(this.dataset.mediaId, this.dataset.eventId);
                }
            });
        });
    }
    async function deleteMediaItem(mediaId, eventId) {
        const feedbackDiv = document.getElementById('uploadMediaFeedback');
        if(feedbackDiv) feedbackDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Eliminazione...</p>';
        try {
            const formData = new FormData();
            formData.append('action', 'delete_event_media');
            formData.append('media_id', mediaId);
            const response = await fetch('manage_event_media.php', { method: 'POST', body: formData });
            const result = await response.json();
            if (result.success) {
                if(feedbackDiv) feedbackDiv.innerHTML = `<p class="success-message">${sanitizeText(result.message)}</p>`;
                const titleEl = document.getElementById('uploadMediaEventTitle');
                openManageMediaModal(eventId, titleEl ? titleEl.textContent : "Evento");
            } else {
                if(feedbackDiv) feedbackDiv.innerHTML = `<p class="error-message">Errore: ${sanitizeText(result.message)}</p>`;
            }
        } catch (error) {
            console.error('Errore eliminazione media:', error);
            if(feedbackDiv) feedbackDiv.innerHTML = `<p class="error-message">Errore connessione: ${sanitizeText(error.message)}</p>`;
        }
    }
    const uploadMediaForm = document.getElementById('uploadMediaForm');
    if(uploadMediaForm) {
        uploadMediaForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const eventId = document.getElementById('uploadMediaEventId').value;
            const files = document.getElementById('mediaFiles').files;
            const description = document.getElementById('mediaDescription').value;
            const feedbackDiv = document.getElementById('uploadMediaFeedback');
            if (!feedbackDiv) { console.error("Feedback div upload mancante"); return; }
            if (files.length === 0) {
                feedbackDiv.innerHTML = '<p class="error-message">Seleziona almeno un file.</p>'; return;
            }
            feedbackDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Caricamento...</p>';
            const formData = new FormData();
            formData.append('action', 'upload_media');
            formData.append('event_id', eventId);
            formData.append('description', description);
            for (let i = 0; i < files.length; i++) formData.append('mediaFiles[]', files[i]);
            try {
                const response = await fetch('manage_event_media.php', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    feedbackDiv.innerHTML = `<p class="success-message">${sanitizeText(result.message)}</p>`;
                    const titleEl = document.getElementById('uploadMediaEventTitle');
                    openManageMediaModal(eventId, titleEl ? titleEl.textContent : "Evento");
                    this.reset();
                } else {
                    feedbackDiv.innerHTML = `<p class="error-message">Errore: ${sanitizeText(result.message)}</p>`;
                }
            } catch (error) {
                console.error('Errore uploadMedia:', error);
                feedbackDiv.innerHTML = `<p class="error-message">Errore upload: ${sanitizeText(error.message)}</p>`;
            }
        });
    }

    // --- Gestione Commenti Admin Modal (con Threading) ---
    async function openManageCommentsModal(eventId, eventTitle) {
        const commentsEventTitleEl = document.getElementById('commentsEventTitle');
        const commentsListContainerEl = document.getElementById('commentsListContainer');
        const feedbackDiv = document.getElementById('commentsManagementFeedback');

        if(commentsEventTitleEl) commentsEventTitleEl.textContent = sanitizeText(eventTitle);
        if(commentsListContainerEl) commentsListContainerEl.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Caricamento commenti...</p>';
        if(feedbackDiv) feedbackDiv.innerHTML = '';

        openModal('manageCommentsModal');

        try {
            const response = await fetch(`manage_comments_admin.php?action=get_comments&event_id=${eventId}`);
            const result = await response.json();
            if (result.success && result.comments) {
                if(commentsListContainerEl) renderCommentsForAdminThreaded(result.comments, eventId, commentsListContainerEl);
            } else {
                if(commentsListContainerEl) commentsListContainerEl.innerHTML = `<p>${sanitizeText(result.message || 'Nessun commento per questo evento.')}</p>`;
            }
        } catch (error) {
            console.error('Errore fetchComments per admin:', error);
            if(commentsListContainerEl) commentsListContainerEl.innerHTML = `<p>Impossibile caricare i commenti: ${sanitizeText(error.message)}</p>`;
        }
    }

    function renderCommentsForAdminThreaded(comments, eventId, parentElement, depth = 0) {
        if (depth === 0) { // Pulisci il contenitore principale solo alla prima chiamata
            parentElement.innerHTML = '';
        }
        if (!comments || comments.length === 0) {
            if (depth === 0) parentElement.innerHTML = '<p>Nessun commento per questo evento.</p>';
            return;
        }

        const ul = document.createElement('ul');
        ul.className = depth > 0 ? 'comment-replies-list' : 'comment-thread-list';
        if (depth > 0) ul.style.paddingLeft = `${depth * 15}px`; // Indentazione per risposte

        comments.forEach(comment => {
            const li = document.createElement('li');
            li.className = 'comment-item-admin';
            li.innerHTML = `
                <div class="comment-item-content">
                    <p>
                        <strong>${sanitizeText(comment.utente_display_name)}</strong>
                        <small>(${sanitizeText(comment.data_creazione_formattata)})</small>
                        <small>[ID: ${comment.Progressivo}${comment.CodRisposta ? `, Risp a: ${comment.CodRisposta}` : ''}]</small>
                    </p>
                    <p class="comment-text-admin"><em>"${sanitizeText(comment.Descrizione)}"</em></p>
                </div>
                <button class="btn-admin btn-admin-danger btn-sm" onclick="deleteAdminComment(${comment.Progressivo}, ${eventId})">
                    <i class="fas fa-trash-alt"></i> Elimina
                </button>
            `;
            parentElement.appendChild(li);

            if (comment.replies && comment.replies.length > 0) {
                const repliesContainer = document.createElement('div'); // Le risposte vanno sotto l'li del genitore
                li.appendChild(repliesContainer);
                renderCommentsForAdminThreaded(comment.replies, eventId, repliesContainer, depth + 1);
            }
        });
    }

    async function deleteAdminComment(commentId, eventIdForReload) {
        if (!confirm('Sei sicuro di voler eliminare questo commento e tutte le sue eventuali risposte dirette?')) return;
        const feedbackDiv = document.getElementById('commentsManagementFeedback');
        if(feedbackDiv) feedbackDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Eliminazione commento...</p>';

        try {
            const formData = new FormData();
            formData.append('action', 'delete_comment');
            formData.append('comment_id', commentId);
            const response = await fetch('manage_comments_admin.php', { method: 'POST', body: formData });
            const result = await response.json();

            if (result.success) {
                if(feedbackDiv) feedbackDiv.innerHTML = `<p class="success-message">${sanitizeText(result.message)}</p>`;
                const eventTitleElement = document.getElementById('commentsEventTitle');
                const eventTitle = eventTitleElement ? eventTitleElement.textContent : "Evento";
                openManageCommentsModal(eventIdForReload, eventTitle); // Ricarica i commenti
            } else {
                if(feedbackDiv) feedbackDiv.innerHTML = `<p class="error-message">Errore: ${sanitizeText(result.message)}</p>`;
            }
        } catch (error) {
            console.error('Errore deleteAdminComment:', error);
            if(feedbackDiv) feedbackDiv.innerHTML = `<p class="error-message">Errore eliminazione: ${sanitizeText(error.message)}</p>`;
        }
        setTimeout(() => { if(feedbackDiv) feedbackDiv.innerHTML = ''; }, 4000); // Pulisci feedback dopo un po'
    }

    async function confirmDeleteEvent(eventId, eventTitle) {
        if (!confirm(`Sei sicuro di voler eliminare l'evento "${eventTitle}" (ID: ${eventId})? Questa azione √® irreversibile e canceller√† anche tutte le prenotazioni, i media e i commenti associati.`)) return;
        try {
            const formData = new FormData();
            formData.append('action', 'delete_event'); // Questo va gestito in gestione_eventi.php
            formData.append('event_id', eventId);
            const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
            const result = await response.json();
            alert(sanitizeText(result.message));
            if (result.success) fetchDashboardData();
        } catch (error) {
            console.error('Errore deleteEvent:', error);
            alert(`Errore durante l'eliminazione dell'evento: ${sanitizeText(error.message)}`);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchDashboardData();
    });
</script>

</body>
</html>