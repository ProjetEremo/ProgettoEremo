<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Personale - Eremo Frate Francesco</title>
  <link rel="stylesheet" href="style.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>

<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="indexaccesso.html"> <span class="emoji">üèîÔ∏è</span>
        <h2>Eremo Frate Francesco</h2>
      </a>
    </div>
    <div class="menu">
      <a href="eventiincorsoaccesso.html">Calendario attivit√†</a>
      <a href="eventipassatiaccesso.html">Archivio attivit√†</a>
      <span class="separator">|</span>
      <a href="incontrisullaparolaaccesso.html">Incontri sulla parola</a>
      <span class="separator">|</span>
      <a href="dovesiamoaccesso.html">Dove siamo</a>
      <a href="contattiaccesso.html">Contatti</a>
    </div>
    <div class="right-menu">
      <div class="user-dropdown" id="userDropdownContainer">
        <button class="user-btn" onclick="toggleUserMenu()" aria-haspopup="true" aria-expanded="false">
          <span class="user-avatar" id="navbar-avatar">üë§</span> <span class="user-name" id="navbar-username">Caricamento...</span> <span class="dropdown-arrow">‚ñº</span>
        </button>
        <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
          <a href="areapersonale.html">Il mio profilo</a>
          <a href="areapersonale.html#prenotazioni">Le mie prenotazioni</a>
          <a href="#" onclick="logout()">Esci</a>
        </div>
      </div>
      <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorsoaccesso.html" onclick="closeMobileMenu()">Calendario attivit√†</a>
    <a href="eventipassatiaccesso.html" onclick="closeMobileMenu()">Archivio attivit√†</a>
    <a href="incontrisullaparolaaccesso.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
    <a href="dovesiamoaccesso.html" onclick="closeMobileMenu()">Dove siamo</a>
    <a href="contattiaccesso.html" onclick="closeMobileMenu()">Contatti</a>
    <hr style="border-color: rgba(255,255,255,0.1);">
    <a href="areapersonale.html" onclick="closeMobileMenu()">Il mio profilo</a>
    <a href="areapersonale.html#prenotazioni" onclick="closeMobileMenu()">Le mie prenotazioni</a>
    <a href="#" onclick="logout(); closeMobileMenu();">Esci</a>
  </div>
</header>

<main>
  <div class="profile-header">
    <div class="avatar-container" id="main-avatar">
      üë§
    </div>
    <h1 id="profile-greeting">Caricamento Profilo...</h1>
    <p>Gestisci le tue informazioni personali e le preferenze.</p>
  </div>

  <div class="container">
    <section class="profile-section">
      <h2><i class="fas fa-user-edit" style="margin-right: 8px;"></i> Informazioni Personali</h2>
      <form id="profile-info-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="nome">Nome</label>
            <input type="text" id="nome" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="cognome">Cognome</label>
            <input type="text" id="cognome" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="form-control" disabled>
          </div>
          <div class="form-group">
            <label for="telefono">Telefono (facoltativo)</label>
            <input type="tel" id="telefono" class="form-control" placeholder="+39 123 456789">
          </div>
        </div>
        <button type="submit" class="btn-save">Salva Info Personali</button>
      </form>
    </section>

    <section class="profile-section">
      <h2><i class="fas fa-image" style="margin-right: 8px;"></i> Icona Profilo</h2>
      <p>Scegli un'icona che ti rappresenti:</p>
      <div class="avatar-options">
        <div class="avatar-option" data-emoji="üë§">üë§</div>
        <div class="avatar-option" data-emoji="üë©">üë©</div>
        <div class="avatar-option" data-emoji="üßî">üßî</div>
        <div class="avatar-option" data-emoji="üßì">üßì</div>
        <div class="avatar-option" data-emoji="üßò">üßò</div>
        <div class="avatar-option" data-emoji="üôè">üôè</div>
        <div class="avatar-option" data-emoji="üå≥">üå≥</div>
        <div class="avatar-option" data-emoji="üïäÔ∏è">üïäÔ∏è</div>
      </div>
      <button class="btn-save" id="save-avatar-btn">Salva Icona</button>
    </section>

    <section class="profile-section">
      <h2><i class="fas fa-lock" style="margin-right: 8px;"></i> Sicurezza Account</h2>
      <form id="password-change-form">
        <div class="form-grid">
          <div class="form-group">
            <label for="vecchia-password">Password Attuale</label>
            <input type="password" id="vecchia-password" class="form-control" required>
          </div>
          <div class="form-group">
            <label for="nuova-password">Nuova Password</label>
            <input type="password" id="nuova-password" class="form-control" required minlength="8">
            <small>Minimo 8 caratteri.</small>
          </div>
          <div class="form-group">
            <label for="conferma-password">Conferma Nuova Password</label>
            <input type="password" id="conferma-password" class="form-control" required>
          </div>
        </div>
        <button type="submit" class="btn-save">Cambia Password</button>
      </form>
    </section>

    <section class="profile-section" id="prenotazioni">
      <h2><i class="fas fa-calendar-check" style="margin-right: 8px;"></i> Le Mie Prenotazioni</h2>
      <div class="card-grid" id="user-bookings-grid">
        <div id="no-bookings-message" style="display: none;">
          <p>Non hai nessuna prenotazione attiva al momento.</p>
          <a href="eventiincorsoaccesso.html" class="card-btn card-btn-primary" style="max-width: 200px; margin: 1rem auto;">Scopri le attivit√†</a>
        </div>
      </div>
    </section>
  </div>
</main>

<footer>
  <p>&copy; 2025 Eremo Frate Francesco. Tutti i diritti riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia</p>
</footer>

<script>
  // --- Navbar & Mobile Menu Logic ---
  let lastScroll = 0;
  const navbarContainer = document.getElementById('navbarContainer');
  const mobileMenu = document.getElementById("mobileMenu");
  const hamburger = document.querySelector(".hamburger");

  window.addEventListener('scroll', function() {
    const currentScroll = window.pageYOffset;
    if (currentScroll <= 0) {
      navbarContainer.classList.remove('hidden');
      return;
    }
    if (currentScroll > lastScroll && !navbarContainer.classList.contains('hidden')) {
      // Scroll Down
      navbarContainer.classList.add('hidden');
    } else if (currentScroll < lastScroll && navbarContainer.classList.contains('hidden')) {
      // Scroll Up
      navbarContainer.classList.remove('hidden');
    }
    lastScroll = currentScroll;
  });

  function toggleMobileMenu() {
    mobileMenu.classList.toggle('show');
    hamburger.setAttribute('aria-expanded', mobileMenu.classList.contains('show'));
  }

  function closeMobileMenu() {
    mobileMenu.classList.remove('show');
    hamburger.setAttribute('aria-expanded', 'false');
  }

  // --- User Dropdown Logic ---
  function toggleUserMenu() {
    const dropdown = document.querySelector('.user-dropdown');
    const isOpen = dropdown.classList.toggle('show');
    dropdown.querySelector('.user-btn').setAttribute('aria-expanded', isOpen);
  }

  // Chiudi dropdown se si clicca fuori
  document.addEventListener('click', function(event) {
    const dropdown = document.querySelector('.user-dropdown');
    if (dropdown && !dropdown.contains(event.target)) {
      dropdown.classList.remove('show');
      dropdown.querySelector('.user-btn').setAttribute('aria-expanded', 'false');
    }
  });

  // --- Logica Area Personale (Interazione con Backend SENZA REINDIRIZZAMENTO FORZATO) ---

  let selectedAvatarEmoji = 'üë§'; // Default, sar√† aggiornato dal backend

  /**
   * Effettua una richiesta API al backend.
   * NON reindirizza automaticamente in caso di token mancante o 401.
   * Permette alla pagina di caricarsi anche senza un token valido, ma le chiamate API falliranno.
   * @param {string} url - L'URL dell'endpoint API.
   * @param {string} method - Il metodo HTTP (GET, POST, PUT, DELETE).
   * @param {object} [data=null] - I dati da inviare nel corpo della richiesta (per POST/PUT).
   * @returns {Promise<object|null>} I dati della risposta JSON o null in caso di errore.
   */
  async function callApi(url, method = 'GET', data = null) {
    const token = localStorage.getItem('authToken'); // Recupera il token di autenticazione

    const headers = {
      'Content-Type': 'application/json',
      // Aggiungi l'header Authorization con il token se presente
      ...(token && { 'Authorization': `Bearer ${token}` })
    };

    const options = {
      method,
      headers,
      // Aggiungi il corpo della richiesta per POST/PUT
      ...(data && { body: JSON.stringify(data) })
    };

    try {
      const response = await fetch(url, options);

      // Se la risposta non √® OK (es. 400, 401, 500), estrai il messaggio di errore e lancia un'eccezione
      // NON reindirizziamo qui, l'errore verr√† gestito dal chiamante (loadUserProfile, etc.)
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ message: response.statusText }));
        // Logga l'errore per il debug ma non blocca l'utente dalla pagina
        console.error(`Errore API (${response.status}) per ${url}:`, errorData.message);
        throw new Error(errorData.message || `Errore del server: ${response.status}`);
      }

      // Se la risposta √® 204 No Content, non c'√® un body da parsificare
      if (response.status === 204) {
        return {};
      }

      // Parsifica la risposta come JSON
      return await response.json();
    } catch (error) {
      console.error('Errore durante la fetch API:', error);
      // Non mostriamo un alert globale qui per ogni errore, lasciamo che il chiamante decida
      return null; // Ritorna null in caso di fallimento
    }
  }

  // Caricamento Dati Utente all'avvio della pagina
  document.addEventListener('DOMContentLoaded', async () => {
    // Tenta di caricare il profilo utente e le prenotazioni.
    // Gli errori o la mancanza di autenticazione non causeranno un reindirizzamento.
    await loadUserProfile();
    await loadUserBookings();

    // Gestione Hash URL per scorrere a prenotazioni dopo il caricamento
    if (window.location.hash === '#prenotazioni') {
      const prenotazioniSection = document.getElementById('prenotazioni');
      if (prenotazioniSection) {
        prenotazioniSection.scrollIntoView({ behavior: 'smooth' });
      }
    }
  });

  /**
   * Carica i dati del profilo utente dal backend e popola l'interfaccia.
   */
  async function loadUserProfile() {
    const mainAvatar = document.getElementById('main-avatar');
    const navbarAvatar = document.getElementById('navbar-avatar');
    const navbarUsername = document.getElementById('navbar-username');
    const profileGreeting = document.getElementById('profile-greeting');

    // Imposta stati di caricamento nell'interfaccia
    mainAvatar.textContent = '...';
    navbarAvatar.textContent = '...';
    navbarUsername.textContent = 'Caricamento...';
    profileGreeting.textContent = 'Caricamento Profilo...';

    // Effettua la chiamata API per recuperare i dati del profilo
    const userData = await callApi('/api/user/profile');
    if (userData) {
      // Popola i campi del modulo con i dati ricevuti
      document.getElementById('nome').value = userData.nome || '';
      document.getElementById('cognome').value = userData.cognome || '';
      document.getElementById('email').value = userData.email || '';
      document.getElementById('telefono').value = userData.telefono || '';

      // Aggiorna l'emoji selezionata e gli elementi dell'interfaccia
      selectedAvatarEmoji = userData.avatar || 'üë§'; // Imposta l'avatar predefinito se non presente
      mainAvatar.textContent = selectedAvatarEmoji;
      navbarAvatar.textContent = selectedAvatarEmoji;
      navbarUsername.textContent = userData.nome || 'Utente';
      profileGreeting.textContent = `Ciao, ${userData.nome || 'Utente'}!`;

      // Seleziona l'avatar nell'interfaccia utente (UI)
      document.querySelectorAll('.avatar-option').forEach(opt => {
        if (opt.getAttribute('data-emoji') === selectedAvatarEmoji) {
          opt.classList.add('selected');
        } else {
          opt.classList.remove('selected');
        }
      });
    } else {
      // In caso di errore nel caricamento del profilo (es. 401 dal backend, ora non reindirizza)
      // Puoi mostrare dati di fallback o un messaggio specifico
      mainAvatar.textContent = 'üë§';
      navbarAvatar.textContent = 'Anonimo';
      navbarUsername.textContent = 'Ospite';
      profileGreeting.textContent = 'Benvenuto, Ospite!';
      // Potresti disabilitare i form se non ci sono dati utente validi
      document.getElementById('profile-info-form').reset(); // Pulisci i campi
      document.getElementById('profile-info-form').querySelectorAll('input').forEach(input => input.disabled = true);
      document.getElementById('profile-info-form').querySelector('.btn-save').disabled = true;
      document.getElementById('save-avatar-btn').disabled = true;
      document.getElementById('password-change-form').querySelectorAll('input').forEach(input => input.disabled = true);
      document.getElementById('password-change-form').querySelector('.btn-save').disabled = true;

      alert('Non √® stato possibile caricare i dati del profilo. Potrebbe essere necessario effettuare il login.');
    }
  }

  /**
   * Carica le prenotazioni dell'utente dal backend e le visualizza.
   */
  async function loadUserBookings() {
    const bookingsGrid = document.getElementById('user-bookings-grid');
    const noBookingsMsg = document.getElementById('no-bookings-message');
    bookingsGrid.innerHTML = ''; // Pulisci il contenuto precedente della griglia

    // Aggiungi un indicatore di caricamento temporaneo
    const loadingMessage = document.createElement('div');
    loadingMessage.textContent = 'Caricamento prenotazioni...';
    loadingMessage.style.textAlign = 'center';
    loadingMessage.style.padding = '2rem';
    loadingMessage.style.color = 'var(--gray-dark)';
    bookingsGrid.appendChild(loadingMessage);

    // Effettua la chiamata API per recuperare le prenotazioni
    const bookings = await callApi('/api/user/bookings');
    bookingsGrid.removeChild(loadingMessage); // Rimuovi l'indicatore di caricamento

    if (bookings && bookings.length > 0) {
      noBookingsMsg.style.display = 'none'; // Nascondi il messaggio "nessuna prenotazione"
      bookings.forEach(booking => {
        // Formatta la data se √® un formato ISO standard (es. '2025-05-20T10:00:00Z')
        const formattedDate = booking.date ? new Date(booking.date).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Data non disponibile';

        const cardHtml = `
          <article class="card ${booking.status === 'Concluso' || booking.status === 'Annullata' ? 'prenotazione-card-past' : ''}" ${booking.status === 'Concluso' || booking.status === 'Annullata' ? 'style="opacity: 0.7;"' : ''}>
            <div class="card-image-container">
                <img src="${booking.imageUrl || 'https://picsum.photos/400/250?random=event'}" alt="${booking.eventName}" class="card-image">
            </div>
            <div class="card-content">
                <h3>${booking.eventName}</h3>
                <p class="card-info">
                    <b>Data:</b> ${formattedDate} <br>
                    <b>Stato:</b> <span style="color: ${booking.status === 'Confermata' ? 'green' : (booking.status === 'Annullata' ? 'red' : 'gray')}; font-weight: bold;">${booking.status}</span>
                </p>
                <p>${booking.details || ''}</p>
                <div class="card-actions">
                    <a href="evento.html?id=${booking.eventId}" class="card-btn card-btn-secondary">Vedi Evento</a>
                    ${booking.status === 'Confermata' ? `<button class="card-btn card-btn-secondary btn-annulla-prenotazione" data-booking-id="${booking.id}">Annulla</button>` : ''}
                </div>
            </div>
          </article>
        `;
        bookingsGrid.insertAdjacentHTML('beforeend', cardHtml);
      });
      attachCancelBookingListeners(); // Collega gli event listener ai nuovi bottoni "Annulla"
    } else {
      // Se non ci sono prenotazioni o i dati non sono validi, mostra il messaggio "nessuna prenotazione"
      bookingsGrid.appendChild(noBookingsMsg); // Aggiungi il messaggio alla griglia
      noBookingsMsg.style.display = 'block'; // Assicurati che sia visibile
    }
  }

  // Salvataggio Icona
  document.getElementById('save-avatar-btn')?.addEventListener('click', async () => {
    const token = localStorage.getItem('authToken');
    if (!token) { // Aggiungi un controllo locale per avvisare l'utente di login
      alert('Per salvare l\'icona, devi prima effettuare il login.');
      return;
    }
    // Invia l'emoji selezionata al backend
    const success = await callApi('/api/user/avatar/update', 'PUT', { avatar: selectedAvatarEmoji });
    if (success) {
      // Se l'aggiornamento √® riuscito, aggiorna l'UI
      document.getElementById('navbar-avatar').textContent = selectedAvatarEmoji;
      alert('Icona profilo aggiornata con successo!');
    }
  });

  // Salvataggio Info Personali
  document.getElementById('profile-info-form')?.addEventListener('submit', async (e) => {
    e.preventDefault(); // Impedisci il comportamento predefinito del form (ricaricamento pagina)
    const token = localStorage.getItem('authToken');
    if (!token) { // Aggiungi un controllo locale per avvisare l'utente di login
      alert('Per salvare le informazioni, devi prima effettuare il login.');
      return;
    }
    const updatedInfo = {
      nome: document.getElementById('nome').value,
      cognome: document.getElementById('cognome').value,
      telefono: document.getElementById('telefono').value
      // L'email di solito non √® modificabile qui, √® disabilitata nell'HTML
    };
    // Invia le informazioni aggiornate al backend
    const success = await callApi('/api/user/profile/update', 'PUT', updatedInfo);
    if (success) {
      // Se l'aggiornamento √® riuscito, aggiorna l'UI
      document.getElementById('profile-greeting').textContent = `Ciao, ${updatedInfo.nome}!`;
      document.getElementById('navbar-username').textContent = updatedInfo.nome;
      alert('Informazioni personali aggiornate con successo!');
    }
  });

  // Cambio Password
  document.getElementById('password-change-form')?.addEventListener('submit', async (e) => {
    e.preventDefault(); // Impedisci il comportamento predefinito del form
    const token = localStorage.getItem('authToken');
    if (!token) { // Aggiungi un controllo locale per avvisare l'utente di login
      alert('Per cambiare la password, devi prima effettuare il login.');
      return;
    }
    const oldPass = document.getElementById('vecchia-password').value;
    const newPass = document.getElementById('nuova-password').value;
    const confirmPass = document.getElementById('conferma-password').value;

    if (newPass !== confirmPass) {
      alert('Le nuove password non coincidono!');
      return;
    }
    if (newPass.length < 8) {
      alert('La nuova password deve essere di almeno 8 caratteri.');
      return;
    }

    // Invia le password al backend per la verifica e l'aggiornamento
    const success = await callApi('/api/user/password/change', 'POST', {
      oldPassword: oldPass,
      newPassword: newPass
    });
    if (success) {
      alert('Password aggiornata con successo!');
      // Pulisci i campi del form dopo un cambio riuscito
      document.getElementById('vecchia-password').value = '';
      document.getElementById('nuova-password').value = '';
      document.getElementById('conferma-password').value = '';
    }
  });

  /**
   * Collega i listener ai bottoni "Annulla" delle prenotazioni.
   * Questa funzione √® importante perch√© le card sono generate dinamicamente.
   */
  function attachCancelBookingListeners() {
    document.querySelectorAll('.btn-annulla-prenotazione').forEach(button => {
        // Rimuovi eventuali listener precedenti per evitare duplicati
        button.removeEventListener('click', handleCancelBooking);
        // Aggiungi il listener per gestire l'annullamento
        button.addEventListener('click', handleCancelBooking);
    });
  }

  /**
   * Gestisce l'evento di annullamento di una prenotazione.
   * @param {Event} event - L'evento click.
   */
  async function handleCancelBooking(event) {
    const token = localStorage.getItem('authToken');
    if (!token) { // Aggiungi un controllo locale per avvisare l'utente di login
      alert('Per annullare una prenotazione, devi prima effettuare il login.');
      return;
    }
    const button = event.target;
    const bookingId = button.getAttribute('data-booking-id');
    if (confirm('Sei sicuro di voler annullare questa prenotazione? Questa azione non pu√≤ essere annullata.')) {
      // Chiamata API per annullare la prenotazione
      const success = await callApi(`/api/user/bookings/cancel/${bookingId}`, 'POST'); // O 'DELETE'
      if (success) {
        alert(`Prenotazione ${bookingId} annullata.`);
        // Ricarica le prenotazioni per riflettere lo stato aggiornato
        await loadUserBookings();
      }
    }
  }

  /**
   * Funzione di logout.
   * Rimuove il token di autenticazione e reindirizza l'utente.
   */
  function logout() {
    // Idealmente, qui faresti una chiamata API al backend per invalidare la sessione lato server
    // es: await callApi('/api/logout', 'POST'); // Questo dovrebbe essere gestito senza token
    localStorage.removeItem('authToken'); // Rimuove il token dal client
    alert('Logout effettuato. Verrai reindirizzato alla homepage.');
    window.location.href = 'index.html'; // Reindirizza alla homepage pubblica
  }

</script>

</body>
</html>