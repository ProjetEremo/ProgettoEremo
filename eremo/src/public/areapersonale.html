<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="images/logo.png" type="image/x-icon">
  <title>Area Personale - Eremo frate Francesco</title>
  <link rel="stylesheet" href="style.css"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/liquid-web/liquid-core.min.js"></script>
<link rel="stylesheet" href="liquidai.css">
  <style>
    /* CSS MINIMI per FIX e NUOVI ELEMENTI. La maggior parte dello stile è atteso da style.css */

    :root {
      /* Queste variabili sono usate dai NUOVI componenti. Se già definite nel tuo style.css, verranno usate quelle. */
      --primary-color: #365e51;
      --secondary-color: #8db187;
      --accent-color: #d4a373;
      --white-color: #f8f5ef;
      --text-dark-color: #333333;
      --gray-light-color: #e0e0e0;
      --gray-medium-color: #cccccc;
      --gray-dark-color: #555555;
      --danger-color: #e74c3c;
      --success-color: #2ecc71;
      --primary-rgb: 54, 94, 81;
      --accent-rgb: 212, 163, 115;
      --border-radius-small: 4px;
      --border-radius-medium: 8px;
      --border-radius-large: 12px;
      --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    body {
      /* Il padding-top per la navbar fissa dovrebbe essere gestito dal tuo style.css
         Esempio: padding-top: 70px; (o l'altezza effettiva della tua navbar) */
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Assicurati che il tuo style.css definisca il font-family principale */
      background-color: var(--white-color); /* Sfondo pagina */
      color: var(--text-dark-color); /* Colore testo base */
    }

    /* Stili MINIMI per la funzionalità della navbar (fissa, dropdown, menu mobile) */
    .navbar-container {
      position: fixed; /* Mantiene la navbar in alto */
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000; /* Sopra altro contenuto */
      transition: top 0.3s ease-in-out; /* Per l'effetto hide/show on scroll */
      /* Colore di sfondo, ombre, ecc. dovrebbero venire dal tuo style.css */
    }
    .navbar-container.hidden {
      top: -80px; /* Adatta all'altezza della tua navbar per nasconderla */
    }

    .navbar {
      /* Il tuo style.css dovrebbe definire display:flex, justify-content, align-items, padding, max-width, margin per .navbar */
    }

    /* Stile specifico per l'icona utente nella navbar, per garantirne la dimensione */
    .user-avatar#navbar-avatar img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 0.6rem;
      border: 1px solid rgba(255,255,255,0.3); /* Bordo leggero, puoi rimuoverlo se gestito altrove */
    }

    /* Stili base per il dropdown utente se non completamente gestiti da style.css */
    .user-dropdown .dropdown-menu {
      display: none; /* Nascosto di default */
      position: absolute;
      background-color: var(--white-color); /* Sfondo del menu */
      color: var(--text-dark-color); /* Colore testo link */
      border: 1px solid var(--gray-light-color);
      border-radius: var(--border-radius-medium);
      box-shadow: var(--shadow-medium);
      right: 1rem; /* Posizionamento, adatta se necessario */
      top: 100%; /* Sotto il bottone utente */
      margin-top: 0.5rem;
      z-index: 1001; /* Sopra la navbar stessa */
      min-width: 180px;
    }
    .user-dropdown .dropdown-menu a {
      display: block;
      padding: 0.8rem 1.2rem;
      text-decoration: none;
      color: var(--text-dark-color);
      transition: background-color 0.2s ease;
    }
    .user-dropdown .dropdown-menu a:hover {
      background-color: var(--gray-light-color);
    }

    /* Stili base per il menu mobile se non completamente gestiti da style.css */
    .mobile-menu {
      display: none; /* Nascosto di default */
      /* Il tuo style.css dovrebbe gestire il resto (background, padding, etc.) */
    }
    .mobile-menu.open {
      display: flex; /* Mostra quando aperto */
      flex-direction: column; /* Tipico per menu mobile */
    }


    /* === INIZIO STILI PER NUOVI COMPONENTI (NON NAVBAR) === */

    /* Stili per la griglia delle icone e la selezione */
    .avatar-options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 15px;
      margin-top: 1rem;
      margin-bottom: 1.5rem;
    }
    .avatar-option-image-container {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .avatar-option-image {
      width: 70px; height: 70px; border-radius: 50%;
      object-fit: cover; cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.3s ease, transform 0.2s ease;
    }
    .avatar-option-image:hover { transform: scale(1.05); }
    .avatar-option-image.selected {
      border-color: var(--primary-color);
      box-shadow: 0 0 12px rgba(var(--primary-rgb), 0.6);
      transform: scale(1.1);
    }
    .delete-icon-btn {
      position: absolute; top: -5px; right: -5px;
      background: var(--danger-color); color: white;
      border: none; border-radius: 50%;
      width: 22px; height: 22px; font-size: 14px;
      line-height: 22px; text-align: center; cursor: pointer;
      opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 5; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .delete-icon-btn:hover { transform: scale(1.1); background-color: #c0392b; }
    .avatar-option-image-container:hover .delete-icon-btn { opacity: 1; }

    /* Stili per la sezione Generatore Icone AI */
    .ai-icon-generator-section {
      position: relative; margin-top: 2.5rem; padding-top: 2rem;
      border-top: 1px dashed var(--gray-medium-color);
    }
    .ai-title-container {
      position: relative; display: inline-block; margin-bottom: 1.8rem;
    }
    .ai-icon-generator-section h3 {
      font-size: 1.5rem; color: var(--secondary-color);
      display: flex; align-items: center; gap: 12px; font-weight: 600;
    }
    .ai-icon-generator-section h3 i.fa-magic { font-size: 1.3em; }
    .star-title {
      position: absolute; background-color: var(--accent-color);
      border-radius: 50%; opacity: 0;
      animation: twinkleAround 2.5s infinite ease-in-out;
      box-shadow: 0 0 6px var(--accent-color), 0 0 12px var(--accent-color);
    }
    @keyframes twinkleAround { 0%, 100% { opacity: 0.2; transform: scale(0.4) rotate(0deg); } 50% { opacity: 0.9; transform: scale(1) rotate(180deg); } 75% { opacity: 0.6; transform: scale(0.7) rotate(270deg); }}
    .star-title.s1 { width: 3px; height: 3px; top: -6px; left: -12px; animation-delay: 0s; }
    .star-title.s2 { width: 4px; height: 4px; top: -2px; right: -18px; animation-delay: 0.35s; }
    .star-title.s3 { width: 3px; height: 3px; bottom: -7px; left: 25%; animation-delay: 0.7s; }
    .star-title.s4 { width: 4px; height: 4px; bottom: -3px; right: 20%; animation-delay: 1.05s; }
    .star-title.s5 { width: 3px; height: 3px; top: 45%; left: -22px; transform: translateY(-50%); animation-delay: 1.4s; }
    .star-title.s6 { width: 2px; height: 2px; top: 25%; right: -28px; animation-delay: 1.75s; }

    .ai-prompt-controls-container {
      display: flex; align-items: flex-start; gap: 12px; margin-bottom: 1.5rem;
    }
    .ai-prompt-controls-container textarea#ai-icon-prompt {
      flex-grow: 1; min-height: 75px; resize: vertical;
      /* Assumi che .form-control sia stilizzato globalmente */
    }
    .ai-prompt-controls-container .btn { /* Stile base per i bottoni AI */
      padding: 0.85rem 1.3rem; font-size: 0.98rem; white-space: nowrap;
      height: fit-content; margin-top: 0; border-radius: var(--border-radius-medium);
      border: none; cursor: pointer; transition: background-color 0.2s ease, transform 0.15s ease;
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    }
    .ai-prompt-controls-container .btn-ai-generate {
      background: linear-gradient(145deg, var(--secondary-color), var(--primary-color));
      color: white; box-shadow: var(--shadow-light);
    }
    .ai-prompt-controls-container .btn-ai-generate:hover:not(:disabled) {
      background: linear-gradient(145deg, var(--primary-color), var(--secondary-color));
      transform: translateY(-2px); box-shadow: var(--shadow-medium);
    }
    .ai-prompt-controls-container .btn-ai-generate:active:not(:disabled) { transform: translateY(0px); }

    /* Stili specifici per i bottoni Salva/Scarta dell'icona AI */
    .ai-prompt-controls-container .btn-save { /* Bottone Salva AI */
      background-color: var(--success-color); color: white;
    }
    .ai-prompt-controls-container .btn-save:hover { background-color: #27ae60; }

    .ai-prompt-controls-container .btn-danger { /* Bottone Scarta AI */
      background-color: var(--gray-dark-color); color: white;
    }
    .ai-prompt-controls-container .btn-danger:hover { background-color: #444; }


    #ai-generated-icon-preview-container {
      margin-top: 1.5rem; border: 1px solid var(--gray-light-color);
      box-shadow: var(--shadow-light); padding: 1.5rem;
      background-color: var(--white-color); opacity: 0;
      transform: translateY(15px) scale(0.98);
      transition: opacity 0.4s ease-out, transform 0.4s ease-out;
      text-align: center;
    }
    #ai-generated-icon-preview-container.revealed { opacity: 1; transform: translateY(0) scale(1); }
    #ai-generated-icon-preview-container p {
      font-size: 0.95rem; color: var(--gray-dark-color); margin-bottom: 0.8rem;
    }
    #ai-generated-icon-preview {
      width: 100px; height: 100px; border-radius: 50%; object-fit: cover;
      border: 4px solid var(--gray-light-color); box-shadow: 0 4px 10px rgba(0,0,0,0.12);
      cursor: pointer; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), border-color 0.3s ease, box-shadow 0.3s ease;
      display: block; margin-left: auto; margin-right: auto;
    }
    #ai-generated-icon-preview.selected {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 4px var(--white-color), 0 0 0 7px var(--primary-color), 0 8px 20px rgba(var(--primary-rgb),0.4);
      transform: scale(1.1);
    }
    #ai-icon-message.form-message { margin-top: 1rem; }

    /* Overlay Animazione Bolle */
    #ai-bubble-animation-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(var(--primary-rgb), 0.92);
      backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
      z-index: 10000; justify-content: center; align-items: center; overflow: hidden;
    }
    .bubble {
      position: absolute; width: 50px; height: 50px;
      border-radius: 50%;
      background-size: cover; background-position: center;
      box-shadow: 0 0 18px rgba(255,255,255,0.35), inset 0 0 12px rgba(255,255,255,0.25);
      border: 1.5px solid rgba(255,255,255,0.6); opacity: 0;
      animation-timing-function: cubic-bezier(0.3, 0, 0.7, 1);
      animation-fill-mode: forwards;
    }
    .bubble.fade-out {
      animation: bubbleFadeOut 0.4s ease-out forwards !important;
    }
    @keyframes floatToCenterAndFade {
      0% { opacity: 0; transform: translate(var(--startX), var(--startY)) scale(0.4); }
      25% { opacity: 0.85; transform: translate(calc(var(--startX) * 0.35), calc(var(--startY) * 0.35)) scale(0.75); }
      85% { opacity: 0.95; transform: translate(0, 0) scale(1); }
      100% { opacity: 0; transform: translate(0,0) scale(0.2); }
    }
    @keyframes bubbleFadeOut {
      to { opacity: 0; transform: scale(0.1); }
    }

    /* Icona Rivelata Centralmente */
    #ai-revealed-icon-container {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%) scale(0.3);
      width: 170px; height: 170px; opacity: 0;
      display: flex; justify-content: center; align-items: center;
      transition: opacity 0.7s ease-out, transform 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
    }
    #ai-revealed-icon-container.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    #ai-revealed-icon-container img {
      width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
      box-shadow: 0 0 40px rgba(var(--accent-rgb), 0.8),
      0 0 80px rgba(var(--white-color), 0.65),
      0 0 12px rgba(0,0,0,0.25) inset;
      border: 6px solid var(--white-color);
    }

    /* Adattamenti per mobile (il tuo style.css dovrebbe gestire la maggior parte) */
    @media (max-width: 992px) { /* Breakpoint in cui il menu desktop potrebbe nascondersi */
      /* .navbar .menu { display: none; }  DEVE ESSERE GESTITO DAL TUO style.css */
      /* .navbar .hamburger { display: block; } DEVE ESSERE GESTITO DAL TUO style.css */
    }
    @media (max-width: 768px) {
      /* .navbar { padding: 0.8rem 1rem; } Esempio, ma dovrebbe essere in style.css */
      .ai-prompt-controls-container {
        flex-direction: column; align-items: stretch;
      }
      .ai-prompt-controls-container textarea#ai-icon-prompt { margin-bottom: 10px; }
      .ai-prompt-controls-container .btn { width: 100%; }
      #ai-revealed-icon-container { width: 140px; height: 140px; }
    }

    /* Stili per il resto della pagina (profile-section, form-grid, etc.)
       dovrebbero provenire principalmente dal tuo style.css. */
    .profile-header .avatar-container img {
      width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
      border: 4px solid var(--white-color); box-shadow: var(--shadow-light);
    }
    .form-message {
      margin-top: 1rem; padding: 0.8rem 1rem; border-radius: var(--border-radius-medium);
      font-size: 0.95rem; text-align: center; display: none;
    }
    .form-message.success { background-color: rgba(46, 204, 113, 0.15); border: 1px solid var(--success-color); color: var(--text-dark-color); }
    .form-message.error { background-color: rgba(231, 76, 60, 0.15); border: 1px solid var(--danger-color); color: var(--text-dark-color); }

    /* Stili per i bottoni principali (btn-save, btn-danger) dovrebbero essere nel tuo style.css */
    /* Esempio:
    .btn-save { background-color: var(--primary-color); color: white; ... }
    .btn-danger { background-color: var(--danger-color); color: white; ... }
    */
	/* === NUOVI STILI PER INFO A "PILLOLE" (CON SPAZIATURA AGGIORNATA) === */
.card-info-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin: 1rem 0 1.2rem 0; /* Aumentato lo spazio sopra e sotto */
    padding-bottom: 1rem; /* Aumentato il padding inferiore */
    border-bottom: 1px solid var(--gray-lighter);
}
.info-pill {
    display: inline-flex;
    align-items: center;
    background-color: var(--background-light, #f8f9fa);
    color: var(--primary-dark, #333);
    padding: 0.4rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 500;
    border: 1px solid var(--gray-light, #eee);
    transition: all 0.2s ease-in-out;
}
.info-pill i {
    margin-right: 0.5rem;
    color: var(--primary);
    font-size: 0.9em;
}
/* === FINE NUOVI STILI === */

/* === NUOVI STILI PER INFO POSTI E COSTO (CON ALLINEAMENTO CENTRATO) === */
.status-pill {
    display: inline-flex;
    align-items: center;
    padding: 0.4rem 0.9rem;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    /* --- MODIFICHE QUI SOTTO --- */
    background-color: #f0f0f0; /* Aggiunto sfondo di base grigio chiaro */
    border: 1px solid #ddd;   /* Aggiunto bordo di base per definizione */
    color: #333;             /* Aggiunto colore testo di base */
}
.status-pill i {
    margin-right: 0.6rem;
    font-size: 0.9em;
}
/* Pillola Posti */
.status-pill.posti {
    background-color: rgba(var(--success-rgb, 40, 167, 69), 0.1);
    color: var(--success-dark, #155724);
}
.status-pill.posti.low-seats {
    background-color: rgba(255, 193, 7, 0.15); /* Giallo/Arancio */
    color: #856404;
}
.status-pill.posti.sold-out {
    background-color: rgba(var(--danger-rgb, 220, 53, 69), 0.1);
    color: var(--danger-dark, #721c24);
}
/* Pillola Costo */
.status-pill.costo {
    background-color: rgba(var(--primary-rgb, 54, 94, 81), 0.1);
    color: var(--primary-dark, #2a4b40);
}
/* Pillola Utente */
.status-pill.user-info {
    background-color: rgba(0, 123, 255, 0.1);
    color: #004085;
}
/* Stili per le pillole di stato prenotazione */
.status-pill.stato-confermata {
    background-color: rgba(var(--success-rgb, 40, 167, 69), 0.15);
    color: var(--success-dark, #155724);
}
.status-pill.stato-concluso {
    background-color: #f0f0f0;
    color: #555;
    border-color: #ddd;
}
.status-pill.stato-annullata {
    background-color: rgba(var(--danger-rgb, 220, 53, 69), 0.1);
    color: var(--danger-dark, #721c24);
}
/* Stili per la lista dei partecipanti nella card di prenotazione */
.participant-recap {
    margin: 0.8rem 0;
    padding: 0.8rem;
    background-color: var(--light, #f8f5ef);
    border-radius: var(--border-radius-medium, 8px);
    border: 1px solid var(--gray-light, #e0e0e0);
}

.participant-recap-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.participant-recap-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    font-size: 0.95rem;
    border-bottom: 1px dotted var(--gray-medium, #cccccc);
}

.participant-recap-list li:last-child {
    border-bottom: none;
}

.participant-recap-list .participant-name {
    color: var(--dark, #333);
}

.participant-recap-list .btn-remove-participant {
    background: none;
    border: none;
    color: var(--gray-dark, #555);
    cursor: pointer;
    font-size: 1.2rem;
    line-height: 1;
    padding: 5px;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
}

.participant-recap-list .btn-remove-participant:hover {
    background-color: var(--danger, #e74c3c);
    color: white;
    transform: scale(1.1);
}
/* --- NUOVA REGOLA PER IL BOTTONE ANNULLA --- */
.card-btn.btn-annulla-prenotazione {
    white-space: nowrap; /* Mantiene il testo su una riga */
    overflow: hidden;    /* Nasconde il testo che eccede */
    text-overflow: ellipsis; /* Aggiunge i puntini di sospensione se il testo è troncato */
    padding-left: 0.8rem; /* Riduci il padding orizzontale se necessario per il testo */
    padding-right: 0.8rem;
}

/* Media query per schermi più piccoli, se necessario */
@media (max-width: 400px) { /* Adatta questo breakpoint alla tua necessità */
    .card-btn.btn-annulla-prenotazione {
        font-size: 0.95rem; /* Riduci la dimensione del font su schermi piccoli */
    }
}
/* === STILI MODIFICATI PER ALLINEAMENTO INFERIORE === */

/* Aggiungi queste regole CSS per fixare le card */

/* Card principale - usa flexbox */
.card {
    display: flex;
    flex-direction: column;
    height: 100%; /* Se le card sono in una griglia, assicura che abbiano la stessa altezza */
}

/* Card content - cresce per riempire lo spazio disponibile */
.card-content {
    display: flex;
    flex-direction: column;
    flex-grow: 1; /* Questo fa crescere il content per riempire lo spazio */
}

/* Status info - sempre in basso */
.card-status-info {
    margin-top: auto; /* Questo spinge le status pill sempre in fondo */
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-lighter, #f0f0f0);
}

/* Card actions - mantieni dopo le status pill */
.card-actions {
    margin-top: 1rem; /* Spazio dalle status pill */
    padding-top: 0.8rem;
    border-top: 1px solid var(--gray-lighter, #f0f0f0);
}

/* Se usi una griglia per le card, assicurati che abbiano altezza uguale */
.card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    align-items: stretch; /* Questo rende tutte le card della stessa altezza */
}
  </style>
</head>
<body>

<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="index.html" style="text-decoration: none; color: inherit;">
        <img src="images/Logo_eremo.png" alt="Logo Eremo frate Francesco" class="navbar-logo-img" id="navbarLogoImgTag">
        <h2 id="navbarTitle">Eremo frate Francesco</h2>
      </a>
    </div>
    <div class="menu" id="desktopMenu"> <a href="eventiincorso.html">Calendario attività</a>
      <a href="eventipassati.html">Archivio attività</a>
      <span class="separator">|</span>
      <a href="incontrisullaparola.html">Incontri sulla parola</a>
      <span class="separator">|</span>
      <a href="dovesiamo.html">Dove siamo</a>
      <a href="contatti.html">Contatti</a>
    </div>
    <div class="right-menu"> <div class="user-dropdown" id="userDropdownContainer">
      <button class="user-btn" onclick="toggleUserMenu(event)" aria-haspopup="true" aria-expanded="false">
        <span class="user-avatar" id="navbar-avatar"><img src="/uploads/icons/default_user.png" alt="User"></span>
        <span class="user-name" id="navbar-username">Ospite</span>
        <span class="dropdown-arrow">▼</span>
      </button>
      <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
        <a href="areapersonale.html" id="nav-profilo">Il mio profilo</a>
        <a href="areapersonale.html#prenotazioni" id="nav-mie-prenotazioni">Le mie prenotazioni</a>
        <a href="dashboard.html" id="nav-dashboard" style="display: none;">Dashboard Admin</a>
        <a href="eventiincorsoAdmin.html" id="nav-gestione-eventi-admin" style="display: none;">Gestione Eventi</a>
        <a href="#" onclick="logout()">Esci</a>
      </div>
    </div>
      <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu" aria-controls="mobileMenu" aria-expanded="false">☰</button> </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu"> <a href="eventiincorso.html" onclick="closeMobileMenu()">Calendario attività</a>
    <a href="eventipassati.html" onclick="closeMobileMenu()">Archivio attività</a>
    <a href="incontrisullaparola.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
    <a href="dovesiamo.html" onclick="closeMobileMenu()">Dove siamo</a>
    <a href="contatti.html" onclick="closeMobileMenu()">Contatti</a>
    <hr id="mobile-menu-separator" style="border-color: rgba(255,255,255,0.1); display:none;">
    <a href="areapersonale.html" id="mobile-nav-profilo" style="display: none;">Il mio profilo</a>
    <a href="areapersonale.html#prenotazioni" id="mobile-nav-mie-prenotazioni" style="display: none;">Le mie prenotazioni</a>
    <a href="dashboard.html" id="mobile-nav-dashboard" style="display: none;">Dashboard Admin</a>
    <a href="eventiincorsoAdmin.html" id="mobile-nav-gestione-eventi-admin" style="display: none;">Gestione Eventi</a>
    <a href="#" onclick="logout(); closeMobileMenu();" id="mobile-logout-link" style="display:none;">Esci</a>
  </div>
</header>

<main>
  <div class="profile-header">
    <div class="avatar-container" id="main-avatar">
      <img src="/uploads/icons/default_user.png" alt="Icona Profilo Utente">
    </div>
    <h1 id="profile-greeting">Area Personale</h1>
    <p>Gestisci le tue informazioni personali e le preferenze.</p>
  </div>

  <div class="container">
    <section class="profile-section">
      <h2><i class="fas fa-user-edit" style="margin-right: 8px;"></i> Informazioni Personali</h2>
      <form id="profile-info-form">
        <div class="form-grid">
          <div class="form-group"> <label for="nome">Nome</label> <input type="text" id="nome" name="nome" class="form-control" required> </div>
          <div class="form-group"> <label for="cognome">Cognome</label> <input type="text" id="cognome" name="cognome" class="form-control" required> </div>
          <div class="form-group full-width"> <label for="email">Email</label> <input type="email" id="email" name="email" class="form-control" disabled> </div>
        </div>
        <button type="submit" class="btn-save">Salva Info Personali</button> <p id="profile-info-message" class="form-message" style="display:none;"></p>
      </form>
      <div class="terms-acceptance-info" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--gray-light-color, #e0e0e0); text-align: center;">
        <p style="font-size: 0.9rem; color: var(--gray-dark-color, #555);">
          <i class="fas fa-check-circle" style="color: var(--success-color, green); margin-right: 5px;"></i>
          Registrandoti hai accettato i nostri <a href="termini.html" target="_blank" style="text-decoration: underline; color: var(--primary-color);">Termini e Condizioni</a>.
        </p>
      </div>
    </section>

    <section class="profile-section">
      <h2><i class="fas fa-image" style="margin-right: 8px;"></i> Icona Profilo</h2>
      <p>Scegli un'icona che ti rappresenti tra quelle disponibili oppure generane una nuova con l'AI:</p>
      <div class="avatar-options-grid" id="avatar-options-container"> <p>Caricamento icone disponibili...</p> </div>

      <div class="ai-icon-generator-section">
        <div class="ai-title-container">
          <h3><i class="fas fa-magic"></i> Genera Icona con Eremo AI</h3>
          <span class="star-title s1"></span><span class="star-title s2"></span><span class="star-title s3"></span>
          <span class="star-title s4"></span><span class="star-title s5"></span><span class="star-title s6"></span>
        </div>
        <div class="form-group">
          <label for="ai-icon-prompt">Descrivi l'icona che vorresti (es. "gatto saggio con occhiali", "montagna stilizzata all'alba"):</label>
          <div class="ai-prompt-controls-container">
            <textarea id="ai-icon-prompt" rows="3" class="form-control" placeholder="Max 250 caratteri..."></textarea>
            <button type="button" class="btn btn-ai-generate" id="btn-generate-ai-icon">
              <i class="fas fa-lightbulb"></i> Genera
            </button>
            <button type="button" class="btn btn-save" id="btn-save-ai-generated-icon" style="display:none;">
              <i class="fas fa-save"></i> Salva
            </button>
            <button type="button" class="btn btn-danger" id="btn-discard-ai-generated-icon" style="display:none;">
              <i class="fas fa-times"></i> Scarta
            </button>
          </div>
        </div>
        <div id="ai-generated-icon-preview-container" style="display:none;">
          <p>Icona generata (clicca per selezionarla):</p>
          <img src="#" alt="Icona Generata con AI" id="ai-generated-icon-preview">
        </div>
        <p id="ai-icon-message" class="form-message" style="display:none;"></p>
      </div>

      <button class="btn-save" id="save-icon-btn" style="margin-top: 2rem;"> <i class="fas fa-save btn-icon-fa"></i>
        <span class="btn-text">Salva Icona Selezionata</span>
        <span class="spinner-btn-overlay" style="display: none;"><div class="modern-spinner"></div></span>
        <i class="fas fa-check btn-icon-fa" style="display: none;"></i>
      </button>
      <p id="icon-save-message" class="form-message" style="display:none;"></p>
    </section>

    <section class="profile-section">
      <h2><i class="fas fa-lock" style="margin-right: 8px;"></i> Sicurezza Account</h2>
      <form id="password-change-form">
        <div class="form-grid">
          <div class="form-group"> <label for="vecchia-password">Password Attuale</label> <input type="password" id="vecchia-password" class="form-control" required> </div>
          <div class="form-group"> <label for="nuova-password">Nuova Password</label> <input type="password" id="nuova-password" class="form-control" required minlength="8"> <small>Minimo 8 caratteri.</small> </div>
          <div class="form-group"> <label for="conferma-password">Conferma Nuova Password</label> <input type="password" id="conferma-password" class="form-control" required> </div>
        </div>
        <button type="submit" class="btn-save">Cambia Password</button> <p id="password-change-message" class="form-message" style="display:none;"></p>
      </form>
    </section>

    <section class="profile-section" id="prenotazioni">
      <h2><i class="fas fa-calendar-check" style="margin-right: 8px;"></i> Le Mie Prenotazioni</h2>
      <div id="user-bookings-grid" class="card-grid"> <p style="text-align:center; padding:1rem;">Caricamento prenotazioni...</p> </div>
      <div id="no-bookings-message" style="display: none; text-align: center; padding: 2rem;">
        <p>Non hai nessuna prenotazione attiva al momento.</p>
        <a href="eventiincorso.html" class="btn-primary" style="display: inline-block; margin-top: 1rem;">Scopri le attività</a> </div>
    </section>

    <section class="profile-section" id="eventi-in-coda">
      <h2><i class="fas fa-hourglass-half" style="margin-right: 8px;"></i> Eventi in Lista d'Attesa</h2>
      <div id="user-waitlist-grid" class="card-grid">
        <p style="text-align:center; padding:1rem;">Caricamento eventi in coda...</p>
      </div>
      <div id="no-waitlist-message" style="display: none; text-align: center; padding: 2rem;">
        <p>Non sei in lista d'attesa per nessun evento al momento.</p>
      </div>
    </section>

    <section class="profile-section" id="delete-account-section">
      <h2><i class="fas fa-user-times" style="margin-right: 8px;"></i> Elimina Account</h2>
      <p style="color: var(--danger-color); text-align:center; margin-bottom: 1.5rem;">Attenzione: Questa azione è irreversibile e cancellerà tutti i tuoi dati personali, incluse prenotazioni, commenti e iscrizioni alle liste d'attesa.</p>
      <form id="delete-account-form">
        <div class="form-group" style="max-width: 400px; margin-left:auto; margin-right:auto;">
          <label for="confirm-delete-email">Per confermare, inserisci la tua email:</label>
          <input type="email" id="confirm-delete-email" name="confirm-delete-email" class="form-control" required>
        </div>
        <button type="submit" class="btn-save" id="btn-confirm-delete-account">Elimina il Mio Account Definitivamente</button> <p id="delete-account-message" class="form-message" style="display:none;"></p>
      </form>
    </section>
  </div>
</main>

<div id="ai-assistant-fab" title="Assistente Virtuale Eremo" data-liquid> <i class="fas fa-headset"></i>
</div>


<div id="ai-chat-popup">
  <div id="ai-chat-header">
    <h3>Assistente Eremo <i class="fas fa-robot"></i></h3>
    <button id="ai-chat-close-btn" aria-label="Chiudi Chat">&times;</button>
  </div>
  <div id="ai-chat-messages">
    <div class="ai-message">Ciao! Sono l'assistente virtuale dell'Eremo. Come posso aiutarti oggi riguardo il sito?</div>
  </div>
  <div id="ai-chat-input-container">
    <textarea id="ai-chat-input" placeholder="Scrivi la tua domanda..." rows="2"></textarea>
    <button id="ai-chat-send-btn" aria-label="Invia Messaggio"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<footer>
  <p>© <span id="currentYear"></span> Eremo frate Francesco. OdV Via San Vito 2, Nembro. C.F.:90004060167. Sviluppato da 5AII 2024-2025 Majorana Seriate.</p>
</footer>

<div id="ai-bubble-animation-overlay">
  <div id="ai-revealed-icon-container">
    <img src="#" alt="Icona Generata" id="revealed-ai-icon-img">
  </div>
</div>

<script src="assistenteAI.js" defer></script>
<script src="liquidglass.js" defer></script>

<script>
  // Variabili globali
  let lastScroll = 0;
  const navbarContainer = document.getElementById('navbarContainer');
  const mobileMenu = document.getElementById("mobileMenu");
  const hamburger = document.querySelector(".navbar .hamburger"); // Assicurati che esista nel tuo HTML
  const defaultIconPath = 'uploads/icons/default_user.png';
  let selectedIconPath = defaultIconPath;
  let currentUserDataFromStorage = null;
  let saveIconBtnEl, saveIconBtnOriginalText;

  // Elementi UI specifici per AI generator e animazione
  let btnGenerateAiIconEl, aiIconPromptEl, aiPreviewContainerEl, aiGeneratedIconPreviewEl, aiIconMessageEl;
  let btnSaveAiGeneratedIconEl, btnDiscardAiGeneratedIconEl;
  let aiBubbleAnimationOverlayEl, aiRevealedIconContainerEl, revealedAiIconImgEl;
  let bubbleIntervalId = null;
  let isGeneratingAI = false;

  // Gestione scroll navbar
  if (navbarContainer) {
    window.addEventListener('scroll', function() {
      const currentScroll = window.pageYOffset;
      if (currentScroll <= 50) { navbarContainer.classList.remove('hidden'); lastScroll = 0; return; }
      if (currentScroll > lastScroll && !navbarContainer.classList.contains('hidden')) { navbarContainer.classList.add('hidden'); }
      else if (currentScroll < lastScroll && navbarContainer.classList.contains('hidden')) { navbarContainer.classList.remove('hidden'); }
      lastScroll = currentScroll;
    });
  }

  // Funzioni per menu mobile e dropdown utente
  function toggleMobileMenu() {
    if (!mobileMenu || !hamburger) return;
    const isOpen = mobileMenu.classList.toggle('open');
    hamburger.classList.toggle('open', isOpen);
    hamburger.setAttribute('aria-expanded', String(isOpen));
    document.body.style.overflow = isOpen ? 'hidden' : '';
  }
  function closeMobileMenu() {
    if (mobileMenu) mobileMenu.classList.remove('open');
    if (hamburger) {
      hamburger.classList.remove('open');
      hamburger.setAttribute('aria-expanded', 'false');
    }
    document.body.style.overflow = '';
  }
  function toggleUserMenu(event) {
    if (event) event.stopPropagation();
    const dropdown = document.querySelector('.user-dropdown .dropdown-menu');
    const btn = document.querySelector('.user-dropdown .user-btn');
    if (dropdown && btn) {
      const isOpen = dropdown.style.display === 'block';
      dropdown.style.display = isOpen ? 'none' : 'block';
      btn.setAttribute('aria-expanded', String(!isOpen));
    }
  }

  // Chiusura menu al click esterno
  document.addEventListener('click', function(event) {
    const userDropdownContainer = document.getElementById('userDropdownContainer');
    const dropdownMenu = document.querySelector('.user-dropdown .dropdown-menu');
    if (dropdownMenu && dropdownMenu.style.display === 'block') {
      if (userDropdownContainer && !userDropdownContainer.contains(event.target)) {
        dropdownMenu.style.display = 'none';
        const userBtn = document.querySelector('.user-dropdown .user-btn');
        if (userBtn) userBtn.setAttribute('aria-expanded', 'false');
      }
    }
    const desktopMenu = document.getElementById('desktopMenu');
    if (mobileMenu && mobileMenu.classList.contains('open')) {
      if (!mobileMenu.contains(event.target) && hamburger && !hamburger.contains(event.target) && (desktopMenu && !desktopMenu.contains(event.target))) {
        closeMobileMenu();
      }
    }
  });

  // Funzione helper per mostrare messaggi
  function displayMessage(elementId, message, isSuccess, clearAfter = true, isToast = false) {
    const el = document.getElementById(elementId);
    if (el) {
      el.innerHTML = message;
      el.className = 'form-message'; // Reset classi
      if (isSuccess) el.classList.add('success'); else el.classList.add('error');

      if (isToast) {
        el.classList.add('toast-style');
        void el.offsetWidth; // Forza reflow
        requestAnimationFrame(() => { el.classList.add('show'); });
      } else {
        el.classList.remove('toast-style', 'show');
      }
      el.style.display = 'block';

      if(clearAfter){
        const timeoutDuration = isToast ? 3500 : (isSuccess ? 5000 : 7000);
        setTimeout(() => {
          if(el) {
            if (isToast && el.classList.contains('toast-style')) {
              el.classList.remove('show');
              el.addEventListener('transitionend', () => {
                if (el.classList.contains('toast-style')) { el.style.display = 'none'; }
              }, { once: true });
            } else if (!isToast) { el.style.display = 'none'; }
          }
        }, timeoutDuration);
      }
    }
  }

  // Funzione helper per chiamate API (MODIFICATA per gestire meglio 401/403)
  async function callApi(url, method = 'GET', data = null) {
    const headers = { 'Content-Type': 'application/json' };
    const options = { method, headers, credentials: 'same-origin' }; // Assicura l'invio dei cookie di sessione
    if (data && (method === 'POST' || method === 'PUT' || method === 'DELETE')) {
      options.body = JSON.stringify(data);
    }
    try {
      const response = await fetch(url, options);
      if (!response.ok) {
        let errorData;
        let rawErrorText = '';
        try {
          rawErrorText = await response.text();
          errorData = JSON.parse(rawErrorText);
        } catch (e) {
          errorData = { message: rawErrorText || `Errore HTTP ${response.status} (${response.statusText}) per ${url}` };
        }
        // Aggiungi lo status all'oggetto errore se non presente, per una gestione più facile
        if (!errorData.status) errorData.status = response.status;
        throw errorData; // Lancia l'oggetto errore (o un Error object con le info)
      }
      if (response.status === 204) return {}; // No Content
      const contentType = response.headers.get("content-type");
      if (contentType && contentType.indexOf("application/json") !== -1) {
        return await response.json();
      } else {
        const textResponse = await response.text();
        return { success: true, data: textResponse, message: textResponse };
      }
    } catch (error) {
      console.error(`Fallimento chiamata API ${url}:`, error.message || error);
      // Assicurati che l'errore rilanciato abbia uno status se disponibile
      if (error && !error.status && error.message && error.message.includes("HTTP")) {
        const match = error.message.match(/HTTP (\d+)/);
        if (match && match[1]) error.status = parseInt(match[1]);
      }
      throw error; // Rilancia l'errore per essere gestito dal chiamante
    }
  }


  // Inizializzazione UI per utente ospite o errore caricamento/sessione scaduta
  function initializeUIForGuest(errorMessage = "Funzionalità non disponibile. Effettua il login.") {
    const mainAvatarImg = document.querySelector('#main-avatar img');
    const navbarAvatarImg = document.querySelector('#navbar-avatar img');
    const navbarUsername = document.getElementById('navbar-username');
    const profileGreeting = document.getElementById('profile-greeting');

    if(mainAvatarImg) mainAvatarImg.src = getDisplayIconPath(defaultIconPath);
    if(navbarAvatarImg) navbarAvatarImg.src = getDisplayIconPath(defaultIconPath);
    if(navbarUsername) navbarUsername.textContent = 'Ospite';
    if(profileGreeting) profileGreeting.textContent = 'Area Personale';

    const emailInput = document.getElementById('email');
    if(emailInput) emailInput.value = '';
    const nomeInput = document.getElementById('nome');
    if(nomeInput) nomeInput.value = '';
    const cognomeInput = document.getElementById('cognome');
    if(cognomeInput) cognomeInput.value = '';


    document.querySelectorAll('#profile-info-form input:not(#email), #profile-info-form button, #save-icon-btn, #password-change-form input, #password-change-form button, #delete-account-form input, #delete-account-form button, #btn-generate-ai-icon, #ai-icon-prompt, #btn-save-ai-generated-icon, #btn-discard-ai-generated-icon').forEach(el => el.disabled = true);

    const avatarContainer = document.getElementById('avatar-options-container');
    if(avatarContainer) avatarContainer.innerHTML = `<p style="text-align:center; padding:1rem;">${errorMessage}</p>`;
    const bookingsGrid = document.getElementById('user-bookings-grid');
    if(bookingsGrid) bookingsGrid.innerHTML = `<p style="text-align:center; padding:1rem;">${errorMessage}</p>`;
    const waitlistGrid = document.getElementById('user-waitlist-grid');
    if(waitlistGrid) waitlistGrid.innerHTML = `<p style="text-align:center; padding:1rem;">${errorMessage}</p>`;
    const noBookingsMsg = document.getElementById('no-bookings-message');
    if(noBookingsMsg) noBookingsMsg.style.display = 'none'; // Nascondi "nessuna prenotazione" se mostriamo errore
    const noWaitlistMsg = document.getElementById('no-waitlist-message');
    if(noWaitlistMsg) noWaitlistMsg.style.display = 'none';


    const aiIconMessageEl = document.getElementById('ai-icon-message');
    if(aiIconMessageEl) displayMessage('ai-icon-message', errorMessage, false, false);

    // Mostra il messaggio principale nella sezione info profilo se è un errore di sessione/caricamento
    if (errorMessage.toLowerCase().includes("sessione") || errorMessage.toLowerCase().includes("login") || errorMessage.toLowerCase().includes("errore caricamento")) {
      displayMessage('profile-info-message', errorMessage, false, false); // Non cancellare subito
    }
  }

  // Normalizza il path dell'icona
  function normalizeIconPath(path) {
    if (!path) return defaultIconPath;
    if (path.startsWith('data:image/')) return path;
    if (path.startsWith('http')) return path;
    if (path.startsWith('/')) return path.substring(1);
    return path;
  }

  // Ottiene il path corretto per l'attributo src dell'immagine
  function getDisplayIconPath(normalizedPath) {
    if (!normalizedPath) return '/' + defaultIconPath;
    if (normalizedPath.startsWith('data:image/')) return normalizedPath;
    if (normalizedPath.startsWith('http')) return normalizedPath;
    if (normalizedPath.startsWith('/')) return normalizedPath;
    return '/' + normalizedPath;
  }


  async function loadNavbarLogo() {
    const logoImgTag = document.getElementById('navbarLogoImgTag');
    if (!logoImgTag) {
      console.error("Elemento immagine logo navbar (<img id='navbarLogoImgTag'>) non trovato in areapersonale.html.");
      return;
    }

    const defaultLogoPath = '/images/Logo_eremo.png'; // Usare path assoluto per coerenza

    try {
      // Assicurati che api_get_page_content.php non richieda login per il logo
      const response = await fetch('/api_get_page_content.php?page=index');
      if (!response.ok) {
        throw new Error(`Errore HTTP ${response.status} nel caricare i dati per il logo.`);
      }
      const data = await response.json();

      if (data.success && data.contents && data.contents.navbarLogo) {
        logoImgTag.src = getDisplayIconPath(data.contents.navbarLogo);
      } else {
        console.warn("URL del logo navbar non trovato o errore API. Uso il logo di default.");
        logoImgTag.src = defaultLogoPath;
      }
    } catch (error) {
      console.error("Errore nel caricare dinamicamente il logo navbar:", error);
      logoImgTag.src = defaultLogoPath; // Fallback in caso di errore
    }
  }

  // NUOVA FUNZIONE: Verifica attiva della sessione server
  async function checkUserSessionActive() {
    try {
      // Assicurati che 'api/api_check_session.php' esista e usi require_login()
      // Dovrebbe restituire {success: true} o un errore 401/403 se la sessione non è valida
      await callApi('api/api_check_session.php');
      return true; // La chiamata ha avuto successo (nessun errore), la sessione è attiva
    } catch (error) {
      // Controlla se l'errore è dovuto a sessione scaduta (401/403)
      if (error && (error.status === 401 || error.status === 403)) {
        console.warn("Session check: Sessione server non attiva (401/403).");
        return false; // Sessione non attiva
      }
      // Per altri errori (es. rete, server down), consideriamo la sessione potenzialmente attiva
      // ma con problemi di comunicazione. Potresti voler gestire questo diversamente.
      // Se l'API non è raggiungibile, non possiamo confermare la sessione, ma non è detto sia scaduta.
      console.warn("Errore durante il check della sessione (non 401/403):", error.message || error);
      return true; // In questo caso, assumiamo che la sessione possa essere ancora valida per evitare logout aggressivi per problemi di rete.
                   // Se l'API non è raggiungibile, le altre chiamate API falliranno comunque e gestiranno il logout se necessario.
    }
  }


  document.addEventListener('DOMContentLoaded', async () => {
    // Inizializzazione elementi DOM
    saveIconBtnEl = document.getElementById('save-icon-btn');
    btnGenerateAiIconEl = document.getElementById('btn-generate-ai-icon');
    aiIconPromptEl = document.getElementById('ai-icon-prompt');
    aiPreviewContainerEl = document.getElementById('ai-generated-icon-preview-container');
    aiGeneratedIconPreviewEl = document.getElementById('ai-generated-icon-preview');
    aiIconMessageEl = document.getElementById('ai-icon-message');
    btnSaveAiGeneratedIconEl = document.getElementById('btn-save-ai-generated-icon');
    btnDiscardAiGeneratedIconEl = document.getElementById('btn-discard-ai-generated-icon');
    aiBubbleAnimationOverlayEl = document.getElementById('ai-bubble-animation-overlay');
    aiRevealedIconContainerEl = document.getElementById('ai-revealed-icon-container');
    revealedAiIconImgEl = document.getElementById('revealed-ai-icon-img');

    const currentYearEl = document.getElementById('currentYear');
    if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();
    await loadNavbarLogo();

    if (saveIconBtnEl) {
      const textSpan = saveIconBtnEl.querySelector('.btn-text');
      saveIconBtnOriginalText = textSpan ? textSpan.textContent : "Salva Icona Selezionata";
      let spinnerOverlay = saveIconBtnEl.querySelector('.spinner-btn-overlay');
      if (!spinnerOverlay) {
        spinnerOverlay = document.createElement('span');
        spinnerOverlay.className = 'spinner-btn-overlay';
        const spinnerDiv = document.createElement('div');
        spinnerDiv.className = 'modern-spinner';
        spinnerDiv.style.cssText = 'width:20px; height:20px; border-width:2px; margin:0; border-color:white white transparent transparent;';
        spinnerOverlay.appendChild(spinnerDiv);
        saveIconBtnEl.appendChild(spinnerOverlay);
      }
      spinnerOverlay.style.display = 'none';

      const iconNode = saveIconBtnEl.querySelector('.fas.fa-save');
      if (iconNode && !iconNode.classList.contains('btn-icon-fa')) {
        iconNode.classList.add('btn-icon-fa');
      }
      let checkIcon = saveIconBtnEl.querySelector('.btn-icon-fa.fa-check');
      if (!checkIcon && iconNode) {
        checkIcon = document.createElement('i');
        checkIcon.className = 'fas fa-check btn-icon-fa';
        iconNode.parentNode.insertBefore(checkIcon, iconNode.nextSibling);
      }
      if(checkIcon) checkIcon.style.display = 'none';
    }

    const profileHeaderEl = document.querySelector('.profile-header');
    if (profileHeaderEl) {
      profileHeaderEl.classList.add('profile-header-loading');
      setTimeout(() => {
        profileHeaderEl.classList.remove('profile-header-loading');
        profileHeaderEl.classList.add('loaded');
      }, 50);
    }

    // --- INIZIO LOGICA DI CARICAMENTO E VERIFICA SESSIONE ---
    const userDataString = localStorage.getItem('userDataEFF');
    if (userDataString) {
      try {
        currentUserDataFromStorage = JSON.parse(userDataString);
        // PRIMA DI TUTTO, VERIFICA LA SESSIONE REALE SUL SERVER
        const sessionIsValidOnServer = await checkUserSessionActive();

        if (!sessionIsValidOnServer) {
          console.warn("Sessione server non valida rilevata all'avvio di areapersonale.html.");
          logout(false); // Esegui il logout client-side (false per non mostrare alert duplicati)
          initializeUIForGuest("La tua sessione è scaduta. Effettua nuovamente il login.");
          return; // Interrompi ulteriori caricamenti se la sessione non è valida
        }

        // Se la sessione server è valida, popola l'UI con i dati da localStorage
        // e poi aggiorna con i dati freschi dal server.
        const navbarUsername = document.getElementById('navbar-username');
        const navbarAvatarImg = document.querySelector('#navbar-avatar img');
        const mainAvatarImg = document.querySelector('#main-avatar img');
        const profileGreeting = document.getElementById('profile-greeting');

        if (navbarUsername) navbarUsername.textContent = currentUserDataFromStorage.nome || 'Utente';
        selectedIconPath = normalizeIconPath(currentUserDataFromStorage.iconPath || defaultIconPath);
        if (navbarAvatarImg) navbarAvatarImg.src = getDisplayIconPath(selectedIconPath);
        if (mainAvatarImg) mainAvatarImg.src = getDisplayIconPath(selectedIconPath);
        if (profileGreeting) profileGreeting.textContent = `Ciao, ${currentUserDataFromStorage.nome || 'Utente'}!`;
        // Non impostare nome/cognome/email qui, lo farà loadUserProfileFromServer

        // Ora carica/aggiorna i dati dal server
        await loadUserProfileFromServer(); // Questa funzione ora gestirà anche 401/403
        await loadAvailableIcons();
        await loadUserBookings();
        await loadUserWaitlist();
        if(btnGenerateAiIconEl) btnGenerateAiIconEl.disabled = false;
        if(aiIconPromptEl) aiIconPromptEl.disabled = false;

      } catch(e) { // Questo catch è per errori nel parsing di localStorage o errori imprevisti
        console.error("Errore durante l'inizializzazione o il caricamento dei dati:", e);
        currentUserDataFromStorage = null;
        logout(false);
        initializeUIForGuest("Errore durante il caricamento della pagina. Riprova.");
      }
    } else {
      // Nessun dato utente in localStorage, quindi l'utente non è "loggato" nel browser.
      initializeUIForGuest("Effettua il login per accedere alle funzionalità.");
      // Non c'è bisogno di chiamare logout() qui.
    }
    // --- FINE LOGICA DI CARICAMENTO E VERIFICA SESSIONE ---


    btnGenerateAiIconEl?.addEventListener('click', handleGenerateAiIcon);
    aiGeneratedIconPreviewEl?.addEventListener('click', handleSelectAiGeneratedIcon);
    btnSaveAiGeneratedIconEl?.addEventListener('click', handleSaveNewlyGeneratedAiIcon);
    btnDiscardAiGeneratedIconEl?.addEventListener('click', handleDiscardAiGeneratedIcon);
    saveIconBtnEl?.addEventListener('click', handleSaveIcon);

    document.getElementById('profile-info-form')?.addEventListener('submit', handleProfileInfoSubmit);
    document.getElementById('password-change-form')?.addEventListener('submit', handlePasswordChangeSubmit);
    document.getElementById('delete-account-form')?.addEventListener('submit', handleDeleteAccount);

    if (window.location.hash === '#prenotazioni') {
      const el = document.getElementById('prenotazioni'); if(el) el.scrollIntoView({behavior:'smooth'});
    }
  });

  // Funzione per gestire errori API, specialmente 401/403 per la sessione
  function handleApiError(error, messageElementId, defaultErrorMessage) {
    let displayMsg = defaultErrorMessage;
    if (error && (error.status === 401 || error.status === 403)) {
      displayMsg = "Sessione scaduta o non autorizzata. Effettua nuovamente il login.";
      console.warn("API Error: Sessione scaduta (401/403). Eseguo logout client.");
      logout(false);
      initializeUIForGuest(displayMsg);
    } else if (error && error.message) {
      displayMsg = error.message;
    }
    displayMessage(messageElementId, displayMsg, false, false); // Non cancellare subito il messaggio di errore importante
  }


  async function loadUserProfileFromServer() {
    const mainAvatarImg = document.querySelector('#main-avatar img');
    const navbarAvatarImg = document.querySelector('#navbar-avatar img');
    const navbarUsername = document.getElementById('navbar-username');
    const profileGreeting = document.getElementById('profile-greeting');
    try {
      const apiUserData = await callApi('api/api_get_user_profile.php'); // Assicurati che questa API esista e sia protetta
      if (apiUserData && apiUserData.success) {
        const data = apiUserData.data;
        document.getElementById('nome').value = data.nome || '';
        document.getElementById('cognome').value = data.cognome || '';
        document.getElementById('email').value = data.email || (currentUserDataFromStorage ? currentUserDataFromStorage.email : '');

        selectedIconPath = normalizeIconPath(data.icon || defaultIconPath);

        if(mainAvatarImg) mainAvatarImg.src = getDisplayIconPath(selectedIconPath);
        if(navbarAvatarImg) navbarAvatarImg.src = getDisplayIconPath(selectedIconPath);
        if(navbarUsername) navbarUsername.textContent = data.nome || 'Utente';
        if(profileGreeting) profileGreeting.textContent = `Ciao, ${data.nome || 'Utente'}!`;

        // Aggiorna i dati in localStorage con quelli freschi dal server
        currentUserDataFromStorage = {
          nome: data.nome,
          cognome: data.cognome,
          email: data.email,
          iconPath: selectedIconPath,
          // Mantieni isAdmin se era presente, altrimenti l'API dovrebbe fornirlo
          isAdmin: currentUserDataFromStorage ? currentUserDataFromStorage.isAdmin : false
        };
        localStorage.setItem('userDataEFF', JSON.stringify(currentUserDataFromStorage));
      } else {
        // Se l'API non ha successo ma non è un 401 (gestito da handleApiError nel catch)
        // mostra il messaggio specifico dell'API.
        displayMessage('profile-info-message', (apiUserData && apiUserData.message) ? apiUserData.message : "Errore nel recupero del profilo utente.", false, false);
      }
    } catch (error) {
      handleApiError(error, 'profile-info-message', 'Errore durante il caricamento del profilo utente.');
    }
  }

  function updateIconSelectionVisual() {
    document.querySelectorAll('.avatar-option-image.selected').forEach(sel => sel.classList.remove('selected'));
    if (aiGeneratedIconPreviewEl) aiGeneratedIconPreviewEl.classList.remove('selected');

    const normalizedComparePath = selectedIconPath;

    const currentSelectedPredefinedImg = document.querySelector(`.avatar-option-image[data-path="${normalizedComparePath}"]`);
    if (currentSelectedPredefinedImg) {
      currentSelectedPredefinedImg.classList.add('selected');
    } else if (selectedIconPath && selectedIconPath.startsWith('data:image/') && aiGeneratedIconPreviewEl && aiGeneratedIconPreviewEl.src === selectedIconPath) {
      aiGeneratedIconPreviewEl.classList.add('selected');
    } else if (aiGeneratedIconPreviewEl && selectedIconPath && getDisplayIconPath(selectedIconPath) === aiGeneratedIconPreviewEl.src) {
      aiGeneratedIconPreviewEl.classList.add('selected');
    }
  }

  async function loadAvailableIcons() {
    const container = document.getElementById('avatar-options-container');
    if (!container) return;
    container.innerHTML = '<p>Caricamento icone disponibili...</p>';

    try {
      const iconsData = await callApi('api/api_get_icons.php'); // Assicurati che questa API esista
      if (iconsData && iconsData.success && iconsData.icons) {
        container.innerHTML = '';
        if (iconsData.icons.length > 0) {
          const nonDeletableDefaultIcons = [
            defaultIconPath, 'uploads/icons/1.jpg', 'uploads/icons/3.jpg',
            'uploads/icons/ata.png', 'uploads/icons/spiritual.png'
          ].map(p => normalizeIconPath(p));

          iconsData.icons.forEach(path => {
            const normalizedPath = normalizeIconPath(path);
            const imgContainer = document.createElement('div');
            imgContainer.classList.add('avatar-option-image-container');

            const img = document.createElement('img');
            img.src = getDisplayIconPath(normalizedPath);
            img.alt = 'Icona profilo';
            img.classList.add('avatar-option-image');
            img.setAttribute('data-path', normalizedPath);
            img.addEventListener('click', () => {
              if (!currentUserDataFromStorage) return; // Non permettere selezione se non loggato (UI dovrebbe già impedirlo)
              selectedIconPath = normalizedPath;
              updateIconSelectionVisual();
              const mainAvatarPreview = document.querySelector('#main-avatar img');
              if(mainAvatarPreview) mainAvatarPreview.src = getDisplayIconPath(selectedIconPath);
              if (aiGeneratedIconPreviewEl) aiGeneratedIconPreviewEl.classList.remove('selected');
            });
            imgContainer.appendChild(img);

            let userEmailSanitized = null;
            if(currentUserDataFromStorage && currentUserDataFromStorage.email) {
              const emailParts = currentUserDataFromStorage.email.split('@');
              userEmailSanitized = emailParts[0].replace(/[^a-zA-Z0-9_]+/g, "");
            }

            const isUserGeneratedAI = normalizedPath.includes('ai_icon_') && userEmailSanitized && normalizedPath.includes(userEmailSanitized);
            const isDefault = nonDeletableDefaultIcons.includes(normalizedPath);

            if (isUserGeneratedAI && !isDefault && currentUserDataFromStorage) {
              const deleteBtn = document.createElement('button');
              deleteBtn.innerHTML = '&times;';
              deleteBtn.title = 'Elimina questa icona';
              deleteBtn.classList.add('delete-icon-btn');
              deleteBtn.onclick = (e) => {
                e.stopPropagation();
                handleDeleteIcon(normalizedPath);
              };
              imgContainer.appendChild(deleteBtn);
            }
            container.appendChild(imgContainer);
          });
          updateIconSelectionVisual();
        } else {
          container.innerHTML = `<p>${iconsData.message || 'Nessuna icona personalizzata disponibile.'}</p>`;
        }
      } else {
        // Se iconsData.success è false ma non è un errore 401/403 (già gestito da handleApiError)
        container.innerHTML = `<p>${(iconsData && iconsData.message) ? iconsData.message : 'Errore nel caricamento delle icone.'}</p>`;
      }
    } catch (error) {
      handleApiError(error, 'avatar-options-container', 'Errore durante il caricamento delle icone disponibili.');
      // Sovrascrive il contenuto del container con il messaggio di errore da handleApiError
      // ma displayMessage scrive in un elemento con ID, quindi dobbiamo farlo manualmente per il container.
      if (container) container.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">${error.message || 'Errore caricamento icone.'}</p>`;
    }
  }

  async function handleDeleteIcon(iconPathToDelete) {
    if (!currentUserDataFromStorage) {
      displayMessage('icon-save-message', 'Devi essere loggato per eliminare le icone.', false, true, true);
      return;
    }
    if (!confirm(`Sei sicuro di voler eliminare l'icona "${iconPathToDelete.split('/').pop()}"? L'azione è irreversibile.`)) {
      return;
    }
    try {
      displayMessage('icon-save-message', 'Eliminazione icona in corso...', true, false, true);
      const response = await callApi('api/api_delete_icon.php', 'POST', { iconPath: iconPathToDelete }); // Assicurati che esista
      if (response.success) {
        displayMessage('icon-save-message', response.message || 'Icona eliminata con successo!', true, true, true);
        if (selectedIconPath === iconPathToDelete) {
          selectedIconPath = defaultIconPath;
          const mainAvatarPreview = document.querySelector('#main-avatar img');
          if (mainAvatarPreview) mainAvatarPreview.src = getDisplayIconPath(defaultIconPath);
        }
        await loadAvailableIcons(); // Ricarica la griglia
        await loadUserProfileFromServer(); // Ricarica il profilo per aggiornare l'icona se era quella corrente
      } else {
        throw new Error(response.message || 'Errore durante l\'eliminazione dell\'icona sul server.');
      }
    } catch (error) {
      handleApiError(error, 'icon-save-message', 'Errore durante l\'eliminazione dell\'icona.');
    }
  }

  function startBubbleAnimation() {
    if (!aiBubbleAnimationOverlayEl) return;
    aiBubbleAnimationOverlayEl.innerHTML = `
        <div id="ai-revealed-icon-container">
            <img src="#" alt="Icona Generata" id="revealed-ai-icon-img">
        </div>`;
    aiRevealedIconContainerEl = document.getElementById('ai-revealed-icon-container');
    revealedAiIconImgEl = document.getElementById('revealed-ai-icon-img');
    if(aiRevealedIconContainerEl) aiRevealedIconContainerEl.classList.remove('show');

    aiBubbleAnimationOverlayEl.style.display = 'flex';
    isGeneratingAI = true;

    function createBubble() {
      if (!isGeneratingAI || !aiBubbleAnimationOverlayEl.contains(aiRevealedIconContainerEl)) {
        if(bubbleIntervalId) clearInterval(bubbleIntervalId);
        return;
      }

      const bubble = document.createElement('div');
      bubble.classList.add('bubble');
      const size = Math.random() * 30 + 50;
      bubble.style.width = `${size}px`;
      bubble.style.height = `${size}px`;

      const startSide = Math.floor(Math.random() * 4);
      let startX, startY;
      const offset = 120; // Quanto fuori dallo schermo iniziare
      const randomViewportPosW = Math.random() * window.innerWidth + 'px';
      const randomViewportPosH = Math.random() * window.innerHeight + 'px';

      switch (startSide) {
        case 0: startX = randomViewportPosW; startY = `-${offset}px`; break; // Da sopra
        case 1: startX = (window.innerWidth + offset) + 'px'; startY = randomViewportPosH; break; // Da destra
        case 2: startX = randomViewportPosW; startY = (window.innerHeight + offset) + 'px'; break; // Da sotto
        case 3: startX = `-${offset}px`; startY = randomViewportPosH; break; // Da sinistra
      }
      bubble.style.setProperty('--startX', startX);
      bubble.style.setProperty('--startY', startY);
      bubble.style.backgroundImage = `url(https://picsum.photos/100/100?random=${Math.random() + Date.now()})`;

      const duration = Math.random() * 3 + 4.5;
      bubble.style.animationName = 'floatToCenterAndFade';
      bubble.style.animationDuration = `${duration}s`;

      aiBubbleAnimationOverlayEl.appendChild(bubble);

      setTimeout(() => { if (bubble.parentElement) bubble.remove(); }, duration * 1000);
    }

    for(let i=0; i < 8; i++) { setTimeout(createBubble, i * 150); } // Ondata iniziale più densa
    if (bubbleIntervalId) clearInterval(bubbleIntervalId);
    bubbleIntervalId = setInterval(createBubble, 450); // Bolle più frequenti
  }

  function stopBubbleAnimation(generatedIconBase64 = null) {
    isGeneratingAI = false;
    if (bubbleIntervalId) {
      clearInterval(bubbleIntervalId);
      bubbleIntervalId = null;
    }

    const existingBubbles = aiBubbleAnimationOverlayEl.querySelectorAll('.bubble');
    existingBubbles.forEach(bubble => {
      bubble.classList.add('fade-out');
      setTimeout(() => { if (bubble.parentElement) bubble.remove(); }, 400);
    });


    if (generatedIconBase64 && aiRevealedIconContainerEl && revealedAiIconImgEl) {
      revealedAiIconImgEl.src = generatedIconBase64;
      setTimeout(() => {
        aiRevealedIconContainerEl.classList.add('show');
      }, 150);


      setTimeout(() => {
        if(aiRevealedIconContainerEl) aiRevealedIconContainerEl.classList.remove('show');
        if(aiBubbleAnimationOverlayEl) aiBubbleAnimationOverlayEl.style.display = 'none';

        if (aiGeneratedIconPreviewEl) aiGeneratedIconPreviewEl.src = generatedIconBase64;
        if (aiPreviewContainerEl) {
          aiPreviewContainerEl.style.display = 'block';
          void aiPreviewContainerEl.offsetWidth;
          aiPreviewContainerEl.classList.add('revealed');
        }
        if (aiGeneratedIconPreviewEl) aiGeneratedIconPreviewEl.classList.remove('selected');
        displayMessage('ai-icon-message', 'Icona generata! Cliccala per selezionarla, poi salvala o scartala.', true);
        if(btnSaveAiGeneratedIconEl) btnSaveAiGeneratedIconEl.style.display = 'inline-flex';
        if(btnDiscardAiGeneratedIconEl) btnDiscardAiGeneratedIconEl.style.display = 'inline-flex';
        if(btnGenerateAiIconEl) btnGenerateAiIconEl.style.display = 'none';

      }, 1800 + 150);
    } else {
      setTimeout(() => {
        if(aiBubbleAnimationOverlayEl) aiBubbleAnimationOverlayEl.style.display = 'none';
      }, 400);
    }
  }

  async function handleGenerateAiIcon() {
    if (!currentUserDataFromStorage) { displayMessage('ai-icon-message', 'Autenticazione richiesta.', false); return; }
    const promptText = aiIconPromptEl.value.trim();
    if (!promptText) { displayMessage('ai-icon-message', 'Inserisci una descrizione.', false); return; }

    btnGenerateAiIconEl.disabled = true;
    aiIconPromptEl.disabled = true;
    if(btnSaveAiGeneratedIconEl) btnSaveAiGeneratedIconEl.style.display = 'none';
    if(btnDiscardAiGeneratedIconEl) btnDiscardAiGeneratedIconEl.style.display = 'none';
    if(aiPreviewContainerEl) aiPreviewContainerEl.style.display = 'none';
    displayMessage('ai-icon-message', '', true, false); // Pulisci messaggi precedenti

    startBubbleAnimation();

    const CLOUDFLARE_WORKER_URL = 'https://text-to-image-template.tnt-teambom.workers.dev';
    const stylisticKeywords = "profile avatar, realistic icon style, full color, vector art, 2d illustration with depth, clean lines, balanced shading, realistic color palette, detailed, circular icon";
    const augmentedPrompt = `${promptText}, ${stylisticKeywords}`;

    try {
      const response = await fetch(CLOUDFLARE_WORKER_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: augmentedPrompt })
      });

      if (!response.ok) {
        const errorText = await response.text();
        let errorDetail = errorText;
        try { const errorJson = JSON.parse(errorText); errorDetail = errorJson.error || errorJson.message || errorText; }
        catch(e) { /* usa errorText */ }
        throw new Error(errorDetail || `Errore dal Worker AI: ${response.statusText}`);
      }

      const imageBlob = await response.blob();
      if (imageBlob.type && imageBlob.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onloadend = function() {
          stopBubbleAnimation(reader.result); // Passa il base64 all'animazione
        }
        reader.readAsDataURL(imageBlob);
      } else {
        const errorText = await imageBlob.text(); // Se non è un'immagine, prova a leggere come testo
        displayMessage('ai-icon-message', `Risposta non valida dal servizio AI: ${errorText.substring(0,100)}...`, false);
        stopBubbleAnimation(); // Ferma l'animazione senza un'icona
      }
    } catch (error) {
      displayMessage('ai-icon-message', `Errore generazione AI: ${error.message}. Riprova.`, false);
      stopBubbleAnimation(); // Ferma l'animazione in caso di errore
    } finally {
      // Riabilita i controlli solo se non sono apparsi i bottoni Salva/Scarta (cioè se non c'è un'icona generata)
      if (btnSaveAiGeneratedIconEl && btnSaveAiGeneratedIconEl.style.display === 'none') {
        if(btnGenerateAiIconEl) {
          btnGenerateAiIconEl.disabled = false;
          btnGenerateAiIconEl.style.display = 'inline-flex';
        }
        if(aiIconPromptEl) aiIconPromptEl.disabled = false;
      }
    }
  }

  function handleSelectAiGeneratedIcon(event) {
    if (!currentUserDataFromStorage) return;
    const aiPreviewImg = event.target;
    if (aiPreviewImg.src && (aiPreviewImg.src.startsWith('data:image/') || aiPreviewImg.src.includes('/uploads/icons/ai_icon_'))) {
      selectedIconPath = aiPreviewImg.src.startsWith('data:image/') ? aiPreviewImg.src : normalizeIconPath(aiPreviewImg.src.substring(aiPreviewImg.src.indexOf("uploads/icons/")));
      updateIconSelectionVisual();
      const mainAvatarPreview = document.querySelector('#main-avatar img');
      if(mainAvatarPreview) mainAvatarPreview.src = getDisplayIconPath(selectedIconPath);
    }
  }

  function handleSaveNewlyGeneratedAiIcon() {
    if (!aiGeneratedIconPreviewEl || !aiGeneratedIconPreviewEl.src || aiGeneratedIconPreviewEl.src === '#') {
      displayMessage('ai-icon-message', 'Nessuna icona generata valida da salvare.', false);
      return;
    }
    // Assicura che selectedIconPath sia il base64 se l'immagine è nuova
    if (aiGeneratedIconPreviewEl.src.startsWith('data:image/')) {
      selectedIconPath = aiGeneratedIconPreviewEl.src;
    } else { // Se per qualche motivo fosse già un path salvato, normalizzalo
      selectedIconPath = normalizeIconPath(aiGeneratedIconPreviewEl.src.substring(aiGeneratedIconPreviewEl.src.indexOf("uploads/icons/")));
    }
    updateIconSelectionVisual(); // Seleziona l'icona AI nella preview
    handleSaveIcon(); // Chiama la funzione di salvataggio principale

    // Resetta i controlli AI
    if(btnSaveAiGeneratedIconEl) btnSaveAiGeneratedIconEl.style.display = 'none';
    if(btnDiscardAiGeneratedIconEl) btnDiscardAiGeneratedIconEl.style.display = 'none';
    if(btnGenerateAiIconEl) btnGenerateAiIconEl.style.display = 'inline-flex';
    if(btnGenerateAiIconEl) btnGenerateAiIconEl.disabled = false;
    if(aiIconPromptEl) aiIconPromptEl.disabled = false;
    // Non pulire il prompt, l'utente potrebbe volerlo modificare leggermente
  }

  function handleDiscardAiGeneratedIcon() {
    if (aiPreviewContainerEl) {
      aiPreviewContainerEl.style.display = 'none';
      aiPreviewContainerEl.classList.remove('revealed');
    }
    if(aiGeneratedIconPreviewEl) aiGeneratedIconPreviewEl.src = '#'; // Rimuovi l'immagine dalla preview
    displayMessage('ai-icon-message', 'Generazione annullata. Puoi provare con un nuovo prompt.', true, true);

    // Resetta i controlli AI
    if(btnSaveAiGeneratedIconEl) btnSaveAiGeneratedIconEl.style.display = 'none';
    if(btnDiscardAiGeneratedIconEl) btnDiscardAiGeneratedIconEl.style.display = 'none';
    if(btnGenerateAiIconEl) btnGenerateAiIconEl.style.display = 'inline-flex';
    if(btnGenerateAiIconEl) btnGenerateAiIconEl.disabled = false;
    if(aiIconPromptEl) aiIconPromptEl.disabled = false;
    if(aiIconPromptEl) aiIconPromptEl.value = ''; // Pulisci il prompt
  }

  async function handleSaveIcon() {
    if (!currentUserDataFromStorage || !saveIconBtnEl) return;

    let finalIconPathToServer = selectedIconPath;
    const textSpan = saveIconBtnEl.querySelector('.btn-text');
    const saveIconFA = saveIconBtnEl.querySelector('.btn-icon-fa.fa-save');
    const checkIconFA = saveIconBtnEl.querySelector('.btn-icon-fa.fa-check');
    const spinnerOverlay = saveIconBtnEl.querySelector('.spinner-btn-overlay');

    saveIconBtnEl.disabled = true;
    saveIconBtnEl.classList.remove('saved-success');
    saveIconBtnEl.classList.add('saving');
    if(textSpan) textSpan.style.opacity = '0';
    if(saveIconFA) saveIconFA.style.display = 'none';
    if(checkIconFA) checkIconFA.style.display = 'none';
    if(spinnerOverlay) spinnerOverlay.style.display = 'flex';

    // Se l'icona selezionata è un base64 (nuova icona AI non ancora salvata su disco)
    if (selectedIconPath && selectedIconPath.startsWith('data:image/')) {
      displayMessage('icon-save-message', 'Salvataggio icona AI personalizzata sul server...', true, false, true);
      try {
        // API per salvare il base64 come file e restituire il path
        const saveResponse = await callApi('api/api_save_ai_icon.php', 'POST', { imageBase64: selectedIconPath }); // Assicurati che esista
        if (saveResponse.success && saveResponse.iconPath) {
          finalIconPathToServer = normalizeIconPath(saveResponse.iconPath);
          // L'icona AI è ora salvata come file, procedi ad aggiornare il DB con questo path
        } else {
          throw new Error(saveResponse.message || 'Errore durante il salvataggio del file dell\'icona AI.');
        }
      } catch (error) {
        handleApiError(error, 'icon-save-message', 'Errore durante il salvataggio del file icona.');
        saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saving');
        if(textSpan) {textSpan.textContent = saveIconBtnOriginalText; textSpan.style.opacity = '1';}
        if(saveIconFA) saveIconFA.style.display = 'inline-block';
        if(spinnerOverlay) spinnerOverlay.style.display = 'none';
        return;
      }
    } else if (!selectedIconPath || (selectedIconPath === defaultIconPath && !document.querySelector(`.avatar-option-image[data-path="${defaultIconPath}"].selected`))) {
      // Controlla se un'icona è effettivamente selezionata (non base64)
      const aiPreviewImg = document.getElementById('ai-generated-icon-preview');
      if (!document.querySelector('.avatar-option-image.selected') && !(aiPreviewImg && aiPreviewImg.classList.contains('selected') && aiPreviewImg.src !== '#')) {
        displayMessage('icon-save-message', 'Nessuna nuova icona selezionata.', false, true, true);
        saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saving');
        if(textSpan) {textSpan.textContent = saveIconBtnOriginalText; textSpan.style.opacity = '1';}
        if(saveIconFA) saveIconFA.style.display = 'inline-block';
        if(spinnerOverlay) spinnerOverlay.style.display = 'none';
        return;
      }
    }

    if (!finalIconPathToServer || finalIconPathToServer.startsWith('data:image/')) {
      // Questo non dovrebbe accadere se il salvataggio base64 ha funzionato
      displayMessage('icon-save-message', 'Errore: path icona non valido per il database.', false, true, true);
      saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saving');
      if(textSpan) {textSpan.textContent = saveIconBtnOriginalText; textSpan.style.opacity = '1';}
      if(saveIconFA) saveIconFA.style.display = 'inline-block';
      if(spinnerOverlay) spinnerOverlay.style.display = 'none';
      return;
    }

    // Ora aggiorna il DB con il path dell'icona (sia essa preesistente o appena salvata da base64)
    let pathToSaveForDB = finalIconPathToServer;
    if (!pathToSaveForDB.startsWith('/')) { // Assicura che il path nel DB inizi con / se è relativo alla root del sito
      pathToSaveForDB = '/' + pathToSaveForDB;
    }


    try {
      const response = await callApi('api/api_update_user_icon.php', 'PUT', { icon: pathToSaveForDB }); // Assicurati che esista
      if (response.success) {
        saveIconBtnEl.classList.remove('saving');
        saveIconBtnEl.classList.add('saved-success');
        if(spinnerOverlay) spinnerOverlay.style.display = 'none';
        if(textSpan) {textSpan.textContent = 'Salvato!'; textSpan.style.opacity = '1';}
        if(saveIconFA) saveIconFA.style.display = 'none';
        if(checkIconFA) checkIconFA.style.display = 'inline-block';

        const navbarAvatarImg = document.querySelector('#navbar-avatar img');
        const mainAvatarImg = document.querySelector('#main-avatar img');
        const cacheBuster = '?t=' + new Date().getTime();
        let displayPathForUIAfterSave = getDisplayIconPath(finalIconPathToServer); // Usa il path normalizzato e corretto

        if (navbarAvatarImg) navbarAvatarImg.src = displayPathForUIAfterSave + cacheBuster;
        if (mainAvatarImg) mainAvatarImg.src = displayPathForUIAfterSave + cacheBuster;

        selectedIconPath = finalIconPathToServer; // Aggiorna selectedIconPath con il path del file salvato
        if(currentUserDataFromStorage) {
          currentUserDataFromStorage.iconPath = finalIconPathToServer; // Salva il path del file
          localStorage.setItem('userDataEFF', JSON.stringify(currentUserDataFromStorage));
        }
        await loadAvailableIcons(); // Ricarica la griglia, che ora includerà la nuova icona se è stata generata da AI
        displayMessage('icon-save-message', response.message || 'Icona profilo aggiornata!', true, true, true);

        // Se l'icona AI era stata generata e ora è salvata, aggiorna il src della preview AI
        // per puntare al file salvato, non più al base64.
        if (aiGeneratedIconPreviewEl && aiGeneratedIconPreviewEl.src.startsWith('data:image/')) {
          aiGeneratedIconPreviewEl.src = displayPathForUIAfterSave + cacheBuster;
        }
        updateIconSelectionVisual(); // Assicura che la nuova icona sia visualmente selezionata

        setTimeout(() => {
          saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saved-success');
          if(textSpan) textSpan.textContent = saveIconBtnOriginalText;
          if(saveIconFA) saveIconFA.style.display = 'inline-block';
          if(checkIconFA) checkIconFA.style.display = 'none';
        }, 2500);
      } else {
        throw new Error(response.message || 'Errore durante l\'aggiornamento dell\'icona profilo nel database.');
      }
    } catch (error) {
      handleApiError(error, 'icon-save-message', 'Errore durante l\'aggiornamento dell\'icona.');
      saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saving');
      if(textSpan) {textSpan.textContent = saveIconBtnOriginalText; textSpan.style.opacity = '1';}
      if(saveIconFA) saveIconFA.style.display = 'inline-block';
      if(checkIconFA) checkIconFA.style.display = 'none';
      if(spinnerOverlay) spinnerOverlay.style.display = 'none';
    }
  }

  async function handleProfileInfoSubmit(e) {
    e.preventDefault();
    if (!currentUserDataFromStorage) { displayMessage('profile-info-message', 'Autenticazione richiesta.', false); return; }
    const updatedInfo = { nome: document.getElementById('nome').value, cognome: document.getElementById('cognome').value };
    try {
      const response = await callApi('api/api_update_user_profile.php', 'PUT', updatedInfo); // Assicurati che esista
      if (response.success) {
        const navbarUsername = document.getElementById('navbar-username');
        const profileGreeting = document.getElementById('profile-greeting');
        if(navbarUsername) navbarUsername.textContent = updatedInfo.nome;
        if(profileGreeting) profileGreeting.textContent = `Ciao, ${updatedInfo.nome}!`;
        if(currentUserDataFromStorage) {
          currentUserDataFromStorage.nome = updatedInfo.nome;
          currentUserDataFromStorage.cognome = updatedInfo.cognome;
          localStorage.setItem('userDataEFF', JSON.stringify(currentUserDataFromStorage));
        }
        displayMessage('profile-info-message', response.message || 'Informazioni personali aggiornate!', true);
      } else {
        // Non è un errore 401/403 (già gestito), ma un altro errore API
        displayMessage('profile-info-message', response.message || 'Errore durante l\'aggiornamento delle informazioni.', false);
      }
    } catch (error) {
      handleApiError(error, 'profile-info-message', 'Errore durante l\'aggiornamento delle informazioni.');
    }
  }

  async function handlePasswordChangeSubmit(e) {
    e.preventDefault();
    if (!currentUserDataFromStorage) { displayMessage('password-change-message', 'Autenticazione richiesta.', false); return; }
    const oldPassword = document.getElementById('vecchia-password').value;
    const newPassword = document.getElementById('nuova-password').value;
    const confirmPassword = document.getElementById('conferma-password').value;
    if (newPassword !== confirmPassword) { displayMessage('password-change-message', 'Le nuove password non coincidono.', false); return; }
    if (newPassword.length < 8) { displayMessage('password-change-message', 'La nuova password deve contenere almeno 8 caratteri.', false); return; }
    try {
      const response = await callApi('api/api_change_password.php', 'POST', { oldPassword, newPassword }); // Assicurati che esista
      if (response.success) {
        displayMessage('password-change-message', response.message || 'Password aggiornata con successo!', true);
        e.target.reset(); // Pulisci i campi del form password
      } else {
        displayMessage('password-change-message', response.message || 'Errore durante il cambio password.', false);
      }
    } catch (error) {
      handleApiError(error, 'password-change-message', 'Errore durante il cambio password.');
    }
  }

 async function loadUserBookings() {
    const bookingsGrid = document.getElementById('user-bookings-grid');
    const noBookingsMsg = document.getElementById('no-bookings-message');
    if (!bookingsGrid || !noBookingsMsg) return;
    bookingsGrid.innerHTML = '<p style="text-align:center; padding:1rem;">Caricamento prenotazioni...</p>';
    noBookingsMsg.style.display = 'none';
    try {
        const response = await callApi('api/api_get_user_bookings.php');
        if (response.success && response.bookings) {
            const bookings = response.bookings;
            bookingsGrid.innerHTML = ''; 
            if (bookings.length > 0) {
                bookings.forEach(booking => {
                    const formattedDate = booking.eventDataInizio ? new Date(booking.eventDataInizio.replace(/-/g, '/')).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Data non definita';
                    const isPastOrCancelled = booking.statoPrenotazione === 'Concluso' || booking.statoPrenotazione === 'Annullata';
                    let iconSrc = getDisplayIconPath(normalizeIconPath(booking.eventFotoCopertina || defaultIconPath));

                    // --- NUOVA LOGICA PER GENERARE LA LISTA PARTECIPANTI ---
                    let participantsHtml = '';
                    if (booking.participants && booking.participants.length > 0) {
                        const listItems = booking.participants.map(p => `
                            <li>
                                <span class="participant-name">${p.name}</span>
                                ${booking.statoPrenotazione === 'Confermata' ? `<button class="btn-remove-participant" title="Rimuovi ${p.name}" data-participant-id="${p.id}" data-booking-id="${booking.idPrenotazione}">&times;</button>` : ''}
                            </li>
                        `).join('');

                        participantsHtml = `
                            <div class="participant-recap">
                                <ul class="participant-recap-list" data-total-participants="${booking.participants.length}">
                                    ${listItems}
                                </ul>
                            </div>`;
                    }
                    // --- FINE NUOVA LOGICA ---

                    let statusClass = '';
                    let statusIcon = 'fa-question-circle';
                    switch (booking.statoPrenotazione) {
                        case 'Confermata': statusClass = 'stato-confermata'; statusIcon = 'fa-check-circle'; break;
                        case 'Concluso': statusClass = 'stato-concluso'; statusIcon = 'fa-history'; break;
                        case 'Annullata': statusClass = 'stato-annullata'; statusIcon = 'fa-times-circle'; break;
                    }

                    const infoPillsHtml = `
                      <div class="card-status-info">
                          <span class="status-pill"><i class="fas fa-calendar-alt"></i> ${formattedDate}</span>
                          <span class="status-pill user-info"><i class="fas fa-users"></i> ${booking.numeroPostiPrenotati || 'N/D'} Posti</span>
                          <span class="status-pill ${statusClass}"><i class="fas ${statusIcon}"></i> ${booking.statoPrenotazione || 'Sconosciuto'}</span>
                      </div>`;

                    const cardHtml = `
                      <article class="card ${isPastOrCancelled ? 'prenotazione-card-past' : ''}">
                        <div class="card-image-container">
                          <img src="${iconSrc}" alt="Evento: ${booking.eventTitolo || 'Evento Sconosciuto'}" class="card-image" onerror="this.onerror=null; this.src='${getDisplayIconPath(defaultIconPath)}';">
                        </div>
                        <div class="card-content">
                          <h3>${booking.eventTitolo || 'Evento Sconosciuto'}</h3>
                          ${participantsHtml} 
                          ${infoPillsHtml}
                          <div class="card-actions">
                            <a href="evento_dettaglio_accesso.html?id=${booking.idEvento}" class="card-btn card-btn-secondary">Vedi Evento</a>
                            ${booking.statoPrenotazione === 'Confermata' ? `<button class="card-btn btn-danger btn-annulla-prenotazione" data-booking-id="${booking.idPrenotazione}">Annulla </button>` : ''}
                          </div>
                        </div>
                      </article>`;
                    bookingsGrid.insertAdjacentHTML('beforeend', cardHtml);
                });
                attachCancelBookingListeners();
                attachRemoveParticipantListeners(); // <-- NUOVA CHIAMATA
            } else {
                noBookingsMsg.style.display = 'block';
            }
        } else {
            bookingsGrid.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">${response.message || 'Errore durante il caricamento delle prenotazioni.'}</p>`;
        }
    } catch (error) {
        handleApiError(error, 'user-bookings-grid', 'Errore durante il caricamento delle prenotazioni.');
        if (bookingsGrid) bookingsGrid.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">${error.message || 'Errore caricamento prenotazioni.'}</p>`;
    }
}
function attachRemoveParticipantListeners() {
    document.querySelectorAll('.btn-remove-participant').forEach(button => {
        button.addEventListener('click', handleRemoveParticipant);
    });
}

async function handleRemoveParticipant(event) {
    const button = event.currentTarget;
    const participantId = button.dataset.participantId;
    const bookingId = button.dataset.bookingId;
    
    // Controllo lato client per evitare di rimuovere l'ultimo partecipante
    const list = button.closest('.participant-recap-list');
    const totalParticipants = list ? parseInt(list.dataset.totalParticipants, 10) : 0;
    if (totalParticipants <= 1) {
        alert("Non puoi rimuovere l'ultimo partecipante. Se necessario, annulla l'intera prenotazione dalla sezione apposita.");
        return;
    }

    if (confirm("Sei sicuro di voler rimuovere questo partecipante dalla prenotazione?")) {
        button.disabled = true;
        try {
            const response = await callApi('api/api_remove_participant.php', 'POST', { participantId });
            if (response.success) {
                alert(response.message || "Partecipante rimosso!");
                await loadUserBookings(); // Ricarica la lista per riflettere le modifiche
            } else {
                throw new Error(response.message || "Impossibile rimuovere il partecipante.");
            }
        } catch (error) {
            handleApiError(error, 'user-bookings-grid', `Errore: ${error.message || 'Qualcosa è andato storto'}`);
            if (!(error && (error.status === 401 || error.status === 403))) {
              alert(`Errore: ${error.message || 'Qualcosa è andato storto'}`);
            }
            button.disabled = false;
        }
    }
}

  async function loadUserWaitlist() {
    const waitlistGrid = document.getElementById('user-waitlist-grid');
    const noWaitlistMsg = document.getElementById('no-waitlist-message');
    if (!waitlistGrid || !noWaitlistMsg) return;
    waitlistGrid.innerHTML = '<p style="text-align:center; padding:1rem;">Caricamento eventi in coda...</p>';
    noWaitlistMsg.style.display = 'none';
    try {
      const response = await callApi('api/api_get_user_waitlist.php'); // Assicurati che esista
      if (response.success && response.waitlistEntries) {
        const entries = response.waitlistEntries;
        waitlistGrid.innerHTML = ''; // Pulisci prima di aggiungere
        if (entries.length > 0) {
          entries.forEach(entry => {
            const formattedDate = entry.eventDataInizio ? new Date(entry.eventDataInizio.replace(/-/g, '/')).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Data non definita';
            let statusMessage = `Sei in coda per ${entry.numeroPostiInCoda} posto/i.`;
            let statusColor = 'orange'; let cardClass = ''; let cancelButtonHtml = '';
            if (parseInt(entry.eventPostiDisponibili) > 0 && entry.eventFlagPrenotabile == 1) {
              statusMessage = `ATTENZIONE: Si sono liberati ${entry.eventPostiDisponibili} posti! Prenota ora. (Richiesti: ${entry.numeroPostiInCoda})`;
              statusColor = 'var(--success-color, green)';
            } else if (entry.eventFlagPrenotabile == 0) {
              statusMessage = `Evento non più prenotabile. (Richiesti: ${entry.numeroPostiInCoda})`;
              statusColor = 'var(--gray-dark-color, grey)'; cardClass = 'waitlist-card-unavailable';
            }
            if (entry.eventFlagPrenotabile == 1) { // Permetti di uscire dalla coda solo se l'evento è ancora "attivo" per la coda
              cancelButtonHtml = `<button class="card-btn card-btn-danger btn-cancel-waitlist" data-event-id="${entry.idEvento}">Esci dalla Coda</button>`;
            }
            let iconSrc = normalizeIconPath(entry.eventFotoCopertina || defaultIconPath);
            iconSrc = getDisplayIconPath(iconSrc);
            const cardHtml = `
              <article class="card ${cardClass}">
                <div class="card-image-container">
                  <img src="${iconSrc}" alt="Evento: ${entry.eventTitolo || 'Evento Sconosciuto'}" class="card-image" onerror="this.onerror=null; this.src='${getDisplayIconPath(defaultIconPath)}';">
                </div>
                <div class="card-content">
                  <h3>${entry.eventTitolo || 'Evento Sconosciuto'}</h3>
                  <p class="card-info">
                    <b>Data Evento:</b> ${formattedDate}<br>
                    <b style="color: ${statusColor};">Stato Coda:</b> <span style="color: ${statusColor};">${statusMessage}</span>
                  </p>
                  <div class="card-actions">
                    <a href="evento_dettaglio_accesso.html?id=${entry.idEvento}" class="card-btn card-btn-secondary">Vedi Evento</a>
                    ${(parseInt(entry.eventPostiDisponibili) > 0 && entry.eventFlagPrenotabile == 1) ? `<a href="eventiincorso.html#evento-${entry.idEvento}" class="card-btn card-btn-primary">Prenota Ora</a>` : ''}
                    ${cancelButtonHtml}
                  </div>
                </div>
              </article>`;
            waitlistGrid.insertAdjacentHTML('beforeend', cardHtml);
          });
          attachCancelWaitlistListeners();
        } else { noWaitlistMsg.style.display = 'block'; }
      } else {
        waitlistGrid.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">${response.message || 'Errore durante il caricamento della lista d\'attesa.'}</p>`;
      }
    } catch (error) {
      handleApiError(error, 'user-waitlist-grid', 'Errore durante il caricamento della lista d\'attesa.');
      if(waitlistGrid) waitlistGrid.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">${error.message || 'Errore caricamento lista d\'attesa.'}</p>`;
    }
  }

  function attachCancelBookingListeners() {
    document.querySelectorAll('.btn-annulla-prenotazione').forEach(b => {
      b.removeEventListener('click', handleCancelBooking); // Rimuovi vecchi listener
      b.addEventListener('click', handleCancelBooking);
    });
  }
  async function handleCancelBooking(event) {
    const button = event.target; const bookingId = button.dataset.bookingId;
    if (!currentUserDataFromStorage) { alert('Autenticazione richiesta.'); return; } // Questo non dovrebbe accadere se la UI è corretta
    if (confirm('Sei sicuro di voler annullare questa prenotazione?')) {
      button.disabled = true; button.textContent = 'Annullamento...';
      try {
        const response = await callApi('api/api_cancel_booking.php', 'POST', { idPrenotazione: bookingId }); // Assicurati che esista
        if (response.success) {
          alert(response.message || 'Prenotazione annullata con successo.');
          loadUserBookings(); // Ricarica solo le prenotazioni
          // Potrebbe essere utile ricaricare anche la waitlist se l'annullamento libera posti
          loadUserWaitlist();
        } else { throw new Error(response.message || 'Errore durante l\'annullamento della prenotazione.'); }
      } catch (error) {
        // handleApiError gestirà il logout se è un 401/403
        handleApiError(error, 'user-bookings-grid', 'Errore durante l\'annullamento della prenotazione.');
        // Se non è un errore di sessione, mostra l'alert specifico
        if (!(error && (error.status === 401 || error.status === 403))) {
          alert(`Errore: ${error.message || 'Impossibile annullare la prenotazione.'}`);
        }
      }
      finally { button.disabled = false; button.textContent = 'Annulla';}
    }
  }

  function attachCancelWaitlistListeners() {
    document.querySelectorAll('.btn-cancel-waitlist').forEach(b => {
      b.removeEventListener('click', handleCancelWaitlist); // Rimuovi vecchi listener
      b.addEventListener('click', handleCancelWaitlist);
    });
  }
  async function handleCancelWaitlist(event) {
    const button = event.target; const eventId = button.dataset.eventId;
    if (!currentUserDataFromStorage) { alert('Autenticazione richiesta.'); return; }
    if (confirm('Sei sicuro di voler uscire dalla lista d\'attesa per questo evento?')) {
      button.disabled = true; button.textContent = 'Rimozione...';
      try {
        const response = await callApi('api/api_cancel_waitlist.php', 'POST', { idEvento: eventId }); // Assicurati che esista
        if (response.success) {
          alert(response.message || 'Rimosso dalla lista d\'attesa con successo.');
          loadUserWaitlist(); // Ricarica la lista d'attesa
        } else { throw new Error(response.message || 'Errore durante la rimozione dalla lista d\'attesa.'); }
      } catch (error) {
        handleApiError(error, 'user-waitlist-grid', 'Errore durante la rimozione dalla lista d\'attesa.');
        if (!(error && (error.status === 401 || error.status === 403))) {
          alert(`Errore: ${error.message || 'Impossibile uscire dalla lista d\'attesa.'}`);
        }
      }
      finally { button.disabled = false; button.textContent = 'Esci dalla Coda';}
    }
  }

  async function handleDeleteAccount(event) {
    event.preventDefault();
    const confirmEmailInput = document.getElementById('confirm-delete-email');
    const confirmEmail = confirmEmailInput.value;
    const deleteButton = document.getElementById('btn-confirm-delete-account');

    if (!currentUserDataFromStorage || !currentUserDataFromStorage.email) {
      displayMessage('delete-account-message', 'Utente non verificato o email mancante. Impossibile procedere.', false); return;
    }
    if (confirmEmail !== currentUserDataFromStorage.email) {
      displayMessage('delete-account-message', 'L\'email inserita non corrisponde a quella del tuo account.', false); return;
    }
    if (confirm('ATTENZIONE! Sei assolutamente sicuro di voler eliminare il tuo account? Questa azione è IRREVERSIBILE e tutti i tuoi dati (profilo, prenotazioni, icone generate, ecc.) verranno cancellati definitivamente.')) {
      if (confirm('CONFERMA FINALE: Questa è l\'ultima possibilità per annullare. Procedere con l\'eliminazione definitiva dell\'account?')) {
        deleteButton.disabled = true; deleteButton.textContent = 'Eliminazione in corso...';
        try {
          // L'API api_delete_account.php dovrebbe gestire la cancellazione sicura
          const response = await callApi('api/api_delete_account.php', 'POST', { email: confirmEmail });
          if (response.success) {
            displayMessage('delete-account-message', response.message || "Account eliminato con successo.", true, false); // Non cancellare subito
            alert(response.message || "Il tuo account è stato eliminato. Verrai reindirizzato alla homepage.");
            logout(false); // Esegui il logout client-side senza mostrare un altro alert
            setTimeout(() => { window.location.href = 'index.html'; }, 2500);
          } else { throw new Error(response.message || 'Errore durante l\'eliminazione dell\'account.'); }
        } catch (error) {
          // handleApiError gestirà il logout se è un 401/403 (improbabile qui se l'utente è loggato per iniziare)
          handleApiError(error, 'delete-account-message', 'Errore durante l\'eliminazione dell\'account.');
          deleteButton.disabled = false; deleteButton.textContent = 'Elimina il Mio Account Definitivamente';
        }
      }
    }
  }

  function logout(showAlert = true) {
    const wasLoggedIn = !!localStorage.getItem('userDataEFF');
    localStorage.removeItem('userDataEFF');
    currentUserDataFromStorage = null; // Resetta la variabile globale

    // Chiamata API per invalidare la sessione sul server
    fetch('api/api_logout.php', { method: 'POST', credentials: 'same-origin' }) // Assicurati che esista
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                if (showAlert && wasLoggedIn) alert('Logout effettuato con successo. Verrai reindirizzato alla homepage.');
              } else {
                if (showAlert && wasLoggedIn) alert('Logout dal server fallito, ma i dati locali sono stati rimossi. Verrai reindirizzato.');
              }
            })
            .catch(error => {
              console.error("Errore API logout:", error);
              if (showAlert && wasLoggedIn) alert('Errore durante il logout dal server. Verrai reindirizzato.');
            })
            .finally(() => {
              // Se ci troviamo in areapersonale.html, reindirizza sempre a index.html dopo il logout.
              // Altrimenti, se showAlert è true (logout standard da altre pagine), reindirizza.
              if (window.location.pathname.includes("areapersonale.html") || showAlert) {
                // Se siamo già in areapersonale, non c'è bisogno di reindirizzare subito,
                // initializeUIForGuest dovrebbe aver già resettato la pagina.
                // Ma se è un logout esplicito (showAlert=true), allora reindirizza.
                if (showAlert) {
                  window.location.href = 'index.html';
                } else {
                  // Se showAlert è false (es. da sessione scaduta rilevata in areapersonale),
                  // initializeUIForGuest è già stata chiamata.
                  // Potresti voler aggiornare la navbar qui se non già fatto da initializeUIForGuest
                  const navbarUsername = document.getElementById('navbar-username');
                  const navbarAvatarImg = document.querySelector('#navbar-avatar img');
                  if (navbarUsername) navbarUsername.textContent = 'Ospite';
                  if (navbarAvatarImg) navbarAvatarImg.src = getDisplayIconPath(defaultIconPath);
                }
              }
            });
  }
</script>
</body>
</html>
