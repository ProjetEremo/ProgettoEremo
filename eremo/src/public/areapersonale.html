<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Personale - Eremo Frate Francesco</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    /* Stili CSS di base minimi - Assicurati che quelli completi e i nuovi per le animazioni
       siano nel tuo file style.css come da istruzioni precedenti */
    .avatar-options-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; margin-top: 1rem; margin-bottom: 1rem; }
    .avatar-option-image { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; cursor: pointer; border: 3px solid transparent; transition: border-color 0.3s ease; }
    .avatar-option-image.selected { border-color: var(--primary); box-shadow: 0 0 10px rgba(141, 177, 135, 0.5); }
    .avatar-container#main-avatar img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid var(--white); box-shadow: var(--shadow-light); }
    .user-avatar#navbar-avatar img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; } /* Stile per icona navbar */
    .profile-header .avatar-container { width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; margin-bottom: 0.5rem; }
    .form-message { margin-top: 1rem; padding: 0.8rem 1rem; border-radius: 8px; font-size: 0.95rem; text-align: center; display: none; }
    .form-message.success { background-color: rgba(46, 204, 113, 0.15); border: 1px solid var(--success, green); color: var(--dark, black); }
    .form-message.error { background-color: rgba(231, 76, 60, 0.15); border: 1px solid var(--danger, red); color: var(--dark, black); }
    .btn-danger { background-color: var(--danger); color: white; border: none; padding: 1rem 2.2rem; border-radius: 10px; font-size: 1.25rem; font-weight: 500; cursor: pointer; transition: var(--transition-medium); display: block; width: fit-content; margin: 2.6rem auto 0; }
    .btn-danger:hover { background-color: #c0392b; transform: translateY(-3px); box-shadow: var(--shadow-light); }

    /* STILI PER SEZIONE AI ICON GENERATOR (assicurati siano in style.css o qui) */
    .ai-icon-generator-section { position: relative; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px dashed var(--gray-medium); }
    .ai-title-container { position: relative; display: inline-block; margin-bottom: 1.8rem; }
    .ai-icon-generator-section h3 { font-family: 'Segoe UI', sans-serif; font-size: 1.6rem; color: var(--secondary); text-align: left; display: flex; align-items: center; gap: 10px; font-weight: 600; margin-bottom: 0; }
    .ai-icon-generator-section h3 i.fa-magic { font-size: 1.2em; color: var(--secondary); margin-right: 8px; }
    .star-title { position: absolute; background-color: var(--accent); border-radius: 50%; opacity: 0; animation: twinkleAround 2s infinite ease-in-out; box-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent); }
    @keyframes twinkleAround { 0%, 100% { opacity: 0.3; transform: scale(0.5) rotate(0deg); } 50% { opacity: 1; transform: scale(1.1) rotate(180deg); } 75% { opacity: 0.7; transform: scale(0.8) rotate(270deg); }}
    .star-title.s1 { width: 3px; height: 3px; top: -5px; left: -10px; animation-delay: 0s; }
    .star-title.s2 { width: 4px; height: 4px; top: 0px; right: -15px; animation-delay: 0.3s; }
    .star-title.s3 { width: 3px; height: 3px; bottom: -5px; left: 20%; animation-delay: 0.6s; }
    .star-title.s4 { width: 4px; height: 4px; bottom: 0px; right: 15%; animation-delay: 0.9s; }
    .star-title.s5 { width: 3px; height: 3px; top: 50%; left: -20px; transform: translateY(-50%); animation-delay: 1.2s; }
    .star-title.s6 { width: 2px; height: 2px; top: 20%; right: -25px; animation-delay: 1.5s; }
    .ai-icon-generator-section .form-group label { font-size: 1.1rem; color: var(--primary); font-weight: 500; }
    .ai-icon-generator-section textarea#ai-icon-prompt { width: 100%; padding: 0.8rem 1rem; border: 1px solid var(--gray-medium); border-radius: 8px; font-size: 1rem; min-height: 70px; resize: vertical; margin-bottom: 0.5rem; background-color: var(--white); transition: border-color 0.3s ease, box-shadow 0.3s ease;}
    .ai-icon-generator-section textarea#ai-icon-prompt:focus { border-color: var(--secondary); box-shadow: 0 0 0 3.5px rgba(141, 177, 135, 0.3); outline: none; }
    .ai-icon-generator-section .btn-ai-generate { background: linear-gradient(145deg, var(--secondary), var(--primary)); color: white; border: none; padding: 0.9rem 1.8rem; border-radius: 10px; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: inline-flex; align-items: center; gap: 0.6em; margin-top: 0.5rem; box-shadow: 0 4px 15px rgba(var(--dark-rgb, 30, 59, 47), 0.2), 0 2px 8px rgba(var(--dark-rgb, 30, 59, 47), 0.15); text-shadow: 1px 1px 2px rgba(0,0,0,0.2); position: relative; overflow: hidden; }
    .ai-icon-generator-section .btn-ai-generate i.fa-lightbulb { transition: transform 0.3s ease; }
    .ai-icon-generator-section .btn-ai-generate:hover:not(:disabled) { background: linear-gradient(145deg, var(--primary), var(--secondary)); transform: translateY(-3px) scale(1.03); box-shadow: 0 8px 25px rgba(var(--dark-rgb, 30, 59, 47), 0.25), 0 4px 12px rgba(var(--dark-rgb, 30, 59, 47), 0.2); }
    .ai-icon-generator-section .btn-ai-generate:hover:not(:disabled) i.fa-lightbulb { transform: scale(1.2) rotate(-15deg); }
    .ai-icon-generator-section .btn-ai-generate:active:not(:disabled) { transform: translateY(-1px) scale(0.99); box-shadow: 0 2px 10px rgba(var(--dark-rgb, 30, 59, 47), 0.2); }
    .ai-icon-generator-section .btn-ai-generate::before { content: ""; position: absolute; top: 50%; left: 50%; width: 0; height: 0; background: rgba(255, 255, 255, 0.2); border-radius: 50%; transform: translate(-50%, -50%); opacity: 0; transition: width 0.4s ease, height 0.4s ease, opacity 0.4s ease; }
    .ai-icon-generator-section .btn-ai-generate:hover:not(:disabled)::before { width: 250%; height: 250%; opacity: 0.3; }
    .ai-icon-generator-section .btn-ai-generate:disabled { background: var(--gray-medium) !important; color: var(--gray-dark) !important; box-shadow: none !important; transform: none !important; cursor: not-allowed; }
    .ai-icon-generator-section .btn-ai-generate:disabled i.fa-lightbulb { transform: none; }
    .ai-section-loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(248, 245, 239, 0.85); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 20; border-radius: var(--border-radius-medium); opacity: 0; visibility: hidden; transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1), visibility 0s linear 0.35s; }
    .ai-section-loading-overlay.active { opacity: 1; visibility: visible; transition-delay: 0s; }
    .modern-spinner { width: 48px; height: 48px; border-radius: 50%; display: inline-block; position: relative; border: 3px solid; border-color: var(--secondary) var(--secondary) transparent transparent; box-sizing: border-box; animation: spin 1s linear infinite; margin-bottom: 1.2rem; }
    .modern-spinner::after, .modern-spinner::before { content: ''; box-sizing: border-box; position: absolute; left: 0; right: 0; top: 0; bottom: 0; margin: auto; border: 3px solid; border-color: transparent transparent var(--primary) var(--primary); width: 40px; height: 40px; border-radius: 50%; animation: spinBack 0.7s linear infinite; transform-origin: center center; }
    .modern-spinner::before { width: 32px; height: 32px; border-color: var(--accent) var(--accent) transparent transparent; animation: spin 1.5s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes spinBack { 0% { transform: rotate(0deg); } 100% { transform: rotate(-360deg); } }
    .ai-section-loading-overlay p { font-size: 1.05rem; color: var(--primary); font-weight: 500; letter-spacing: 0.5px; }
    #ai-generated-icon-preview-container { margin-top: 2rem; border: 1px solid var(--gray-light); box-shadow: 0 6px 18px rgba(0,0,0,0.08); padding: 1.5rem; background-color: var(--white); opacity: 0; transform: translateY(15px) scale(0.98); transition: opacity 0.4s ease-out, transform 0.4s ease-out; }
    #ai-generated-icon-preview-container.revealed { opacity: 1; transform: translateY(0) scale(1); }
    #ai-generated-icon-preview-container p { font-size: 0.95rem; color: var(--gray-dark); margin-bottom: 0.8rem; text-align: center; }
    #ai-generated-icon-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid var(--gray-light); box-shadow: 0 4px 10px rgba(0,0,0,0.12); cursor: pointer; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), border-color 0.3s ease, box-shadow 0.3s ease; display: block; margin-left: auto; margin-right: auto;}
    #ai-generated-icon-preview.selected { border-color: var(--primary); box-shadow: 0 0 0 4px var(--white), 0 0 0 7px var(--primary), 0 8px 20px rgba(var(--primary-rgb, 54, 94, 81), 0.4); transform: scale(1.1); }
    #ai-icon-message.form-message { margin-top: 1rem; }

    /* ANIMAZIONE BOTTONE SALVATAGGIO */
    .btn-save#save-icon-btn { position: relative; overflow: hidden; }
    .btn-save#save-icon-btn .btn-text { display: inline-block; transition: opacity 0.2s ease, transform 0.2s ease; }
    .btn-save#save-icon-btn .btn-icon-fa { transition: opacity 0.2s ease, transform 0.2s ease; margin-right: 8px; }
    .btn-save#save-icon-btn.saving { background-color: var(--accent) !important; color: white !important; cursor: wait; }
    .btn-save#save-icon-btn.saving .btn-text,
    .btn-save#save-icon-btn.saving .btn-icon-fa.fa-save { opacity: 0; transform: translateY(-5px); display:none !important; }
    .btn-save#save-icon-btn .spinner-btn-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease; pointer-events:none; }
    .btn-save#save-icon-btn.saving .spinner-btn-overlay { opacity: 1; }
    .btn-save#save-icon-btn .spinner-btn-overlay .modern-spinner { width: 20px; height: 20px; border-width: 2px; margin: 0; border-color: white white transparent transparent; }
    .btn-save#save-icon-btn .spinner-btn-overlay .modern-spinner::after,
    .btn-save#save-icon-btn .spinner-btn-overlay .modern-spinner::before { border-width: 2px; }
    .btn-save#save-icon-btn .spinner-btn-overlay .modern-spinner::after { width: 16px; height: 16px; border-color: transparent transparent white white; }
    .btn-save#save-icon-btn .spinner-btn-overlay .modern-spinner::before { width: 12px; height: 12px; border-color: rgba(255,255,255,0.7) rgba(255,255,255,0.7) transparent transparent;}
    .btn-save#save-icon-btn.saved-success { background-color: var(--success) !important; color: white !important; }
    .btn-save#save-icon-btn.saved-success .btn-icon-fa.fa-save { display: none !important; }
    .btn-save#save-icon-btn.saved-success .btn-icon-fa.fa-check { display: inline-block !important; animation: bounceIn 0.5s ease; }
    @keyframes bounceIn { 0%,100%,20%,40%,60%,80%{transition-timing-function:cubic-bezier(.215,.61,.355,1)}0%{opacity:0;transform:scale3d(.3,.3,.3)}20%{transform:scale3d(1.1,1.1,1.1)}40%{transform:scale3d(.9,.9,.9)}60%{opacity:1;transform:scale3d(1.03,1.03,1.03)}80%{transform:scale3d(.97,.97,.97)}100%{opacity:1;transform:scale3d(1,1,1)}}

    #icon-save-message.form-message.toast-style { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 0.9rem 1.5rem; border-radius: 10px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); z-index: 10010; font-size: 0.95rem; font-weight: 500; opacity: 0; transition: opacity 0.4s cubic-bezier(0.23, 1, 0.32, 1), bottom 0.4s cubic-bezier(0.23, 1, 0.32, 1); min-width: 280px; max-width: 90%; text-align: center;}
    #icon-save-message.form-message.toast-style.show { opacity: 1; bottom: 25px; }
    #icon-save-message.form-message.toast-style.success { background-color: var(--success) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; }
    #icon-save-message.form-message.toast-style.error { background-color: var(--danger) !important; color: white !important; border: 1px solid rgba(255,255,255,0.2) !important; }

  </style>
</head>
<body>

<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="index.html" style="text-decoration: none; color: inherit;">
        <span class="emoji">üèîÔ∏è</span>
        <h2>Eremo Frate Francesco</h2>
      </a>
    </div>
    <div class="menu">
      <a href="eventiincorso.html">Calendario attivit√†</a>
      <a href="eventipassati.html">Archivio attivit√†</a>
      <span class="separator">|</span>
      <a href="incontrisullaparola.html">Incontri sulla parola</a>
      <span class="separator">|</span>
      <a href="dovesiamo.html">Dove siamo</a>
      <a href="contatti.html">Contatti</a>
    </div>
    <div class="right-menu">
      <div class="user-dropdown" id="userDropdownContainer">
        <button class="user-btn" onclick="toggleUserMenu(event)" aria-haspopup="true" aria-expanded="false">
          <span class="user-avatar" id="navbar-avatar"><img src="/uploads/icons/default_user.png" alt="User"></span>
          <span class="user-name" id="navbar-username">Ospite</span>
          <span class="dropdown-arrow">‚ñº</span>
        </button>
        <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
          <a href="areapersonale.html">Il mio profilo</a>
          <a href="areapersonale.html#prenotazioni">Le mie prenotazioni</a> <a href="#" onclick="logout()">Esci</a>
        </div>
      </div>
      <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorso.html" onclick="closeMobileMenu()">Calendario attivit√†</a>
    <a href="eventipassati.html" onclick="closeMobileMenu()">Archivio attivit√†</a>
    <a href="incontrisullaparola.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
    <a href="dovesiamo.html" onclick="closeMobileMenu()">Dove siamo</a>
    <a href="contatti.html" onclick="closeMobileMenu()">Contatti</a>
    <hr style="border-color: rgba(255,255,255,0.1);">
    <a href="areapersonale.html" onclick="closeMobileMenu()">Il mio profilo</a>
    <a href="areapersonale.html#prenotazioni" onclick="closeMobileMenu()">Le mie prenotazioni</a>
    <a href="#" onclick="logout(); closeMobileMenu();">Esci</a>
  </div>
</header>

<main>
  <div class="profile-header">
    <div class="avatar-container" id="main-avatar">
      <img src="/uploads/icons/default_user.png" alt="Icona Profilo Utente">
    </div>
    <h1 id="profile-greeting">Area Personale</h1>
    <p>Gestisci le tue informazioni personali e le preferenze.</p>
  </div>

  <div class="container">
    <section class="profile-section">
      <h2><i class="fas fa-user-edit" style="margin-right: 8px;"></i> Informazioni Personali</h2>
      <form id="profile-info-form">
        <div class="form-grid">
          <div class="form-group"> <label for="nome">Nome</label> <input type="text" id="nome" name="nome" class="form-control" required> </div>
          <div class="form-group"> <label for="cognome">Cognome</label> <input type="text" id="cognome" name="cognome" class="form-control" required> </div>
          <div class="form-group full-width"> <label for="email">Email</label> <input type="email" id="email" name="email" class="form-control" disabled> </div>
        </div>
        <button type="submit" class="btn-save">Salva Info Personali</button>
        <p id="profile-info-message" class="form-message" style="display:none;"></p>
      </form>
    </section>

    <section class="profile-section">
      <h2><i class="fas fa-image" style="margin-right: 8px;"></i> Icona Profilo</h2>
      <p>Scegli un'icona che ti rappresenti tra quelle disponibili oppure generane una nuova con l'AI:</p>
      <div class="avatar-options-grid" id="avatar-options-container"> <p>Caricamento icone disponibili...</p> </div>

      <div class="ai-icon-generator-section">
        <div class="ai-section-loading-overlay" id="ai-section-loader">
          <div class="modern-spinner"></div>
          <p>Sto creando la tua icona...</p>
        </div>
        <div class="ai-title-container">
          <h3><i class="fas fa-magic"></i> Genera Icona con Eremo AI</h3>
          <span class="star-title s1"></span>
          <span class="star-title s2"></span>
          <span class="star-title s3"></span>
          <span class="star-title s4"></span>
          <span class="star-title s5"></span>
          <span class="star-title s6"></span>
        </div>
        <div class="form-group">
          <label for="ai-icon-prompt">Descrivi l'icona che vorresti (es. "gatto saggio con occhiali", "montagna stilizzata all'alba"):</label>
          <textarea id="ai-icon-prompt" rows="3" class="form-control" placeholder="Max 250 caratteri..."></textarea>
        </div>
        <button type="button" class="btn-ai-generate cool-ai-btn" id="btn-generate-ai-icon">
          <span class="ai-btn-content-wrapper">
              <span class="ai-icon-btn"><i class="fas fa-lightbulb"></i></span>
              <span class="ai-text-btn">Genera Icona</span>
          </span>
          <span class="ai-ripple-container-btn"></span>
        </button>
        <div id="ai-generated-icon-preview-container" style="display:none;">
          <p>Icona generata (clicca per selezionarla):</p>
          <img src="#" alt="Icona Generata con AI" id="ai-generated-icon-preview">
        </div>
        <p id="ai-icon-message" class="form-message" style="display:none;"></p>
      </div>

      <button class="btn-save" id="save-icon-btn" style="margin-top: 2rem;">
        <i class="fas fa-save btn-icon-fa"></i>
        <span class="btn-text">Salva Icona Selezionata</span>
        <span class="spinner-btn-overlay" style="display: none;"><div class="modern-spinner"></div></span>
        <i class="fas fa-check btn-icon-fa" style="display: none;"></i>
      </button>
      <p id="icon-save-message" class="form-message" style="display:none;"></p>
    </section>

    <section class="profile-section">
      <h2><i class="fas fa-lock" style="margin-right: 8px;"></i> Sicurezza Account</h2>
      <form id="password-change-form">
        <div class="form-grid">
          <div class="form-group"> <label for="vecchia-password">Password Attuale</label> <input type="password" id="vecchia-password" class="form-control" required> </div>
          <div class="form-group"> <label for="nuova-password">Nuova Password</label> <input type="password" id="nuova-password" class="form-control" required minlength="8"> <small>Minimo 8 caratteri.</small> </div>
          <div class="form-group"> <label for="conferma-password">Conferma Nuova Password</label> <input type="password" id="conferma-password" class="form-control" required> </div>
        </div>
        <button type="submit" class="btn-save">Cambia Password</button>
        <p id="password-change-message" class="form-message" style="display:none;"></p>
      </form>
    </section>

    <section class="profile-section" id="prenotazioni">
      <h2><i class="fas fa-calendar-check" style="margin-right: 8px;"></i> Le Mie Prenotazioni</h2>
      <div id="user-bookings-grid" class="card-grid"> <p style="text-align:center; padding:1rem;">Caricamento prenotazioni...</p> </div>
      <div id="no-bookings-message" style="display: none; text-align: center; padding: 2rem;">
        <p>Non hai nessuna prenotazione attiva al momento.</p>
        <a href="eventiincorso.html" class="btn-primary" style="display: inline-block; margin-top: 1rem;">Scopri le attivit√†</a>
      </div>
    </section>

    <section class="profile-section" id="eventi-in-coda">
      <h2><i class="fas fa-hourglass-half" style="margin-right: 8px;"></i> Eventi in Lista d'Attesa</h2>
      <div id="user-waitlist-grid" class="card-grid">
        <p style="text-align:center; padding:1rem;">Caricamento eventi in coda...</p>
      </div>
      <div id="no-waitlist-message" style="display: none; text-align: center; padding: 2rem;">
        <p>Non sei in lista d'attesa per nessun evento al momento.</p>
      </div>
    </section>

    <section class="profile-section" id="delete-account-section">
      <h2><i class="fas fa-user-times" style="margin-right: 8px;"></i> Elimina Account</h2>
      <p style="color: var(--danger); text-align:center; margin-bottom: 1.5rem;">Attenzione: Questa azione √® irreversibile e canceller√† tutti i tuoi dati personali, incluse prenotazioni, commenti e iscrizioni alle liste d'attesa.</p>
      <form id="delete-account-form">
        <div class="form-group" style="max-width: 400px; margin-left:auto; margin-right:auto;">
          <label for="confirm-delete-email">Per confermare, inserisci la tua email:</label>
          <input type="email" id="confirm-delete-email" name="confirm-delete-email" class="form-control" required>
        </div>
        <button type="submit" class="btn-danger" id="btn-confirm-delete-account">Elimina il Mio Account Definitivamente</button>
        <p id="delete-account-message" class="form-message" style="display:none;"></p>
      </form>
    </section>
  </div>
</main>

<footer> <p>&copy; <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia</p> </footer>

<script>
  let lastScroll = 0;
  const navbarContainer = document.getElementById('navbarContainer');
  const mobileMenu = document.getElementById("mobileMenu");
  const hamburger = document.querySelector(".navbar .hamburger");
  const defaultIconPath = 'uploads/icons/default_user.png';
  let selectedIconPath = defaultIconPath;
  let currentUserDataFromStorage = null;

  let aiSectionLoaderEl, aiPreviewContainerEl, saveIconBtnEl, saveIconBtnOriginalText;
  let loadAvailableIconsCallCount = 0;

  if (navbarContainer) {
    window.addEventListener('scroll', function() {
      const currentScroll = window.pageYOffset;
      if (currentScroll <= 50) { navbarContainer.classList.remove('hidden'); lastScroll = 0; return; }
      if (currentScroll > lastScroll && !navbarContainer.classList.contains('hidden')) { navbarContainer.classList.add('hidden'); }
      else if (currentScroll < lastScroll && navbarContainer.classList.contains('hidden')) { navbarContainer.classList.remove('hidden'); }
      lastScroll = currentScroll;
    });
  }
  function toggleMobileMenu() {
    const isOpen = mobileMenu.classList.toggle('open');
    if (hamburger) { hamburger.classList.toggle('open'); hamburger.setAttribute('aria-expanded', String(isOpen));}
    document.body.style.overflow = isOpen ? 'hidden' : '';
  }
  function closeMobileMenu() {
    if (mobileMenu) mobileMenu.classList.remove('open');
    if (hamburger) { hamburger.classList.remove('open'); hamburger.setAttribute('aria-expanded', 'false');}
    document.body.style.overflow = '';
  }
  function toggleUserMenu(event) {
    if (event) event.stopPropagation();
    const dropdown = document.querySelector('.user-dropdown .dropdown-menu');
    const btn = document.querySelector('.user-dropdown .user-btn');
    if (dropdown && btn) {
      const isOpen = dropdown.style.display === 'block';
      dropdown.style.display = isOpen ? 'none' : 'block';
      btn.setAttribute('aria-expanded', String(!isOpen));
    }
  }
  document.addEventListener('click', function(event) {
    const userDropdownContainer = document.getElementById('userDropdownContainer');
    const dropdownMenu = document.querySelector('.user-dropdown .dropdown-menu');
    if (dropdownMenu && dropdownMenu.style.display === 'block') {
      if (userDropdownContainer && !userDropdownContainer.contains(event.target)) {
        dropdownMenu.style.display = 'none';
        const userBtn = document.querySelector('.user-dropdown .user-btn');
        if (userBtn) userBtn.setAttribute('aria-expanded', 'false');
      }
    }
    if (mobileMenu && mobileMenu.classList.contains('open')) {
      if (!mobileMenu.contains(event.target) && hamburger && !hamburger.contains(event.target)) {
        closeMobileMenu();
      }
    }
  });

  function displayMessage(elementId, message, isSuccess, clearAfter = true, isToast = false) {
    const el = document.getElementById(elementId);
    if (el) {
      el.innerHTML = message;
      el.className = 'form-message';
      if (isSuccess) el.classList.add('success'); else el.classList.add('error');

      if (isToast) {
        el.classList.add('toast-style');
        void el.offsetWidth;
        requestAnimationFrame(() => { el.classList.add('show'); });
      } else {
        el.classList.remove('toast-style', 'show');
      }
      el.style.display = 'block';

      if(clearAfter){
        const timeoutDuration = isToast ? 3500 : (isSuccess ? 5000 : 7000);
        setTimeout(() => {
          if(el) {
            if (isToast && el.classList.contains('toast-style')) {
              el.classList.remove('show');
              el.addEventListener('transitionend', () => {
                if (el.classList.contains('toast-style')) { el.style.display = 'none'; }
              }, { once: true });
            } else if (!isToast) { el.style.display = 'none'; }
          }
        }, timeoutDuration);
      }
    }
  }

  async function callApi(url, method = 'GET', data = null) {
    const headers = { 'Content-Type': 'application/json' };
    const options = { method, headers, credentials: 'same-origin' };
    if (data && (method === 'POST' || method === 'PUT' || method === 'DELETE')) {
      options.body = JSON.stringify(data);
    }
    try {
      const response = await fetch(url, options);
      if (!response.ok) {
        let errorData = { message: `Errore HTTP ${response.status} (${response.statusText}) per ${url}` };
        let rawErrorText = '';
        try {
          rawErrorText = await response.text();
          console.debug("Raw error response from callApi to " + url + ":", rawErrorText);
          errorData = JSON.parse(rawErrorText);
        } catch (e) {
          errorData.message = rawErrorText || errorData.message;
        }
        const finalErrorMessage = errorData.message || `Errore del server: ${response.status} per ${url}`;
        throw new Error(finalErrorMessage);
      }
      if (response.status === 204) return {};
      const contentType = response.headers.get("content-type");
      if (contentType && contentType.indexOf("application/json") !== -1) {
        return await response.json();
      } else {
        const textResponse = await response.text();
        return { success: true, data: textResponse, message: textResponse };
      }
    } catch (error) {
      console.error(`Fallimento chiamata API PHP ${url}:`, error.message);
      throw error;
    }
  }

  function initializeUIForGuest(errorMessage = "Funzionalit√† non disponibile. Effettua il login.") {
    const mainAvatarImg = document.querySelector('#main-avatar img');
    const navbarAvatarImg = document.querySelector('#navbar-avatar img');
    const navbarUsername = document.getElementById('navbar-username');
    const profileGreeting = document.getElementById('profile-greeting');
    if(mainAvatarImg) mainAvatarImg.src = defaultIconPath; // Usa direttamente il path senza slash iniziale
    if(navbarAvatarImg) navbarAvatarImg.src = defaultIconPath;
    if(navbarUsername) navbarUsername.textContent = 'Ospite';
    if(profileGreeting) profileGreeting.textContent = 'Area Personale';
    const emailInput = document.getElementById('email');
    if(emailInput) emailInput.value = '';
    document.querySelectorAll('#profile-info-form input:not(#email), #profile-info-form button, #save-icon-btn, #password-change-form input, #password-change-form button, #delete-account-form input, #delete-account-form button, #btn-generate-ai-icon, #ai-icon-prompt').forEach(el => el.disabled = true);
    const avatarContainer = document.getElementById('avatar-options-container');
    if(avatarContainer) avatarContainer.innerHTML = `<p>${errorMessage}</p>`;
    const bookingsGrid = document.getElementById('user-bookings-grid');
    if(bookingsGrid) bookingsGrid.innerHTML = `<p style="text-align:center;">${errorMessage}</p>`;
    const waitlistGrid = document.getElementById('user-waitlist-grid');
    if(waitlistGrid) waitlistGrid.innerHTML = `<p style="text-align:center;">${errorMessage}</p>`;
    const aiIconMessageEl = document.getElementById('ai-icon-message');
    if(aiIconMessageEl) displayMessage('ai-icon-message', errorMessage, false, false);
    const noBookingsMsg = document.getElementById('no-bookings-message');
    if(noBookingsMsg) noBookingsMsg.style.display = 'none';
    const noWaitlistMsg = document.getElementById('no-waitlist-message');
    if(noWaitlistMsg) noWaitlistMsg.style.display = 'none';
    if(aiSectionLoaderEl) aiSectionLoaderEl.classList.remove('active');
    if(errorMessage !== "Funzionalit√† non disponibile. Effettua il login.") {
      displayMessage('profile-info-message', errorMessage, false);
    }
  }

  function normalizeIconPath(path) {
    if (!path) return defaultIconPath; // defaultIconPath √® gi√† 'uploads/icons/...'
    if (path.startsWith('data:image/')) return path;
    if (path.startsWith('/')) {
      return path.substring(1); // Rimuove lo slash iniziale
    }
    return path; // Gi√† nel formato 'uploads/icons/...'
  }

  // Funzione per ottenere il path corretto per l'attributo src dell'immagine
  function getDisplayIconPath(normalizedPath) {
    if (!normalizedPath) return '/' + defaultIconPath;
    if (normalizedPath.startsWith('data:image/')) return normalizedPath;
    if (normalizedPath.startsWith('http')) return normalizedPath; // Se √® un URL completo
    return '/' + normalizedPath; // Aggiunge lo slash per path relativi alla root
  }


  document.addEventListener('DOMContentLoaded', async () => {
    aiSectionLoaderEl = document.getElementById('ai-section-loader');
    aiPreviewContainerEl = document.getElementById('ai-generated-icon-preview-container');
    saveIconBtnEl = document.getElementById('save-icon-btn');
    if (saveIconBtnEl) {
      const textSpan = saveIconBtnEl.querySelector('.btn-text');
      saveIconBtnOriginalText = textSpan ? textSpan.textContent : "Salva Icona Selezionata";

      let spinnerOverlay = saveIconBtnEl.querySelector('.spinner-btn-overlay');
      if (!spinnerOverlay) {
        spinnerOverlay = document.createElement('span');
        spinnerOverlay.className = 'spinner-btn-overlay';
        spinnerOverlay.innerHTML = '<div class="modern-spinner"></div>';
        saveIconBtnEl.appendChild(spinnerOverlay);
      }
      spinnerOverlay.style.display = 'none';

      const iconNode = saveIconBtnEl.querySelector('.fas.fa-save');
      if (iconNode && !iconNode.classList.contains('btn-icon-fa')) {
        iconNode.classList.add('btn-icon-fa');
      }

      let checkIcon = saveIconBtnEl.querySelector('.btn-icon-fa.fa-check');
      if (!checkIcon && iconNode && iconNode.classList.contains('fa-save') ) {
        checkIcon = document.createElement('i');
        checkIcon.className = 'fas fa-check btn-icon-fa';
        const existingTextSpan = saveIconBtnEl.querySelector('.btn-text');
        if(existingTextSpan) { iconNode.parentNode.insertBefore(checkIcon, existingTextSpan); }
        else if (iconNode.nextSibling) { iconNode.parentNode.insertBefore(checkIcon, iconNode.nextSibling); }
        else { iconNode.parentNode.appendChild(checkIcon); }
      }
      if(checkIcon) checkIcon.style.display = 'none';
    }

    const currentYearEl = document.getElementById('currentYear');
    if(currentYearEl) currentYearEl.textContent = new Date().getFullYear();

    const userDataString = localStorage.getItem('userDataEFF');
    if (userDataString) {
      try {
        currentUserDataFromStorage = JSON.parse(userDataString);
        const navbarUsername = document.getElementById('navbar-username');
        const navbarAvatarImg = document.querySelector('#navbar-avatar img');
        const mainAvatarImg = document.querySelector('#main-avatar img');
        const profileGreeting = document.getElementById('profile-greeting');
        const emailInput = document.getElementById('email');
        const nomeInput = document.getElementById('nome');
        const cognomeInput = document.getElementById('cognome');

        if (navbarUsername) navbarUsername.textContent = currentUserDataFromStorage.nome || 'Utente';

        selectedIconPath = normalizeIconPath(currentUserDataFromStorage.iconPath || defaultIconPath);

        if (navbarAvatarImg) navbarAvatarImg.src = getDisplayIconPath(selectedIconPath);
        if (mainAvatarImg) mainAvatarImg.src = getDisplayIconPath(selectedIconPath);

        if (profileGreeting) profileGreeting.textContent = `Ciao, ${currentUserDataFromStorage.nome || 'Utente'}!`;
        if (emailInput) emailInput.value = currentUserDataFromStorage.email || '';
        if(nomeInput) nomeInput.value = currentUserDataFromStorage.nome || '';
        if(cognomeInput) cognomeInput.value = currentUserDataFromStorage.cognome || '';

      } catch(e) {
        currentUserDataFromStorage = null;
        initializeUIForGuest("Errore nel caricamento dei dati locali. Prova a ricaricare o effettua nuovamente il login.");
      }
    } else {
      initializeUIForGuest("Effettua il login per accedere a tutte le funzionalit√†.");
    }

    try {
      if (currentUserDataFromStorage) {
        await loadUserProfileFromServer();
        await loadAvailableIcons();
        await loadUserBookings();
        await loadUserWaitlist();
        document.getElementById('btn-generate-ai-icon').disabled = false;
        document.getElementById('ai-icon-prompt').disabled = false;
      } else {
        document.querySelectorAll('#profile-info-form input:not(#email), #profile-info-form button, #save-icon-btn, #password-change-form input, #password-change-form button, #delete-account-form input, #delete-account-form button, #btn-generate-ai-icon, #ai-icon-prompt').forEach(el => el.disabled = true);
        if(aiSectionLoaderEl) aiSectionLoaderEl.classList.remove('active');
      }
    } catch (error) {
      console.error("Errore durante il setup iniziale della pagina (DOMContentLoaded):", error);
      const profileInfoMessage = document.getElementById('profile-info-message');
      if (profileInfoMessage) displayMessage('profile-info-message', 'Si √® verificato un errore critico durante il caricamento della pagina. Riprova pi√π tardi.', false, false);
      initializeUIForGuest('Errore caricamento dati profilo. Riprova.');
    }

    document.getElementById('btn-generate-ai-icon')?.addEventListener('click', handleGenerateAiIcon);
    document.getElementById('ai-generated-icon-preview')?.addEventListener('click', handleSelectAiGeneratedIcon);
    if(saveIconBtnEl) saveIconBtnEl.addEventListener('click', handleSaveIcon);

    if (window.location.hash === '#prenotazioni') {
      const el = document.getElementById('prenotazioni'); if(el) el.scrollIntoView({behavior:'smooth'});
    }
    document.getElementById('delete-account-form')?.addEventListener('submit', handleDeleteAccount);
    console.log("DOMContentLoaded completato e listeners attaccati.");
  });

  async function loadUserProfileFromServer() {
    console.log("loadUserProfileFromServer CHIAMATA");
    const mainAvatarImg = document.querySelector('#main-avatar img');
    const navbarAvatarImg = document.querySelector('#navbar-avatar img');
    const navbarUsername = document.getElementById('navbar-username');
    const profileGreeting = document.getElementById('profile-greeting');
    try {
      const apiUserData = await callApi('api/api_get_user_profile.php');
      console.log("loadUserProfileFromServer: Dati ricevuti", apiUserData);
      if (apiUserData && apiUserData.success) {
        const data = apiUserData.data;
        document.getElementById('nome').value = data.nome || '';
        document.getElementById('cognome').value = data.cognome || '';
        document.getElementById('email').value = data.email || (currentUserDataFromStorage ? currentUserDataFromStorage.email : '');

        let serverIconPath = data.icon || defaultIconPath;
        selectedIconPath = normalizeIconPath(serverIconPath);

        if(mainAvatarImg) mainAvatarImg.src = getDisplayIconPath(selectedIconPath);
        if(navbarAvatarImg) navbarAvatarImg.src = getDisplayIconPath(selectedIconPath);
        if(navbarUsername) navbarUsername.textContent = data.nome || 'Utente';
        if(profileGreeting) profileGreeting.textContent = `Ciao, ${data.nome || 'Utente'}!`;

        currentUserDataFromStorage = {
          nome: data.nome, cognome: data.cognome, email: data.email,
          iconPath: selectedIconPath
        };
        localStorage.setItem('userDataEFF', JSON.stringify(currentUserDataFromStorage));
      } else {
        console.error("loadUserProfileFromServer: Errore API o dati mancanti", apiUserData);
        displayMessage('profile-info-message', (apiUserData && apiUserData.message) ? apiUserData.message : "Errore recupero profilo.", false);
      }
    } catch (error) {
      console.error("loadUserProfileFromServer: Errore CATCH", error);
      displayMessage('profile-info-message', `Errore caricamento profilo: ${error.message}.`, false);
    }
  }

  function updateIconSelectionVisual() {
    console.log("updateIconSelectionVisual CHIAMATA con selectedIconPath:", selectedIconPath);
    document.querySelectorAll('.avatar-option-image.selected').forEach(sel => sel.classList.remove('selected'));
    const aiPreviewImg = document.getElementById('ai-generated-icon-preview');
    if (aiPreviewImg) aiPreviewImg.classList.remove('selected');

    const normalizedComparePath = normalizeIconPath(selectedIconPath);

    const currentSelectedPredefinedImg = document.querySelector(`.avatar-option-image[data-path="${normalizedComparePath}"]`);
    if (currentSelectedPredefinedImg) {
      currentSelectedPredefinedImg.classList.add('selected');
      console.log("Icona predefinita selezionata:", normalizedComparePath);
    }
    else if (selectedIconPath && selectedIconPath.startsWith('data:image/') && aiPreviewImg) {
      aiPreviewImg.classList.add('selected');
      console.log("Icona AI (base64) selezionata.");
    } else {
      if(aiPreviewImg && selectedIconPath && aiPreviewImg.src.endsWith(selectedIconPath)){
        aiPreviewImg.classList.add('selected');
        console.log("Icona AI (da server) selezionata nell'anteprima.");
      } else {
        console.log("Nessuna icona corrisponde a selectedIconPath per la selezione visiva:", selectedIconPath);
      }
    }
  }

  async function loadAvailableIcons() {
    loadAvailableIconsCallCount++;
    console.log(`loadAvailableIcons CHIAMATA NUMERO: ${loadAvailableIconsCallCount}`);

    const container = document.getElementById('avatar-options-container');
    if (!container) { console.error("loadAvailableIcons: Contenitore avatar non trovato!"); return; }
    container.innerHTML = '<p>Caricamento icone disponibili...</p>';

    try {
      console.log("loadAvailableIcons: Chiamata a api_get_icons.php...");
      const iconsData = await callApi('api/api_get_icons.php');
      console.log("loadAvailableIcons: Risposta da api_get_icons.php:", iconsData);

      if (iconsData && iconsData.success && iconsData.icons) {
        if (iconsData.icons.length > 0) {
          container.innerHTML = '';
          iconsData.icons.forEach(path => {
            const normalizedPath = normalizeIconPath(path);
            const img = document.createElement('img');
            img.src = getDisplayIconPath(normalizedPath);
            img.alt = 'Icona profilo';
            img.classList.add('avatar-option-image');
            img.setAttribute('data-path', normalizedPath);
            img.addEventListener('click', () => {
              if (!currentUserDataFromStorage) return;
              selectedIconPath = normalizedPath;
              updateIconSelectionVisual();
              const mainAvatarPreview = document.querySelector('#main-avatar img');
              if(mainAvatarPreview) mainAvatarPreview.src = getDisplayIconPath(selectedIconPath);
              const aiPreviewImg = document.getElementById('ai-generated-icon-preview');
              if (aiPreviewImg) aiPreviewImg.classList.remove('selected');
            });
            container.appendChild(img);
          });
          updateIconSelectionVisual();
        } else {
          container.innerHTML = `<p>${iconsData.message || 'Nessuna icona disponibile al momento.'}</p>`;
        }
      } else {
        console.error("loadAvailableIcons: Risposta API icone non valida o fallita:", iconsData);
        container.innerHTML = `<p>${(iconsData && iconsData.message) ? iconsData.message : 'Errore nel formato risposta icone.'}</p>`;
      }
    } catch (error) {
      console.error("loadAvailableIcons: Errore catch:", error);
      container.innerHTML = `<p class="form-message error" style="display:block;">Errore caricamento icone: ${error.message}</p>`;
    }
  }

  async function handleGenerateAiIcon() {
    if (!currentUserDataFromStorage) { displayMessage('ai-icon-message', 'Autenticazione richiesta.', false); return; }

    const promptInput = document.getElementById('ai-icon-prompt');
    const promptText = promptInput.value.trim();
    if (!promptText) { displayMessage('ai-icon-message', 'Inserisci una descrizione.', false); return; }

    const generateBtn = document.getElementById('btn-generate-ai-icon');
    const aiPreviewImg = document.getElementById('ai-generated-icon-preview');

    generateBtn.disabled = true;
    promptInput.disabled = true;
    if (aiSectionLoaderEl) aiSectionLoaderEl.classList.add('active');
    if (aiPreviewContainerEl) {
      aiPreviewContainerEl.style.display = 'none';
      aiPreviewContainerEl.classList.remove('revealed');
    }
    displayMessage('ai-icon-message', '', true, false);

    const CLOUDFLARE_WORKER_URL = 'https://text-to-image-template.tnt-teambom.workers.dev';

    try {
      console.log(`Chiamata al Worker Cloudflare: ${CLOUDFLARE_WORKER_URL} con prompt: "${promptText}"`);
      const response = await fetch(CLOUDFLARE_WORKER_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: promptText })
      });

      console.log("Risposta dal Worker - Status:", response.status);
      if (!response.ok) {
        const errorText = await response.text();
        let errorDetail = errorText;
        try {
          const errorJson = JSON.parse(errorText);
          errorDetail = errorJson.error || errorJson.message || errorText;
        } catch(e) { /* usa errorText */ }
        console.error("Errore dal Cloudflare Worker:", response.status, errorDetail);
        throw new Error(errorDetail || `Errore dal Worker AI: ${response.statusText}`);
      }

      const imageBlob = await response.blob();
      console.log("Risposta dal Worker - Blob ricevuto:", imageBlob);

      if (imageBlob.type && imageBlob.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onloadend = function() {
          aiPreviewImg.src = reader.result;
          if (aiPreviewContainerEl) {
            aiPreviewContainerEl.style.display = 'block';
            void aiPreviewContainerEl.offsetWidth;
            aiPreviewContainerEl.classList.add('revealed');
          }
          aiPreviewImg.classList.remove('selected');
          displayMessage('ai-icon-message', 'Icona generata! Cliccala per selezionarla e poi salvala.', true);
        }
        reader.readAsDataURL(imageBlob);
      } else {
        const errorText = await imageBlob.text();
        console.warn("Risposta dal Worker non √® un'immagine valida:", imageBlob, "Testo risposta:", errorText);
        displayMessage('ai-icon-message', `Risposta non valida dal servizio AI (formato non immagine). Dettagli: ${errorText.substring(0,100)}`, false);
      }

    } catch (error) {
      console.error("Errore chiamata Cloudflare Worker:", error);
      displayMessage('ai-icon-message', `Errore generazione AI: ${error.message}.`, false);
    } finally {
      generateBtn.disabled = false;
      promptInput.disabled = false;
      if (aiSectionLoaderEl) aiSectionLoaderEl.classList.remove('active');
    }
  }

  function handleSelectAiGeneratedIcon(event) {
    if (!currentUserDataFromStorage) return;
    const aiPreviewImg = event.target;
    if (aiPreviewImg.src && aiPreviewImg.src.startsWith('data:image/')) {
      selectedIconPath = aiPreviewImg.src; // √à base64
      updateIconSelectionVisual();
      const mainAvatarPreview = document.querySelector('#main-avatar img');
      if(mainAvatarPreview) mainAvatarPreview.src = selectedIconPath;
    }
  }

  async function handleSaveIcon() {
    if (!currentUserDataFromStorage || !saveIconBtnEl) return;

    let finalIconPathToServer = selectedIconPath;
    const textSpan = saveIconBtnEl.querySelector('.btn-text');
    const saveIcon = saveIconBtnEl.querySelector('.btn-icon-fa.fa-save');
    const checkIcon = saveIconBtnEl.querySelector('.btn-icon-fa.fa-check');
    const spinnerOverlay = saveIconBtnEl.querySelector('.spinner-btn-overlay');

    saveIconBtnEl.disabled = true;
    saveIconBtnEl.classList.remove('saved-success');
    saveIconBtnEl.classList.add('saving');
    if(textSpan) textSpan.style.opacity = '0';
    if(saveIcon) saveIcon.style.display = 'none';
    if(checkIcon) checkIcon.style.display = 'none';
    if(spinnerOverlay) spinnerOverlay.style.display = 'flex';

    if (selectedIconPath && selectedIconPath.startsWith('data:image/')) {
      displayMessage('icon-save-message', 'Salvataggio icona AI sul server...', true, false, true);
      try {
        const saveResponse = await callApi('api/api_save_ai_icon.php', 'POST', { imageBase64: selectedIconPath });
        if (saveResponse.success && saveResponse.iconPath) {
          finalIconPathToServer = normalizeIconPath(saveResponse.iconPath);
        } else { throw new Error(saveResponse.message || 'Errore salvataggio file icona AI.'); }
      } catch (error) {
        displayMessage('icon-save-message', `Errore salvataggio file: ${error.message}`, false, true, true);
        saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saving');
        if(textSpan) {textSpan.textContent = saveIconBtnOriginalText; textSpan.style.opacity = '1';}
        if(saveIcon) saveIcon.style.display = 'inline-block';
        if(spinnerOverlay) spinnerOverlay.style.display = 'none';
        return;
      }
    } else if (!selectedIconPath || (selectedIconPath === normalizeIconPath(defaultIconPath) && !document.querySelector(`.avatar-option-image[data-path="${normalizeIconPath(defaultIconPath)}"].selected`))) {
      const aiPreviewImg = document.getElementById('ai-generated-icon-preview');
      if (!document.querySelector('.avatar-option-image.selected') && !(aiPreviewImg && aiPreviewImg.classList.contains('selected'))) {
        displayMessage('icon-save-message', 'Seleziona un\'icona prima di salvare.', false, true, true);
        saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saving');
        if(textSpan) {textSpan.textContent = saveIconBtnOriginalText; textSpan.style.opacity = '1';}
        if(saveIcon) saveIcon.style.display = 'inline-block';
        if(spinnerOverlay) spinnerOverlay.style.display = 'none';
        return;
      }
    }

    if (finalIconPathToServer && finalIconPathToServer.startsWith('data:image/')) {
      displayMessage('icon-save-message', 'Errore: percorso icona non valido per aggiornamento.', false, true, true);
      saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saving');
      if(textSpan) {textSpan.textContent = saveIconBtnOriginalText; textSpan.style.opacity = '1';}
      if(saveIcon) saveIcon.style.display = 'inline-block';
      if(spinnerOverlay) spinnerOverlay.style.display = 'none';
      return;
    }

    let pathToSaveForDB = finalIconPathToServer;
    if (pathToSaveForDB && !pathToSaveForDB.startsWith('/') && pathToSaveForDB.startsWith('uploads/icons/')) {
      pathToSaveForDB = '/' + pathToSaveForDB;
    }

    try {
      const response = await callApi('api/api_update_user_icon.php', 'PUT', { icon: pathToSaveForDB });
      if (response.success) {
        saveIconBtnEl.classList.remove('saving');
        saveIconBtnEl.classList.add('saved-success');
        if(spinnerOverlay) spinnerOverlay.style.display = 'none';
        if(textSpan) {textSpan.textContent = 'Salvato!'; textSpan.style.opacity = '1';}
        if(saveIcon) saveIcon.style.display = 'none';
        if(checkIcon) checkIcon.style.display = 'inline-block';

        const navbarAvatarImg = document.querySelector('#navbar-avatar img');
        const mainAvatarImg = document.querySelector('#main-avatar img');
        const cacheBuster = '?t=' + new Date().getTime();

        let displayPathForUIAfterSave = finalIconPathToServer;
        if (!displayPathForUIAfterSave.startsWith('http') && !displayPathForUIAfterSave.startsWith('data:image') && !displayPathForUIAfterSave.startsWith('/')) {
          displayPathForUIAfterSave = '/' + displayPathForUIAfterSave;
        }

        if (navbarAvatarImg) navbarAvatarImg.src = displayPathForUIAfterSave + cacheBuster;
        if (mainAvatarImg) mainAvatarImg.src = displayPathForUIAfterSave + cacheBuster;

        selectedIconPath = finalIconPathToServer;

        if(currentUserDataFromStorage) {
          currentUserDataFromStorage.iconPath = finalIconPathToServer;
          localStorage.setItem('userDataEFF', JSON.stringify(currentUserDataFromStorage));
        }

        const aiPreviewImg = document.getElementById('ai-generated-icon-preview');
        if (aiPreviewImg && aiPreviewImg.classList.contains('selected')) {
          aiPreviewImg.classList.remove('selected');
        }
        updateIconSelectionVisual();
        displayMessage('icon-save-message', response.message || 'Icona profilo aggiornata!', true, true, true);

        setTimeout(() => {
          saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saved-success');
          if(textSpan) textSpan.textContent = saveIconBtnOriginalText;
          if(saveIcon) saveIcon.style.display = 'inline-block';
          if(checkIcon) checkIcon.style.display = 'none';
        }, 2500);

      } else { throw new Error(response.message || 'Errore salvataggio icona nel profilo.'); }
    } catch (error) {
      displayMessage('icon-save-message', `Errore: ${error.message} (Path inviato: ${pathToSaveForDB})`, false, true, true);
      saveIconBtnEl.disabled = false; saveIconBtnEl.classList.remove('saving');
      if(textSpan) {textSpan.textContent = saveIconBtnOriginalText; textSpan.style.opacity = '1';}
      if(saveIcon) saveIcon.style.display = 'inline-block';
      if(checkIcon) checkIcon.style.display = 'none';
      if(spinnerOverlay) spinnerOverlay.style.display = 'none';
    }
  }

  document.getElementById('profile-info-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUserDataFromStorage) { displayMessage('profile-info-message', 'Devi essere autenticato per salvare le informazioni.', false); return; }
    const updatedInfo = { nome: document.getElementById('nome').value, cognome: document.getElementById('cognome').value };
    try {
      const response = await callApi('api/api_update_user_profile.php', 'PUT', updatedInfo);
      if (response.success) {
        const navbarUsername = document.getElementById('navbar-username');
        const profileGreeting = document.getElementById('profile-greeting');
        if(navbarUsername) navbarUsername.textContent = updatedInfo.nome;
        if(profileGreeting) profileGreeting.textContent = `Ciao, ${updatedInfo.nome}!`;
        if(currentUserDataFromStorage) {
          currentUserDataFromStorage.nome = updatedInfo.nome;
          currentUserDataFromStorage.cognome = updatedInfo.cognome;
          localStorage.setItem('userDataEFF', JSON.stringify(currentUserDataFromStorage));
        }
        displayMessage('profile-info-message', response.message || 'Informazioni personali aggiornate!', true);
      } else { displayMessage('profile-info-message', response.message || 'Errore aggiornamento profilo.', false); }
    } catch (error) { displayMessage('profile-info-message', `Errore aggiornamento profilo: ${error.message}`, false); }
  });

  document.getElementById('password-change-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!currentUserDataFromStorage) { displayMessage('password-change-message', 'Devi essere autenticato per cambiare la password.', false); return; }
    const oldPassword = document.getElementById('vecchia-password').value;
    const newPassword = document.getElementById('nuova-password').value;
    const confirmPassword = document.getElementById('conferma-password').value;
    if (newPassword !== confirmPassword) { displayMessage('password-change-message', 'Le nuove password non coincidono!', false); return; }
    if (newPassword.length < 8) { displayMessage('password-change-message', 'La nuova password deve essere di almeno 8 caratteri.', false); return; }
    try {
      const response = await callApi('api/api_change_password.php', 'POST', { oldPassword, newPassword });
      if (response.success) {
        displayMessage('password-change-message', response.message || 'Password aggiornata con successo!', true);
        e.target.reset();
      } else { displayMessage('password-change-message', response.message || 'Errore cambio password.', false); }
    } catch (error) { displayMessage('password-change-message', `Errore cambio password: ${error.message}`, false); }
  });

  async function loadUserBookings() {
    const bookingsGrid = document.getElementById('user-bookings-grid');
    const noBookingsMsg = document.getElementById('no-bookings-message');
    if (!bookingsGrid || !noBookingsMsg) return;
    bookingsGrid.innerHTML = '<p style="text-align:center; padding:1rem;">Caricamento prenotazioni...</p>';
    noBookingsMsg.style.display = 'none';
    try {
      const response = await callApi('api/api_get_user_bookings.php');
      if (response.success && response.bookings) {
        const bookings = response.bookings;
        bookingsGrid.innerHTML = '';
        if (bookings.length > 0) {
          bookings.forEach(booking => {
            const formattedDate = booking.eventDataInizio ? new Date(booking.eventDataInizio.replace(/-/g, '/')).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Data non definita';
            const isPastOrCancelled = booking.statoPrenotazione === 'Concluso' || booking.statoPrenotazione === 'Annullata';
            let iconSrc = normalizeIconPath(booking.eventFotoCopertina || defaultIconPath);
            iconSrc = getDisplayIconPath(iconSrc); // Assicura lo slash per il display
            const cardHtml = `<article class="card ${isPastOrCancelled ? 'prenotazione-card-past' : ''}"><div class="card-image-container"> <img src="${iconSrc}" alt="Evento: ${booking.eventTitolo}" class="card-image"> </div><div class="card-content"><h3>${booking.eventTitolo || 'Evento Sconosciuto'}</h3><p class="card-info"><b>Data Evento:</b> ${formattedDate}<br><b>Posti Prenotati:</b> ${booking.numeroPostiPrenotati || 'N/D'}<br><b>Stato:</b> <span style="font-weight: bold; color: ${booking.statoPrenotazione === 'Confermata' ? 'var(--success, green)' : (isPastOrCancelled ? 'var(--gray-dark, grey)' : 'orange')};">${booking.statoPrenotazione || 'Sconosciuto'}</span></p><div class="card-actions"><a href="evento_dettaglio_accesso.html?id=${booking.idEvento}" class="card-btn card-btn-secondary">Vedi Evento</a>${booking.statoPrenotazione === 'Confermata' ? `<button class="card-btn card-btn-secondary btn-annulla-prenotazione" data-booking-id="${booking.idPrenotazione}">Annulla Prenotazione</button>` : ''}</div></div></article>`;
            bookingsGrid.insertAdjacentHTML('beforeend', cardHtml);
          });
          attachCancelBookingListeners();
        } else { noBookingsMsg.style.display = 'block'; }
      } else { bookingsGrid.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">${response.message || 'Errore caricamento prenotazioni.'}</p>`; noBookingsMsg.style.display = 'none'; }
    } catch (error) { bookingsGrid.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">Errore caricamento prenotazioni: ${error.message}</p>`; noBookingsMsg.style.display = 'none'; }
  }

  async function loadUserWaitlist() {
    const waitlistGrid = document.getElementById('user-waitlist-grid');
    const noWaitlistMsg = document.getElementById('no-waitlist-message');
    if (!waitlistGrid || !noWaitlistMsg) return;
    waitlistGrid.innerHTML = '<p style="text-align:center; padding:1rem;">Caricamento eventi in coda...</p>';
    noWaitlistMsg.style.display = 'none';
    try {
      const response = await callApi('api/api_get_user_waitlist.php');
      if (response.success && response.waitlistEntries) {
        const entries = response.waitlistEntries;
        waitlistGrid.innerHTML = '';
        if (entries.length > 0) {
          entries.forEach(entry => {
            const formattedDate = entry.eventDataInizio ? new Date(entry.eventDataInizio.replace(/-/g, '/')).toLocaleDateString('it-IT', { year: 'numeric', month: 'long', day: 'numeric' }) : 'Data non definita';
            let statusMessage = `Sei in coda per ${entry.numeroPostiInCoda} posto/i.`;
            let statusColor = 'orange'; let cardClass = ''; let cancelButtonHtml = '';
            if (parseInt(entry.eventPostiDisponibili) > 0 && entry.eventFlagPrenotabile == 1) { statusMessage = `ATTENZIONE: Si sono liberati ${entry.eventPostiDisponibili} posti! Prenota ora. (Richiesti in coda: ${entry.numeroPostiInCoda})`; statusColor = 'var(--success, green)';
            } else if (entry.eventFlagPrenotabile == 0) { statusMessage = `Evento non pi√π prenotabile. (Richiesti in coda: ${entry.numeroPostiInCoda})`; statusColor = 'var(--gray-dark, grey)'; cardClass = 'waitlist-card-unavailable'; }
            if (entry.eventFlagPrenotabile == 1) { cancelButtonHtml = `<button class="card-btn card-btn-danger btn-cancel-waitlist" data-event-id="${entry.idEvento}">Esci dalla Coda</button>`;}
            let iconSrc = normalizeIconPath(entry.eventFotoCopertina || defaultIconPath);
            iconSrc = getDisplayIconPath(iconSrc); // Assicura lo slash per il display
            const cardHtml = `<article class="card ${cardClass}"><div class="card-image-container"><img src="${iconSrc}" alt="Evento: ${entry.eventTitolo}" class="card-image"></div><div class="card-content"><h3>${entry.eventTitolo || 'Evento Sconosciuto'}</h3><p class="card-info"><b>Data Evento:</b> ${formattedDate}<br><b style="color: ${statusColor};">Stato Coda:</b> <span style="color: ${statusColor};">${statusMessage}</span></p><div class="card-actions" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"><a href="evento_dettaglio_accesso.html?id=${entry.idEvento}" class="card-btn card-btn-secondary" style="flex-grow: 1;">Vedi Evento</a>${(parseInt(entry.eventPostiDisponibili) > 0 && entry.eventFlagPrenotabile == 1) ? `<a href="eventiincorso.html" class="card-btn card-btn-primary" style="flex-grow: 1;">Prenota Ora</a>` : ''}${cancelButtonHtml}</div></div></article>`;
            waitlistGrid.insertAdjacentHTML('beforeend', cardHtml);
          });
          attachCancelWaitlistListeners();
        } else { noWaitlistMsg.style.display = 'block'; }
      } else { waitlistGrid.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">${response.message || 'Errore caricamento eventi in coda.'}</p>`; noWaitlistMsg.style.display = 'none';}
    } catch (error) { waitlistGrid.innerHTML = `<p class="form-message error" style="display:block; text-align:center;">Errore caricamento eventi in coda: ${error.message}</p>`; noWaitlistMsg.style.display = 'none';}
  }

  function attachCancelBookingListeners() { document.querySelectorAll('.btn-annulla-prenotazione').forEach(b => {b.removeEventListener('click', handleCancelBooking); b.addEventListener('click', handleCancelBooking);}); }
  async function handleCancelBooking(event) {
    const button = event.target; const bookingId = button.dataset.bookingId;
    if (!currentUserDataFromStorage) { alert('Autenticazione richiesta.'); return; }
    if (confirm('Sei sicuro di voler annullare questa prenotazione?')) {
      button.disabled = true; button.textContent = 'Annullamento...';
      try {
        const response = await callApi('api/api_cancel_booking.php', 'POST', { idPrenotazione: bookingId });
        if (response.success) { alert(response.message || 'Prenotazione annullata.'); loadUserBookings(); loadUserWaitlist(); }
        else { alert(response.message || 'Errore annullamento.'); button.disabled = false; button.textContent = 'Annulla Prenotazione';}
      } catch (error) { alert(`Errore: ${error.message}`); button.disabled = false; button.textContent = 'Annulla Prenotazione';}
    }
  }
  function attachCancelWaitlistListeners() { document.querySelectorAll('.btn-cancel-waitlist').forEach(b => {b.removeEventListener('click', handleCancelWaitlist); b.addEventListener('click', handleCancelWaitlist);});}
  async function handleCancelWaitlist(event) {
    const button = event.target; const eventId = button.dataset.eventId;
    if (!currentUserDataFromStorage) { alert('Autenticazione richiesta.'); return; }
    if (confirm('Sei sicuro di voler uscire dalla lista d\'attesa?')) {
      button.disabled = true; button.textContent = 'Rimozione...';
      try {
        const response = await callApi('api/api_cancel_waitlist.php', 'POST', { idEvento: eventId });
        if (response.success) { alert(response.message || 'Rimosso dalla coda.'); loadUserWaitlist(); }
        else { alert(response.message || 'Errore rimozione.'); button.disabled = false; button.textContent = 'Esci dalla Coda';}
      } catch (error) { alert(`Errore: ${error.message}`); button.disabled = false; button.textContent = 'Esci dalla Coda';}
    }
  }
  async function handleDeleteAccount(event) {
    event.preventDefault(); const confirmEmailInput = document.getElementById('confirm-delete-email');
    const confirmEmail = confirmEmailInput.value; const deleteButton = document.getElementById('btn-confirm-delete-account');
    if (!currentUserDataFromStorage || !currentUserDataFromStorage.email) { displayMessage('delete-account-message', 'Utente non verificato. Ricarica o effettua il login.', false); return;}
    if (confirmEmail !== currentUserDataFromStorage.email) { displayMessage('delete-account-message', 'L\'email non corrisponde.', false); return;}
    if (confirm('ATTENZIONE! Sei assolutamente sicuro di voler eliminare il tuo account? Questa azione √® IRREVERSIBILE.')) {
      if (confirm('CONFERMA FINALE: Tutti i tuoi dati (profilo, prenotazioni, commenti, code) verranno cancellati definitivamente. Non potranno essere recuperati. Procedere?')) {
        deleteButton.disabled = true; deleteButton.textContent = 'Eliminazione...';
        try {
          const response = await callApi('api/api_delete_account.php', 'POST', { email: confirmEmail });
          if (response.success) {
            displayMessage('delete-account-message', response.message, true); alert(response.message);
            localStorage.removeItem('userDataEFF'); setTimeout(() => { window.location.href = 'index.html'; }, 3000);
          } else { throw new Error(response.message || 'Errore eliminazione account.'); }
        } catch (error) {
          displayMessage('delete-account-message', `Errore: ${error.message}`, false);
          deleteButton.disabled = false; deleteButton.textContent = 'Elimina il Mio Account Definitivamente';
        }
      }
    }
  }
  function logout() {
    localStorage.removeItem('userDataEFF');
    fetch('api/api_logout.php', { method: 'POST', credentials: 'same-origin' })
            .finally(() => {
              alert('Logout effettuato. Verrai reindirizzato alla homepage.');
              window.location.href = 'index.html';
            });
  }
</script>
</body>
</html>