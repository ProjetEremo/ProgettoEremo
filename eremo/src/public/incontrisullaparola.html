<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Incontri sulla Parola - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Add this for red logout link */
        #logout-link-desktop, #mobileLogoutLink {
            /* color: red !important; */ /* Rimosso stile rosso per coerenza con altre pagine */
        }
        /* Stili popup login/registrazione */
        .login-popup input.form-control { transition: border-color 0.3s ease; border: 1px solid #ced4da; background-color: white !important; box-shadow: none !important; outline: none !important; }
        .login-popup input.error-border { border-color: var(--danger, red) !important; }
        .login-popup input:-webkit-autofill,
        .login-popup input:-webkit-autofill:hover,
        .login-popup input:-webkit-autofill:focus { -webkit-box-shadow: 0 0 0px 1000px white inset !important; -webkit-text-fill-color: var(--dark, #333) !important; }
        .form-message { display: none; padding: 0.75rem; border-radius: 8px; font-size: 0.9em; margin-top: 0.5em; text-align: left;}
        .form-message.error { color: var(--danger, red); background-color: rgba(var(--danger-rgb, 231, 76, 60), 0.1); border: 1px solid rgba(var(--danger-rgb, 231, 76, 60), 0.3); }
        .form-message.success { color: var(--success, green); background-color: rgba(var(--success-rgb, 46, 204, 113), 0.1); border: 1px solid rgba(var(--success-rgb, 46, 204, 113), 0.3); }
        .spinner-mini-light { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; vertical-align: middle; margin-left: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .user-avatar img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; vertical-align: middle; }
        .terms-checkbox { text-align: left; font-size: 0.9em; margin-top: 0.5rem; margin-bottom: 1rem; color: var(--gray-dark); }
        .terms-checkbox input[type="checkbox"] { margin-right: 0.5rem; vertical-align: middle; }
        .terms-checkbox label { font-weight: normal; color: var(--gray-dark); } .terms-checkbox a { color: var(--primary); text-decoration: underline; }

        /* Stili Modifica Pagina Admin */
        #editPageBtnContainer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            z-index: 1001;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        #editPageBtnContainer.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        #editPageBtn, #savePageChangesBtn, #cancelPageChangesBtn {
            background-color: var(--accent);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            white-space: nowrap;
        }
        #editPageBtn i, #savePageChangesBtn i, #cancelPageChangesBtn i { margin-right: 8px; }
        #savePageChangesBtn { background-color: var(--success); }
        #cancelPageChangesBtn { background-color: var(--gray-dark); }
        #editPageBtn:hover { background-color: #c07b50; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        #savePageChangesBtn:hover { background-color: #27ae60; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        #cancelPageChangesBtn:hover { background-color: var(--dark); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }

        .editable-text-wrapper { position: relative; display: block; width:100%; }
        .editable-image-wrapper { position: relative; display: block; }

        .edit-icon-text, .edit-icon-image {
            display: none;
            position: absolute;
            background: var(--accent);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 0.9em;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        .editable-text-wrapper:hover .edit-icon-text,
        .editable-image-wrapper:hover .edit-icon-image {
            opacity: 1;
            transform: scale(1);
        }

        .edit-icon-text, .edit-icon-image {
            top: 0;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .main-title-editable-wrapper > h1 + .edit-icon-text {
            top: 50%;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .chi-siamo-section .editable-text-wrapper h2 + .edit-icon-text {
            top: 0;
            right: 0;
            transform: translate(calc(100% + 5px), -50%) scale(0.8);
        }
        .chi-siamo-section .editable-text-wrapper p + .edit-icon-text {
            top: 50%;
            right: 0;
            transform: translate(calc(100% + 5px), -50%) scale(0.8);
        }
        .editable-image-wrapper .edit-icon-image {
            top: 0;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .card-grid .editable-text-wrapper h2 + .edit-icon-text {
            top: 0;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .card-content .editable-text-wrapper p + .edit-icon-text {
            top: 0;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .editable-text-wrapper:hover .edit-icon-text,
        .editable-image-wrapper:hover .edit-icon-image {
            opacity: 1;
            transform: translate(50%, -50%) scale(1);
        }
        .main-title-editable-wrapper:hover > h1 + .edit-icon-text,
        .chi-siamo-section .editable-text-wrapper:hover h2 + .edit-icon-text,
        .chi-siamo-section .editable-text-wrapper:hover p + .edit-icon-text {
            opacity: 1;
            transform: translate(var(--custom-translate-x, 50%), var(--custom-translate-y, -50%)) scale(1);
        }


        img.editable-image-target { border: 3px dashed var(--accent) !important; cursor: pointer; opacity: 0.85; }
        .edit-content-modal, .edit-quando-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(var(--dark-rgb, 30, 59, 47), 0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center;}
        .edit-content-modal-content, .edit-quando-modal-content { background-color: var(--white); padding: 25px; border-radius: var(--border-radius-medium); width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative;}
        .edit-content-modal-content h3, .edit-quando-modal-content h3 { margin-top: 0; color: var(--primary); }
        .edit-content-modal .form-group, .edit-quando-modal .form-group { margin-bottom: 15px; }
        .edit-content-modal .form-group label, .edit-quando-modal .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--dark); text-align: left; }
        .edit-content-modal .form-group input[type="text"], .edit-content-modal .form-group textarea,
        .edit-quando-modal .form-group select, .edit-quando-modal .form-group input[type="time"] { width: 100%; padding: 10px; border: 1px solid var(--gray-medium); border-radius: 8px; font-size: 1rem;}
        .edit-content-modal .form-group textarea { min-height: 100px; resize: vertical; }
        .edit-content-modal-actions, .edit-quando-modal-actions { margin-top: 20px; text-align: right; } .edit-content-modal-actions button, .edit-quando-modal-actions button { margin-left: 10px; }
        .close-modal-btn { position: absolute; top: 10px; right: 15px; font-size: 1.8rem; color: var(--gray-medium); background: none; border: none; cursor: pointer; line-height: 1;}
        .close-modal-btn:hover { color: var(--dark); }

        /* Stili per #pageOverallStatus - Standardizzati */
        #pageOverallStatus {
            position: fixed;
            bottom: 80px;
            left: 50%;
            z-index: 1000;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
            background-color: var(--primary);
            color: white;
            display: block;
            opacity: 0;
            transform: translateX(-50%) translateY(30px);
            transition: opacity 0.4s cubic-bezier(0.175, 0.885, 0.320, 1.275), transform 0.4s cubic-bezier(0.175, 0.885, 0.320, 1.275);
            pointer-events: none;
            max-width: 90%;
            box-sizing: border-box;
        }

        #pageOverallStatus.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        #pageOverallStatus.success {
            background-color: var(--success, green);
        }

        #pageOverallStatus.error {
            background-color: var(--danger, red);
        }

        .chi-siamo-image-container { aspect-ratio: 4/3; }
    </style>
</head>
<body>

<header class="navbar-container" id="navbarContainer">
    <nav class="navbar">
        <div class="logo">
            <a href="index.html" id="logoLink">
                <img src="images/Logo_eremo.png" alt="Logo Eremo Frate Francesco" class="navbar-logo-img" id="navbarLogoImgTag">
                <h2 id="navbarTitle">Eremo Frate Francesco</h2>
            </a>
        </div>
        <div class="menu" id="mainMenu">
            <a href="eventiincorso.html" id="navCalendarioAttivita">Calendario attività</a>
            <a href="eventipassati.html" id="navArchivioAttivita">Archivio attività</a>
            <span class="separator">|</span>
            <a href="incontrisullaparola.html" class="active" id="navIncontriParola">Incontri sulla parola</a>
            <span class="separator">|</span>
            <a href="dovesiamo.html" id="navDoveSiamo">Dove siamo</a>
            <a href="contatti.html" id="navContatti">Contatti</a>
        </div>
        <div class="right-menu">
            <button id="login-btn-desktop" class="login-btn" style="display: none;">Accedi</button>
            <div class="user-dropdown" id="userDropdownContainer" style="display: none;">
                <button class="user-btn" id="userBtnTrigger" aria-haspopup="true" aria-expanded="false">
                    <span class="user-avatar" id="navbar-avatar"><img src="uploads/icons/default_user.png" alt="User Icon"></span>
                    <span class="user-name" id="navbar-username">Utente</span>
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dropdown-menu" id="userDropdownMenu">
                    <a href="areapersonale.html" id="nav-profilo">Il mio profilo</a>
                    <a href="areapersonale.html#prenotazioni" id="nav-mie-prenotazioni">Le mie prenotazioni</a>
                    <a href="dashboard.html" id="nav-dashboard" style="display: none;">Dashboard Admin</a>
                    <a href="eventiincorsoAdmin.html" id="nav-gestione-eventi-admin" style="display: none;">Gestione Eventi</a>
                    <a href="#" id="logout-link-desktop">Esci</a>
                </div>
            </div>
            <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu">☰</button>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="eventiincorso.html" id="mobileNavCalendarioAttivita">Calendario attività</a>
        <a href="eventipassati.html" id="mobileNavArchivioAttivita">Archivio attività</a>
        <a href="incontrisullaparola.html" id="mobileNavIncontriParola">Incontri sulla parola</a>
        <a href="dovesiamo.html" id="mobileNavDoveSiamo">Dove siamo</a>
        <a href="contatti.html" id="mobileNavContatti">Contatti</a>
        <hr id="mobileMenuSeparator" style="border-color: rgba(255,255,255,0.1); display:none;">
        <a href="#" id="login-btn-mobile" style="display: none;">Accedi</a>
        <a href="areapersonale.html" id="mobileNavProfilo" style="display: none;">Il mio profilo</a>
        <a href="areapersonale.html#prenotazioni" id="mobileNavPrenotazioni" style="display: none;">Le mie prenotazioni</a>
        <a href="dashboard.html" id="mobileNavDashboard" style="display: none;">Dashboard Admin</a>
        <a href="eventiincorsoAdmin.html" id="mobileNavGestioneEventiAdmin" style="display: none;">Gestione Eventi</a>
        <a href="#" id="mobileLogoutLink" style="display: none;">Esci</a>
    </div>
</header>

<main>
    <div class="container section-padding">
        <div class="editable-text-wrapper main-title-editable-wrapper" style="text-align: center;">
            <h1 id="content-pageHeaderTitle" data-content-key="pageHeaderTitle"
                style="color: var(--primary); margin-top: 3rem; margin-bottom: 3.5rem; font-size: clamp(2.8rem, 5.8vw, 3.5rem);"></h1>
            <span class="edit-icon-text" data-key="pageHeaderTitle" data-type="text" title="Modifica Titolo Pagina">✎</span>
        </div>
    </div>

    <div class="container">
        <section class="chi-siamo-section section-padding">
            <div class="chi-siamo-image-container editable-image-wrapper">
                <img src="" alt="Gruppo di studio biblico" class="chi-siamo-image" id="content-cosaSonoImage" data-content-key="cosaSonoImage">
                <span class="edit-icon-image" data-key="cosaSonoImage" data-type="image" title="Modifica Immagine">✎</span>
            </div>
            <div class="chi-siamo-content">
                <div class="editable-text-wrapper">
                    <h2 id="content-cosaSonoHeading" data-content-key="cosaSonoHeading"></h2>
                    <span class="edit-icon-text" data-key="cosaSonoHeading" data-type="text" title="Modifica Titolo">✎</span>
                </div>
                <div class="editable-text-wrapper">
                    <p id="content-cosaSonoText1" data-content-key="cosaSonoText1"></p>
                    <span class="edit-icon-text" data-key="cosaSonoText1" data-type="textarea" title="Modifica Testo">✎</span>
                </div>
                <div class="editable-text-wrapper">
                    <p id="content-cosaSonoText2" data-content-key="cosaSonoText2"></p>
                    <span class="edit-icon-text" data-key="cosaSonoText2" data-type="textarea" title="Modifica Testo">✎</span>
                </div>
            </div>
        </section>



        <section class="chi-siamo-section reverse section-padding">
            <div class="chi-siamo-image-container editable-image-wrapper">
                <img src="" alt="Condivisione comunitaria" class="chi-siamo-image" id="content-approccioImage" data-content-key="approccioImage">
                <span class="edit-icon-image" data-key="approccioImage" data-type="image" title="Modifica Immagine">✎</span>
            </div>
            <div class="chi-siamo-content">
                <div class="editable-text-wrapper">
                    <h2 id="content-approccioHeading" data-content-key="approccioHeading"></h2>
                    <span class="edit-icon-text" data-key="approccioHeading" data-type="text" title="Modifica Titolo">✎</span>
                </div>
                <div class="editable-text-wrapper">
                    <p id="content-approccioText1" data-content-key="approccioText1"></p>
                    <span class="edit-icon-text" data-key="approccioText1" data-type="textarea" title="Modifica Testo">✎</span>
                </div>
                <div class="editable-text-wrapper">
                    <p id="content-approccioText2" data-content-key="approccioText2"></p>
                    <span class="edit-icon-text" data-key="approccioText2" data-type="textarea" title="Modifica Testo">✎</span>
                </div>
            </div>
        </section>

        <section class="section-padding">
            <div class="editable-text-wrapper">
                <h2 class="text-center mb-4" id="content-passiLectioHeading" data-content-key="passiLectioHeading"></h2>
                <span class="edit-icon-text" data-key="passiLectioHeading" data-type="text" title="Modifica Titolo">✎</span>
            </div>
            <div class="card-grid lectio-steps-grid">
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">1</div>
                        <div class="editable-text-wrapper">
                            <h3 id="content-passoLectioHeadingCard" data-content-key="passoLectioHeadingCard"></h3>
                            <span class="edit-icon-text" data-key="passoLectioHeadingCard" data-type="text" title="Modifica Titolo Passo">✎</span>
                        </div>
                        <div class="editable-text-wrapper">
                            <p id="content-passoLectioTextCard" data-content-key="passoLectioTextCard"></p>
                            <span class="edit-icon-text" data-key="passoLectioTextCard" data-type="textarea" title="Modifica Testo Passo">✎</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">2</div>
                        <div class="editable-text-wrapper">
                            <h3 id="content-passoMeditatioHeadingCard" data-content-key="passoMeditatioHeadingCard"></h3>
                            <span class="edit-icon-text" data-key="passoMeditatioHeadingCard" data-type="text" title="Modifica Titolo Passo">✎</span>
                        </div>
                        <div class="editable-text-wrapper">
                            <p id="content-passoMeditatioTextCard" data-content-key="passoMeditatioTextCard"></p>
                            <span class="edit-icon-text" data-key="passoMeditatioTextCard" data-type="textarea" title="Modifica Testo Passo">✎</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">3</div>
                        <div class="editable-text-wrapper">
                            <h3 id="content-passoOratioHeadingCard" data-content-key="passoOratioHeadingCard"></h3>
                            <span class="edit-icon-text" data-key="passoOratioHeadingCard" data-type="text" title="Modifica Titolo Passo">✎</span>
                        </div>
                        <div class="editable-text-wrapper">
                            <p id="content-passoOratioTextCard" data-content-key="passoOratioTextCard"></p>
                            <span class="edit-icon-text" data-key="passoOratioTextCard" data-type="textarea" title="Modifica Testo Passo">✎</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="section-padding" style="background-color: var(--light); border-radius: var(--border-radius-large);">
            <div class="editable-text-wrapper">
                <h2 class="text-center mb-4" style="color: var(--primary);" id="content-infoPraticheHeading" data-content-key="infoPraticheHeading"></h2>
                <span class="edit-icon-text" data-key="infoPraticheHeading" data-type="text" title="Modifica Titolo">✎</span>
            </div>
            <div class="card-grid">
                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-calendar-alt" style="margin-right: 8px; color: var(--secondary);"></i> Quando</h3>
                        <div class="editable-text-wrapper">
                            <p id="content-infoQuandoText" data-content-key="infoQuandoText"></p>
                            <span class="edit-icon-text" data-key="infoQuandoText" data-type="quando" title="Modifica Info Quando">✎</span>
                            <p style="margin-top: 1rem; font-size: 1rem;">Prossimo incontro: <strong id="next-meeting-date"></strong></p>
                        </div>
                    </div>
                </div>
                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-map-marker-alt" style="margin-right: 8px; color: var(--secondary);"></i> Dove</h3>
                        <div class="editable-text-wrapper">
                            <p id="content-infoDoveText" data-content-key="infoDoveText"></p>
                            <span class="edit-icon-text" data-key="infoDoveText" data-type="textarea" title="Modifica Info Dove">✎</span>
                        </div>
                        <a href="dovesiamo.html" class="card-btn card-btn-secondary" style="margin-top: 1rem;">Come raggiungerci</a>
                    </div>
                </div>
                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-users" style="margin-right: 8px; color: var(--secondary);"></i> A chi è rivolto</h3>
                        <div class="editable-text-wrapper">
                            <p id="content-infoRivoltoText" data-content-key="infoRivoltoText"></p>
                            <span class="edit-icon-text" data-key="infoRivoltoText" data-type="textarea" title="Modifica Info Rivolto">✎</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
    <button class="close-popup" id="closeLoginPopupBtn" aria-label="Chiudi popup">×</button>
    <div class="login-tabs"> <div class="login-tab active" data-tab="login">Accedi</div> <div class="login-tab" data-tab="register">Registrati</div></div>
    <form class="login-form active" id="loginForm" method="POST">
        <div class="form-group mb-3"><label for="login-email">Email</label><input type="email" id="login-email" name="login-email" class="form-control" required autocomplete="email"></div>
        <div class="form-group mb-3"><label for="login-password">Password</label><input type="password" id="login-password" name="login-password" class="form-control" required autocomplete="current-password"></div>
        <div style="text-align: right; margin-top: -10px; margin-bottom: 10px;">
            <a href="#" id="forgotPasswordLink" style="font-size: 0.9em; color: var(--primary);">Password dimenticata?</a>
        </div>
        <div id="login-error-message" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
        <div class="form-actions"><button type="submit" class="btn-popup">Accedi</button></div>
    </form>
    <form class="login-form" id="registerForm" method="POST">
        <div class="form-group mb-3"><label for="register-name">Nome</label><input type="text" id="register-name" name="register-name" class="form-control" required autocomplete="given-name"></div>
        <div class="form-group mb-3"><label for="register-surname">Cognome</label><input type="text" id="register-surname" name="register-surname" class="form-control" required autocomplete="family-name"></div>
        <div class="form-group mb-3"><label for="register-email">Email</label><input type="email" id="register-email" name="register-email" class="form-control" required autocomplete="email"></div>
        <div class="form-group mb-3"><label for="register-password">Password</label><input type="password" id="register-password" name="register-password" class="form-control" required minlength="8" autocomplete="new-password"><small>Minimo 8 caratteri.</small></div>
        <div class="terms-checkbox mb-3"><input type="checkbox" id="register-terms" name="register-terms" required><label for="register-terms">Accetto i <a href="termini.html" target="_blank">termini e condizioni</a></label></div>
        <div id="register-error-message" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
        <div class="form-actions"><button type="submit" class="btn-popup">Registrati</button></div>
    </form>
</div>

<div class="login-popup-overlay" id="forgotPasswordOverlay"></div>
<div class="login-popup" id="forgotPasswordPopup">
    <button class="close-popup" id="closeForgotPasswordPopupBtn" aria-label="Chiudi popup">×</button>
    <h3 style="text-align:center; margin-bottom: 1rem; color: var(--primary);">Recupera Password</h3>
    <p style="font-size:0.95em; color:var(--gray-dark); margin-bottom:1.5rem; text-align:left;">Inserisci l'indirizzo email associato al tuo account. Se presente nel nostro sistema, ti invieremo un link per reimpostare la password.</p>
    <form id="forgotPasswordForm" method="POST">
        <div class="form-group mb-3">
            <label for="forgot-email">Email</label>
            <input type="email" id="forgot-email" name="forgot-email" class="form-control" required autocomplete="email">
        </div>
        <div id="forgot-password-message" class="form-message" style="text-align:left;"></div>
        <div class="form-actions">
            <button type="submit" class="btn-popup">Invia link di recupero</button>
        </div>
    </form>
</div>
<div id="editPageBtnContainer">
    <button id="editPageBtn"><i class="fas fa-pencil-alt"></i> Attiva Modifiche</button>
    <button id="savePageChangesBtn" style="display:none;"><i class="fas fa-save"></i> Salva Modifiche Pagina</button>
    <button id="cancelPageChangesBtn" style="display:none;"><i class="fas fa-times"></i> Annulla Modifiche</button>
</div>
<div id="pageOverallStatus"></div>


<div id="editContentModal" class="edit-content-modal">
    <div class="edit-content-modal-content">
        <button class="close-modal-btn" id="closeEditContentModalBtn" aria-label="Chiudi">×</button>
        <h3 id="editModalTitle">Modifica Contenuto</h3>
        <div class="form-group">
            <label id="editModalFieldLabelText">Testo:</label>
            <textarea id="editModalTextarea" class="form-control" rows="5" style="display:none;"></textarea>
            <input type="text" id="editModalInputText" class="form-control" style="display:none;">
            <input type="text" id="editModalInputImage" class="form-control" style="display:none;" placeholder="URL immagine esistente o nuovo (http://...)">
            <label for="editModalInputFile" id="editModalFileLabel" style="margin-top: 10px; display:none;">Oppure carica nuova immagine:</label>
            <input type="file" id="editModalInputFile" class="form-control" style="display:none;" accept="image/jpeg, image/png, image/gif, image/webp">
            <small id="editModalFileNote" style="display:none; font-size:0.8em; color: var(--gray-dark);">Se carichi un file, questo sostituirà l'URL sopra. L'immagine verrà salvata sul server.</small>
        </div>
        <div id="editModalMessage" class="form-message" style="margin-bottom:1rem;"></div>
        <div class="edit-content-modal-actions">
            <button type="button" class="btn-popup btn-secondary" id="cancelEditModalBtn">Annulla</button>
            <button type="button" class="btn-popup" id="saveEditModalBtn">Salva</button>
        </div>
    </div>
</div>

<div id="editQuandoModal" class="edit-quando-modal">
    <div class="edit-quando-modal-content">
        <button class="close-modal-btn" id="closeEditQuandoModalBtn" aria-label="Chiudi">×</button>
        <h3>Modifica Dettagli Incontro "Quando"</h3>
        <div class="form-group">
            <label for="editQuandoDayOfWeek">Giorno della Settimana:</label>
            <select id="editQuandoDayOfWeek" class="form-control">
                <option value="0">Domenica</option>
                <option value="1">Lunedì</option>
                <option value="2">Martedì</option>
                <option value="3">Mercoledì</option>
                <option value="4">Giovedì</option>
                <option value="5">Venerdì</option>
                <option value="6">Sabato</option>
            </select>
        </div>
        <div class="form-group">
            <label for="editQuandoStartTime">Orario Inizio:</label>
            <input type="time" id="editQuandoStartTime" class="form-control">
        </div>
        <div class="form-group">
            <label for="editQuandoEndTime">Orario Fine:</label>
            <input type="time" id="editQuandoEndTime" class="form-control">
        </div>
        <div id="editQuandoModalMessage" class="form-message" style="margin-bottom:1rem;"></div>
        <div class="edit-quando-modal-actions">
            <button type="button" class="btn-popup btn-secondary" id="cancelEditQuandoModalBtn">Annulla</button>
            <button type="button" class="btn-popup" id="saveEditQuandoModalBtn">Salva Quando</button>
        </div>
    </div>
</div>

<div id="ai-assistant-fab" title="Assistente Virtuale Eremo">
    <i class="fas fa-headset"></i>
</div>

<div id="ai-chat-popup">
    <div id="ai-chat-header">
        <h3>Assistente Eremo <i class="fas fa-robot"></i></h3>
        <button id="ai-chat-close-btn" aria-label="Chiudi Chat">×</button>
    </div>
    <div id="ai-chat-messages">
        <div class="ai-message">Ciao! Sono l'assistente virtuale dell'Eremo. Come posso aiutarti oggi riguardo il sito?</div>
    </div>
    <div id="ai-chat-input-container">
        <textarea id="ai-chat-input" placeholder="Scrivi la tua domanda..." rows="2"></textarea>
        <button id="ai-chat-send-btn" aria-label="Invia Messaggio"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<footer>
    <p>© <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati.</p>
</footer>

<script src="assistenteAI.js" defer></script>
<script>
    const PAGE_NAME_FOR_CONTENT = 'incontrisullaparola';
    const defaultUserIconPath = 'uploads/icons/default_user.png';
    let currentUserData = null;
    let isEditModeActive = false;
    let originalPageContentsForCancel = {};
    let currentPageDbContents = {};

    const defaultPageContents = {
        pageHeaderTitle: "Incontri sulla Parola",
        cosaSonoImage: "https://picsum.photos/600/400?random=group,reading,discussion",
        cosaSonoHeading: "Cosa sono gli Incontri sulla Parola?",
        cosaSonoText1: "Gli Incontri sulla Parola sono un appuntamento settimanale dedicato all'ascolto, alla meditazione e alla condivisione della Parola di Dio, secondo il metodo della <strong>Lectio Divina</strong>. È un'opportunità per nutrire la propria fede, approfondire la comprensione delle Scritture e crescere insieme come comunità.",
        cosaSonoText2: "Non si tratta di uno studio accademico, ma di un'esperienza spirituale che cerca di far risuonare la Parola nella vita di ciascuno, in un clima di ascolto reciproco e di preghiera.",
        infoPraticheHeading: "Informazioni Pratiche",
        infoQuandoText: { dayOfWeek: 3, startTime: "20:30", endTime: "22:00" }, // Mercoledì per default
        infoDoveText: "Presso la sala incontri dell'Eremo Frate Francesco<br>Via San Vito, Nembro (BG)",
        infoRivoltoText: "L'invito è aperto a tutti: giovani, adulti, famiglie. Non è richiesta alcuna preparazione teologica specifica, solo il desiderio di mettersi in ascolto della Parola.",
        approccioImage: "https://picsum.photos/600/400?random=community,prayer,circle",
        approccioHeading: "Un Approccio Comunitario alla Lectio Divina",
        approccioText1: "La Lectio Divina è un metodo antico di preghiera e lettura della Bibbia che si articola in quattro momenti: <strong>Lectio</strong> (lettura), <strong>Meditatio</strong> (meditazione), <strong>Oratio</strong> (preghiera) e <strong>Contemplatio</strong> (contemplazione).",
        approccioText2: "Durante i nostri incontri, applichiamo questo metodo in modo comunitario. Dopo la lettura attenta di un brano biblico, ognuno è invitato a meditare su ciò che lo ha colpito, a trasformarlo in preghiera personale e, infine, a condividere liberamente (senza obbligo) le proprie riflessioni con il gruppo, arricchendosi reciprocamente.",
        passiLectioHeading: "I Passi della Lectio Comunitaria",
        passoLectioHeadingCard: "Lectio (Lettura)",
        passoLectioTextCard: "Lettura attenta e ripetuta del brano biblico scelto per l'incontro, cercando di cogliere il messaggio letterale.",
        passoMeditatioHeadingCard: "Meditatio (Meditazione)",
        passoMeditatioTextCard: "Riflessione personale: cosa dice a me, oggi, questa Parola? Quali sentimenti o pensieri suscita?",
        passoOratioHeadingCard: "Oratio (Preghiera)",
        passoOratioTextCard: "Risposta personale alla Parola attraverso la preghiera: lode, ringraziamento, richiesta, supplica."
    };

    function gebi(id) { return document.getElementById(id); }

    function formatHTMLContent(str) {
        if (typeof str !== 'string') str = String(str || '');
        return str.replace(/\r\n|\r|\n/g, '<br>');
    }

    function formatQuandoTextDisplay(quandoDataObjOrString) {
        let dataToParse = quandoDataObjOrString;
        if (typeof dataToParse === 'string') {
            try { dataToParse = JSON.parse(dataToParse); }
            catch (e) { dataToParse = defaultPageContents.infoQuandoText; }
        }
        if (typeof dataToParse !== 'object' || dataToParse === null ||
            typeof dataToParse.dayOfWeek === 'undefined' ||
            typeof dataToParse.startTime !== 'string' ||
            typeof dataToParse.endTime !== 'string') {
            dataToParse = defaultPageContents.infoQuandoText;
        }
        const days = ["Domenica", "Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato"];
        const dayName = days[dataToParse.dayOfWeek] || "Giorno non specificato";
        return `Ogni ${dayName} sera<br>Orario: ${dataToParse.startTime} - ${dataToParse.endTime}`;
    }

    function loadUserData() { const uds = localStorage.getItem('userDataEFF'); if (uds) { try { currentUserData = JSON.parse(uds); if (!currentUserData || typeof currentUserData.email === 'undefined') {currentUserData = null; localStorage.removeItem('userDataEFF');}} catch (e) { console.error("Err parsing userDataEFF:", e); currentUserData = null; localStorage.removeItem('userDataEFF');}} else { currentUserData = null; }}

    async function fetchAndUpdateUserDisplayDataFromApi() {
        if (!currentUserData || !currentUserData.email || currentUserData.isAdmin) {
            updateNavbarUI(); return;
        }
        try {
            const response = await fetch(`api/api_get_user_profile.php?email=${encodeURIComponent(currentUserData.email)}`);
            if (!response.ok) throw new Error('Errore fetch profilo utente');
            const apiResult = await response.json();
            if (apiResult.success && apiResult.data) {
                const freshData = apiResult.data;
                currentUserData.nome = freshData.nome || currentUserData.nome;
                currentUserData.iconPath = freshData.icon || defaultUserIconPath;
                currentUserData.cognome = freshData.cognome || (currentUserData.cognome || '');
                localStorage.setItem('userDataEFF', JSON.stringify(currentUserData));
            }
        } catch (error) { console.warn("IncontriParola: Errore fetch profilo aggiornato:", error.message); }
        updateNavbarUI();
    }

    function updateNavbarUI() {
        const logoLink = gebi('logoLink'); if (logoLink) logoLink.href = "index.html";
        const navbarTitle = gebi('navbarTitle');
        const loginBtnDesktop = gebi('login-btn-desktop');
        const userDropdownContainer = gebi('userDropdownContainer');
        const navbarAvatarSpan = gebi('navbar-avatar');
        const navbarUsername = gebi('navbar-username');
        const mobileMenuSeparator = gebi('mobileMenuSeparator');
        const editPageBtnContainer = gebi('editPageBtnContainer');
        const navProfilo = gebi('nav-profilo');
        const navMiePrenotazioni = gebi('nav-mie-prenotazioni');
        const navDashboard = gebi('nav-dashboard');
        const navGestioneEventiAdmin = gebi('nav-gestione-eventi-admin');
        const logoutLinkDesktop = gebi('logout-link-desktop');
        const loginBtnMobile = gebi('login-btn-mobile');
        const mobileNavProfiloEl = gebi('mobileNavProfilo');
        const mobileNavPrenotazioniEl = gebi('mobileNavPrenotazioni');
        const mobileNavDashboardEl = gebi('mobileNavDashboard');
        const mobileNavGestioneEventiAdminEl = gebi('mobileNavGestioneEventiAdmin');
        const mobileLogoutLinkEl = gebi('mobileLogoutLink');

        // Reset iniziale di tutti gli item specifici dell'utente/admin
        if(loginBtnDesktop) loginBtnDesktop.style.display = 'none';
        if(userDropdownContainer) userDropdownContainer.style.display = 'none';

        if(navProfilo) navProfilo.style.display = 'none';
        if(navMiePrenotazioni) navMiePrenotazioni.style.display = 'none';
        if(navDashboard) navDashboard.style.display = 'none';
        if(navGestioneEventiAdmin) navGestioneEventiAdmin.style.display = 'none';

        if(loginBtnMobile) loginBtnMobile.style.display = 'none';
        if(mobileNavProfiloEl) mobileNavProfiloEl.style.display = 'none';
        if(mobileNavPrenotazioniEl) mobileNavPrenotazioniEl.style.display = 'none';
        if(mobileNavDashboardEl) mobileNavDashboardEl.style.display = 'none';
        if(mobileNavGestioneEventiAdminEl) mobileNavGestioneEventiAdminEl.style.display = 'none';

        if(mobileLogoutLinkEl) mobileLogoutLinkEl.style.display = 'none';
        if(mobileMenuSeparator) mobileMenuSeparator.style.display = 'none';
        if(logoutLinkDesktop) logoutLinkDesktop.style.display = 'none';


        if (currentUserData) { // Utente Loggato
            if (userDropdownContainer) userDropdownContainer.style.display = 'inline-block';
            if (navbarUsername) navbarUsername.textContent = currentUserData.nome || currentUserData.email.split('@')[0];
            const avatarImgEl = navbarAvatarSpan ? navbarAvatarSpan.querySelector('img') : null;
            if (avatarImgEl) { avatarImgEl.src = currentUserData.iconPath || defaultUserIconPath; avatarImgEl.alt = `Avatar di ${currentUserData.nome || 'utente'}`; avatarImgEl.onerror = function() { this.src = defaultUserIconPath; }; }
            if (logoutLinkDesktop) logoutLinkDesktop.style.display = 'block'; // Mostra Logout Desktop
            if (mobileLogoutLinkEl) mobileLogoutLinkEl.style.display = 'block';
            if (mobileMenuSeparator) mobileMenuSeparator.style.display = 'block';

            if (currentUserData.isAdmin) { // ADMIN LOGGATO
                if (navbarTitle) navbarTitle.textContent = "Eremo (Admin)";
                if (navProfilo) navProfilo.style.display = 'block';
                if (mobileNavProfiloEl) mobileNavProfiloEl.style.display = 'block';
                if (navDashboard) navDashboard.style.display = 'block';
                if (mobileNavDashboardEl) mobileNavDashboardEl.style.display = 'block';

                // Nascondi "Le mie prenotazioni" e "Gestione Eventi" per admin
                if (navMiePrenotazioni) navMiePrenotazioni.style.display = 'none';
                if (mobileNavPrenotazioniEl) mobileNavPrenotazioniEl.style.display = 'none';
                if (navGestioneEventiAdmin) navGestioneEventiAdmin.style.display = 'none';
                if (mobileNavGestioneEventiAdminEl) mobileNavGestioneEventiAdminEl.style.display = 'none';

            } else { // UTENTE NORMALE LOGGATO
                if (navbarTitle) navbarTitle.textContent = "Eremo Frate Francesco";
                if (navProfilo) navProfilo.style.display = 'block';
                if (mobileNavProfiloEl) mobileNavProfiloEl.style.display = 'block';
                if (navMiePrenotazioni) navMiePrenotazioni.style.display = 'block';
                if (mobileNavPrenotazioniEl) mobileNavPrenotazioniEl.style.display = 'block';
                // Dashboard e Gestione Eventi rimangono 'none' dal reset iniziale
                if(editPageBtnContainer) editPageBtnContainer.classList.remove('active');
            }
        } else { // UTENTE NON LOGGATO
            if (loginBtnDesktop) loginBtnDesktop.style.display = 'inline-block';
            if (loginBtnMobile) loginBtnMobile.style.display = 'block';
            if (navbarTitle) navbarTitle.textContent = "Eremo Frate Francesco";
            if(editPageBtnContainer) editPageBtnContainer.classList.remove('active');
        }
    }


    function handleLogout(){localStorage.removeItem('userDataEFF');currentUserData=null;isEditModeActive=false;updateNavbarUI();loadPageContentsFromServer();showPageStatus('Logout effettuato.','info');}
    let lastScroll = 0; const navbarContainer = gebi("navbarContainer"); if (navbarContainer) { window.addEventListener("scroll", function () { const cS = window.pageYOffset||document.documentElement.scrollTop; if(cS<=50){navbarContainer.classList.remove("hidden");lastScroll=0;return;} if(cS>lastScroll&&!navbarContainer.classList.contains("hidden"))navbarContainer.classList.add("hidden"); else if(cS<lastScroll&&navbarContainer.classList.contains("hidden"))navbarContainer.classList.remove("hidden"); lastScroll=cS<=0?0:cS;}, false);}
    const mobileMenu = gebi("mobileMenu"); const hamburgerBtn = gebi("hamburgerBtn"); function toggleMobileMenu(){if(mobileMenu&&hamburgerBtn){const iO=mobileMenu.classList.toggle("open");hamburgerBtn.classList.toggle("open"); hamburgerBtn.setAttribute("aria-expanded",String(iO));document.body.style.overflow=iO?"hidden":"";}} function closeMobileMenu(){if(mobileMenu&&hamburgerBtn&&mobileMenu.classList.contains("open")){mobileMenu.classList.remove("open");hamburgerBtn.classList.remove("open");hamburgerBtn.setAttribute("aria-expanded","false");document.body.style.overflow="";}} if(hamburgerBtn)hamburgerBtn.addEventListener("click",toggleMobileMenu); document.querySelectorAll("#mobileMenu a").forEach(l=>{if(l.id!=='login-btn-mobile'&&l.id!=='mobileLogoutLink')l.addEventListener("click",closeMobileMenu);}); document.addEventListener("click",function(e){if(mobileMenu&&mobileMenu.classList.contains("open")&&hamburgerBtn&&!mobileMenu.contains(e.target)&&!hamburgerBtn.contains(e.target))closeMobileMenu();});
    const userBtnTrigger = gebi('userBtnTrigger'); const userDropdownMenu = gebi('userDropdownMenu'); if(userBtnTrigger&&userDropdownMenu){userBtnTrigger.addEventListener('click',function(e){e.stopPropagation();const iS=userDropdownMenu.style.display==='block';userDropdownMenu.style.display=iS?'none':'block';this.setAttribute('aria-expanded',String(!iS));}); document.addEventListener('click',function(e){if(userDropdownMenu&&userDropdownMenu.style.display==='block'&&!userBtnTrigger.contains(e.target)&&!userDropdownMenu.contains(e.target)){userDropdownMenu.style.display='none';userBtnTrigger.setAttribute('aria-expanded','false');}});}
    const loginOverlay = gebi('loginOverlay'); const loginPopup = gebi('loginPopup'); const closeLoginPopupBtn = gebi('closeLoginPopupBtn'); const loginTabs = document.querySelectorAll('.login-tab'); const loginForms = document.querySelectorAll('#loginPopup .login-form'); const loginFormEl = gebi('loginForm'); const registerFormEl = gebi('registerForm'); const loginErrorMessageEl = gebi('login-error-message'); const registerErrorMessageEl = gebi('register-error-message');
    function openLoginPopup(){if(loginOverlay)loginOverlay.classList.add('active');if(loginPopup)loginPopup.classList.add('active');document.body.style.overflow='hidden';resetFormErrorsAndMessages();const loginTabToActivate = loginPopup.querySelector('.login-tab[data-tab="login"]'); if(loginTabToActivate) loginTabToActivate.click(); gebi('login-email')?.focus();}
    function closeLoginPopup(){if(loginOverlay)loginOverlay.classList.remove('active');if(loginPopup)loginPopup.classList.remove('active');document.body.style.overflow='';resetFormErrorsAndMessages();}
    function resetFormErrorsAndMessages(){loginForms.forEach(f=>f.querySelectorAll('.form-control.error-border').forEach(i=>i.classList.remove('error-border')));if(loginErrorMessageEl)loginErrorMessageEl.style.display='none';if(registerErrorMessageEl)registerErrorMessageEl.style.display='none';}
    gebi('login-btn-desktop')?.addEventListener('click',(e)=>{e.preventDefault();openLoginPopup();}); gebi('login-btn-mobile')?.addEventListener('click',(e)=>{e.preventDefault();openLoginPopup();closeMobileMenu();});
    if(closeLoginPopupBtn)closeLoginPopupBtn.addEventListener('click',closeLoginPopup); if(loginOverlay)loginOverlay.addEventListener('click',(e)=>{if(e.target===loginOverlay)closeLoginPopup();});
    loginTabs.forEach(t=>t.addEventListener('click',()=>{const id=t.dataset.tab;loginTabs.forEach(tb=>tb.classList.remove('active'));t.classList.add('active');loginForms.forEach(f=>{f.classList.remove('active');if(f.id===`${id}Form`){f.classList.add('active');f.querySelector('input:not([type="hidden"])')?.focus();}});resetFormErrorsAndMessages();}));

    loginFormEl?.addEventListener('submit',async(e)=>{
        e.preventDefault();
        resetFormErrorsAndMessages();
        const b=loginFormEl.querySelector('button[type="submit"]');
        const o=b.innerHTML;
        b.disabled=true;
        b.innerHTML='Accesso...<div class="spinner-mini-light"></div>';
        try{
            const r=await fetch('login.php',{method:'POST',body:new FormData(loginFormEl)});
            const j=await r.json();
            if(!r.ok)throw new Error(j.message||`Errore ${r.status}`);
            if(j.success){
                currentUserData={email:j.email,nome:j.nome,iconPath:j.iconPath,isAdmin:j.is_admin===true||j.is_admin===1};
                localStorage.setItem('userDataEFF',JSON.stringify(currentUserData));

                updateNavbarUI();
                closeLoginPopup();
                await loadPageContentsFromServer();

                if (currentUserData.isAdmin) {
                    toggleEditMode(false);
                }
                showPageStatus(`Benvenuto/a ${currentUserData.nome}!`,"success");

            }else{
                loginFormEl.querySelectorAll('#login-email,#login-password').forEach(el=>el.classList.add('error-border'));
                if(loginErrorMessageEl){loginErrorMessageEl.textContent=j.message||"Credenziali errate.";loginErrorMessageEl.style.display='block';}
            }
        }catch(err){
            console.error("Errore login:",err);
            if(loginErrorMessageEl){loginErrorMessageEl.textContent="Errore connessione o server.";loginErrorMessageEl.style.display='block';}
        }finally{
            b.disabled=false;
            b.innerHTML=o;
        }
    });

    registerFormEl?.addEventListener('submit',async(e)=>{e.preventDefault();resetFormErrorsAndMessages();const b=registerFormEl.querySelector('button[type="submit"]');const o=b.innerHTML;b.disabled=true;b.innerHTML='Registrazione...<div class="spinner-mini-light"></div>';try{const r=await fetch('registrati.php',{method:'POST',body:new FormData(registerFormEl)});const j=await r.json();if(!r.ok)throw new Error(j.message||`Errore ${r.status}`);if(j.success){alert(j.message||"Registrazione completata! Ora puoi accedere.");const loginTabButton=document.querySelector('.login-tab[data-tab="login"]');if(loginTabButton)loginTabButton.click();const loginEmailInput=gebi('login-email');const registerEmailInput=gebi('register-email');if(loginEmailInput&&registerEmailInput)loginEmailInput.value=registerEmailInput.value;e.target.reset();}else{if(registerErrorMessageEl){registerErrorMessageEl.textContent=j.message||"Errore registrazione.";registerErrorMessageEl.style.display='block';}if(j.errors){for(const f in j.errors)gebi(`register-${f}`)?.classList.add('error-border');}}}catch(err){console.error("Errore registrazione:",err);if(registerErrorMessageEl){registerErrorMessageEl.textContent="Errore connessione o server.";registerErrorMessageEl.style.display='block';}}finally{b.disabled=false;b.innerHTML=o;}});
    gebi('logout-link-desktop')?.addEventListener('click',(e)=>{e.preventDefault();handleLogout();}); gebi('mobileLogoutLink')?.addEventListener('click',(e)=>{e.preventDefault();handleLogout();closeMobileMenu();});

    const forgotPasswordLink = document.getElementById('forgotPasswordLink');
    const forgotPasswordOverlay = document.getElementById('forgotPasswordOverlay');
    const forgotPasswordPopup = document.getElementById('forgotPasswordPopup');
    const closeForgotPasswordPopupBtn = document.getElementById('closeForgotPasswordPopupBtn');
    const forgotPasswordForm = document.getElementById('forgotPasswordForm');
    const forgotPasswordMessage = document.getElementById('forgot-password-message');
    function openForgotPasswordPopup() { if (typeof closeLoginPopup === 'function' && loginPopup?.classList.contains('active')) { closeLoginPopup(); } if (forgotPasswordOverlay) forgotPasswordOverlay.classList.add('active'); if (forgotPasswordPopup) forgotPasswordPopup.classList.add('active'); document.body.style.overflow = 'hidden'; if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'none'; const forgotEmailInput = document.getElementById('forgot-email'); if(forgotEmailInput) forgotEmailInput.focus(); }
    function closeForgotPasswordPopup() { if (forgotPasswordOverlay) forgotPasswordOverlay.classList.remove('active'); if (forgotPasswordPopup) forgotPasswordPopup.classList.remove('active'); let anyOtherPagePopupActive = document.querySelector('#loginPopup.active, #editContentModal.active, #editQuandoModal.active'); if (!anyOtherPagePopupActive) { document.body.style.overflow = ''; } if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'none'; if(forgotPasswordForm) forgotPasswordForm.reset(); }
    if (forgotPasswordLink) { forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); openForgotPasswordPopup(); }); }
    if (closeForgotPasswordPopupBtn) closeForgotPasswordPopupBtn.addEventListener('click', closeForgotPasswordPopup);
    if (forgotPasswordOverlay) forgotPasswordOverlay.addEventListener('click', (e) => { if (e.target === forgotPasswordOverlay) closeForgotPasswordPopup(); });
    if (forgotPasswordForm) { forgotPasswordForm.addEventListener('submit', async (e) => { e.preventDefault(); if (forgotPasswordMessage) { forgotPasswordMessage.style.display = 'none'; forgotPasswordMessage.className = 'form-message'; } const emailInput = document.getElementById('forgot-email'); const submitBtn = forgotPasswordForm.querySelector('button[type="submit"]'); const originalBtnText = submitBtn.innerHTML; submitBtn.disabled = true; submitBtn.innerHTML = 'Invio...<div class="spinner-mini-light"></div>'; try { const formData = new FormData(forgotPasswordForm); const response = await fetch('richiesta_recupero_password.php', { method: 'POST', body: formData }); const result = await response.json(); if (result.success) { forgotPasswordMessage.textContent = result.message; forgotPasswordMessage.classList.add('success'); if(emailInput) emailInput.value = ''; } else { forgotPasswordMessage.textContent = result.message || "Si è verificato un errore."; forgotPasswordMessage.classList.add('error'); } } catch (error) { console.error('Errore richiesta recupero password:', error); forgotPasswordMessage.textContent = "Errore di connessione o del server."; forgotPasswordMessage.classList.add('error'); } finally { if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'block'; submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; } }); }

    const editPageBtn=gebi('editPageBtn');const savePageChangesBtn=gebi('savePageChangesBtn'); const cancelPageChangesBtn=gebi('cancelPageChangesBtn');
    const editContentModal=gebi('editContentModal'); const closeEditContentModalBtn=gebi('closeEditContentModalBtn');const editModalTitle=gebi('editModalTitle'); const editModalTextarea=gebi('editModalTextarea');const editModalInputText=gebi('editModalInputText'); const editModalInputImage=gebi('editModalInputImage');const editModalFieldLabelText=gebi('editModalFieldLabelText'); const saveEditModalBtn=gebi('saveEditModalBtn');const cancelEditModalBtn=gebi('cancelEditModalBtn'); const editModalMessage=gebi('editModalMessage');const pageOverallStatus=gebi('pageOverallStatus'); const editModalInputFile=gebi('editModalInputFile'); const editModalFileLabel=gebi('editModalFileLabel'); const editModalFileNote = gebi('editModalFileNote');
    const editQuandoModal = gebi('editQuandoModal');
    const closeEditQuandoModalBtn = gebi('closeEditQuandoModalBtn');
    const cancelEditQuandoModalBtn = gebi('cancelEditQuandoModalBtn');
    const saveEditQuandoModalBtn = gebi('saveEditQuandoModalBtn');
    const editQuandoDayOfWeekEl = gebi('editQuandoDayOfWeek');
    const editQuandoStartTimeEl = gebi('editQuandoStartTime');
    const editQuandoEndTimeEl = gebi('editQuandoEndTime');
    const editQuandoModalMessage = gebi('editQuandoModalMessage');
    let currentEditingKey=null;let currentEditingType='text';

    function showPageStatus(message, type = 'info', duration = 3000) {
        if (!pageOverallStatus) return;
        pageOverallStatus.textContent = message;
        pageOverallStatus.className = 'form-message';
        pageOverallStatus.classList.remove('success', 'error', 'active');

        if (type === 'success') {
            pageOverallStatus.classList.add('success');
        } else if (type === 'error') {
            pageOverallStatus.classList.add('error');
        }
        if (pageOverallStatus.hideTimeout) {
            clearTimeout(pageOverallStatus.hideTimeout);
        }
        void pageOverallStatus.offsetHeight;
        pageOverallStatus.classList.add('active');

        pageOverallStatus.hideTimeout = setTimeout(() => {
            pageOverallStatus.classList.remove('active');
        }, duration);
    }

    async function loadPageContentsFromServer(){
        showPageStatus("Caricamento contenuti...","info",1500);
        try{
            const r=await fetch(`api_get_page_content.php?page=${PAGE_NAME_FOR_CONTENT}`);
            if(!r.ok)throw new Error(`Errore server: ${r.status}`);
            const d=await r.json();
            if(d.success&&d.contents&&Object.keys(d.contents).length>0){
                currentPageDbContents=d.contents;
                if (typeof currentPageDbContents.infoQuandoText === 'string') {
                    try { currentPageDbContents.infoQuandoText = JSON.parse(currentPageDbContents.infoQuandoText); }
                    catch (e) { currentPageDbContents.infoQuandoText = defaultPageContents.infoQuandoText; }
                } else if (currentPageDbContents.infoQuandoText === undefined || currentPageDbContents.infoQuandoText === null) {
                    currentPageDbContents.infoQuandoText = defaultPageContents.infoQuandoText;
                }
            } else {
                currentPageDbContents=JSON.parse(JSON.stringify(defaultPageContents));
            }
        }catch(err){
            console.error("Errore caricamento contenuti:",err);
            currentPageDbContents=JSON.parse(JSON.stringify(defaultPageContents));
            showPageStatus("Errore caricamento. Usati valori predefiniti.","error");
        }
        applyContentsToPage(currentPageDbContents);
        originalPageContentsForCancel=JSON.parse(JSON.stringify(currentPageDbContents));
    }

    function applyContentsToPage(contents) {
        document.querySelectorAll('[data-content-key]').forEach(el => {
            const key = el.dataset.contentKey;
            let contentValue = contents[key] !== undefined ? contents[key] : defaultPageContents[key];

            if (key === 'infoQuandoText') {
                el.innerHTML = formatQuandoTextDisplay(contentValue);
            } else if (contentValue !== undefined) {
                if (el.tagName === 'IMG') {
                    el.src = String(contentValue);
                    el.onerror = function() {
                        this.src = defaultPageContents[key] || `https://placehold.co/600x400/eee/ccc?text=Img Default (${key})`;
                        this.onerror = null;
                    };
                } else {
                    el.innerHTML = formatHTMLContent(String(contentValue));
                }
            } else {
                if (el.tagName !== 'IMG') el.innerHTML = `[${key} mancante]`;
                else el.src = `https://placehold.co/600x400/eee/ccc?text=${key}+mancante`;
            }
        });
        updateNextMeetingDateDisplay();
    }

    function toggleEditMode(enable){
        isEditModeActive=enable;
        document.querySelectorAll('.edit-icon-text, .edit-icon-image').forEach(icon => {
            if (currentUserData?.isAdmin && enable) {
                icon.style.display = 'flex';
                const parentWrapper = icon.closest('.editable-text-wrapper, .editable-image-wrapper');
                if (parentWrapper) {
                    let translateX = '50%';
                    let translateY = '-50%';

                    if (parentWrapper.classList.contains('main-title-editable-wrapper')) {
                        translateX = '50%';
                        translateY = '-50%';
                    } else if (parentWrapper.closest('.chi-siamo-section')) {
                        const tagName = parentWrapper.querySelector('[data-content-key]')?.tagName;
                        if (tagName === 'H2') {
                            translateX = 'calc(100% + 5px)';
                            translateY = '-50%';
                        } else if (tagName === 'P') {
                            translateX = 'calc(100% + 5px)';
                            translateY = '-50%';
                        }
                    } else if (parentWrapper.closest('.card-grid')) {
                        translateX = '50%';
                        translateY = '-50%';
                    } else if (parentWrapper.classList.contains('editable-image-wrapper')) {
                        translateX = '50%';
                        translateY = '-50%';
                    }

                    icon.style.setProperty('--custom-translate-x', translateX);
                    icon.style.setProperty('--custom-translate-y', translateY);
                }
                setTimeout(() => {
                    icon.style.opacity = '1';
                    icon.style.transform = `translate(var(--custom-translate-x), var(--custom-translate-y)) scale(1)`;
                }, 10);
            } else {
                icon.style.opacity = '0';
                icon.style.transform = `translate(var(--custom-translate-x), var(--custom-translate-y)) scale(0.8)`;
                setTimeout(() => {
                    icon.style.display = 'none';
                }, 300);
            }
        });

        const editContainer=gebi('editPageBtnContainer');
        const editBtn=gebi('editPageBtn');
        const saveBtn=gebi('savePageChangesBtn');
        const cancelBtn=gebi('cancelPageChangesBtn');
        if(editContainer) {
            if (currentUserData?.isAdmin) {
                editContainer.classList.add('active');
                if(editBtn) editBtn.style.display = enable ? 'none' : 'inline-block';
                if(saveBtn) saveBtn.style.display = enable ? 'inline-block' : 'none';
                if(cancelBtn) cancelBtn.style.display = enable ? 'inline-block' : 'none';
            } else {
                editContainer.classList.remove('active');
                if(editBtn) editBtn.style.display = 'none';
                if(saveBtn) saveBtn.style.display = 'none';
                if(cancelBtn) cancelBtn.style.display = 'none';
            }
        }
        if(enable){originalPageContentsForCancel= JSON.parse(JSON.stringify(currentPageDbContents));}
    }

    function openEditModal(key,type,currentValue){
        currentEditingKey=key;currentEditingType=type;
        if(!editContentModal||!editModalMessage)return;
        editModalMessage.style.display='none';editModalMessage.textContent='';

        if(type==='textarea'){
            editModalTitle.textContent=`Modifica Testo Paragrafo`;
        } else if(type==='image' || type === 'backgroundImage'){
            editModalTitle.textContent = `Modifica Immagine`;
        } else {
            editModalTitle.textContent=`Modifica Testo Breve`;
        }

        editModalTextarea.style.display='none';editModalInputText.style.display='none';
        editModalInputImage.style.display='none';editModalInputFile.style.display='none';
        editModalFileLabel.style.display='none';editModalFileNote.style.display='none';
        editModalInputFile.value='';
        let valForInput = currentValue;

        if (type === 'image' || type === 'backgroundImage') {
            editModalFieldLabelText.textContent = "URL Immagine Corrente:";
            editModalInputImage.value = valForInput;
            editModalInputImage.style.display='block'; editModalInputFile.style.display='block'; editModalFileLabel.style.display='block'; editModalFileNote.style.display='block'; editModalInputImage.focus();
        } else if (type === 'textarea') {
            const tmp = document.createElement('div'); tmp.innerHTML = currentValue;
            valForInput = tmp.textContent || "";
            editModalFieldLabelText.textContent="Testo (paragrafo):";
            editModalTextarea.value=valForInput.replace(/<br\s*\/?>/gi, "\n");
            editModalTextarea.style.display='block';editModalTextarea.focus();
        } else {
            const tmp = document.createElement('div'); tmp.innerHTML = currentValue;
            valForInput = tmp.textContent || "";
            editModalFieldLabelText.textContent="Testo (titolo/corto):";
            editModalInputText.value=valForInput.replace(/<br\s*\/?>/gi, "\n");
            editModalInputText.style.display='block';editModalInputText.focus();
        }
        editContentModal.style.display='flex';
    }

    function openEditQuandoModal() {
        currentEditingKey = 'infoQuandoText';
        currentEditingType = 'quando';
        if (!editQuandoModal || !editQuandoModalMessage) return;
        editQuandoModalMessage.style.display = 'none'; editQuandoModalMessage.textContent = '';
        let quandoData = currentPageDbContents.infoQuandoText;
        if (typeof quandoData !== 'object' || quandoData === null) {
            quandoData = defaultPageContents.infoQuandoText;
        }
        editQuandoDayOfWeekEl.value = quandoData.dayOfWeek !== undefined ? String(quandoData.dayOfWeek) : "5"; // Venerdì se non specificato
        editQuandoStartTimeEl.value = quandoData.startTime || "20:30";
        editQuandoEndTimeEl.value = quandoData.endTime || "22:00";
        editQuandoModal.style.display = 'flex';
        editQuandoDayOfWeekEl.focus();
    }

    function closeEditContentModal(){if(editContentModal)editContentModal.style.display='none';currentEditingKey=null;}
    function closeEditQuandoModal(){if(editQuandoModal)editQuandoModal.style.display='none';currentEditingKey=null;}

    if(editPageBtn)editPageBtn.addEventListener('click',()=>toggleEditMode(true));
    if(savePageChangesBtn)savePageChangesBtn.addEventListener('click',async()=>{
        const contentsToSave = { ...currentPageDbContents };
        document.querySelectorAll('[data-content-key]').forEach(el => {
            const key = el.dataset.contentKey;
            if (key !== 'infoQuandoText') { // Escludi 'infoQuandoText' perché è già aggiornato in currentPageDbContents
                if (el.tagName === 'IMG') {
                    contentsToSave[key] = el.src;
                } else {
                    contentsToSave[key] = el.innerHTML; // Salva HTML grezzo come è nella pagina
                }
            }
        });
        // Assicura che infoQuandoText sia stringhificato per il salvataggio
        if (typeof contentsToSave.infoQuandoText === 'object' && contentsToSave.infoQuandoText !== null) {
            contentsToSave.infoQuandoText = JSON.stringify(contentsToSave.infoQuandoText);
        } else if (contentsToSave.infoQuandoText === undefined || contentsToSave.infoQuandoText === null) {
            contentsToSave.infoQuandoText = JSON.stringify(defaultPageContents.infoQuandoText);
        }


        const btn=savePageChangesBtn;const oldHtml=btn.innerHTML;btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Salvataggio...';
        try{
            const r=await fetch('api_save_page_content.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({page_name:PAGE_NAME_FOR_CONTENT,contents:contentsToSave})});
            const j=await r.json();if(!r.ok||!j.success)throw new Error(j.message||"Errore salvataggio.");
            // Dopo il salvataggio, assicurati che currentPageDbContents.infoQuandoText sia un oggetto se era stato stringhificato
            if (typeof currentPageDbContents.infoQuandoText === 'string') {
                try { currentPageDbContents.infoQuandoText = JSON.parse(currentPageDbContents.infoQuandoText); } catch(e){ currentPageDbContents.infoQuandoText = defaultPageContents.infoQuandoText; }
            }
            originalPageContentsForCancel = JSON.parse(JSON.stringify(currentPageDbContents)); // Aggiorna il backup per l'annulla
            showPageStatus(j.message||'Modifiche salvate!','success');toggleEditMode(false);
        }catch(err){console.error("Errore salvataggio:",err);showPageStatus(`Errore: ${err.message}`,'error');}
        finally{btn.disabled=false;btn.innerHTML=oldHtml;}
    });
    if(cancelPageChangesBtn)cancelPageChangesBtn.addEventListener('click',()=>{applyContentsToPage(originalPageContentsForCancel); currentPageDbContents = JSON.parse(JSON.stringify(originalPageContentsForCancel)); toggleEditMode(false);showPageStatus('Modifiche annullate.','info');});

    document.addEventListener('click',function(e){
        if(!isEditModeActive||!currentUserData?.isAdmin)return;
        const editIcon=e.target.closest('.edit-icon-text,.edit-icon-image');
        const imageTarget=e.target.closest('img.editable-image-target');
        let elToEdit,key,type,currentVal;

        if(editIcon){
            e.stopPropagation();
            key=editIcon.dataset.key; type=editIcon.dataset.type;
            if (type === 'quando') {
                openEditQuandoModal();
                return;
            }
            elToEdit=gebi(`content-${key}`);
            if(!elToEdit){console.error(`Elemento con id content-${key} non trovato`);return;}
            currentVal = elToEdit.tagName === 'IMG' ? elToEdit.src : elToEdit.innerHTML;
            openEditModal(key, type, currentVal);
        } else if(imageTarget){
            e.stopPropagation();
            key=imageTarget.dataset.contentKey; type='image';currentVal=imageTarget.src;
            openEditModal(key,type,currentVal);
        }
    });

    if(closeEditContentModalBtn)closeEditContentModalBtn.addEventListener('click',closeEditContentModal);
    if(cancelEditModalBtn)cancelEditModalBtn.addEventListener('click',closeEditContentModal);
    if(closeEditQuandoModalBtn) closeEditQuandoModalBtn.addEventListener('click', closeEditQuandoModal);
    if(cancelEditQuandoModalBtn) cancelEditQuandoModalBtn.addEventListener('click', closeEditQuandoModal);

    if(saveEditModalBtn)saveEditModalBtn.addEventListener('click',async()=>{
        if(!currentEditingKey)return;
        let targetElement = gebi(`content-${currentEditingKey}`);
        if(!targetElement){if(editModalMessage){editModalMessage.textContent="Err: Elem. non trovato.";editModalMessage.className='form-message error';editModalMessage.style.display='block';}return;}
        let newValue='';const fileInput=gebi('editModalInputFile');
        const saveModalButton=saveEditModalBtn;const originalSaveModalButtonHtml=saveModalButton.innerHTML;
        let closeTheModal = true;
        if(currentEditingType==='image' && fileInput.files[0]){
            saveModalButton.disabled=true;saveModalButton.innerHTML='<i class="fas fa-spinner fa-spin"></i> Caricamento...';
            const formData=new FormData();formData.append('imageFile',fileInput.files[0]);formData.append('page_name',PAGE_NAME_FOR_CONTENT);formData.append('content_key',currentEditingKey);
            try{
                const r=await fetch('api_upload_image.php',{method:'POST',body:formData});
                const j=await r.json();if(!r.ok||!j.success)throw new Error(j.message||"Errore upload file.");
                newValue=j.filePath; targetElement.src=newValue;
                currentPageDbContents[currentEditingKey] = newValue;
                if(editModalMessage)editModalMessage.style.display='none';
            }
            catch(err){console.error("Errore upload immagine:",err);if(editModalMessage){editModalMessage.textContent=`Errore upload: ${err.message}`;editModalMessage.className='form-message error';editModalMessage.style.display='block';} closeTheModal = false;}
            finally{saveModalButton.disabled=false;saveModalButton.innerHTML=originalSaveModalButtonHtml;}
        } else if(currentEditingType==='image'){
            newValue=editModalInputImage.value.trim(); targetElement.src=newValue;
            currentPageDbContents[currentEditingKey] = newValue;
        } else if(currentEditingType==='textarea'){
            newValue = editModalTextarea.value; targetElement.innerHTML = formatHTMLContent(newValue); // Usa il valore grezzo per il DB
            currentPageDbContents[currentEditingKey] = newValue; // Salva valore grezzo
        } else { // text
            newValue = editModalInputText.value; targetElement.innerHTML = formatHTMLContent(newValue);
            currentPageDbContents[currentEditingKey] = newValue; // Salva valore grezzo
        }
        if(closeTheModal)closeEditContentModal();
    });

    if(saveEditQuandoModalBtn) saveEditQuandoModalBtn.addEventListener('click', () => {
        const newQuandoData = {
            dayOfWeek: parseInt(editQuandoDayOfWeekEl.value),
            startTime: editQuandoStartTimeEl.value,
            endTime: editQuandoEndTimeEl.value
        };
        currentPageDbContents.infoQuandoText = newQuandoData; // Ora è un oggetto
        applyContentsToPage(currentPageDbContents); // Aggiorna la UI
        closeEditQuandoModal();
        showPageStatus("Dettagli 'Quando' aggiornati localmente. Ricorda di salvare la pagina.", "info");
    });

    function getNextMeetingDay(targetDay, triggerHour = 22, triggerMinute = 0) {
        const today = new Date(); const currentDay = today.getDay();
        let daysUntilTarget = (targetDay - currentDay + 7) % 7;
        // Se oggi è il giorno dell'incontro e l'orario di fine è già passato, calcola per la settimana successiva
        if (daysUntilTarget === 0 && (today.getHours() > triggerHour || (today.getHours() === triggerHour && today.getMinutes() >= triggerMinute))) {
            daysUntilTarget = 7;
        }
        const nextMeeting = new Date(today); nextMeeting.setDate(today.getDate() + daysUntilTarget);
        return nextMeeting;
    }
    function formatDateItalian(date) { const options = { weekday: 'long', day: 'numeric', month: 'long' }; return date.toLocaleDateString('it-IT', options); }

    function updateNextMeetingDateDisplay() {
        const nextMeetingDateElement = gebi('next-meeting-date');
        if (nextMeetingDateElement) {
            let quandoData = currentPageDbContents.infoQuandoText; // Dovrebbe essere già un oggetto qui
            if (typeof quandoData === 'string') { // Fallback nel caso improbabile sia ancora stringa
                try { quandoData = JSON.parse(quandoData); }
                catch(e) { quandoData = defaultPageContents.infoQuandoText; }
            }
            if (typeof quandoData !== 'object' || quandoData === null) {
                quandoData = defaultPageContents.infoQuandoText;
            }

            const targetDay = (quandoData && typeof quandoData.dayOfWeek === 'number') ? quandoData.dayOfWeek : 5; // Default Venerdì
            let triggerHour = 22, triggerMinute = 0; // Orario di default per considerare l'incontro "finito" per oggi
            if (quandoData && quandoData.endTime) {
                const timeParts = quandoData.endTime.split(':');
                if (timeParts.length === 2) {
                    triggerHour = parseInt(timeParts[0]);
                    triggerMinute = parseInt(parseInt(timeParts[1]));
                }
            }
            nextMeetingDateElement.textContent = formatDateItalian(getNextMeetingDay(targetDay, triggerHour, triggerMinute));
        }
    }

    async function loadNavbarLogo() {
        const logoImgTag = document.getElementById('navbarLogoImgTag');
        if (!logoImgTag) {
            console.error("Elemento immagine logo navbar (<img id='navbarLogoImgTag'>) non trovato in incontrisullaparola.html.");
            return;
        }
        const defaultLogoPath = 'images/Logo_eremo.png';
        try {
            const response = await fetch('api_get_page_content.php?page=index');
            if (!response.ok) {
                throw new Error(`Errore HTTP ${response.status} nel caricare i dati per il logo.`);
            }
            const data = await response.json();
            if (data.success && data.contents && data.contents.navbarLogo) {
                logoImgTag.src = data.contents.navbarLogo;
            } else {
                console.warn("URL del logo navbar non trovato o errore API. Uso il logo di default.");
                logoImgTag.src = defaultLogoPath;
            }
        } catch (error) {
            console.error("Errore nel caricare dinamicamente il logo navbar:", error);
            logoImgTag.src = defaultLogoPath;
        }
    }

    document.addEventListener('DOMContentLoaded',async()=>{
        const c=gebi('currentYear');if(c)c.textContent=new Date().getFullYear();
        loadUserData();
        // updateNavbarUI(); // Chiamata spostata dopo fetchAndUpdateUserDisplayDataFromApi
        await loadNavbarLogo();
        await loadPageContentsFromServer(); // Carica i contenuti della pagina, inclusi quelli per 'infoQuandoText'
        await fetchAndUpdateUserDisplayDataFromApi(); // Aggiorna UI Navbar dopo aver potenzialmente aggiornato currentUserData

        // Assicura che toggleEditMode sia chiamato dopo che i dati utente sono completamente caricati E la navbar UI è aggiornata
        if (currentUserData && currentUserData.isAdmin) {
            toggleEditMode(false);
        } else {
            toggleEditMode(false);
            const editContainer = gebi('editPageBtnContainer');
            if(editContainer) editContainer.classList.remove('active');
        }

        document.addEventListener('keydown',(e)=>{
            if(e.key==='Escape'){
                if(loginPopup?.classList.contains('active')) closeLoginPopup();
                if(gebi('forgotPasswordPopup')?.classList.contains('active')) closeForgotPasswordPopup();
                if(editContentModal?.style.display==='flex') closeEditContentModal();
                if(editQuandoModal?.style.display==='flex') closeEditQuandoModal();
            }
        });
    });
</script>

</body>
</html>
