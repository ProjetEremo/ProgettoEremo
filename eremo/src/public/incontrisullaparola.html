<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Incontri sulla Parola - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/liquid-web/liquid-core.min.js"></script>
    <link rel="stylesheet" href="liquidai.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Stili popup login/registrazione (da auth.js) */
        .login-popup input.form-control { transition: border-color 0.3s ease; border: 1px solid #ced4da; background-color: white !important; box-shadow: none !important; outline: none !important; }
        .login-popup input.error-border { border-color: var(--danger, red) !important; }
        .login-popup input:-webkit-autofill,
        .login-popup input:-webkit-autofill:hover,
        .login-popup input:-webkit-autofill:focus { -webkit-box-shadow: 0 0 0px 1000px white inset !important; -webkit-text-fill-color: var(--dark, #333) !important; }
        .form-message { display: none; padding: 0.75rem; border-radius: 8px; font-size: 0.9em; margin-top: 0.5em; text-align: left;}
        .form-message.error { color: var(--danger, red); background-color: rgba(var(--danger-rgb, 231, 76, 60), 0.1); border: 1px solid rgba(var(--danger-rgb, 231, 76, 60), 0.3); }
        .form-message.success { color: var(--success, green); background-color: rgba(var(--success-rgb, 46, 204, 113), 0.1); border: 1px solid rgba(var(--success-rgb, 46, 204, 113), 0.3); }
        .spinner-mini-light { display: inline-block; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 0.8s linear infinite; vertical-align: middle; margin-left: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .user-avatar img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; vertical-align: middle; }
        .terms-checkbox { text-align: left; font-size: 0.9em; margin-top: 0.5rem; margin-bottom: 1rem; color: var(--gray-dark); }
        .terms-checkbox input[type="checkbox"] { margin-right: 0.5rem; vertical-align: middle; }
        .terms-checkbox label { font-weight: normal; color: var(--gray-dark); } .terms-checkbox a { color: var(--primary); text-decoration: underline; }

        /* Stili Modifica Pagina Admin */
        #editPageBtnContainer {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            z-index: 1001;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }

        #editPageBtnContainer.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        #editPageBtn, #savePageChangesBtn, #cancelPageChangesBtn {
            background-color: var(--accent);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            white-space: nowrap;
        }
        #editPageBtn i, #savePageChangesBtn i, #cancelPageChangesBtn i { margin-right: 8px; }
        #savePageChangesBtn { background-color: var(--success); }
        #cancelPageChangesBtn { background-color: var(--gray-dark); }
        #editPageBtn:hover { background-color: #c07b50; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        #savePageChangesBtn:hover { background-color: #27ae60; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        #cancelPageChangesBtn:hover { background-color: var(--dark); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }

        .editable-text-wrapper { position: relative; display: block; width:100%; }
        .editable-image-wrapper { position: relative; display: block; }

        .edit-icon-text, .edit-icon-image {
            display: none;
            position: absolute;
            background: var(--accent);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 0.9em;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.2s ease-out, transform 0.2s ease-out;
        }

        .editable-text-wrapper:hover .edit-icon-text,
        .editable-image-wrapper:hover .edit-icon-image {
            opacity: 1;
            transform: scale(1);
        }

        .edit-icon-text, .edit-icon-image {
            top: 0;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .main-title-editable-wrapper > h1 + .edit-icon-text {
            top: 50%;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .chi-siamo-section .editable-text-wrapper h2 + .edit-icon-text {
            top: 0;
            right: 0;
            transform: translate(calc(100% + 5px), -50%) scale(0.8);
        }
        .chi-siamo-section .editable-text-wrapper p + .edit-icon-text {
            top: 50%;
            right: 0;
            transform: translate(calc(100% + 5px), -50%) scale(0.8);
        }
        .editable-image-wrapper .edit-icon-image {
            top: 0;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .card-grid .editable-text-wrapper h2 + .edit-icon-text {
            top: 0;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .card-content .editable-text-wrapper p + .edit-icon-text {
            top: 0;
            right: 0;
            transform: translate(50%, -50%) scale(0.8);
        }
        .editable-text-wrapper:hover .edit-icon-text,
        .editable-image-wrapper:hover .edit-icon-image {
            opacity: 1;
            transform: translate(50%, -50%) scale(1);
        }
        .main-title-editable-wrapper:hover > h1 + .edit-icon-text,
        .chi-siamo-section .editable-text-wrapper:hover h2 + .edit-icon-text,
        .chi-siamo-section .editable-text-wrapper:hover p + .edit-icon-text {
            opacity: 1;
            transform: translate(var(--custom-translate-x, 50%), var(--custom-translate-y, -50%)) scale(1);
        }


        img.editable-image-target { border: 3px dashed var(--accent) !important; cursor: pointer; opacity: 0.85; }
        .edit-content-modal, .edit-quando-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(var(--dark-rgb, 30, 59, 47), 0.8); backdrop-filter: blur(5px); align-items: center; justify-content: center;}
        .edit-content-modal-content, .edit-quando-modal-content { background-color: var(--white); padding: 25px; border-radius: var(--border-radius-medium); width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.15); position: relative;}
        .edit-content-modal-content h3, .edit-quando-modal-content h3 { margin-top: 0; color: var(--primary); }
        .edit-content-modal .form-group, .edit-quando-modal .form-group { margin-bottom: 15px; }
        .edit-content-modal .form-group label, .edit-quando-modal .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: var(--dark); text-align: left; }
        .edit-content-modal .form-group input[type="text"], .edit-content-modal .form-group textarea,
        .edit-quando-modal .form-group select, .edit-quando-modal .form-group input[type="time"] { width: 100%; padding: 10px; border: 1px solid var(--gray-medium); border-radius: 8px; font-size: 1rem;}
        .edit-content-modal .form-group textarea { min-height: 100px; resize: vertical; }
        .edit-content-modal-actions, .edit-quando-modal-actions { margin-top: 20px; text-align: right; } .edit-content-modal-actions button, .edit-quando-modal-actions button { margin-left: 10px; }
        .close-modal-btn { position: absolute; top: 10px; right: 15px; font-size: 1.8rem; color: var(--gray-medium); background: none; border: none; cursor: pointer; line-height: 1;}
        .close-modal-btn:hover { color: var(--dark); }

        /* Stili per #pageOverallStatus - Standardizzati */
        #pageOverallStatus {
            position: fixed;
            bottom: 80px;
            left: 50%;
            z-index: 1000;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
            background-color: var(--primary);
            color: white;
            display: block;
            opacity: 0;
            transform: translateX(-50%) translateY(30px);
            transition: opacity 0.4s cubic-bezier(0.175, 0.885, 0.320, 1.275), transform 0.4s cubic-bezier(0.175, 0.885, 0.320, 1.275);
            pointer-events: none;
            max-width: 90%;
            box-sizing: border-box;
        }

        #pageOverallStatus.active {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        #pageOverallStatus.success {
            background-color: var(--success, green);
        }

        #pageOverallStatus.error {
            background-color: var(--danger, red);
        }

        .chi-siamo-image-container { aspect-ratio: 4/3; }

        /* Regolazione per allineare il testo nelle card informative */
        .info-card .card-content > h3 {
            /* Riduce lo spazio sotto il titolo per avvicinare il testo */
            margin-bottom: 0.75rem;
        }
        .info-card .card-content .editable-text-wrapper > p:first-of-type {
            /* Rimuove lo spazio sopra il paragrafo di testo, allineandolo di fatto al titolo */
            margin-top: 0;
        }
    </style>
</head>
<body>

<header class="navbar-container" id="navbarContainer">
    <nav class="navbar">
        <div class="logo">
            <a href="index.html" id="logoLink">
                <img src="images/Logo_eremo.png" alt="Logo Eremo Frate Francesco" class="navbar-logo-img" id="navbarLogoImgTag">
                <h2 id="navbarTitle">Eremo Frate Francesco</h2>
            </a>
        </div>
        <div class="menu" id="mainMenu">
            <a href="eventiincorso.html" id="navCalendarioAttivita">Calendario attività</a>
            <a href="eventipassati.html" id="navArchivioAttivita">Archivio attività</a>
            <span class="separator">|</span>
            <a href="incontrisullaparola.html" class="active" id="navIncontriParola">Incontri sulla parola</a>
            <span class="separator">|</span>
            <a href="dovesiamo.html" id="navDoveSiamo">Dove siamo</a>
            <a href="contatti.html" id="navContatti">Contatti</a>
        </div>
        <div class="right-menu">
            <button id="login-btn-desktop" class="login-btn" style="display: none;">Accedi</button>
            <div class="user-dropdown" id="userDropdownContainer" style="display: none;">
                <button class="user-btn" id="userBtnTrigger" aria-haspopup="true" aria-expanded="false">
                    <span class="user-avatar" id="navbar-avatar"><img src="uploads/icons/default_user.png" alt="User Icon"></span>
                    <span class="user-name" id="navbar-username">Utente</span>
                    <span class="dropdown-arrow">▼</span>
                </button>
                <div class="dropdown-menu" id="userDropdownMenu">
                    <a href="areapersonale.html" id="nav-profilo">Il mio profilo</a>
                    <a href="areapersonale.html#prenotazioni" id="nav-mie-prenotazioni">Le mie prenotazioni</a>
                    <a href="dashboard.html" id="nav-dashboard">Dashboard Admin</a>
                    <a href="#" id="logout-link-desktop">Esci</a>
                </div>
            </div>
            <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu">☰</button>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="eventiincorso.html">Calendario attività</a>
        <a href="eventipassati.html">Archivio attività</a>
        <a href="incontrisullaparola.html">Incontri sulla parola</a>
        <a href="dovesiamo.html">Dove siamo</a>
        <a href="contatti.html">Contatti</a>
        <hr id="mobile-menu-separator" style="display:none;">
        <a href="#" id="login-btn-mobile" style="display: none;">Accedi</a>
        <a href="areapersonale.html" id="mobile-nav-profilo" style="display: none;">Il mio profilo</a>
        <a href="areapersonale.html#prenotazioni" id="mobile-nav-mie-prenotazioni" style="display: none;">Le mie prenotazioni</a>
        <a href="dashboard.html" id="mobile-nav-dashboard" style="display: none;">Dashboard Admin</a>
        <a href="#" id="mobile-logout-link" style="display: none;">Esci</a>
    </div>
</header>

<main>
    <div class="container section-padding">
        <div class="editable-text-wrapper main-title-editable-wrapper" style="text-align: center;">
            <h1 id="content-pageHeaderTitle" data-content-key="pageHeaderTitle"></h1>
            <span class="edit-icon-text" data-key="pageHeaderTitle" data-type="text" title="Modifica Titolo Pagina">✎</span>
        </div>
    </div>

    <div class="container">
        <section class="chi-siamo-section section-padding">
            <div class="chi-siamo-image-container editable-image-wrapper">
                <img src="" alt="Gruppo di studio biblico" class="chi-siamo-image" id="content-cosaSonoImage" data-content-key="cosaSonoImage">
                <span class="edit-icon-image" data-key="cosaSonoImage" data-type="image" title="Modifica Immagine">✎</span>
            </div>
            <div class="chi-siamo-content">
                <div class="editable-text-wrapper">
                    <h2 id="content-cosaSonoHeading" data-content-key="cosaSonoHeading"></h2>
                    <span class="edit-icon-text" data-key="cosaSonoHeading" data-type="text" title="Modifica Titolo">✎</span>
                </div>
                <div class="editable-text-wrapper">
                    <p id="content-cosaSonoText1" data-content-key="cosaSonoText1"></p>
                    <span class="edit-icon-text" data-key="cosaSonoText1" data-type="textarea" title="Modifica Testo">✎</span>
                </div>
                <div class="editable-text-wrapper">
                    <p id="content-cosaSonoText2" data-content-key="cosaSonoText2"></p>
                    <span class="edit-icon-text" data-key="cosaSonoText2" data-type="textarea" title="Modifica Testo">✎</span>
                </div>
            </div>
        </section>

        <section class="chi-siamo-section reverse section-padding">
            <div class="chi-siamo-image-container editable-image-wrapper">
                <img src="" alt="Condivisione comunitaria" class="chi-siamo-image" id="content-approccioImage" data-content-key="approccioImage">
                <span class="edit-icon-image" data-key="approccioImage" data-type="image" title="Modifica Immagine">✎</span>
            </div>
            <div class="chi-siamo-content">
                <div class="editable-text-wrapper">
                    <h2 id="content-approccioHeading" data-content-key="approccioHeading"></h2>
                    <span class="edit-icon-text" data-key="approccioHeading" data-type="text" title="Modifica Titolo">✎</span>
                </div>
                <div class="editable-text-wrapper">
                    <p id="content-approccioText1" data-content-key="approccioText1"></p>
                    <span class="edit-icon-text" data-key="approccioText1" data-type="textarea" title="Modifica Testo">✎</span>
                </div>
                <div class="editable-text-wrapper">
                    <p id="content-approccioText2" data-content-key="approccioText2"></p>
                    <span class="edit-icon-text" data-key="approccioText2" data-type="textarea" title="Modifica Testo">✎</span>
                </div>
            </div>
        </section>

        <section class="section-padding">
            <div class="editable-text-wrapper">
                <h2 class="text-center mb-4" id="content-passiLectioHeading" data-content-key="passiLectioHeading"></h2>
                <span class="edit-icon-text" data-key="passiLectioHeading" data-type="text" title="Modifica Titolo">✎</span>
            </div>
            <div class="card-grid lectio-steps-grid">
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">1</div>
                        <div class="editable-text-wrapper">
                            <h3 id="content-passoLectioHeadingCard" data-content-key="passoLectioHeadingCard"></h3>
                            <span class="edit-icon-text" data-key="passoLectioHeadingCard" data-type="text" title="Modifica Titolo Passo">✎</span>
                        </div>
                        <div class="editable-text-wrapper">
                            <p id="content-passoLectioTextCard" data-content-key="passoLectioTextCard"></p>
                            <span class="edit-icon-text" data-key="passoLectioTextCard" data-type="textarea" title="Modifica Testo Passo">✎</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">2</div>
                        <div class="editable-text-wrapper">
                            <h3 id="content-passoMeditatioHeadingCard" data-content-key="passoMeditatioHeadingCard"></h3>
                            <span class="edit-icon-text" data-key="passoMeditatioHeadingCard" data-type="text" title="Modifica Titolo Passo">✎</span>
                        </div>
                        <div class="editable-text-wrapper">
                            <p id="content-passoMeditatioTextCard" data-content-key="passoMeditatioTextCard"></p>
                            <span class="edit-icon-text" data-key="passoMeditatioTextCard" data-type="textarea" title="Modifica Testo Passo">✎</span>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">3</div>
                        <div class="editable-text-wrapper">
                            <h3 id="content-passoOratioHeadingCard" data-content-key="passoOratioHeadingCard"></h3>
                            <span class="edit-icon-text" data-key="passoOratioHeadingCard" data-type="text" title="Modifica Titolo Passo">✎</span>
                        </div>
                        <div class="editable-text-wrapper">
                            <p id="content-passoOratioTextCard" data-content-key="passoOratioTextCard"></p>
                            <span class="edit-icon-text" data-key="passoOratioTextCard" data-type="textarea" title="Modifica Testo Passo">✎</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

       <section class="section-padding" style="background-color: var(--light); border-radius: var(--border-radius-large);">
            <div class="editable-text-wrapper">
                <h2 class="text-center mb-4" style="color: var(--primary);" id="content-infoPraticheHeading" data-content-key="infoPraticheHeading"></h2>
                <span class="edit-icon-text" data-key="infoPraticheHeading" data-type="text" title="Modifica Titolo">✎</span>
            </div>
            <div class="card-grid" style="gap: 2rem;">
                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-calendar-alt" style="margin-right: 8px; color: var(--secondary);"></i> Quando</h3>
                        <div class="editable-text-wrapper">
                            <p id="content-infoQuandoText" data-content-key="infoQuandoText"></p>
                            <span class="edit-icon-text" data-key="infoQuandoText" data-type="quando" title="Modifica Info Quando">✎</span>
                            <p style="margin-top: 1rem; font-size: 1rem;">Prossimo incontro: <strong id="next-meeting-date"></strong></p>
                        </div>
                    </div>
                </div>
                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-map-marker-alt" style="margin-right: 8px; color: var(--secondary);"></i> Dove</h3>
                        <div class="editable-text-wrapper">
                            <p id="content-infoDoveText" data-content-key="infoDoveText"></p>
                            <span class="edit-icon-text" data-key="infoDoveText" data-type="textarea" title="Modifica Info Dove">✎</span>
                        </div>
                    </div>
                </div>
                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-users" style="margin-right: 8px; color: var(--secondary);"></i> A chi è rivolto</h3>
                        <div class="editable-text-wrapper">
                            <p id="content-infoRivoltoText" data-content-key="infoRivoltoText"></p>
                            <span class="edit-icon-text" data-key="infoRivoltoText" data-type="textarea" title="Modifica Info Rivolto">✎</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<!--
  [RIMOSSO] I popup di login/registrazione/recupero password sono stati rimossi da qui.
  Vengono ora creati e gestiti dinamicamente dallo script 'auth.js'.
-->

<div id="editPageBtnContainer">
    <button id="editPageBtn"><i class="fas fa-pencil-alt"></i> Attiva Modifiche</button>
    <button id="savePageChangesBtn" style="display:none;"><i class="fas fa-save"></i> Salva Modifiche Pagina</button>
    <button id="cancelPageChangesBtn" style="display:none;"><i class="fas fa-times"></i> Annulla Modifiche</button>
</div>
<div id="pageOverallStatus"></div>


<div id="editContentModal" class="edit-content-modal">
    <div class="edit-content-modal-content">
        <button class="close-modal-btn" id="closeEditContentModalBtn" aria-label="Chiudi">×</button>
        <h3 id="editModalTitle">Modifica Contenuto</h3>
        <div class="form-group">
            <label id="editModalFieldLabelText">Testo:</label>
            <textarea id="editModalTextarea" class="form-control" rows="5" style="display:none;"></textarea>
            <input type="text" id="editModalInputText" class="form-control" style="display:none;">
            <input type="text" id="editModalInputImage" class="form-control" style="display:none;" placeholder="URL immagine esistente o nuovo (http://...)">
            <label for="editModalInputFile" id="editModalFileLabel" style="margin-top: 10px; display:none;">Oppure carica nuova immagine:</label>
            <input type="file" id="editModalInputFile" class="form-control" style="display:none;" accept="image/jpeg, image/png, image/gif, image/webp">
            <small id="editModalFileNote" style="display:none; font-size:0.8em; color: var(--gray-dark);">Se carichi un file, questo sostituirà l'URL sopra. L'immagine verrà salvata sul server.</small>
        </div>
        <div id="editModalMessage" class="form-message" style="margin-bottom:1rem;"></div>
        <div class="edit-content-modal-actions">
            <button type="button" class="btn-popup btn-secondary" id="cancelEditModalBtn">Annulla</button>
            <button type="button" class="btn-popup" id="saveEditModalBtn">Salva</button>
        </div>
    </div>
</div>

<div id="editQuandoModal" class="edit-quando-modal">
    <div class="edit-quando-modal-content">
        <button class="close-modal-btn" id="closeEditQuandoModalBtn" aria-label="Chiudi">×</button>
        <h3>Modifica Dettagli Incontro "Quando"</h3>
        <div class="form-group">
            <label for="editQuandoDayOfWeek">Giorno della Settimana:</label>
            <select id="editQuandoDayOfWeek" class="form-control">
                <option value="0">Domenica</option>
                <option value="1">Lunedì</option>
                <option value="2">Martedì</option>
                <option value="3">Mercoledì</option>
                <option value="4">Giovedì</option>
                <option value="5">Venerdì</option>
                <option value="6">Sabato</option>
            </select>
        </div>
        <div class="form-group">
            <label for="editQuandoStartTime">Orario Inizio:</label>
            <input type="time" id="editQuandoStartTime" class="form-control">
        </div>
        <div class="form-group">
            <label for="editQuandoEndTime">Orario Fine:</label>
            <input type="time" id="editQuandoEndTime" class="form-control">
        </div>
        <div id="editQuandoModalMessage" class="form-message" style="margin-bottom:1rem;"></div>
        <div class="edit-quando-modal-actions">
            <button type="button" class="btn-popup btn-secondary" id="cancelEditQuandoModalBtn">Annulla</button>
            <button type="button" class="btn-popup" id="saveEditQuandoModalBtn">Salva Quando</button>
        </div>
    </div>
</div>

<div id="ai-assistant-fab" title="Assistente Virtuale Eremo" data-liquid> <i class="fas fa-headset"></i>
</div>


<div id="ai-chat-popup">
    <div id="ai-chat-header">
        <h3>Assistente Eremo <i class="fas fa-robot"></i></h3>
        <button id="ai-chat-close-btn" aria-label="Chiudi Chat">×</button>
    </div>
    <div id="ai-chat-messages">
        <div class="ai-message">Ciao! Sono l'assistente virtuale dell'Eremo. Come posso aiutarti oggi riguardo il sito?</div>
    </div>
    <div id="ai-chat-input-container">
        <textarea id="ai-chat-input" placeholder="Scrivi la tua domanda..." rows="2"></textarea>
        <button id="ai-chat-send-btn" aria-label="Invia Messaggio"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<footer>
  <p>© <span id="currentYear"></span> Eremo Frate Francesco. OdV Via San Vito 2, Nembro. C.F.:90004060167. Sviluppato da 5AII 2024-2025 Majorana Seriate.</p>
</footer>

<script src="assistenteAI.js" defer></script>
<script src="liquidglass.js" defer></script>
<script src="auth.js" defer></script>

<script>
    const PAGE_NAME_FOR_CONTENT = 'incontrisullaparola';
    let isEditModeActive = false;
    let originalPageContentsForCancel = {};
    let currentPageDbContents = {};

    const defaultPageContents = {
        pageHeaderTitle: "Incontri sulla Parola",
        cosaSonoImage: "images/default-image-1.jpg",
        cosaSonoHeading: "Cosa sono gli Incontri sulla Parola?",
        cosaSonoText1: "Gli Incontri sulla Parola sono un appuntamento settimanale dedicato all'ascolto, alla meditazione e alla condivisione della Parola di Dio, secondo il metodo della <strong>Lectio Divina</strong>. È un'opportunità per nutrire la propria fede, approfondire la comprensione delle Scritture e crescere insieme come comunità.",
        cosaSonoText2: "Non si tratta di uno studio accademico, ma di un'esperienza spirituale che cerca di far risuonare la Parola nella vita di ciascuno, in un clima di ascolto reciproco e di preghiera.",
        infoPraticheHeading: "Informazioni Pratiche",
        infoQuandoText: { dayOfWeek: 3, startTime: "20:30", endTime: "22:00" }, // Mercoledì per default
        infoDoveText: "Presso la sala incontri dell'Eremo Frate Francesco<br>Via San Vito, Nembro (BG)",
        infoRivoltoText: "L'invito è aperto a tutti: giovani, adulti, famiglie. Non è richiesta alcuna preparazione teologica specifica, solo il desiderio di mettersi in ascolto della Parola.",
        approccioImage: "images/default-image-2.jpg",
        approccioHeading: "Un Approccio Comunitario alla Lectio Divina",
        approccioText1: "La Lectio Divina è un metodo antico di preghiera e lettura della Bibbia che si articola in quattro momenti: <strong>Lectio</strong> (lettura), <strong>Meditatio</strong> (meditazione), <strong>Oratio</strong> (preghiera) e <strong>Contemplatio</strong> (contemplazione).",
        approccioText2: "Durante i nostri incontri, applichiamo questo metodo in modo comunitario. Dopo la lettura attenta di un brano biblico, ognuno è invitato a meditare su ciò che lo ha colpito, a trasformarlo in preghiera personale e, infine, a condividere liberamente (senza obbligo) le proprie riflessioni con il gruppo, arricchendosi reciprocamente.",
        passiLectioHeading: "I Passi della Lectio Comunitaria",
        passoLectioHeadingCard: "Lectio (Lettura)",
        passoLectioTextCard: "Lettura attenta e ripetuta del brano biblico scelto per l'incontro, cercando di cogliere il messaggio letterale.",
        passoMeditatioHeadingCard: "Meditatio (Meditazione)",
        passoMeditatioTextCard: "Riflessione personale: cosa dice a me, oggi, questa Parola? Quali sentimenti o pensieri suscita?",
        passoOratioHeadingCard: "Oratio (Preghiera)",
        passoOratioTextCard: "Risposta personale alla Parola attraverso la preghiera: lode, ringraziamento, richiesta, supplica."
    };

    function gebi(id) { return document.getElementById(id); }

    // Gestione menu mobile e dropdown (specifico per questa pagina, per evitare conflitti con auth.js)
    function setupPageNavigation() {
        const hamburgerBtn = gebi("hamburgerBtn");
        const mobileMenu = gebi("mobileMenu");
        function toggleMobileMenu() {
            if (mobileMenu && hamburgerBtn) {
                const isOpen = mobileMenu.classList.toggle("open");
                hamburgerBtn.classList.toggle("open");
                hamburgerBtn.setAttribute("aria-expanded", String(isOpen));
                document.body.style.overflow = isOpen ? "hidden" : "";
            }
        }
        function closeMobileMenu() {
            if (mobileMenu && hamburgerBtn && mobileMenu.classList.contains("open")) {
                mobileMenu.classList.remove("open");
                hamburgerBtn.classList.remove("open");
                hamburgerBtn.setAttribute("aria-expanded", "false");
                document.body.style.overflow = "";
            }
        }
        if (hamburgerBtn) hamburgerBtn.addEventListener("click", toggleMobileMenu);
        document.querySelectorAll("#mobileMenu a").forEach(link => {
            if (!link.id.includes('login') && !link.id.includes('logout')) {
                link.addEventListener("click", closeMobileMenu);
            }
        });
        document.addEventListener("click", function(e) {
            if (mobileMenu && mobileMenu.classList.contains("open") && hamburgerBtn && !mobileMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                closeMobileMenu();
            }
        });

        const userBtnTrigger = gebi('userBtnTrigger');
        const userDropdownMenu = gebi('userDropdownMenu');
        if (userBtnTrigger && userDropdownMenu) {
            userBtnTrigger.addEventListener('click', function(e) {
                e.stopPropagation();
                const isShown = userDropdownMenu.style.display === 'block';
                userDropdownMenu.style.display = isShown ? 'none' : 'block';
                this.setAttribute('aria-expanded', String(!isShown));
            });
            document.addEventListener('click', function(e) {
                if (userDropdownMenu && userDropdownMenu.style.display === 'block' && !userBtnTrigger.contains(e.target) && !userDropdownMenu.contains(e.target)) {
                    userDropdownMenu.style.display = 'none';
                    userBtnTrigger.setAttribute('aria-expanded', 'false');
                }
            });
        }
    }

    function formatHTMLContent(str) {
        if (typeof str !== 'string') str = String(str || '');
        return str.replace(/\r\n|\r|\n/g, '<br>');
    }

    function formatQuandoTextDisplay(quandoDataObjOrString) {
        let dataToParse = quandoDataObjOrString;
        if (typeof dataToParse === 'string') {
            try { dataToParse = JSON.parse(dataToParse); }
            catch (e) { dataToParse = defaultPageContents.infoQuandoText; }
        }
        if (typeof dataToParse !== 'object' || dataToParse === null ||
            typeof dataToParse.dayOfWeek === 'undefined' ||
            typeof dataToParse.startTime !== 'string' ||
            typeof dataToParse.endTime !== 'string') {
            dataToParse = defaultPageContents.infoQuandoText;
        }
        const days = ["Domenica", "Lunedì", "Martedì", "Mercoledì", "Giovedì", "Venerdì", "Sabato"];
        const dayName = days[dataToParse.dayOfWeek] || "Giorno non specificato";
        return `Ogni ${dayName} sera<br>Orario: ${dataToParse.startTime} - ${dataToParse.endTime}`;
    }
    
    let lastScroll = 0; const navbarContainer = gebi("navbarContainer"); if (navbarContainer) { window.addEventListener("scroll", function () { const cS = window.pageYOffset||document.documentElement.scrollTop; if(cS<=50){navbarContainer.classList.remove("hidden");lastScroll=0;return;} if(cS>lastScroll&&!navbarContainer.classList.contains("hidden"))navbarContainer.classList.add("hidden"); else if(cS<lastScroll&&navbarContainer.classList.contains("hidden"))navbarContainer.classList.remove("hidden"); lastScroll=cS<=0?0:cS;}, false);}
    
    const editPageBtn=gebi('editPageBtn');const savePageChangesBtn=gebi('savePageChangesBtn'); const cancelPageChangesBtn=gebi('cancelPageChangesBtn');
    const editContentModal=gebi('editContentModal'); const closeEditContentModalBtn=gebi('closeEditContentModalBtn');const editModalTitle=gebi('editModalTitle'); const editModalTextarea=gebi('editModalTextarea');const editModalInputText=gebi('editModalInputText'); const editModalInputImage=gebi('editModalInputImage');const editModalFieldLabelText=gebi('editModalFieldLabelText'); const saveEditModalBtn=gebi('saveEditModalBtn');const cancelEditModalBtn=gebi('cancelEditModalBtn'); const editModalMessage=gebi('editModalMessage');const pageOverallStatus=gebi('pageOverallStatus'); const editModalInputFile=gebi('editModalInputFile'); const editModalFileLabel=gebi('editModalFileLabel'); const editModalFileNote = gebi('editModalFileNote');
    const editQuandoModal = gebi('editQuandoModal');
    const closeEditQuandoModalBtn = gebi('closeEditQuandoModalBtn');
    const cancelEditQuandoModalBtn = gebi('cancelEditQuandoModalBtn');
    const saveEditQuandoModalBtn = gebi('saveEditQuandoModalBtn');
    const editQuandoDayOfWeekEl = gebi('editQuandoDayOfWeek');
    const editQuandoStartTimeEl = gebi('editQuandoStartTime');
    const editQuandoEndTimeEl = gebi('editQuandoEndTime');
    const editQuandoModalMessage = gebi('editQuandoModalMessage');
    let currentEditingKey=null;let currentEditingType='text';

    function showPageStatus(message, type = 'info', duration = 3000) {
        if (!pageOverallStatus) return;
        pageOverallStatus.textContent = message;
        pageOverallStatus.className = '';
        pageOverallStatus.classList.add('active');
        if (type === 'success') pageOverallStatus.classList.add('success');
        else if (type === 'error') pageOverallStatus.classList.add('error');
        
        setTimeout(() => {
            pageOverallStatus.classList.remove('active');
        }, duration);
    }

    async function loadPageContentsFromServer(){
        showPageStatus("Caricamento contenuti...","info",1500);
        try{
            const r=await fetch(`api_get_page_content.php?page=${PAGE_NAME_FOR_CONTENT}`);
            if(!r.ok)throw new Error(`Errore server: ${r.status}`);
            const d=await r.json();
            if(d.success&&d.contents&&Object.keys(d.contents).length>0){
                currentPageDbContents=d.contents;
                if (typeof currentPageDbContents.infoQuandoText === 'string') {
                    try { currentPageDbContents.infoQuandoText = JSON.parse(currentPageDbContents.infoQuandoText); }
                    catch (e) { currentPageDbContents.infoQuandoText = defaultPageContents.infoQuandoText; }
                } else if (currentPageDbContents.infoQuandoText === undefined || currentPageDbContents.infoQuandoText === null) {
                    currentPageDbContents.infoQuandoText = defaultPageContents.infoQuandoText;
                }
            } else {
                currentPageDbContents=JSON.parse(JSON.stringify(defaultPageContents));
            }
        }catch(err){
            console.error("Errore caricamento contenuti:",err);
            currentPageDbContents=JSON.parse(JSON.stringify(defaultPageContents));
            showPageStatus("Errore caricamento. Usati valori predefiniti.","error");
        }
        applyContentsToPage(currentPageDbContents);
        originalPageContentsForCancel=JSON.parse(JSON.stringify(currentPageDbContents));
        // Dopo aver caricato i contenuti, controlla lo stato utente e mostra/nascondi i pulsanti admin
        toggleEditMode(false);
    }

    function applyContentsToPage(contents) {
        document.querySelectorAll('[data-content-key]').forEach(el => {
            const key = el.dataset.contentKey;
            let contentValue = contents[key] !== undefined ? contents[key] : defaultPageContents[key];

            if (key === 'infoQuandoText') {
                el.innerHTML = formatQuandoTextDisplay(contentValue);
            } else if (contentValue !== undefined) {
                if (el.tagName === 'IMG') {
                    el.src = String(contentValue);
                    el.onerror = function() {
                        this.src = defaultPageContents[key] || `https://placehold.co/600x400/eee/ccc?text=Img Default (${key})`;
                        this.onerror = null;
                    };
                } else {
                    el.innerHTML = formatHTMLContent(String(contentValue));
                }
            } else {
                if (el.tagName !== 'IMG') el.innerHTML = `[${key} mancante]`;
                else el.src = `https://placehold.co/600x400/eee/ccc?text=${key}+mancante`;
            }
        });
        updateNextMeetingDateDisplay();
    }

    function toggleEditMode(enable){
        isEditModeActive=enable;
        document.querySelectorAll('.edit-icon-text, .edit-icon-image').forEach(icon => {
            // currentUserData è una variabile globale definita in auth.js
            if (typeof currentUserData !== 'undefined' && currentUserData && currentUserData.isAdmin && enable) {
                icon.style.display = 'flex';
            } else {
                icon.style.display = 'none';
            }
        });

        const editContainer=gebi('editPageBtnContainer');
        const editBtn=gebi('editPageBtn');
        const saveBtn=gebi('savePageChangesBtn');
        const cancelBtn=gebi('cancelPageChangesBtn');
        if(editContainer) {
            if (typeof currentUserData !== 'undefined' && currentUserData && currentUserData.isAdmin) {
                editContainer.classList.add('active');
                if(editBtn) editBtn.style.display = enable ? 'none' : 'inline-block';
                if(saveBtn) saveBtn.style.display = enable ? 'inline-block' : 'none';
                if(cancelBtn) cancelBtn.style.display = enable ? 'inline-block' : 'none';
            } else {
                editContainer.classList.remove('active');
            }
        }
        if(enable){originalPageContentsForCancel= JSON.parse(JSON.stringify(currentPageDbContents));}
    }

    function openEditModal(key,type,currentValue){
        currentEditingKey=key;currentEditingType=type;
        if(!editContentModal||!editModalMessage)return;
        editModalMessage.style.display='none';editModalMessage.textContent='';

        if(type==='textarea'){
            editModalTitle.textContent=`Modifica Testo Paragrafo`;
        } else if(type==='image' || type === 'backgroundImage'){
            editModalTitle.textContent = `Modifica Immagine`;
        } else {
            editModalTitle.textContent=`Modifica Testo Breve`;
        }

        editModalTextarea.style.display='none';editModalInputText.style.display='none';
        editModalInputImage.style.display='none';editModalInputFile.style.display='none';
        editModalFileLabel.style.display='none';editModalFileNote.style.display='none';
        editModalInputFile.value='';
        let valForInput = currentValue;

        if (type === 'image' || type === 'backgroundImage') {
            editModalFieldLabelText.textContent = "URL Immagine Corrente:";
            editModalInputImage.value = valForInput;
            editModalInputImage.style.display='block'; editModalInputFile.style.display='block'; editModalFileLabel.style.display='block'; editModalFileNote.style.display='block'; editModalInputImage.focus();
        } else if (type === 'textarea') {
            const tmp = document.createElement('div'); tmp.innerHTML = currentValue;
            valForInput = tmp.textContent || "";
            editModalFieldLabelText.textContent="Testo (paragrafo):";
            editModalTextarea.value=valForInput.replace(/<br\s*\/?>/gi, "\n");
            editModalTextarea.style.display='block';editModalTextarea.focus();
        } else {
            const tmp = document.createElement('div'); tmp.innerHTML = currentValue;
            valForInput = tmp.textContent || "";
            editModalFieldLabelText.textContent="Testo (titolo/corto):";
            editModalInputText.value=valForInput.replace(/<br\s*\/?>/gi, "\n");
            editModalInputText.style.display='block';editModalInputText.focus();
        }
        editContentModal.style.display='flex';
    }

    function openEditQuandoModal() {
        currentEditingKey = 'infoQuandoText';
        currentEditingType = 'quando';
        if (!editQuandoModal || !editQuandoModalMessage) return;
        editQuandoModalMessage.style.display = 'none'; editQuandoModalMessage.textContent = '';
        let quandoData = currentPageDbContents.infoQuandoText;
        if (typeof quandoData !== 'object' || quandoData === null) {
            quandoData = defaultPageContents.infoQuandoText;
        }
        editQuandoDayOfWeekEl.value = quandoData.dayOfWeek !== undefined ? String(quandoData.dayOfWeek) : "5"; // Venerdì se non specificato
        editQuandoStartTimeEl.value = quandoData.startTime || "20:30";
        editQuandoEndTimeEl.value = quandoData.endTime || "22:00";
        editQuandoModal.style.display = 'flex';
        editQuandoDayOfWeekEl.focus();
    }

    function closeEditContentModal(){if(editContentModal)editContentModal.style.display='none';currentEditingKey=null;}
    function closeEditQuandoModal(){if(editQuandoModal)editQuandoModal.style.display='none';currentEditingKey=null;}

    if(editPageBtn)editPageBtn.addEventListener('click',()=>toggleEditMode(true));
    if(savePageChangesBtn)savePageChangesBtn.addEventListener('click',async()=>{
        const contentsToSave = { ...currentPageDbContents };
        document.querySelectorAll('[data-content-key]').forEach(el => {
            const key = el.dataset.contentKey;
            if (key !== 'infoQuandoText') { // Escludi 'infoQuandoText' perché è già aggiornato in currentPageDbContents
                if (el.tagName === 'IMG') {
                    contentsToSave[key] = el.src;
                } else {
                    contentsToSave[key] = el.innerHTML; // Salva HTML grezzo come è nella pagina
                }
            }
        });
        if (typeof contentsToSave.infoQuandoText === 'object' && contentsToSave.infoQuandoText !== null) {
            contentsToSave.infoQuandoText = JSON.stringify(contentsToSave.infoQuandoText);
        } else if (contentsToSave.infoQuandoText === undefined || contentsToSave.infoQuandoText === null) {
            contentsToSave.infoQuandoText = JSON.stringify(defaultPageContents.infoQuandoText);
        }

        const btn=savePageChangesBtn;const oldHtml=btn.innerHTML;btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Salvataggio...';
        try{
            const r=await fetch('api_save_page_content.php',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({page_name:PAGE_NAME_FOR_CONTENT,contents:contentsToSave})});
            const j=await r.json();if(!r.ok||!j.success)throw new Error(j.message||"Errore salvataggio.");
            if (typeof currentPageDbContents.infoQuandoText === 'string') {
                try { currentPageDbContents.infoQuandoText = JSON.parse(currentPageDbContents.infoQuandoText); } catch(e){ currentPageDbContents.infoQuandoText = defaultPageContents.infoQuandoText; }
            }
            originalPageContentsForCancel = JSON.parse(JSON.stringify(currentPageDbContents));
            showPageStatus(j.message||'Modifiche salvate!','success');toggleEditMode(false);
        }catch(err){console.error("Errore salvataggio:",err);showPageStatus(`Errore: ${err.message}`,'error');}
        finally{btn.disabled=false;btn.innerHTML=oldHtml;}
    });
    if(cancelPageChangesBtn)cancelPageChangesBtn.addEventListener('click',()=>{applyContentsToPage(originalPageContentsForCancel); currentPageDbContents = JSON.parse(JSON.stringify(originalPageContentsForCancel)); toggleEditMode(false);showPageStatus('Modifiche annullate.','info');});

    document.addEventListener('click',function(e){
        if(!isEditModeActive|| !currentUserData?.isAdmin)return;
        const editIcon=e.target.closest('.edit-icon-text,.edit-icon-image');
        const imageTarget=e.target.closest('img.editable-image-target');
        let elToEdit,key,type,currentVal;

        if(editIcon){
            e.stopPropagation();
            key=editIcon.dataset.key; type=editIcon.dataset.type;
            if (type === 'quando') {
                openEditQuandoModal();
                return;
            }
            elToEdit=gebi(`content-${key}`);
            if(!elToEdit){console.error(`Elemento con id content-${key} non trovato`);return;}
            currentVal = elToEdit.tagName === 'IMG' ? elToEdit.src : elToEdit.innerHTML;
            openEditModal(key, type, currentVal);
        } else if(imageTarget){
            e.stopPropagation();
            key=imageTarget.dataset.contentKey; type='image';currentVal=imageTarget.src;
            openEditModal(key,type,currentVal);
        }
    });

    if(closeEditContentModalBtn)closeEditContentModalBtn.addEventListener('click',closeEditContentModal);
    if(cancelEditModalBtn)cancelEditModalBtn.addEventListener('click',closeEditContentModal);
    if(closeEditQuandoModalBtn) closeEditQuandoModalBtn.addEventListener('click', closeEditQuandoModal);
    if(cancelEditQuandoModalBtn) cancelEditQuandoModalBtn.addEventListener('click', closeEditQuandoModal);

    if(saveEditModalBtn)saveEditModalBtn.addEventListener('click',async()=>{
        if(!currentEditingKey)return;
        let targetElement = gebi(`content-${currentEditingKey}`);
        if(!targetElement){if(editModalMessage){editModalMessage.textContent="Err: Elem. non trovato.";editModalMessage.className='form-message error';editModalMessage.style.display='block';}return;}
        let newValue='';const fileInput=gebi('editModalInputFile');
        const saveModalButton=saveEditModalBtn;const originalSaveModalButtonHtml=saveModalButton.innerHTML;
        let closeTheModal = true;
        if(currentEditingType==='image' && fileInput.files[0]){
            saveModalButton.disabled=true;saveModalButton.innerHTML='<i class="fas fa-spinner fa-spin"></i> Caricamento...';
            const formData=new FormData();formData.append('imageFile',fileInput.files[0]);formData.append('page_name',PAGE_NAME_FOR_CONTENT);formData.append('content_key',currentEditingKey);
            try{
                const r=await fetch('api_upload_image.php',{method:'POST',body:formData});
                const j=await r.json();if(!r.ok||!j.success)throw new Error(j.message||"Errore upload file.");
                newValue=j.filePath; targetElement.src=newValue;
                currentPageDbContents[currentEditingKey] = newValue;
                if(editModalMessage)editModalMessage.style.display='none';
            }
            catch(err){console.error("Errore upload immagine:",err);if(editModalMessage){editModalMessage.textContent=`Errore upload: ${err.message}`;editModalMessage.className='form-message error';editModalMessage.style.display='block';} closeTheModal = false;}
            finally{saveModalButton.disabled=false;saveModalButton.innerHTML=originalSaveModalButtonHtml;}
        } else if(currentEditingType==='image'){
            newValue=editModalInputImage.value.trim(); targetElement.src=newValue;
            currentPageDbContents[currentEditingKey] = newValue;
        } else if(currentEditingType==='textarea'){
            newValue = editModalTextarea.value; targetElement.innerHTML = formatHTMLContent(newValue);
            currentPageDbContents[currentEditingKey] = newValue;
        } else { // text
            newValue = editModalInputText.value; targetElement.innerHTML = formatHTMLContent(newValue);
            currentPageDbContents[currentEditingKey] = newValue;
        }
        if(closeTheModal)closeEditContentModal();
    });

    if(saveEditQuandoModalBtn) saveEditQuandoModalBtn.addEventListener('click', () => {
        const newQuandoData = {
            dayOfWeek: parseInt(editQuandoDayOfWeekEl.value),
            startTime: editQuandoStartTimeEl.value,
            endTime: editQuandoEndTimeEl.value
        };
        currentPageDbContents.infoQuandoText = newQuandoData;
        applyContentsToPage(currentPageDbContents);
        closeEditQuandoModal();
        showPageStatus("Dettagli 'Quando' aggiornati localmente. Ricorda di salvare la pagina.", "info");
    });

    function getNextMeetingDay(targetDay, triggerHour = 22, triggerMinute = 0) {
        const today = new Date(); const currentDay = today.getDay();
        let daysUntilTarget = (targetDay - currentDay + 7) % 7;
        if (daysUntilTarget === 0 && (today.getHours() > triggerHour || (today.getHours() === triggerHour && today.getMinutes() >= triggerMinute))) {
            daysUntilTarget = 7;
        }
        const nextMeeting = new Date(today); nextMeeting.setDate(today.getDate() + daysUntilTarget);
        return nextMeeting;
    }
    function formatDateItalian(date) { const options = { weekday: 'long', day: 'numeric', month: 'long' }; return date.toLocaleDateString('it-IT', options); }

    function updateNextMeetingDateDisplay() {
        const nextMeetingDateElement = gebi('next-meeting-date');
        if (nextMeetingDateElement) {
            let quandoData = currentPageDbContents.infoQuandoText;
            if (typeof quandoData === 'string') {
                try { quandoData = JSON.parse(quandoData); }
                catch(e) { quandoData = defaultPageContents.infoQuandoText; }
            }
            if (typeof quandoData !== 'object' || quandoData === null) {
                quandoData = defaultPageContents.infoQuandoText;
            }

            const targetDay = (quandoData && typeof quandoData.dayOfWeek === 'number') ? quandoData.dayOfWeek : 5; // Default Venerdì
            let triggerHour = 22, triggerMinute = 0;
            if (quandoData && quandoData.endTime) {
                const timeParts = quandoData.endTime.split(':');
                if (timeParts.length === 2) {
                    triggerHour = parseInt(timeParts[0]);
                    triggerMinute = parseInt(parseInt(timeParts[1]));
                }
            }
            nextMeetingDateElement.textContent = formatDateItalian(getNextMeetingDay(targetDay, triggerHour, triggerMinute));
        }
    }

    async function loadNavbarLogo() {
        const logoImgTag = document.getElementById('navbarLogoImgTag');
        if (!logoImgTag) {
            console.error("Elemento immagine logo navbar non trovato.");
            return;
        }
        const defaultLogoPath = 'images/Logo_eremo.png';
        try {
            const response = await fetch('api_get_page_content.php?page=index');
            if (!response.ok) throw new Error(`Errore HTTP ${response.status}`);
            const data = await response.json();
            if (data.success && data.contents && data.contents.navbarLogo) {
                logoImgTag.src = data.contents.navbarLogo;
            } else {
                logoImgTag.src = defaultLogoPath;
            }
        } catch (error) {
            console.error("Errore nel caricare il logo navbar:", error);
            logoImgTag.src = defaultLogoPath;
        }
    }

    document.addEventListener('DOMContentLoaded',async()=>{
        const c=gebi('currentYear');if(c)c.textContent=new Date().getFullYear();
        
        setupPageNavigation();
        
        // auth.js gestirà il caricamento dati utente e l'aggiornamento UI della navbar
        // quindi qui ci concentriamo solo sulla logica della pagina
        await loadNavbarLogo();
        await loadPageContentsFromServer();
        
        document.addEventListener('loginSuccess', async () => {
            console.log('Login Rilevato. Aggiorno UI IncontriSullaParola.');
            await loadPageContentsFromServer();
        });

        document.addEventListener('logoutSuccess', async () => {
            console.log('Logout Rilevato. Aggiorno UI IncontriSullaParola.');
            await loadPageContentsFromServer();
        });

        document.addEventListener('keydown',(e)=>{
            if(e.key==='Escape'){
                if(editContentModal?.style.display==='flex') closeEditContentModal();
                if(editQuandoModal?.style.display==='flex') closeEditQuandoModal();
            }
        });
    });
</script>

</body>
</html>
