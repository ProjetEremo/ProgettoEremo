<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon"> <title>Incontri sulla Parola - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Stili aggiuntivi per coerenza e messaggi di errore */
        .login-popup input.form-control.error-border {
            border-color: var(--danger, red) !important;
        }
        .login-popup input:-webkit-autofill,
        .login-popup input:-webkit-autofill:hover,
        .login-popup input:-webkit-autofill:focus {
            -webkit-box-shadow: 0 0 0px 1000px var(--white, white) inset !important;
            -webkit-text-fill-color: var(--dark, #333) !important;
        }
        .form-message.error {
            color: var(--danger, red);
            background-color: rgba(var(--danger-rgb, 231, 76, 60), 0.1);
            border: 1px solid rgba(var(--danger-rgb, 231, 76, 60), 0.3);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9em;
            margin-top: 0.5em;
            text-align: left;
        }
        .spinner-mini-light { /* Spinner per bottoni */
            display: inline-block;
            width: 1em;
            height: 1em;
            border: 2px solid rgba(0,0,0,0.2); /* Colore base spinner */
            border-radius: 50%;
            border-top-color: #000; /* Colore del loader che gira */
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-left: 5px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* Assicurati che .terms-checkbox sia stilizzato se non lo √® gi√† globalmente in style.css */
        .terms-checkbox {
            text-align: left;
            font-size: 0.9em;
            margin-top: 0.5rem;
            margin-bottom: 1rem; /* Default da style.css √® .mb-3 */
            color: var(--gray-dark);
        }
        .terms-checkbox input[type="checkbox"] {
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        .terms-checkbox label {
            font-weight: normal;
            color: var(--gray-dark);
        }
        .terms-checkbox a {
            color: var(--primary);
            text-decoration: underline;
        }
    </style>
</head>
<body>

<header class="navbar-container" id="navbarContainer">
    <nav class="navbar">
        <div class="logo">
            <a href="index.html">
                <span class="emoji">üèîÔ∏è</span>
                <h2>Eremo Frate Francesco</h2>
            </a>
        </div>
        <div class="menu">
            <a href="eventiincorso.html">Calendario attivit√†</a>
            <a href="eventipassati.html">Archivio attivit√†</a>
            <span class="separator">|</span>
            <a href="incontrisullaparola.html" class="active">Incontri sulla parola</a>
            <span class="separator">|</span>
            <a href="dovesiamo.html">Dove siamo</a>
            <a href="contatti.html">Contatti</a>
        </div>
        <div class="right-menu">
            <button id="login-btn" class="login-btn">Accedi</button>
            <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="eventiincorso.html" onclick="closeMobileMenu()">Calendario attivit√†</a>
        <a href="eventipassati.html" onclick="closeMobileMenu()">Archivio attivit√†</a>
        <a href="incontrisullaparola.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
        <a href="dovesiamo.html" onclick="closeMobileMenu()">Dove siamo</a>
        <a href="contatti.html" onclick="closeMobileMenu()">Contatti</a>
        <a href="#" id="login-btn-mobile" onclick="openLoginPopup(); closeMobileMenu();">Accedi</a>
    </div>
</header>

<main>
    <section class="page-header section-padding" style="background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.4)), url('https://picsum.photos/1920/1080?random=bible,study') center/cover; color: white; text-align: center; border-radius: 0 0 var(--border-radius-large) var(--border-radius-large); margin-bottom: 3rem;">
        <div class="container">
            <h1 style="color: white;">Incontri sulla Parola</h1>
            <p style="font-size: 1.2rem; opacity: 0.9;">Un cammino settimanale di scoperta e crescita spirituale attraverso la Lectio Divina.</p>
        </div>
    </section>

    <div class="container">
        <section class="chi-siamo-section section-padding">
            <div class="chi-siamo-image-container">
                <img src="https://picsum.photos/600/400?random=group,reading,discussion" alt="Gruppo di studio biblico" class="chi-siamo-image">
            </div>
            <div class="chi-siamo-content">
                <h2>Cosa sono gli Incontri sulla Parola?</h2>
                <p>Gli Incontri sulla Parola sono un appuntamento settimanale dedicato all'ascolto, alla meditazione e alla condivisione della Parola di Dio, secondo il metodo della <strong>Lectio Divina</strong>. √à un'opportunit√† per nutrire la propria fede, approfondire la comprensione delle Scritture e crescere insieme come comunit√†.</p>
                <p>Non si tratta di uno studio accademico, ma di un'esperienza spirituale che cerca di far risuonare la Parola nella vita di ciascuno, in un clima di ascolto reciproco e di preghiera.</p>
            </div>
        </section>

        <section class="section-padding" style="background-color: var(--light); border-radius: var(--border-radius-large);">
            <h2 class="text-center mb-4" style="color: var(--secondary);">Informazioni Pratiche</h2>
            <div class="card-grid">
                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-calendar-alt" style="margin-right: 8px; color: var(--secondary);"></i> Quando</h3>
                        <p>Ogni Mercoled√¨ sera<br>Orario: 20:30 - 22:00</p>
                        <p><strong>Prossimo incontro: <span id="next-meeting-date">[Data prossimo mercoled√¨]</span></strong></p>
                    </div>
                </div>

                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-map-marker-alt" style="margin-right: 8px; color: var(--secondary);"></i> Dove</h3>
                        <p>Presso la sala incontri dell'Eremo Frate Francesco<br>Via San Vito, Nembro (BG)</p>
                        <a href="dovesiamo.html" class="card-btn card-btn-secondary" style="margin-top: 1rem;">Come raggiungerci</a>
                    </div>
                </div>

                <div class="card info-card">
                    <div class="card-content">
                        <h3><i class="fas fa-users" style="margin-right: 8px; color: var(--secondary);"></i> A chi √® rivolto</h3>
                        <p>L'invito √® aperto a tutti: giovani, adulti, famiglie. Non √® richiesta alcuna preparazione teologica specifica, solo il desiderio di mettersi in ascolto della Parola.</p>
                    </div>
                </div>
            </div>
        </section>


        <section class="chi-siamo-section reverse section-padding">
            <div class="chi-siamo-image-container">
                <img src="https://picsum.photos/600/400?random=community,prayer,circle" alt="Condivisione comunitaria" class="chi-siamo-image">
            </div>
            <div class="chi-siamo-content">
                <h2>Un Approccio Comunitario alla Lectio Divina</h2>
                <p>La Lectio Divina √® un metodo antico di preghiera e lettura della Bibbia che si articola in quattro momenti: <strong>Lectio</strong> (lettura), <strong>Meditatio</strong> (meditazione), <strong>Oratio</strong> (preghiera) e <strong>Contemplatio</strong> (contemplazione).</p>
                <p>Durante i nostri incontri, applichiamo questo metodo in modo comunitario. Dopo la lettura attenta di un brano biblico, ognuno √® invitato a meditare su ci√≤ che lo ha colpito, a trasformarlo in preghiera personale e, infine, a condividere liberamente (senza obbligo) le proprie riflessioni con il gruppo, arricchendosi reciprocamente.</p>
            </div>
        </section>

        <section class="section-padding">
            <h2 class="text-center mb-4">I Passi della Lectio Comunitaria</h2>
            <div class="card-grid">
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">1</div>
                        <h3>Lectio (Lettura)</h3>
                        <p>Lettura attenta e ripetuta del brano biblico scelto per l'incontro, cercando di cogliere il messaggio letterale.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">2</div>
                        <h3>Meditatio (Meditazione)</h3>
                        <p>Riflessione personale: cosa dice a me, oggi, questa Parola? Quali sentimenti o pensieri suscita?</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content text-center">
                        <div style="font-size: 2rem; color: var(--accent); margin-bottom: 1rem;">3</div>
                        <h3>Oratio (Preghiera)</h3>
                        <p>Risposta personale alla Parola attraverso la preghiera: lode, ringraziamento, richiesta, supplica.</p>
                    </div>
                </div>
            </div>
        </section>

    </div>
</main>

<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
    <button class="close-popup" id="closePopup" aria-label="Chiudi popup">&times;</button>
    <div class="login-tabs">
        <div class="login-tab active" data-tab="login">Accedi</div>
        <div class="login-tab" data-tab="register">Registrati</div>
    </div>
    <form class="login-form active" id="loginForm" method="POST">
        <div class="form-group mb-3">
            <label for="login-email">Email</label>
            <input type="email" id="login-email" name="login-email" class="form-control" required autocomplete="email">
        </div>
        <div class="form-group mb-3">
            <label for="login-password">Password</label>
            <input type="password" id="login-password" name="login-password" class="form-control" required autocomplete="current-password">
        </div>
        <div id="login-error-message" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
        <div class="form-actions">
            <button type="submit" class="btn-popup">Accedi</button>
        </div>
    </form>
    <form class="login-form" id="registerForm" method="POST">
        <div class="form-group mb-3">
            <label for="register-name">Nome</label>
            <input type="text" id="register-name" name="register-name" class="form-control" required autocomplete="given-name">
        </div>
        <div class="form-group mb-3">
            <label for="register-surname">Cognome</label>
            <input type="text" id="register-surname" name="register-surname" class="form-control" required autocomplete="family-name">
        </div>
        <div class="form-group mb-3">
            <label for="register-email">Email</label>
            <input type="email" id="register-email" name="register-email" class="form-control" required autocomplete="email">
        </div>
        <div class="form-group mb-3">
            <label for="register-password">Password</label>
            <input type="password" id="register-password" name="register-password" class="form-control" required minlength="8" autocomplete="new-password">
            <small>Minimo 8 caratteri.</small>
        </div>
        <div class="terms-checkbox mb-3">
            <input type="checkbox" id="register-terms" name="register-terms" required>
            <label for="register-terms">Accetto i <a href="termini.html" target="_blank">termini e condizioni</a></label>
        </div>
        <div id="register-error-message" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
        <div class="form-actions">
            <button type="submit" class="btn-popup">Registrati</button>
        </div>
    </form>
</div>

<footer>
    <p>¬© <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia</p>
</footer>

<script>
    const defaultUserIconPath = '/uploads/icons/default_user.png';

    // --- Navbar Scroll Logic ---
    let lastScroll = 0;
    const navbarContainer = document.getElementById('navbarContainer');
    if (navbarContainer) {
        window.addEventListener('scroll', function() {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            if (currentScroll <= 50) {
                navbarContainer.classList.remove('hidden');
                lastScroll = 0;
                return;
            }
            if (currentScroll > lastScroll && !navbarContainer.classList.contains('hidden')) {
                navbarContainer.classList.add('hidden');
            } else if (currentScroll < lastScroll && navbarContainer.classList.contains('hidden')) {
                navbarContainer.classList.remove('hidden');
            }
            lastScroll = currentScroll;
        }, false);
    }

    // --- Mobile Menu Logic ---
    const mobileMenu = document.getElementById("mobileMenu");
    const hamburger = document.querySelector(".navbar .hamburger");

    function toggleMobileMenu() {
        if (mobileMenu && hamburger) {
            const isOpen = mobileMenu.classList.toggle("open");
            hamburger.classList.toggle("open"); // Aggiorna stato hamburger
            hamburger.setAttribute("aria-expanded", String(isOpen));
            document.body.style.overflow = isOpen ? 'hidden' : '';
        }
    }
    function closeMobileMenu() { // Chiamata dai link del menu
        if (mobileMenu && hamburger && mobileMenu.classList.contains("open")) {
            mobileMenu.classList.remove("open");
            hamburger.classList.remove("open"); // Aggiorna stato hamburger
            hamburger.setAttribute("aria-expanded", "false");
            document.body.style.overflow = '';
        }
    }
    // Rimosso: if (hamburger) hamburger.addEventListener("click", toggleMobileMenu); // L'onclick nell'HTML √® sufficiente

    document.querySelectorAll("#mobileMenu a").forEach((link) => {
        if (link.id !== 'login-btn-mobile') {
            link.addEventListener("click", closeMobileMenu);
        }
        // Per login-btn-mobile, l'onclick nell'HTML gestisce openLoginPopup() e closeMobileMenu()
    });
    document.addEventListener('click', function(event) {
        if (mobileMenu && mobileMenu.classList.contains('open') &&
            hamburger && !mobileMenu.contains(event.target) &&
            !hamburger.contains(event.target)) {
            closeMobileMenu(); // Chiama la funzione corretta
        }
    });

    // --- Login Popup Logic ---
    const loginBtn = document.getElementById('login-btn');
    const loginBtnMobile = document.getElementById('login-btn-mobile'); // Gi√† gestito dall'HTML
    const loginOverlay = document.getElementById('loginOverlay');
    const loginPopup = document.getElementById('loginPopup');
    const closePopupBtn = document.getElementById('closePopup');
    const loginTabs = document.querySelectorAll('.login-tab');
    const loginForms = document.querySelectorAll('.login-popup .login-form');
    const loginErrorMessage = document.getElementById('login-error-message');
    const registerErrorMessage = document.getElementById('register-error-message');

    function openLoginPopup() {
        if (loginOverlay) loginOverlay.classList.add('active');
        if (loginPopup) loginPopup.classList.add('active');
        document.body.style.overflow = 'hidden';
        resetFormErrors(); // Chiama resetFormErrors
        const activeForm = loginPopup?.querySelector(".login-form.active");
        activeForm?.querySelector('input:not([type="hidden"])')?.focus();
    }

    function closeLoginPopup() {
        if (loginOverlay) loginOverlay.classList.remove('active');
        if (loginPopup) loginPopup.classList.remove('active');
        document.body.style.overflow = '';
        resetFormErrors(); // Chiama resetFormErrors
    }

    function resetFormErrors() { // Funzione unificata
        loginForms.forEach(form => {
            form.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border'));
        });
        if (loginErrorMessage) loginErrorMessage.style.display = 'none';
        if (registerErrorMessage) registerErrorMessage.style.display = 'none';
    }

    if (loginBtn) {
        loginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openLoginPopup();
        });
    }
    // loginBtnMobile ha gi√† onclick="openLoginPopup(); closeMobileMenu();"

    if(closePopupBtn) { closePopupBtn.addEventListener('click', closeLoginPopup); }
    if(loginOverlay) {
        loginOverlay.addEventListener('click', (e) => {
            if (e.target === loginOverlay) closeLoginPopup();
        });
    }

    loginTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            loginTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loginForms.forEach(form => {
                form.classList.remove('active');
                if (form.id === `${tabId}Form`) {
                    form.classList.add('active');
                    form.querySelector('input:not([type="hidden"])')?.focus();
                }
            });
            resetFormErrors(); // Chiama resetFormErrors al cambio tab
        });
    });

    // --- Gestione Invio Form con Fetch API ---
    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const loginButton = e.target.querySelector('button[type="submit"]');
        const originalButtonText = loginButton.textContent;
        loginButton.disabled = true;
        loginButton.innerHTML = 'Accesso... <div class="spinner-mini-light"></div>';

        const emailInput = document.getElementById('login-email');
        const passwordInput = document.getElementById('login-password');
        emailInput.classList.remove('error-border');
        passwordInput.classList.remove('error-border');
        if(loginErrorMessage) loginErrorMessage.style.display = 'none';

        try {
            const response = await fetch('login.php', {
                method: 'POST',
                body: new FormData(e.target)
            });

            if (!response.ok) {
                let errorData = { message: `Errore HTTP: ${response.status}` };
                try { errorData = await response.json(); } catch (e) { /* Ignora */ }
                throw new Error(errorData.message || `Errore HTTP: ${response.status}`);
            }
            const result = await response.json();

            if (result.success) {
                const userDataToStore = {
                    nome: result.nome,
                    email: result.email,
                    iconPath: defaultUserIconPath
                };
                localStorage.setItem('userDataEFF', JSON.stringify(userDataToStore));
                closeLoginPopup();
                window.location.href = result.is_admin ? 'indexadmin.html' : 'incontrisullaparolaaccesso.html'; // <<< REINDIRIZZAMENTO CORRETTO
            } else {
                emailInput.classList.add('error-border');
                passwordInput.classList.add('error-border');
                if(loginErrorMessage) {
                    loginErrorMessage.textContent = result.message || "Credenziali non valide.";
                    loginErrorMessage.style.display = 'block';
                } else {
                    alert(result.message || "Credenziali non valide.");
                }
            }
        } catch (error) {
            emailInput.classList.add('error-border');
            passwordInput.classList.add('error-border');
            if(loginErrorMessage) {
                loginErrorMessage.textContent = "Errore di connessione o risposta non valida.";
                loginErrorMessage.style.display = 'block';
            } else {
                alert("Errore di connessione o risposta non valida dal server.");
            }
            console.error("Errore login:", error);
        } finally {
            loginButton.disabled = false;
            loginButton.innerHTML = originalButtonText;
        }
    });

    document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const registerButton = e.target.querySelector('button[type="submit"]');
        const originalButtonText = registerButton.textContent;
        registerButton.disabled = true;
        registerButton.innerHTML = 'Registrazione... <div class="spinner-mini-light"></div>'; // Aggiunto spinner
        if(registerErrorMessage) registerErrorMessage.style.display = 'none';
        e.target.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border'));

        try {
            const response = await fetch('registrati.php', {
                method: 'POST',
                body: new FormData(e.target)
            });

            if (!response.ok) {
                let errorMsg = `Errore HTTP: ${response.status} ${response.statusText}`;
                try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; }
                catch(err) { /* Ignora */ }
                throw new Error(errorMsg);
            }
            const result = await response.json();

            if (result.success) {
                alert(result.message || "Registrazione completata! Ora puoi effettuare il login.");
                const loginTabButton = document.querySelector('.login-tab[data-tab="login"]');
                if(loginTabButton) loginTabButton.click();

                const loginEmailInput = document.getElementById('login-email');
                const registerEmailInput = document.getElementById('register-email');
                if(loginEmailInput && registerEmailInput) {
                    loginEmailInput.value = registerEmailInput.value;
                }
                e.target.reset();
            } else {
                if(registerErrorMessage) {
                    registerErrorMessage.textContent = result.message || "Errore durante la registrazione.";
                    registerErrorMessage.style.display = 'block';
                } else {
                    alert("Errore Registrazione: " + (result.message || "Si √® verificato un errore."));
                }
                if (result.errors) { // Gestione errori specifici per campo (se il backend li fornisce)
                    for (const fieldNameFromError in result.errors) {
                        const inputElement = e.target.elements[fieldNameFromError] || document.getElementById(`register-${fieldNameFromError}`);
                        if (inputElement) {
                            inputElement.classList.add('error-border');
                        }
                    }
                }
            }
        } catch (error) {
            if(registerErrorMessage) {
                registerErrorMessage.textContent = "Errore: " + error.message;
                registerErrorMessage.style.display = 'block';
            } else {
                alert("Errore durante la registrazione: " + error.message);
            }
            console.error("Dettaglio errore registrazione:", error);
        } finally {
            registerButton.disabled = false;
            registerButton.innerHTML = originalButtonText;
        }
    });

    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && loginPopup && loginPopup.classList.contains('active')) {
            closeLoginPopup();
        }
    });

    // Logica specifica pagina (invariata)
    function getNextWednesday() {
        const today = new Date();
        const currentDay = today.getDay();
        var daysUntilWednesday = (3 - currentDay + 7) % 7;
        if (daysUntilWednesday === 0 && today.getHours() >= 22) {
            daysUntilWednesday = 7;
        }
        const nextWednesday = new Date(today);
        nextWednesday.setDate(today.getDate() + daysUntilWednesday);
        return nextWednesday;
    }

    function formatDateItalian(date) {
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        return date.toLocaleDateString('it-IT', options);
    }

    document.addEventListener('DOMContentLoaded', function() {
        const nextMeetingDateElement = document.getElementById('next-meeting-date');
        if (nextMeetingDateElement) {
            nextMeetingDateElement.textContent = formatDateItalian(getNextWednesday());
        }

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = 1;
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.chi-siamo-section, .card').forEach(el => {
            el.style.opacity = 0;
            el.style.transform = 'translateY(20px)';
            el.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
            observer.observe(el);
        });

        const currentYearEl = document.getElementById('currentYear');
        if (currentYearEl) {
            currentYearEl.textContent = new Date().getFullYear();
        }
    });
</script>

</body>
</html>