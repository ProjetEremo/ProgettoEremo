<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/logo.png" type="image/x-icon" />
  <title>Calendario Attivit√† - Eremo Frate Francesco</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@300;400;500;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Stili popup login/registrazione (da eventiincorso.html) */
    .login-popup input.form-control {
      transition: border-color 0.3s ease;
      border: 1px solid #ced4da;
      background-color: white !important;
      box-shadow: none !important;
      outline: none !important;
    }
    .login-popup input.error-border { border-color: var(--danger, red) !important; }
    .login-popup input:-webkit-autofill,
    .login-popup input:-webkit-autofill:hover,
    .login-popup input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0px 1000px white inset !important;
      -webkit-text-fill-color: var(--dark, #333) !important;
    }

    /* Stili per form message, spinner, avatar (da eventiincorso.html) */
    .form-message { display: none; padding: 0.75rem; border-radius: 8px; font-size: 0.9em; margin-top: 0.5em; text-align: left; }
    .form-message.error { color: var(--danger, red); background-color: rgba(var(--danger-rgb, 231, 76, 60), 0.1); border: 1px solid rgba(var(--danger-rgb, 231, 76, 60), 0.3); }
    .form-message.success { color: var(--success, green); background-color: rgba(var(--success-rgb, 46, 204, 113), 0.1); border: 1px solid rgba(var(--success-rgb, 46, 204, 113), 0.3); }
    .spinner-mini-light, .spinner-mini { display: inline-block; width: 1em; height: 1em; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; }
    .spinner-mini-light { border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; margin-left: 5px; }
    .spinner-mini { border: 2px solid rgba(0, 0, 0, 0.2); border-top-color: var(--primary); margin-right: 5px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .user-avatar img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; vertical-align: middle; }
    .terms-checkbox { text-align: left; font-size: 0.9em; margin-top: 0.5rem; margin-bottom: 1rem; color: var(--gray-dark); }
    .terms-checkbox input[type="checkbox"] { margin-right: 0.5rem; vertical-align: middle; }
    .terms-checkbox label { font-weight: normal; color: var(--gray-dark); }
    .terms-checkbox a { color: var(--primary); text-decoration: underline; }
    #eventiGridContainer .no-events, #eventiGridContainer .error-message { grid-column: 1 / -1; text-align: center; padding: 2rem; font-size: 1.1rem; }

    /* Stili per il popup evento (ispirati da dashboard.html e admin) */
    .event-popup-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6); z-index: 999;
      display: none;
      opacity: 0; transition: opacity 0.3s ease;
    }
    .event-popup-overlay.active { display: flex; opacity: 1; align-items: center; justify-content: center;}

    .event-popup {
      background-color: var(--white); color: var(--dark);
      padding: 2rem; border-radius: var(--border-radius-large);
      width: 90%; max-width: 650px;
      box-shadow: var(--shadow-strong);
      position: relative; max-height: 90vh; overflow-y: auto;
      transform: scale(0.95); opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .event-popup-overlay.active .event-popup { transform: scale(1); opacity: 1; }

    .event-popup h2 { color: var(--primary); margin-top: 0; margin-bottom: 1.5rem; font-size: 1.8rem; text-align: center; }
    .event-popup .form-group { margin-bottom: 1rem; }
    .event-popup .form-group label { display: block; font-weight: 500; margin-bottom: 0.4rem; color: var(--primary-dark); font-size:0.95rem; }
    .event-popup .form-control {
      width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--gray-medium);
      border-radius: 8px; font-size: 1rem; box-sizing: border-box;
      transition: border-color 0.2s ease;
    }
    .event-popup .form-control:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2); }
    .event-popup textarea.form-control { min-height: 80px; resize: vertical; }
    .event-popup .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .event-popup .form-check-group { display: flex; align-items: center; margin-bottom: 1rem; }
    .event-popup .form-check-group input[type="checkbox"] { margin-right: 0.5rem; width: auto; height: auto; transform: scale(1.1); }
    .event-popup .form-check-group label { font-weight: normal; font-size: 0.95rem; color: var(--dark); }
    .event-popup .form-actions { text-align: right; margin-top: 1.5rem; }
    .event-popup .btn-popup {
      padding: 0.8rem 1.8rem; background-color: var(--secondary); color: white;
      border: none; border-radius: 8px; cursor: pointer;
      font-size: 1rem; font-weight: 500; transition: var(--transition-medium);
    }
    .event-popup .btn-popup:hover { background-color: var(--primary); }
    .event-popup .close-popup {
      position: absolute; top: 15px; right: 20px;
      background: none; border: none; font-size: 2rem; color: var(--gray-dark);
      cursor: pointer; line-height: 1; padding: 0;
    }
    .event-popup .close-popup:hover { color: var(--primary); }
    .event-popup .form-message { margin-top: 1rem; margin-bottom: 0; }
    .event-popup small { font-size: 0.85em; color: var(--gray-dark); display: block; margin-top: 0.2rem; }
    #current-event-image-preview { max-width:100px; max-height:100px; display:none; margin-top:5px; border-radius: 4px; border: 1px solid var(--gray-light); }
    #current-event-flyer-preview a { color: var(--primary); text-decoration: underline; }
    #current-event-flyer-preview a:hover { color: var(--accent); }

    /* Stile per il bottone "Nuovo Evento" (FAB) */
    .add-event-btn-container {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 990;
      display: none;
    }
    .add-event-btn {
      background-color: var(--secondary); color: white;
      border: none; border-radius: 50%;
      width: 60px; height: 60px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      font-size: 28px; line-height: 60px; text-align: center;
      cursor: pointer; transition: all 0.3s ease;
      display: flex; align-items: center; justify-content: center;
    }
    .add-event-btn:hover { background-color: var(--primary); transform: scale(1.1); }
    .add-event-btn .plus-icon { display: block; }
    .add-event-btn .btn-label { display: none; }

    /* Stili per card admin */
    .card.admin-card .card-actions {
      margin-top: 1rem;
      border-top: 1px solid var(--gray-light);
      padding-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    .card.admin-card .card-actions .card-btn {
      flex-grow: 1;
    }
    .card.admin-card .btn-delete {
      background-color: var(--danger) !important;
      color: white !important;
    }
    .card.admin-card .btn-delete:hover {
      background-color: darkred !important;
    }
    .status-prenotabile { color: var(--success, green); font-weight: bold; }
    .status-non-prenotabile { color: var(--danger, red); font-weight: bold; }

    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(255, 255, 255, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      visibility: hidden; opacity: 0;
      transition: opacity 0.3s, visibility 0.3s;
      border-radius: inherit;
    }
    .loading-overlay.visible { visibility: visible; opacity: 1; }
    .loading-overlay .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 36px; height: 36px;
      border-radius: 50%;
      border-left-color: var(--primary);
      animation: spin 1s ease infinite;
      margin-bottom: 0.8rem;
    }
    .loading-overlay p {
      font-size: 1.1em;
      color: var(--dark);
      font-weight: 500;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

  </style>
</head>

<body>
<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo"><a href="index.html"><span class="emoji">üèîÔ∏è</span><h2 id="navbar-title">Eremo Frate Francesco</h2></a></div>
    <div class="menu" id="main-menu">
      <a href="eventiincorso.html" class="active" id="nav-calendario">Calendario attivit√†</a>
      <a href="eventipassati.html" id="nav-archivio">Archivio attivit√†</a>
      <span class="separator">|</span>
      <a href="incontrisullaparola.html" id="nav-incontri">Incontri sulla parola</a>
      <span class="separator">|</span>
      <a href="dovesiamo.html" id="nav-dovesiamo">Dove siamo</a>
      <a href="contatti.html" id="nav-contatti">Contatti</a>
    </div>
    <div class="right-menu">
      <button id="login-btn-desktop" class="login-btn">Accedi</button>
      <div class="user-dropdown" id="userDropdownContainer" style="display: none;">
        <button class="user-btn" id="userBtnTrigger" aria-haspopup="true" aria-expanded="false">
          <span class="user-avatar" id="navbar-avatar"><img src="uploads/icons/default_user.png" alt="User Icon"></span>
          <span class="user-name" id="navbar-username">Utente</span><span class="dropdown-arrow">‚ñº</span>
        </button>
        <div class="dropdown-menu" id="userDropdownMenu">
          <a href="areapersonale.html" id="nav-profilo">Il mio profilo</a>
          <a href="areapersonale.html#prenotazioni" id="nav-mie-prenotazioni">Le mie prenotazioni</a>
          <a href="dashboard.html" id="nav-dashboard" style="display: none;">Dashboard Admin</a>
          <a href="#" id="logout-link-desktop">Esci</a>
        </div>
      </div>
      <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu" aria-expanded="false">‚ò∞</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorso.html" id="mobile-nav-calendario">Calendario attivit√†</a>
    <a href="eventipassati.html" id="mobile-nav-archivio">Archivio attivit√†</a>
    <a href="incontrisullaparola.html" id="mobile-nav-incontri">Incontri sulla parola</a>
    <a href="dovesiamo.html" id="mobile-nav-dovesiamo">Dove siamo</a>
    <a href="contatti.html" id="mobile-nav-contatti">Contatti</a>
    <hr id="mobile-menu-separator" style="border-color: rgba(255,255,255,0.1); display:none;">
    <a href="#" id="login-btn-mobile">Accedi</a>
    <a href="areapersonale.html" id="mobile-nav-profilo" style="display: none;">Il mio profilo</a>
    <a href="areapersonale.html#prenotazioni" id="mobile-nav-mie-prenotazioni" style="display: none;">Le mie prenotazioni</a>
    <a href="dashboard.html" id="mobile-nav-dashboard" style="display: none;">Dashboard Admin</a>
    <a href="#" id="mobile-logout-link" style="display: none;">Esci</a>
  </div>
</header>

<main>
  <div class="container section-padding">
    <h1 id="pageMainTitle">Calendario Attivit√†</h1>
    <div id="eventiGridContainer">
      <div id="loadingIndicator" class="loading-overlay">
        <div class="spinner"></div>
        <p>Sto caricando gli eventi...</p>
      </div>
      <div class="card-grid" id="eventiGrid">
      </div>
    </div>
  </div>
  <div class="add-event-btn-container" id="addEventBtnContainer">
    <button class="add-event-btn" id="addEventBtnAdmin">
      <span class="plus-icon">+</span>
      <span class="btn-label">Nuovo Evento</span>
    </button>
  </div>
</main>

<div class="volantino-morph-overlay" id="volantinoMorphOverlay"></div>

<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
  <button class="close-popup" id="closeLoginPopupBtn" aria-label="Chiudi popup">&times;</button>
  <div class="login-tabs">
    <div class="login-tab active" data-tab="login">Accedi</div>
    <div class="login-tab" data-tab="register">Registrati</div>
  </div>
  <form class="login-form active" id="loginForm" method="POST">
    <div class="form-group mb-3"><label for="login-email">Email</label><input type="email" id="login-email" name="login-email" class="form-control" required autocomplete="email"></div>
    <div class="form-group mb-3"><label for="login-password">Password</label><input type="password" id="login-password" name="login-password" class="form-control" required autocomplete="current-password"></div>
    <div style="text-align: right; margin-top: -10px; margin-bottom: 10px;">
      <a href="#" id="forgotPasswordLink" style="font-size: 0.9em; color: var(--primary);">Password dimenticata?</a>
    </div>
    <div id="login-error-message" class="form-message error"></div>
    <div class="form-actions"><button type="submit" class="btn-popup">Accedi</button></div>
  </form>
  <form class="login-form" id="registerForm" method="POST">
    <div class="form-group mb-3"><label for="register-name">Nome</label><input type="text" id="register-name" name="register-name" class="form-control" required autocomplete="given-name"></div>
    <div class="form-group mb-3"><label for="register-surname">Cognome</label><input type="text" id="register-surname" name="register-surname" class="form-control" required autocomplete="family-name"></div>
    <div class="form-group mb-3"><label for="register-email">Email</label><input type="email" id="register-email" name="register-email" class="form-control" required autocomplete="email"></div>
    <div class="form-group mb-3"><label for="register-password">Password</label><input type="password" id="register-password" name="register-password" class="form-control" required minlength="8" autocomplete="new-password"><small>Minimo 8 caratteri.</small></div>
    <div class="terms-checkbox mb-3"><input type="checkbox" id="register-terms" name="register-terms" required><label for="register-terms">Accetto i <a href="termini.html" target="_blank">termini e condizioni</a></label></div>
    <div id="register-error-message" class="form-message error"></div>
    <div class="form-actions"><button type="submit" class="btn-popup">Registrati</button></div>
  </form>
</div>

<div class="login-popup-overlay" id="forgotPasswordOverlay"></div>
<div class="login-popup" id="forgotPasswordPopup">
  <button class="close-popup" id="closeForgotPasswordPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h3 style="text-align:center; margin-bottom: 1rem; color: var(--primary);">Recupera Password</h3>
  <p style="font-size:0.95em; color:var(--gray-dark); margin-bottom:1.5rem; text-align:left;">Inserisci l'indirizzo email associato al tuo account. Se presente nel nostro sistema, ti invieremo un link per reimpostare la password.</p>
  <form id="forgotPasswordForm" method="POST">
    <div class="form-group mb-3">
      <label for="forgot-email">Email</label>
      <input type="email" id="forgot-email" name="forgot-email" class="form-control" required autocomplete="email">
    </div>
    <div id="forgot-password-message" class="form-message" style="text-align:left;"></div>
    <div class="form-actions">
      <button type="submit" class="btn-popup">Invia link di recupero</button>
    </div>
  </form>
</div>

<div class="booking-popup-overlay" id="bookingPopupOverlay"></div>
<div class="booking-popup" id="bookingPopup">
  <button class="close-popup" id="closeBookingPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h2 id="bookingPopupTitle">Prenota Evento</h2>
  <form id="bookingForm">
    <input type="hidden" id="bookingEventId" name="eventId">
    <div class="form-group">
      <label for="numeroPosti">Numero Partecipanti (max <span id="maxSeatsAllowedBooking">5</span>)</label>
      <input type="number" id="numeroPosti" name="numeroPosti" class="form-control" min="1" value="1" required>
      <small id="infoPostiPrenotabili" style="display: block; margin-top: 0.3rem; font-size: 0.85rem;"></small>
    </div>
    <div id="participantFieldsContainer" class="participant-fields-container"></div>
    <div id="bookingResponseMessage" class="form-message"></div>
    <div class="form-actions"><button type="submit" class="btn-popup">Conferma Prenotazione</button></div>
  </form>
</div>

<div class="booking-popup-overlay" id="waitlistPopupOverlay"></div>
<div class="booking-popup" id="waitlistPopup">
  <button class="close-popup" id="closeWaitlistPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h2 id="waitlistPopupTitle">Entra in Lista d'Attesa</h2>
  <form id="waitlistForm">
    <input type="hidden" id="waitlistEventId" name="eventId">
    <p id="waitlistEventInfo" style="text-align:center; margin-bottom:1rem; font-size: 1.1rem; color: var(--primary);"></p>
    <div class="form-group">
      <label for="waitlistNumeroPosti">Numero posti richiesti (max <span id="maxSeatsAllowedWaitlist">5</span>)</label>
      <input type="number" id="waitlistNumeroPosti" name="numeroPosti" class="form-control" min="1" value="1" required>
      <small id="infoPostiCoda" style="display: block; margin-top: 0.3rem; font-size: 0.85rem;"></small>
    </div>
    <div id="waitlistResponseMessage" class="form-message"></div>
    <div class="form-actions"><button type="submit" class="btn-popup">Mettiti in Coda</button></div>
  </form>
</div>

<div class="event-popup-overlay" id="adminEventPopupOverlay">
  <div class="event-popup" id="adminEventPopup">
    <button class="close-popup" id="closeAdminEventPopupBtn" aria-label="Chiudi popup">&times;</button>
    <h2 id="adminEventPopupTitle">Aggiungi Nuovo Evento</h2>
    <form id="adminEventForm" method="POST" enctype="multipart/form-data">
      <input type="hidden" id="admin-event-id" name="event-id">
      <div class="form-group"> <label for="admin-event-title">Titolo Evento*</label> <input type="text" id="admin-event-title" name="event-title" class="form-control" required> </div>
      <div class="form-grid">
        <div class="form-group"> <label for="admin-event-date">Data Inizio*</label> <input type="date" id="admin-event-date" name="event-date" class="form-control" required> </div>
        <div class="form-group"> <label for="admin-event-time">Orario/Durata</label> <input type="text" id="admin-event-time" name="event-time" class="form-control" placeholder="es. 18:00-19:30 o 2 giorni"> </div>
      </div>
      <div class="form-group"> <label for="admin-event-short-desc">Descrizione Breve*</label> <textarea id="admin-event-short-desc" name="event-short-desc" class="form-control" rows="3" required maxlength="200"></textarea> </div>
      <div class="form-group"> <label for="admin-event-long-desc">Descrizione Estesa</label> <textarea id="admin-event-long-desc" name="event-long-desc" class="form-control" rows="5"></textarea> </div>
      <div class="form-grid">
        <div class="form-group"> <label for="admin-event-prefix">Prefisso Relatore</label> <input type="text" id="admin-event-prefix" name="event-prefix" class="form-control" placeholder="Default: Relatore"> </div>
        <div class="form-group"> <label for="admin-event-speaker">Nome Relatore*</label> <input type="text" id="admin-event-speaker" name="event-speaker" class="form-control" required> </div>
      </div>
      <div class="form-grid">
        <div class="form-group"> <label for="admin-event-association">Associazione</label> <input type="text" id="admin-event-association" name="event-association" class="form-control"> </div>
        <div class="form-group"> <label for="admin-event-seats">Posti Disponibili*</label> <input type="number" id="admin-event-seats" name="event-seats" class="form-control" required min="0"> </div>
      </div>
      <div class="form-group">
        <label for="admin-event-image">Immagine Copertina</label> <input type="file" id="admin-event-image" name="event-image" class="form-control" accept="image/*">
        <small>Lascia vuoto se non vuoi modificare l'immagine corrente.</small>
        <img id="current-event-image-preview" src="#" alt="Anteprima copertina">
      </div>
      <div class="form-group">
        <label for="admin-event-flyer">Volantino (PDF/Immagine)</label> <input type="file" id="admin-event-flyer" name="event-flyer" class="form-control" accept="image/*,application/pdf">
        <small>Lascia vuoto se non vuoi modificare il volantino corrente.</small>
        <div id="current-event-flyer-preview"></div>
      </div>
      <div class="form-check-group"> <input type="checkbox" id="admin-event-booking" name="event-booking" checked> <label for="admin-event-booking">Prenotazioni aperte</label> </div>
      <div class="form-check-group"> <input type="checkbox" id="admin-event-voluntary" name="event-voluntary"> <label for="admin-event-voluntary">Costo su base volontaria (offerta libera)</label> </div>
      <div class="form-group" id="admin-event-price-container"> <label for="admin-event-price">Prezzo (‚Ç¨)</label> <input type="number" id="admin-event-price" name="event-price" class="form-control" min="0" step="0.01" placeholder="Es. 10.00"> </div>
      <div id="adminEventFormMessage" class="form-message"></div>
      <div class="form-actions"> <button type="submit" class="btn-popup">Salva Evento</button> </div>
    </form>
  </div>
</div>


<footer>
  <p>¬© <span id="currentYear"></span> Eremo Frate Francesco ODV. Tutti i diritti riservati.</p>
</footer>

<script>
  // === INIZIO SCRIPT UNIFICATO PER EVENTIINCORSO.HTML ===
  const defaultUserIconPath = 'uploads/icons/default_user.png';
  let currentUserData = null;
  let volantinoMorphOverlay = null;
  let morphingCard = null;
  let currentEventsData = [];

  function gebi(id) { return document.getElementById(id); }

  function loadUserData() {
    const uds = localStorage.getItem('userDataEFF');
    if (uds) {
      try {
        currentUserData = JSON.parse(uds);
        if (!currentUserData || typeof currentUserData.email === 'undefined') {
          currentUserData = null; localStorage.removeItem('userDataEFF');
        }
      } catch (e) {
        console.error("Errore parsing userDataEFF:", e);
        currentUserData = null; localStorage.removeItem('userDataEFF');
      }
    } else {
      currentUserData = null;
    }
  }

  function updateNavbarUI() {
    const el = {
      loginBtnDesktop: gebi('login-btn-desktop'), loginBtnMobile: gebi('login-btn-mobile'),
      userDropdownContainer: gebi('userDropdownContainer'), navbarUsername: gebi('navbar-username'),
      navbarAvatarImg: document.querySelector('#navbar-avatar img'), navDashboard: gebi('nav-dashboard'),
      mobileNavDashboard: gebi('mobile-nav-dashboard'), mobileNavProfilo: gebi('mobile-nav-profilo'),
      mobileNavMiePrenotazioni: gebi('mobile-nav-mie-prenotazioni'), mobileLogoutLink: gebi('mobile-logout-link'),
      mobileMenuSeparator: gebi('mobile-menu-separator'), navbarTitle: gebi('navbar-title'),
      pageMainTitle: gebi('pageMainTitle'),
      addEventBtnContainer: gebi('addEventBtnContainer')
    };

    if(el.loginBtnDesktop) el.loginBtnDesktop.style.display = 'none';
    if(el.loginBtnMobile) el.loginBtnMobile.style.display = 'none';
    if(el.userDropdownContainer) el.userDropdownContainer.style.display = 'none';
    if(el.navDashboard) el.navDashboard.style.display = 'none';
    if(el.mobileNavDashboard) el.mobileNavDashboard.style.display = 'none';
    if(el.mobileNavProfilo) el.mobileNavProfilo.style.display = 'none';
    if(el.mobileNavMiePrenotazioni) el.mobileNavMiePrenotazioni.style.display = 'none';
    if(el.mobileLogoutLink) el.mobileLogoutLink.style.display = 'none';
    if(el.mobileMenuSeparator) el.mobileMenuSeparator.style.display = 'none';
    if(el.addEventBtnContainer) el.addEventBtnContainer.style.display = 'none';


    if (currentUserData) {
      if (el.userDropdownContainer) el.userDropdownContainer.style.display = 'inline-block';
      if (el.mobileNavProfilo) el.mobileNavProfilo.style.display = 'block';
      if (el.mobileNavMiePrenotazioni) el.mobileNavMiePrenotazioni.style.display = 'block';
      if (el.mobileLogoutLink) el.mobileLogoutLink.style.display = 'block';
      if (el.mobileMenuSeparator) el.mobileMenuSeparator.style.display = 'block';

      if (el.navbarUsername) el.navbarUsername.textContent = currentUserData.nome || currentUserData.email.split('@')[0];
      if (el.navbarAvatarImg) {
        el.navbarAvatarImg.src = currentUserData.iconPath || defaultUserIconPath;
        el.navbarAvatarImg.alt = `Avatar di ${currentUserData.nome || 'utente'}`;
        el.navbarAvatarImg.onerror = function () { this.src = defaultUserIconPath; };
      }

      if (currentUserData.isAdmin) {
        if (el.navDashboard) el.navDashboard.style.display = 'block';
        if (el.mobileNavDashboard) el.mobileNavDashboard.style.display = 'block';
        if (el.navbarTitle) el.navbarTitle.textContent = "Eremo (Admin)";
        if (el.pageMainTitle) el.pageMainTitle.textContent = "Gestione Calendario Attivit√†";
        if (el.addEventBtnContainer) el.addEventBtnContainer.style.display = 'block';
      } else {
        if (el.navbarTitle) el.navbarTitle.textContent = "Eremo Frate Francesco";
        if (el.pageMainTitle) el.pageMainTitle.textContent = "Calendario Attivit√†";
      }
    } else {
      if (el.loginBtnDesktop) el.loginBtnDesktop.style.display = 'inline-block';
      if (el.loginBtnMobile) el.loginBtnMobile.style.display = 'block';
      if (el.navbarTitle) el.navbarTitle.textContent = "Eremo Frate Francesco";
      if (el.pageMainTitle) el.pageMainTitle.textContent = "Calendario Attivit√†";
    }
  }

  let lastScrollNav = 0; const navbarContainerEl = gebi("navbarContainer"); if (navbarContainerEl) { window.addEventListener("scroll", function () { const cS = window.pageYOffset || document.documentElement.scrollTop; if (cS <= 50) { navbarContainerEl.classList.remove("hidden"); lastScrollNav = 0; return; } if (cS > lastScrollNav && !navbarContainerEl.classList.contains("hidden")) navbarContainerEl.classList.add("hidden"); else if (cS < lastScrollNav && navbarContainerEl.classList.contains("hidden")) navbarContainerEl.classList.remove("hidden"); lastScrollNav = cS <= 0 ? 0 : cS; }, false); }
  const mobileMenuEl = gebi("mobileMenu"); const hamburgerButton = gebi("hamburgerBtn"); function toggleMobileMenu() { if (mobileMenuEl && hamburgerButton) { const iO = mobileMenuEl.classList.toggle("open"); hamburgerButton.setAttribute("aria-expanded", String(iO)); document.body.style.overflow = iO ? "hidden" : ""; } } function closeMobileMenuOnLinkClick() { if (mobileMenuEl && hamburgerButton && mobileMenuEl.classList.contains("open")) { mobileMenuEl.classList.remove("open"); hamburgerButton.setAttribute("aria-expanded", "false"); document.body.style.overflow = ""; } } if (hamburgerButton) hamburgerButton.addEventListener("click", toggleMobileMenu); document.querySelectorAll("#mobileMenu a").forEach(l => { if (l.id !== 'login-btn-mobile' && l.id !== 'mobile-logout-link') l.addEventListener("click", closeMobileMenuOnLinkClick); }); document.addEventListener("click", function (e) { if (mobileMenuEl && mobileMenuEl.classList.contains("open") && hamburgerButton && !mobileMenuEl.contains(e.target) && !hamburgerButton.contains(e.target)) toggleMobileMenu(); });
  const userBtnTriggerEl = gebi('userBtnTrigger'); const userDropdownMenuEl = gebi('userDropdownMenu'); if (userBtnTriggerEl && userDropdownMenuEl) { userBtnTriggerEl.addEventListener('click', function (e) { e.stopPropagation(); const iO = userDropdownMenuEl.style.display === 'block'; userDropdownMenuEl.style.display = iO ? 'none' : 'block'; this.setAttribute('aria-expanded', String(!iO)); }); document.addEventListener('click', function (e) { if (userDropdownMenuEl && userDropdownMenuEl.style.display === 'block' && !userBtnTriggerEl.contains(e.target) && !userDropdownMenuEl.contains(e.target)) { userDropdownMenuEl.style.display = 'none'; userBtnTriggerEl.setAttribute('aria-expanded', 'false'); } }); }
  const loginOverlayEl = gebi('loginOverlay'); const loginPopupEl = gebi('loginPopup'); const closeLoginPopupBtnEl = gebi('closeLoginPopupBtn'); const loginTabsEl = document.querySelectorAll('.login-tab'); const loginFormsEl = document.querySelectorAll('.login-popup .login-form'); const loginFormElement = gebi('loginForm'); const registerFormElement = gebi('registerForm'); const loginErrorMessageElement = gebi('login-error-message'); const registerErrorMessageElement = gebi('register-error-message');
  function openLoginPopup() { if (loginOverlayEl) loginOverlayEl.classList.add('active'); if (loginPopupEl) loginPopupEl.classList.add('active'); document.body.style.overflow = 'hidden'; resetFormErrorsAndMessages(); document.querySelector('.login-tab[data-tab="login"]')?.click(); gebi('login-email')?.focus(); }
  function closeLoginPopup() { if (loginOverlayEl) loginOverlayEl.classList.remove('active'); if (loginPopupEl) loginPopupEl.classList.remove('active'); if (!isAnyPopupActive()) document.body.style.overflow = ''; resetFormErrorsAndMessages(); }
  function resetFormErrorsAndMessages() { loginFormsEl.forEach(f => f.querySelectorAll('.form-control.error-border').forEach(i => i.classList.remove('error-border'))); if (loginErrorMessageElement) loginErrorMessageElement.style.display = 'none'; if (registerErrorMessageElement) registerErrorMessageElement.style.display = 'none'; }
  gebi('login-btn-desktop')?.addEventListener('click', openLoginPopup); gebi('login-btn-mobile')?.addEventListener('click', (e) => { e.preventDefault(); openLoginPopup(); closeMobileMenuOnLinkClick(); });
  if (closeLoginPopupBtnEl) closeLoginPopupBtnEl.addEventListener('click', closeLoginPopup); if (loginOverlayEl) loginOverlayEl.addEventListener('click', (e) => { if (e.target === loginOverlayEl) closeLoginPopup(); });

  loginTabsEl.forEach(t => t.addEventListener('click', () => { const id = t.dataset.tab; loginTabsEl.forEach(tb => tb.classList.remove('active')); t.classList.add('active'); loginFormsEl.forEach(f => { f.classList.remove('active'); if (f.id === `${id}Form`) { f.classList.add('active'); f.querySelector('input:not([type="hidden"])')?.focus(); } }); resetFormErrorsAndMessages(); }));
  loginFormElement?.addEventListener('submit', async (e) => { e.preventDefault(); resetFormErrorsAndMessages(); const b = loginFormElement.querySelector('button[type="submit"]'); const o = b.innerHTML; b.disabled = true; b.innerHTML = 'Accesso...<div class="spinner-mini-light"></div>'; try { const r = await fetch('login.php', { method: 'POST', body: new FormData(loginFormElement) }); const j = await r.json(); if (!r.ok) throw new Error(j.message || `Errore ${r.status}`); if (j.success) { currentUserData = { email: j.email, nome: j.nome, iconPath: j.iconPath || defaultUserIconPath, isAdmin: j.is_admin === true || j.is_admin === 1 }; localStorage.setItem('userDataEFF', JSON.stringify(currentUserData)); updateNavbarUI(); closeLoginPopup(); loadEvents(); const pAction = localStorage.getItem("pending_action_eff"); if (pAction) { localStorage.removeItem("pending_action_eff"); const aD = JSON.parse(pAction); if (aD.action === 'book' && typeof window.openBookingPopup === 'function') window.openBookingPopup(aD.eventId, aD.eventTitle, aD.postiDisp, aD.postiGiaPren); else if (aD.action === 'waitlist' && typeof window.openWaitlistPopup === 'function') window.openWaitlistPopup(aD.eventId, aD.eventTitle, aD.postiGiaPren); } } else { loginFormElement.querySelectorAll('#login-email,#login-password').forEach(el => el.classList.add('error-border')); if (loginErrorMessageElement) { loginErrorMessageElement.textContent = j.message || "Credenziali errate."; loginErrorMessageElement.style.display = 'block'; } } } catch (err) { console.error("Errore login:", err); if (loginErrorMessageElement) { loginErrorMessageElement.textContent = "Errore connessione o server."; loginErrorMessageElement.style.display = 'block'; } } finally { b.disabled = false; b.innerHTML = o; } });
  registerFormElement?.addEventListener('submit', async (e) => { e.preventDefault(); resetFormErrorsAndMessages(); const b = registerFormElement.querySelector('button[type="submit"]'); const o = b.innerHTML; b.disabled = true; b.innerHTML = 'Registrazione...<div class="spinner-mini-light"></div>'; try { const r = await fetch('registrati.php', { method: 'POST', body: new FormData(registerFormElement) }); const j = await r.json(); if (!r.ok) throw new Error(j.message || `Errore ${r.status}`); if (j.success) { alert(j.message || "Registrazione completata! Ora puoi accedere."); document.querySelector('.login-tab[data-tab="login"]')?.click(); gebi('login-email').value = gebi('register-email').value; registerFormElement.reset(); } else { if (registerErrorMessageElement) { registerErrorMessageElement.textContent = j.message || "Errore registrazione."; registerErrorMessageElement.style.display = 'block'; } if (j.errors) { for (const f in j.errors) gebi(`register-${f}`)?.classList.add('error-border'); } } } catch (err) { console.error("Errore registrazione:", err); if (registerErrorMessageElement) { registerErrorMessageElement.textContent = "Errore connessione o server."; registerErrorMessageElement.style.display = 'block'; } } finally { b.disabled = false; b.innerHTML = o; } });

  const forgotPasswordLink = document.getElementById('forgotPasswordLink'); const forgotPasswordOverlay = document.getElementById('forgotPasswordOverlay'); const forgotPasswordPopup = document.getElementById('forgotPasswordPopup'); const closeForgotPasswordPopupBtn = document.getElementById('closeForgotPasswordPopupBtn'); const forgotPasswordForm = document.getElementById('forgotPasswordForm'); const forgotPasswordMessage = document.getElementById('forgot-password-message');
  function openForgotPasswordPopup() { if (typeof closeLoginPopup === 'function' && loginPopupEl?.classList.contains('active')) { closeLoginPopup(); } if (forgotPasswordOverlay) forgotPasswordOverlay.classList.add('active'); if (forgotPasswordPopup) forgotPasswordPopup.classList.add('active'); document.body.style.overflow = 'hidden'; if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'none'; const forgotEmailInput = document.getElementById('forgot-email'); if(forgotEmailInput) forgotEmailInput.focus(); }
  function closeForgotPasswordPopup() { if (forgotPasswordOverlay) forgotPasswordOverlay.classList.remove('active'); if (forgotPasswordPopup) forgotPasswordPopup.classList.remove('active'); if (!isAnyPopupActive()) document.body.style.overflow = ''; if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'none'; if(forgotPasswordForm) forgotPasswordForm.reset(); }
  if (forgotPasswordLink) { forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); openForgotPasswordPopup(); }); }
  if (closeForgotPasswordPopupBtn) closeForgotPasswordPopupBtn.addEventListener('click', closeForgotPasswordPopup);
  if (forgotPasswordOverlay) forgotPasswordOverlay.addEventListener('click', (e) => { if (e.target === forgotPasswordOverlay) closeForgotPasswordPopup(); });
  if (forgotPasswordForm) { forgotPasswordForm.addEventListener('submit', async (e) => { e.preventDefault(); if (forgotPasswordMessage) { forgotPasswordMessage.style.display = 'none'; forgotPasswordMessage.className = 'form-message'; } const submitBtn = forgotPasswordForm.querySelector('button[type="submit"]'); const originalBtnText = submitBtn.innerHTML; submitBtn.disabled = true; submitBtn.innerHTML = 'Invio...<div class="spinner-mini-light"></div>'; try { const formData = new FormData(forgotPasswordForm); const response = await fetch('richiesta_recupero_password.php', { method: 'POST', body: formData }); const result = await response.json(); if (result.success) { forgotPasswordMessage.textContent = result.message; forgotPasswordMessage.classList.add('success'); document.getElementById('forgot-email').value = ''; } else { forgotPasswordMessage.textContent = result.message || "Si √® verificato un errore."; forgotPasswordMessage.classList.add('error'); } } catch (error) { forgotPasswordMessage.textContent = "Errore di connessione o del server."; forgotPasswordMessage.classList.add('error'); } finally { if (forgotPasswordMessage) forgotPasswordMessage.style.display = 'block'; submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText; } }); }

  function handleLogout() { localStorage.removeItem('userDataEFF'); currentUserData = null; updateNavbarUI(); loadEvents(); alert('Logout effettuato.'); }
  gebi('logout-link-desktop')?.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); });
  gebi('mobile-logout-link')?.addEventListener('click', (e) => { e.preventDefault(); handleLogout(); closeMobileMenuOnLinkClick(); });

  function showVolantinoWithMorph(volantinoUrl) { if (!volantinoMorphOverlay) return; if (morphingCard) cleanUpMorphingCard(); volantinoMorphOverlay.classList.add("active"); document.body.classList.add("volantino-morph-active"); morphingCard = document.createElement("article"); morphingCard.className = "card morph-active-card"; let flyerContentHTML = ''; if (volantinoUrl && volantinoUrl.trim() !== "") { if (volantinoUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { flyerContentHTML = `<img src="${volantinoUrl}" alt="Volantino Evento">`; } else if (volantinoUrl.endsWith('.pdf')) { flyerContentHTML = `<iframe src="${volantinoUrl}" type="application/pdf" width="100%" height="100%" style="border:none; min-height: 80vh;"></iframe>`; } else { flyerContentHTML = `<div class="volantino-message-display"><p>Il volantino √® disponibile come file esterno.</p><a href="${volantinoUrl}" target="_blank" rel="noopener noreferrer">Visualizza Volantino</a></div>`; } } else { flyerContentHTML = `<div class="volantino-message-display"><p>Volantino non disponibile.</p></div>`; } morphingCard.innerHTML = `<div class="morph-content-wrapper"><div class="volantino-image-container-morph">${flyerContentHTML}</div></div><button class="close-morph-volantino-btn" aria-label="Chiudi">&times;</button>`; volantinoMorphOverlay.appendChild(morphingCard); morphingCard.querySelector('.close-morph-volantino-btn').onclick = hideVolantinoWithMorph; requestAnimationFrame(() => { morphingCard.classList.add("zoomed-in", "volantino-visible"); }); }
  function hideVolantinoWithMorph() { if (morphingCard && volantinoMorphOverlay) { morphingCard.classList.remove("zoomed-in", "volantino-visible"); volantinoMorphOverlay.classList.remove("active"); document.body.classList.remove("volantino-morph-active"); setTimeout(cleanUpMorphingCard, 300); } }
  function cleanUpMorphingCard() { if (morphingCard) { morphingCard.remove(); morphingCard = null; } }

  const MAX_SEATS_PER_BOOKING = 5; const MAX_TOTAL_SEATS_PER_USER = 5;

  async function loadEvents() {
    const eventsGrid = gebi("eventiGrid"); const loadingIndicator = gebi("loadingIndicator");
    if (loadingIndicator) loadingIndicator.classList.add('visible');
    if (eventsGrid) eventsGrid.innerHTML = "";

    try {
      let apiUrl = 'get_events.php';
      if (currentUserData && currentUserData.isAdmin) {
        apiUrl += '?admin_view=true';
      } else if (currentUserData && currentUserData.email) {
        apiUrl += `?user_email=${encodeURIComponent(currentUserData.email)}`;
      }

      const response = await fetch(apiUrl); const responseText = await response.text(); if (!response.ok) throw new Error(`Errore HTTP ${response.status}: ${responseText.substring(0, 100)}`);
      let result; try { result = JSON.parse(responseText); } catch (e) { throw new Error("Risposta server non JSON."); }
      if (!result.success) throw new Error(result.message || "Caricamento eventi fallito."); if (!eventsGrid) return;

      if (currentUserData && currentUserData.isAdmin) {
        currentEventsData = result.data || [];
      }

      if (result.data && result.data.length === 0) { eventsGrid.innerHTML = '<p class="no-events">Nessun evento in programma al momento.</p>'; }
      else if (result.data) { result.data.forEach((event) => eventsGrid.appendChild(createEventCard(event))); }
      else { eventsGrid.innerHTML = '<p class="no-events">Nessun dato evento ricevuto.</p>'; }
    } catch (error) { console.error("Errore loadEvents:", error); if (eventsGrid) eventsGrid.innerHTML = `<div class="error-message" style="width:100%;"><p><strong>Errore:</strong> ${error.message}</p><button onclick="loadEvents()" class="btn-popup">Riprova</button></div>`; }
    finally { if (loadingIndicator) loadingIndicator.classList.remove('visible'); }
  }

  function createEventCard(event) {
    const card = document.createElement("article");
    card.className = "card";
    card.dataset.eventId = event.idevento;
    let imageSrc = event.immagine_url?.trim() ? event.immagine_url : "images/default-event.jpg";

    if (currentUserData && currentUserData.isAdmin) {
      card.classList.add('admin-card');
      let volantinoAdminLinkHTML = '';
      if (event.volantino_url && event.volantino_url.trim() !== "") {
        // MODIFICA: Testo link volantino per admin card
        volantinoAdminLinkHTML = `<p class="card-info" style="font-size:0.9em;"><b>Volantino:</b> <a href="${event.volantino_url}" target="_blank">Visualizza volantino</a></p>`;
      }

      card.innerHTML = `
            <div class="card-image-container"><img src="${imageSrc}" alt="Copertina: ${event.titolo || "Evento"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';"></div>
            <div class="card-content">
                <h3>${event.titolo || "Titolo non disponibile"}</h3>
                <p class="card-info"><b>Data:</b> ${formatDate(event.datainizio)}${event.durata ? `<br><b>Orario/Durata:</b> ${event.durata}` : ""}</p>
                <p class="card-info"><b>${event.prefisso_relatore || "Relatore"}:</b> ${event.relatore || "N/D"}${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}`: ""}</p>
                <p class="card-description" style="font-size:0.95em; min-height: 4.5em;">${event.descrizione || "Nessuna descrizione breve."}</p>
                <p class="card-info"><b>Posti Totali:</b> ${event.posti_disponibili !== null ? event.posti_disponibili : 'N/D'}</p>
                <p class="card-info"><b>Prenotazioni:</b> ${parseInt(event.flagprenotabile) === 1 ? '<span class="status-prenotabile">Aperte</span>' : '<span class="status-non-prenotabile">Chiuse</span>'}</p>
                ${event.costo !== null ? (parseFloat(event.costo) > 0 ? `<p class="card-info"><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨</p>` : (parseFloat(event.costo) === 0 ? "<p class='card-info'><b>Costo:</b> Offerta libera</p>" : "")) : ""}
                ${volantinoAdminLinkHTML}
                <div class="card-actions admin-actions">
                    <button class="card-btn btn-edit card-btn-secondary" data-event-id="${event.idevento}">Modifica</button>
                    <button class="card-btn btn-delete card-btn-primary" data-event-id="${event.idevento}">Elimina</button>
                </div>
            </div>`;

      card.querySelector('.btn-edit').addEventListener('click', function() {
        const eventIdToEdit = this.dataset.eventId;
        const eventToEdit = currentEventsData.find(e => e.idevento == eventIdToEdit);
        if (eventToEdit) {
          openAdminEventPopup(eventToEdit);
        } else {
          console.error("Dettagli evento non trovati per la modifica. Event ID:", eventIdToEdit, "Dati correnti:", currentEventsData);
          alert("Dettagli evento non trovati per la modifica.");
        }
      });

      card.querySelector('.btn-delete').addEventListener('click', async function() {
        const eventIdToDelete = this.dataset.eventId;
        const eventToDelete = currentEventsData.find(e => e.idevento == eventIdToDelete);
        const eventTitle = eventToDelete ? eventToDelete.titolo : "questo evento";

        if (confirm(`Sei sicuro di voler eliminare l'evento "${eventTitle}"? L'azione √® irreversibile.`)) {
          const btn = this;
          const originalBtnText = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = '<div class="spinner-mini" style="border-top-color:white;"></div>';
          try {
            const formData = new FormData();
            formData.append('action', 'delete_event');
            formData.append('event_id', eventIdToDelete);
            const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
            const responseText = await response.text();
            let result;
            try { result = JSON.parse(responseText); }
            catch (e) { throw new Error(`Risposta non JSON (delete): ${responseText.substring(0,100)}`); }

            if (!response.ok || !result.success) {
              throw new Error(result.message || "Eliminazione fallita.");
            }
            alert(result.message || 'Evento eliminato con successo.');
            loadEvents();
          } catch (error) {
            console.error('Errore eliminazione evento:', error);
            alert(`Errore durante l'eliminazione: ${error.message}`);
          } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
          }
        }
      });

    } else {
      const postiDispEv = parseInt(event.posti_disponibili) || 0;
      const pGiaPrenUt = parseInt(event.posti_gia_prenotati_utente) || 0;
      const inCodaPerP = parseInt(event.in_coda_per_posti) || 0;
      const flagPrenDB = parseInt(event.flagprenotabile) === 1;
      let primaryBtnHTML = '';
      let volantinoBtnHTML = "";

      if (event.volantino_url?.trim()) {
        volantinoBtnHTML = `<button class="card-btn btn-visualizza-volantino card-btn-secondary" data-volantino-url="${event.volantino_url}">Volantino</button>`;
      } else {
        volantinoBtnHTML = `<a href="evento_dettaglio.html?id=${event.idevento}" class="card-btn card-btn-secondary">Dettagli</a>`;
      }

      if (!flagPrenDB) {
        primaryBtnHTML = `<a class="card-btn card-btn-primary">(Pren. Chiuse)</a>`;
      } else if (pGiaPrenUt >= MAX_TOTAL_SEATS_PER_USER) {
        primaryBtnHTML = `<button class="card-btn card-btn-primary btn-prenota" disabled title="Max ${MAX_TOTAL_SEATS_PER_USER} posti totali.">Max Posti (${pGiaPrenUt})</button>`;
      } else if (inCodaPerP > 0) {
        primaryBtnHTML = `<button class="card-btn card-btn-primary btn-prenota" disabled title="Sei in coda per ${inCodaPerP} posti.">In Lista d'Attesa</button>`;
      } else if (postiDispEv > 0) {
        primaryBtnHTML = `<button class="card-btn card-btn-primary btn-prenota" data-action="book" data-event-id="${event.idevento}" data-event-title="${event.titolo || ''}" data-posti-disponibili-evento="${postiDispEv}" data-posti-gia-prenotati-utente="${pGiaPrenUt}">Prenota</button>`;
      } else {
        primaryBtnHTML = `<button class="card-btn card-btn-primary btn-prenota" data-action="waitlist" data-event-id="${event.idevento}" data-event-title="${event.titolo || ''}" data-posti-gia-prenotati-utente="${pGiaPrenUt}">Entra in Coda</button>`;
      }

      card.innerHTML = `
            <div class="card-image-container"><img src="${imageSrc}" alt="Copertina: ${event.titolo || "Evento"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';"></div>
            <div class="card-content">
                <h3>${event.titolo || "Titolo non disponibile"}</h3>
                <p class="card-info"><b>Data:</b> ${formatDate(event.datainizio)}${event.durata ? `<br><b>Orario:</b> ${event.durata}` : ""}</p>
                <p class="card-info"><b>${event.prefisso_relatore || "Relatore"}:</b> ${event.relatore || "N/D"}${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}` : ""}</p>
                <p class="card-description">${event.descrizione || "Nessuna descrizione."}</p>
                <p class="card-info"><b>Posti Disponibili:</b> <span class="posti-disponibili">${postiDispEv > 0 ? postiDispEv : (flagPrenDB ? 'Esaurito' : 'Pren. Chiuse')}</span>${(currentUserData && pGiaPrenUt > 0) ? `<br><b>Tuoi posti:</b> <span class="posti-disponibili">${pGiaPrenUt}</span>` : ''}${(currentUserData && inCodaPerP > 0) ? `<br><b>In coda per:</b> <span class="posti-disponibili">${inCodaPerP} posti</span>` : ''}${event.costo !== null ? (parseFloat(event.costo) > 0 ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨` : (parseFloat(event.costo) === 0 ? "<br><b>Costo:</b> Offerta libera" : "")) : ""}</p>
                <div class="card-actions">${volantinoBtnHTML}${primaryBtnHTML}</div>
            </div>`;

      const actionBtn = card.querySelector('.btn-prenota');
      if (actionBtn && !actionBtn.disabled) {
        actionBtn.addEventListener('click', function () {
          const act = this.dataset.action;
          const eId = this.dataset.eventId;
          const eTitle = this.dataset.eventTitle;
          const pDisp = parseInt(this.dataset.postiDisponibiliEvento);
          const pGiaPren = parseInt(this.dataset.postiGiaPrenotatiUtente);

          if (!currentUserData) {
            openLoginPopup();
            localStorage.setItem("pending_action_eff", JSON.stringify({ action: act, eventId: eId, eventTitle: eTitle, postiDisp: pDisp, postiGiaPren: pGiaPren }));
            return;
          }
          if (act === 'book') {
            if (typeof window.openBookingPopup === 'function') {
              window.openBookingPopup(eId, eTitle, pDisp, pGiaPren);
            } else { console.error("Funzione openBookingPopup non definita."); }
          } else if (act === 'waitlist') {
            if (typeof window.openWaitlistPopup === 'function') {
              window.openWaitlistPopup(eId, eTitle, pGiaPren);
            } else { console.error("Funzione openWaitlistPopup non definita."); }
          }
        });
      }

      const volantinoDisplayBtn = card.querySelector(".btn-visualizza-volantino");
      if (volantinoDisplayBtn) {
        volantinoDisplayBtn.addEventListener("click", function () {
          if (typeof showVolantinoWithMorph === 'function') {
            showVolantinoWithMorph(this.dataset.volantinoUrl);
          } else { console.error("Funzione showVolantinoWithMorph non definita.");}
        });
      }
    }
    return card;
  }


  function formatDate(dateString) {
    if (!dateString) return "N/D";
    try {
      let d;
      if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
        const p = dateString.substring(0, 10).split('-');
        d = new Date(Date.UTC(parseInt(p[0]), parseInt(p[1]) - 1, parseInt(p[2])));
      } else {
        d = new Date(dateString);
      }
      if (isNaN(d.getTime())) return dateString;
      return d.toLocaleDateString("it-IT", { day: "numeric", month: "long", year: "numeric", timeZone: 'UTC' });
    } catch (e) {
      console.error("Errore formattazione data:", dateString, e);
      return dateString;
    }
  }

  function initializeBookingPopupHandlers() { const bO = gebi('bookingPopupOverlay'); const bP = gebi('bookingPopup'); const cB = gebi('closeBookingPopupBtn'); const bF = gebi('bookingForm'); const nPI = gebi('numeroPosti'); const pFC = gebi('participantFieldsContainer'); const bEII = gebi('bookingEventId'); const bPT = gebi('bookingPopupTitle'); const bRM = gebi('bookingResponseMessage'); const iPP = gebi('infoPostiPrenotabili'); const mSB = gebi('maxSeatsAllowedBooking');
    window.openBookingPopup = function (id, t, disp, giaP) { if (!currentUserData) { openLoginPopup(); localStorage.setItem("pending_action_eff", JSON.stringify({ action: 'book', eventId: id, eventTitle: t, postiDisp: disp, postiGiaPren: giaP })); return; } bEII.value = id; bPT.textContent = `Prenota: ${t}`; const pDN = parseInt(disp); const pGPN = parseInt(giaP) || 0; const maxPrUsrSTrx = Math.min(MAX_SEATS_PER_BOOKING, MAX_TOTAL_SEATS_PER_USER - pGPN); const maxE = Math.min(maxPrUsrSTrx, pDN); if (maxE < 1) { alert("Non puoi prenotare ulteriori posti."); return; }
      nPI.max = maxE; nPI.value = 1; if (mSB) mSB.textContent = maxE; if (iPP) iPP.textContent = `Puoi prenotare da 1 a ${maxE} posti. (Gi√† prenotati: ${pGPN}/${MAX_TOTAL_SEATS_PER_USER})`; generateParticipantFields(1, pFC, 'bp', maxE); if (bRM) { bRM.style.display = 'none'; bRM.className = 'form-message'; } if (bO) bO.classList.add('active'); if (bP) bP.classList.add('active'); document.body.style.overflow = 'hidden'; }; function cBP() { if (bO) bO.classList.remove('active'); if (bP) bP.classList.remove('active'); if (!isAnyPopupActive()) document.body.style.overflow = ''; if (pFC) pFC.innerHTML = ''; if (bF) bF.reset(); if (iPP) iPP.textContent = ''; } if (cB) cB.addEventListener('click', cBP); if (bO) bO.addEventListener('click', (e) => { if (e.target === bO) cBP(); });
    if (nPI && pFC) nPI.addEventListener('input', (e) => generateParticipantFields(e.target.value, pFC, 'bp', parseInt(nPI.max)));
    if (bF) bF.addEventListener('submit', async function (e) { e.preventDefault(); if (!currentUserData || !currentUserData.email) { alert("Sessione scaduta."); window.location.href = 'index.html'; return; } const btn = this.querySelector('button[type="submit"]'); const oT = btn.textContent; btn.disabled = true; btn.innerHTML = '<div class="spinner-mini"></div> Elaboro...'; if (bRM) bRM.style.display = 'none'; const fd = new FormData(); fd.append('eventId', bEII.value); fd.append('numeroPosti', nPI.value); fd.append('contatto', currentUserData.email); const N = pFC.querySelectorAll('input[name="participant_nome[]"]'); const C = pFC.querySelectorAll('input[name="participant_cognome[]"]'); let v = true; if (N.length !== parseInt(nPI.value)) { v = false; if (bRM) bRM.textContent = 'Num. partecipanti non corrisponde.'; } else { for (let i = 0; i < N.length; i++) { if (N[i].value.trim() === '' || C[i].value.trim() === '') { v = false; if (bRM) bRM.textContent = 'Nome e cognome obbligatori.'; break; } fd.append('partecipanti_nomi[]', N[i].value.trim()); fd.append('partecipanti_cognomi[]', C[i].value.trim()); } } if (!v) { if (bRM) { bRM.className = 'form-message error'; bRM.style.display = 'block'; } btn.disabled = false; btn.textContent = oT; return; }
      try { const r = await fetch('prenota_evento.php', { method: 'POST', body: fd }); const rt = await r.text(); let j; try { j = JSON.parse(rt); } catch (err) { throw new Error("Risposta non valida: " + rt.substring(0, 100)); } if (j.success) { if (bRM) { bRM.textContent = j.message || 'Prenotazione confermata!'; bRM.className = 'form-message success'; } loadEvents(); setTimeout(cBP, 2000); } else { throw new Error(j.message || 'Errore prenotazione.'); } } catch (err) { if (bRM) { bRM.textContent = `Errore: ${err.message}`; bRM.className = 'form-message error'; } } finally { if (bRM) bRM.style.display = 'block'; btn.disabled = false; btn.textContent = oT; } });
  }
  function generateParticipantFields(c, cont, bId, maxA) { if (!cont) return; cont.innerHTML = ''; let vC = parseInt(c); if (isNaN(vC) || vC < 1) vC = 1; if (isNaN(maxA) || maxA < 1) maxA = MAX_SEATS_PER_BOOKING; if (vC > maxA) vC = maxA; const nI = cont.closest('form')?.querySelector('input[type="number"]'); if (nI && parseInt(nI.value) !== vC) nI.value = vC; if (vC > 0) { for (let i = 1; i <= vC; i++) { const fS = document.createElement('div'); fS.className = 'participant-entry'; fS.innerHTML = `<p style="margin-bottom:0.5rem;font-weight:500;color:var(--dark);">Partecipante ${i}:</p><div class="form-grid"><div><label for="${bId}_nome_${i}">Nome*</label><input type="text" id="${bId}_nome_${i}" name="participant_nome[]" class="form-control" required></div><div><label for="${bId}_cognome_${i}">Cognome*</label><input type="text" id="${bId}_cognome_${i}" name="participant_cognome[]" class="form-control" required></div></div>`; cont.appendChild(fS); } } }
  function initializeWaitlistPopupHandlers() { const wO = gebi('waitlistPopupOverlay'); const wP = gebi('waitlistPopup'); const cB = gebi('closeWaitlistPopupBtn'); const wF = gebi('waitlistForm'); const wNPI = gebi('waitlistNumeroPosti'); const wEII = gebi('waitlistEventId'); const wPT = gebi('waitlistPopupTitle'); const wEI = gebi('waitlistEventInfo'); const wRM = gebi('waitlistResponseMessage'); const mSEW = gebi('maxSeatsAllowedWaitlist');
    window.openWaitlistPopup = function (id, t, pGiaP) { if (!currentUserData) { openLoginPopup(); localStorage.setItem("pending_action_eff", JSON.stringify({ action: 'waitlist', eventId: id, eventTitle: t, postiGiaPren: pGiaP })); return; } if (wEII) wEII.value = id; if (wPT) wPT.textContent = `Entra in Lista d'Attesa`; if (wEI) wEI.textContent = `Evento: ${t}`; const pGPN = parseInt(pGiaP) || 0; const maxPC = Math.min(MAX_SEATS_PER_BOOKING, MAX_TOTAL_SEATS_PER_USER - pGPN); if (maxPC < 1) { alert("Limite posti raggiunto."); return; } if (wNPI) { wNPI.max = maxPC; wNPI.value = 1; } if (mSEW) mSEW.textContent = maxPC; const iCEl = gebi('infoPostiCoda'); if (iCEl) iCEl.textContent = `Puoi richiedere da 1 a ${maxPC} posti. (Gi√† prenotati/in coda: ${pGPN}/${MAX_TOTAL_SEATS_PER_USER})`; if (wRM) { wRM.style.display = 'none'; wRM.className = 'form-message'; } if (wO) wO.classList.add('active'); if (wP) wP.classList.add('active'); document.body.style.overflow = 'hidden'; };
    function cWP() { if (wO) wO.classList.remove('active'); if (wP) wP.classList.remove('active'); if (!isAnyPopupActive()) document.body.style.overflow = ''; if (wF) wF.reset(); }
    if (cB) cB.addEventListener('click', cWP); if (wO) wO.addEventListener('click', (e) => { if (e.target === wO) cWP(); });
    if (wF) wF.addEventListener('submit', async function (e) { e.preventDefault(); if (!currentUserData || !currentUserData.email) { alert("Sessione scaduta."); window.location.href = 'index.html'; return; } const btn = this.querySelector('button[type="submit"]'); const oT = btn.textContent; btn.disabled = true; btn.innerHTML = '<div class="spinner-mini"></div> Elaboro...'; if (wRM) wRM.style.display = 'none'; const fd = new FormData(); fd.append('eventId', wEII.value); fd.append('numeroPosti', wNPI.value); fd.append('contatto', currentUserData.email);
      try { const r = await fetch('gestisci_coda.php', { method: 'POST', body: fd }); const rt = await r.text(); let j; try { j = JSON.parse(rt); } catch (err) { throw new Error("Risposta non valida: " + rt.substring(0, 100)); } if (j.success) { if (wRM) { wRM.textContent = j.message || "Richiesta coda inviata!"; wRM.className = 'form-message success'; } loadEvents(); setTimeout(cWP, 2000); } else { throw new Error(j.message || "Errore richiesta coda."); } } catch (err) { if (wRM) { wRM.textContent = `Errore: ${err.message}`; wRM.className = 'form-message error'; } } finally { if (wRM) wRM.style.display = 'block'; btn.disabled = false; btn.textContent = oT; } });
  }

  const adminEventPopupOverlayEl = gebi('adminEventPopupOverlay');
  const adminEventPopupEl = gebi('adminEventPopup');
  const closeAdminEventPopupBtnEl = gebi('closeAdminEventPopupBtn');
  const adminEventFormEl = gebi('adminEventForm');
  const adminEventPopupTitleEl = gebi('adminEventPopupTitle');
  const adminEventIdInputEl = gebi('admin-event-id');
  const adminVoluntaryCheckboxEl = gebi('admin-event-voluntary');
  const adminPriceContainerEl = gebi('admin-event-price-container');
  const adminEventPriceInputEl = gebi('admin-event-price');
  const adminEventFormMessageEl = gebi('adminEventFormMessage');
  const adminCurrentImagePreviewEl = gebi('current-event-image-preview');
  const adminCurrentFlyerPreviewEl = gebi('current-event-flyer-preview');
  const addEventBtnAdminEl = gebi('addEventBtnAdmin');

  function updateAdminPriceFieldVisibility() {
    if (adminVoluntaryCheckboxEl && adminPriceContainerEl && adminEventPriceInputEl) {
      const isVoluntary = adminVoluntaryCheckboxEl.checked;
      adminPriceContainerEl.style.display = isVoluntary ? 'none' : 'block';
      adminEventPriceInputEl.required = !isVoluntary;
      if (isVoluntary) adminEventPriceInputEl.value = '';
    }
  }
  if (adminVoluntaryCheckboxEl) adminVoluntaryCheckboxEl.addEventListener('change', updateAdminPriceFieldVisibility);

  function openAdminEventPopup(eventData = null) {
    if (!adminEventFormEl || !adminEventPopupEl || !adminEventPopupOverlayEl) return;
    adminEventFormEl.reset();
    updateAdminPriceFieldVisibility();
    if(adminEventFormMessageEl) { adminEventFormMessageEl.style.display = 'none'; adminEventFormMessageEl.className = 'form-message'; }
    if(adminCurrentImagePreviewEl) { adminCurrentImagePreviewEl.style.display = 'none'; adminCurrentImagePreviewEl.src = '#';}
    if(adminCurrentFlyerPreviewEl) adminCurrentFlyerPreviewEl.innerHTML = '';

    if (eventData) {
      if(adminEventPopupTitleEl) adminEventPopupTitleEl.textContent = 'Modifica Evento';
      if(adminEventIdInputEl) adminEventIdInputEl.value = eventData.idevento;
      gebi('admin-event-title').value = eventData.titolo || '';
      gebi('admin-event-date').value = eventData.datainizio ? eventData.datainizio.substring(0,10) : '';
      gebi('admin-event-time').value = eventData.durata || '';
      gebi('admin-event-short-desc').value = eventData.descrizione || '';
      gebi('admin-event-long-desc').value = eventData.descrizione_estesa || '';
      gebi('admin-event-prefix').value = eventData.prefisso_relatore || '';
      gebi('admin-event-speaker').value = eventData.relatore || '';
      gebi('admin-event-association').value = eventData.associazione || '';
      gebi('admin-event-seats').value = eventData.posti_disponibili !== null ? eventData.posti_disponibili : '';
      gebi('admin-event-booking').checked = parseInt(eventData.flagprenotabile) === 1;

      if(adminVoluntaryCheckboxEl) adminVoluntaryCheckboxEl.checked = parseFloat(eventData.costo) === 0.00;
      updateAdminPriceFieldVisibility();
      if (adminEventPriceInputEl && !adminVoluntaryCheckboxEl.checked && eventData.costo && parseFloat(eventData.costo) > 0) {
        adminEventPriceInputEl.value = parseFloat(eventData.costo).toFixed(2);
      } else if (adminEventPriceInputEl) {
        adminEventPriceInputEl.value = '';
      }

      if (adminCurrentImagePreviewEl && eventData.immagine_url) {
        adminCurrentImagePreviewEl.src = eventData.immagine_url; adminCurrentImagePreviewEl.style.display = 'block';
      }
      if (adminCurrentFlyerPreviewEl && eventData.volantino_url) {
        // MODIFICA: Testo link volantino per admin popup
        adminCurrentFlyerPreviewEl.innerHTML = `<p>Volantino attuale: <a href="${eventData.volantino_url}" target="_blank">Visualizza volantino</a></p>`;
      }
    } else {
      if(adminEventPopupTitleEl) adminEventPopupTitleEl.textContent = 'Aggiungi Nuovo Evento';
      if(adminEventIdInputEl) adminEventIdInputEl.value = '';
      gebi('admin-event-booking').checked = true;
      if(adminVoluntaryCheckboxEl) adminVoluntaryCheckboxEl.checked = false;
      updateAdminPriceFieldVisibility();
    }
    adminEventPopupOverlayEl.classList.add('active');
    document.body.style.overflow = 'hidden';
    gebi('admin-event-title').focus();
  }

  function closeAdminEventPopup() {
    if (!adminEventPopupEl || !adminEventPopupOverlayEl) return;
    adminEventPopupOverlayEl.classList.remove('active');
    if (!isAnyPopupActive()) {
      document.body.style.overflow = '';
    }
  }
  if (addEventBtnAdminEl) addEventBtnAdminEl.addEventListener('click', () => openAdminEventPopup());
  if (closeAdminEventPopupBtnEl) closeAdminEventPopupBtnEl.addEventListener('click', closeAdminEventPopup);
  if (adminEventPopupOverlayEl) adminEventPopupOverlayEl.addEventListener('click', (e) => { if (e.target === adminEventPopupOverlayEl) closeAdminEventPopup(); });

  adminEventFormEl?.addEventListener('submit', async function(e) {
    e.preventDefault();
    if (!currentUserData || !currentUserData.isAdmin) return;
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true; submitBtn.innerHTML = '<div class="spinner-mini"></div>Salvataggio...';
    if(adminEventFormMessageEl) { adminEventFormMessageEl.style.display = 'none'; adminEventFormMessageEl.className = 'form-message'; }

    try {
      const formData = new FormData(this);
      formData.append('action', formData.get('event-id') ? 'update_event' : 'add_event');

      const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
      const responseText = await response.text();
      let result;
      try { result = JSON.parse(responseText); }
      catch (jsonError) { throw new Error(`Risposta non JSON dal server: ${responseText.substring(0,200)}`); }

      if (!response.ok) throw new Error(result.message || `Errore server: ${response.status}`);
      if (result.success) {
        if(adminEventFormMessageEl) { adminEventFormMessageEl.textContent = result.message || 'Operazione completata!'; adminEventFormMessageEl.classList.add('success'); }
        loadEvents();
        setTimeout(closeAdminEventPopup, 1500);
      } else { throw new Error(result.message || 'Errore durante il salvataggio.'); }
    } catch (error) {
      console.error('Errore invio form evento admin:', error);
      if(adminEventFormMessageEl) { adminEventFormMessageEl.textContent = `Errore: ${error.message}`; adminEventFormMessageEl.classList.add('error'); }
    } finally {
      if(adminEventFormMessageEl) adminEventFormMessageEl.style.display = 'block';
      submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText;
    }
  });

  function isAnyPopupActive() {
    return gebi('loginPopup')?.classList.contains('active') ||
            gebi('forgotPasswordPopup')?.classList.contains('active') ||
            gebi('bookingPopupOverlay')?.classList.contains('active') || // Controlla l'overlay per coerenza
            gebi('waitlistPopupOverlay')?.classList.contains('active') || // Controlla l'overlay
            gebi('adminEventPopupOverlay')?.classList.contains('active');
  }


  document.addEventListener('DOMContentLoaded', async () => {
    const cY = gebi("currentYear"); if (cY) cY.textContent = new Date().getFullYear();
    volantinoMorphOverlay = gebi('volantinoMorphOverlay'); if (volantinoMorphOverlay) volantinoMorphOverlay.addEventListener("click", (e) => { if (e.target === volantinoMorphOverlay && morphingCard) hideVolantinoWithMorph(); });
    loadUserData(); updateNavbarUI(); await loadEvents();
    initializeBookingPopupHandlers(); initializeWaitlistPopupHandlers();
    updateAdminPriceFieldVisibility();

    const pAction = localStorage.getItem("pending_action_eff");
    if (pAction && currentUserData) {
      const aD = JSON.parse(pAction);
      if (aD.action === 'book' && typeof window.openBookingPopup === 'function') window.openBookingPopup(aD.eventId, aD.eventTitle, aD.postiDisp, aD.postiGiaPren);
      else if (aD.action === 'waitlist' && typeof window.openWaitlistPopup === 'function') window.openWaitlistPopup(aD.eventId, aD.eventTitle, aD.postiGiaPren);
      localStorage.removeItem("pending_action_eff");
    } else if (pAction && !currentUserData) {
      // Non cancellare, l'utente potrebbe loggarsi pi√π tardi
    }


    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (gebi('loginPopup')?.classList.contains("active")) closeLoginPopup();
        else if (gebi('forgotPasswordPopup')?.classList.contains("active")) closeForgotPasswordPopup();
        else if (gebi('bookingPopupOverlay')?.classList.contains("active")) gebi('closeBookingPopupBtn')?.click();
        else if (gebi('waitlistPopupOverlay')?.classList.contains("active")) gebi('closeWaitlistPopupBtn')?.click();
        else if (gebi('adminEventPopupOverlay')?.classList.contains("active")) closeAdminEventPopup();
        else if (volantinoMorphOverlay?.classList.contains("active")) hideVolantinoWithMorph();
      }
    });
  });
  // === FINE SCRIPT UNIFICATO ===
</script>
</body>

</html>
