<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/logo.png" type="image/x-icon" />
  <title>Calendario Attivit√† - Eremo Frate Francesco</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@300;400;500;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* Stili aggiuntivi per coerenza con index.html se necessario, es. error-border */
    .login-popup input.form-control.error-border {
      border-color: red !important;
    }
    .login-popup input:-webkit-autofill,
    .login-popup input:-webkit-autofill:hover,
    .login-popup input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0px 1000px white inset !important;
      -webkit-text-fill-color: #333 !important; /* O il colore del testo che usi */
    }
    .spinner-mini-light { /* Aggiunto per coerenza con index.html se usi spinner */
      display: inline-block;
      width: 1em;
      height: 1em;
      border: 2px solid rgba(0,0,0,0.2);
      border-radius: 50%;
      border-top-color: #000; /* O il colore che preferisci */
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-left: 5px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="index.html">
        <span class="emoji">üèîÔ∏è</span>
        <h2>Eremo Frate Francesco</h2>
      </a>
    </div>
    <div class="menu">
      <a href="eventiincorso.html" class="active">Calendario attivit√†</a>
      <a href="eventipassati.html">Archivio attivit√†</a
      ><span class="separator">|</span>
      <a href="incontrisullaparola.html">Incontri sulla parola</a
      ><span class="separator">|</span>
      <a href="dovesiamo.html">Dove siamo</a>
      <a href="contatti.html">Contatti</a>
    </div>
    <div class="right-menu">
      <button id="login-btn-header" class="login-btn">Accedi</button>
      <div
              class="user-dropdown"
              id="userDropdownContainer"
              style="display: none"
      >
        <button class="user-btn" aria-haspopup="true" aria-expanded="false">
              <span class="user-avatar" id="navbar-avatar">üë§</span
              ><span class="user-name" id="navbar-username">Utente</span
        ><span class="dropdown-arrow">‚ñº</span>
        </button>
        <div class="dropdown-menu">
          <a href="areapersonale.html">Profilo</a>
          <a href="areapersonale.html#prenotazioni">Prenotazioni</a>
          <a href="#" id="logout-btn-dropdown">Esci</a>
        </div>
      </div>
      <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorso.html" onclick="closeMobileMenuOnLinkClick()">Calendario attivit√†</a>
    <a href="eventipassati.html" onclick="closeMobileMenuOnLinkClick()">Archivio attivit√†</a>
    <a href="incontrisullaparola.html" onclick="closeMobileMenuOnLinkClick()">Incontri sulla parola</a>
    <a href="dovesiamo.html" onclick="closeMobileMenuOnLinkClick()">Dove siamo</a>
    <a href="contatti.html" onclick="closeMobileMenuOnLinkClick()">Contatti</a>
    <a href="#" id="login-btn-mobile" onclick="openLoginPopup(); closeMobileMenuOnLinkClick();">Accedi</a>
  </div>
</header>

<main>
  <div class="container section-padding">
    <h1>Calendario Attivit√†</h1>
    <div id="eventiGridContainer">
      <div id="loadingIndicator" class="loading-overlay">
        <div class="spinner">
          <div class="bounce1"></div>
          <div class="bounce2"></div>
          <div class="bounce3"></div>
        </div>
        <p>Sto caricando gli eventi...</p>
      </div>
      <div class="card-grid" id="eventiGrid"></div>
    </div>
  </div>
</main>

<div class="volantino-morph-overlay" id="volantinoMorphOverlay"></div>

<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
  <button
          class="close-popup"
          id="closeLoginPopupBtn"
          aria-label="Chiudi popup"
  >
    &times;
  </button>
  <div class="login-tabs">
    <div class="login-tab active" data-tab="login">Accedi</div>
    <div class="login-tab" data-tab="register">Registrati</div>
  </div>
  <form class="login-form active" id="loginFormPopup">
    <div class="form-group">
      <label for="login-email-popup">Email</label>
      <input
              type="email"
              id="login-email-popup"
              name="login-email" /* NAME AGGIUNTO */
      class="form-control"
      required
      autocomplete="email"
      />
    </div>
    <div class="form-group">
      <label for="login-password-popup">Password</label>
      <input
              type="password"
              id="login-password-popup"
              name="login-password" /* NAME AGGIUNTO */
      class="form-control"
      required
      autocomplete="current-password"
      />
    </div>
    <div id="login-error-message-popup" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
    <div class="form-actions">
      <button type="submit" class="btn-popup">Accedi</button>
    </div>
  </form>
  <form class="login-form" id="registerFormPopup">
    <div class="form-group">
      <label for="register-name-popup">Nome</label>
      <input
              type="text"
              id="register-name-popup"
              name="register-name" /* NAME AGGIUNTO */
      class="form-control"
      required
      autocomplete="given-name"
      />
    </div>
    <div class="form-group">
      <label for="register-surname-popup">Cognome</label> {/* Aggiunto per coerenza se registrati.php lo richiede */}
      <input
              type="text"
              id="register-surname-popup"
              name="register-surname" /* NAME AGGIUNTO */
      class="form-control"
      required
      autocomplete="family-name"
      />
    </div>
    <div class="form-group">
      <label for="register-email-popup">Email</label>
      <input
              type="email"
              id="register-email-popup"
              name="register-email" /* NAME AGGIUNTO */
      class="form-control"
      required
      autocomplete="email"
      />
    </div>
    <div class="form-group">
      <label for="register-password-popup">Password</label>
      <input
              type="password"
              id="register-password-popup"
              name="register-password" /* NAME AGGIUNTO */
      class="form-control"
      required
      minlength="8"
      autocomplete="new-password"
      />
      <small>Minimo 8 caratteri.</small>
    </div>
    <div class="terms-checkbox mb-3"> {/* Aggiunto per coerenza se registrati.php lo richiede */}
      <input type="checkbox" id="register-terms-popup" name="register-terms" required>
      <label for="register-terms-popup">Accetto i <a href="/termini" target="_blank">termini e condizioni</a></label>
    </div>
    <div id="register-error-message-popup" class="form-message error" style="display: none; margin-bottom: 1rem;"></div>
    <div class="form-actions">
      <button type="submit" class="btn-popup">Registrati</button>
    </div>
  </form>
</div>

<footer>
  <p>
    &copy; <span id="currentYear"></span> Eremo Frate Francesco. Tutti i
    diritti riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia
  </p>
</footer>

<script>
  function gebi(id) {
    return document.getElementById(id);
  }

  const defaultUserIconPath = 'uploads/icons/default_user.png'; // Definisci icona di default per localStorage

  // --- Navbar & Mobile Menu ---
  const navbarContainerEl = gebi("navbarContainer");
  const mobileMenuEl = gebi("mobileMenu");
  const hamburgerEl = document.querySelector(".navbar .hamburger"); // Selettore pi√π specifico
  let lastScrollNav = 0;

  if (navbarContainerEl) {
    window.addEventListener("scroll", function () {
      const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
      if (currentScroll <= 50) {
        navbarContainerEl.classList.remove("hidden");
        lastScrollNav = 0;
        return;
      }
      if (currentScroll > lastScrollNav && !navbarContainerEl.classList.contains("hidden")) {
        navbarContainerEl.classList.add("hidden");
      } else if (currentScroll < lastScrollNav && navbarContainerEl.classList.contains("hidden")) {
        navbarContainerEl.classList.remove("hidden");
      }
      lastScrollNav = currentScroll;
    });
  }

  function toggleMobileMenu() {
    if (mobileMenuEl && hamburgerEl) {
      const isOpen = mobileMenuEl.classList.toggle("open");
      hamburgerEl.classList.toggle("open"); // Per stile hamburger (es. X)
      hamburgerEl.setAttribute("aria-expanded", String(isOpen));
      document.body.style.overflow = isOpen ? "hidden" : "";
    }
  }

  function closeMobileMenuOnLinkClick() {
    if (mobileMenuEl && hamburgerEl && mobileMenuEl.classList.contains("open")) {
      mobileMenuEl.classList.remove("open");
      hamburgerEl.classList.remove("open");
      hamburgerEl.setAttribute("aria-expanded", "false");
      document.body.style.overflow = "";
    }
  }

  if (hamburgerEl) hamburgerEl.addEventListener("click", toggleMobileMenu);

  document.querySelectorAll("#mobileMenu a").forEach((link) => {
    // Non serve pi√π closeMobileMenuOnLinkClick separata se i link hanno gi√† onclick
    // Ma assicuriamoci che la logica di apertura popup Accedi funzioni bene con closeMobileMenu
    if (link.id !== 'login-btn-mobile') { // login-btn-mobile ha gi√† una sua logica onclick
      link.addEventListener("click", closeMobileMenuOnLinkClick);
    }
  });
  document.addEventListener('click', function(event) {
    if (mobileMenuEl && mobileMenuEl.classList.contains('open') &&
            hamburgerEl && !mobileMenuEl.contains(event.target) &&
            !hamburgerEl.contains(event.target)) {
      closeMobileMenuOnLinkClick();
    }
  });


  // --- Login Popup ---
  const loginOverlay = gebi("loginOverlay"),
          loginPopup = gebi("loginPopup"),
          closeLoginPopupBtn = gebi("closeLoginPopupBtn");
  const loginTabs = document.querySelectorAll(".login-tab"),
          loginForms = document.querySelectorAll(".login-popup .login-form");
  const loginBtnHeader = gebi("login-btn-header"),
          loginBtnMobile = gebi("login-btn-mobile");
  const loginErrorMessagePopup = gebi('login-error-message-popup');
  const registerErrorMessagePopup = gebi('register-error-message-popup');


  function openLoginPopup() {
    if (loginOverlay && loginPopup) {
      loginOverlay.classList.add("active");
      loginPopup.classList.add("active");
      document.body.style.overflow = "hidden";
      resetFormErrors();
      const activeForm = loginPopup.querySelector(".login-form.active");
      if (activeForm) activeForm.querySelector('input:not([type="hidden"])')?.focus();
    }
  }
  function closeLoginPopup() {
    if (loginOverlay && loginPopup) {
      loginOverlay.classList.remove("active");
      loginPopup.classList.remove("active");
      document.body.style.overflow = "";
      resetFormErrors();
    }
  }

  function resetFormErrors() {
    loginForms.forEach(form => {
      form.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border'));
    });
    if (loginErrorMessagePopup) loginErrorMessagePopup.style.display = 'none';
    if (registerErrorMessagePopup) registerErrorMessagePopup.style.display = 'none';
  }


  if (loginBtnHeader) loginBtnHeader.addEventListener("click", openLoginPopup);
  if (loginBtnMobile) {
    loginBtnMobile.addEventListener("click", (e) => { // Assicurati che openLoginPopup e closeMobileMenu siano chiamate
      e.preventDefault();
      closeMobileMenuOnLinkClick(); // Chiude prima il menu mobile
      openLoginPopup(); // Poi apre il popup
    });
  }

  if (closeLoginPopupBtn) closeLoginPopupBtn.addEventListener("click", closeLoginPopup);
  if (loginOverlay) loginOverlay.addEventListener("click", (e) => {
    if (e.target === loginOverlay) closeLoginPopup();
  });

  loginTabs.forEach((tab) => {
    tab.addEventListener("click", function () {
      loginTabs.forEach((t) => t.classList.remove("active"));
      loginForms.forEach((f) => f.classList.remove("active"));
      this.classList.add("active");
      const targetForm = gebi(
              this.getAttribute("data-tab") === "login"
                      ? "loginFormPopup"
                      : "registerFormPopup"
      );
      if (targetForm) {
        targetForm.classList.add("active");
        targetForm.querySelector('input:not([type="hidden"])')?.focus();
      }
      resetFormErrors();
    });
  });

  // --- User Dropdown & Logic ---
  const userDropdownContainerEl = gebi("userDropdownContainer"),
          userBtnEl = userDropdownContainerEl?.querySelector(".user-btn");
  let currentUser = null; // Sar√† popolato da localStorage o dopo login
  const logoutBtnDropdown = gebi("logout-btn-dropdown");

  if (userBtnEl) {
    userBtnEl.addEventListener("click", (e) => {
      e.stopPropagation();
      userDropdownContainerEl.classList.toggle("show");
      userBtnEl.setAttribute(
              "aria-expanded",
              userDropdownContainerEl.classList.contains("show").toString()
      );
    });
  }
  document.addEventListener("click", (e) => {
    if (
            userDropdownContainerEl?.classList.contains("show") &&
            !userDropdownContainerEl.contains(e.target)
    ) {
      userDropdownContainerEl.classList.remove("show");
      userBtnEl?.setAttribute("aria-expanded", "false");
    }
  });

  function updateNavbarUserUI() {
    const navbarAvatarEl = gebi("navbar-avatar"); // Questo √® uno SPAN in eventiincorso.html
    const navbarUsernameEl = gebi("navbar-username");

    if (currentUser && currentUser.nome) { // Controlla currentUser e currentUser.nome
      if (navbarAvatarEl) {
        // Se currentUser.iconPath esiste E navbarAvatarEl ha un figlio img, aggiorna src.
        // Altrimenti, usa il testo o l'avatar di testo.
        const imgAvatar = navbarAvatarEl.querySelector('img');
        if (imgAvatar && currentUser.iconPath) {
          imgAvatar.src = currentUser.iconPath;
          imgAvatar.alt = `Icona di ${currentUser.nome}`;
          imgAvatar.style.display = ''; // Assicura sia visibile
          // Potresti voler nascondere il testo di fallback se l'immagine carica
          const textNode = Array.from(navbarAvatarEl.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
          if (textNode) textNode.textContent = '';
        } else {
          // Fallback a testo se non c'√® img o iconPath, o se lo span non √® predisposto per img
          navbarAvatarEl.textContent = currentUser.avatar || (currentUser.nome ? currentUser.nome.charAt(0).toUpperCase() : "üë§");
        }
      }
      if (navbarUsernameEl) navbarUsernameEl.textContent = currentUser.nome;

      if (userDropdownContainerEl) userDropdownContainerEl.style.display = "inline-block";
      if (loginBtnHeader) loginBtnHeader.style.display = "none";
      if (loginBtnMobile) { // loginBtnMobile √® un link <a> ora.
        const mobileLoginLink = gebi('login-btn-mobile');
        if(mobileLoginLink) mobileLoginLink.style.display = "none";
      }
    } else {
      if (navbarAvatarEl) { // Reset avatar allo stato di default (testo o img di default)
        const imgAvatar = navbarAvatarEl.querySelector('img');
        if (imgAvatar) {
          imgAvatar.src = defaultUserIconPath; // o un placeholder
          imgAvatar.alt = 'User Icon';
        } else {
          navbarAvatarEl.textContent = "üë§";
        }
      }
      if (navbarUsernameEl) navbarUsernameEl.textContent = "Utente";
      if (userDropdownContainerEl) userDropdownContainerEl.style.display = "none";
      if (loginBtnHeader) loginBtnHeader.style.display = "inline-block";

      const mobileLoginLink = gebi('login-btn-mobile');
      if(mobileLoginLink) {
        mobileLoginLink.style.display = "block"; // O 'inline-block' a seconda del layout del menu mobile
        // loginBtnMobile.textContent = "Accedi"; // Gi√† cos√¨
      }
    }
  }


  // --- LOGIN FORM SUBMISSION (MODIFICATO) ---
  gebi("loginFormPopup")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const loginButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = loginButton.innerHTML;
    loginButton.disabled = true;
    loginButton.innerHTML = 'Accesso... <div class="spinner-mini-light"></div>';

    const emailInput = gebi('login-email-popup');
    const passwordInput = gebi('login-password-popup');
    emailInput.classList.remove('error-border');
    passwordInput.classList.remove('error-border');
    if(loginErrorMessagePopup) loginErrorMessagePopup.style.display = 'none';

    try {
      const response = await fetch('login.php', {
        method: 'POST',
        body: new FormData(e.target) // Assicura che gli input abbiano l'attributo 'name'
      });

      if (!response.ok) {
        let errorData = { message: `Errore HTTP: ${response.status}` };
        try { errorData = await response.json(); } catch (e) { /* Ignora se non √® JSON */ }
        throw new Error(errorData.message || `Errore HTTP: ${response.status}`);
      }
      const result = await response.json();

      if (result.success) {
        const userDataToStore = {
          nome: result.nome,
          email: result.email,
          iconPath: defaultUserIconPath // login.php non fornisce iconPath, lo prenderemo da areapersonale o user_profile_api
        };
        localStorage.setItem('userDataEFF', JSON.stringify(userDataToStore));

        // Aggiorna currentUser per l'UI immediata (opzionale, dato il redirect)
        currentUser = userDataToStore;
        // updateNavbarUserUI(); // Chiamata opzionale, la pagina ricaricher√† comunque

        closeLoginPopup();
        // REINDIRIZZAMENTO CORRETTO
        window.location.href = result.is_admin ? 'indexadmin.html' : 'eventiincorsoaccesso.html';
      } else {
        emailInput.classList.add('error-border');
        passwordInput.classList.add('error-border');
        if(loginErrorMessagePopup) {
          loginErrorMessagePopup.textContent = result.message || "Credenziali non valide.";
          loginErrorMessagePopup.style.display = 'block';
        } else {
          alert(result.message || "Credenziali non valide.");
        }
      }
    } catch (error) {
      emailInput.classList.add('error-border');
      passwordInput.classList.add('error-border');
      if(loginErrorMessagePopup) {
        loginErrorMessagePopup.textContent = "Errore di connessione o risposta non valida.";
        loginErrorMessagePopup.style.display = 'block';
      } else {
        alert("Errore di connessione o risposta non valida dal server.");
      }
      console.error("Errore login:", error);
    } finally {
      loginButton.disabled = false;
      loginButton.innerHTML = originalButtonText;
    }
  });

  // --- REGISTER FORM SUBMISSION (MODIFICATO) ---
  gebi("registerFormPopup")?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const registerButton = e.target.querySelector('button[type="submit"]');
    const originalButtonText = registerButton.innerHTML;
    registerButton.disabled = true;
    registerButton.innerHTML = 'Registrazione... <div class="spinner-mini-light"></div>';
    if(registerErrorMessagePopup) registerErrorMessagePopup.style.display = 'none';
    e.target.querySelectorAll('.form-control.error-border').forEach(input => input.classList.remove('error-border'));


    try {
      const response = await fetch('registrati.php', {
        method: 'POST',
        body: new FormData(e.target) // Assicura che gli input abbiano l'attributo 'name'
      });

      if (!response.ok) {
        let errorMsg = `Errore HTTP: ${response.status} ${response.statusText}`;
        try { const errorData = await response.json(); errorMsg = errorData.message || errorMsg; }
        catch(err) { /* Ignora */ }
        throw new Error(errorMsg);
      }
      const result = await response.json();

      if (result.success) {
        alert(result.message || "Registrazione completata! Ora puoi effettuare il login.");
        // Passa automaticamente al tab di login
        document.querySelector('.login-tab[data-tab="login"]').click();
        gebi('login-email-popup').value = gebi('register-email-popup').value; // Precompila email
        gebi('registerFormPopup').reset();
      } else {
        if(registerErrorMessagePopup) {
          registerErrorMessagePopup.textContent = result.message || "Errore durante la registrazione.";
          registerErrorMessagePopup.style.display = 'block';
        } else {
          alert("Errore Registrazione: " + (result.message || "Si √® verificato un errore."));
        }
        // Potresti voler evidenziare campi specifici se il backend fornisce dettagli
        if (result.errors) {
          for (const field in result.errors) {
            const inputElement = gebi(`register-${field}-popup`) || e.target.elements[`register-${field}`];
            if (inputElement) {
              inputElement.classList.add('error-border');
            }
          }
        }
      }
    } catch (error) {
      if(registerErrorMessagePopup) {
        registerErrorMessagePopup.textContent = "Errore: " + error.message;
        registerErrorMessagePopup.style.display = 'block';
      } else {
        alert("Errore durante la registrazione: " + error.message);
      }
      console.error("Dettaglio errore registrazione:", error);
    } finally {
      registerButton.disabled = false;
      registerButton.innerHTML = originalButtonText;
    }
  });


  function logout() {
    currentUser = null;
    localStorage.removeItem("userDataEFF");
    updateNavbarUserUI();
    // Se sei su una pagina "accesso" e fai logout, potresti voler reindirizzare a quella non "accesso"
    if (window.location.pathname.includes('accesso.html')) {
      window.location.href = window.location.pathname.replace('accesso.html', '.html');
    }
  }

  function checkLoginStatusOnLoad() {
    const userDataString = localStorage.getItem("userDataEFF");
    if (userDataString) {
      try {
        currentUser = JSON.parse(userDataString);
        // Assicurati che currentUser abbia la struttura attesa da updateNavbarUserUI,
        // specialmente se proviene da un login precedente con una struttura diversa.
        // Per eventiincorso.html, updateNavbarUserUI si aspetta .nome e .avatar (testuale).
        // Se localStorage ha iconPath, possiamo adattarlo o usare un default.
        if (currentUser && !currentUser.avatar && currentUser.iconPath) { // Adattamento per la UI di questa pagina
          currentUser.avatar = currentUser.nome ? currentUser.nome.charAt(0).toUpperCase() : "üë§";
        }
      } catch (e) {
        console.error("Errore parsing userDataEFF da localStorage:", e);
        currentUser = null;
        localStorage.removeItem("userDataEFF"); // Rimuovi dati corrotti
      }
    } else {
      currentUser = null;
    }
    updateNavbarUserUI();
  }
  if (logoutBtnDropdown) logoutBtnDropdown.addEventListener("click", (e) => {
    e.preventDefault();
    logout();
  });

  // --- Logica Caricamento Eventi & Morphing Volantino (INVARIATA DAL TUO CODICE ORIGINALE) ---
  const volantinoMorphOverlay = gebi("volantinoMorphOverlay");
  let morphingCard = null;
  let originalCardForMorph = null;

  async function loadEvents() {
    const eventsGrid = gebi("eventiGrid");
    const loadingIndicator = gebi("loadingIndicator");
    if (loadingIndicator) loadingIndicator.classList.add("visible");
    if (eventsGrid) eventsGrid.innerHTML = "";
    try {
      const response = await fetch("get_events.php"); // Assumendo che get_events.php sia accessibile dalla root
      const responseText = await response.text();
      if (!response.ok)
        throw new Error(
                `Errore HTTP ${response.status}: ${
                        response.statusText || "Net err"
                }`
        );
      let result;
      try {
        result = JSON.parse(responseText);
      } catch (e) {
        console.error("JSON Parse err:", responseText.substring(0, 500));
        throw new Error("Server err.");
      }
      if (!result.success) throw new Error(result.message || "Load err.");
      if (!eventsGrid) return;
      if (result.data.length === 0) {
        eventsGrid.innerHTML =
                '<p class="no-events" style="text-align:center; padding:20px;">Nessun evento in programma.</p>';
      } else {
        result.data.forEach((event) =>
                eventsGrid.appendChild(createEventCard(event))
        );
      }
    } catch (error) {
      console.error("loadEvents err:", error);
      if (eventsGrid)
        eventsGrid.innerHTML = `<div class="error-message" style="width:100%; text-align:center; padding:20px;"><p><strong>Errore:</strong> ${error.message}</p><button onclick="loadEvents()" class="btn-popup" style="margin-top:10px;">Riprova</button></div>`;
    } finally {
      if (loadingIndicator) loadingIndicator.classList.remove("visible");
    }
  }

  function createEventCard(event) {
    const cardOriginal = document.createElement("article");
    cardOriginal.className = "card";
    cardOriginal.dataset.eventId = event.idevento;
    let imageSrc = event.immagine_url?.trim()
            ? event.immagine_url
            : "images/default-event.jpg"; // Assicurati che questo path sia corretto
    let volantinoBtnHtml = "";
    if (event.volantino_url?.trim()) {
      // NOTA: √® stato rimosso "Volantino</button>" dal data-copertina-url qui sotto, sembrava un typo.
      volantinoBtnHtml = `<button class="card-btn btn-visualizza-volantino card-btn-secondary"
                                        data-volantino-url="${event.volantino_url}"
                                        data-copertina-url="${imageSrc}">Volantino</button>`;
    }

    // Modifica per il bottone "Prenota / Dettagli / Esaurito"
    let primaryButtonHtml = '';
    if (!event.flagprenotabile) { // Se l'evento non √® prenotabile (flag a 0 o false)
      primaryButtonHtml = `<a href="evento_dettaglio.html?id=${event.idevento}" class="card-btn card-btn-primary">Dettagli</a>`;
    } else if (parseInt(event.posti_disponibili) === 0) { // Se √® prenotabile ma i posti sono esauriti
      primaryButtonHtml = `<button class="card-btn card-btn-primary" disabled>Esaurito</button>`;
    } else { // Se √® prenotabile e ci sono posti
      primaryButtonHtml = `<button class="card-btn card-btn-primary btn-prenota-rapido" data-event-id="${event.idevento}">Prenota</button>`;
    }


    cardOriginal.innerHTML = `
            <div class="card-image-container">
                <img src="${imageSrc}" alt="Copertina: ${
            event.titolo || "Evento"
    }" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
            </div>
            <div class="card-content">
                <h3>${event.titolo || "Titolo non disponibile"}</h3>
                <p class="card-info"><b>Data:</b> ${formatDate(
            event.datainizio
    )}${
            event.durata ? `<br><b>Orario:</b> ${event.durata}` : ""
    }</p>
                <p class="card-info"><b>${
            event.prefisso_relatore || "Relatore"
    }:</b> ${event.relatore || "N/D"}${
            event.associazione
                    ? `<br><b>Associazione:</b> ${event.associazione}`
                    : ""
    }</p>
                <p class="card-description">${
            event.descrizione || "Nessuna descrizione breve."
    }</p>
                <p class="card-info"><b>Posti Disponibili:</b> <span class="posti-disponibili">${
            event.posti_disponibili !== null ? (parseInt(event.posti_disponibili) > 0 ? event.posti_disponibili : 'Esaurito') : 'N/D'
    }</span>${
            event.costo !== null
                    ? parseFloat(event.costo) > 0
                            ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨`
                            : parseFloat(event.costo) === 0
                                    ? "<br><b>Costo:</b> Offerta libera"
                                    : ""
                    : ""
    }</p>
                <div class="card-actions ${!volantinoBtnHtml ? 'single-action' : ''}">
                    ${volantinoBtnHtml}
                    ${primaryButtonHtml}
                </div>
            </div>`;

    // Aggiungi event listener solo se il bottone "Prenota" esiste ed √® attivo
    const prenotaBtn = cardOriginal.querySelector(".btn-prenota-rapido");
    if (prenotaBtn && !prenotaBtn.disabled) {
      prenotaBtn.addEventListener("click", function () {
        handleRapidBooking(this, event.idevento, event.titolo);
      });
    }

    cardOriginal
            .querySelector(".btn-visualizza-volantino")
            ?.addEventListener("click", function () {
              showVolantinoWithMorph(
                      cardOriginal,
                      this.dataset.copertinaUrl,
                      this.dataset.volantinoUrl
              );
            });
    return cardOriginal;
  }

  function showVolantinoWithMorph(
          originalCardElement,
          copertinaUrl,
          volantinoUrl
  ) {
    if (morphingCard || !volantinoMorphOverlay) return;

    originalCardForMorph = originalCardElement;
    const rect = originalCardForMorph.getBoundingClientRect();

    morphingCard = document.createElement("article");
    morphingCard.className = "card morph-active-card"; // Rimosso preparing-morph per ora

    morphingCard.style.width = `${rect.width}px`;
    morphingCard.style.height = `${rect.height}px`;
    morphingCard.style.top = `${rect.top + window.scrollY}px`; // Aggiunto scrollY
    morphingCard.style.left = `${rect.left + window.scrollX}px`; // Aggiunto scrollX

    const morphContentWrapper = document.createElement("div");
    morphContentWrapper.className = "morph-content-wrapper";

    const copertinaContainer = document.createElement("div");
    copertinaContainer.className = "card-image-container-morph";
    const imgCopertina = document.createElement("img");
    imgCopertina.src = copertinaUrl;
    imgCopertina.alt = "Copertina Evento";
    copertinaContainer.appendChild(imgCopertina);

    const cardContentOriginal =
            originalCardForMorph.querySelector(".card-content");
    let cardContentCloned = null;
    if (cardContentOriginal) {
      cardContentCloned = cardContentOriginal.cloneNode(true);
      cardContentCloned.className = "card-content-morph";
      cardContentCloned.querySelectorAll("button, a").forEach((btn) => {
        const newBtn = btn.cloneNode(true);
        if (newBtn.classList.contains("btn-prenota-rapido")) {
          newBtn.addEventListener("click", () =>
                  handleRapidBooking(newBtn, originalCardForMorph.dataset.eventId, originalCardForMorph.querySelector('h3').textContent)
          );
        } else if (newBtn.classList.contains("btn-visualizza-volantino")) {
          newBtn.disabled = true; // Disabilita il bottone volantino dentro il morph
        } else if (newBtn.tagName === 'A' && newBtn.href.includes('evento_dettaglio.html')) {
          // Mantieni link ai dettagli, ma potrebbe essere ridondante
        } else {
          newBtn.disabled = true;
        }
        btn.parentNode.replaceChild(newBtn, btn);
      });
    }

    const volantinoContainer = document.createElement("div");
    volantinoContainer.className = "volantino-image-container-morph";

    morphContentWrapper.appendChild(copertinaContainer);
    if (cardContentCloned) morphContentWrapper.appendChild(cardContentCloned);
    morphContentWrapper.appendChild(volantinoContainer);
    morphingCard.appendChild(morphContentWrapper);

    const closeBtn = document.createElement("button");
    closeBtn.className = "close-morph-volantino-btn";
    closeBtn.innerHTML = "&times;";
    closeBtn.setAttribute("aria-label", "Chiudi");
    closeBtn.onclick = hideVolantinoWithMorph;
    morphingCard.appendChild(closeBtn);

    volantinoMorphOverlay.innerHTML = "";
    volantinoMorphOverlay.appendChild(morphingCard);

    // Transizione per il mask e opacity dell'overlay
    volantinoMorphOverlay.style.transitionDelay = '0s, 0.1s, 0.1s, 0s, 0s'; // Ritardi come da CSS .active
    volantinoMorphOverlay.classList.add("active");

    document.body.classList.add("volantino-morph-active");
    if (originalCardForMorph) originalCardForMorph.classList.add("original-morph-hidden");

    requestAnimationFrame(() => { // Permette al browser di applicare stili iniziali
      requestAnimationFrame(() => { // Doppio RAF per sicurezza su alcuni browser
        morphingCard.classList.add("zoomed-in"); // Applica la classe che fa lo zoom
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        const cardAspectRatio = 700 / 800; // Esempio aspect ratio del volantino o card ingrandita
        let finalWidth, finalHeight;

        if (viewportWidth / viewportHeight > cardAspectRatio) { // Viewport pi√π largo dell'immagine
          finalHeight = Math.min(viewportHeight * 0.9, 800);
          finalWidth = finalHeight * cardAspectRatio;
        } else { // Viewport pi√π alto dell'immagine
          finalWidth = Math.min(viewportWidth * 0.9, 700);
          finalHeight = finalWidth / cardAspectRatio;
        }
        finalWidth = Math.max(finalWidth, rect.width); // Non pi√π piccolo dell'originale
        finalHeight = Math.max(finalHeight, rect.height);


        morphingCard.style.width = `${finalWidth}px`;
        morphingCard.style.height = `${finalHeight}px`;
        morphingCard.style.top = `${(viewportHeight - finalHeight) / 2 + window.scrollY}px`;
        morphingCard.style.left = `${(viewportWidth - finalWidth) / 2 + window.scrollX}px`;

        // Popola e attiva il volantino dopo l'animazione di zoom
        const zoomDuration = parseFloat(getComputedStyle(morphingCard).transitionDuration.split(",")[1] || getComputedStyle(morphingCard).transitionDuration || "0.55") * 1000;

        setTimeout(() => {
          if (!morphingCard) return;
          morphingCard.classList.add("morphing");

          volantinoContainer.innerHTML = "";
          if (volantinoUrl && volantinoUrl.trim() !== "") {
            if (volantinoUrl.match(/\.(jpeg|jpg|gif|png|webp)$/i)) {
              const imgVol = document.createElement("img");
              imgVol.src = volantinoUrl;
              imgVol.alt = "Volantino Evento";
              imgVol.onerror = () => {
                volantinoContainer.innerHTML = `<div class="volantino-message-display"><p>Impossibile caricare il volantino.</p><a href="${volantinoUrl}" target="_blank" rel="noopener noreferrer">Apri link diretto</a></div>`;
              };
              volantinoContainer.appendChild(imgVol);
            } else { // Assume sia un PDF o altro link
              volantinoContainer.innerHTML = `<div class="volantino-message-display"><p>Il volantino √® disponibile come file esterno.</p><a href="${volantinoUrl}" target="_blank" rel="noopener noreferrer">Visualizza Volantino</a></div>`;
            }
          } else {
            volantinoContainer.innerHTML = `<div class="volantino-message-display"><p>Volantino non disponibile per questo evento.</p></div>`;
          }
          morphingCard.classList.add("volantino-visible");
        }, zoomDuration);
      });
    });
  }


  function hideVolantinoWithMorph() {
    if (!morphingCard || !volantinoMorphOverlay || !originalCardForMorph) return;

    morphingCard.classList.remove("volantino-visible");
    morphingCard.classList.remove("morphing");

    // Ripristina la visualizzazione del contenuto originale nella card morphing (opzionale, se vuoi che si veda durante il restringimento)
    const clonedContent = morphingCard.querySelector('.card-content-morph');
    if (clonedContent) clonedContent.style.opacity = '1'; // O come era prima del morphing
    const morphCopertina = morphingCard.querySelector('.card-image-container-morph');
    if (morphCopertina) morphCopertina.style.height = '280px'; // Altezza originale della copertina nella card

    const rect = originalCardForMorph.getBoundingClientRect();
    morphingCard.style.width = `${rect.width}px`;
    morphingCard.style.height = `${rect.height}px`;
    morphingCard.style.top = `${rect.top + window.scrollY}px`;
    morphingCard.style.left = `${rect.left + window.scrollX}px`;
    morphingCard.classList.remove("zoomed-in");


    const overlayTransitionDuration = parseFloat(getComputedStyle(volantinoMorphOverlay).transitionDuration.split(",")[0] || "0.3") * 1000; // Durata transizione opacit√† overlay
    const cardShrinkDuration = parseFloat(getComputedStyle(morphingCard).transitionDuration.split(",")[1] || getComputedStyle(morphingCard).transitionDuration || "0.55") * 1000;

    // Rimuovi l'overlay *dopo* che la card √® tornata al suo posto e l'overlay √® diventato trasparente
    // Usa la durata pi√π lunga tra le due per il cleanup finale.
    const cleanupDelay = Math.max(overlayTransitionDuration, cardShrinkDuration);

    // Inizia la transizione dell'overlay (maschera e opacit√†) per farlo scomparire
    volantinoMorphOverlay.style.transitionDelay = '0s, 0s, 0s, 0s, 0s'; // Resetta i ritardi per l'uscita
    volantinoMorphOverlay.classList.remove("active");


    setTimeout(() => {
      cleanUpMorphingCard();
    }, cleanupDelay + 50); // Aggiungi un piccolo buffer
  }


  function cleanUpMorphingCard() {
    if (morphingCard) {
      morphingCard.remove(); // Rimuove la card clippata dal DOM
      morphingCard = null;
    }
    if (volantinoMorphOverlay.classList.contains("active")) { // Controllo ridondante ma sicuro
      volantinoMorphOverlay.classList.remove("active"); // Assicura sia rimosso
    }
    volantinoMorphOverlay.innerHTML = ""; // Pulisce overlay per sicurezza
    document.body.classList.remove("volantino-morph-active");
    if (originalCardForMorph) {
      originalCardForMorph.classList.remove("original-morph-hidden");
      originalCardForMorph = null;
    }
  }


  if (volantinoMorphOverlay) {
    volantinoMorphOverlay.addEventListener("click", (e) => {
      if (e.target === volantinoMorphOverlay && morphingCard && morphingCard.classList.contains('zoomed-in')) {
        hideVolantinoWithMorph();
      }
    });
  }


  function handleRapidBooking(buttonElement, eventId, eventTitle) {
    if (currentUser) {
      // Qui, invece di un alert, dovresti aprire il popup di prenotazione vero e proprio,
      // passando eventId e eventTitle. Questo popup sar√† gestito in eventiincorsoaccesso.html.
      // Per ora, simuliamo che l'utente debba andare alla pagina accesso.
      alert(`Per prenotare l'evento "${eventTitle}", effettua il login e vai alla sezione calendario attivit√† dell'area riservata.`);
      openLoginPopup(); // O reindirizza direttamente se preferisci
      // Potresti salvare l'ID evento nel localStorage per riprenderlo dopo il login
      localStorage.setItem("pending_booking_event_id_eff", eventId);

    } else {
      openLoginPopup();
      // Salva l'ID evento per riprenderlo dopo il login, se necessario
      localStorage.setItem("pending_booking_event_id_eff", eventId);
    }
  }

  function formatDate(dateString) {
    if (!dateString) return "N/D";
    try {
      let date;
      // Gestisce sia 'YYYY-MM-DD HH:MM:SS' che 'YYYY-MM-DD'
      if (/^\d{4}-\d{2}-\d{2}/.test(dateString)) {
        const parts = dateString.substring(0, 10).split("-");
        // Mese √® 0-indexed in JS Date constructor
        date = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
      } else {
        date = new Date(dateString); // Fallback per altri formati, potrebbe non essere UTC
      }
      if (isNaN(date.getTime())) return dateString; // Restituisce stringa originale se parsing fallisce
      return date.toLocaleDateString("it-IT", {
        day: "numeric",
        month: "long",
        year: "numeric",
        timeZone: 'UTC' // Importante se le date dal DB sono UTC e vuoi visualizzarle correttamente
      });
    } catch (e) {
      console.warn("Errore formattazione data:", dateString, e);
      return dateString; // Fallback alla stringa originale in caso di errore
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const currentYearEl = gebi("currentYear");
    if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();
    checkLoginStatusOnLoad();
    loadEvents();

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (loginPopup?.classList.contains("active")) closeLoginPopup();
        if (volantinoMorphOverlay?.classList.contains("active")) hideVolantinoWithMorph();
      }
    });
  });
</script>
</body>
</html>