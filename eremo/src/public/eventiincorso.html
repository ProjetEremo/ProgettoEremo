<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Calendario Attivit√† - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="navbar-container" id="navbarContainer">
    <nav class="navbar">
        <div class="logo">
            <a href="index.html">
                <span class="emoji">üèîÔ∏è</span>
                <h2>Eremo Frate Francesco</h2>
            </a>
        </div>
        <div class="menu">
            <a href="chi-siamo.html">Chi siamo</a>
            <span class="separator">|</span>
            <a href="eventiincorso.html" class="active">Calendario attivit√†</a>
            <a href="eventipassati.html">Archivio attivit√†</a>
            <span class="separator">|</span>
            <a href="incontrisullaparola.html">Incontri sulla parola</a>
            <span class="separator">|</span>
            <a href="dovesiamo.html">Dove siamo</a>
            <a href="contatti.html">Contatti</a>
        </div>
        <div class="right-menu">
            <button id="login-btn-header" class="login-btn" onclick="openLoginPopup()">Accedi</button>

            <div class="user-dropdown" id="userDropdownContainer" style="display: none;">
                <button class="user-btn" onclick="toggleUserMenu()" aria-haspopup="true" aria-expanded="false">
                    <span class="user-avatar" id="navbar-avatar">üë§</span> <span class="user-name" id="navbar-username">Utente</span> <span class="dropdown-arrow">‚ñº</span>
                </button>
                <div class="dropdown-menu" aria-labelledby="userDropdownContainer">
                    <a href="areapersonale.html">Il mio profilo</a>
                    <a href="areapersonale.html#prenotazioni">Le mie prenotazioni</a>
                    <a href="#" onclick="logout()">Esci</a>
                </div>
            </div>
            <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="chi-siamo.html" onclick="closeMobileMenu()">Chi siamo</a>
        <a href="eventiincorso.html" onclick="closeMobileMenu()">Calendario attivit√†</a>
        <a href="eventipassati.html" onclick="closeMobileMenu()">Archivio attivit√†</a>
        <a href="incontrisullaparola.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
        <a href="dovesiamo.html" onclick="closeMobileMenu()">Dove siamo</a>
        <a href="contatti.html" onclick="closeMobileMenu()">Contatti</a>
        <a href="#" id="login-btn-mobile" onclick="openLoginPopup(); closeMobileMenu();">Accedi</a>
    </div>
</header>

<main>
    <div class="container section-padding">
        <h1 class="text-center mb-4">Calendario Attivit√†</h1>

        <div id="eventiGridContainer">
            <div id="loadingIndicator" class="loading-overlay">
                <div class="spinner">
                    <div class="bounce1"></div>
                    <div class="bounce2"></div>
                    <div class="bounce3"></div>
                </div>
                <p>Sto caricando gli eventi...</p>
            </div>

            <div class="card-grid" id="eventiGrid">
            </div>
        </div>
    </div>
</main>

<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
    <button class="close-popup" id="closePopupBtn" aria-label="Chiudi popup">&times;</button> <div class="login-tabs">
    <div class="login-tab active" data-tab="login">Accedi</div>
    <div class="login-tab" data-tab="register">Registrati</div>
</div>
    <form class="login-form active" id="loginFormPopup"> <div class="form-group mb-3">
        <label for="login-email-popup">Email</label>
        <input type="email" id="login-email-popup" class="form-control" required>
    </div>
        <div class="form-group mb-3">
            <label for="login-password-popup">Password</label>
            <input type="password" id="login-password-popup" class="form-control" required>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn-popup">Accedi</button>
        </div>
    </form>
    <form class="login-form" id="registerFormPopup"> <div class="form-group mb-3">
        <label for="register-name-popup">Nome</label>
        <input type="text" id="register-name-popup" class="form-control" required>
    </div>
        <div class="form-group mb-3">
            <label for="register-email-popup">Email</label>
            <input type="email" id="register-email-popup" class="form-control" required>
        </div>
        <div class="form-group mb-3">
            <label for="register-password-popup">Password</label>
            <input type="password" id="register-password-popup" class="form-control" required minlength="8">
        </div>
        <div class="form-actions">
            <button type="submit" class="btn-popup">Registrati</button>
        </div>
    </form>
</div>

<footer>
    <p>&copy; <span id="currentYear"></span> Eremo Frate Francesco. Tutti i diritti riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia</p>
</footer>

<script>
    // --- Funzioni Utilit√† Generali ---
    function gebi(id) { return document.getElementById(id); }

    // --- Navbar & Mobile Menu Logic ---
    let lastScrollNav = 0;
    const navbarContainerEl = gebi('navbarContainer');
    if (navbarContainerEl) {
        window.addEventListener('scroll', function() {
            const currentScroll = window.pageYOffset;
            if (currentScroll <= 50) {
                navbarContainerEl.classList.remove('scroll-up', 'scroll-down');
                return;
            }
            if (currentScroll > lastScrollNav && !navbarContainerEl.classList.contains('scroll-down')) {
                navbarContainerEl.classList.remove('scroll-up');
                navbarContainerEl.classList.add('scroll-down');
            } else if (currentScroll < lastScrollNav && navbarContainerEl.classList.contains('scroll-down')) {
                navbarContainerEl.classList.remove('scroll-down');
                navbarContainerEl.classList.add('scroll-up');
            }
            lastScrollNav = currentScroll;
        });
    }

    const mobileMenuEl = gebi("mobileMenu");
    const hamburgerEl = document.querySelector(".hamburger");

    function toggleMobileMenu() {
        if (mobileMenuEl && hamburgerEl) {
            const isActive = mobileMenuEl.classList.toggle("active");
            hamburgerEl.classList.toggle("active");
            document.body.style.overflow = isActive ? 'hidden' : '';
        }
    }

    function closeMobileMenu() {
        if (mobileMenuEl && hamburgerEl) {
            mobileMenuEl.classList.remove("active");
            hamburgerEl.classList.remove("active");
            document.body.style.overflow = '';
        }
    }

    // --- Login Popup Logic ---
    const loginOverlay = gebi('loginOverlay');
    const loginPopup = gebi('loginPopup');
    const closePopupBtn = gebi('closePopupBtn'); // ID Corretto
    const loginTabs = document.querySelectorAll('.login-tab');
    const loginForms = document.querySelectorAll('.login-popup .login-form'); // Selettore pi√π specifico
    const loginBtnHeader = gebi('login-btn-header');
    const loginBtnMobile = gebi('login-btn-mobile');


    function openLoginPopup() {
        if (loginOverlay && loginPopup) {
            loginOverlay.classList.add('active');
            loginPopup.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeLoginPopup() {
        if (loginOverlay && loginPopup) {
            loginOverlay.classList.remove('active');
            loginPopup.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    if (loginBtnHeader) { // Aggiunto listener per il bottone Accedi nell'header
        loginBtnHeader.addEventListener('click', openLoginPopup);
    }
    if (loginBtnMobile) {
        loginBtnMobile.addEventListener('click', function(e) {
            e.preventDefault();
            openLoginPopup();
            closeMobileMenu();
        });
    }

    if (closePopupBtn) closePopupBtn.addEventListener('click', closeLoginPopup);
    if (loginOverlay) loginOverlay.addEventListener('click', closeLoginPopup);

    loginTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            loginTabs.forEach(t => t.classList.remove('active'));
            loginForms.forEach(f => f.classList.remove('active'));
            this.classList.add('active');
            const targetFormId = this.getAttribute('data-tab') === 'login' ? 'loginFormPopup' : 'registerFormPopup'; // ID Corretti
            const targetForm = gebi(targetFormId);
            if (targetForm) targetForm.classList.add('active');
        });
    });

    // --- User Dropdown Logic (per quando l'utente √® loggato) ---
    function toggleUserMenu() {
        const dropdown = gebi('userDropdownContainer');
        if (dropdown) {
            const userBtn = dropdown.querySelector('.user-btn');
            // Usa show per il menu, active per il bottone se necessario
            const isOpen = dropdown.classList.toggle('show');
            if (userBtn) userBtn.setAttribute('aria-expanded', isOpen.toString());
        }
    }

    // Chiudi il dropdown se si clicca fuori
    document.addEventListener('click', function(event) {
        const dropdownContainer = gebi('userDropdownContainer');
        if (dropdownContainer && dropdownContainer.classList.contains('show')) {
            if (!dropdownContainer.contains(event.target)) {
                dropdownContainer.classList.remove('show');
                const userBtn = dropdownContainer.querySelector('.user-btn');
                if (userBtn) userBtn.setAttribute('aria-expanded', 'false');
            }
        }
    });

    // --- Logica Utente ---
    let currentUser = null; // { nome: "Nome Utente", avatar: "üë§" } o null

    function updateNavbarUserUI() {
        const loginBtnHeaderEl = gebi('login-btn-header');
        const userDropdownContainerEl = gebi('userDropdownContainer');
        const navbarAvatarEl = gebi('navbar-avatar');
        const navbarUsernameEl = gebi('navbar-username');
        const loginBtnMobileEl = gebi('login-btn-mobile'); // Gi√† definito

        if (currentUser) {
            if (navbarAvatarEl) navbarAvatarEl.textContent = currentUser.avatar || 'üë§';
            if (navbarUsernameEl) navbarUsernameEl.textContent = currentUser.nome || 'Utente';
            if (userDropdownContainerEl) userDropdownContainerEl.style.display = 'inline-block';
            if (loginBtnHeaderEl) loginBtnHeaderEl.style.display = 'none';
            if (loginBtnMobileEl) loginBtnMobileEl.style.display = 'none'; // Nascondi "Accedi" nel menu mobile
        } else {
            if (userDropdownContainerEl) userDropdownContainerEl.style.display = 'none';
            if (loginBtnHeaderEl) loginBtnHeaderEl.style.display = 'inline-block';
            if (loginBtnMobileEl) { // Assicurati che il testo sia "Accedi" se non loggato
                loginBtnMobileEl.style.display = 'block';
                loginBtnMobileEl.innerHTML = 'Accedi'; // O il testo originale
                loginBtnMobileEl.onclick = function() { openLoginPopup(); closeMobileMenu(); };
            }
        }
    }

    gebi('loginFormPopup')?.addEventListener('submit', (e) => { // ID Corretto
        e.preventDefault();
        const email = gebi('login-email-popup').value;
        // SIMULAZIONE LOGIN:
        // In una vera applicazione, qui faresti una chiamata fetch a un endpoint di login
        currentUser = { nome: email.split('@')[0] || "Utente Loggato", avatar: "üßò" };
        localStorage.setItem('userDataEFF', JSON.stringify(currentUser)); // Salva in localStorage
        updateNavbarUserUI();
        alert('Login effettuato con successo!');
        closeLoginPopup();

        // Controlla se c'era una prenotazione in sospeso
        const pendingEventId = localStorage.getItem('pending_booking_event_id_eff');
        if (pendingEventId) {
            if(confirm(`Login effettuato. Vuoi completare la prenotazione per l'evento precedentemente selezionato?`)) {
                // Qui potresti reindirizzare o chiamare direttamente la funzione di prenotazione
                alert(`Prenotazione per evento ${pendingEventId} da completare (simulato).`);
            }
            localStorage.removeItem('pending_booking_event_id_eff');
        }
    });

    gebi('registerFormPopup')?.addEventListener('submit', (e) => { // ID Corretto
        e.preventDefault();
        // SIMULAZIONE REGISTRAZIONE E LOGIN:
        // In una vera applicazione, qui faresti una chiamata fetch a un endpoint di registrazione
        currentUser = { nome: gebi('register-name-popup').value || "Nuovo Utente", avatar: "üë§" };
        localStorage.setItem('userDataEFF', JSON.stringify(currentUser));
        updateNavbarUserUI();
        alert('Registrazione effettuata con successo! Ora sei loggato.');
        closeLoginPopup();
    });

    function logout() {
        currentUser = null;
        localStorage.removeItem('userDataEFF'); // Rimuovi da localStorage
        updateNavbarUserUI();
        alert('Logout effettuato.');
        // Potresti voler ricaricare la pagina o reindirizzare alla home
        // window.location.reload();
    }

    function checkLoginStatusOnLoad() {
        const storedUserData = localStorage.getItem('userDataEFF');
        if (storedUserData) {
            currentUser = JSON.parse(storedUserData);
        } else {
            currentUser = null;
        }
        updateNavbarUserUI();
    }


    // --- Logica Caricamento Eventi (COPIATA E ADATTATA DA eventiincorsoAdmin.html) ---
    async function loadEvents() {
        const eventsGrid = gebi('eventiGrid');
        const loadingIndicator = gebi('loadingIndicator');

        if (loadingIndicator) loadingIndicator.classList.add('visible');
        if (eventsGrid) eventsGrid.innerHTML = '';

        try {
            const response = await fetch('get_events.php'); // Assicurati che get_events.php sia accessibile
            const responseText = await response.text();

            let result;
            try {
                result = JSON.parse(responseText);
            } catch (jsonError) {
                console.error("JSON.parse() fallito durante il caricamento degli eventi. Errore:", jsonError);
                console.error("Testo della risposta grezza da get_events.php (primi 1000 caratteri):\n", responseText.substring(0, 1000));
                let displayedError = `Errore nella risposta del server (non √® JSON valido).`;
                if (responseText.toLowerCase().includes("<br />") || responseText.toLowerCase().includes("<b>warning</b>") || responseText.toLowerCase().includes("<b>fatal error</b>")) {
                    displayedError += " Potrebbe trattarsi di un errore PHP.";
                }
                throw new Error(displayedError + " Controlla la console del browser (F12) per maggiori dettagli.");
            }

            if (!response.ok) {
                const errorMsg = result?.error || result?.message || `Errore HTTP: ${response.status} - ${response.statusText || 'Nessun testo di stato'}`;
                throw new Error(errorMsg);
            }

            if (!result.success) {
                throw new Error(result.error || result.message || 'Errore nel caricamento dei dati degli eventi (flag success: false).');
            }

            if (!eventsGrid) return;

            if (result.count === 0 || !result.data || result.data.length === 0) {
                eventsGrid.innerHTML = '<p class="no-events text-center" style="padding: 20px;">Nessun evento in programma al momento.</p>';
            } else {
                result.data.forEach(event => {
                    const eventCard = createEventCard(event);
                    eventsGrid.appendChild(eventCard);
                });
            }

        } catch (error) {
            console.error('Errore dettagliato durante il caricamento degli eventi (blocco catch principale):', error);
            if (eventsGrid) {
                eventsGrid.innerHTML = `
                  <div class="error-message text-center" style="padding: 20px; width: 100%;">
                    <p><strong>Oops! Si √® verificato un errore.</strong></p>
                    <p style="font-size:0.9em; color: #e74c3c; margin-top: 5px;">${error.message || 'Impossibile caricare gli eventi.'}</p>
                    <button onclick="loadEvents()" class="btn-popup" style="margin-top: 15px;">Riprova Caricamento</button>
                  </div>`;
            }
        } finally {
            if (loadingIndicator) loadingIndicator.classList.remove('visible');
        }
    }

    function createEventCard(event) {
        const card = document.createElement('article');
        card.className = 'card';

        let imageSrc = 'images/default-event.jpg';
        if (event.immagine && typeof event.immagine === 'string' && event.immagine.startsWith('data:image')) {
            imageSrc = event.immagine;
        } else if (event.immagine) {
            console.warn(`Immagine per evento "${event.titolo}" non √® una data URI valida:`, event.immagine.substring(0,100) + "...");
        }

        card.innerHTML = `
            <div class="card-image-container">
                <img src="${imageSrc}" alt="Immagine evento ${event.titolo || 'Evento'}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';">
            </div>
            <div class="card-content">
                <h3>${event.titolo || 'Titolo non disponibile'}</h3>
                <p class="card-info">
                    <b>Data:</b> ${event.datainizio ? formatDate(event.datainizio) : 'Da definire'}
                    ${event.durata ? `<br><b>Orario:</b> ${event.durata}` : ''}
                    <br>
                    <b>${event.prefisso_relatore || 'Relatore'}:</b> ${event.relatore || 'Non specificato'}
                    ${event.associazione ? `<br><b>Associazione:</b> ${event.associazione}` : ''}
                </p>
                <p class="card-description">${event.descrizione || 'Nessuna descrizione breve.'}</p>
                <p class="card-info">
                    <b>Posti:</b>
                    <span class="posti-disponibili">${event.posti_disponibili !== null ? event.posti_disponibili : 'N/D'}</span>
                    ${event.costo !== null ? (parseFloat(event.costo) > 0 ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ‚Ç¨` : (parseFloat(event.costo) === 0 ? '<br><b>Costo:</b> Offerta libera' : '')) : ''}
                </p>
                <div class="card-actions">
                    <a href="evento_dettaglio.html?id=${event.idevento}" class="card-btn card-btn-secondary">Dettagli</a>
                    <button class="card-btn card-btn-primary btn-prenota-rapido"
                            data-event-id="${event.idevento}"
                            ${parseInt(event.posti_disponibili) === 0 || !event.flagprenotabile ? 'disabled' : ''}>
                        ${!event.flagprenotabile ? 'Info dettagli' : (parseInt(event.posti_disponibili) === 0 ? 'Esaurito' : 'Prenota')}
                    </button>
                </div>
            </div>
        `;
        const prenotaBtn = card.querySelector('.btn-prenota-rapido');
        if (prenotaBtn && event.flagprenotabile && parseInt(event.posti_disponibili) > 0) {
            prenotaBtn.addEventListener('click', function() {
                handleRapidBooking(this, event.idevento);
            });
        }
        return card;
    }

    function handleRapidBooking(buttonElement, eventId) {
        if (currentUser) {
            console.log(`Tentativo prenotazione evento ${eventId} per utente ${currentUser.nome}`);
            // Qui dovresti implementare la logica di prenotazione reale,
            // ad esempio una chiamata fetch a uno script PHP che gestisce le prenotazioni.
            alert(`Prenotazione per evento ${eventId} in elaborazione (simulato per ${currentUser.nome}).`);
            // Esempio di reindirizzamento a una pagina di conferma o dettaglio prenotazione:
            // window.location.href = `pagina_prenotazione.html?evento_id=${eventId}`;
        } else {
            openLoginPopup();
            localStorage.setItem('pending_booking_event_id_eff', eventId); // Salva l'ID per dopo il login
        }
    }

    function formatDate(dateString) {
        if (!dateString) return 'Data non disponibile';
        try {
            const parts = dateString.split('-');
            let date;
            if (parts.length === 3 && !isNaN(parseInt(parts[0])) && !isNaN(parseInt(parts[1])) && !isNaN(parseInt(parts[2]))) {
                date = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
            } else {
                date = new Date(dateString);
            }
            if (isNaN(date.getTime())) {
                console.warn("Formato data non riconosciuto o data non valida per la conversione:", dateString);
                return dateString;
            }
            return date.toLocaleDateString('it-IT', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' });
        } catch (e) {
            console.error("Errore formattazione data:", dateString, e);
            return dateString;
        }
    }

    // Anno dinamico nel footer
    gebi('currentYear').textContent = new Date().getFullYear();

    document.addEventListener('DOMContentLoaded', () => {
        checkLoginStatusOnLoad(); // Controlla se l'utente √® gi√† loggato
        loadEvents(); // Carica gli eventi
    });

</script>
</body>
</html>