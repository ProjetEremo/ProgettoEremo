<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="images/logo.png" type="image/x-icon">
    <title>Calendario Attivit√† - Eremo Frate Francesco</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="navbar-container" id="navbarContainer">
    <nav class="navbar">
        <div class="logo">
            <a href="index.html">
                <span class="emoji">üèîÔ∏è</span>
                <h2>Eremo Frate Francesco</h2>
            </a>
        </div>
        <div class="menu">
            <a href="chi-siamo.html">Chi siamo</a>
            <span class="separator">|</span>
            <a href="eventiincorso.html">Calendario attivit√†</a>
            <a href="eventipassati.html">Archivio attivit√†</a>
            <span class="separator">|</span>
            <a href="incontrisullaparola.html">Incontri sulla parola</a>
            <span class="separator">|</span>
            <a href="dovesiamo.html">Dove siamo</a>
            <a href="contatti.html">Contatti</a>
        </div>
        <div class="right-menu">
            <button id="login-btn" class="login-btn">Accedi</button>
            <button class="hamburger" onclick="toggleMobileMenu()" aria-label="Toggle menu">‚ò∞</button>
        </div>
    </nav>
    <div class="mobile-menu" id="mobileMenu">
        <a href="chi-siamo.html" onclick="closeMobileMenu()">Chi siamo</a>
        <a href="eventiincorso.html" onclick="closeMobileMenu()">Calendario attivit√†</a>
        <a href="eventipassati.html" onclick="closeMobileMenu()">Archivio attivit√†</a>
        <a href="incontrisullaparola.html" onclick="closeMobileMenu()">Incontri sulla parola</a>
        <a href="dovesiamo.html" onclick="closeMobileMenu()">Dove siamo</a>
        <a href="contatti.html" onclick="closeMobileMenu()">Contatti</a>
        <a href="#" id="login-btn-mobile" onclick="openLoginPopup(); closeMobileMenu();">Accedi</a>
    </div>
</header>

<main>
    <div class="container section-padding">
        <h1 class="text-center mb-4">Calendario Attivit√†</h1>

        <div class="card-grid" id="eventiGrid">
            <article class="card">
                <div class="card-image-container">
                    <img src="https://picsum.photos/400/250?random=meditation,spirituality" alt="Meditazione profonda" class="card-image">
                </div>
                <div class="card-content">
                    <h3>Ritiro di Meditazione Profonda</h3>
                    <p class="card-info">
                        <b>Data:</b> 15-17 Maggio 2025 <br>
                        <b>Relatore:</b> Fra' Elia <br>
                        <b>Orario:</b> Dalle 18:00 del 15
                    </p>
                    <p>Un weekend immersivo per esplorare tecniche meditative e ritrovare la calma interiore.</p>
                    <p class="card-info"><b>Posti Disponibili:</b> <span class="posti-disponibili">12</span></p>
                    <div class="card-actions">
                        <a href="evento.html?id=1" class="card-btn card-btn-secondary">Dettagli</a>
                        <button class="card-btn card-btn-primary btn-prenota-rapido" data-event-id="1">Prenota</button>
                    </div>
                </div>
            </article>

            <article class="card">
                <div class="card-image-container">
                    <img src="https://picsum.photos/400/250?random=scripture,study" alt="Studio della parola" class="card-image">
                </div>
                <div class="card-content">
                    <h3>Incontro sulla Parola: Il Vangelo di Marco</h3>
                    <p class="card-info">
                        <b>Data:</b> Ogni Gioved√¨ di Maggio 2025 <br>
                        <b>Relatore:</b> Sorella Chiara <br>
                        <b>Orario:</b> 20:30 - 22:00
                    </p>
                    <p>Approfondimento settimanale del Vangelo di Marco, aperto a tutti.</p>
                    <p class="card-info"><b>Posti Disponibili:</b> <span class="posti-disponibili">30</span></p>
                    <div class="card-actions">
                        <a href="evento.html?id=2" class="card-btn card-btn-secondary">Dettagli</a>
                        <button class="card-btn card-btn-primary btn-prenota-rapido" data-event-id="2">Prenota</button>
                    </div>
                </div>
            </article>

            <article class="card">
                <div class="card-image-container">
                    <img src="https://picsum.photos/400/250?random=nature,walk" alt="Camminata contemplativa" class="card-image">
                </div>
                <div class="card-content">
                    <h3>Camminata Contemplativa nel Bosco</h3>
                    <p class="card-info">
                        <b>Data:</b> 24 Maggio 2025 <br>
                        <b>Guida:</b> Antonio Verdi <br>
                        <b>Orario:</b> 09:00 - 13:00
                    </p>
                    <p>Un percorso guidato nei sentieri dell'Eremo, unendo movimento e riflessione.</p>
                    <p class="card-info"><b>Posti Disponibili:</b> <span class="posti-disponibili">8</span></p>
                    <div class="card-actions">
                        <a href="evento.html?id=3" class="card-btn card-btn-secondary">Dettagli</a>
                        <button class="card-btn card-btn-primary btn-prenota-rapido" data-event-id="3">Prenota</button>
                    </div>
                </div>
            </article>
        </div>
    </div>
</main>

<div class="login-popup-overlay" id="loginOverlay"></div>
<div class="login-popup" id="loginPopup">
    <button class="close-popup" id="closePopup" aria-label="Chiudi popup">&times;</button>
    <div class="login-tabs">
        <div class="login-tab active" data-tab="login">Accedi</div>
        <div class="login-tab" data-tab="register">Registrati</div>
    </div>
    <form class="login-form active" id="loginForm">
        <div class="form-group mb-3">
            <label for="login-email-popup">Email</label>
            <input type="email" id="login-email-popup" class="form-control" required>
        </div>
        <div class="form-group mb-3">
            <label for="login-password-popup">Password</label>
            <input type="password" id="login-password-popup" class="form-control" required>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn-popup">Accedi</button>
        </div>
    </form>
    <form class="login-form" id="registerForm">
        <div class="form-group mb-3">
            <label for="register-name">Nome</label>
            <input type="text" id="register-name" name="register-name" class="form-control" required autocomplete="given-name">
        </div>
        <div class="form-group mb-3">
            <label for="register-surname">Cognome</label>
            <input type="text" id="register-surname" name="register-surname" class="form-control" required autocomplete="family-name">
        </div>
        <div class="form-group mb-3">
            <label for="register-email">Email</label>
            <input type="email" id="register-email" name="register-email" class="form-control" required autocomplete="email">
        </div>
        <div class="form-group mb-3">
            <label for="register-password">Password</label>
            <input type="password" id="register-password" name="register-password" class="form-control" required minlength="8" autocomplete="new-password">
            <small>Minimo 8 caratteri.</small>
        </div>
        <div class="terms-checkbox mb-3">
            <input type="checkbox" id="register-terms" name="register-terms" required>
            <label for="register-terms">Accetto i <a href="/termini" target="_blank">termini e condizioni</a></label>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn-popup">Registrati</button>
        </div>
    </form>
</div>

<div class="booking-popup-overlay" id="bookingOverlay"></div>

<div class="booking-popup" id="bookingPopup">
    <button class="close-popup" id="closeBookingPopup" aria-label="Chiudi popup">&times;</button>
    <h2 class="mb-3">Effettua la tua Prenotazione</h2>
    <p><strong>Evento:</strong> <span id="bookingEventName">Nome Evento</span></p>
    <hr class="mb-3">
    <form id="bookingForm">
        <div class="form-group mb-3">
            <label for="numParticipants">Numero di Partecipanti (incluso te stesso):</label>
            <input type="number" id="numParticipants" name="numParticipants" class="form-control" value="1" min="1" max="10">
            <small class="form-text text-muted">Massimo <span id="maxAvailableSeatsPopup">10</span> posti disponibili per questo evento.</small>
        </div>

        <div id="additionalGuestsSection">
        </div>

        <div class="form-actions mt-4">
            <button type="submit" class="btn-popup btn-primary">Conferma Prenotazione</button>
        </div>
    </form>
</div>


<footer>
    <p>&copy; 2025 Eremo Frate Francesco. Tutti i diritti riservati. Via della Spiritualit√† 123, Nembro (BG) - Italia</p>
</footer>

<script>
    // --- Navbar Scroll Logic (dal tuo HTML originale) ---
    let lastScroll = 0;
    const navbarContainer = document.getElementById('navbarContainer');
    if (navbarContainer) { // Aggiunto controllo esistenza
        window.addEventListener('scroll', function() {
            const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
            if (currentScroll <= 50) {
                navbarContainer.classList.remove('hidden');
                lastScroll = 0;
                return;
            }
            if (currentScroll > lastScroll && !navbarContainer.classList.contains('hidden')) {
                navbarContainer.classList.add('hidden');
            } else if (currentScroll < lastScroll && navbarContainer.classList.contains('hidden')) {
                navbarContainer.classList.remove('hidden');
            }
            lastScroll = currentScroll;
        }, false);
    }

    // --- Mobile Menu Logic (dal tuo HTML originale) ---
    const mobileMenu = document.getElementById("mobileMenu");
    const hamburger = document.querySelector(".hamburger");
    function toggleMobileMenu() {
        if (mobileMenu && hamburger) { // Aggiunto controllo esistenza
            const isOpen = mobileMenu.classList.toggle("open");
            hamburger.setAttribute("aria-expanded", isOpen);
            document.body.style.overflow = isOpen ? 'hidden' : '';
        }
    }
    function closeMobileMenu() {
        if (mobileMenu && hamburger) { // Aggiunto controllo esistenza
            mobileMenu.classList.remove("open");
            hamburger.setAttribute("aria-expanded", "false");
            document.body.style.overflow = '';
        }
    }
    document.addEventListener('click', function(event) {
        if (mobileMenu && mobileMenu.classList.contains('open') &&
            !mobileMenu.contains(event.target) &&
            hamburger && !hamburger.contains(event.target)) {
            closeMobileMenu();
        }
    });

    // --- Login Popup Logic (dal tuo HTML originale) ---
    const loginBtn = document.getElementById('login-btn');
    const loginBtnMobile = document.getElementById('login-btn-mobile');
    const loginOverlay = document.getElementById('loginOverlay');
    const loginPopup = document.getElementById('loginPopup');
    const closePopupBtn = document.getElementById('closePopup');
    const loginTabs = document.querySelectorAll('.login-tab');
    const loginForms = document.querySelectorAll('.login-form');

    function openLoginPopup() {
        if (loginOverlay && loginPopup) { // Aggiunto controllo esistenza
            loginOverlay.classList.add('active');
            loginPopup.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeLoginPopup() {
        if (loginOverlay && loginPopup) { // Aggiunto controllo esistenza
            loginOverlay.classList.remove('active');
            loginPopup.classList.remove('active');
            document.body.style.overflow = '';
        }
    }

    if (loginBtn) {
        loginBtn.addEventListener('click', (e) => {
            e.preventDefault();
            openLoginPopup();
        });
    }
    if (loginBtnMobile) {
        loginBtnMobile.addEventListener('click', (e) => {
            e.preventDefault();
            closeMobileMenu();
            openLoginPopup();
        });
    }

    if(closePopupBtn) { closePopupBtn.addEventListener('click', closeLoginPopup); }
    if(loginOverlay) { loginOverlay.addEventListener('click', closeLoginPopup); }

    loginTabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            loginTabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            loginForms.forEach(form => {
                form.classList.remove('active');
                if (form.id === `${tabId}Form`) {
                    form.classList.add('active');
                }
            });
        });
    });

    document.getElementById('loginForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        // ... (logica login esistente) ...
        console.log("Login form submitted");
        alert("Login simulato!");
        closeLoginPopup();
    });

    document.getElementById('registerForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        // ... (logica registrazione esistente) ...
        console.log("Register form submitted");
        alert("Registrazione simulata!");
        closeLoginPopup();
    });


    // --- NUOVO: Booking Popup Logic ---
    const bookingOverlay = document.getElementById('bookingOverlay');
    const bookingPopup = document.getElementById('bookingPopup');
    const closeBookingPopupBtn = document.getElementById('closeBookingPopup');
    const bookingForm = document.getElementById('bookingForm');
    const numParticipantsInput = document.getElementById('numParticipants');
    const additionalGuestsSection = document.getElementById('additionalGuestsSection');
    const bookingEventNameSpan = document.getElementById('bookingEventName');
    const maxAvailableSeatsPopupSpan = document.getElementById('maxAvailableSeatsPopup');

    let currentEventMaxSeats = 1; // Default, da aggiornare
    let currentEventId = null;

    function openBookingPopup(eventId, eventName, postiDisponibili) {
        if (!bookingOverlay || !bookingPopup) return; // Controllo esistenza

        currentEventId = eventId;
        if(bookingEventNameSpan) bookingEventNameSpan.textContent = eventName;

        currentEventMaxSeats = parseInt(postiDisponibili, 10) || 1;
        if(numParticipantsInput) {
            numParticipantsInput.max = currentEventMaxSeats;
            if (parseInt(numParticipantsInput.value) > currentEventMaxSeats) {
                numParticipantsInput.value = currentEventMaxSeats > 0 ? currentEventMaxSeats : 1;
            }
            if (parseInt(numParticipantsInput.value) < 1 && currentEventMaxSeats > 0) {
                numParticipantsInput.value = 1;
            } else if (currentEventMaxSeats === 0) {
                numParticipantsInput.value = 0; // No seats, no participants
            }
            numParticipantsInput.min = currentEventMaxSeats > 0 ? 1 : 0;
        }
        if(maxAvailableSeatsPopupSpan) maxAvailableSeatsPopupSpan.textContent = currentEventMaxSeats;


        updateAdditionalGuestsFields(numParticipantsInput ? parseInt(numParticipantsInput.value, 10) : 1);
        bookingOverlay.classList.add('active');
        bookingPopup.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeBookingPopup() {
        if (!bookingOverlay || !bookingPopup) return; // Controllo esistenza

        bookingOverlay.classList.remove('active');
        bookingPopup.classList.remove('active');
        document.body.style.overflow = '';
        if(additionalGuestsSection) additionalGuestsSection.innerHTML = ''; // Pulisci i campi
        if(bookingForm) bookingForm.reset();
        if(numParticipantsInput) numParticipantsInput.value = "1";
    }

    function updateAdditionalGuestsFields(numTotalParticipants) {
        if (!additionalGuestsSection) return; // Controllo esistenza

        additionalGuestsSection.innerHTML = ''; // Pulisci i campi precedenti
        const numAdditionalGuests = numTotalParticipants - 1;

        if (numAdditionalGuests > 0) {
            const title = document.createElement('h4');
            title.textContent = 'Dettagli Ospiti Aggiuntivi';
            title.className = 'mt-3 mb-3 text-center';
            additionalGuestsSection.appendChild(title);
        }

        for (let i = 1; i <= numAdditionalGuests; i++) {
            const guestDiv = document.createElement('div');
            guestDiv.classList.add('guest-details', 'mb-3');
            // Usiamo un nome univoco per i campi di ogni ospite, ad es. guests[0][name], guests[0][surname]
            // Per semplicit√† qui uso guestName${i} e guestSurname${i} come hai fatto.
            guestDiv.innerHTML = `
                <h5>Ospite ${i}</h5>
                <div class="form-group mb-2">
                    <label for="guestName${i}">Nome Ospite ${i}:</label>
                    <input type="text" id="guestName${i}" name="guestName${i}" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="guestSurname${i}">Cognome Ospite ${i}:</label>
                    <input type="text" id="guestSurname${i}" name="guestSurname${i}" class="form-control" required>
                </div>
            `;
            additionalGuestsSection.appendChild(guestDiv);
        }
    }

    document.querySelectorAll('.btn-prenota-rapido').forEach(button => {
        button.addEventListener('click', function() {
            const card = this.closest('.card');
            if (!card) return;

            const eventId = this.dataset.eventId;
            const eventNameElement = card.querySelector('h3');
            const postiDisponibiliElement = card.querySelector('.posti-disponibili');

            const eventName = eventNameElement ? eventNameElement.textContent : "Evento Selezionato";
            const postiDisponibiliText = postiDisponibiliElement ? postiDisponibiliElement.textContent : "1";

            openBookingPopup(eventId, eventName, postiDisponibiliText);
        });
    });

    if (closeBookingPopupBtn) {
        closeBookingPopupBtn.addEventListener('click', closeBookingPopup);
    }
    if (bookingOverlay) {
        bookingOverlay.addEventListener('click', closeBookingPopup);
    }

    if (numParticipantsInput) {
        numParticipantsInput.addEventListener('input', function() { // 'input' per reattivit√† immediata
            let num = parseInt(this.value, 10);
            const maxSeats = parseInt(this.max, 10) || 1;
            const minSeats = parseInt(this.min, 10) || 0;

            if (isNaN(num)) num = minSeats; // Se non √® un numero, imposta al minimo

            if (num > maxSeats) {
                num = maxSeats;
                // alert(`Ci sono solo ${maxSeats} posti disponibili per questo evento.`);
            }
            if (num < minSeats) {
                num = minSeats;
            }
            this.value = num; // Aggiorna il valore nel campo input
            updateAdditionalGuestsFields(num);
        });
    }

    if (bookingForm) {
        bookingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            formData.append('eventId', currentEventId);

            // Simulazione invio dati
            console.log("Dati prenotazione da inviare:");
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            alert('Prenotazione inviata (simulazione)! Controlla la console per i dati.');
            closeBookingPopup();
            // Qui potresti voler aggiornare il numero di posti disponibili sulla card
            // e/o mostrare un messaggio di successo pi√π persistente.
        });
    }

    // Chiudi popup con tasto Esc
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            if (loginPopup && loginPopup.classList.contains('active')) {
                closeLoginPopup();
            }
            if (bookingPopup && bookingPopup.classList.contains('active')) {
                closeBookingPopup();
            }
        }
    });

</script>

</body>
</html>