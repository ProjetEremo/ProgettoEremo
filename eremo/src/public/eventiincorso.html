<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="images/logo.png" type="image/x-icon" />
  <title>Calendario Attività - Eremo frate Francesco</title>
  <script src="https://cdn.jsdelivr.net/npm/liquid-web/liquid-core.min.js"></script>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="liquidai.css"> <link rel="preconnect" href="https://fonts.googleapis.com">
  <script src="auth.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Roboto:wght@300;400;500;700&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    /* Stili popup login/registrazione (da eventiincorso.html) */
    .login-popup input.form-control {
      transition: border-color 0.3s ease;
      border: 1px solid #ced4da;
      background-color: white !important;
      box-shadow: none !important;
      outline: none !important;
    }
    .login-popup input.error-border { border-color: var(--danger, red) !important; }
    .login-popup input:-webkit-autofill,
    .login-popup input:-webkit-autofill:hover,
    .login-popup input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0px 1000px white inset !important;
      -webkit-text-fill-color: var(--dark, #333) !important;
    }

    /* Stili per form message, spinner, avatar (da eventiincorso.html) */
    .form-message { display: none; padding: 0.75rem; border-radius: 8px; font-size: 0.9em; margin-top: 0.5em; text-align: left; }
    .form-message.error { color: var(--danger, red); background-color: rgba(var(--danger-rgb, 231, 76, 60), 0.1); border: 1px solid rgba(var(--danger-rgb, 231, 76, 60), 0.3); }
    .form-message.success { color: var(--success, green); background-color: rgba(var(--success-rgb, 46, 204, 113), 0.1); border: 1px solid rgba(var(--success-rgb, 46, 204, 113), 0.3); }
    .spinner-mini-light, .spinner-mini { display: inline-block; width: 1em; height: 1em; border-radius: 50%; animation: spin 0.8s linear infinite; vertical-align: middle; }
    .spinner-mini-light { border: 2px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; margin-left: 5px; }
    .spinner-mini { border: 2px solid rgba(0,0,0,0.2); border-top-color: var(--primary); margin-right: 5px; }
    .btn-popup .spinner-mini { border-top-color: #fff; } /* Specifico per spinner su bottoni popup */

    @keyframes spin { to { transform: rotate(360deg); } }
    .user-avatar img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; vertical-align: middle; }
    .terms-checkbox { text-align: left; font-size: 0.9em; margin-top: 0.5rem; margin-bottom: 1rem; color: var(--gray-dark); }
    .terms-checkbox input[type="checkbox"] { margin-right: 0.5rem; vertical-align: middle; }
    .terms-checkbox label { font-weight: normal; color: var(--gray-dark); }
    .terms-checkbox a { color: var(--primary); text-decoration: underline; }
    #eventiGridContainer .no-events, #eventiGridContainer .error-message { grid-column: 1 / -1; text-align: center; padding: 2rem; font-size: 1.1rem; }

    /* === CSS PER FUNZIONALITÀ ADMIN ESISTENTI === */
    .card.admin-card .card-info b { font-weight: 600; }
    .card.admin-card .status-prenotabile { color: var(--success, green); font-weight: bold; }
    .card.admin-card .status-non-prenotabile { color: var(--danger, red); font-weight: bold; }
    .card-actions.admin-actions {
      margin-top: 1rem;
      border-top: 1px solid var(--gray-light, #eee);
      padding-top: 1rem;
      display: flex; gap: 0.5rem;
    }
    .card-actions.admin-actions .card-btn { flex-grow: 1; text-align: center; }
    .card-actions .btn-delete {
      background-color: var(--danger, #e74c3c) !important; color: white !important;
    }
    .card-actions .btn-delete:hover { background-color: darkred !important; }

    /* === STILE PER BOTTONE "AGGIUNGI EVENTO" (STILE DASHBOARD) === */
    .add-event-btn-container-wrapper {
      width: 100%;
      padding: 1rem 0;
      display: flex;
      justify-content: center;
    }
    #adminAddEventBtn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem 1.5rem;
      font-size: 1rem;
      font-weight: 500;
      color: var(--success-dark, #155724);
      background-color: var(--white, #fff);
      border: 2px dashed var(--success, #28a745);
      border-radius: var(--border-radius-large, 12px);
      cursor: pointer;
      transition: all 0.2s ease-in-out;
      text-decoration: none;
      width: auto;
      max-width: 400px;
      margin: 0 auto;
    }
    #adminAddEventBtn:hover, #adminAddEventBtn:focus {
      background-color: var(--success-light, #d4edda);
      border-color: var(--success-dark, #155724);
      color: var(--success-dark, #155724);
      box-shadow: 0 4px 12px rgba(var(--success-rgb, 40, 167, 69), 0.2);
      transform: translateY(-2px);
    }
    #adminAddEventBtn:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(var(--success-rgb, 40, 167, 69), 0.15);
    }
    #adminAddEventBtn .plus-icon {
      font-size: 1.3em;
      margin-right: 0.6em;
      font-weight: bold;
    }
    #adminAddEventBtn .fab-text-label { }


    /* === STILI PER IL NUOVO POPUP ADMIN (stile Dashboard) === */
    .dash-admin-event-popup-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.65); z-index: 1050;
      display: none; opacity: 0; transition: opacity 0.3s ease;
    }
    .dash-admin-event-popup-overlay.active { display: block; opacity: 1; }

    .dash-admin-event-popup {
      position: fixed; top: 50%; left: 50%;
      background-color: var(--white, #fff);
      padding: 0;
      border-radius: var(--border-radius-large, 12px);
      box-shadow: var(--shadow-strong, 0 10px 30px rgba(0,0,0,0.2));
      z-index: 1051;
      width: 95%; max-width: 900px;
      max-height: 90vh;
      display: none; opacity: 0;
      transform: translate(-50%, -50%) scale(0.95);
      transition: opacity 0.3s ease, transform 0.3s ease;
      overflow: hidden;
    }
    .dash-admin-event-popup.active {
      opacity: 1; transform: translate(-50%, -50%) scale(1);
      display: flex; flex-direction: column;
    }

    .dash-admin-event-popup-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--gray-light, #eee);
      display: flex; justify-content: space-between; align-items: center;
    }
    .dash-admin-event-popup-header h2 { margin: 0; color: var(--primary); font-size: 1.5rem; }
    .dash-admin-event-popup .close-popup {
      font-size: 1.8rem; color: var(--gray-dark, #777); background: none;
      border: none; cursor: pointer; padding: 0.5rem; line-height: 1;
    }
    .dash-admin-event-popup .close-popup:hover { color: var(--dark, #333); }
    .dash-admin-event-popup-content {
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
    }

    /* === NUOVI STILI PER LA SELEZIONE DELLA MODALITÀ DI CREAZIONE === */
    #creationModeSelectionView {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      justify-content: center;
      gap: 1.5rem;
      padding: 2rem 1rem;
      width: 100%;
      flex-grow: 1;
    }
    .creation-mode-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.8rem 1.5rem;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius-large);
      background-color: var(--white);
      box-shadow: var(--shadow-light);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      width: 100%;
      max-width: 320px;
      text-align: center;
      flex-basis: 0;
      flex-grow: 1;
      position: relative;
      overflow: hidden;
    }
    .creation-mode-option:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: var(--shadow-medium-strong, 0 8px 25px rgba(0,0,0,0.12));
      border-color: var(--secondary);
    }
    .creation-mode-option .icon-container { /* MODIFICATO: Contenitore per icona/logo */
      font-size: 2.5rem;
      color: var(--secondary);
      margin-bottom: 1rem;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      z-index: 1;
      position: relative; /* Per posizionare le stelle */
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 40px; /* Altezza minima per contenere testo o icona */
    }
    .creation-mode-option:hover .icon-container {
      color: var(--primary);
      transform: scale(1.15);
    }
    /* MODIFICATO: Stile per il logo testuale AI */
    .ai-logo-text {
      font-size: 0.6em; /* Relativo a .icon-container font-size */
      font-weight: bold;
      line-height: 1.1;
      display: block;
      color: var(--primary);
    }
    .ai-logo-text .line-1 { font-size: 0.9em; display: block; }
    .ai-logo-text .line-2 { font-size: 1.15em; display: block; letter-spacing: 0.5px;}

    /* MODIFICATO: Stelle per animazione bottone AI */
    .star {
      position: absolute;
      background-color: var(--primary);
      border-radius: 50%;
      opacity: 0;
      animation: twinkle 1.5s infinite ease-in-out;
      width: 3px;
      height: 3px;
    }
    .creation-mode-option#extractFromFlyerModeBtn:hover .star { opacity: 0.7; }
    .star.s1 { top: 10%; left: 15%; animation-delay: 0s; width: 2px; height: 2px;}
    .star.s2 { top: 20%; right: 10%; animation-delay: 0.3s; }
    .star.s3 { bottom: 15%; left: 25%; animation-delay: 0.6s; width: 2px; height: 2px;}
    .star.s4 { bottom: 25%; right: 20%; animation-delay: 0.9s; }
    .star.s5 { top: 50%; left: 5%; animation-delay: 0.2s; }
    .star.s6 { top: 5%; right: 30%; animation-delay: 0.7s; width: 1px; height: 1px;}


    @keyframes twinkle {
      0%, 100% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
    }


    .creation-mode-option h4 {
      font-size: 1.25rem;
      color: var(--primary);
      margin-bottom: 0.5rem;
      font-weight: 600;
      text-align: center;
      z-index: 1;
    }
    .creation-mode-option p {
      font-size: 0.9rem;
      color: var(--gray-dark);
      line-height: 1.6;
      margin-bottom: 0;
      text-align: center;
      z-index: 1;
    }

    .creation-mode-option#extractFromFlyerModeBtn {
      border-color: var(--primary-light, #a5c2b9);
      background: linear-gradient(145deg, var(--primary-lighter, #eef3f1), var(--white));
    }
    .creation-mode-option#extractFromFlyerModeBtn::before {
      content: "";
      position: absolute;
      top: 0;
      left: -150%;
      width: 50%;
      height: 100%;
      background: linear-gradient(
              to right,
              rgba(255, 255, 255, 0) 0%,
              rgba(255, 255, 255, 0.3) 50%, /* Shimmer più sottile */
              rgba(255, 255, 255, 0) 100%
      );
      transform: skewX(-25deg);
      transition: left 0.85s cubic-bezier(0.25, 0.8, 0.25, 1); /* Leggermente più lento */
      z-index: 0;
    }
    .creation-mode-option#extractFromFlyerModeBtn:hover::before {
      left: 150%;
    }
    .creation-mode-option#extractFromFlyerModeBtn:hover {
      border-color: var(--primary);
      box-shadow: 0 10px 30px rgba(var(--primary-rgb), 0.2);
    }
    .creation-mode-option#extractFromFlyerModeBtn:hover .icon-container {
      transform: scale(1.1); /* Scalatura più contenuta per il testo */
    }


    /* === NUOVI STILI PER LA SEZIONE CARICAMENTO VOLANTINO === */
    #flyerUploadView {
      display: none;
      padding: 2rem;
      border: 2px dashed var(--gray-medium);
      border-radius: var(--border-radius-large);
      background-color: var(--background-light, #f8f9fa);
      text-align: center;
      margin-top: 1rem;
      position: relative;
    }
    #flyerUploadView .form-group {
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #flyerUploadView .form-group label {
      display: block;
      margin-bottom: 0.8rem;
      color: var(--primary-dark, #333);
      font-weight: 500;
      font-size: 1rem;
      text-align: center;
    }
    #flyerUploadView #flyerFile {
      display: block;
      margin: 0 auto 1.5rem auto;
      max-width: 450px;
      padding: 0.5rem;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius-small);
    }
    #flyerUploadView #flyerPreviewContainer {
      position: relative;
      max-width: 100%;
      max-height: 250px;
      margin: 0 auto 1.5rem auto;
      display: none;
      /* MODIFICATO: Aggiunto flex per centrare l'immagine */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #flyerUploadView #flyerPreview {
      max-width: 100%;
      max-height: 250px;
      border: 1px solid var(--gray-light);
      border-radius: var(--border-radius-medium);
      display: block;
      box-shadow: var(--shadow-light);
      position: relative;
      z-index: 1;
      /* MODIFICATO: Rimosso margin: 0 auto; perché il parent ora è flex */
    }
    #flyerUploadView #flyerPreviewContainer.pulsating-background::before {
      content: '';
      position: absolute;
      top: -8px; left: -8px; right: -8px; bottom: -8px; /* Leggermente ridotto per essere più stretto */
      background-color: rgba(var(--primary-rgb), 0.08); /* Più tenue */
      border-radius: calc(var(--border-radius-medium) + 8px);
      animation: flyerPulseEffect 1.8s infinite ease-in-out; /* MODIFICATO: Animazione più veloce e nome diverso */
      z-index: 0;
    }
    /* MODIFICATO: Animazione sfondo più "lampeggiante" */
    @keyframes flyerPulseEffect {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.03); }
    }

    #flyerUploadView #processFlyerBtn.btn-popup .spinner-mini {
      margin-right: 8px;
    }
    #flyerProcessingStatus {
      margin-top: 1rem;
      font-size: 0.9rem;
      min-height: 1.2em;
    }
    #flyerProcessingStatus.error { color: var(--danger); }
    #flyerProcessingStatus.success { color: var(--success); }


    .dash-admin-event-form-and-preview-container {
      display: none;
      flex-wrap: wrap; gap: 2rem;
    }
    #dashAdminEventForm { flex: 2; min-width: 320px; }
    #dashAdminEventCardPreviewContainer {
      flex: 1; min-width: 280px; padding: 1rem; border: 1px dashed var(--gray-medium, #ccc);
      border-radius: var(--border-radius-medium, 8px); background-color: var(--background-light, #f8f9fa);
      height: fit-content; position: sticky; top: 1.5rem;
    }
    @media (max-width: 768px) {
      .dash-admin-event-form-and-preview-container { flex-direction: column-reverse; }
      #dashAdminEventCardPreviewContainer { position: static; margin-bottom: 2rem;}
    }
    #dashAdminEventCardPreviewContainer h4 {
      text-align: center; color: var(--primary); margin-top: 0; margin-bottom: 1rem;
      font-size: 1.1rem; border-bottom: 1px solid var(--gray-light, #eee); padding-bottom: 0.5rem;
    }
    .dash-admin-preview-card {
      background: var(--white); border-radius: var(--border-radius-medium);
      box-shadow: var(--shadow-light); overflow: hidden; border: 1px solid var(--gray-light);
    }
    .dash-admin-preview-card-image-container {
      height: 160px; background-color: var(--gray-lighter, #f0f0f0); display: flex;
      align-items: center; justify-content: center; overflow: hidden;
    }
    .dash-admin-preview-card-image-container img { width: 100%; height: 100%; object-fit: cover; }
    .dash-admin-preview-card-image-container .dash-admin-no-image-placeholder { font-size: 0.9rem; color: var(--gray-dark); }
    .dash-admin-preview-card-content { padding: 0.8rem 1rem; }
    .dash-admin-preview-card-content h5 {
      font-size: 1.15rem; color: var(--primary); margin: 0 0 0.4rem 0;
      font-weight: 600; min-height: 1.2em; word-break: break-word;
    }
    .dash-admin-preview-card-content p {
      font-size: 0.85rem; color: var(--gray-dark); line-height: 1.4;
      margin-bottom: 0.4rem; min-height: 1em; word-break: break-word;
    }
    .dash-admin-preview-card-content .dash-admin-preview-relatore { font-style: italic; }
    .dash-admin-preview-card-content .dash-admin-preview-posti,
    .dash-admin-preview-card-content .dash-admin-preview-costo { font-weight: bold; }
    #dashAdminEventForm .form-group { margin-bottom: 1rem; position: relative; }
    #dashAdminEventForm .form-group label {
      display: block; margin-bottom: 0.3rem; color: var(--primary-dark, #333);
      font-weight: 500; font-size: 0.9rem;
    }
    #dashAdminEventForm .form-control, #dashAdminEventForm select.form-control {
      width: 100%; padding: 0.7rem 0.9rem; border: 1px solid var(--gray-medium, #ccc);
      border-radius: 6px; font-size: 0.95rem; background-color: var(--white, #fff);
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    #dashAdminEventForm .form-control:focus {
      border-color: var(--secondary, #8db187);
      box-shadow: 0 0 0 2px rgba(var(--secondary-rgb, 141, 177, 135), 0.2);
      outline: none;
    }
    #dashAdminEventForm textarea.form-control { min-height: 70px; resize: vertical; }
    #dashAdminEventForm .form-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;
    }
    #dashAdminEventForm .form-check-group {
      display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;
    }
    #dashAdminEventForm .form-check-group input[type="checkbox"] {
      width: auto; margin-right: 0.2rem; transform: scale(1.05);
    }
    #dashAdminEventForm .form-check-group label {
      font-weight: normal; font-size: 0.9rem; margin-bottom: 0; color: var(--dark);
    }
    #dashAdminEventForm .form-actions { margin-top: 1.5rem; text-align: right; }
    #dashAdminEventForm small {
      font-size: 0.8rem; color: var(--gray-dark); display: block; margin-top: 0.2rem;
    }
    #dashAdmin-current-event-image-preview {
      margin-top: 0.5rem; max-width: 120px; border: 1px solid var(--gray-light, #eee);
      padding: 4px; border-radius: 4px; display:none;
    }
    #dashAdmin-current-event-flyer-preview {
      margin-top: 0.5rem; padding: 4px; font-size: 0.85rem;
    }
    #dashAdmin-current-event-flyer-preview a { color: var(--primary); text-decoration: underline; }
    #dashAdmin-current-event-flyer-preview span { color: var(--gray-dark); }
    #dashAdminEventFormMessage.form-message { margin-top: 1rem; }

    /* === NUOVI STILI PER BOTTONE AI "DYNAMIC ISLAND" v3 (Altezza corretta e Energia Cosmica) === */
    .ai-generate-btn-container {
      position: relative;
    }
    .ai-generate-btn {
      position: absolute;
      top: -11px;
      right: 0px;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 19px;
      min-width: 38px;
      height: 38px;
      padding: 0 9px;
      font-size: 1.05rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08);
      z-index: 10;
      opacity: 0;
      transform: scale(0.7) translateY(15px);
      pointer-events: none;
      overflow: hidden;
      transition: opacity 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
      transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275),
      min-width 0.35s ease-in-out,
      padding 0.35s ease-in-out,
      background-color 0.2s ease;
    }
    .ai-generate-btn::before {
      content: '';
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      border-radius: inherit;
      background-image:
              radial-gradient(circle at 25% 25%, rgba(255,255,255,0.15) 0px, transparent 2px),
              radial-gradient(circle at 75% 15%, rgba(200,200,255,0.12) 0.5px, transparent 2.5px),
              radial-gradient(circle at 50% 75%, rgba(220,220,255,0.1) 1px, transparent 3px),
              radial-gradient(circle at 15% 85%, rgba(230,230,255,0.13) 0.5px, transparent 2px),
              radial-gradient(circle at 85% 60%, rgba(210,210,255,0.11) 0.75px, transparent 2.5px);
      background-size: 50px 50px;
      opacity: 0;
      mix-blend-mode: screen;
      transition: opacity 0.5s ease-in-out;
      animation: cosmicFlow 20s linear infinite;
      z-index: 0;
      will-change: transform, background-position;
    }
    @keyframes cosmicFlow {
      0% { background-position: 0% 0%; transform: rotate(0deg) scale(1); }
      100% { background-position: 200px 200px; transform: rotate(360deg) scale(1.1); }
    }

    .ai-generate-btn.visible {
      opacity: 1;
      transform: scale(1) translateY(0);
      pointer-events: auto;
      animation: aiButtonPulseMain 2.8s infinite cubic-bezier(0.45, 0.05, 0.55, 0.95) 0.6s;
    }
    .ai-generate-btn.visible::before {
      opacity: 0.5;
    }
    .ai-generate-btn.visible.expanded {
      min-width: 170px;
      padding: 0 14px;
    }

    .ai-generate-btn:not(.loading):hover {
      background-color: var(--secondary);
      transform: scale(1.05) translateY(0);
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
      animation-play-state: paused;
    }
    .ai-generate-btn:not(.loading):hover::before {
      animation-play-state: paused;
      opacity: 0.7;
    }
    .ai-generate-btn:not(.loading):active {
      transform: scale(0.98) translateY(0);
      background-color: var(--primary-dark, #2a4b40);
    }

    @keyframes aiButtonPulseMain {
      0%, 100% { box-shadow: 0 4px 12px rgba(var(--primary-rgb, 54,94,81),0.1), 0 1px 3px rgba(0,0,0,0.08); transform: scale(1) translateY(0); }
      50% { box-shadow: 0 7px 18px rgba(var(--primary-rgb, 54,94,81),0.18), 0 3px 7px rgba(0,0,0,0.12); transform: scale(1.02) translateY(0); }
    }

    .ai-btn-content-wrapper {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 100%; position: relative; z-index: 2;
    }
    .ai-icon { display: inline-block; transition: opacity 0.2s ease, transform 0.3s ease; margin-right: 0; }
    .ai-text {
      opacity: 0; max-width: 0; overflow: hidden; white-space: nowrap;
      font-size: 0.85rem;
      font-weight: 500; margin-left: 0.4em;
      transition: opacity 0.3s ease-in-out 0.1s, max-width 0.35s ease-in-out 0.05s;
    }
    .ai-generate-btn.visible.expanded .ai-text {
      opacity: 1;
      max-width: 140px;
    }

    .ai-ripple-container {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      border-radius: inherit; overflow: hidden; z-index: 1;
    }
    .ai-ripple-container::before,
    .ai-ripple-container::after {
      content: ''; position: absolute; left: 50%; top: 50%;
      transform: translate(-50%, -50%) scale(0);
      border-radius: 50%;
      background-color: rgba(var(--secondary-rgb, 141, 177, 135), 0.15);
      opacity: 0; pointer-events: none;
    }
    .ai-generate-btn.visible:not(.loading):not(:hover) .ai-ripple-container::before {
      width: 180%; height: 180%;
      animation: rippleWave 2.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite 0s;
    }
    .ai-generate-btn.visible:not(.loading):not(:hover) .ai-ripple-container::after {
      width: 180%; height: 180%;
      animation: rippleWave 2.8s cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite 0.9s;
    }
    .ai-generate-btn:hover .ai-ripple-container::before,
    .ai-generate-btn:hover .ai-ripple-container::after {
      animation-play-state: paused;
    }

    @keyframes rippleWave {
      0% { transform: translate(-50%, -50%) scale(0.1); opacity: 0.6; }
      70% { transform: translate(-50%, -50%) scale(1.3); opacity: 0.15; }
      100% { transform: translate(-50%, -50%) scale(1.8); opacity: 0; }
    }

    .ai-spinner-container { display: none; align-items: center; justify-content: center; }
    .ai-spinner-container .spinner-mini {
      width: 0.9em; height: 0.9em; border-width: 2px;
      border-top-color: var(--white);
      border-left-color: rgba(255,255,255,0.3);
      border-right-color: rgba(255,255,255,0.3);
      border-bottom-color: rgba(255,255,255,0.3);
      margin: 0;
    }
    .ai-spinner-container .ai-loading-text { font-size: 0.8rem; font-weight: 500; color: white; margin-left: 8px; }

    .ai-generate-btn.loading {
      min-width: 120px;
      padding: 0 14px;
      background-color: var(--secondary);
      animation-play-state: paused;
      cursor: default;
    }
    .ai-generate-btn.loading::before {
      opacity: 0 !important;
      animation: none !important;
    }
    .ai-generate-btn.loading .ai-btn-content-wrapper { display: none; }
    .ai-generate-btn.loading .ai-spinner-container { display: flex; }
    .ai-generate-btn.loading .ai-ripple-container::before,
    .ai-generate-btn.loading .ai-ripple-container::after {
      animation: none; opacity: 0;
    }
    /* Fine nuovi stili bottone AI v3 */


    /* === ANIMAZIONE POPUP PRENOTAZIONE === */
    .booking-popup-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.55);
      z-index: 1040;
      opacity: 0;
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    .booking-popup-overlay.active { opacity: 1; pointer-events: auto; }
    .booking-popup-overlay.fading-out { opacity: 0 !important; }


    .booking-popup {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.95);
      transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      transition-delay: 0.05s;
      pointer-events: none;
    }
    .booking-popup.active {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }
    .booking-popup.fading-out {
      opacity: 0 !important;
      transform: translate(-50%, -50%) scale(0.95) !important;
    }

    #bookingForm .form-content-wrapper.swept-away,
    #waitlistForm .form-content-wrapper.swept-away {
      transition: opacity 0.4s ease-out, max-height 0.5s ease-in-out, transform 0.4s ease-out;
      opacity: 0;
      max-height: 0 !important;
      transform: translateY(-30px);
      overflow: hidden;
      margin:0; padding:0; border:0;
    }
    #bookingSuccessAnimation,
    #waitlistSuccessAnimation {
      text-align: center; padding: 20px 0;
    }
    .animated-check-icon {
      width: 80px; height: 80px;
      border-radius: 50%;
      display: block;
      stroke-width: 3;
      stroke: var(--success, #4CAF50);
      stroke-miterlimit: 10;
      margin: 20px auto;
      box-shadow: inset 0px 0px 0px var(--success, #4CAF50);
      animation: check_fill .4s ease-in-out .4s forwards, check_scale .3s ease-in-out .9s both;
    }
    .animated-check-icon__circle {
      stroke-dasharray: 166;
      stroke-dashoffset: 166;
      stroke-width: 3;
      stroke-miterlimit: 10;
      stroke: var(--success, #4CAF50);
      fill: none;
      animation: check_stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }
    .animated-check-icon__check {
      transform-origin: 50% 50%;
      stroke-dasharray: 48;
      stroke-dashoffset: 48;
      stroke-width: 4;
      stroke: #FFFFFF;
      animation: check_stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }
    @keyframes check_stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes check_scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes check_fill { 100% { box-shadow: inset 0px 0px 0px 45px var(--success, #4CAF50); } }

    #bookingSuccessAnimation p,
    #waitlistSuccessAnimation p {
      font-size: 1.3em;
      color: var(--success-dark, #155724);
      margin-top: 15px;
      font-weight: 500;
      animation: fadeInText 0.5s ease-in-out 1s forwards;
      opacity: 0;
    }
    @keyframes fadeInText { to { opacity: 1; } }

    /* === STILI NUOVO POPUP VOLANTINO (Design Ispirato Apple) === */
    :root {
      --flyer-text-primary: #1d1d1f;
      --flyer-modal-bg: #f8f8fa;
      --flyer-overlay-bg: rgba(0, 0, 0, 0.65);
    }

    .flyer-overlay-eff {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--flyer-overlay-bg);
      backdrop-filter: blur(16px) saturate(160%);
      -webkit-backdrop-filter: blur(16px) saturate(160%);
      z-index: 2000;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.4s cubic-bezier(0.45, 0.05, 0.55, 0.95), visibility 0s linear 0.4s;
    }

    .flyer-overlay-eff.active {
      opacity: 1;
      visibility: visible;
      transition-delay: 0s;
    }

    .flyer-modal-eff {
      background-color: var(--flyer-modal-bg);
      border-radius: 22px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25),
      0 0 15px rgba(0, 0, 0, 0.1);
      width: clamp(320px, 88vw, 1000px);
      height: clamp(450px, 85vh, 750px);
      display: flex;
      flex-direction: column;
      position: relative;
      opacity: 0;
      transform: scale(0.92) translateY(15px);
      transition: opacity 0.4s cubic-bezier(0.45, 0.05, 0.55, 0.95) 0.05s, transform 0.4s cubic-bezier(0.45, 0.05, 0.55, 0.95) 0.05s;
      overflow: hidden;
    }

    .flyer-overlay-eff.active .flyer-modal-eff {
      opacity: 1;
      transform: scale(1) translateY(0px);
    }

    .flyer-close-btn-eff {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 2rem;
      color: var(--gray-dark, #777);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0.5rem;
      line-height: 1;
      z-index: 10;
      transition: color 0.2s ease, transform 0.25s ease-out;
    }

    .flyer-close-btn-eff:hover,
    .flyer-close-btn-eff:focus-visible {
      color: var(--dark, #333);
      transform: rotate(90deg);
      background: none;
    }

    .flyer-content-area-eff {
      flex-grow: 1;
      width: 100%;
      height: 100%;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: inherit;
    }

    .flyer-media-container-eff {
      width: 100%;
      height: 100%;
      overflow: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 5px;
      box-sizing: border-box;
    }

    .flyer-media-container-eff img,
    .flyer-media-container-eff iframe {
      display: block;
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      border: none;
      border-radius: 8px;
    }

    .flyer-media-container-eff iframe {
      width: 100%;
      height: 100%;
      min-height: 400px;
    }

    .flyer-message-display-eff {
      text-align: center;
      padding: 3rem 1rem;
      font-size: 1.1rem;
      color: var(--flyer-text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }
    .flyer-message-display-eff p { margin-bottom: 1rem; }
    .flyer-message-display-eff a {
      color: var(--primary);
      text-decoration: underline; font-weight: 500;
      padding: 0.6rem 1.2rem; background-color: rgba(0,0,0,0.05); border-radius: 8px;
    }
    .flyer-message-display-eff a:hover { background-color: rgba(0,0,0,0.08); }

    body.flyer-popup-active-eff {
      overflow: hidden;
    }
    /* === FINE STILI NUOVO POPUP VOLANTINO === */

    /* Stile per il Custom Confirm Modal */
    .custom-confirm-overlay {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.6);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease-out;
    }
    .custom-confirm-overlay.active {
      display: flex;
      opacity: 1;
    }
    .custom-confirm-modal {
      background-color: var(--white);
      padding: 2rem;
      border-radius: var(--border-radius-medium);
      box-shadow: var(--shadow-strong);
      width: 90%;
      max-width: 450px;
      text-align: center;
      transform: scale(0.95);
      opacity: 0;
      transition: transform 0.2s ease-out, opacity 0.2s ease-out;
    }
    .custom-confirm-overlay.active .custom-confirm-modal {
      transform: scale(1);
      opacity: 1;
    }
    .custom-confirm-modal h3 {
      font-size: 1.3rem;
      color: var(--primary);
      margin-top: 0;
      margin-bottom: 1rem;
    }
    .custom-confirm-modal p {
      font-size: 1rem;
      color: var(--gray-dark);
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    .custom-confirm-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
    }
    .custom-confirm-actions .btn-popup {
      min-width: 100px;
    }
    .custom-confirm-actions .btn-confirm-no {
      background-color: var(--gray-light);
      color: var(--dark);
      border: 1px solid var(--gray-medium);
    }
    .custom-confirm-actions .btn-confirm-no:hover {
      background-color: var(--gray-medium);
    }

    /* === NUOVI STILI PER INFO A "PILLOLE" (CON SPAZIATURA AGGIORNATA) === */
    .card-info-pills {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 1rem 0 1.2rem 0; /* Aumentato lo spazio sopra e sotto */
        padding-bottom: 1rem; /* Aumentato il padding inferiore */
        border-bottom: 1px solid var(--gray-lighter);
    }
    .info-pill {
        display: inline-flex;
        align-items: center;
        background-color: var(--background-light, #f8f9fa);
        color: var(--primary-dark, #333);
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        border: 1px solid var(--gray-light, #eee);
        transition: all 0.2s ease-in-out;
    }
    .info-pill i {
        margin-right: 0.5rem;
        color: var(--primary);
        font-size: 0.9em;
    }
    /* === FINE NUOVI STILI === */

    /* === NUOVI STILI PER INFO POSTI E COSTO (CON ALLINEAMENTO CENTRATO) === */
    .card-status-info {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center; /* Aggiunto per centrare le pillole */
        gap: 0.6rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--gray-lighter, #f0f0f0);
    }
    .status-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.4rem 0.9rem;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        border: 1px solid transparent;
    }
    .status-pill i {
        margin-right: 0.6rem;
        font-size: 0.9em;
    }
    /* Pillola Posti */
    .status-pill.posti {
        background-color: rgba(var(--success-rgb, 40, 167, 69), 0.1);
        color: var(--success-dark, #155724);
    }
    .status-pill.posti.low-seats {
        background-color: rgba(255, 193, 7, 0.15); /* Giallo/Arancio */
        color: #856404;
    }
    .status-pill.posti.sold-out {
        background-color: rgba(var(--danger-rgb, 220, 53, 69), 0.1);
        color: var(--danger-dark, #721c24);
    }
    /* Pillola Costo */
    .status-pill.costo {
        background-color: rgba(var(--primary-rgb, 54, 94, 81), 0.1);
        color: var(--primary-dark, #2a4b40);
    }
    /* Pillola Utente */
    .status-pill.user-info {
        background-color: rgba(0, 123, 255, 0.1);
        color: #004085;
    }
    /* Stile per la card di un evento annullato */
.card.event-cancelled {
    position: relative; /* Necessario per posizionare il watermark */
    overflow: hidden;   /* Nasconde le parti del banner che escono dalla card */
}

.card.event-cancelled .card-image-container img {
    filter: grayscale(80%) brightness(0.7);
    transition: all 0.4s ease; /* Applica la transizione a tutto (filtro e zoom) */
}

/* Aggiungi questa nuova regola per l'effetto al passaggio del mouse */
.card.event-cancelled:hover .card-image-container img {
    transform: scale(1.1);
    filter: grayscale(40%) brightness(0.85); /* Schiarisce leggermente l'effetto al passaggio */
}

.cancelled-watermark {
    position: absolute;
    top: 25px;
    left: -45px;
    transform: rotate(-35deg);
    background-color: rgba(220, 53, 69, 0.85); /* Rosso semi-trasparente */
    color: white;
    padding: 8px 60px;
    font-size: 1.4rem;
    font-weight: bold;
    letter-spacing: 2px;
    text-align: center;
    z-index: 10;
    pointer-events: none; /* Permette di cliccare gli elementi sotto il banner */
    text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    animation: pulse-fade 2s infinite ease-in-out;
}

/* Animazione per il banner */
@keyframes pulse-fade {
    0%, 100% {
        opacity: 0.85;
        transform: rotate(-35deg) scale(1);
    }
    50% {
        opacity: 1;
        transform: rotate(-35deg) scale(1.05);
    }
}
  </style>
</head>

<body>
<header class="navbar-container" id="navbarContainer">
  <nav class="navbar">
    <div class="logo">
      <a href="index.html">
        <img src="images/Logo_eremo.png" alt="Logo Eremo frate Francesco" class="navbar-logo-img" id="navbarLogoImgTag">
        <h2 id="navbar-title">Eremo frate Francesco</h2>
      </a>
    </div>
    <div class="menu" id="main-menu">
      <a href="eventiincorso.html" class="active" id="nav-calendario">Calendario attività</a>
      <a href="eventipassati.html" id="nav-archivio">Archivio attività</a>
      <span class="separator">|</span>
      <a href="incontrisullaparola.html" id="nav-incontri">Incontri sulla parola</a>
      <span class="separator">|</span>
      <a href="dovesiamo.html" id="nav-dovesiamo">Dove siamo</a>
      <a href="contatti.html" id="nav-contatti">Contatti</a>
    </div>
    <div class="right-menu">
      <button id="login-btn-desktop" class="login-btn">Accedi</button>
      <div class="user-dropdown" id="userDropdownContainer" style="display: none;">
        <button class="user-btn" id="userBtnTrigger" aria-haspopup="true" aria-expanded="false">
          <span class="user-avatar" id="navbar-avatar"><img src="uploads/icons/default_user.png" alt="User Icon"></span>
          <span class="user-name" id="navbar-username">Utente</span><span class="dropdown-arrow">▼</span>
        </button>
        <div class="dropdown-menu" id="userDropdownMenu">
          <a href="areapersonale.html" id="nav-profilo">Il mio profilo</a>
          <a href="areapersonale.html#prenotazioni" id="nav-mie-prenotazioni">Le mie prenotazioni</a>
          <a href="dashboard.html" id="nav-dashboard" style="display: block;">Dashboard Admin</a>
          <a href="eventiincorsoAdmin.html" id="nav-gestione-eventi-admin" style="display: block;">Gestione Eventi</a>
          <a href="#" id="logout-link-desktop">Esci</a>
        </div>
      </div>
      <button class="hamburger" id="hamburgerBtn" aria-label="Toggle menu" aria-expanded="false">☰</button>
    </div>
  </nav>
  <div class="mobile-menu" id="mobileMenu">
    <a href="eventiincorso.html" id="mobile-nav-calendario">Calendario attività</a>
    <a href="eventipassati.html" id="mobile-nav-archivio">Archivio attività</a>
    <a href="incontrisullaparola.html" id="mobile-nav-incontri">Incontri sulla parola</a>
    <a href="dovesiamo.html" id="mobile-nav-dovesiamo">Dove siamo</a>
    <a href="contatti.html" id="mobile-nav-contatti">Contatti</a>
    <hr id="mobile-menu-separator" style="border-color: rgba(255,255,255,0.1); display:none;">
    <a href="#" id="login-btn-mobile">Accedi</a>
    <a href="areapersonale.html" id="mobile-nav-profilo" style="display: none;">Il mio profilo</a>
    <a href="areapersonale.html#prenotazioni" id="mobile-nav-mie-prenotazioni" style="display: none;">Le mie prenotazioni</a>
    <a href="dashboard.html" id="mobile-nav-dashboard" style="display: none;">Dashboard Admin</a>
    <a href="eventiincorsoAdmin.html" id="mobile-nav-gestione-eventi-admin" style="display: none;">Gestione Eventi</a>
    <a href="#" id="mobile-logout-link" style="display: none;">Esci</a>
  </div>
</header>

<main>
  <div class="container section-padding">
    <h1 id="mainPageTitle">Calendario Attività</h1>

    <div class="add-event-btn-container-wrapper" id="addEventFabContainerWrapper" style="display:none;">
      <button id="adminAddEventBtn" aria-label="Aggiungi Nuovo Evento">
        <span class="plus-icon">+</span>
        <span class="fab-text-label">Aggiungi Nuovo Evento</span>
      </button>
    </div>

    <div id="eventiGridContainer">
      <div id="loadingIndicator" class="loading-overlay visible">
        <div class="spinner">
          <div class="bounce1"></div>
          <div class="bounce2"></div>
          <div class="bounce3"></div>
        </div>
        <p>Sto caricando gli eventi...</p>
      </div>
      <div class="card-grid" id="eventiGrid">
      </div>
    </div>
  </div>
</main>

<div class="booking-popup-overlay" id="bookingPopupOverlay"></div>
<div class="booking-popup" id="bookingPopup">
  <button class="close-popup" id="closeBookingPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h2 id="bookingPopupTitle">Prenota Evento</h2>
  <form id="bookingForm">
    <div class="form-content-wrapper">
      <input type="hidden" id="bookingEventId" name="eventId">
      <div class="form-group">
        <label for="numeroPosti">Numero Partecipanti (max <span id="maxSeatsAllowedBooking">5</span>)</label>
        <input type="number" id="numeroPosti" name="numeroPosti" class="form-control" min="1" value="1" required>
        <small id="infoPostiPrenotabili" style="display: block; margin-top: 0.3rem; font-size: 0.85rem;"></small>
      </div>
      <div id="participantFieldsContainer" class="participant-fields-container"></div>
      <div class="form-actions"><button type="submit" class="btn-popup">Conferma Prenotazione</button></div>
    </div>
    <div id="bookingResponseMessage" class="form-message"></div>
    <div id="bookingSuccessAnimation" style="display: none;">
      <svg class="animated-check-icon" viewBox="0 0 52 52">
        <circle class="animated-check-icon__circle" cx="26" cy="26" r="25" fill="none"/>
        <path class="animated-check-icon__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
      </svg>
      <p>Prenotazione completata!</p>
    </div>
  </form>
</div>

<div class="booking-popup-overlay" id="waitlistPopupOverlay"></div>
<div class="booking-popup" id="waitlistPopup">
  <button class="close-popup" id="closeWaitlistPopupBtn" aria-label="Chiudi popup">&times;</button>
  <h2 id="waitlistPopupTitle">Mettiti in Lista d'Attesa</h2>
  <form id="waitlistForm">
    <div class="form-content-wrapper"> <input type="hidden" id="waitlistEventId" name="eventId">
      <p id="waitlistEventInfo" style="text-align:center; margin-bottom:1rem; font-size: 1.1rem; color: var(--primary);"></p>
      <div class="form-group">
        <label for="waitlistNumeroPosti">Numero posti richiesti (max <span id="maxSeatsAllowedWaitlist">5</span>)</label>
        <input type="number" id="waitlistNumeroPosti" name="numeroPosti" class="form-control" min="1" value="1" required>
        <small id="infoPostiCoda" style="display: block; margin-top: 0.3rem; font-size: 0.85rem;"></small>
      </div>
      <div class="form-actions"><button type="submit" class="btn-popup">Mettiti in Coda</button></div>
    </div>
    <div id="waitlistResponseMessage" class="form-message"></div> <div id="waitlistSuccessAnimation" style="display: none;"> <svg class="animated-check-icon" viewBox="0 0 52 52">
    <circle class="animated-check-icon__circle" cx="26" cy="26" r="25" fill="none"/>
    <path class="animated-check-icon__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
  </svg>
    <p>Richiesta inviata!</p>
  </div>
  </form>
</div>

<div class="dash-admin-event-popup-overlay" id="dashAdminEventPopupOverlay"></div>
<div class="dash-admin-event-popup" id="dashAdminEventPopup">
  <div class="dash-admin-event-popup-header">
    <h2 id="dashAdminEventPopupTitle">Aggiungi Nuovo Evento</h2>
    <button class="close-popup" id="closeDashAdminEventPopupBtn" aria-label="Chiudi popup">&times;</button>
  </div>
  <div class="dash-admin-event-popup-content">
    <div id="creationModeSelectionView">
      <div class="creation-mode-option" id="createManuallyModeBtn">
        <div class="icon-container"><i class="fas fa-edit"></i></div>
        <h4>Crea Manualmente</h4>
        <p>Inserisci tutti i dettagli dell'evento compilando il modulo.</p>
      </div>
      <div class="creation-mode-option" id="extractFromFlyerModeBtn">
        <div class="icon-container">
                <span class="ai-logo-text">
                    <span class="line-1">Eremo</span>
                    <span class="line-2">Vision AI</span>
                </span>
          <span class="star s1"></span><span class="star s2"></span><span class="star s3"></span>
          <span class="star s4"></span><span class="star s5"></span><span class="star s6"></span>
        </div>
        <h4>Estrai da Volantino</h4>
        <p>Carica un volantino e lascia che l'AI compili i campi per te.</p>
      </div>
    </div>

    <div id="flyerUploadView">
      <h4>Carica Volantino Evento</h4>
      <div class="form-group">
        <label for="flyerFile">Seleziona immagine volantino (JPG, PNG, WEBP):</label>
        <input type="file" id="flyerFile" class="form-control" accept="image/jpeg, image/png, image/webp">
      </div>
      <div id="flyerPreviewContainer">
        <img id="flyerPreview" src="#" alt="Anteprima Volantino" />
      </div>
      <button type="button" id="processFlyerBtn" class="btn-popup" disabled><i class="fas fa-cogs"></i> Processa Volantino con AI</button>
      <div id="flyerProcessingStatus"></div>
    </div>

    <div class="dash-admin-event-form-and-preview-container">
      <form id="dashAdminEventForm" method="POST" enctype="multipart/form-data">
        <input type="hidden" id="dashAdmin-event-id" name="event-id">

        <div class="form-group">
          <label for="dashAdmin-event-title">Titolo Evento*</label>
          <input type="text" id="dashAdmin-event-title" name="event-title" class="form-control" required>
        </div>

        <div class="form-group">
          <label for="dashAdmin-event-date">Data Inizio*</label>
          <input type="date" id="dashAdmin-event-date" name="event-date" class="form-control" required>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="dashAdmin-event-start-time">Orario Inizio (HH:MM)</label>
            <input type="time" id="dashAdmin-event-start-time" name="event-start-time" class="form-control">
          </div>
          <div class="form-group">
            <label for="dashAdmin-event-end-time">Orario Fine (HH:MM)</label>
            <input type="time" id="dashAdmin-event-end-time" name="event-end-time" class="form-control">
          </div>
        </div>

        <div class="form-group">
          <label for="dashAdmin-event-long-desc">Descrizione Estesa</label>
          <textarea id="dashAdmin-event-long-desc" name="event-long-desc" class="form-control" rows="4"></textarea>
        </div>

        <div class="form-group ai-generate-btn-container">
          <label for="dashAdmin-event-short-desc">Descrizione Breve* (max 200 caratteri)</label>
          <button type="button" id="generateShortDescBtn" class="ai-generate-btn" title="Genera descrizione breve con AI">
            <span class="ai-btn-content-wrapper">
                <span class="ai-icon">✨</span>
                <span class="ai-text">Genera con AI</span>
            </span>
            <span class="ai-ripple-container"></span>
            <span class="ai-spinner-container">
                <span class="spinner-mini"></span>
                <span class="ai-loading-text">Genero...</span>
            </span>
          </button>
          <textarea id="dashAdmin-event-short-desc" name="event-short-desc" class="form-control" rows="2" required maxlength="200"></textarea>
          <small id="aiShortDescStatus" style="font-size: 0.75rem; color: var(--gray-dark); display: block; margin-top: 2px; height: 1em;"></small>
        </div>


        <div class="form-grid">
          <div class="form-group">
            <label for="dashAdmin-event-prefix">Prefisso Relatore</label>
            <input type="text" id="dashAdmin-event-prefix" name="event-prefix" class="form-control" placeholder="Default: Relatore">
          </div>
          <div class="form-group">
            <label for="dashAdmin-event-speaker">Nome Relatore*</label>
            <input type="text" id="dashAdmin-event-speaker" name="event-speaker" class="form-control" required>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="dashAdmin-event-association">Associazione</label>
            <input type="text" id="dashAdmin-event-association" name="event-association" class="form-control">
          </div>
          <div class="form-group">
            <label for="dashAdmin-event-seats">Posti Disponibili Iniziali*</label>
            <input type="number" id="dashAdmin-event-seats" name="event-seats" class="form-control" required min="0">
          </div>
        </div>

        <div class="form-group">
          <label for="dashAdmin-event-image">Immagine Copertina</label>
          <input type="file" id="dashAdmin-event-image" name="event-image" class="form-control" accept="image/*">
          <small>Lascia vuoto se non vuoi modificare l'immagine esistente.</small>
          <img id="dashAdmin-current-event-image-preview" src="#" alt="Anteprima Immagine">
        </div>

        <div class="form-group">
          <label for="dashAdmin-event-flyer">Volantino (PDF/Immagine)</label>
          <input type="file" id="dashAdmin-event-flyer" name="event-flyer" class="form-control" accept="image/*,application/pdf">
          <small>Lascia vuoto se non vuoi modificare il volantino esistente.</small>
          <div id="dashAdmin-current-event-flyer-preview">
          </div>
        </div>

        <div class="form-check-group">
          <input type="checkbox" id="dashAdmin-event-booking" name="event-booking" checked>
          <label for="dashAdmin-event-booking">Prenotazioni aperte</label>
        </div>

        <div class="form-check-group">
          <input type="checkbox" id="dashAdmin-event-voluntary" name="event-voluntary">
          <label for="dashAdmin-event-voluntary">Offerta libera</label>
        </div>

        <div class="form-group" id="dashAdmin-event-price-container" style="display: block;">
          <label for="dashAdmin-event-price">Prezzo (€)</label>
          <input type="number" id="dashAdmin-event-price" name="event-price" class="form-control" min="0" step="0.01" placeholder="Es. 10.00">
        </div>

        <div id="dashAdminEventFormMessage" class="form-message" style="display:none;"></div>
        <div class="form-actions">
          <button type="submit" class="btn-popup">Salva Evento</button>
        </div>
      </form>

      <div id="dashAdminEventCardPreviewContainer">
        <h4>Anteprima Card Evento</h4>
        <div class="dash-admin-preview-card">
          <div class="dash-admin-preview-card-image-container">
            <img id="dashAdmin_previewImage" src="images/default-event.jpg" alt="Anteprima copertina evento">
            <span class="dash-admin-no-image-placeholder" style="display:none;">Nessuna immagine</span>
          </div>
          <div class="dash-admin-preview-card-content">
            <h5 id="dashAdmin_previewTitle">Titolo Evento</h5>
            <p id="dashAdmin_previewDateFull"><b>Data:</b> <span class="value">Seleziona data</span></p>
            <p id="dashAdmin_previewTimeFull" style="display:none;"><b>Orario:</b> <span class="value"></span></p>
            <p id="dashAdmin_previewSpeakerFull" class="dash-admin-preview-relatore"><b><span id="dashAdmin_previewSpeakerPrefix">Relatore</span>:</b> <span id="dashAdmin_previewSpeakerName" class="value">Nome Relatore</span></p>
            <p id="dashAdmin_previewShortDesc">Descrizione breve dell'evento qui...</p>
            <p id="dashAdmin_previewSeatsFull" class="dash-admin-preview-posti"><b>Posti:</b> <span class="value">0</span></p>
            <p id="dashAdmin_previewPriceFull" class="dash-admin-preview-costo"><b>Costo:</b> <span class="value">€ 0.00</span></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="custom-confirm-overlay" id="customConfirmOverlay">
  <div class="custom-confirm-modal" id="customConfirmModal">
    <h3 id="customConfirmTitle">Conferma Uscita</h3>
    <p id="customConfirmMessage">Hai modifiche non salvate. Sei sicuro di voler uscire senza salvare?</p>
    <div class="custom-confirm-actions">
      <button type="button" class="btn-popup btn-confirm-no" id="customConfirmNo">Annulla</button>
      <button type="button" class="btn-popup btn-confirm-yes" id="customConfirmYes">Esci</button>
    </div>
  </div>
</div>

<div id="ai-assistant-fab" title="Assistente Virtuale Eremo" data-liquid> <i class="fas fa-headset"></i>
</div>

<div id="ai-chat-popup">
  <div id="ai-chat-header">
    <h3>Assistente Eremo <i class="fas fa-robot"></i></h3>
    <button id="ai-chat-close-btn" aria-label="Chiudi Chat">&times;</button>
  </div>
  <div id="ai-chat-messages">
    <div class="ai-message">Ciao! Sono l'assistente virtuale dell'Eremo. Come posso aiutarti oggi riguardo il sito?</div>
  </div>
  <div id="ai-chat-input-container">
    <textarea id="ai-chat-input" placeholder="Scrivi la tua domanda..." rows="2"></textarea>
    <button id="ai-chat-send-btn" aria-label="Invia Messaggio"><i class="fas fa-paper-plane"></i></button>
  </div>
</div>

<footer>
  <p>© <span id="currentYear"></span> Eremo frate Francesco. OdV Via San Vito 2, Nembro. C.F.:90004060167. Sviluppato da 5AII 2024-2025 Majorana Seriate.</p>
</footer>

<script src="assistenteAI.js" defer></script>
<script src="liquidglass.js" defer></script> <script>
  // === INIZIO SCRIPT UNIFICATO PER EVENTIINCORSO.HTML ===
  // ...
</script>
</body>
</html>
<script>
  // === INIZIO SCRIPT UNIFICATO PER EVENTIINCORSO.HTML ===
  let currentEventsData = [];
  let groqApiKey = null;

  // Elementi DOM per la selezione della modalità di creazione
  let creationModeSelectionViewEl, createManuallyModeBtnEl, extractFromFlyerModeBtnEl;
  // Elementi DOM per il caricamento del volantino
  let flyerUploadViewEl, flyerFileEl, flyerPreviewEl, processFlyerBtnEl, flyerProcessingStatusEl, flyerPreviewContainerEl;

  let adminAddEventBtnEl, dashAdminEventPopupOverlayEl, dashAdminEventPopupEl, closeDashAdminEventPopupBtnEl,
          dashAdminEventFormEl, dashAdminEventPopupTitleEl, dashAdminEventIdInputEl, dashAdminEventTitleEl,
          dashAdminEventDateEl, dashAdminEventStartTimeEl, dashAdminEventEndTimeEl, dashAdminEventShortDescEl,
          dashAdminEventLongDescEl, dashAdminEventPrefixEl, dashAdminEventSpeakerEl, dashAdminEventAssociationEl,
          dashAdminEventSeatsEl, dashAdminEventImageEl, dashAdminEventFlyerEl, dashAdminEventBookingCheckbox,
          dashAdminEventVoluntaryCheckbox, dashAdminEventPriceContainerEl, dashAdminEventPriceInputEl,
          dashAdminEventFormMessageEl, dashAdminCurrentImagePreviewEl, dashAdminCurrentFlyerPreviewEl,
          dashAdminPreviewImageEl, dashAdminPreviewNoImagePlaceholderEl, dashAdminPreviewTitleEl,
          dashAdminPreviewDateFullEl, dashAdminPreviewTimeFullEl, dashAdminPreviewTimeValueEl,
          dashAdminPreviewSpeakerFullEl, dashAdminPreviewSpeakerPrefixEl, dashAdminPreviewSpeakerNameEl,
          dashAdminPreviewShortDescEl, dashAdminPreviewSeatsFullEl, dashAdminPreviewPriceFullEl,
          generateShortDescBtnEl, aiShortDescStatusEl, dashAdminLongDescElForAI;

  let initialAdminEventFormData = {};
  let isEventFormDirty = false;
  let customConfirmOverlayEl, customConfirmModalEl, customConfirmTitleEl, customConfirmMessageEl,
          customConfirmYesBtn, customConfirmNoBtn;
  let confirmResolve = null;

  let globalFlyerOverlayEff = null;
  let currentFlyerModalEff = null;

  let dashAdminFormAndPreviewContainerEl = null;

  function gebi(id) { return document.getElementById(id); }

  async function callApi(url, method = 'GET', data = null) {
    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
    const options = { method, headers, credentials: 'same-origin' };
    if (data && (method === 'POST' || method === 'PUT' || method === 'DELETE')) {
      options.body = JSON.stringify(data);
    }
    try {
      const response = await fetch(url, options);
      if (!response.ok) {
        let errorData = { message: `Errore HTTP ${response.status} (${response.statusText})` };
        let rawErrorText = '';
        try {
          rawErrorText = await response.text();
          errorData = JSON.parse(rawErrorText);
        } catch (e) {
          errorData.message = rawErrorText || errorData.message;
          errorData.rawError = rawErrorText;
        }
        throw new Error(errorData.message || `Errore server: ${response.status}`);
      }
      const contentType = response.headers.get("content-type");
      if (contentType && contentType.indexOf("application/json") !== -1) {
        return response.json();
      } else {
        return response.text().then(text => text ? {success: true, message: text, data: text} : {success: true});
      }
    } catch (error) {
      console.error(`Fallimento API a ${url}:`, error);
      throw error;
    }
  }

  function simpleXorDecryptClient(base64String, key) {
    try {
      const encryptedText = atob(base64String);
      let outText = '';
      for(let i = 0; i < encryptedText.length; i++) {
        outText += String.fromCharCode(encryptedText.charCodeAt(i) ^ key.charCodeAt(i % key.length));
      }
      return outText;
    } catch (e) {
      console.error("Fallimento decifratura API key:", e);
      return null;
    }
  }

  async function fetchAndPrepareGroqApiKey() {
    if (groqApiKey) return true;
    try {
      const result = await callApi('api/get_groq_config.php');
      if (result.success && result.obfuscatedApiKey && result.decryptionKey) {
        const decryptedKey = simpleXorDecryptClient(result.obfuscatedApiKey, result.decryptionKey);
        if (decryptedKey) {
          groqApiKey = decryptedKey;
          console.log("Chiave API Groq pronta per l'uso.");
          return true;
        } else {
          console.error("Fallimento decifratura API Key Groq.");
          if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = "Errore configurazione AI (dec.).";
          if(flyerProcessingStatusEl) flyerProcessingStatusEl.textContent = "Errore configurazione AI (dec.).";
          return false;
        }
      } else {
        console.error('Fallimento recupero componenti API key Groq:', result.message || 'Dati mancanti.');
        if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = "Errore configurazione AI (fetch).";
        if(flyerProcessingStatusEl) flyerProcessingStatusEl.textContent = "Errore configurazione AI (fetch).";
        return false;
      }
    } catch (error) {
      console.error('Errore recupero API key Groq:', error);
      if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = "Errore connessione AI.";
      if(flyerProcessingStatusEl) flyerProcessingStatusEl.textContent = "Errore connessione AI.";
      return false;
    }
  }

  async function callGroqForFlyerExtraction(base64ImageData) {
    if (!groqApiKey) {
      const keyReady = await fetchAndPrepareGroqApiKey();
      if (!keyReady) {
        return { success: false, error: "Chiave API Groq non disponibile." };
      }
    }

    const groqApiUrl = 'https://api.groq.com/openai/v1/chat/completions';
    const flyerPrompt = `Analizza l'immagine del volantino fornita e estrai le seguenti informazioni strutturate.
Formatta l'output ESCLUSIVAMENTE come un oggetto JSON valido. Non includere testo prima o dopo l'oggetto JSON.
Se un'informazione non è chiaramente presente o deducibile, usa 'null' per il valore del campo corrispondente.

Schema JSON richiesto:
{
  "titolo": "string | null",
  "data_inizio": "YYYY-MM-DD | null (es. '2024-07-20')",
  "ora_inizio": "HH:MM | null (es. '09:30')",
  "ora_fine": "HH:MM | null (es. '17:00', se non specificata, usa null)",
  "relatore_prefisso": "string | null (es. 'Don', 'Suor', 'Prof.', 'Dott.')",
  "relatore_nome": "string | null (nome completo del relatore/i)",
  "associazione": "string | null (nome dell'associazione organizzatrice, se presente)",
  "descrizione_breve_generata": "string (massimo 180 caratteri, concisa e informativa, basata sui contenuti principali)",
  "descrizione_estesa_generata": "string (più dettagliata, riassumendo i temi e le attività principali descritte nel volantino)",
  "posti_disponibili": "number | null (se indicato un numero esatto di posti)",
  "costo": "number | null (es. 25.00. Se 'offerta libera' o 'ingresso gratuito con offerta', imposta a 0.00. Se solo 'ingresso gratuito' senza menzione di offerta, usa null o 0.00 a seconda del contesto. Se non menzionato, usa null)",
  "flag_prenotabile": "boolean (true se il volantino indica la necessità o possibilità di prenotare/iscriversi, altrimenti false)",
  "flag_offerta_libera": "boolean (true se esplicitamente menzionato 'offerta libera', 'ingresso a offerta', etc.)"
}

Interpreta le date e gli orari nel modo più accurato possibile. Per 'costo', se è 'offerta libera', assicurati che 'flag_offerta_libera' sia true e 'costo' sia 0.00.
La 'descrizione_breve_generata' deve essere un riassunto molto conciso.
La 'descrizione_estesa_generata' può essere più lunga ma deve rimanere un riassunto del contenuto del volantino.
Non aggiungere commenti o spiegazioni al di fuori dell'oggetto JSON.`;

    const payload = {
      messages: [
        {
          role: "user",
          content: [
            { type: "text", text: flyerPrompt },
            {
              type: "image_url",
              image_url: { url: `data:image/jpeg;base64,${base64ImageData}` }
            }
          ]
        }
      ],
      model: "meta-llama/llama-4-scout-17b-16e-instruct",
      temperature: 0.2,
      max_tokens: 2500,
    };

    try {
      const response = await fetch(groqApiUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${groqApiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        const errorText = await response.text();
        let errorData;
        try {
          errorData = JSON.parse(errorText);
        } catch (e) {
          errorData = { error: { message: errorText || response.statusText }};
        }
        console.error("Errore API Groq per estrazione da volantino:", response.status, errorData);
        return { success: false, error: `Errore AI (${response.status}): ${errorData.error?.message || 'Servizio non raggiungibile'}` };
      }
      const data = await response.json();
      if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
        let content = data.choices[0].message.content;
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch && jsonMatch[0]) {
          try {
            const extractedJson = JSON.parse(jsonMatch[0]);
            return { success: true, data: extractedJson };
          } catch (e) {
            console.error("Errore parsing JSON estratto da Groq:", e, "\nContenuto ricevuto ripulito:", jsonMatch[0], "\nContenuto originale:", content);
            return { success: false, error: "Risposta AI non è un JSON valido dopo pulizia." };
          }
        } else {
          try {
            const extractedJson = JSON.parse(content);
            return { success: true, data: extractedJson };
          } catch (e) {
            console.warn("Nessun JSON valido trovato nella risposta Groq per volantino, né grezza né pulita:", content);
            return { success: false, error: "Risposta AI non contiene un oggetto JSON interpretabile." };
          }
        }
      } else {
        console.warn("Struttura risposta Groq non valida per estrazione da volantino:", data);
        return { success: false, error: "Risposta AI non valida (struttura)." };
      }
    } catch (error) {
      console.error('Errore chiamata API Groq per estrazione da volantino:', error);
      return { success: false, error: "Errore comunicazione con servizio AI per estrazione." };
    }
  }


  async function generateShortDescriptionAI(longDescription) {
    if (!groqApiKey) {
      const keyReady = await fetchAndPrepareGroqApiKey();
      if (!keyReady || !groqApiKey) {
        console.error("API Key Groq non disponibile per la generazione della descrizione.");
        return { success: false, description: null, error: "Chiave API per AI non disponibile." };
      }
    }

    if (!longDescription || longDescription.trim().length < 20) {
      return { success: false, description: null, error: "La descrizione estesa è troppo corta per generare un riassunto." };
    }

    const groqApiUrl = 'https://api.groq.com/openai/v1/chat/completions';
    const promptSystem = "Sei un assistente AI specializzato nella creazione di contenuti per eventi. Data una descrizione estesa, il tuo compito è generare una descrizione breve, concisa e accattivante, ideale per essere visualizzata su una card promozionale dell'evento. La descrizione breve non deve superare i 190 caratteri. Rispondi solo con la descrizione breve generata, senza alcuna introduzione o testo aggiuntivo.";

    const payload = {
      "messages": [
        { "role": "system", "content": promptSystem },
        { "role": "user", "content": `Descrizione estesa da riassumere:\n\n${longDescription}` }
      ],
      "model": "meta-llama/llama-4-scout-17b-16e-instruct",
      "temperature": 0.7,
      "max_tokens": 70,
      "top_p": 1,
      "stream": false
    };

    try {
      const response = await fetch(groqApiUrl, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${groqApiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
        console.error("Errore API Groq per descrizione:", response.status, errorData);
        return { success: false, description: null, error: `Errore AI (${response.status}): ${errorData.error?.message || 'Servizio non raggiungibile'}` };
      }

      const data = await response.json();
      if (data.choices && data.choices.length > 0 && data.choices[0].message && data.choices[0].message.content) {
        let generatedText = data.choices[0].message.content.trim();
        generatedText = generatedText.replace(/^["']|["']$/g, "");
        return { success: true, description: generatedText, error: null };
      } else {
        console.warn("Struttura risposta Groq non valida per descrizione (non-streaming):", data);
        return { success: false, description: null, error: "Risposta AI non valida (struttura)." };
      }
    } catch (error) {
      console.error('Errore chiamata API Groq per descrizione:', error);
      return { success: false, description: null, error: "Errore comunicazione con servizio AI." };
    }
  }

  let lastScrollNav = 0; const navbarContainerEl = gebi("navbarContainer"); if (navbarContainerEl) { window.addEventListener("scroll", function () { const cS = window.pageYOffset || document.documentElement.scrollTop; if (cS <= 50) { navbarContainerEl.classList.remove("hidden"); lastScrollNav = 0; return; } if (cS > lastScrollNav && !navbarContainerEl.classList.contains("hidden")) navbarContainerEl.classList.add("hidden"); else if (cS < lastScrollNav && navbarContainerEl.classList.contains("hidden")) navbarContainerEl.classList.remove("hidden"); lastScrollNav = cS <= 0 ? 0 : cS; }, false); }
  const mobileMenuEl = gebi("mobileMenu"); const hamburgerButton = gebi("hamburgerBtn"); function toggleMobileMenu() { if (mobileMenuEl && hamburgerButton) { const iO = mobileMenuEl.classList.toggle("open"); hamburgerButton.setAttribute("aria-expanded", String(iO)); document.body.style.overflow = iO ? "hidden" : ""; } } function closeMobileMenuOnLinkClick() { if (mobileMenuEl && hamburgerButton && mobileMenuEl.classList.contains("open")) { mobileMenuEl.classList.remove("open"); hamburgerButton.setAttribute("aria-expanded", "false"); document.body.style.overflow = ""; } } if (hamburgerButton) hamburgerButton.addEventListener("click", toggleMobileMenu); document.querySelectorAll("#mobileMenu a").forEach(l => { if (l.id !== 'login-btn-mobile' && l.id !== 'mobile-logout-link' && l.id !== 'mobile-nav-gestione-eventi-admin') l.addEventListener("click", closeMobileMenuOnLinkClick); }); document.addEventListener("click", function (e) { if (mobileMenuEl && mobileMenuEl.classList.contains("open") && hamburgerButton && !mobileMenuEl.contains(e.target) && !hamburgerButton.contains(e.target)) toggleMobileMenu(); });
  const userBtnTriggerEl = gebi('userBtnTrigger'); const userDropdownMenuEl = gebi('userDropdownMenu'); if (userBtnTriggerEl && userDropdownMenuEl) { userBtnTriggerEl.addEventListener('click', function (e) { e.stopPropagation(); const iO = userDropdownMenuEl.style.display === 'block'; userDropdownMenuEl.style.display = iO ? 'none' : 'block'; this.setAttribute('aria-expanded', String(!iO)); }); document.addEventListener('click', function (e) { if (userDropdownMenuEl.style.display === 'block' && !userBtnTriggerEl.contains(e.target) && !userDropdownMenuEl.contains(e.target)) { userDropdownMenuEl.style.display = 'none'; userBtnTriggerEl.setAttribute('aria-expanded', 'false'); } }); }

  function initGlobalFlyerOverlay() {
    if (!document.getElementById('globalFlyerOverlayEff')) {
      const overlay = document.createElement('div');
      overlay.id = 'globalFlyerOverlayEff';
      overlay.className = 'flyer-overlay-eff';
      document.body.appendChild(overlay);
      globalFlyerOverlayEff = overlay;
      globalFlyerOverlayEff.addEventListener('click', (e) => {
        if (e.target === globalFlyerOverlayEff) hideFlyerPopupEff();
      });
    } else {
      globalFlyerOverlayEff = document.getElementById('globalFlyerOverlayEff');
    }
  }
  function showFlyerPopupEff(volantinoUrl) {
    if (!globalFlyerOverlayEff) return;
    if (currentFlyerModalEff) currentFlyerModalEff.remove();
    document.body.classList.add("flyer-popup-active-eff");
    globalFlyerOverlayEff.classList.add("active");
    currentFlyerModalEff = document.createElement("article");
    currentFlyerModalEff.className = "flyer-modal-eff";
    let flyerContentHTML = '';
    const sanitizedUrl = typeof sanitizeForAttribute === 'function' ? sanitizeForAttribute(volantinoUrl) : volantinoUrl;
    if (volantinoUrl && volantinoUrl.trim() !== "") {
      if (volantinoUrl.match(/\.(jpeg|jpg|gif|png|webp|svg)$/i)) {
        flyerContentHTML = `<img src="${sanitizedUrl}" alt="Volantino Evento">`;
      } else if (volantinoUrl.endsWith('.pdf')) {
        flyerContentHTML = `<iframe src="${sanitizedUrl}" type="application/pdf" title="Volantino PDF"></iframe>`;
      } else {
        flyerContentHTML = `<div class="flyer-message-display-eff"><p>Il volantino è disponibile come file esterno.</p><a href="${sanitizedUrl}" target="_blank" rel="noopener noreferrer">Visualizza Volantino</a></div>`;
      }
    } else {
      flyerContentHTML = `<div class="flyer-message-display-eff"><p>Volantino non disponibile.</p></div>`;
    }
    currentFlyerModalEff.innerHTML = `
      <button class="flyer-close-btn-eff" aria-label="Chiudi">&times;</button>
      <div class="flyer-content-area-eff">
          <div class="flyer-media-container-eff">${flyerContentHTML}</div>
      </div>`;
    globalFlyerOverlayEff.appendChild(currentFlyerModalEff);
    const closeBtn = currentFlyerModalEff.querySelector('.flyer-close-btn-eff');
    if (closeBtn) { closeBtn.onclick = hideFlyerPopupEff; closeBtn.focus(); }
  }
  function hideFlyerPopupEff() {
    if (globalFlyerOverlayEff) globalFlyerOverlayEff.classList.remove("active");
    if (currentFlyerModalEff) {
      currentFlyerModalEff.addEventListener('transitionend', function handleTransitionEnd(event) {
        if (event.propertyName === 'opacity' && currentFlyerModalEff && !globalFlyerOverlayEff.classList.contains('active')) {
          currentFlyerModalEff.remove(); currentFlyerModalEff = null;
          event.target.removeEventListener('transitionend', handleTransitionEnd);
        }
      });
      if (currentFlyerModalEff && !globalFlyerOverlayEff.classList.contains('active')) {
        setTimeout(() => {
          if (currentFlyerModalEff && !globalFlyerOverlayEff.classList.contains('active')) {
            currentFlyerModalEff.remove(); currentFlyerModalEff = null;
          }
        }, 450);
      }
    }
    document.body.classList.remove("flyer-popup-active-eff");
  }

  const MAX_SEATS_PER_BOOKING = 5; const MAX_TOTAL_SEATS_PER_USER = 5;

  async function loadEvents() {
    const eventsGrid = gebi("eventiGrid"); const loadingIndicator = gebi("loadingIndicator");
    if (loadingIndicator) loadingIndicator.style.display = 'flex'; if (eventsGrid) eventsGrid.innerHTML = ""; currentEventsData = [];
    try {
      let apiUrl = 'get_events.php';
      if (currentUserData && currentUserData.isAdmin) apiUrl = 'get_events.php?admin_view=true';
      else if (currentUserData && currentUserData.email) apiUrl += `?user_email=${encodeURIComponent(currentUserData.email)}`;
      const response = await fetch(apiUrl); const responseText = await response.text();
      if (!response.ok) throw new Error(`Errore HTTP ${response.status}: ${responseText.substring(0, 100)}`);
      let result; try { result = JSON.parse(responseText); } catch (e) { throw new Error("Risposta server non JSON."); }
      if (!result.success) throw new Error(result.message || "Caricamento eventi fallito."); if (!eventsGrid) return;
      if (result.data) {
        currentEventsData = result.data;
        if (result.data.length === 0) {
          eventsGrid.innerHTML = `<p class="no-events">Nessun evento ${(currentUserData && currentUserData.isAdmin) ? 'presente. Clicca "Aggiungi Nuovo Evento" per crearne uno.' : 'in programma al momento.'}</p>`;
        } else {
          currentEventsData.forEach((event) => eventsGrid.appendChild(createEventCard(event)));
        }
      } else {
        eventsGrid.innerHTML = '<p class="no-events">Nessun dato evento ricevuto.</p>';
      }
    } catch (error) { console.error("Errore loadEvents:", error); if (eventsGrid) eventsGrid.innerHTML = `<div class="error-message" style="width:100%;"><p><strong>Errore:</strong> ${error.message}</p><button onclick="loadEvents()" class="btn-popup">Riprova</button></div>`; }
    finally { if (loadingIndicator) loadingIndicator.style.display = 'none'; }
  }

function createEventCard(event) {
    const card = document.createElement("article");
    card.className = "card";
    card.dataset.eventId = event.idevento;
    let imageSrc = event.immagine_url?.trim() ? event.immagine_url : "images/default-event.jpg";

    // --- NUOVA LOGICA PER IL BANNER "ANNULLATO" ---
    let watermarkHTML = '';
    if (event.stato === 'cancellato') {
        card.classList.add('event-cancelled');
        watermarkHTML = '<div class="cancelled-watermark">ANNULLATO</div>';
    }
    // --- FINE NUOVA LOGICA ---

    // --- LOGICA PER LE "PILLOLE" INFORMATIVE GENERALI ---
    let infoPillsHTML = '<div class="card-info-pills">';
    if (event.datainizio) {
        infoPillsHTML += `<span class="info-pill"><i class="fas fa-calendar-alt"></i> ${formatDate(event.datainizio)}</span>`;
    }
    if (event.durata) {
        infoPillsHTML += `<span class="info-pill"><i class="fas fa-clock"></i> ${sanitizeText(event.durata)}</span>`;
    }
    if (event.relatore) {
        infoPillsHTML += `<span class="info-pill"><i class="fas fa-user"></i> ${sanitizeText(event.prefisso_relatore) || 'Relatore'}: ${sanitizeText(event.relatore)}</span>`;
    }
    if (event.associazione) {
        infoPillsHTML += `<span class="info-pill"><i class="fas fa-users"></i> ${sanitizeText(event.associazione)}</span>`;
    }
    infoPillsHTML += '</div>';
    
    if (currentUserData && currentUserData.isAdmin) {
      card.classList.add('admin-card');
      let volantinoAdminLinkHTML = event.volantino_url?.trim() ? `<p class="card-info" style="font-size:0.9em; margin-bottom: 0.5rem;"><b>Volantino:</b> <a href="${sanitizeForAttribute(event.volantino_url)}" target="_blank" title="Visualizza il volantino dell'evento">Visualizza Volantino</a></p>` : '';
      
      // --- MODIFICA BOTTONI ADMIN PER EVENTO ANNULLATO ---
      let adminButtonsHTML = '';
      if (event.stato === 'cancellato') {
          adminButtonsHTML = `<button class="card-btn btn-edit card-btn-secondary" data-event-id="${event.idevento}">Modifica</button>
                              <button class="card-btn card-btn-primary" disabled>Annullato</button>`;
      } else {
          adminButtonsHTML = `<button class="card-btn btn-edit card-btn-secondary" data-event-id="${event.idevento}">Modifica</button>
                              <button class="card-btn btn-delete card-btn-primary" data-event-id="${event.idevento}">Elimina</button>`;
      }
      
      card.innerHTML = `
            ${watermarkHTML} 
            <div class="card-image-container"><img src="${imageSrc}" alt="Copertina: ${sanitizeForAttribute(event.titolo) || "Evento"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';"></div>
            <div class="card-content">
                <h3>${sanitizeText(event.titolo) || "Titolo non disponibile"}</h3>
                ${infoPillsHTML}
                <p class="card-description" style="font-size:0.95em; min-height: auto;">${sanitizeText(event.descrizione) || "Nessuna descrizione."}</p>
                <p class="card-info" style="margin-bottom: 0.5rem;">
                    <b>Posti Disponibili:</b> <span class="posti-disponibili">${event.posti_disponibili !== null ? event.posti_disponibili : 'N/D'}</span>
                    ${event.costo !== null ? (parseFloat(event.costo) > 0 ? `<br><b>Costo:</b> ${parseFloat(event.costo).toFixed(2)} ` : (parseFloat(event.costo) === 0.00 ? "<br><b>Costo:</b> Offerta libera" : "")) : ""}
                </p>
                <p class="card-info" style="margin-bottom: 0.5rem;"><b>Prenotazioni:</b> ${parseInt(event.flagprenotabile) === 1 ? '<span class="status-prenotabile">Aperte</span>' : '<span class="status-non-prenotabile">Chiuse</span>'}</p>
                ${volantinoAdminLinkHTML}
                <div class="card-actions admin-actions">${adminButtonsHTML}</div>
            </div>`;
      card.querySelector('.btn-edit').addEventListener('click', function() {
        const eventToEdit = currentEventsData.find(e => e.idevento == this.dataset.eventId);
        if (eventToEdit) openDashAdminEventPopup(eventToEdit);
        else alert("Dettagli evento non trovati per la modifica.");
      });
      // Solo se il pulsante delete esiste, aggiungi l'handler
      const deleteBtn = card.querySelector('.btn-delete');
      if(deleteBtn) {
        deleteBtn.addEventListener('click', function() { handleDeleteEvent(this.dataset.eventId); });
      }
    } else {
      const postiDispEv = parseInt(event.posti_disponibili) || 0; const pGiaPrenUt = parseInt(event.posti_gia_prenotati_utente) || 0;
      const inCodaPerP = parseInt(event.in_coda_per_posti) || 0; const flagPrenDB = parseInt(event.flagprenotabile) === 1;
      
      let statusPillsHTML = '<div class="card-status-info">';
      let postiClass = 'posti'; let postiText = '';
      if (event.stato === 'cancellato') { // Aggiunto controllo stato
          postiText = 'Annullato'; postiClass += ' sold-out';
      } else if (!flagPrenDB) {
          postiText = 'Pren. Chiuse'; postiClass += ' sold-out';
      } else if (postiDispEv > 0) {
          postiText = `${postiDispEv} Posti Disp.`;
          if (postiDispEv <= 5) postiClass += ' low-seats';
      } else {
          postiText = 'Esaurito'; postiClass += ' sold-out';
      }
      statusPillsHTML += `<span class="status-pill ${postiClass}"><i class="fas fa-chair"></i> ${postiText}</span>`;
      if (event.costo !== null) {
          let costoText = parseFloat(event.costo) > 0 ? ` ${parseFloat(event.costo).toFixed(2)}` : 'Offerta libera';
          statusPillsHTML += `<span class="status-pill costo"><i class="fas fa-euro-sign"></i> ${costoText}</span>`;
      }
      if (currentUserData) {
          if (pGiaPrenUt > 0) statusPillsHTML += `<span class="status-pill user-info"><i class="fas fa-user-check"></i> ${pGiaPrenUt} Posti tuoi</span>`;
          if (inCodaPerP > 0) statusPillsHTML += `<span class="status-pill user-info"><i class="fas fa-user-clock"></i> In coda per ${inCodaPerP}</span>`;
      }
      statusPillsHTML += '</div>';

      let primaryBtnHTML = '', volantinoBtnHTML = "";
      if (event.volantino_url?.trim()) { volantinoBtnHTML = `<button class="card-btn btn-visualizza-volantino card-btn-secondary" data-volantino-url="${sanitizeForAttribute(event.volantino_url)}">Volantino</button>`; }
      else { volantinoBtnHTML = `<button class="card-btn card-btn-secondary btn-visualizza-volantino" data-volantino-url="">Dettagli</button>`; }
      
      // --- MODIFICA BOTTONE UTENTE PER EVENTO ANNULLATO ---
      if (event.stato === 'cancellato') {
          primaryBtnHTML = `<button class="card-btn card-btn-primary" disabled>Annullato</button>`;
      } else if (!flagPrenDB) {
          primaryBtnHTML = `<button class="card-btn card-btn-primary" disabled title="Prenotazioni chiuse">(Pren. Chiuse)</button>`;
      } else if (pGiaPrenUt >= MAX_TOTAL_SEATS_PER_USER) {
          primaryBtnHTML = `<button class="card-btn card-btn-primary btn-prenota" disabled title="Max ${MAX_TOTAL_SEATS_PER_USER} posti totali.">Max Posti (${pGiaPrenUt})</button>`;
      } else if (inCodaPerP > 0) {
          primaryBtnHTML = `<button class="card-btn card-btn-primary btn-prenota" disabled title="Sei in coda per ${inCodaPerP} posti.">In Lista d'Attesa</button>`;
      } else if (postiDispEv > 0) {
          primaryBtnHTML = `<button class="card-btn card-btn-primary btn-prenota" data-action="book" data-event-id="${event.idevento}" data-event-title="${sanitizeForAttribute(event.titolo || '')}" data-posti-disponibili-evento="${postiDispEv}" data-posti-gia-prenotati-utente="${pGiaPrenUt}">Prenota</button>`;
      } else {
          primaryBtnHTML = `<button class="card-btn card-btn-primary btn-prenota" data-action="waitlist" data-event-id="${event.idevento}" data-event-title="${sanitizeForAttribute(event.titolo || '')}" data-posti-gia-prenotati-utente="${pGiaPrenUt}">Mettiti in Coda</button>`;
      }
      
      card.innerHTML = `${watermarkHTML} <div class="card-image-container"><img src="${imageSrc}" alt="Copertina: ${sanitizeForAttribute(event.titolo) || "Evento"}" class="card-image" loading="lazy" onerror="this.onerror=null;this.src='images/default-event-error.jpg';"></div>
        <div class="card-content">
            <h3>${sanitizeText(event.titolo) || "Titolo non disponibile"}</h3>
            ${infoPillsHTML}
            <p class="card-description">${sanitizeText(event.descrizione) || "Nessuna descrizione."}</p>
            ${statusPillsHTML}
            <div class="card-actions">${volantinoBtnHTML}${primaryBtnHTML}</div>
        </div>`;
      const actionBtn = card.querySelector('.btn-prenota'); if (actionBtn && !actionBtn.disabled) { actionBtn.addEventListener('click', function () { const act = this.dataset.action; const eId = this.dataset.eventId; const eTitle = this.dataset.eventTitle; const pDisp = parseInt(this.dataset.postiDisponibiliEvento); const pGiaPren = parseInt(this.dataset.postiGiaPrenotatiUtente); if (!currentUserData) { openLoginPopup(); localStorage.setItem("pending_action_eff", JSON.stringify({ action: act, eventId: eId, eventTitle: eTitle, postiDisp: pDisp, postiGiaPren: pGiaPren })); return; } if (act === 'book') { if (typeof window.openBookingPopup === 'function') window.openBookingPopup(eId, eTitle, pDisp, pGiaPren); } else if (act === 'waitlist') { if (typeof window.openWaitlistPopup === 'function') window.openWaitlistPopup(eId, eTitle, pGiaPren); } }); }
      const viewFlyerBtn = card.querySelector(".btn-visualizza-volantino");
      if (viewFlyerBtn) viewFlyerBtn.addEventListener("click", function () { if (typeof showFlyerPopupEff === 'function') showFlyerPopupEff(this.dataset.volantinoUrl); });
    }
    return card;
  }


  function formatDate(dateString) {
    if (!dateString) return "Data non disponibile";
    try {
      const normalizedDateString = dateString.length === 10 ? dateString + "T00:00:00Z" : dateString.replace(" ", "T") + (dateString.endsWith("Z") ? "" : "Z");
      const date = new Date(normalizedDateString);
      if (isNaN(date.getTime())) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateString.substring(0,10))) {
          const parts = dateString.substring(0,10).split('-');
          const utcDate = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
          if (!isNaN(utcDate.getTime())) return utcDate.toLocaleDateString("it-IT", { day: "numeric", month: "long", year: "numeric", timeZone: 'UTC' });
        } return dateString;
      }
      return date.toLocaleDateString("it-IT", { day: "numeric", month: "long", year: "numeric", timeZone: 'UTC' });
    } catch (e) { return dateString; }
  }
  function formatSimpleDateForPreview(dateString) {
    if (!dateString) return 'Seleziona data';
    try {
      const parts = dateString.split('-');
      if (parts.length === 3) return `${parts[2]}/${parts[1]}/${parts[0]}`;
      return dateString;
    } catch (e) { return dateString; }
  }

  async function loadNavbarLogo() {
    const logoImgTag = document.getElementById('navbarLogoImgTag');
    if (!logoImgTag) {
      console.error("Elemento immagine logo navbar (<img id='navbarLogoImgTag'>) non trovato in eventiincorso.html.");
      return;
    }

    // Percorso del logo di default/fallback se il caricamento dinamico fallisce
    const defaultLogoPath = 'images/Logo_eremo.png'; // Assicurati che questo percorso sia corretto

    try {
      // Chiamiamo l'API per ottenere i contenuti della pagina 'index',
      // perché è lì che viene gestito il 'navbarLogo'.
      const response = await fetch('api_get_page_content.php?page=index');
      if (!response.ok) {
        throw new Error(`Errore HTTP ${response.status} nel caricare i contenuti della pagina 'index' per il logo.`);
      }
      const data = await response.json();

      if (data.success && data.contents && data.contents.navbarLogo) {
        logoImgTag.src = data.contents.navbarLogo;
      } else {
        console.warn("URL del logo navbar non trovato nei dati della pagina 'index' o errore API. Uso il logo di default.");
        logoImgTag.src = defaultLogoPath;
      }
    } catch (error) {
      console.error("Errore nel caricare dinamicamente il logo navbar:", error);
      logoImgTag.src = defaultLogoPath; // Fallback in caso di errore
    }
  }



  function initializeBookingPopupHandlers() {
    const bO = gebi('bookingPopupOverlay'); const bP = gebi('bookingPopup'); const cB = gebi('closeBookingPopupBtn'); const bF = gebi('bookingForm'); const nPI = gebi('numeroPosti'); const pFC = gebi('participantFieldsContainer'); const bEII = gebi('bookingEventId'); const bPT = gebi('bookingPopupTitle'); const bRM = gebi('bookingResponseMessage'); const iPP = gebi('infoPostiPrenotabili'); const mSB = gebi('maxSeatsAllowedBooking');
    const formContentWrapper = bF ? bF.querySelector('.form-content-wrapper') : null;
    const successAnimationContainer = gebi('bookingSuccessAnimation');
    window.openBookingPopup = function (id, t, disp, giaP) {
      if (!currentUserData) { openLoginPopup(); localStorage.setItem("pending_action_eff", JSON.stringify({ action: 'book', eventId: id, eventTitle: t, postiDisp: disp, postiGiaPren: giaP })); return; }
      if (formContentWrapper) { formContentWrapper.classList.remove('swept-away'); formContentWrapper.style.display = 'block'; formContentWrapper.style.maxHeight = 'none'; }
      if (successAnimationContainer) successAnimationContainer.style.display = 'none';
      if (bRM) { bRM.style.display = 'none'; bRM.className = 'form-message'; }
      if (bF) bF.reset(); if (pFC) pFC.innerHTML = ''; if(bEII) bEII.value = id; if(bPT) bPT.textContent = `Prenota: ${t}`;
      const pDN = parseInt(disp); const pGPN = parseInt(giaP) || 0;
      const maxPrUsrSTrx = Math.min(MAX_SEATS_PER_BOOKING, MAX_TOTAL_SEATS_PER_USER - pGPN);
      const maxE = Math.min(maxPrUsrSTrx, pDN);
      if (maxE < 1) { alert("Non puoi prenotare ulteriori posti per questo evento o hai raggiunto il limite massimo di prenotazioni."); return; }
      if(nPI) { nPI.max = maxE; nPI.value = 1; }
      if (mSB) mSB.textContent = maxE;
      if (iPP) iPP.textContent = `Puoi prenotare da 1 a ${maxE} posti. (Già prenotati da te per questo evento: ${pGPN}. Max totale per utente: ${MAX_TOTAL_SEATS_PER_USER})`;
      generateParticipantFields(1, pFC, 'bp', maxE);
      if (bO) { bO.classList.remove('fading-out'); bO.classList.add('active'); }
      if (bP) { bP.classList.remove('fading-out'); bP.classList.add('active'); }
      document.body.style.overflow = 'hidden';
    };
    function cBP_actualClose() {
      if (bO) bO.classList.remove('active', 'fading-out'); if (bP) bP.classList.remove('active', 'fading-out');
      if (!isAnyPopupActive()) document.body.style.overflow = '';
      if (formContentWrapper) { formContentWrapper.classList.remove('swept-away'); formContentWrapper.style.display = 'block'; formContentWrapper.style.maxHeight = 'none'; }
      if (successAnimationContainer) successAnimationContainer.style.display = 'none';
      if (bF) bF.reset(); if (pFC) pFC.innerHTML = ''; if (iPP) iPP.textContent = '';
      if (bRM) { bRM.style.display = 'none'; bRM.className = 'form-message';}
    }
    function cBP_withAnimation() { if (bO) bO.classList.add('fading-out'); if (bP) bP.classList.add('fading-out'); setTimeout(cBP_actualClose, 300); }
    if (cB) cB.addEventListener('click', cBP_withAnimation);
    if (bO) bO.addEventListener('click', (e) => { if (e.target === bO) cBP_withAnimation(); });
    if (nPI && pFC) nPI.addEventListener('input', (e) => {
      const currentVal = parseInt(e.target.value); const maxVal = parseInt(nPI.max);
      if (currentVal > maxVal) e.target.value = maxVal;
      if (currentVal < 1 && e.target.value !== "") e.target.value = 1;
      generateParticipantFields(e.target.value, pFC, 'bp', maxVal);
    });
    if (bF) bF.addEventListener('submit', async function (e) {
      e.preventDefault();
      if (!currentUserData || !currentUserData.email) { alert("Sessione scaduta o utente non valido. Effettua nuovamente il login."); handleLogout(); return; }
      const btn = this.querySelector('button[type="submit"]'); const oT = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<div class="spinner-mini-light" style="margin-right: 5px;"></div> Elaboro...';
      if (bRM) { bRM.style.display = 'none'; bRM.className = 'form-message'; }
      const fd = new FormData(); fd.append('eventId', bEII.value); fd.append('numeroPosti', nPI.value); fd.append('contatto', currentUserData.email);
      const N = pFC.querySelectorAll('input[name="participant_nome[]"]'); const C = pFC.querySelectorAll('input[name="participant_cognome[]"]');
      let v = true;
      if (N.length !== parseInt(nPI.value)) { v = false; if (bRM) bRM.textContent = 'Il numero di partecipanti non corrisponde ai campi compilati.'; }
      else {
        for (let i = 0; i < N.length; i++) {
          if (N[i].value.trim() === '' || C[i].value.trim() === '') { v = false; if (bRM) bRM.textContent = 'Nome e cognome sono obbligatori per tutti i partecipanti.'; break; }
          fd.append('partecipanti_nomi[]', N[i].value.trim()); fd.append('partecipanti_cognomi[]', C[i].value.trim());
        }
      }
      if (!v) { if (bRM) { bRM.className = 'form-message error'; bRM.style.display = 'block'; } btn.disabled = false; btn.innerHTML = oT; return; }
      try {
        const r = await fetch('prenota_evento.php', { method: 'POST', body: fd }); const rt = await r.text();
        let j; try { j = JSON.parse(rt); } catch (err) { throw new Error("Risposta non valida dal server: " + rt.substring(0, 150)); }
        if (j.success) {
          if (formContentWrapper) { formContentWrapper.style.maxHeight = formContentWrapper.scrollHeight + 'px'; setTimeout(() => formContentWrapper.classList.add('swept-away'), 10); }
          if (bRM) bRM.style.display = 'none';
          if (successAnimationContainer) {
            successAnimationContainer.style.display = 'block';
            const checkMarkIcon = successAnimationContainer.querySelector('.animated-check-icon');
            if(checkMarkIcon) { const newCheckMark = checkMarkIcon.cloneNode(true); checkMarkIcon.parentNode.replaceChild(newCheckMark, checkMarkIcon); }
          }
          loadEvents(); setTimeout(cBP_withAnimation, 3000);
        } else { throw new Error(j.message || 'Errore durante la prenotazione.'); }
      } catch (err) { if (bRM) { bRM.textContent = `Errore: ${err.message}`; bRM.className = 'form-message error'; }
      } finally {
        if (successAnimationContainer && successAnimationContainer.style.display === 'block') { if (bRM) bRM.style.display = 'none'; }
        else if (bRM && !bRM.classList.contains('success')) bRM.style.display = 'block';
        btn.disabled = false; btn.innerHTML = oT;
      }
    });
  }
  function generateParticipantFields(c, cont, bId, maxA) {
    if (!cont) return; cont.innerHTML = ''; let vC = parseInt(c);
    if (isNaN(vC) || vC < 1) vC = 1;
    const maxAllowed = parseInt(maxA); if (isNaN(maxAllowed) || maxAllowed < 1) maxAllowed = MAX_SEATS_PER_BOOKING;
    if (vC > maxAllowed) vC = maxAllowed;
    const nI = cont.closest('form')?.querySelector('input[type="number"]#numeroPosti');
    if (nI && parseInt(nI.value) !== vC) nI.value = vC;
    if (vC > 0) {
      for (let i = 1; i <= vC; i++) {
        const fS = document.createElement('div'); fS.className = 'participant-entry';
        fS.innerHTML = `<p style="margin-bottom:0.5rem;font-weight:500;color:var(--dark); padding-top: ${i > 1 ? '1rem' : '0'};">Partecipante ${i}:</p>
                            <div class="form-grid">
                                <div><label for="${bId}_nome_${i}">Nome*</label><input type="text" id="${bId}_nome_${i}" name="participant_nome[]" class="form-control" required></div>
                                <div><label for="${bId}_cognome_${i}">Cognome*</label><input type="text" id="${bId}_cognome_${i}" name="participant_cognome[]" class="form-control" required></div>
                            </div>`;
        cont.appendChild(fS);
      }
    }
  }
  function initializeWaitlistPopupHandlers() {
    const wO = gebi('waitlistPopupOverlay'); const wP = gebi('waitlistPopup'); const cB = gebi('closeWaitlistPopupBtn'); const wF = gebi('waitlistForm'); const wNPI = gebi('waitlistNumeroPosti'); const wEII = gebi('waitlistEventId'); const wPT = gebi('waitlistPopupTitle'); const wEI = gebi('waitlistEventInfo'); const wRM = gebi('waitlistResponseMessage'); const mSEW = gebi('maxSeatsAllowedWaitlist'); const iCEl = gebi('infoPostiCoda');
    const wFormContentWrapper = wF ? wF.querySelector('.form-content-wrapper') : null;
    const wSuccessAnimationContainer = gebi('waitlistSuccessAnimation');
    window.openWaitlistPopup = function (id, t, pGiaP) {
      if (!currentUserData) { openLoginPopup(); localStorage.setItem("pending_action_eff", JSON.stringify({ action: 'waitlist', eventId: id, eventTitle: t, postiGiaPren: pGiaP })); return; }
      if (wFormContentWrapper) { wFormContentWrapper.classList.remove('swept-away'); wFormContentWrapper.style.display = 'block'; wFormContentWrapper.style.maxHeight = 'none'; }
      if (wSuccessAnimationContainer) wSuccessAnimationContainer.style.display = 'none';
      if (wRM) { wRM.style.display = 'none'; wRM.className = 'form-message'; }
      if (wF) wF.reset(); if(wEII) wEII.value = id; if(wPT) wPT.textContent = `Mettiti in Lista d'Attesa`; if(wEI) wEI.textContent = `Evento: ${t}`;
      const pGPN = parseInt(pGiaP) || 0; const maxPC = Math.min(MAX_SEATS_PER_BOOKING, MAX_TOTAL_SEATS_PER_USER - pGPN);
      if (maxPC < 1) { alert("Hai raggiunto il limite massimo di posti prenotabili o richiedibili in coda."); return; }
      if (wNPI) { wNPI.max = maxPC; wNPI.value = 1; }
      if (mSEW) mSEW.textContent = maxPC; if (iCEl) iCEl.textContent = `Puoi richiedere da 1 a ${maxPC} posti. (Già prenotati/in coda da te: ${pGPN}/${MAX_TOTAL_SEATS_PER_USER})`;
      if (wO) { wO.classList.remove('fading-out'); wO.classList.add('active'); }
      if (wP) { wP.classList.remove('fading-out'); wP.classList.add('active'); }
      document.body.style.overflow = 'hidden';
    };
    function cWP_actualClose() {
      if (wO) wO.classList.remove('active', 'fading-out'); if (wP) wP.classList.remove('active', 'fading-out');
      if (!isAnyPopupActive()) document.body.style.overflow = '';
      if (wFormContentWrapper) { wFormContentWrapper.classList.remove('swept-away'); wFormContentWrapper.style.display = 'block'; wFormContentWrapper.style.maxHeight = 'none'; }
      if (wSuccessAnimationContainer) wSuccessAnimationContainer.style.display = 'none';
      if (wF) wF.reset(); if (iCEl) iCEl.textContent = ''; if (wRM) { wRM.style.display = 'none'; wRM.className = 'form-message';}
    }
    function cWP_withAnimation() { if (wO) wO.classList.add('fading-out'); if (wP) wP.classList.add('fading-out'); setTimeout(cWP_actualClose, 300); }
    if (cB) cB.addEventListener('click', cWP_withAnimation);
    if (wO) wO.addEventListener('click', (e) => { if (e.target === wO) cWP_withAnimation(); });
    if (wNPI) wNPI.addEventListener('input', (e) => {
      const currentVal = parseInt(e.target.value); const maxVal = parseInt(wNPI.max);
      if (currentVal > maxVal) e.target.value = maxVal;
      if (currentVal < 1 && e.target.value !== "") e.target.value = 1;
    });
    if (wF) wF.addEventListener('submit', async function (e) {
      e.preventDefault();
      if (!currentUserData || !currentUserData.email) { alert("Sessione scaduta o utente non valido. Effettua nuovamente il login."); handleLogout(); return; }
      const btn = this.querySelector('button[type="submit"]'); const oT = btn.innerHTML; btn.disabled = true; btn.innerHTML = '<div class="spinner-mini-light" style="margin-right: 5px;"></div> Elaboro...';
      if (wRM) wRM.style.display = 'none';
      const fd = new FormData(); fd.append('eventId', wEII.value); fd.append('numeroPosti', wNPI.value); fd.append('contatto', currentUserData.email);
      try {
        const r = await fetch('gestisci_coda.php', { method: 'POST', body: fd }); const rt = await r.text();
        let j; try { j = JSON.parse(rt); } catch (err) { throw new Error("Risposta non valida dal server: " + rt.substring(0, 150)); }
        if (j.success) {
          if (wFormContentWrapper) { wFormContentWrapper.style.maxHeight = wFormContentWrapper.scrollHeight + 'px'; setTimeout(() => wFormContentWrapper.classList.add('swept-away'), 10); }
          if (wRM) wRM.style.display = 'none';
          if (wSuccessAnimationContainer) {
            wSuccessAnimationContainer.style.display = 'block';
            const checkMarkIcon = wSuccessAnimationContainer.querySelector('.animated-check-icon');
            if(checkMarkIcon) { const newCheckMark = checkMarkIcon.cloneNode(true); checkMarkIcon.parentNode.replaceChild(newCheckMark, checkMarkIcon); }
          }
          loadEvents(); setTimeout(cWP_withAnimation, 3000);
        } else { throw new Error(j.message || "Errore durante la richiesta di inserimento in coda."); }
      } catch (err) { if (wRM) { wRM.textContent = `Errore: ${err.message}`; wRM.className = 'form-message error'; }
      } finally {
        if (wSuccessAnimationContainer && wSuccessAnimationContainer.style.display === 'block') { if (wRM) wRM.style.display = 'none'; }
        else if (wRM && !wRM.classList.contains('success')) wRM.style.display = 'block';
        btn.disabled = false; btn.innerHTML = oT;
      }
    });
  }

  function initializeDashAdminEventPopupHandlers() {
    adminAddEventBtnEl = gebi('adminAddEventBtn');
    dashAdminEventPopupOverlayEl = gebi('dashAdminEventPopupOverlay');
    dashAdminEventPopupEl = gebi('dashAdminEventPopup');
    closeDashAdminEventPopupBtnEl = gebi('closeDashAdminEventPopupBtn');
    dashAdminEventFormEl = gebi('dashAdminEventForm');
    dashAdminEventPopupTitleEl = gebi('dashAdminEventPopupTitle');
    dashAdminEventIdInputEl = gebi('dashAdmin-event-id');
    dashAdminEventTitleEl = gebi('dashAdmin-event-title');
    dashAdminEventDateEl = gebi('dashAdmin-event-date');
    dashAdminEventStartTimeEl = gebi('dashAdmin-event-start-time');
    dashAdminEventEndTimeEl = gebi('dashAdmin-event-end-time');
    dashAdminEventShortDescEl = gebi('dashAdmin-event-short-desc');
    dashAdminEventLongDescEl = gebi('dashAdmin-event-long-desc');
    dashAdminEventPrefixEl = gebi('dashAdmin-event-prefix');
    dashAdminEventSpeakerEl = gebi('dashAdmin-event-speaker');
    dashAdminEventAssociationEl = gebi('dashAdmin-event-association');
    dashAdminEventSeatsEl = gebi('dashAdmin-event-seats');
    dashAdminEventImageEl = gebi('dashAdmin-event-image');
    dashAdminEventFlyerEl = gebi('dashAdmin-event-flyer');
    dashAdminEventBookingCheckbox = gebi('dashAdmin-event-booking');
    dashAdminEventVoluntaryCheckbox = gebi('dashAdmin-event-voluntary');
    dashAdminEventPriceContainerEl = gebi('dashAdmin-event-price-container');
    dashAdminEventPriceInputEl = gebi('dashAdmin-event-price');
    dashAdminEventFormMessageEl = gebi('dashAdminEventFormMessage');
    dashAdminCurrentImagePreviewEl = gebi('dashAdmin-current-event-image-preview');
    dashAdminCurrentFlyerPreviewEl = gebi('dashAdmin-current-event-flyer-preview');
    dashAdminPreviewImageEl = gebi('dashAdmin_previewImage');
    dashAdminPreviewNoImagePlaceholderEl = document.querySelector('#dashAdminEventCardPreviewContainer .dash-admin-no-image-placeholder');
    dashAdminPreviewTitleEl = gebi('dashAdmin_previewTitle');
    dashAdminPreviewDateFullEl = gebi('dashAdmin_previewDateFull').querySelector('.value');
    dashAdminPreviewTimeFullEl = gebi('dashAdmin_previewTimeFull');
    dashAdminPreviewTimeValueEl = gebi('dashAdmin_previewTimeFull').querySelector('.value');
    dashAdminPreviewSpeakerFullEl = gebi('dashAdmin_previewSpeakerFull');
    dashAdminPreviewSpeakerPrefixEl = gebi('dashAdmin_previewSpeakerPrefix');
    dashAdminPreviewSpeakerNameEl = gebi('dashAdmin_previewSpeakerName');
    dashAdminPreviewShortDescEl = gebi('dashAdmin_previewShortDesc');
    dashAdminPreviewSeatsFullEl = gebi('dashAdmin_previewSeatsFull').querySelector('.value');
    dashAdminPreviewPriceFullEl = gebi('dashAdmin_previewPriceFull').querySelector('.value');
    generateShortDescBtnEl = gebi('generateShortDescBtn');
    aiShortDescStatusEl = gebi('aiShortDescStatus');
    dashAdminLongDescElForAI = dashAdminEventLongDescEl;

    customConfirmOverlayEl = gebi('customConfirmOverlay');
    customConfirmModalEl = gebi('customConfirmModal');
    customConfirmTitleEl = gebi('customConfirmTitle'); // Aggiunto per il titolo del modal
    customConfirmMessageEl = gebi('customConfirmMessage');
    customConfirmYesBtn = gebi('customConfirmYes');
    customConfirmNoBtn = gebi('customConfirmNo');

    creationModeSelectionViewEl = gebi('creationModeSelectionView');
    createManuallyModeBtnEl = gebi('createManuallyModeBtn');
    extractFromFlyerModeBtnEl = gebi('extractFromFlyerModeBtn');
    flyerUploadViewEl = gebi('flyerUploadView');
    flyerFileEl = gebi('flyerFile');
    flyerPreviewContainerEl = gebi('flyerPreviewContainer');
    flyerPreviewEl = gebi('flyerPreview');
    processFlyerBtnEl = gebi('processFlyerBtn');
    flyerProcessingStatusEl = gebi('flyerProcessingStatus');
    dashAdminFormAndPreviewContainerEl = document.querySelector('.dash-admin-event-form-and-preview-container');


    if (adminAddEventBtnEl) adminAddEventBtnEl.addEventListener('click', () => openDashAdminEventPopup(null));
    if (closeDashAdminEventPopupBtnEl) closeDashAdminEventPopupBtnEl.addEventListener('click', () => tryCloseDashAdminEventPopup());
    if (dashAdminEventPopupOverlayEl) dashAdminEventPopupOverlayEl.addEventListener('click', (e) => { if (e.target === dashAdminEventPopupOverlayEl) tryCloseDashAdminEventPopup(); });
    if (dashAdminEventVoluntaryCheckbox) dashAdminEventVoluntaryCheckbox.addEventListener('change', updateDashAdminPriceFieldVisibility);

    if(createManuallyModeBtnEl) createManuallyModeBtnEl.addEventListener('click', () => {
      if(creationModeSelectionViewEl) creationModeSelectionViewEl.style.display = 'none';
      if(flyerUploadViewEl) flyerUploadViewEl.style.display = 'none';
      if(dashAdminFormAndPreviewContainerEl) dashAdminFormAndPreviewContainerEl.style.display = 'flex';
      resetAndPrepareManualForm();
      if(dashAdminEventPopupTitleEl) dashAdminEventPopupTitleEl.textContent = 'Aggiungi Nuovo Evento Manualmente';
      if(dashAdminEventTitleEl) dashAdminEventTitleEl.focus();
      storeInitialFormData();
    });

    if(extractFromFlyerModeBtnEl) extractFromFlyerModeBtnEl.addEventListener('click', () => {
      if(creationModeSelectionViewEl) creationModeSelectionViewEl.style.display = 'none';
      if(flyerUploadViewEl) flyerUploadViewEl.style.display = 'block';
      if(dashAdminFormAndPreviewContainerEl) dashAdminFormAndPreviewContainerEl.style.display = 'none';
      if(flyerFileEl) flyerFileEl.value = '';
      if(flyerPreviewContainerEl) flyerPreviewContainerEl.style.display = 'none';
      if(flyerPreviewEl) flyerPreviewEl.src = '#';
      if(flyerPreviewContainerEl) flyerPreviewContainerEl.classList.remove('pulsating-background');
      if(processFlyerBtnEl) processFlyerBtnEl.disabled = true;
      if(flyerProcessingStatusEl) flyerProcessingStatusEl.textContent = '';
      if(dashAdminEventPopupTitleEl) dashAdminEventPopupTitleEl.textContent = 'Estrai da Volantino';
      resetAndPrepareManualForm();
    });

    if(flyerFileEl) flyerFileEl.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          if(flyerPreviewEl) flyerPreviewEl.src = e.target.result;
          if(flyerPreviewContainerEl) {
            flyerPreviewContainerEl.style.display = 'flex';
            flyerPreviewContainerEl.classList.add('pulsating-background');
          }
        }
        reader.readAsDataURL(file);
        if(processFlyerBtnEl) processFlyerBtnEl.disabled = false;
        if(flyerProcessingStatusEl) flyerProcessingStatusEl.textContent = '';
      } else {
        if(flyerPreviewContainerEl) {
          flyerPreviewContainerEl.style.display = 'none';
          flyerPreviewContainerEl.classList.remove('pulsating-background');
        }
        if(flyerPreviewEl) flyerPreviewEl.src = '#';
        if(processFlyerBtnEl) processFlyerBtnEl.disabled = true;
        if(flyerProcessingStatusEl && file) flyerProcessingStatusEl.textContent = 'Per favore, seleziona un file immagine (JPG, PNG, WEBP).';
      }
    });

    if(processFlyerBtnEl) processFlyerBtnEl.addEventListener('click', handleFlyerProcessing);


    if (dashAdminLongDescElForAI && generateShortDescBtnEl) {
      dashAdminLongDescElForAI.addEventListener('input', () => {
        const hasText = dashAdminLongDescElForAI.value.trim().length > 0;
        generateShortDescBtnEl.classList.toggle('visible', hasText);
        if (hasText && !generateShortDescBtnEl.classList.contains('loading')) {
          generateShortDescBtnEl.classList.add('expanded');
        } else {
          generateShortDescBtnEl.classList.remove('expanded');
        }
      });
    }

    if (generateShortDescBtnEl) {
      generateShortDescBtnEl.addEventListener('click', async () => {
        const longDesc = dashAdminLongDescElForAI.value;
        if (!longDesc.trim()) {
          if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = "Inserisci prima una descrizione estesa.";
          setTimeout(() => { if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = ""; }, 3000);
          return;
        }
        generateShortDescBtnEl.classList.add('loading');
        generateShortDescBtnEl.classList.remove('expanded');
        generateShortDescBtnEl.disabled = true;
        if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = "";

        const result = await generateShortDescriptionAI(longDesc);

        generateShortDescBtnEl.classList.remove('loading');
        generateShortDescBtnEl.disabled = false;
        if (dashAdminLongDescElForAI.value.trim().length > 0) {
          generateShortDescBtnEl.classList.add('expanded');
        }

        if (result.success && result.description) {
          dashAdminEventShortDescEl.value = result.description;
          dashAdminEventShortDescEl.dispatchEvent(new Event('input', { bubbles: true }));
          if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = "Descrizione breve generata!";
        } else {
          console.error("Errore generazione descrizione AI:", result.error);
          if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = `Errore AI: ${result.error || 'Sconosciuto'}`;
        }
        setTimeout(() => { if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = ""; }, 4000);
      });
    }

    attachDashAdminPreviewListeners();
    dashAdminEventFormEl?.addEventListener('submit', handleAdminEventFormSubmit);
    if (customConfirmYesBtn) customConfirmYesBtn.addEventListener('click', () => handleConfirm(true));
    if (customConfirmNoBtn) customConfirmNoBtn.addEventListener('click', () => handleConfirm(false));
    if (customConfirmOverlayEl) customConfirmOverlayEl.addEventListener('click', (e) => {
      if (e.target === customConfirmOverlayEl) handleConfirm(false);
    });
  }

  async function handleFlyerProcessing() {
    if (!flyerFileEl || !flyerFileEl.files || flyerFileEl.files.length === 0) {
      if(flyerProcessingStatusEl) flyerProcessingStatusEl.textContent = 'Nessun volantino selezionato.';
      return;
    }
    const file = flyerFileEl.files[0];
    if (!file.type.startsWith('image/')) {
      if(flyerProcessingStatusEl) flyerProcessingStatusEl.textContent = 'Per favore, carica un file immagine.';
      return;
    }

    if(processFlyerBtnEl) {
      processFlyerBtnEl.disabled = true;
      processFlyerBtnEl.innerHTML = '<div class="spinner-mini"></div> Processo AI...';
    }
    if(flyerProcessingStatusEl) {
      flyerProcessingStatusEl.textContent = 'Estrazione informazioni dal volantino in corso...';
      flyerProcessingStatusEl.className = '';
    }
    if(flyerPreviewContainerEl) flyerPreviewContainerEl.classList.remove('pulsating-background');


    try {
      const base64ImageData = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });

      const extractionResult = await callGroqForFlyerExtraction(base64ImageData);

      if (extractionResult.success && extractionResult.data) {
        populateFormWithExtractedData(extractionResult.data);
        if(flyerProcessingStatusEl) {
          flyerProcessingStatusEl.textContent = 'Informazioni estratte! Controlla e completa il modulo.';
          flyerProcessingStatusEl.classList.add('success');
        }
        if(flyerUploadViewEl) flyerUploadViewEl.style.display = 'none';
        if(dashAdminFormAndPreviewContainerEl) dashAdminFormAndPreviewContainerEl.style.display = 'flex';
        if(dashAdminEventPopupTitleEl) dashAdminEventPopupTitleEl.textContent = 'Verifica Evento da Volantino';

        if (dashAdminEventFlyerEl && flyerFileEl.files.length > 0) {
          const uploadedFlyerFile = flyerFileEl.files[0];
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(uploadedFlyerFile);
          dashAdminEventFlyerEl.files = dataTransfer.files;
          if (dashAdminCurrentFlyerPreviewEl) {
            dashAdminCurrentFlyerPreviewEl.innerHTML = `<a href="${URL.createObjectURL(uploadedFlyerFile)}" target="_blank" title="Visualizza il volantino caricato">${sanitizeText(uploadedFlyerFile.name)}</a> (Appena caricato)`;
          }
          dashAdminEventFlyerEl.dispatchEvent(new Event('change', { bubbles: true }));
        }
        storeInitialFormData();
      } else {
        throw new Error(extractionResult.error || "Estrazione fallita.");
      }
    } catch (error) {
      console.error("Errore processamento volantino:", error);
      if(flyerProcessingStatusEl) {
        flyerProcessingStatusEl.textContent = `Errore: ${error.message}`;
        flyerProcessingStatusEl.classList.add('error');
      }
    } finally {
      if(processFlyerBtnEl) {
        processFlyerBtnEl.disabled = false;
        processFlyerBtnEl.innerHTML = '<i class="fas fa-cogs"></i> Processa Volantino con AI';
      }
    }
  }

  function populateFormWithExtractedData(data) {
    if (!data) return;

    if(dashAdminEventTitleEl) dashAdminEventTitleEl.value = data.titolo || '';
    if(dashAdminEventDateEl && data.data_inizio) dashAdminEventDateEl.value = data.data_inizio;
    if(dashAdminEventStartTimeEl && data.ora_inizio) dashAdminEventStartTimeEl.value = data.ora_inizio;
    if(dashAdminEventEndTimeEl && data.ora_fine) dashAdminEventEndTimeEl.value = data.ora_fine;

    if(dashAdminEventPrefixEl) dashAdminEventPrefixEl.value = data.relatore_prefisso || 'Relatore';
    if(dashAdminEventSpeakerEl) dashAdminEventSpeakerEl.value = data.relatore_nome || '';
    if(dashAdminEventAssociationEl) dashAdminEventAssociationEl.value = data.associazione || '';

    if(dashAdminEventShortDescEl) dashAdminEventShortDescEl.value = data.descrizione_breve_generata || '';
    if(dashAdminEventLongDescEl) dashAdminEventLongDescEl.value = data.descrizione_estesa_generata || '';

    if(dashAdminEventSeatsEl && data.posti_disponibili !== null) dashAdminEventSeatsEl.value = data.posti_disponibili;
    else if(dashAdminEventSeatsEl) dashAdminEventSeatsEl.value = '50';

    if(dashAdminEventBookingCheckbox && data.flag_prenotabile !== null) dashAdminEventBookingCheckbox.checked = data.flag_prenotabile;
    else if(dashAdminEventBookingCheckbox) dashAdminEventBookingCheckbox.checked = true;

    if(dashAdminEventVoluntaryCheckbox && data.flag_offerta_libera !== null) dashAdminEventVoluntaryCheckbox.checked = data.flag_offerta_libera;
    updateDashAdminPriceFieldVisibility();

    if(dashAdminEventPriceInputEl && data.costo !== null && !dashAdminEventVoluntaryCheckbox.checked) {
      dashAdminEventPriceInputEl.value = parseFloat(data.costo).toFixed(2);
    } else if (dashAdminEventPriceInputEl && !dashAdminEventVoluntaryCheckbox.checked) {
      dashAdminEventPriceInputEl.value = '';
    }

    updateDashAdminEventPreview();
  }

  function showCustomConfirm(title, message, confirmBtnText = "Sì", cancelBtnText = "Annulla") {
    return new Promise((resolve) => {
      if(customConfirmTitleEl) customConfirmTitleEl.textContent = title || "Conferma";
      if(customConfirmMessageEl) customConfirmMessageEl.textContent = message || "Sei sicuro di voler procedere?";
      if(customConfirmYesBtn) customConfirmYesBtn.textContent = confirmBtnText;
      if(customConfirmNoBtn) customConfirmNoBtn.textContent = cancelBtnText;

      if(customConfirmOverlayEl) customConfirmOverlayEl.classList.add('active');
      confirmResolve = resolve;
    });
  }

  function handleConfirm(confirmed) {
    if(customConfirmOverlayEl) customConfirmOverlayEl.classList.remove('active');
    if (confirmResolve) {
      confirmResolve(confirmed);
      confirmResolve = null;
    }
  }

  function getAdminEventFormData(form) {
    const formData = new FormData(form);
    const data = {};
    for (const [key, value] of formData.entries()) {
      const element = form.elements[key];
      if (element.type === 'checkbox') data[key] = element.checked;
      else if (element.type === 'file') data[key] = element.files.length > 0 ? element.files[0].name : '';
      else data[key] = value;
    }
    return data;
  }

  function compareAdminEventFormData(data1, data2) {
    const keys1 = Object.keys(data1);
    const keys2 = Object.keys(data2);
    if (keys1.length !== keys2.length) return false;
    for (let key of keys1) {
      if (data1[key] !== data2[key]) {
        return false;
      }
    }
    return true;
  }

  function updateDashAdminPriceFieldVisibility() {
    if (dashAdminEventVoluntaryCheckbox && dashAdminEventPriceContainerEl && dashAdminEventPriceInputEl) {
      const isVoluntary = dashAdminEventVoluntaryCheckbox.checked;
      dashAdminEventPriceContainerEl.style.display = isVoluntary ? 'none' : 'block';
      dashAdminEventPriceInputEl.required = !isVoluntary;
      if (isVoluntary) dashAdminEventPriceInputEl.value = '';
      updateDashAdminEventPreview();
    }
  }
  function sanitizeForAttribute(str) {
    if (typeof str !== 'string' || str === null) return '';
    return str.replace(/'/g, "&apos;").replace(/"/g, "&quot;");
  }
  function sanitizeText(text) {
    if (text === null || typeof text === 'undefined') return '';
    const element = document.createElement('div'); element.innerText = String(text); return element.innerHTML;
  }
  function updateDashAdminEventPreview() {
    if (!dashAdminPreviewTitleEl) return;
    dashAdminPreviewTitleEl.textContent = dashAdminEventTitleEl.value || 'Titolo Evento';
    const dateValue = dashAdminEventDateEl.value;
    dashAdminPreviewDateFullEl.textContent = dateValue ? formatSimpleDateForPreview(dateValue) : 'Seleziona data';
    const startTimeValue = dashAdminEventStartTimeEl.value;
    const endTimeValue = dashAdminEventEndTimeEl.value;
    let timeString = '';
    if (startTimeValue && endTimeValue) timeString = `${startTimeValue} - ${endTimeValue}`;
    else if (startTimeValue) timeString = startTimeValue;
    if (timeString && dashAdminPreviewTimeFullEl && dashAdminPreviewTimeValueEl) {
      dashAdminPreviewTimeFullEl.style.display = 'block';
      dashAdminPreviewTimeValueEl.textContent = timeString;
    } else if (dashAdminPreviewTimeFullEl && dashAdminPreviewTimeValueEl) {
      dashAdminPreviewTimeFullEl.style.display = 'none';
      dashAdminPreviewTimeValueEl.textContent = '';
    }
    dashAdminPreviewSpeakerPrefixEl.textContent = dashAdminEventPrefixEl.value || 'Relatore';
    dashAdminPreviewSpeakerNameEl.textContent = dashAdminEventSpeakerEl.value || 'Nome Relatore';
    dashAdminPreviewShortDescEl.textContent = dashAdminEventShortDescEl.value || 'Descrizione breve dell\'evento qui...';
    dashAdminPreviewSeatsFullEl.textContent = dashAdminEventSeatsEl.value || '0';
    const isVoluntary = dashAdminEventVoluntaryCheckbox.checked;
    if (isVoluntary) dashAdminPreviewPriceFullEl.textContent = 'Offerta libera';
    else {
      const priceValue = parseFloat(dashAdminEventPriceInputEl.value);
      dashAdminPreviewPriceFullEl.textContent = !isNaN(priceValue) && priceValue > 0 ? `€ ${priceValue.toFixed(2)}` : '€ 0.00';
    }
    const imageInput = dashAdminEventImageEl;
    if (imageInput.files && imageInput.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        dashAdminPreviewImageEl.src = e.target.result;
        dashAdminPreviewImageEl.style.display = 'block';
        if(dashAdminPreviewNoImagePlaceholderEl) dashAdminPreviewNoImagePlaceholderEl.style.display = 'none';
      }
      reader.readAsDataURL(imageInput.files[0]);
    } else if (dashAdminCurrentImagePreviewEl && dashAdminCurrentImagePreviewEl.src !== '#' && dashAdminCurrentImagePreviewEl.style.display !== 'none') {
      dashAdminPreviewImageEl.src = dashAdminCurrentImagePreviewEl.src;
      dashAdminPreviewImageEl.style.display = 'block';
      if(dashAdminPreviewNoImagePlaceholderEl) dashAdminPreviewNoImagePlaceholderEl.style.display = 'none';
    } else {
      dashAdminPreviewImageEl.src = 'images/default-event.jpg';
      dashAdminPreviewImageEl.style.display = 'block';
      if(dashAdminPreviewNoImagePlaceholderEl) dashAdminPreviewNoImagePlaceholderEl.style.display = 'none';
    }
  }
  function attachDashAdminPreviewListeners() {
    const formElementsToWatch = [
      'dashAdmin-event-title', 'dashAdmin-event-date', 'dashAdmin-event-start-time', 'dashAdmin-event-end-time',
      'dashAdmin-event-short-desc', 'dashAdmin-event-prefix', 'dashAdmin-event-speaker', 'dashAdmin-event-seats',
      'dashAdmin-event-price', 'dashAdmin-event-voluntary', 'dashAdmin-event-image', 'dashAdmin-event-long-desc'
    ];
    formElementsToWatch.forEach(id => {
      const element = gebi(id);
      if (element) {
        element.addEventListener('input', updateDashAdminEventPreview);
        if (element.type === 'checkbox' || element.type === 'file' || element.type === 'date' || element.type === 'time') {
          element.addEventListener('change', updateDashAdminEventPreview);
        }
      }
    });
    if (dashAdminEventFlyerEl && dashAdminCurrentFlyerPreviewEl) {
      dashAdminEventFlyerEl.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          dashAdminCurrentFlyerPreviewEl.innerHTML = `<a href="${URL.createObjectURL(this.files[0])}" target="_blank" title="Visualizza il volantino selezionato">${sanitizeText(this.files[0].name)}</a>`;
        } else if (!dashAdminEventIdInputEl.value) {
          dashAdminCurrentFlyerPreviewEl.innerHTML = '<span>Nessun volantino caricato.</span>';
        }
      });
    }
  }

  function resetAndPrepareManualForm() {
    if (!dashAdminEventFormEl) return;
    dashAdminEventFormEl.reset();
    if(dashAdminEventIdInputEl) dashAdminEventIdInputEl.value = '';
    updateDashAdminPriceFieldVisibility();
    if(dashAdminEventFormMessageEl) { dashAdminEventFormMessageEl.style.display = 'none'; dashAdminEventFormMessageEl.className = 'form-message';}
    if(dashAdminCurrentImagePreviewEl) { dashAdminCurrentImagePreviewEl.style.display = 'none'; dashAdminCurrentImagePreviewEl.src = '#';}
    if(dashAdminCurrentFlyerPreviewEl) { dashAdminCurrentFlyerPreviewEl.innerHTML = '<span>Nessun volantino caricato.</span>'; }
    if(dashAdminEventFlyerEl) dashAdminEventFlyerEl.value = '';
    if(dashAdminEventImageEl) dashAdminEventImageEl.value = '';
    if(dashAdminEventStartTimeEl) dashAdminEventStartTimeEl.value = '';
    if(dashAdminEventEndTimeEl) dashAdminEventEndTimeEl.value = '';
    if(aiShortDescStatusEl) aiShortDescStatusEl.textContent = "";
    if(generateShortDescBtnEl) generateShortDescBtnEl.classList.remove('visible', 'loading', 'expanded');
    updateDashAdminEventPreview();
  }


  function openDashAdminEventPopup(eventData = null) {
    if (!dashAdminEventFormEl) return;

    if(creationModeSelectionViewEl) creationModeSelectionViewEl.style.display = 'flex';
    if(flyerUploadViewEl) flyerUploadViewEl.style.display = 'none';
    if(flyerPreviewContainerEl) flyerPreviewContainerEl.style.display = 'none';
    if(flyerPreviewContainerEl) flyerPreviewContainerEl.classList.remove('pulsating-background');
    if(dashAdminFormAndPreviewContainerEl) dashAdminFormAndPreviewContainerEl.style.display = 'none';
    if(dashAdminEventPopupTitleEl) dashAdminEventPopupTitleEl.textContent = 'Come vuoi creare l\'evento?';

    if (!eventData) {
      resetAndPrepareManualForm();
    } else {
      if(creationModeSelectionViewEl) creationModeSelectionViewEl.style.display = 'none';
      if(flyerUploadViewEl) flyerUploadViewEl.style.display = 'none';
      if(dashAdminFormAndPreviewContainerEl) dashAdminFormAndPreviewContainerEl.style.display = 'flex';

      if(dashAdminEventPopupTitleEl) dashAdminEventPopupTitleEl.textContent = 'Modifica Evento';
      if(dashAdminEventIdInputEl) dashAdminEventIdInputEl.value = eventData.idevento;
      dashAdminEventTitleEl.value = eventData.titolo || '';
      dashAdminEventDateEl.value = eventData.datainizio ? eventData.datainizio.substring(0,10) : '';
      let startTime = '', endTime = '';
      const durata = eventData.durata || '';
      if (durata.includes('-')) {
        const parts = durata.split('-');
        startTime = parts[0].trim().match(/^\d{2}:\d{2}/) ? parts[0].trim().substring(0,5) : '';
        endTime = parts[1].trim().match(/^\d{2}:\d{2}/) ? parts[1].trim().substring(0,5) : '';
      } else if (durata.match(/^\d{2}:\d{2}/)) {
        startTime = durata.substring(0,5);
      }
      dashAdminEventStartTimeEl.value = startTime;
      dashAdminEventEndTimeEl.value = endTime;
      dashAdminEventShortDescEl.value = eventData.descrizione || '';
      dashAdminEventLongDescEl.value = eventData.descrizione_estesa || '';
      dashAdminEventPrefixEl.value = eventData.prefisso_relatore || 'Relatore';
      dashAdminEventSpeakerEl.value = eventData.relatore || '';
      dashAdminEventAssociationEl.value = eventData.associazione || '';
      dashAdminEventSeatsEl.value = eventData.posti_disponibili !== null ? eventData.posti_disponibili : '0';
      dashAdminEventBookingCheckbox.checked = parseInt(eventData.flagprenotabile) === 1;
      dashAdminEventVoluntaryCheckbox.checked = parseFloat(eventData.costo) === 0.00;
      updateDashAdminPriceFieldVisibility();
      if (!dashAdminEventVoluntaryCheckbox.checked && eventData.costo && parseFloat(eventData.costo) > 0) {
        dashAdminEventPriceInputEl.value = parseFloat(eventData.costo).toFixed(2);
      } else {
        dashAdminEventPriceInputEl.value = '';
      }
      if (dashAdminCurrentImagePreviewEl && eventData.immagine_url) {
        dashAdminCurrentImagePreviewEl.src = eventData.immagine_url;
        dashAdminCurrentImagePreviewEl.style.display = 'block';
      } else if (dashAdminCurrentImagePreviewEl) {
        dashAdminCurrentImagePreviewEl.style.display = 'none';
        dashAdminCurrentImagePreviewEl.src = '#';
      }
      if(dashAdminEventFlyerEl) dashAdminEventFlyerEl.value = '';
      if (dashAdminCurrentFlyerPreviewEl && eventData.volantino_url) {
        dashAdminCurrentFlyerPreviewEl.innerHTML = `<a href="${sanitizeForAttribute(eventData.volantino_url)}" target="_blank" title="Visualizza il volantino attuale">${sanitizeText(eventData.volantino_url.split('/').pop())}</a>`;
      } else if (dashAdminCurrentFlyerPreviewEl) {
        dashAdminCurrentFlyerPreviewEl.innerHTML = `<span>Nessun volantino caricato.</span>`;
      }
      updateDashAdminEventPreview();
      storeInitialFormData();
      if(dashAdminEventTitleEl) dashAdminEventTitleEl.focus();
    }

    if (dashAdminLongDescElForAI && generateShortDescBtnEl) {
      const hasText = dashAdminLongDescElForAI.value.trim().length > 0;
      generateShortDescBtnEl.classList.toggle('visible', hasText);
      generateShortDescBtnEl.classList.toggle('expanded', hasText && !generateShortDescBtnEl.classList.contains('loading'));
    }

    if(dashAdminEventPopupOverlayEl) dashAdminEventPopupOverlayEl.classList.add('active');
    if(dashAdminEventPopupEl) dashAdminEventPopupEl.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function storeInitialFormData() {
    if (dashAdminEventFormEl) {
      initialAdminEventFormData = getAdminEventFormData(dashAdminEventFormEl);
      isEventFormDirty = false;
    }
  }

  async function tryCloseDashAdminEventPopup() {
    if (dashAdminFormAndPreviewContainerEl && dashAdminFormAndPreviewContainerEl.style.display === 'flex') {
      const currentFormData = getAdminEventFormData(dashAdminEventFormEl);
      const imageFileChanged = dashAdminEventImageEl.files.length > 0 && initialAdminEventFormData['event-image'] !== dashAdminEventImageEl.files[0].name;
      const flyerFileChanged = dashAdminEventFlyerEl.files.length > 0 && initialAdminEventFormData['event-flyer'] !== dashAdminEventFlyerEl.files[0].name;

      isEventFormDirty = !compareAdminEventFormData(initialAdminEventFormData, currentFormData) || imageFileChanged || flyerFileChanged;


      if (isEventFormDirty) {
        const confirmed = await showCustomConfirm(
                "Conferma Uscita",
                "Hai modifiche non salvate. Sei sicuro di voler uscire senza salvare?",
                "Esci",
                "Annulla"
        );
        if (confirmed) {
          closeDashAdminEventPopup_actual();
        }
        return;
      }
    }
    closeDashAdminEventPopup_actual();
  }

  function closeDashAdminEventPopup_actual() {
    if(dashAdminEventPopupOverlayEl) dashAdminEventPopupOverlayEl.classList.remove('active');
    if(dashAdminEventPopupEl) dashAdminEventPopupEl.classList.remove('active');
    if (!isAnyPopupActive()) document.body.style.overflow = '';
    isEventFormDirty = false;
    if(creationModeSelectionViewEl) creationModeSelectionViewEl.style.display = 'flex';
    if(flyerUploadViewEl) flyerUploadViewEl.style.display = 'none';
    if(flyerPreviewContainerEl) flyerPreviewContainerEl.style.display = 'none';
    if(flyerPreviewContainerEl) flyerPreviewContainerEl.classList.remove('pulsating-background');
    if(dashAdminFormAndPreviewContainerEl) dashAdminFormAndPreviewContainerEl.style.display = 'none';
    if(dashAdminEventPopupTitleEl) dashAdminEventPopupTitleEl.textContent = 'Come vuoi creare l\'evento?';
  }

  async function handleAdminEventFormSubmit(e) {
    e.preventDefault();
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true; submitBtn.innerHTML = '<div class="spinner-mini"></div>Salvataggio...';
    if(dashAdminEventFormMessageEl) { dashAdminEventFormMessageEl.style.display = 'none'; dashAdminEventFormMessageEl.className = 'form-message';}
    try {
      const formData = new FormData(this);
      formData.append('action', formData.get('event-id') ? 'update_event' : 'add_event');
      const startTime = formData.get('event-start-time'); const endTime = formData.get('event-end-time');
      let durataString = '';
      if (startTime && endTime) durataString = `${startTime}-${endTime}`;
      else if (startTime) durataString = startTime;
      formData.append('event-time', durataString);
      formData.delete('event-start-time'); formData.delete('event-end-time');
      if (dashAdminEventVoluntaryCheckbox.checked) formData.set('event-price', '0.00');
      else if (!formData.get('event-price')) formData.set('event-price', '0.00');

      const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
      const responseText = await response.text();
      let result; try { result = JSON.parse(responseText); }
      catch (jsonError) { throw new Error(`Risposta non JSON dal server: ${responseText.substring(0,200)}`); }
      if (!response.ok) throw new Error(result.message || `Errore server: ${response.status}`);
      if (result.success) {
        if(dashAdminEventFormMessageEl) {
          dashAdminEventFormMessageEl.textContent = result.message || 'Operazione completata!';
          dashAdminEventFormMessageEl.classList.add('success');
          dashAdminEventFormMessageEl.style.display = 'block';
        }
        loadEvents();
        isEventFormDirty = false;
        setTimeout(closeDashAdminEventPopup_actual, 1500);
      } else { throw new Error(result.message || 'Errore durante il salvataggio dell\'evento.'); }
    } catch (error) {
      console.error('Errore invio form evento admin (stile dashboard):', error);
      if(dashAdminEventFormMessageEl) {
        dashAdminEventFormMessageEl.textContent = `Errore: ${error.message}`;
        dashAdminEventFormMessageEl.classList.add('error');
        dashAdminEventFormMessageEl.style.display = 'block';
      }
    } finally {
      submitBtn.disabled = false; submitBtn.innerHTML = originalBtnText;
    }
  }

  async function handleDeleteEvent(eventId) {
    const eventToDelete = currentEventsData.find(e => e.idevento == eventId);
    const eventTitle = eventToDelete ? eventToDelete.titolo : "questo evento";

    let confirmDialogTitle = "Conferma eliminazione";
    let confirmDialogMessage;
    let confirmDialogYesText = "Elimina";
    let confirmDialogNoText = "Annulla";

    if (currentUserData && currentUserData.isAdmin) {
      confirmDialogMessage = `Sei sicuro di voler eliminare l'evento "${sanitizeForAttribute(eventTitle)}"?`;
    } else {
      // Per utenti non admin, anche se questo scenario è meno probabile per il delete
      confirmDialogMessage = `Sei sicuro di voler eliminare l'evento "${sanitizeForAttribute(eventTitle)}"? L'azione è irreversibile.`;
    }

    const userConfirmed = await showCustomConfirm(confirmDialogTitle, confirmDialogMessage, confirmDialogYesText, confirmDialogNoText);

    if (userConfirmed) {
      const deleteButton = document.querySelector(`.btn-delete[data-event-id="${eventId}"]`);
      let originalButtonHTML = '';
      if(deleteButton) {
        originalButtonHTML = deleteButton.innerHTML;
        deleteButton.disabled = true;
        deleteButton.innerHTML = '<div class="spinner-mini" style="border-top-color:white;"></div>';
      }
      try {
        const formData = new FormData(); formData.append('action', 'delete_event'); formData.append('event_id', eventId);
        const response = await fetch('gestione_eventi.php', { method: 'POST', body: formData });
        const resText = await response.text();
        let result; try { result = JSON.parse(resText); }
        catch(e) { throw new Error("Risposta non JSON dal server (delete): "+resText.substring(0,100));}
        if (!response.ok) throw new Error(result.message || `Errore HTTP ${response.status}`);
        if (result.success) { console.log(result.message || 'Evento eliminato con successo.'); loadEvents(); }
        else { throw new Error(result.message || 'Eliminazione fallita.'); }
      } catch (error) {
        console.error('Errore eliminazione evento:', error);
        alert(`Errore durante l'eliminazione: ${error.message}`);
      } finally {
        if(deleteButton) { deleteButton.disabled = false; deleteButton.innerHTML = originalButtonHTML; }
      }
    }
  }
document.addEventListener('DOMContentLoaded', async () => {
    const cY = gebi("currentYear"); if (cY) cY.textContent = new Date().getFullYear();
    initGlobalFlyerOverlay();

    // NOTA: loadUserData() e updateNavbarUI() sono ora eseguiti automaticamente da auth.js
    
    await loadNavbarLogo();
    await loadEvents();
    initializeBookingPopupHandlers();
    initializeWaitlistPopupHandlers();
    initializeDashAdminEventPopupHandlers();

    // Questo controllo ora dipende dalla variabile currentUserData che viene popolata da auth.js
   // Listener per eventi da auth.js per aggiornare la pagina dinamicamente
document.addEventListener('loginSuccess', () => {
    console.log('Login Rilevato. Aggiorno eventi.');
    loadEvents(); // Ricarica le card degli eventi con la vista corretta (admin/utente)

    // Manteniamo il fetch della API key se l'utente è admin
    if (currentUserData && currentUserData.isAdmin) {
        fetchAndPrepareGroqApiKey();
    }
});

document.addEventListener('logoutSuccess', () => {
    console.log('Logout Rilevato. Aggiorno eventi.');
    loadEvents(); // Ricarica le card degli eventi con la vista pubblica
});
    // Esegui anche al caricamento se l'utente è già loggato
    if (currentUserData && currentUserData.isAdmin) {
      fetchAndPrepareGroqApiKey();
    }

    const pAction = localStorage.getItem("pending_action_eff");
    if (pAction && currentUserData) {
      const aD = JSON.parse(pAction); localStorage.removeItem("pending_action_eff");
      if (aD.action === 'book' && typeof window.openBookingPopup === 'function') window.openBookingPopup(aD.eventId, aD.eventTitle, aD.postiDisp, aD.postiGiaPren);
      else if (aD.action === 'waitlist' && typeof window.openWaitlistPopup === 'function') window.openWaitlistPopup(aD.eventId, aD.eventTitle, aD.postiGiaPren);
    }
    
    // Il listener per il tasto ESCAPE ora gestisce solo i popup specifici della pagina
    document.addEventListener("keydown", async (e) => {
      if (e.key === "Escape") {
        // auth.js gestisce già i suoi popup (login, etc.)
        if (gebi('bookingPopup')?.classList.contains("active")) gebi('closeBookingPopupBtn')?.click();
        else if (gebi('waitlistPopup')?.classList.contains("active")) gebi('closeWaitlistPopupBtn')?.click();
        else if (globalFlyerOverlayEff?.classList.contains("active")) hideFlyerPopupEff();
        else if (gebi('dashAdminEventPopup')?.classList.contains("active")) await tryCloseDashAdminEventPopup();
        else if (customConfirmOverlayEl?.classList.contains('active')) handleConfirm(false);
      }
    });
  });
</script>
</body>
</html>